[{"id":"50b6ca39b1c5fcfd54bce8129993cbda","title":"NettyåŸºç¡€","content":"Netty æ¦‚è¿°Netty æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ã€åŸºäºäº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨æ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤ã€é«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯\nNetty çš„ä¼˜åŠ¿\nNetty vs NIOï¼Œå·¥ä½œé‡å¤§ï¼Œbug å¤š\néœ€è¦è‡ªå·±æ„å»ºåè®®\nè§£å†³ TCP ä¼ è¾“é—®é¢˜ï¼Œå¦‚ç²˜åŒ…ã€åŠåŒ…\nepoll ç©ºè½®è¯¢å¯¼è‡´ CPU 100%\nå¯¹ API è¿›è¡Œå¢å¼ºï¼Œä½¿ä¹‹æ›´æ˜“ç”¨ï¼Œå¦‚ FastThreadLocal &#x3D;&gt; ThreadLocalï¼ŒByteBuf &#x3D;&gt; ByteBuffer\n\n\nNetty vs å…¶å®ƒç½‘ç»œåº”ç”¨æ¡†æ¶\nMina ç”± apache ç»´æŠ¤ï¼Œå°†æ¥ 3.x ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰è¾ƒå¤§é‡æ„ï¼Œç ´å API å‘ä¸‹å…¼å®¹æ€§ï¼ŒNetty çš„å¼€å‘è¿­ä»£æ›´è¿…é€Ÿï¼ŒAPI æ›´ç®€æ´ã€æ–‡æ¡£æ›´ä¼˜ç§€\n\n\n\nå¼€å‘ä¸€ä¸ªç®€å•çš„æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯\nå®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘é€ hello, world\næœåŠ¡å™¨ä»…æ¥æ”¶ï¼Œä¸è¿”å›\n\nåŠ å…¥ä¾èµ–\n&lt;dependency>\n    &lt;groupId>io.netty&lt;/groupId>\n    &lt;artifactId>netty-all&lt;/artifactId>\n    &lt;version>4.1.39.Final&lt;/version>\n&lt;/dependency>\n\næœåŠ¡å™¨ç«¯new ServerBootstrap()\n    .group(new NioEventLoopGroup()) // 1\n    .channel(NioServerSocketChannel.class) // 2\n    .childHandler(new ChannelInitializer&lt;NioSocketChannel>() &#123; // 3\n        protected void initChannel(NioSocketChannel ch) &#123;\n            ch.pipeline().addLast(new StringDecoder()); // 5\n            ch.pipeline().addLast(new SimpleChannelInboundHandler&lt;String>() &#123; // 6\n                @Override\n                protected void channelRead0(ChannelHandlerContext ctx, String msg) &#123;\n                    System.out.println(msg);\n                &#125;\n            &#125;);\n        &#125;\n    &#125;)\n    .bind(8080); // 4\n\nä»£ç è§£è¯»\n\n1 å¤„ï¼Œåˆ›å»º NioEventLoopGroupï¼Œå¯ä»¥ç®€å•ç†è§£ä¸º çº¿ç¨‹æ±  + Selector åé¢ä¼šè¯¦ç»†å±•å¼€\n\n2 å¤„ï¼Œé€‰æ‹©æœåŠ¡ Scoket å®ç°ç±»ï¼Œå…¶ä¸­ NioServerSocketChannel è¡¨ç¤ºåŸºäº NIO çš„æœåŠ¡å™¨ç«¯å®ç°ï¼Œå…¶å®ƒå®ç°è¿˜æœ‰\n\n\n3 å¤„ï¼Œä¸ºå•¥æ–¹æ³•å« childHandlerï¼Œæ˜¯æ¥ä¸‹æ¥æ·»åŠ çš„å¤„ç†å™¨éƒ½æ˜¯ç»™ SocketChannel ç”¨çš„ï¼Œè€Œä¸æ˜¯ç»™ ServerSocketChannelã€‚ChannelInitializer å¤„ç†å™¨ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¾…å®¢æˆ·ç«¯ SocketChannel å»ºç«‹è¿æ¥åï¼Œæ‰§è¡Œ initChannel ä»¥ä¾¿æ·»åŠ æ›´å¤šçš„å¤„ç†å™¨\n\n4 å¤„ï¼ŒServerSocketChannel ç»‘å®šçš„ç›‘å¬ç«¯å£\n\n5 å¤„ï¼ŒSocketChannel çš„å¤„ç†å™¨ï¼Œè§£ç  ByteBuf &#x3D;&gt; String\n\n6 å¤„ï¼ŒSocketChannel çš„ä¸šåŠ¡å¤„ç†å™¨ï¼Œä½¿ç”¨ä¸Šä¸€ä¸ªå¤„ç†å™¨çš„å¤„ç†ç»“æœ\n\n\nå®¢æˆ·ç«¯new Bootstrap()\n    .group(new NioEventLoopGroup()) // 1\n    .channel(NioSocketChannel.class) // 2\n    .handler(new ChannelInitializer&lt;Channel>() &#123; // 3\n        @Override\n        protected void initChannel(Channel ch) &#123;\n            ch.pipeline().addLast(new StringEncoder()); // 8\n        &#125;\n    &#125;)\n    .connect(\"127.0.0.1\", 8080) // 4\n    .sync() // 5\n    .channel() // 6\n    .writeAndFlush(new Date() + \": hello world!\"); // 7\n\nä»£ç è§£è¯»\n\n1 å¤„ï¼Œåˆ›å»º NioEventLoopGroupï¼ŒåŒ Server\n\n2 å¤„ï¼Œé€‰æ‹©å®¢æˆ· Socket å®ç°ç±»ï¼ŒNioSocketChannel è¡¨ç¤ºåŸºäº NIO çš„å®¢æˆ·ç«¯å®ç°ï¼Œå…¶å®ƒå®ç°è¿˜æœ‰\n\n\n3 å¤„ï¼Œæ·»åŠ  SocketChannel çš„å¤„ç†å™¨ï¼ŒChannelInitializer å¤„ç†å™¨ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¾…å®¢æˆ·ç«¯ SocketChannel å»ºç«‹è¿æ¥åï¼Œæ‰§è¡Œ initChannel ä»¥ä¾¿æ·»åŠ æ›´å¤šçš„å¤„ç†å™¨\n\n4 å¤„ï¼ŒæŒ‡å®šè¦è¿æ¥çš„æœåŠ¡å™¨å’Œç«¯å£\n\n5 å¤„ï¼ŒNetty ä¸­å¾ˆå¤šæ–¹æ³•éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œå¦‚ connectï¼Œè¿™æ—¶éœ€è¦ä½¿ç”¨ sync æ–¹æ³•ç­‰å¾… connect å»ºç«‹è¿æ¥å®Œæ¯•\n\n6 å¤„ï¼Œè·å– channel å¯¹è±¡ï¼Œå®ƒå³ä¸ºé€šé“æŠ½è±¡ï¼Œå¯ä»¥è¿›è¡Œæ•°æ®è¯»å†™æ“ä½œ\n\n7 å¤„ï¼Œå†™å…¥æ¶ˆæ¯å¹¶æ¸…ç©ºç¼“å†²åŒº\n\n8 å¤„ï¼Œæ¶ˆæ¯ä¼šç»è¿‡é€šé“ handler å¤„ç†ï¼Œè¿™é‡Œæ˜¯å°† String &#x3D;&gt; ByteBuf å‘å‡º\n\næ•°æ®ç»è¿‡ç½‘ç»œä¼ è¾“ï¼Œåˆ°è¾¾æœåŠ¡å™¨ç«¯ï¼ŒæœåŠ¡å™¨ç«¯ 5 å’Œ 6 å¤„çš„ handler å…ˆåè¢«è§¦å‘ï¼Œèµ°å®Œä¸€ä¸ªæµç¨‹\n\n\næµç¨‹æ¢³ç†\n\n\n\n\n\n\n\n\n\n\næŠŠ channel ç†è§£ä¸ºæ•°æ®çš„é€šé“\næŠŠ msg ç†è§£ä¸ºæµåŠ¨çš„æ•°æ®ï¼Œæœ€å¼€å§‹è¾“å…¥æ˜¯ ByteBufï¼Œä½†ç»è¿‡ pipeline çš„åŠ å·¥ï¼Œä¼šå˜æˆå…¶å®ƒç±»å‹å¯¹è±¡ï¼Œæœ€åè¾“å‡ºåˆå˜æˆ ByteBuf\næŠŠ handler ç†è§£ä¸ºæ•°æ®çš„å¤„ç†å·¥åº\nå·¥åºæœ‰å¤šé“ï¼Œåˆåœ¨ä¸€èµ·å°±æ˜¯ pipelineï¼Œpipeline è´Ÿè´£å‘å¸ƒäº‹ä»¶ï¼ˆè¯»ã€è¯»å–å®Œæˆâ€¦ï¼‰ä¼ æ’­ç»™æ¯ä¸ª handlerï¼Œ handler å¯¹è‡ªå·±æ„Ÿå…´è¶£çš„äº‹ä»¶è¿›è¡Œå¤„ç†ï¼ˆé‡å†™ç›¸åº”äº‹ä»¶å¤„ç†æ–¹æ³•ï¼‰\nhandler åˆ† Inbound å’Œ Outbound ä¸¤ç±»\n\n\næŠŠ eventLoop ç†è§£ä¸ºå¤„ç†æ•°æ®çš„å·¥äºº\nå·¥äººå¯ä»¥ç®¡ç†å¤šä¸ª channel çš„ io æ“ä½œï¼Œå¹¶ä¸”ä¸€æ—¦å·¥äººè´Ÿè´£äº†æŸä¸ª channelï¼Œå°±è¦è´Ÿè´£åˆ°åº•ï¼ˆç»‘å®šï¼‰\nå·¥äººæ—¢å¯ä»¥æ‰§è¡Œ io æ“ä½œï¼Œä¹Ÿå¯ä»¥è¿›è¡Œä»»åŠ¡å¤„ç†ï¼Œæ¯ä½å·¥äººæœ‰ä»»åŠ¡é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é‡Œå¯ä»¥å †æ”¾å¤šä¸ª channel çš„å¾…å¤„ç†ä»»åŠ¡ï¼Œä»»åŠ¡åˆ†ä¸ºæ™®é€šä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡\nå·¥äººæŒ‰ç…§ pipeline é¡ºåºï¼Œä¾æ¬¡æŒ‰ç…§ handler çš„è§„åˆ’ï¼ˆä»£ç ï¼‰å¤„ç†æ•°æ®ï¼Œå¯ä»¥ä¸ºæ¯é“å·¥åºæŒ‡å®šä¸åŒçš„å·¥äºº\n\n\n\nç»„ä»¶EventLoopäº‹ä»¶å¾ªç¯å¯¹è±¡\nEventLoop æœ¬è´¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ‰§è¡Œå™¨ï¼ˆåŒæ—¶ç»´æŠ¤äº†ä¸€ä¸ª Selectorï¼‰ï¼Œé‡Œé¢æœ‰ run æ–¹æ³•å¤„ç† Channel ä¸Šæºæºä¸æ–­çš„ io äº‹ä»¶ã€‚\nå®ƒçš„ç»§æ‰¿å…³ç³»æ¯”è¾ƒå¤æ‚\n\nä¸€æ¡çº¿æ˜¯ç»§æ‰¿è‡ª j.u.c.ScheduledExecutorService å› æ­¤åŒ…å«äº†çº¿ç¨‹æ± ä¸­æ‰€æœ‰çš„æ–¹æ³•\nå¦ä¸€æ¡çº¿æ˜¯ç»§æ‰¿è‡ª netty è‡ªå·±çš„ OrderedEventExecutorï¼Œ\næä¾›äº† boolean inEventLoop(Thread thread) æ–¹æ³•åˆ¤æ–­ä¸€ä¸ªçº¿ç¨‹æ˜¯å¦å±äºæ­¤ EventLoop\næä¾›äº† parent æ–¹æ³•æ¥çœ‹çœ‹è‡ªå·±å±äºå“ªä¸ª EventLoopGroup\n\n\n\näº‹ä»¶å¾ªç¯ç»„\nEventLoopGroup æ˜¯ä¸€ç»„ EventLoopï¼ŒChannel ä¸€èˆ¬ä¼šè°ƒç”¨ EventLoopGroup çš„ register æ–¹æ³•æ¥ç»‘å®šå…¶ä¸­ä¸€ä¸ª EventLoopï¼Œåç»­è¿™ä¸ª Channel ä¸Šçš„ io äº‹ä»¶éƒ½ç”±æ­¤ EventLoop æ¥å¤„ç†ï¼ˆä¿è¯äº† io äº‹ä»¶å¤„ç†æ—¶çš„çº¿ç¨‹å®‰å…¨ï¼‰\n\nç»§æ‰¿è‡ª netty è‡ªå·±çš„ EventExecutorGroup\nå®ç°äº† Iterable æ¥å£æä¾›éå† EventLoop çš„èƒ½åŠ›\nå¦æœ‰ next æ–¹æ³•è·å–é›†åˆä¸­ä¸‹ä¸€ä¸ª EventLoop\n\n\n\nä»¥ä¸€ä¸ªç®€å•çš„å®ç°ä¸ºä¾‹ï¼š\n// å†…éƒ¨åˆ›å»ºäº†ä¸¤ä¸ª EventLoop, æ¯ä¸ª EventLoop ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹\nDefaultEventLoopGroup group = new DefaultEventLoopGroup(2);\nSystem.out.println(group.next());\nSystem.out.println(group.next());\nSystem.out.println(group.next());\n\nè¾“å‡º\nio.netty.channel.DefaultEventLoop@60f82f98\nio.netty.channel.DefaultEventLoop@35f983a6\nio.netty.channel.DefaultEventLoop@60f82f98\n\nä¹Ÿå¯ä»¥ä½¿ç”¨ for å¾ªç¯\nDefaultEventLoopGroup group = new DefaultEventLoopGroup(2);\nfor (EventExecutor eventLoop : group) &#123;\n    System.out.println(eventLoop);\n&#125;\n\nè¾“å‡º\nio.netty.channel.DefaultEventLoop@60f82f98\nio.netty.channel.DefaultEventLoop@35f983a6\n\nå…³é—­å…³é—­ shutdownGracefully æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¼šé¦–å…ˆåˆ‡æ¢ EventLoopGroup åˆ°å…³é—­çŠ¶æ€ä»è€Œæ‹’ç»æ–°çš„ä»»åŠ¡çš„åŠ å…¥ï¼Œç„¶ååœ¨ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡éƒ½å¤„ç†å®Œæˆåï¼Œåœæ­¢çº¿ç¨‹çš„è¿è¡Œã€‚ä»è€Œç¡®ä¿æ•´ä½“åº”ç”¨æ˜¯åœ¨æ­£å¸¸æœ‰åºçš„çŠ¶æ€ä¸‹é€€å‡ºçš„\næ¼”ç¤º NioEventLoop å¤„ç† io äº‹ä»¶æœåŠ¡å™¨ç«¯ä¸¤ä¸ª nio worker å·¥äºº\nnew ServerBootstrap()\n    .group(new NioEventLoopGroup(1), new NioEventLoopGroup(2))\n    .channel(NioServerSocketChannel.class)\n    .childHandler(new ChannelInitializer&lt;NioSocketChannel>() &#123;\n        @Override\n        protected void initChannel(NioSocketChannel ch) &#123;\n            ch.pipeline().addLast(new ChannelInboundHandlerAdapter() &#123;\n                @Override\n                public void channelRead(ChannelHandlerContext ctx, Object msg) &#123;\n                    ByteBuf byteBuf = msg instanceof ByteBuf ? ((ByteBuf) msg) : null;\n                    if (byteBuf != null) &#123;\n                        byte[] buf = new byte[16];\n                        ByteBuf len = byteBuf.readBytes(buf, 0, byteBuf.readableBytes());\n                        log.debug(new String(buf));\n                    &#125;\n                &#125;\n            &#125;);\n        &#125;\n    &#125;).bind(8080).sync();\n\nå®¢æˆ·ç«¯ï¼Œå¯åŠ¨ä¸‰æ¬¡ï¼Œåˆ†åˆ«ä¿®æ”¹å‘é€å­—ç¬¦ä¸²ä¸º zhangsanï¼ˆç¬¬ä¸€æ¬¡ï¼‰ï¼Œlisiï¼ˆç¬¬äºŒæ¬¡ï¼‰ï¼Œwangwuï¼ˆç¬¬ä¸‰æ¬¡ï¼‰\npublic static void main(String[] args) throws InterruptedException &#123;\n    Channel channel = new Bootstrap()\n            .group(new NioEventLoopGroup(1))\n            .handler(new ChannelInitializer&lt;NioSocketChannel>() &#123;\n                @Override\n                protected void initChannel(NioSocketChannel ch) throws Exception &#123;\n                    System.out.println(\"init...\");\n                    ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));\n                &#125;\n            &#125;)\n            .channel(NioSocketChannel.class).connect(\"localhost\", 8080)\n            .sync()\n            .channel();\n\n    channel.writeAndFlush(ByteBufAllocator.DEFAULT.buffer().writeBytes(\"wangwu\".getBytes()));\n    Thread.sleep(2000);\n    channel.writeAndFlush(ByteBufAllocator.DEFAULT.buffer().writeBytes(\"wangwu\".getBytes()));\n\næœ€åè¾“å‡º\n22:03:34 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - zhangsan       \n22:03:36 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - zhangsan       \n22:05:36 [DEBUG] [nioEventLoopGroup-3-2] c.i.o.EventLoopTest - lisi           \n22:05:38 [DEBUG] [nioEventLoopGroup-3-2] c.i.o.EventLoopTest - lisi           \n22:06:09 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - wangwu        \n22:06:11 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - wangwu         \n\nå¯ä»¥çœ‹åˆ°ä¸¤ä¸ªå·¥äººè½®æµå¤„ç† channelï¼Œä½†å·¥äººä¸ channel ä¹‹é—´è¿›è¡Œäº†ç»‘å®š\n\nå†å¢åŠ ä¸¤ä¸ªé nio å·¥äºº\nDefaultEventLoopGroup normalWorkers = new DefaultEventLoopGroup(2);\nnew ServerBootstrap()\n    .group(new NioEventLoopGroup(1), new NioEventLoopGroup(2))\n    .channel(NioServerSocketChannel.class)\n    .childHandler(new ChannelInitializer&lt;NioSocketChannel>() &#123;\n        @Override\n        protected void initChannel(NioSocketChannel ch)  &#123;\n            ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));\n            ch.pipeline().addLast(normalWorkers,\"myhandler\",\n              new ChannelInboundHandlerAdapter() &#123;\n                @Override\n                public void channelRead(ChannelHandlerContext ctx, Object msg) &#123;\n                    ByteBuf byteBuf = msg instanceof ByteBuf ? ((ByteBuf) msg) : null;\n                    if (byteBuf != null) &#123;\n                        byte[] buf = new byte[16];\n                        ByteBuf len = byteBuf.readBytes(buf, 0, byteBuf.readableBytes());\n                        log.debug(new String(buf));\n                    &#125;\n                &#125;\n            &#125;);\n        &#125;\n    &#125;).bind(8080).sync();\n\nå®¢æˆ·ç«¯ä»£ç ä¸å˜ï¼Œå¯åŠ¨ä¸‰æ¬¡ï¼Œåˆ†åˆ«ä¿®æ”¹å‘é€å­—ç¬¦ä¸²ä¸º zhangsanï¼ˆç¬¬ä¸€æ¬¡ï¼‰ï¼Œlisiï¼ˆç¬¬äºŒæ¬¡ï¼‰ï¼Œwangwuï¼ˆç¬¬ä¸‰æ¬¡ï¼‰\nè¾“å‡º\n22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52588] REGISTERED\n22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52588] ACTIVE\n22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52588] READ: 8B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 7a 68 61 6e 67 73 61 6e                         |zhangsan        |\n+--------+-------------------------------------------------+----------------+\n22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52588] READ COMPLETE\n22:19:48 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - zhangsan        \n22:19:50 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52588] READ: 8B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 7a 68 61 6e 67 73 61 6e                         |zhangsan        |\n+--------+-------------------------------------------------+----------------+\n22:19:50 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52588] READ COMPLETE\n22:19:50 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - zhangsan        \n22:20:24 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52612] REGISTERED\n22:20:24 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52612] ACTIVE\n22:20:25 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52612] READ: 4B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 6c 69 73 69                                     |lisi            |\n+--------+-------------------------------------------------+----------------+\n22:20:25 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52612] READ COMPLETE\n22:20:25 [DEBUG] [defaultEventLoopGroup-2-2] c.i.o.EventLoopTest - lisi            \n22:20:27 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52612] READ: 4B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 6c 69 73 69                                     |lisi            |\n+--------+-------------------------------------------------+----------------+\n22:20:27 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52612] READ COMPLETE\n22:20:27 [DEBUG] [defaultEventLoopGroup-2-2] c.i.o.EventLoopTest - lisi            \n22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52625] REGISTERED\n22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52625] ACTIVE\n22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52625] READ: 6B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 77 61 6e 67 77 75                               |wangwu          |\n+--------+-------------------------------------------------+----------------+\n22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52625] READ COMPLETE\n22:20:38 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - wangwu          \n22:20:40 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52625] READ: 6B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 77 61 6e 67 77 75                               |wangwu          |\n+--------+-------------------------------------------------+----------------+\n22:20:40 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52625] READ COMPLETE\n22:20:40 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - wangwu          \n\nå¯ä»¥çœ‹åˆ°ï¼Œnio å·¥äººå’Œ é nio å·¥äººä¹Ÿåˆ†åˆ«ç»‘å®šäº† channelï¼ˆLoggingHandler ç”± nio å·¥äººæ‰§è¡Œï¼Œè€Œæˆ‘ä»¬è‡ªå·±çš„ handler ç”±é nio å·¥äººæ‰§è¡Œï¼‰\n\nhandler æ‰§è¡Œä¸­å¦‚ä½•åˆ‡æ¢çº¿ç¨‹ï¼Ÿå…³é”®ä»£ç  io.netty.channel.AbstractChannelHandlerContext#invokeChannelRead()\nstatic void invokeChannelRead(final AbstractChannelHandlerContext next, Object msg) &#123;\n    final Object m = next.pipeline.touch(ObjectUtil.checkNotNull(msg, \"msg\"), next);\n    // ä¸‹ä¸€ä¸ª handler çš„äº‹ä»¶å¾ªç¯æ˜¯å¦ä¸å½“å‰çš„äº‹ä»¶å¾ªç¯æ˜¯åŒä¸€ä¸ªçº¿ç¨‹\n    EventExecutor executor = next.executor();\n    \n    // æ˜¯ï¼Œç›´æ¥è°ƒç”¨\n    if (executor.inEventLoop()) &#123;\n        next.invokeChannelRead(m);\n    &#125; \n    // ä¸æ˜¯ï¼Œå°†è¦æ‰§è¡Œçš„ä»£ç ä½œä¸ºä»»åŠ¡æäº¤ç»™ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯å¤„ç†ï¼ˆæ¢äººï¼‰\n    else &#123;\n        executor.execute(new Runnable() &#123;\n            @Override\n            public void run() &#123;\n                next.invokeChannelRead(m);\n            &#125;\n        &#125;);\n    &#125;\n&#125;\n\n\nå¦‚æœä¸¤ä¸ª handler ç»‘å®šçš„æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆå°±ç›´æ¥è°ƒç”¨\nå¦åˆ™ï¼ŒæŠŠè¦è°ƒç”¨çš„ä»£ç å°è£…ä¸ºä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œç”±ä¸‹ä¸€ä¸ª handler çš„çº¿ç¨‹æ¥è°ƒç”¨\n\næ¼”ç¤º NioEventLoop å¤„ç†æ™®é€šä»»åŠ¡NioEventLoop é™¤äº†å¯ä»¥å¤„ç† io äº‹ä»¶ï¼ŒåŒæ ·å¯ä»¥å‘å®ƒæäº¤æ™®é€šä»»åŠ¡\nNioEventLoopGroup nioWorkers = new NioEventLoopGroup(2);\n\nlog.debug(\"server start...\");\nThread.sleep(2000);\nnioWorkers.execute(()->&#123;\n    log.debug(\"normal task...\");\n&#125;);\n\nè¾“å‡º\n22:30:36 [DEBUG] [main] c.i.o.EventLoopTest2 - server start...\n22:30:38 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - normal task...\n\n\n\n\n\n\n\n\n\n\nå¯ä»¥ç”¨æ¥æ‰§è¡Œè€—æ—¶è¾ƒé•¿çš„ä»»åŠ¡\næ¼”ç¤º NioEventLoop å¤„ç†å®šæ—¶ä»»åŠ¡NioEventLoopGroup nioWorkers = new NioEventLoopGroup(2);\n\nlog.debug(\"server start...\");\nThread.sleep(2000);\nnioWorkers.scheduleAtFixedRate(() -> &#123;\n    log.debug(\"running...\");\n&#125;, 0, 1, TimeUnit.SECONDS);\n\nè¾“å‡º\n22:35:15 [DEBUG] [main] c.i.o.EventLoopTest2 - server start...\n22:35:17 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...\n22:35:18 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...\n22:35:19 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...\n22:35:20 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...\n...\n\n\n\n\n\n\n\n\n\n\nå¯ä»¥ç”¨æ¥æ‰§è¡Œå®šæ—¶ä»»åŠ¡\nChannelchannel çš„ä¸»è¦ä½œç”¨\n\nclose() å¯ä»¥ç”¨æ¥å…³é—­ channel\ncloseFuture() ç”¨æ¥å¤„ç† channel çš„å…³é—­\nsync æ–¹æ³•ä½œç”¨æ˜¯åŒæ­¥ç­‰å¾… channel å…³é—­\nè€Œ addListener æ–¹æ³•æ˜¯å¼‚æ­¥ç­‰å¾… channel å…³é—­\n\n\npipeline() æ–¹æ³•æ·»åŠ å¤„ç†å™¨\nwrite() æ–¹æ³•å°†æ•°æ®å†™å…¥\nwriteAndFlush() æ–¹æ³•å°†æ•°æ®å†™å…¥å¹¶åˆ·å‡º\n\nChannelFutureå®¢æˆ·ç«¯ä»£ç \nnew Bootstrap()\n    .group(new NioEventLoopGroup())\n    .channel(NioSocketChannel.class)\n    .handler(new ChannelInitializer&lt;Channel>() &#123;\n        @Override\n        protected void initChannel(Channel ch) &#123;\n            ch.pipeline().addLast(new StringEncoder());\n        &#125;\n    &#125;)\n    .connect(\"127.0.0.1\", 8080)\n    .sync()\n    .channel()\n    .writeAndFlush(new Date() + \": hello world!\");\n\næ‹†å¼€\nChannelFuture channelFuture = new Bootstrap()\n    .group(new NioEventLoopGroup())\n    .channel(NioSocketChannel.class)\n    .handler(new ChannelInitializer&lt;Channel>() &#123;\n        @Override\n        protected void initChannel(Channel ch) &#123;\n            ch.pipeline().addLast(new StringEncoder());\n        &#125;\n    &#125;)\n    .connect(\"127.0.0.1\", 8080); // 1\n\nchannelFuture.sync().channel().writeAndFlush(new Date() + \": hello world!\");\n\n\n1 å¤„è¿”å›çš„æ˜¯ ChannelFuture å¯¹è±¡ï¼Œå®ƒçš„ä½œç”¨æ˜¯åˆ©ç”¨ channel() æ–¹æ³•æ¥è·å– Channel å¯¹è±¡\n\næ³¨æ„ connect æ–¹æ³•æ˜¯å¼‚æ­¥çš„ï¼Œæ„å‘³ç€ä¸ç­‰è¿æ¥å»ºç«‹ï¼Œæ–¹æ³•æ‰§è¡Œå°±è¿”å›äº†ã€‚å› æ­¤ channelFuture å¯¹è±¡ä¸­ä¸èƒ½ç«‹åˆ»è·å¾—åˆ°æ­£ç¡®çš„ Channel å¯¹è±¡\nå®éªŒå¦‚ä¸‹ï¼š\nChannelFuture channelFuture = new Bootstrap()\n    .group(new NioEventLoopGroup())\n    .channel(NioSocketChannel.class)\n    .handler(new ChannelInitializer&lt;Channel>() &#123;\n        @Override\n        protected void initChannel(Channel ch) &#123;\n            ch.pipeline().addLast(new StringEncoder());\n        &#125;\n    &#125;)\n    .connect(\"127.0.0.1\", 8080);\n\nSystem.out.println(channelFuture.channel()); // 1\nchannelFuture.sync(); // 2\nSystem.out.println(channelFuture.channel()); // 3\n\n\næ‰§è¡Œåˆ° 1 æ—¶ï¼Œè¿æ¥æœªå»ºç«‹ï¼Œæ‰“å° [id: 0x2e1884dd]\næ‰§è¡Œåˆ° 2 æ—¶ï¼Œsync æ–¹æ³•æ˜¯åŒæ­¥ç­‰å¾…è¿æ¥å»ºç«‹å®Œæˆ\næ‰§è¡Œåˆ° 3 æ—¶ï¼Œè¿æ¥è‚¯å®šå»ºç«‹äº†ï¼Œæ‰“å° [id: 0x2e1884dd, L:/127.0.0.1:57191 - R:/127.0.0.1:8080]\n\né™¤äº†ç”¨ sync æ–¹æ³•å¯ä»¥è®©å¼‚æ­¥æ“ä½œåŒæ­¥ä»¥å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å›è°ƒçš„æ–¹å¼ï¼š\nChannelFuture channelFuture = new Bootstrap()\n    .group(new NioEventLoopGroup())\n    .channel(NioSocketChannel.class)\n    .handler(new ChannelInitializer&lt;Channel>() &#123;\n        @Override\n        protected void initChannel(Channel ch) &#123;\n            ch.pipeline().addLast(new StringEncoder());\n        &#125;\n    &#125;)\n    .connect(\"127.0.0.1\", 8080);\nSystem.out.println(channelFuture.channel()); // 1\nchannelFuture.addListener((ChannelFutureListener) future -> &#123;\n    System.out.println(future.channel()); // 2\n&#125;);\n\n\næ‰§è¡Œåˆ° 1 æ—¶ï¼Œè¿æ¥æœªå»ºç«‹ï¼Œæ‰“å° [id: 0x749124ba]\nChannelFutureListener ä¼šåœ¨è¿æ¥å»ºç«‹æ—¶è¢«è°ƒç”¨ï¼ˆå…¶ä¸­ operationComplete æ–¹æ³•ï¼‰ï¼Œå› æ­¤æ‰§è¡Œåˆ° 2 æ—¶ï¼Œè¿æ¥è‚¯å®šå»ºç«‹äº†ï¼Œæ‰“å° [id: 0x749124ba, L:/127.0.0.1:57351 - R:/127.0.0.1:8080]\n\nCloseFuture@Slf4j\npublic class CloseFutureClient &#123;\n    public static void main(String[] args) throws InterruptedException &#123;\n        NioEventLoopGroup group new NioEventLoopGroup();\n        ChannelFuture channelFuture = new Bootstrap()\n                .group(group)\n                .channel(NioSocketChannel.class)\n                .handler(new ChannelInitializer&lt;NioSocketChannel>() &#123;\n                    @Override // åœ¨è¿æ¥å»ºç«‹åè¢«è°ƒç”¨\n                    protected void initChannel(NioSocketChannel ch) throws Exception &#123;\n                        ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));\n                        ch.pipeline().addLast(new StringEncoder());\n                    &#125;\n                &#125;)\n                .connect(new InetSocketAddress(\"localhost\", 8080));\n        Channel channel = channelFuture.sync().channel();\n        log.debug(\"&#123;&#125;\", channel);\n        new Thread(()->&#123;\n            Scanner scanner = new Scanner(System.in);\n            while (true) &#123;\n                String line = scanner.nextLine();\n                if (\"q\".equals(line)) &#123;\n                    channel.close(); // close å¼‚æ­¥æ“ä½œ 1s ä¹‹å\n//                    log.debug(\"å¤„ç†å…³é—­ä¹‹åçš„æ“ä½œ\"); // ä¸èƒ½åœ¨è¿™é‡Œå–„å\n                    break;\n                &#125;\n                channel.writeAndFlush(line);\n            &#125;\n        &#125;, \"input\").start();\n\n        // è·å– CloseFuture å¯¹è±¡ï¼Œ 1) åŒæ­¥å¤„ç†å…³é—­ï¼Œ 2) å¼‚æ­¥å¤„ç†å…³é—­\n        ChannelFuture closeFuture = channel.closeFuture();\n        /*log.debug(\"waiting close...\");\n        closeFuture.sync();\n        log.debug(\"å¤„ç†å…³é—­ä¹‹åçš„æ“ä½œ\");*/\n        closeFuture.addListener(new ChannelFutureListener() &#123;\n            @Override\n            public void operationComplete(ChannelFuture future) throws Exception &#123;\n                log.debug(\"å¤„ç†å…³é—­ä¹‹åçš„æ“ä½œ\");\n                group.shutdownGracefully();\n            &#125;\n        &#125;);\n    &#125;\n&#125;\n\n\n\n\n\nğŸ’¡ å¼‚æ­¥æå‡çš„æ˜¯ä»€ä¹ˆ\nä¸ºä»€ä¹ˆä¸åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å»æ‰§è¡Œå»ºç«‹è¿æ¥ã€å»æ‰§è¡Œå…³é—­ channelï¼Œé‚£æ ·ä¸æ˜¯ä¹Ÿå¯ä»¥å—ï¼Ÿéè¦ç”¨è¿™ä¹ˆå¤æ‚çš„å¼‚æ­¥æ–¹å¼ï¼šæ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹å‘èµ·å»ºç«‹è¿æ¥ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å»çœŸæ­£å»ºç«‹è¿æ¥\n\næ€è€ƒä¸‹é¢çš„åœºæ™¯ï¼Œ4 ä¸ªåŒ»ç”Ÿç»™äººçœ‹ç—…ï¼Œæ¯ä¸ªç—…äººèŠ±è´¹ 20 åˆ†é’Ÿï¼Œè€Œä¸”åŒ»ç”Ÿçœ‹ç—…çš„è¿‡ç¨‹ä¸­æ˜¯ä»¥ç—…äººä¸ºå•ä½çš„ï¼Œä¸€ä¸ªç—…äººçœ‹å®Œäº†ï¼Œæ‰èƒ½çœ‹ä¸‹ä¸€ä¸ªç—…äººã€‚å‡è®¾ç—…äººæºæºä¸æ–­åœ°æ¥ï¼Œå¯ä»¥è®¡ç®—ä¸€ä¸‹ 4 ä¸ªåŒ»ç”Ÿä¸€å¤©å·¥ä½œ 8 å°æ—¶ï¼Œå¤„ç†çš„ç—…äººæ€»æ•°æ˜¯ï¼š4 * 8 * 3 = 96\n\nç»ç ”ç©¶å‘ç°ï¼Œçœ‹ç—…å¯ä»¥ç»†åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼Œç»æ‹†åˆ†åæ¯ä¸ªæ­¥éª¤éœ€è¦ 5 åˆ†é’Ÿï¼Œå¦‚ä¸‹\n\nå› æ­¤å¯ä»¥åšå¦‚ä¸‹ä¼˜åŒ–ï¼Œåªæœ‰ä¸€å¼€å§‹ï¼ŒåŒ»ç”Ÿ 2ã€3ã€4 åˆ†åˆ«è¦ç­‰å¾… 5ã€10ã€15 åˆ†é’Ÿæ‰èƒ½æ‰§è¡Œå·¥ä½œï¼Œä½†åªè¦åç»­ç—…äººæºæºä¸æ–­åœ°æ¥ï¼Œä»–ä»¬å°±èƒ½å¤Ÿæ»¡è´Ÿè·å·¥ä½œï¼Œå¹¶ä¸”å¤„ç†ç—…äººçš„èƒ½åŠ›æé«˜åˆ°äº† 4 * 8 * 12 æ•ˆç‡å‡ ä¹æ˜¯åŸæ¥çš„å››å€\n\nè¦ç‚¹\n\nå•çº¿ç¨‹æ²¡æ³•å¼‚æ­¥æé«˜æ•ˆç‡ï¼Œå¿…é¡»é…åˆå¤šçº¿ç¨‹ã€å¤šæ ¸ cpu æ‰èƒ½å‘æŒ¥å¼‚æ­¥çš„ä¼˜åŠ¿\nå¼‚æ­¥å¹¶æ²¡æœ‰ç¼©çŸ­å“åº”æ—¶é—´ï¼Œåè€Œæœ‰æ‰€å¢åŠ \nåˆç†è¿›è¡Œä»»åŠ¡æ‹†åˆ†ï¼Œä¹Ÿæ˜¯åˆ©ç”¨å¼‚æ­¥çš„å…³é”®\n\nFuture &amp; Promiseåœ¨å¼‚æ­¥å¤„ç†æ—¶ï¼Œç»å¸¸ç”¨åˆ°è¿™ä¸¤ä¸ªæ¥å£\né¦–å…ˆè¦è¯´æ˜ netty ä¸­çš„ Future ä¸ jdk ä¸­çš„ Future åŒåï¼Œä½†æ˜¯æ˜¯ä¸¤ä¸ªæ¥å£ï¼Œnetty çš„ Future ç»§æ‰¿è‡ª jdk çš„ Futureï¼Œè€Œ Promise åˆå¯¹ netty Future è¿›è¡Œäº†æ‰©å±•\n\njdk Future åªèƒ½åŒæ­¥ç­‰å¾…ä»»åŠ¡ç»“æŸï¼ˆæˆ–æˆåŠŸã€æˆ–å¤±è´¥ï¼‰æ‰èƒ½å¾—åˆ°ç»“æœ\nnetty Future å¯ä»¥åŒæ­¥ç­‰å¾…ä»»åŠ¡ç»“æŸå¾—åˆ°ç»“æœï¼Œä¹Ÿå¯ä»¥å¼‚æ­¥æ–¹å¼å¾—åˆ°ç»“æœï¼Œä½†éƒ½æ˜¯è¦ç­‰ä»»åŠ¡ç»“æŸ\nnetty Promise ä¸ä»…æœ‰ netty Future çš„åŠŸèƒ½ï¼Œè€Œä¸”è„±ç¦»äº†ä»»åŠ¡ç‹¬ç«‹å­˜åœ¨ï¼Œåªä½œä¸ºä¸¤ä¸ªçº¿ç¨‹é—´ä¼ é€’ç»“æœçš„å®¹å™¨\n\n\n\n\nåŠŸèƒ½&#x2F;åç§°\njdk Future\nnetty Future\nPromise\n\n\n\ncancel\nå–æ¶ˆä»»åŠ¡\n-\n-\n\n\nisCanceled\nä»»åŠ¡æ˜¯å¦å–æ¶ˆ\n-\n-\n\n\nisDone\nä»»åŠ¡æ˜¯å¦å®Œæˆï¼Œä¸èƒ½åŒºåˆ†æˆåŠŸå¤±è´¥\n-\n-\n\n\nget\nè·å–ä»»åŠ¡ç»“æœï¼Œé˜»å¡ç­‰å¾…\n-\n-\n\n\ngetNow\n-\nè·å–ä»»åŠ¡ç»“æœï¼Œéé˜»å¡ï¼Œè¿˜æœªäº§ç”Ÿç»“æœæ—¶è¿”å› null\n-\n\n\nawait\n-\nç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼Œä¸ä¼šæŠ›å¼‚å¸¸ï¼Œè€Œæ˜¯é€šè¿‡ isSuccess åˆ¤æ–­\n-\n\n\nsync\n-\nç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸\n-\n\n\nisSuccess\n-\nåˆ¤æ–­ä»»åŠ¡æ˜¯å¦æˆåŠŸ\n-\n\n\ncause\n-\nè·å–å¤±è´¥ä¿¡æ¯ï¼Œéé˜»å¡ï¼Œå¦‚æœæ²¡æœ‰å¤±è´¥ï¼Œè¿”å›null\n-\n\n\naddLinstener\n-\næ·»åŠ å›è°ƒï¼Œå¼‚æ­¥æ¥æ”¶ç»“æœ\n-\n\n\nsetSuccess\n-\n-\nè®¾ç½®æˆåŠŸç»“æœ\n\n\nsetFailure\n-\n-\nè®¾ç½®å¤±è´¥ç»“æœ\n\n\nåŒæ­¥å¤„ç†ä»»åŠ¡æˆåŠŸ\nDefaultEventLoop eventExecutors = new DefaultEventLoop();\nDefaultPromise&lt;Integer> promise = new DefaultPromise&lt;>(eventExecutors);\n\neventExecutors.execute(()->&#123;\n    try &#123;\n        Thread.sleep(1000);\n    &#125; catch (InterruptedException e) &#123;\n        e.printStackTrace();\n    &#125;\n    log.debug(\"set success, &#123;&#125;\",10);\n    promise.setSuccess(10);\n&#125;);\n\nlog.debug(\"start...\");\nlog.debug(\"&#123;&#125;\",promise.getNow()); // è¿˜æ²¡æœ‰ç»“æœ\nlog.debug(\"&#123;&#125;\",promise.get());\n\nè¾“å‡º\n11:51:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...\n11:51:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - null\n11:51:54 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set success, 10\n11:51:54 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - 10\n\nå¼‚æ­¥å¤„ç†ä»»åŠ¡æˆåŠŸ\nDefaultEventLoop eventExecutors = new DefaultEventLoop();\nDefaultPromise&lt;Integer> promise = new DefaultPromise&lt;>(eventExecutors);\n\n// è®¾ç½®å›è°ƒï¼Œå¼‚æ­¥æ¥æ”¶ç»“æœ\npromise.addListener(future -> &#123;\n    // è¿™é‡Œçš„ future å°±æ˜¯ä¸Šé¢çš„ promise\n    log.debug(\"&#123;&#125;\",future.getNow());\n&#125;);\n\n// ç­‰å¾… 1000 åè®¾ç½®æˆåŠŸç»“æœ\neventExecutors.execute(()->&#123;\n    try &#123;\n        Thread.sleep(1000);\n    &#125; catch (InterruptedException e) &#123;\n        e.printStackTrace();\n    &#125;\n    log.debug(\"set success, &#123;&#125;\",10);\n    promise.setSuccess(10);\n&#125;);\n\nlog.debug(\"start...\");\n\nè¾“å‡º\n11:49:30 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...\n11:49:31 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set success, 10\n11:49:31 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - 10\n\nåŒæ­¥å¤„ç†ä»»åŠ¡å¤±è´¥ - sync &amp; get\nDefaultEventLoop eventExecutors = new DefaultEventLoop();\n        DefaultPromise&lt;Integer> promise = new DefaultPromise&lt;>(eventExecutors);\n\n        eventExecutors.execute(() -> &#123;\n            try &#123;\n                Thread.sleep(1000);\n            &#125; catch (InterruptedException e) &#123;\n                e.printStackTrace();\n            &#125;\n            RuntimeException e = new RuntimeException(\"error...\");\n            log.debug(\"set failure, &#123;&#125;\", e.toString());\n            promise.setFailure(e);\n        &#125;);\n\n        log.debug(\"start...\");\n        log.debug(\"&#123;&#125;\", promise.getNow());\n        promise.get(); // sync() ä¹Ÿä¼šå‡ºç°å¼‚å¸¸ï¼Œåªæ˜¯ get ä¼šå†ç”¨ ExecutionException åŒ…ä¸€å±‚å¼‚å¸¸\n\nè¾“å‡º\n12:11:07 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...\n12:11:07 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - null\n12:11:08 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set failure, java.lang.RuntimeException: error...\nException in thread &quot;main&quot; java.util.concurrent.ExecutionException: java.lang.RuntimeException: error...\n\tat io.netty.util.concurrent.AbstractFuture.get(AbstractFuture.java:41)\n\tat com.itcast.oio.DefaultPromiseTest2.main(DefaultPromiseTest2.java:34)\nCaused by: java.lang.RuntimeException: error...\n\tat com.itcast.oio.DefaultPromiseTest2.lambda$main$0(DefaultPromiseTest2.java:27)\n\tat io.netty.channel.DefaultEventLoop.run(DefaultEventLoop.java:54)\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\n\tat java.lang.Thread.run(Thread.java:745)\n\nåŒæ­¥å¤„ç†ä»»åŠ¡å¤±è´¥ - await\nDefaultEventLoop eventExecutors = new DefaultEventLoop();\nDefaultPromise&lt;Integer> promise = new DefaultPromise&lt;>(eventExecutors);\n\neventExecutors.execute(() -> &#123;\n    try &#123;\n        Thread.sleep(1000);\n    &#125; catch (InterruptedException e) &#123;\n        e.printStackTrace();\n    &#125;\n    RuntimeException e = new RuntimeException(\"error...\");\n    log.debug(\"set failure, &#123;&#125;\", e.toString());\n    promise.setFailure(e);\n&#125;);\n\nlog.debug(\"start...\");\nlog.debug(\"&#123;&#125;\", promise.getNow());\npromise.await(); // ä¸ sync å’Œ get åŒºåˆ«åœ¨äºï¼Œä¸ä¼šæŠ›å¼‚å¸¸\nlog.debug(\"result &#123;&#125;\", (promise.isSuccess() ? promise.getNow() : promise.cause()).toString());\n\nè¾“å‡º\n12:18:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...\n12:18:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - null\n12:18:54 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set failure, java.lang.RuntimeException: error...\n12:18:54 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - result java.lang.RuntimeException: error...\n\nå¼‚æ­¥å¤„ç†ä»»åŠ¡å¤±è´¥addListenerï¼ˆå›è°ƒï¼‰\nDefaultEventLoop eventExecutors = new DefaultEventLoop();\nDefaultPromise&lt;Integer> promise = new DefaultPromise&lt;>(eventExecutors);\n\npromise.addListener(future -> &#123;\n    log.debug(\"result &#123;&#125;\", (promise.isSuccess() ? promise.getNow() : promise.cause()).toString());\n&#125;);\n\neventExecutors.execute(() -> &#123;\n    try &#123;\n        Thread.sleep(1000);\n    &#125; catch (InterruptedException e) &#123;\n        e.printStackTrace();\n    &#125;\n    RuntimeException e = new RuntimeException(\"error...\");\n    log.debug(\"set failure, &#123;&#125;\", e.toString());\n    promise.setFailure(e);\n&#125;);\n\nlog.debug(\"start...\");\n\nè¾“å‡º\n12:04:57 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...\n12:04:58 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set failure, java.lang.RuntimeException: error...\n12:04:58 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - result java.lang.RuntimeException: error...\n\nawait æ­»é”æ£€æŸ¥\nDefaultEventLoop eventExecutors = new DefaultEventLoop();\nDefaultPromise&lt;Integer> promise = new DefaultPromise&lt;>(eventExecutors);\n\neventExecutors.submit(()->&#123;\n    System.out.println(\"1\");\n    try &#123;\n        promise.await();\n        // æ³¨æ„ä¸èƒ½ä»…æ•è· InterruptedException å¼‚å¸¸\n        // å¦åˆ™ æ­»é”æ£€æŸ¥æŠ›å‡ºçš„ BlockingOperationException ä¼šç»§ç»­å‘ä¸Šä¼ æ’­\n        // è€Œæäº¤çš„ä»»åŠ¡ä¼šè¢«åŒ…è£…ä¸º PromiseTaskï¼Œå®ƒçš„ run æ–¹æ³•ä¸­ä¼š catch æ‰€æœ‰å¼‚å¸¸ç„¶åè®¾ç½®ä¸º Promise çš„å¤±è´¥ç»“æœè€Œä¸ä¼šæŠ›å‡º\n    &#125; catch (Exception e) &#123; \n        e.printStackTrace();\n    &#125;\n    System.out.println(\"2\");\n&#125;);\neventExecutors.submit(()->&#123;\n    System.out.println(\"3\");\n    try &#123;\n        promise.await();\n    &#125; catch (Exception e) &#123;\n        e.printStackTrace();\n    &#125;\n    System.out.println(\"4\");\n&#125;);\n\nè¾“å‡º\n1\n2\n3\n4\nio.netty.util.concurrent.BlockingOperationException: DefaultPromise@47499c2a(incomplete)\n\tat io.netty.util.concurrent.DefaultPromise.checkDeadLock(DefaultPromise.java:384)\n\tat io.netty.util.concurrent.DefaultPromise.await(DefaultPromise.java:212)\n\tat com.itcast.oio.DefaultPromiseTest.lambda$main$0(DefaultPromiseTest.java:27)\n\tat io.netty.util.concurrent.PromiseTask$RunnableAdapter.call(PromiseTask.java:38)\n\tat io.netty.util.concurrent.PromiseTask.run(PromiseTask.java:73)\n\tat io.netty.channel.DefaultEventLoop.run(DefaultEventLoop.java:54)\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\n\tat java.lang.Thread.run(Thread.java:745)\nio.netty.util.concurrent.BlockingOperationException: DefaultPromise@47499c2a(incomplete)\n\tat io.netty.util.concurrent.DefaultPromise.checkDeadLock(DefaultPromise.java:384)\n\tat io.netty.util.concurrent.DefaultPromise.await(DefaultPromise.java:212)\n\tat com.itcast.oio.DefaultPromiseTest.lambda$main$1(DefaultPromiseTest.java:36)\n\tat io.netty.util.concurrent.PromiseTask$RunnableAdapter.call(PromiseTask.java:38)\n\tat io.netty.util.concurrent.PromiseTask.run(PromiseTask.java:73)\n\tat io.netty.channel.DefaultEventLoop.run(DefaultEventLoop.java:54)\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\n\tat java.lang.Thread.run(Thread.java:745)\n\n\nHandler &amp; PipelineChannelHandler ç”¨æ¥å¤„ç† Channel ä¸Šçš„å„ç§äº‹ä»¶ï¼Œåˆ†ä¸ºå…¥ç«™ã€å‡ºç«™ä¸¤ç§ã€‚æ‰€æœ‰ ChannelHandler è¢«è¿æˆä¸€ä¸²ï¼Œå°±æ˜¯ Pipeline\n\nå…¥ç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelInboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦ç”¨æ¥è¯»å–å®¢æˆ·ç«¯æ•°æ®ï¼Œå†™å›ç»“æœ\nå‡ºç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelOutboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦å¯¹å†™å›ç»“æœè¿›è¡ŒåŠ å·¥\n\næ‰“ä¸ªæ¯”å–»ï¼Œæ¯ä¸ª Channel æ˜¯ä¸€ä¸ªäº§å“çš„åŠ å·¥è½¦é—´ï¼ŒPipeline æ˜¯è½¦é—´ä¸­çš„æµæ°´çº¿ï¼ŒChannelHandler å°±æ˜¯æµæ°´çº¿ä¸Šçš„å„é“å·¥åºï¼Œè€Œåé¢è¦è®²çš„ ByteBuf æ˜¯åŸææ–™ï¼Œç»è¿‡å¾ˆå¤šå·¥åºçš„åŠ å·¥ï¼šå…ˆç»è¿‡ä¸€é“é“å…¥ç«™å·¥åºï¼Œå†ç»è¿‡ä¸€é“é“å‡ºç«™å·¥åºæœ€ç»ˆå˜æˆäº§å“\nå…ˆææ¸…æ¥šé¡ºåºï¼ŒæœåŠ¡ç«¯\nnew ServerBootstrap()\n    .group(new NioEventLoopGroup())\n    .channel(NioServerSocketChannel.class)\n    .childHandler(new ChannelInitializer&lt;NioSocketChannel>() &#123;\n        protected void initChannel(NioSocketChannel ch) &#123;\n            ch.pipeline().addLast(new ChannelInboundHandlerAdapter()&#123;\n                @Override\n                public void channelRead(ChannelHandlerContext ctx, Object msg) &#123;\n                    System.out.println(1);\n                    ctx.fireChannelRead(msg); // 1\n                &#125;\n            &#125;);\n            ch.pipeline().addLast(new ChannelInboundHandlerAdapter()&#123;\n                @Override\n                public void channelRead(ChannelHandlerContext ctx, Object msg) &#123;\n                    System.out.println(2);\n                    ctx.fireChannelRead(msg); // 2\n                &#125;\n            &#125;);\n            ch.pipeline().addLast(new ChannelInboundHandlerAdapter()&#123;\n                @Override\n                public void channelRead(ChannelHandlerContext ctx, Object msg) &#123;\n                    System.out.println(3);\n                    ctx.channel().write(msg); // 3\n                &#125;\n            &#125;);\n            ch.pipeline().addLast(new ChannelOutboundHandlerAdapter()&#123;\n                @Override\n                public void write(ChannelHandlerContext ctx, Object msg, \n                                  ChannelPromise promise) &#123;\n                    System.out.println(4);\n                    ctx.write(msg, promise); // 4\n                &#125;\n            &#125;);\n            ch.pipeline().addLast(new ChannelOutboundHandlerAdapter()&#123;\n                @Override\n                public void write(ChannelHandlerContext ctx, Object msg, \n                                  ChannelPromise promise) &#123;\n                    System.out.println(5);\n                    ctx.write(msg, promise); // 5\n                &#125;\n            &#125;);\n            ch.pipeline().addLast(new ChannelOutboundHandlerAdapter()&#123;\n                @Override\n                public void write(ChannelHandlerContext ctx, Object msg, \n                                  ChannelPromise promise) &#123;\n                    System.out.println(6);\n                    ctx.write(msg, promise); // 6\n                &#125;\n            &#125;);\n        &#125;\n    &#125;)\n    .bind(8080);\n\nå®¢æˆ·ç«¯\nnew Bootstrap()\n    .group(new NioEventLoopGroup())\n    .channel(NioSocketChannel.class)\n    .handler(new ChannelInitializer&lt;Channel>() &#123;\n        @Override\n        protected void initChannel(Channel ch) &#123;\n            ch.pipeline().addLast(new StringEncoder());\n        &#125;\n    &#125;)\n    .connect(\"127.0.0.1\", 8080)\n    .addListener((ChannelFutureListener) future -> &#123;\n        future.channel().writeAndFlush(\"hello,world\");\n    &#125;);\n\næœåŠ¡å™¨ç«¯æ‰“å°ï¼š\n1\n2\n3\n6\n5\n4\n\nå¯ä»¥çœ‹åˆ°ï¼ŒChannelInboundHandlerAdapter æ˜¯æŒ‰ç…§ addLast çš„é¡ºåºæ‰§è¡Œçš„ï¼Œè€Œ ChannelOutboundHandlerAdapter æ˜¯æŒ‰ç…§ addLast çš„é€†åºæ‰§è¡Œçš„ã€‚ChannelPipeline çš„å®ç°æ˜¯ä¸€ä¸ª ChannelHandlerContextï¼ˆåŒ…è£…äº† ChannelHandlerï¼‰ ç»„æˆçš„åŒå‘é“¾è¡¨\n\n\nå…¥ç«™å¤„ç†å™¨ä¸­ï¼Œctx.fireChannelRead(msg) æ˜¯ è°ƒç”¨ä¸‹ä¸€ä¸ªå…¥ç«™å¤„ç†å™¨\nå¦‚æœæ³¨é‡Šæ‰ 1 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1\nå¦‚æœæ³¨é‡Šæ‰ 2 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1 2\n\n\n3 å¤„çš„ ctx.channel().write(msg) ä¼š ä»å°¾éƒ¨å¼€å§‹è§¦å‘ åç»­å‡ºç«™å¤„ç†å™¨çš„æ‰§è¡Œ\nå¦‚æœæ³¨é‡Šæ‰ 3 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1 2 3\n\n\nç±»ä¼¼çš„ï¼Œå‡ºç«™å¤„ç†å™¨ä¸­ï¼Œctx.write(msg, promise) çš„è°ƒç”¨ä¹Ÿä¼š è§¦å‘ä¸Šä¸€ä¸ªå‡ºç«™å¤„ç†å™¨\nå¦‚æœæ³¨é‡Šæ‰ 6 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1 2 3 6\n\n\nctx.channel().write(msg) vs ctx.write(msg)\néƒ½æ˜¯è§¦å‘å‡ºç«™å¤„ç†å™¨çš„æ‰§è¡Œ\nctx.channel().write(msg) ä»å°¾éƒ¨å¼€å§‹æŸ¥æ‰¾å‡ºç«™å¤„ç†å™¨\nctx.write(msg) æ˜¯ä»å½“å‰èŠ‚ç‚¹æ‰¾ä¸Šä¸€ä¸ªå‡ºç«™å¤„ç†å™¨\n3 å¤„çš„ ctx.channel().write(msg) å¦‚æœæ”¹ä¸º ctx.write(msg) ä»…ä¼šæ‰“å° 1 2 3ï¼Œå› ä¸ºèŠ‚ç‚¹3 ä¹‹å‰æ²¡æœ‰å…¶å®ƒå‡ºç«™å¤„ç†å™¨äº†\n6 å¤„çš„ ctx.write(msg, promise) å¦‚æœæ”¹ä¸º ctx.channel().write(msg) ä¼šæ‰“å° 1 2 3 6 6 6â€¦ å› ä¸º ctx.channel().write() æ˜¯ä»å°¾éƒ¨å¼€å§‹æŸ¥æ‰¾ï¼Œç»“æœåˆæ˜¯èŠ‚ç‚¹6 è‡ªå·±\n\n\n\nå›¾1 - æœåŠ¡ç«¯ pipeline è§¦å‘çš„åŸå§‹æµç¨‹ï¼Œå›¾ä¸­æ•°å­—ä»£è¡¨äº†å¤„ç†æ­¥éª¤çš„å…ˆåæ¬¡åº\n\nByteBufæ˜¯å¯¹å­—èŠ‚æ•°æ®çš„å°è£…\nåˆ›å»ºByteBuf buffer = ByteBufAllocator.DEFAULT.buffer(10);\nlog(buffer);\n\nä¸Šé¢ä»£ç åˆ›å»ºäº†ä¸€ä¸ªé»˜è®¤çš„ ByteBufï¼ˆæ± åŒ–åŸºäºç›´æ¥å†…å­˜çš„ ByteBufã€‚ç›´æ¥å†…å­˜åˆ™æ˜¯åœ¨æ“ä½œç³»ç»Ÿå±‚é¢ä¸Šåˆ†é…çš„å†…å­˜ï¼Œä¸å—Javaè™šæ‹Ÿæœºçš„ç®¡ç†ã€‚ï¼‰ï¼Œåˆå§‹å®¹é‡æ˜¯ 10\nè¾“å‡º\nread index:0 write index:0 capacity:10\n\nå…¶ä¸­ log æ–¹æ³•å‚è€ƒå¦‚ä¸‹\nprivate static void log(ByteBuf buffer) &#123;\n    int length = buffer.readableBytes();\n    int rows = length / 16 + (length % 15 == 0 ? 0 : 1) + 4;\n    StringBuilder buf = new StringBuilder(rows * 80 * 2)\n        .append(\"read index:\").append(buffer.readerIndex())\n        .append(\" write index:\").append(buffer.writerIndex())\n        .append(\" capacity:\").append(buffer.capacity())\n        .append(NEWLINE);\n    appendPrettyHexDump(buf, buffer);\n    System.out.println(buf.toString());\n&#125;\n\nç›´æ¥å†…å­˜ vs å †å†…å­˜å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç æ¥åˆ›å»ºæ± åŒ–åŸºäºå †çš„ ByteBuf\nByteBuf buffer = ByteBufAllocator.DEFAULT.heapBuffer(10);\n\nä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç æ¥åˆ›å»ºæ± åŒ–åŸºäºç›´æ¥å†…å­˜çš„ ByteBuf\nByteBuf buffer = ByteBufAllocator.DEFAULT.directBuffer(10);\n\n\nç›´æ¥å†…å­˜åˆ›å»ºå’Œé”€æ¯çš„ä»£ä»·æ˜‚è´µï¼Œä½†è¯»å†™æ€§èƒ½é«˜ï¼ˆå°‘ä¸€æ¬¡å†…å­˜å¤åˆ¶ï¼‰ï¼Œé€‚åˆé…åˆæ± åŒ–åŠŸèƒ½ä¸€èµ·ç”¨\nç›´æ¥å†…å­˜ä¸è¢«GCï¼Œå› ä¸ºè¿™éƒ¨åˆ†å†…å­˜ä¸å— JVM åƒåœ¾å›æ”¶çš„ç®¡ç†ï¼Œä½†ä¹Ÿè¦æ³¨æ„åŠæ—¶ä¸»åŠ¨é‡Šæ”¾\n\næ± åŒ– vs éæ± åŒ–æ± åŒ–çš„æœ€å¤§æ„ä¹‰åœ¨äºå¯ä»¥é‡ç”¨ ByteBufï¼Œä¼˜ç‚¹æœ‰\n\næ²¡æœ‰æ± åŒ–ï¼Œåˆ™æ¯æ¬¡éƒ½å¾—åˆ›å»ºæ–°çš„ ByteBuf å®ä¾‹ï¼Œè¿™ä¸ªæ“ä½œå¯¹ç›´æ¥å†…å­˜ä»£ä»·æ˜‚è´µï¼Œå°±ç®—æ˜¯å †å†…å­˜ï¼Œä¹Ÿä¼šå¢åŠ  GC å‹åŠ›\næœ‰äº†æ± åŒ–ï¼Œåˆ™å¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œå¹¶ä¸”é‡‡ç”¨äº†ä¸ jemalloc ç±»ä¼¼çš„å†…å­˜åˆ†é…ç®—æ³•æå‡åˆ†é…æ•ˆç‡\né«˜å¹¶å‘æ—¶ï¼Œæ± åŒ–åŠŸèƒ½æ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½\n\næ± åŒ–åŠŸèƒ½æ˜¯å¦å¼€å¯ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„ç³»ç»Ÿç¯å¢ƒå˜é‡æ¥è®¾ç½®\n-Dio.netty.allocator.type=&#123;unpooled|pooled&#125;\n\n\n4.1 ä»¥åï¼Œé Android å¹³å°é»˜è®¤å¯ç”¨æ± åŒ–å®ç°ï¼ŒAndroid å¹³å°å¯ç”¨éæ± åŒ–å®ç°\n4.1 ä¹‹å‰ï¼Œæ± åŒ–åŠŸèƒ½è¿˜ä¸æˆç†Ÿï¼Œé»˜è®¤æ˜¯éæ± åŒ–å®ç°\n\nç»„æˆByteBuf ç”±å››éƒ¨åˆ†ç»„æˆ\n\næœ€å¼€å§‹è¯»å†™æŒ‡é’ˆéƒ½åœ¨ 0 ä½ç½®\nå†™å…¥æ–¹æ³•åˆ—è¡¨ï¼Œçœç•¥ä¸€äº›ä¸é‡è¦çš„æ–¹æ³•\n\n\n\næ–¹æ³•ç­¾å\nå«ä¹‰\nå¤‡æ³¨\n\n\n\nwriteBoolean(boolean value)\nå†™å…¥ boolean å€¼\nç”¨ä¸€å­—èŠ‚ 01|00 ä»£è¡¨ true|false\n\n\nwriteByte(int value)\nå†™å…¥ byte å€¼\n\n\n\nwriteShort(int value)\nå†™å…¥ short å€¼\n\n\n\nwriteInt(int value)\nå†™å…¥ int å€¼\nBig Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 00 00 02 50\n\n\nwriteIntLE(int value)\nå†™å…¥ int å€¼\nLittle Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 50 02 00 00\n\n\nwriteLong(long value)\nå†™å…¥ long å€¼\n\n\n\nwriteChar(int value)\nå†™å…¥ char å€¼\n\n\n\nwriteFloat(float value)\nå†™å…¥ float å€¼\n\n\n\nwriteDouble(double value)\nå†™å…¥ double å€¼\n\n\n\nwriteBytes(ByteBuf src)\nå†™å…¥ netty çš„ ByteBuf\n\n\n\nwriteBytes(byte[] src)\nå†™å…¥ byte[]\n\n\n\nwriteBytes(ByteBuffer src)\nå†™å…¥ nio çš„ ByteBuffer\n\n\n\nint writeCharSequence(CharSequence sequence, Charset charset)\nå†™å…¥å­—ç¬¦ä¸²\n\n\n\n\n\n\n\n\n\n\n\n\næ³¨æ„\n\nè¿™äº›æ–¹æ³•çš„æœªæŒ‡æ˜è¿”å›å€¼çš„ï¼Œå…¶è¿”å›å€¼éƒ½æ˜¯ ByteBufï¼Œæ„å‘³ç€å¯ä»¥é“¾å¼è°ƒç”¨\nç½‘ç»œä¼ è¾“ï¼Œé»˜è®¤ä¹ æƒ¯æ˜¯ Big Endian\n\nå…ˆå†™å…¥ 4 ä¸ªå­—èŠ‚\nbuffer.writeBytes(new byte[]&#123;1, 2, 3, 4&#125;);\nlog(buffer);\n\nç»“æœæ˜¯\nread index:0 write index:4 capacity:10\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 01 02 03 04                                     |....            |\n+--------+-------------------------------------------------+----------------+\n\nå†å†™å…¥ä¸€ä¸ª int æ•´æ•°ï¼Œä¹Ÿæ˜¯ 4 ä¸ªå­—èŠ‚\nbuffer.writeInt(5);\nlog(buffer);\n\nç»“æœæ˜¯\nread index:0 write index:8 capacity:10\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 01 02 03 04 00 00 00 05                         |........        |\n+--------+-------------------------------------------------+----------------+\n\n\n\nè¿˜æœ‰ä¸€ç±»æ–¹æ³•æ˜¯ set å¼€å¤´çš„ä¸€ç³»åˆ—æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥å†™å…¥æ•°æ®ï¼Œä½†ä¸ä¼šæ”¹å˜å†™æŒ‡é’ˆä½ç½®\næ‰©å®¹å†å†™å…¥ä¸€ä¸ª int æ•´æ•°æ—¶ï¼Œå®¹é‡ä¸å¤Ÿäº†ï¼ˆåˆå§‹å®¹é‡æ˜¯ 10ï¼‰ï¼Œè¿™æ—¶ä¼šå¼•å‘æ‰©å®¹\nbuffer.writeInt(6);\nlog(buffer);\n\næ‰©å®¹è§„åˆ™æ˜¯\n\nå¦‚ä½•å†™å…¥åæ•°æ®å¤§å°æœªè¶…è¿‡ 512ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 16 çš„æ•´æ•°å€ï¼Œä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 12 ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 16\nå¦‚æœå†™å…¥åæ•°æ®å¤§å°è¶…è¿‡ 512ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 2^nï¼Œä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 513ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 2^10&#x3D;1024ï¼ˆ2^9&#x3D;512 å·²ç»ä¸å¤Ÿäº†ï¼‰\næ‰©å®¹ä¸èƒ½è¶…è¿‡ max capacity ä¼šæŠ¥é”™\n\nç»“æœæ˜¯\nread index:0 write index:12 capacity:16\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 01 02 03 04 00 00 00 05 00 00 00 06             |............    |\n+--------+-------------------------------------------------+----------------+\n\nè¯»å–ä¾‹å¦‚è¯»äº† 4 æ¬¡ï¼Œæ¯æ¬¡ä¸€ä¸ªå­—èŠ‚\nSystem.out.println(buffer.readByte());\nSystem.out.println(buffer.readByte());\nSystem.out.println(buffer.readByte());\nSystem.out.println(buffer.readByte());\nlog(buffer);\n\nè¯»è¿‡çš„å†…å®¹ï¼Œå°±å±äºåºŸå¼ƒéƒ¨åˆ†äº†ï¼Œå†è¯»åªèƒ½è¯»é‚£äº›å°šæœªè¯»å–çš„éƒ¨åˆ†\n1\n2\n3\n4\nread index:4 write index:12 capacity:16\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 00 00 00 05 00 00 00 06                         |........        |\n+--------+-------------------------------------------------+----------------+\n\nå¦‚æœéœ€è¦é‡å¤è¯»å– int æ•´æ•° 5ï¼Œæ€ä¹ˆåŠï¼Ÿ\nå¯ä»¥åœ¨ read å‰å…ˆåšä¸ªæ ‡è®° mark\nbuffer.markReaderIndex();\nSystem.out.println(buffer.readInt());\nlog(buffer);\n\nç»“æœ\n5\nread index:8 write index:12 capacity:16\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 00 00 00 06                                     |....            |\n+--------+-------------------------------------------------+----------------+\n\nè¿™æ—¶è¦é‡å¤è¯»å–çš„è¯ï¼Œé‡ç½®åˆ°æ ‡è®°ä½ç½® reset\nbuffer.resetReaderIndex();\nlog(buffer);\n\nè¿™æ—¶\nread index:4 write index:12 capacity:16\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 00 00 00 05 00 00 00 06                         |........        |\n+--------+-------------------------------------------------+----------------+\n\nè¿˜æœ‰ç§åŠæ³•æ˜¯é‡‡ç”¨ get å¼€å¤´çš„ä¸€ç³»åˆ—æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ä¸ä¼šæ”¹å˜ read index\nretain &amp; releaseç”±äº Netty ä¸­æœ‰å †å¤–å†…å­˜çš„ ByteBuf å®ç°ï¼Œå †å¤–å†…å­˜æœ€å¥½æ˜¯æ‰‹åŠ¨æ¥é‡Šæ”¾ï¼Œè€Œä¸æ˜¯ç­‰ GC åƒåœ¾å›æ”¶ã€‚\n\nUnpooledHeapByteBuf ä½¿ç”¨çš„æ˜¯ JVM å†…å­˜ï¼Œåªéœ€ç­‰ GC å›æ”¶å†…å­˜å³å¯\nUnpooledDirectByteBuf ä½¿ç”¨çš„å°±æ˜¯ç›´æ¥å†…å­˜äº†ï¼Œéœ€è¦ç‰¹æ®Šçš„æ–¹æ³•æ¥å›æ”¶å†…å­˜\nPooledByteBuf å’Œå®ƒçš„å­ç±»ä½¿ç”¨äº†æ± åŒ–æœºåˆ¶ï¼Œéœ€è¦æ›´å¤æ‚çš„è§„åˆ™æ¥å›æ”¶å†…å­˜\n\n\n\n\n\n\n\n\n\n\nå›æ”¶å†…å­˜çš„æºç å®ç°ï¼Œè¯·å…³æ³¨ä¸‹é¢æ–¹æ³•çš„ä¸åŒå®ç°\nprotected abstract void deallocate()\nNetty è¿™é‡Œé‡‡ç”¨äº†å¼•ç”¨è®¡æ•°æ³•æ¥æ§åˆ¶å›æ”¶å†…å­˜ï¼Œæ¯ä¸ª ByteBuf éƒ½å®ç°äº† ReferenceCounted æ¥å£\n\næ¯ä¸ª ByteBuf å¯¹è±¡çš„åˆå§‹è®¡æ•°ä¸º 1\nè°ƒç”¨ release æ–¹æ³•è®¡æ•°å‡ 1ï¼Œå¦‚æœè®¡æ•°ä¸º 0ï¼ŒByteBuf å†…å­˜è¢«å›æ”¶\nè°ƒç”¨ retain æ–¹æ³•è®¡æ•°åŠ  1ï¼Œè¡¨ç¤ºè°ƒç”¨è€…æ²¡ç”¨å®Œä¹‹å‰ï¼Œå…¶å®ƒ handler å³ä½¿è°ƒç”¨äº† release ä¹Ÿä¸ä¼šé€ æˆå›æ”¶\nå½“è®¡æ•°ä¸º 0 æ—¶ï¼Œåº•å±‚å†…å­˜ä¼šè¢«å›æ”¶ï¼Œè¿™æ—¶å³ä½¿ ByteBuf å¯¹è±¡è¿˜åœ¨ï¼Œå…¶å„ä¸ªæ–¹æ³•å‡æ— æ³•æ­£å¸¸ä½¿ç”¨\n\nè°æ¥è´Ÿè´£ release å‘¢ï¼Ÿ\nä¸æ˜¯æˆ‘ä»¬æƒ³è±¡çš„ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹ï¼‰\nByteBuf buf = ...\ntry &#123;\n    ...\n&#125; finally &#123;\n    buf.release();\n&#125;\n\nè¯·æ€è€ƒï¼Œå› ä¸º pipeline çš„å­˜åœ¨ï¼Œä¸€èˆ¬éœ€è¦å°† ByteBuf ä¼ é€’ç»™ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¦‚æœåœ¨ finally ä¸­ release äº†ï¼Œå°±å¤±å»äº†ä¼ é€’æ€§ï¼ˆå½“ç„¶ï¼Œå¦‚æœåœ¨è¿™ä¸ª ChannelHandler å†…è¿™ä¸ª ByteBuf å·²å®Œæˆäº†å®ƒçš„ä½¿å‘½ï¼Œé‚£ä¹ˆä¾¿æ— é¡»å†ä¼ é€’ï¼‰\nåŸºæœ¬è§„åˆ™æ˜¯ï¼Œè°æ˜¯æœ€åä½¿ç”¨è€…ï¼Œè°è´Ÿè´£ releaseï¼Œè¯¦ç»†åˆ†æå¦‚ä¸‹\n\nèµ·ç‚¹ï¼Œå¯¹äº NIO å®ç°æ¥è®²ï¼Œåœ¨ io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe#read æ–¹æ³•ä¸­é¦–æ¬¡åˆ›å»º ByteBuf æ”¾å…¥ pipelineï¼ˆline 163 pipeline.fireChannelRead(byteBuf)ï¼‰\nå…¥ç«™ ByteBuf å¤„ç†åŸåˆ™\nå¯¹åŸå§‹ ByteBuf ä¸åšå¤„ç†ï¼Œè°ƒç”¨ ctx.fireChannelRead(msg) å‘åä¼ é€’ï¼Œè¿™æ—¶æ— é¡» release\nå°†åŸå§‹ ByteBuf è½¬æ¢ä¸ºå…¶å®ƒç±»å‹çš„ Java å¯¹è±¡ï¼Œè¿™æ—¶ ByteBuf å°±æ²¡ç”¨äº†ï¼Œå¿…é¡» release\nå¦‚æœä¸è°ƒç”¨ ctx.fireChannelRead(msg) å‘åä¼ é€’ï¼Œé‚£ä¹ˆä¹Ÿå¿…é¡» release\næ³¨æ„å„ç§å¼‚å¸¸ï¼Œå¦‚æœ ByteBuf æ²¡æœ‰æˆåŠŸä¼ é€’åˆ°ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¿…é¡» release\nå‡è®¾æ¶ˆæ¯ä¸€ç›´å‘åä¼ ï¼Œé‚£ä¹ˆ TailContext ä¼šè´Ÿè´£é‡Šæ”¾æœªå¤„ç†æ¶ˆæ¯ï¼ˆåŸå§‹çš„ ByteBufï¼‰\n\n\nå‡ºç«™ ByteBuf å¤„ç†åŸåˆ™\nå‡ºç«™æ¶ˆæ¯æœ€ç»ˆéƒ½ä¼šè½¬ä¸º ByteBuf è¾“å‡ºï¼Œä¸€ç›´å‘å‰ä¼ ï¼Œç”± HeadContext flush å release\n\n\nå¼‚å¸¸å¤„ç†åŸåˆ™\næœ‰æ—¶å€™ä¸æ¸…æ¥š ByteBuf è¢«å¼•ç”¨äº†å¤šå°‘æ¬¡ï¼Œä½†åˆå¿…é¡»å½»åº•é‡Šæ”¾ï¼Œå¯ä»¥å¾ªç¯è°ƒç”¨ release ç›´åˆ°è¿”å› true\n\n\n\nTailContext é‡Šæ”¾æœªå¤„ç†æ¶ˆæ¯é€»è¾‘\n// io.netty.channel.DefaultChannelPipeline#onUnhandledInboundMessage(java.lang.Object)\nprotected void onUnhandledInboundMessage(Object msg) &#123;\n    try &#123;\n        logger.debug(\n            \"Discarded inbound message &#123;&#125; that reached at the tail of the pipeline. \" +\n            \"Please check your pipeline configuration.\", msg);\n    &#125; finally &#123;\n        ReferenceCountUtil.release(msg);\n    &#125;\n&#125;\n\nå…·ä½“ä»£ç \n// io.netty.util.ReferenceCountUtil#release(java.lang.Object)\npublic static boolean release(Object msg) &#123;\n    if (msg instanceof ReferenceCounted) &#123;\n        return ((ReferenceCounted) msg).release();\n    &#125;\n    return false;\n&#125;\n\nsliceã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå¯¹åŸå§‹ ByteBuf è¿›è¡Œåˆ‡ç‰‡æˆå¤šä¸ª ByteBufï¼Œåˆ‡ç‰‡åçš„ ByteBuf å¹¶æ²¡æœ‰å‘ç”Ÿå†…å­˜å¤åˆ¶ï¼Œè¿˜æ˜¯ä½¿ç”¨åŸå§‹ ByteBuf çš„å†…å­˜ï¼Œåˆ‡ç‰‡åçš„ ByteBuf ç»´æŠ¤ç‹¬ç«‹çš„ readï¼Œwrite æŒ‡é’ˆ\n\nä¾‹ï¼ŒåŸå§‹ ByteBuf è¿›è¡Œä¸€äº›åˆå§‹æ“ä½œ\nByteBuf origin = ByteBufAllocator.DEFAULT.buffer(10);\norigin.writeBytes(new byte[]&#123;1, 2, 3, 4&#125;);\norigin.readByte();\nSystem.out.println(ByteBufUtil.prettyHexDump(origin));\n\nè¾“å‡º\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 02 03 04                                        |...             |\n+--------+-------------------------------------------------+----------------+\n\nè¿™æ—¶è°ƒç”¨ slice è¿›è¡Œåˆ‡ç‰‡ï¼Œæ— å‚ slice æ˜¯ä»åŸå§‹ ByteBuf çš„ read index åˆ° write index ä¹‹é—´çš„å†…å®¹è¿›è¡Œåˆ‡ç‰‡ï¼Œåˆ‡ç‰‡åçš„ max capacity è¢«å›ºå®šä¸ºè¿™ä¸ªåŒºé—´çš„å¤§å°ï¼Œå› æ­¤ä¸èƒ½è¿½åŠ  write\nByteBuf slice = origin.slice();\nSystem.out.println(ByteBufUtil.prettyHexDump(slice));\n// slice.writeByte(5); å¦‚æœæ‰§è¡Œï¼Œä¼šæŠ¥ IndexOutOfBoundsException å¼‚å¸¸\n\nè¾“å‡º\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 02 03 04                                        |...             |\n+--------+-------------------------------------------------+----------------+\n\nå¦‚æœåŸå§‹ ByteBuf å†æ¬¡è¯»æ“ä½œï¼ˆåˆè¯»äº†ä¸€ä¸ªå­—èŠ‚ï¼‰\norigin.readByte();\nSystem.out.println(ByteBufUtil.prettyHexDump(origin));\n\nè¾“å‡º\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 03 04                                           |..              |\n+--------+-------------------------------------------------+----------------+\n\nè¿™æ—¶çš„ slice ä¸å—å½±å“ï¼Œå› ä¸ºå®ƒæœ‰ç‹¬ç«‹çš„è¯»å†™æŒ‡é’ˆ\nSystem.out.println(ByteBufUtil.prettyHexDump(slice));\n\nè¾“å‡º\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 02 03 04                                        |...             |\n+--------+-------------------------------------------------+----------------+\n\nå¦‚æœ slice çš„å†…å®¹å‘ç”Ÿäº†æ›´æ”¹\nslice.setByte(2, 5);\nSystem.out.println(ByteBufUtil.prettyHexDump(slice));\n\nè¾“å‡º\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 02 03 05                                        |...             |\n+--------+-------------------------------------------------+----------------+\n\nè¿™æ—¶ï¼ŒåŸå§‹ ByteBuf ä¹Ÿä¼šå—å½±å“ï¼Œå› ä¸ºåº•å±‚éƒ½æ˜¯åŒä¸€å—å†…å­˜\nSystem.out.println(ByteBufUtil.prettyHexDump(origin));\n\nè¾“å‡º\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 03 05                                           |..              |\n+--------+-------------------------------------------------+----------------+\n\n\n\n10ï¼‰duplicateã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå°±å¥½æ¯”æˆªå–äº†åŸå§‹ ByteBuf æ‰€æœ‰å†…å®¹ï¼Œå¹¶ä¸”æ²¡æœ‰ max capacity çš„é™åˆ¶ï¼Œä¹Ÿæ˜¯ä¸åŸå§‹ ByteBuf ä½¿ç”¨åŒä¸€å—åº•å±‚å†…å­˜ï¼Œåªæ˜¯è¯»å†™æŒ‡é’ˆæ˜¯ç‹¬ç«‹çš„\n\n11ï¼‰copyä¼šå°†åº•å±‚å†…å­˜æ•°æ®è¿›è¡Œæ·±æ‹·è´ï¼Œå› æ­¤æ— è®ºè¯»å†™ï¼Œéƒ½ä¸åŸå§‹ ByteBuf æ— å…³\n12ï¼‰CompositeByteBufã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå¯ä»¥å°†å¤šä¸ª ByteBuf åˆå¹¶ä¸ºä¸€ä¸ªé€»è¾‘ä¸Šçš„ ByteBufï¼Œé¿å…æ‹·è´\næœ‰ä¸¤ä¸ª ByteBuf å¦‚ä¸‹\nByteBuf buf1 = ByteBufAllocator.DEFAULT.buffer(5);\nbuf1.writeBytes(new byte[]&#123;1, 2, 3, 4, 5&#125;);\nByteBuf buf2 = ByteBufAllocator.DEFAULT.buffer(5);\nbuf2.writeBytes(new byte[]&#123;6, 7, 8, 9, 10&#125;);\nSystem.out.println(ByteBufUtil.prettyHexDump(buf1));\nSystem.out.println(ByteBufUtil.prettyHexDump(buf2));\n\nè¾“å‡º\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 01 02 03 04 05                                  |.....           |\n+--------+-------------------------------------------------+----------------+\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 06 07 08 09 0a                                  |.....           |\n+--------+-------------------------------------------------+----------------+\n\nç°åœ¨éœ€è¦ä¸€ä¸ªæ–°çš„ ByteBufï¼Œå†…å®¹æ¥è‡ªäºåˆšæ‰çš„ buf1 å’Œ buf2ï¼Œå¦‚ä½•å®ç°ï¼Ÿ\næ–¹æ³•1ï¼š\nByteBuf buf3 = ByteBufAllocator.DEFAULT\n    .buffer(buf1.readableBytes()+buf2.readableBytes());\nbuf3.writeBytes(buf1);\nbuf3.writeBytes(buf2);\nSystem.out.println(ByteBufUtil.prettyHexDump(buf3));\n\nç»“æœ\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |\n+--------+-------------------------------------------------+----------------+\n\nè¿™ç§æ–¹æ³•å¥½ä¸å¥½ï¼Ÿå›ç­”æ˜¯ä¸å¤ªå¥½ï¼Œå› ä¸ºè¿›è¡Œäº†æ•°æ®çš„å†…å­˜å¤åˆ¶æ“ä½œ\næ–¹æ³•2ï¼š\nCompositeByteBuf buf3 = ByteBufAllocator.DEFAULT.compositeBuffer();\n// true è¡¨ç¤ºå¢åŠ æ–°çš„ ByteBuf è‡ªåŠ¨é€’å¢ write index, å¦åˆ™ write index ä¼šå§‹ç»ˆä¸º 0\nbuf3.addComponents(true, buf1, buf2);\n\nç»“æœæ˜¯ä¸€æ ·çš„\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |\n+--------+-------------------------------------------------+----------------+\n\nCompositeByteBuf æ˜¯ä¸€ä¸ªç»„åˆçš„ ByteBufï¼Œå®ƒå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª Component æ•°ç»„ï¼Œæ¯ä¸ª Component ç®¡ç†ä¸€ä¸ª ByteBufï¼Œè®°å½•äº†è¿™ä¸ª ByteBuf ç›¸å¯¹äºæ•´ä½“åç§»é‡ç­‰ä¿¡æ¯ï¼Œä»£è¡¨ç€æ•´ä½“ä¸­æŸä¸€æ®µçš„æ•°æ®ã€‚\n\nä¼˜ç‚¹ï¼Œå¯¹å¤–æ˜¯ä¸€ä¸ªè™šæ‹Ÿè§†å›¾ï¼Œç»„åˆè¿™äº› ByteBuf ä¸ä¼šäº§ç”Ÿå†…å­˜å¤åˆ¶\nç¼ºç‚¹ï¼Œå¤æ‚äº†å¾ˆå¤šï¼Œå¤šæ¬¡æ“ä½œä¼šå¸¦æ¥æ€§èƒ½çš„æŸè€—\n\nUnpooledUnpooled æ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œç±»å¦‚å…¶åï¼Œæä¾›äº†éæ± åŒ–çš„ ByteBuf åˆ›å»ºã€ç»„åˆã€å¤åˆ¶ç­‰æ“ä½œ\nã€é›¶æ‹·è´ã€‘ç›¸å…³çš„ wrappedBuffer æ–¹æ³•ï¼Œå¯ä»¥ç”¨æ¥åŒ…è£… ByteBuf\nByteBuf buf1 = ByteBufAllocator.DEFAULT.buffer(5);\nbuf1.writeBytes(new byte[]&#123;1, 2, 3, 4, 5&#125;);\nByteBuf buf2 = ByteBufAllocator.DEFAULT.buffer(5);\nbuf2.writeBytes(new byte[]&#123;6, 7, 8, 9, 10&#125;);\n\n// å½“åŒ…è£… ByteBuf ä¸ªæ•°è¶…è¿‡ä¸€ä¸ªæ—¶, åº•å±‚ä½¿ç”¨äº† CompositeByteBuf\nByteBuf buf3 = Unpooled.wrappedBuffer(buf1, buf2);\nSystem.out.println(ByteBufUtil.prettyHexDump(buf3));\n\nè¾“å‡º\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |\n+--------+-------------------------------------------------+----------------+\n\nä¹Ÿå¯ä»¥ç”¨æ¥åŒ…è£…æ™®é€šå­—èŠ‚æ•°ç»„ï¼Œåº•å±‚ä¹Ÿä¸ä¼šæœ‰æ‹·è´æ“ä½œ\nByteBuf buf4 = Unpooled.wrappedBuffer(new byte[]&#123;1, 2, 3&#125;, new byte[]&#123;4, 5, 6&#125;);\nSystem.out.println(buf4.getClass());\nSystem.out.println(ByteBufUtil.prettyHexDump(buf4));\n\nè¾“å‡º\nclass io.netty.buffer.CompositeByteBuf\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 01 02 03 04 05 06                               |......          |\n+--------+-------------------------------------------------+----------------+\n\n\n\nByteBuf ä¼˜åŠ¿\næ± åŒ– - å¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œæ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½\nè¯»å†™æŒ‡é’ˆåˆ†ç¦»ï¼Œä¸éœ€è¦åƒ ByteBuffer ä¸€æ ·åˆ‡æ¢è¯»å†™æ¨¡å¼\nå¯ä»¥è‡ªåŠ¨æ‰©å®¹\næ”¯æŒé“¾å¼è°ƒç”¨ï¼Œä½¿ç”¨æ›´æµç•…\nå¾ˆå¤šåœ°æ–¹ä½“ç°é›¶æ‹·è´ï¼Œä¾‹å¦‚ sliceã€duplicateã€CompositeByteBuf\n\nåŒå‘é€šä¿¡å®ç°ä¸€ä¸ª echo serverç¼–å†™ server\nnew ServerBootstrap()\n    .group(new NioEventLoopGroup())\n    .channel(NioServerSocketChannel.class)\n    .childHandler(new ChannelInitializer&lt;NioSocketChannel>() &#123;\n        @Override\n        protected void initChannel(NioSocketChannel ch) &#123;\n            ch.pipeline().addLast(new ChannelInboundHandlerAdapter()&#123;\n                @Override\n                public void channelRead(ChannelHandlerContext ctx, Object msg) &#123;\n                    ByteBuf buffer = (ByteBuf) msg;\n                    System.out.println(buffer.toString(Charset.defaultCharset()));\n\n                    // å»ºè®®ä½¿ç”¨ ctx.alloc() åˆ›å»º ByteBuf\n                    //ctx.alloc().buffer()åˆ›å»ºçš„ByteBufå¯¹è±¡åˆå§‹å®¹é‡ä¸º0ï¼Œå½“æˆ‘ä»¬å¾€è¿™ä¸ªByteBufå†™å…¥æ•°æ®åï¼Œå®ƒä¼šè‡ªåŠ¨è¿›è¡Œæ‰©å®¹ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ctx.alloc().buffer(int initialCapacity)æ–¹æ³•ï¼Œæ¥æŒ‡å®šåˆ›å»ºä¸€ä¸ªåˆå§‹å®¹é‡ä¸ºinitialCapacityçš„ByteBufå¯¹è±¡ã€‚\n                    ByteBuf response = ctx.alloc().buffer();\n                    response.writeBytes(buffer);\n                    ctx.writeAndFlush(response);\n\t\t\t\t\t\n                    // æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ buffer å—\n                    // æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ response å—\n                &#125;\n            &#125;);\n        &#125;\n    &#125;).bind(8080);\n\nç¼–å†™ client\nNioEventLoopGroup group = new NioEventLoopGroup();\nChannel channel = new Bootstrap()\n    .group(group)\n    .channel(NioSocketChannel.class)\n    .handler(new ChannelInitializer&lt;NioSocketChannel>() &#123;\n        @Override\n        protected void initChannel(NioSocketChannel ch) throws Exception &#123;\n            ch.pipeline().addLast(new StringEncoder());\n            ch.pipeline().addLast(new ChannelInboundHandlerAdapter() &#123;\n                @Override\n                public void channelRead(ChannelHandlerContext ctx, Object msg) &#123;\n                    ByteBuf buffer = (ByteBuf) msg;\n                    System.out.println(buffer.toString(Charset.defaultCharset()));\n\n                    // æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ buffer å—\n                &#125;\n            &#125;);\n        &#125;\n    &#125;).connect(\"127.0.0.1\", 8080).sync().channel();\n\nchannel.closeFuture().addListener(future -> &#123;\n    group.shutdownGracefully();\n&#125;);\n\nnew Thread(() -> &#123;\n    Scanner scanner = new Scanner(System.in);\n    while (true) &#123;\n        String line = scanner.nextLine();\n        if (\"q\".equals(line)) &#123;\n            channel.close();\n            break;\n        &#125;\n        channel.writeAndFlush(line);\n    &#125;\n&#125;).start();\n\nè¯»å’Œå†™çš„ç†è§£ä¸æ˜¯åªæœ‰åœ¨ nettyï¼Œnio è¿™æ ·çš„å¤šè·¯å¤ç”¨ IO æ¨¡å‹æ—¶ï¼Œè¯»å†™æ‰ä¸ä¼šç›¸äº’é˜»å¡ï¼Œæ‰å¯ä»¥å®ç°é«˜æ•ˆçš„åŒå‘é€šä¿¡ï¼Œä½†å®é™…ä¸Šï¼ŒJava Socket æ˜¯å…¨åŒå·¥çš„ï¼šåœ¨ä»»æ„æ—¶åˆ»ï¼Œçº¿è·¯ä¸Šå­˜åœ¨A åˆ° B å’Œ B åˆ° A çš„åŒå‘ä¿¡å·ä¼ è¾“ã€‚å³ä½¿æ˜¯é˜»å¡ IOï¼Œè¯»å’Œå†™æ˜¯å¯ä»¥åŒæ—¶è¿›è¡Œçš„ï¼Œåªè¦åˆ†åˆ«é‡‡ç”¨è¯»çº¿ç¨‹å’Œå†™çº¿ç¨‹å³å¯ï¼Œè¯»ä¸ä¼šé˜»å¡å†™ã€å†™ä¹Ÿä¸ä¼šé˜»å¡è¯»\nä¾‹å¦‚\npublic class TestServer &#123;\n    public static void main(String[] args) throws IOException &#123;\n        ServerSocket ss = new ServerSocket(8888);\n        Socket s = ss.accept();\n\n        new Thread(() -> &#123;\n            try &#123;\n                BufferedReader reader = new BufferedReader(new InputStreamReader(s.getInputStream()));\n                while (true) &#123;\n                    System.out.println(reader.readLine());\n                &#125;\n            &#125; catch (IOException e) &#123;\n                e.printStackTrace();\n            &#125;\n        &#125;).start();\n\n        new Thread(() -> &#123;\n            try &#123;\n                BufferedWriter writer = new BufferedWriter(new OutputStreamWriter(s.getOutputStream()));\n                // ä¾‹å¦‚åœ¨è¿™ä¸ªä½ç½®åŠ å…¥ thread çº§åˆ«æ–­ç‚¹ï¼Œå¯ä»¥å‘ç°å³ä½¿ä¸å†™å…¥æ•°æ®ï¼Œä¹Ÿä¸å¦¨ç¢å‰é¢çº¿ç¨‹è¯»å–å®¢æˆ·ç«¯æ•°æ®\n                for (int i = 0; i &lt; 100; i++) &#123;\n                    writer.write(String.valueOf(i));\n                    writer.newLine();\n                    writer.flush();\n                &#125;\n            &#125; catch (IOException e) &#123;\n                e.printStackTrace();\n            &#125;\n        &#125;).start();\n    &#125;\n&#125;\n\nå®¢æˆ·ç«¯\npublic class TestClient &#123;\n    public static void main(String[] args) throws IOException &#123;\n        Socket s = new Socket(\"localhost\", 8888);\n\n        new Thread(() -> &#123;\n            try &#123;\n                BufferedReader reader = new BufferedReader(new InputStreamReader(s.getInputStream()));\n                while (true) &#123;\n                    System.out.println(reader.readLine());\n                &#125;\n            &#125; catch (IOException e) &#123;\n                e.printStackTrace();\n            &#125;\n        &#125;).start();\n\n        new Thread(() -> &#123;\n            try &#123;\n                BufferedWriter writer = new BufferedWriter(new OutputStreamWriter(s.getOutputStream()));\n                for (int i = 0; i &lt; 100; i++) &#123;\n                    writer.write(String.valueOf(i));\n                    writer.newLine();\n                    writer.flush();\n                &#125;\n            &#125; catch (IOException e) &#123;\n                e.printStackTrace();\n            &#125;\n        &#125;).start();\n    &#125;\n&#125;\n\n\n\n\n\n\n\n\n\n","slug":"NettyåŸºç¡€","date":"2023-05-26T02:36:45.000Z","categories_index":"","tags_index":"Netty","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"c9f2b21b690f4db6367244e90c766293","title":"NIO","content":"NIO åŸºç¡€non-blocking io éé˜»å¡ IOä¸‰å¤§ç»„ä»¶Channel &amp; Bufferchannel æœ‰ä¸€ç‚¹ç±»ä¼¼äº streamï¼Œå®ƒå°±æ˜¯è¯»å†™æ•°æ®çš„åŒå‘é€šé“ï¼Œå¯ä»¥ä» channel å°†æ•°æ®è¯»å…¥ bufferï¼Œä¹Ÿå¯ä»¥å°† buffer çš„æ•°æ®å†™å…¥ channelï¼Œè€Œä¹‹å‰çš„ stream è¦ä¹ˆæ˜¯è¾“å…¥ï¼Œè¦ä¹ˆæ˜¯è¾“å‡ºï¼Œchannel æ¯” stream æ›´ä¸ºåº•å±‚\nå¸¸è§çš„ Channel æœ‰\n\nFileChannel\nDatagramChannel\nSocketChannel\nServerSocketChannel\n\nbuffer åˆ™ç”¨æ¥ç¼“å†²è¯»å†™æ•°æ®ï¼Œå¸¸è§çš„ buffer æœ‰\n\nByteBuffer\nMappedByteBuffer\nDirectByteBuffer\nHeapByteBuffer\n\n\nShortBuffer\nIntBuffer\nLongBuffer\nFloatBuffer\nDoubleBuffer\nCharBuffer\n\nSelectorå¤šçº¿ç¨‹ç‰ˆè®¾è®¡\ngraph TD\nsubgraph å¤šçº¿ç¨‹ç‰ˆ\nt1(thread) --> s1(socket1)\nt2(thread) --> s2(socket2)\nt3(thread) --> s3(socket3)\nend\n\n å¤šçº¿ç¨‹ç‰ˆç¼ºç‚¹:\n\nå†…å­˜å ç”¨é«˜\nçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬é«˜\nåªé€‚åˆè¿æ¥æ•°å°‘çš„åœºæ™¯\n\nçº¿ç¨‹æ± ç‰ˆè®¾è®¡\ngraph TD\nsubgraph çº¿ç¨‹æ± ç‰ˆ\nt4(thread) --> s4(socket1)\nt5(thread) --> s5(socket2)\nt4(thread) -.-> s6(socket3)\nt5(thread) -.-> s7(socket4)\nend\n\nçº¿ç¨‹æ± ç‰ˆç¼ºç‚¹\n\né˜»å¡æ¨¡å¼ä¸‹ï¼Œçº¿ç¨‹ä»…èƒ½å¤„ç†ä¸€ä¸ª socket è¿æ¥\nä»…é€‚åˆçŸ­è¿æ¥åœºæ™¯\n\nselector ç‰ˆè®¾è®¡\nselector çš„ä½œç”¨å°±æ˜¯é…åˆä¸€ä¸ªçº¿ç¨‹æ¥ç®¡ç†å¤šä¸ª channelï¼Œè·å–è¿™äº› channel ä¸Šå‘ç”Ÿçš„äº‹ä»¶ï¼Œè¿™äº› channel å·¥ä½œåœ¨éé˜»å¡æ¨¡å¼ä¸‹ï¼Œä¸ä¼šè®©çº¿ç¨‹åŠæ­»åœ¨ä¸€ä¸ª channel ä¸Šã€‚é€‚åˆè¿æ¥æ•°ç‰¹åˆ«å¤šï¼Œä½†æµé‡ä½çš„åœºæ™¯ï¼ˆlow trafficï¼‰\ngraph TD\nsubgraph selector ç‰ˆ\nthread --> selector\nselector --> c1(channel)\nselector --> c2(channel)\nselector --> c3(channel)\nend\n\nè°ƒç”¨ selector çš„ select() ä¼šé˜»å¡ç›´åˆ° channel å‘ç”Ÿäº†è¯»å†™å°±ç»ªäº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶å‘ç”Ÿï¼Œselect æ–¹æ³•å°±ä¼šè¿”å›è¿™äº›äº‹ä»¶äº¤ç»™ thread æ¥å¤„ç†\nByteBufferæœ‰ä¸€æ™®é€šæ–‡æœ¬æ–‡ä»¶ data.txtï¼Œå†…å®¹ä¸º\n1234567890abcd\n\nä½¿ç”¨ FileChannel æ¥è¯»å–æ–‡ä»¶å†…å®¹\n@Slf4j\npublic class ChannelDemo1 &#123;\n    public static void main(String[] args) &#123;\n        try (RandomAccessFile file = new RandomAccessFile(\"helloword/data.txt\", \"rw\")) &#123;\n            FileChannel channel = file.getChannel();\n            ByteBuffer buffer = ByteBuffer.allocate(10);\n            do &#123;\n                // å‘ buffer å†™å…¥\n                int len = channel.read(buffer);\n                log.debug(\"è¯»åˆ°å­—èŠ‚æ•°ï¼š&#123;&#125;\", len);\n                if (len == -1) &#123;\n                    break;\n                &#125;\n                // åˆ‡æ¢ buffer è¯»æ¨¡å¼\n                buffer.flip();\n                while(buffer.hasRemaining()) &#123;\n                    log.debug(\"&#123;&#125;\", (char)buffer.get());\n                &#125;\n                // åˆ‡æ¢ buffer å†™æ¨¡å¼\n                buffer.clear();\n            &#125; while (true);\n        &#125; catch (IOException e) &#123;\n            e.printStackTrace();\n        &#125;\n    &#125;\n&#125;\n\nè¾“å‡º\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - è¯»åˆ°å­—èŠ‚æ•°ï¼š10\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 1\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 2\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 3\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 4\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 5\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 6\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 7\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 8\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 9\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 0\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - è¯»åˆ°å­—èŠ‚æ•°ï¼š4\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - a\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - b\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - c\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - d\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - è¯»åˆ°å­—èŠ‚æ•°ï¼š-1\n\nByteBuffer æ­£ç¡®ä½¿ç”¨å§¿åŠ¿\nå‘ buffer å†™å…¥æ•°æ®ï¼Œä¾‹å¦‚è°ƒç”¨ channel.read(buffer)\nè°ƒç”¨ flip() åˆ‡æ¢è‡³è¯»æ¨¡å¼\nä» buffer è¯»å–æ•°æ®ï¼Œä¾‹å¦‚è°ƒç”¨ buffer.get()\nè°ƒç”¨ clear() æˆ– compact() åˆ‡æ¢è‡³å†™æ¨¡å¼\né‡å¤ 1~4 æ­¥éª¤\n\nByteBuffer buffer &#x3D; ByteBuffer.allocate(10);\nByteBuffer ç»“æ„ByteBuffer æœ‰ä»¥ä¸‹é‡è¦å±æ€§\n\ncapacity\nposition\nlimit\n\nä¸€å¼€å§‹\tByteBuffer buffer &#x3D; ByteBuffer.allocate(10);\n\nå†™æ¨¡å¼ä¸‹ï¼Œposition æ˜¯å†™å…¥ä½ç½®ï¼Œlimit ç­‰äºå®¹é‡ï¼Œä¸‹å›¾è¡¨ç¤ºå†™å…¥äº† 4 ä¸ªå­—èŠ‚åçš„çŠ¶æ€\n\nflip åŠ¨ä½œå‘ç”Ÿåï¼Œposition åˆ‡æ¢ä¸ºè¯»å–ä½ç½®ï¼Œlimit åˆ‡æ¢ä¸ºè¯»å–é™åˆ¶\n\nè¯»å– 4 ä¸ªå­—èŠ‚åï¼ŒçŠ¶æ€\n\nclear åŠ¨ä½œå‘ç”Ÿåï¼ŒçŠ¶æ€\n\ncompact æ–¹æ³•ï¼Œæ˜¯æŠŠæœªè¯»å®Œçš„éƒ¨åˆ†å‘å‰å‹ç¼©ï¼Œç„¶ååˆ‡æ¢è‡³å†™æ¨¡å¼\n\nByteBuffer å¸¸è§æ–¹æ³•åˆ†é…ç©ºé—´\nå¯ä»¥ä½¿ç”¨ allocate æ–¹æ³•ä¸º ByteBuffer åˆ†é…ç©ºé—´ï¼Œå…¶å®ƒ buffer ç±»ä¹Ÿæœ‰è¯¥æ–¹æ³•\nBytebuffer buf = ByteBuffer.allocate(16);\nå‘ buffer å†™å…¥æ•°æ®\næœ‰ä¸¤ç§åŠæ³•\n\nè°ƒç”¨ channel çš„ read æ–¹æ³•\n\nint readBytes = channel.read(buf);\n\nè°ƒç”¨ buffer è‡ªå·±çš„ put æ–¹æ³•\n\nbuf.put((byte)127);\nä» buffer è¯»å–æ•°æ®\næœ‰ä¸¤ç§åŠæ³•\n\nè°ƒç”¨ channel çš„ write æ–¹æ³•\n\nint writeBytes = channel.write(buf);\n\nè°ƒç”¨ buffer è‡ªå·±çš„ get æ–¹æ³•\n\nbyte b = buf.get();\nget æ–¹æ³•ä¼šè®© position è¯»æŒ‡é’ˆå‘åèµ°ï¼Œå¦‚æœæƒ³é‡å¤è¯»å–æ•°æ®\n\nå¯ä»¥è°ƒç”¨ rewind æ–¹æ³•å°† position é‡æ–°ç½®ä¸º 0\næˆ–è€…è°ƒç”¨ get(int i) æ–¹æ³•è·å–ç´¢å¼• i çš„å†…å®¹ï¼Œå®ƒä¸ä¼šç§»åŠ¨è¯»æŒ‡é’ˆ\n\nmark å’Œ reset\nmark æ˜¯åœ¨è¯»å–æ—¶ï¼Œåšä¸€ä¸ªæ ‡è®°ï¼Œå³ä½¿ position æ”¹å˜ï¼Œåªè¦è°ƒç”¨ reset å°±èƒ½å›åˆ° mark çš„ä½ç½®\nğŸ’¡ rewind å’Œ flip éƒ½ä¼šæ¸…é™¤ mark ä½ç½®\nå­—ç¬¦ä¸²ä¸ ByteBuffer äº’è½¬\nByteBuffer buffer1 = StandardCharsets.UTF_8.encode(\"ä½ å¥½\");\nByteBuffer buffer2 = Charset.forName(\"utf-8\").encode(\"ä½ å¥½\");\n\ndebug(buffer1);\ndebug(buffer2);\n\nCharBuffer buffer3 = StandardCharsets.UTF_8.decode(buffer1);\nSystem.out.println(buffer3.getClass());\nSystem.out.println(buffer3.toString());\n\nè¾“å‡º\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| e4 bd a0 e5 a5 bd                               |......          |\n+--------+-------------------------------------------------+----------------+\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| e4 bd a0 e5 a5 bd                               |......          |\n+--------+-------------------------------------------------+----------------+\nclass java.nio.HeapCharBuffer\nä½ å¥½\n\nBuffer æ˜¯éçº¿ç¨‹å®‰å…¨çš„\nScattering Reads åˆ†æ•£è¯»åˆ†æ•£è¯»å–ï¼Œæœ‰ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ 3parts.txt\nonetwothree\n\nä½¿ç”¨å¦‚ä¸‹æ–¹å¼è¯»å–ï¼Œå¯ä»¥å°†æ•°æ®å¡«å……è‡³å¤šä¸ª buffer\ntry (RandomAccessFile file = new RandomAccessFile(\"3parts.txt\", \"rw\")) &#123;\n    FileChannel channel = file.getChannel();\n    ByteBuffer a = ByteBuffer.allocate(3);\n    ByteBuffer b = ByteBuffer.allocate(3);\n    ByteBuffer c = ByteBuffer.allocate(5);\n    channel.read(new ByteBuffer[]&#123;a, b, c&#125;);\n    a.flip();\n    b.flip();\n    c.flip();\n    debug(a);\n    debug(b);\n    debug(c);\n&#125; catch (IOException e) &#123;\n    e.printStackTrace();\n&#125;\n\nç»“æœ\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 6f 6e 65                                        |one             |\n+--------+-------------------------------------------------+----------------+\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 74 77 6f                                        |two             |\n+--------+-------------------------------------------------+----------------+\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 74 68 72 65 65                                  |three           |\n+--------+-------------------------------------------------+----------------+\n\nGathering Writesèšé›†å†å†™ä½¿ç”¨å¦‚ä¸‹æ–¹å¼å†™å…¥ï¼Œå¯ä»¥å°†å¤šä¸ª buffer çš„æ•°æ®å¡«å……è‡³ channel\ntry (RandomAccessFile file = new RandomAccessFile(\"3parts.txt\", \"rw\")) &#123;\n    FileChannel channel = file.getChannel();\n    ByteBuffer d = ByteBuffer.allocate(4);\n    ByteBuffer e = ByteBuffer.allocate(4);\n    //åŸæ–‡ä»¶æœ‰10ä¸ªå­—ï¼Œä»ç¬¬11ä¸ªå¼€å§‹\n    channel.position(11);\n\n    d.put(new byte[]&#123;'f', 'o', 'u', 'r'&#125;);\n    e.put(new byte[]&#123;'f', 'i', 'v', 'e'&#125;);\n    d.flip();\n    e.flip();\n    debug(d);\n    debug(e);\n    channel.write(new ByteBuffer[]&#123;d, e&#125;);\n&#125; catch (IOException e) &#123;\n    e.printStackTrace();\n&#125;\n\nè¾“å‡º\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 66 6f 75 72                                     |four            |\n+--------+-------------------------------------------------+----------------+\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 66 69 76 65                                     |five            |\n+--------+-------------------------------------------------+----------------+\n\næ–‡ä»¶å†…å®¹\nonetwothreefourfive\n\næ–‡ä»¶ç¼–ç¨‹FileChannelFileChannel åªèƒ½å·¥ä½œåœ¨é˜»å¡æ¨¡å¼ä¸‹\nè·å–\nä¸èƒ½ç›´æ¥æ‰“å¼€ FileChannelï¼Œå¿…é¡»é€šè¿‡ FileInputStreamã€FileOutputStream æˆ–è€… RandomAccessFile æ¥è·å– FileChannelï¼Œå®ƒä»¬éƒ½æœ‰ getChannel æ–¹æ³•\n\né€šè¿‡ FileInputStream è·å–çš„ channel åªèƒ½è¯»\né€šè¿‡ FileOutputStream è·å–çš„ channel åªèƒ½å†™\né€šè¿‡ RandomAccessFile æ˜¯å¦èƒ½è¯»å†™æ ¹æ®æ„é€  RandomAccessFile æ—¶çš„è¯»å†™æ¨¡å¼å†³å®š\n\nè¯»å–\nä¼šä» channel è¯»å–æ•°æ®å¡«å…… ByteBufferï¼Œè¿”å›å€¼è¡¨ç¤ºè¯»åˆ°äº†å¤šå°‘å­—èŠ‚ï¼Œ-1 è¡¨ç¤ºåˆ°è¾¾äº†æ–‡ä»¶çš„æœ«å°¾\nå†™å…¥\nå†™å…¥çš„æ­£ç¡®å§¿åŠ¿å¦‚ä¸‹ï¼Œ SocketChannel\nByteBuffer buffer = ...;\nbuffer.put(...); // å­˜å…¥æ•°æ®\nbuffer.flip();   // åˆ‡æ¢è¯»æ¨¡å¼\n\nwhile(buffer.hasRemaining()) &#123;\n    channel.write(buffer);\n&#125;\n\nåœ¨ while ä¸­è°ƒç”¨ channel.write æ˜¯å› ä¸º write æ–¹æ³•å¹¶ä¸èƒ½ä¿è¯ä¸€æ¬¡å°† buffer ä¸­çš„å†…å®¹å…¨éƒ¨å†™å…¥ channel\nå…³é—­\nchannel å¿…é¡»å…³é—­ï¼Œä¸è¿‡è°ƒç”¨äº† FileInputStreamã€FileOutputStream æˆ–è€… RandomAccessFile çš„ close æ–¹æ³•ä¼šé—´æ¥åœ°è°ƒç”¨ channel çš„ close æ–¹æ³•\nä½ç½®è·å–å½“å‰ä½ç½®\nlong pos = channel.position();\n\nè®¾ç½®å½“å‰ä½ç½®\nlong newPos = ...;\nchannel.position(newPos);\n\nè®¾ç½®å½“å‰ä½ç½®æ—¶ï¼Œå¦‚æœè®¾ç½®ä¸ºæ–‡ä»¶çš„æœ«å°¾\n\nè¿™æ—¶è¯»å–ä¼šè¿”å› -1 \nè¿™æ—¶å†™å…¥ï¼Œä¼šè¿½åŠ å†…å®¹ï¼Œä½†è¦æ³¨æ„å¦‚æœ position è¶…è¿‡äº†æ–‡ä»¶æœ«å°¾ï¼Œå†å†™å…¥æ—¶åœ¨æ–°å†…å®¹å’ŒåŸæœ«å°¾ä¹‹é—´ä¼šæœ‰ç©ºæ´ï¼ˆ00ï¼‰\n\nå¼ºåˆ¶å†™å…¥æ“ä½œç³»ç»Ÿå‡ºäºæ€§èƒ½çš„è€ƒè™‘ï¼Œä¼šå°†æ•°æ®ç¼“å­˜ï¼Œä¸æ˜¯ç«‹åˆ»å†™å…¥ç£ç›˜ã€‚å¯ä»¥è°ƒç”¨ force(true)  æ–¹æ³•å°†æ–‡ä»¶å†…å®¹å’Œå…ƒæ•°æ®ï¼ˆæ–‡ä»¶çš„æƒé™ç­‰ä¿¡æ¯ï¼‰ç«‹åˆ»å†™å…¥ç£ç›˜\nä¸¤ä¸ª Channel ä¼ è¾“æ•°æ®String FROM = \"data.txt\";\nString TO = \"to.txt\";\nlong start = System.nanoTime();\ntry (FileChannel from = new FileInputStream(FROM).getChannel();\n     FileChannel to = new FileOutputStream(TO).getChannel();\n    ) &#123;\n    from.transferTo(0, from.size(), to);\n&#125; catch (IOException e) &#123;\n    e.printStackTrace();\n&#125;\nlong end = System.nanoTime();\nSystem.out.println(\"transferTo ç”¨æ—¶ï¼š\" + (end - start) / 1000_000.0);\n\nè¾“å‡º\ntransferTo ç”¨æ—¶ï¼š8.2011\n\n\n\nè¶…è¿‡ 2g å¤§å°çš„æ–‡ä»¶ä¼ è¾“\npublic class TestFileChannelTransferTo &#123;\n    public static void main(String[] args) &#123;\n        try (\n                FileChannel from = new FileInputStream(\"data.txt\").getChannel();\n                FileChannel to = new FileOutputStream(\"to.txt\").getChannel();\n        ) &#123;\n            // æ•ˆç‡é«˜ï¼Œåº•å±‚ä¼šåˆ©ç”¨æ“ä½œç³»ç»Ÿçš„é›¶æ‹·è´è¿›è¡Œä¼˜åŒ–\n            long size = from.size();\n            // left å˜é‡ä»£è¡¨è¿˜å‰©ä½™å¤šå°‘å­—èŠ‚\n            for (long left = size; left > 0; ) &#123;\n                System.out.println(\"position:\" + (size - left) + \" left:\" + left);\n                left -= from.transferTo((size - left), left, to);\n            &#125;\n        &#125; catch (IOException e) &#123;\n            e.printStackTrace();\n        &#125;\n    &#125;\n&#125;\n\nå®é™…ä¼ è¾“ä¸€ä¸ªè¶…å¤§æ–‡ä»¶\nposition:0 left:7769948160\nposition:2147483647 left:5622464513\nposition:4294967294 left:3474980866\nposition:6442450941 left:1327497219\n\nPathjdk7 å¼•å…¥äº† Path å’Œ Paths ç±»\n\nPath ç”¨æ¥è¡¨ç¤ºæ–‡ä»¶è·¯å¾„\nPaths æ˜¯å·¥å…·ç±»ï¼Œç”¨æ¥è·å– Path å®ä¾‹\n\nPath source = Paths.get(\"1.txt\"); // ç›¸å¯¹è·¯å¾„ ä½¿ç”¨ user.dir ç¯å¢ƒå˜é‡æ¥å®šä½ 1.txt\n\nPath source = Paths.get(\"d:\\\\1.txt\"); // ç»å¯¹è·¯å¾„ ä»£è¡¨äº†  d:\\1.txt\n\nPath source = Paths.get(\"d:/1.txt\"); // ç»å¯¹è·¯å¾„ åŒæ ·ä»£è¡¨äº†  d:\\1.txt\n\nPath projects = Paths.get(\"d:\\\\data\", \"projects\"); // ä»£è¡¨äº†  d:\\data\\projects\n\n\n. ä»£è¡¨äº†å½“å‰è·¯å¾„\n.. ä»£è¡¨äº†ä¸Šä¸€çº§è·¯å¾„\n\nä¾‹å¦‚ç›®å½•ç»“æ„å¦‚ä¸‹\nd:\n\t|- data\n\t\t|- projects\n\t\t\t|- a\n\t\t\t|- b\n\nä»£ç \nPath path = Paths.get(\"d:\\\\data\\\\projects\\\\a\\\\..\\\\b\");\nSystem.out.println(path);\nSystem.out.println(path.normalize()); // æ­£å¸¸åŒ–è·¯å¾„\n\nä¼šè¾“å‡º\nd:\\data\\projects\\a\\..\\b\nd:\\data\\projects\\b\n\nFilesæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨\nPath path = Paths.get(\"helloword/data.txt\");\nSystem.out.println(Files.exists(path));\n\n\n\nåˆ›å»ºä¸€çº§ç›®å½•\nPath path = Paths.get(\"helloword/d1\");\nFiles.createDirectory(path);\n\n\nå¦‚æœç›®å½•å·²å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ FileAlreadyExistsException\nä¸èƒ½ä¸€æ¬¡åˆ›å»ºå¤šçº§ç›®å½•ï¼Œå¦åˆ™ä¼šæŠ›å¼‚å¸¸ NoSuchFileException\n\nåˆ›å»ºå¤šçº§ç›®å½•ç”¨\nPath path = Paths.get(\"helloword/d1/d2\");\nFiles.createDirectories(path);\n\n\n\næ‹·è´æ–‡ä»¶\nPath source = Paths.get(\"helloword/data.txt\");\nPath target = Paths.get(\"helloword/target.txt\");\n\nFiles.copy(source, target);\n\n\nå¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ FileAlreadyExistsException\n\nå¦‚æœå¸Œæœ›ç”¨ source è¦†ç›–æ‰ targetï¼Œéœ€è¦ç”¨ StandardCopyOption æ¥æ§åˆ¶\nFiles.copy(source, target, StandardCopyOption.REPLACE_EXISTING);\n\n\n\nç§»åŠ¨æ–‡ä»¶\nPath source = Paths.get(\"helloword/data.txt\");\nPath target = Paths.get(\"helloword/data.txt\");\n\nFiles.move(source, target, StandardCopyOption.ATOMIC_MOVE);\n\n\nStandardCopyOption.ATOMIC_MOVE ä¿è¯æ–‡ä»¶ç§»åŠ¨çš„åŸå­æ€§\n\nåˆ é™¤æ–‡ä»¶\nPath target = Paths.get(\"helloword/target.txt\");\n\nFiles.delete(target);\n\n\nå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ NoSuchFileException\n\nåˆ é™¤ç›®å½•\nPath target = Paths.get(\"helloword/d1\");\n\nFiles.delete(target);\n\n\nå¦‚æœç›®å½•è¿˜æœ‰å†…å®¹ï¼Œä¼šæŠ›å¼‚å¸¸ DirectoryNotEmptyException\n\nç½‘ç»œç¼–ç¨‹éé˜»å¡ vs é˜»å¡é˜»å¡\né˜»å¡æ¨¡å¼ä¸‹ï¼Œç›¸å…³æ–¹æ³•éƒ½ä¼šå¯¼è‡´çº¿ç¨‹æš‚åœ\nServerSocketChannel.accept ä¼šåœ¨æ²¡æœ‰è¿æ¥å»ºç«‹æ—¶è®©çº¿ç¨‹æš‚åœ\nSocketChannel.read ä¼šåœ¨æ²¡æœ‰æ•°æ®å¯è¯»æ—¶è®©çº¿ç¨‹æš‚åœ\né˜»å¡çš„è¡¨ç°å…¶å®å°±æ˜¯çº¿ç¨‹æš‚åœäº†ï¼Œæš‚åœæœŸé—´ä¸ä¼šå ç”¨ cpuï¼Œä½†çº¿ç¨‹ç›¸å½“äºé—²ç½®\n\n\nå•çº¿ç¨‹ä¸‹ï¼Œé˜»å¡æ–¹æ³•ä¹‹é—´ç›¸äº’å½±å“ï¼Œå‡ ä¹ä¸èƒ½æ­£å¸¸å·¥ä½œï¼Œéœ€è¦å¤šçº¿ç¨‹æ”¯æŒ\nä½†å¤šçº¿ç¨‹ä¸‹ï¼Œæœ‰æ–°çš„é—®é¢˜ï¼Œä½“ç°åœ¨ä»¥ä¸‹æ–¹é¢\n32 ä½ jvm ä¸€ä¸ªçº¿ç¨‹ 320kï¼Œ64 ä½ jvm ä¸€ä¸ªçº¿ç¨‹ 1024kï¼Œå¦‚æœè¿æ¥æ•°è¿‡å¤šï¼Œå¿…ç„¶å¯¼è‡´ OOMï¼Œå¹¶ä¸”çº¿ç¨‹å¤ªå¤šï¼Œåè€Œä¼šå› ä¸ºé¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¼è‡´æ€§èƒ½é™ä½\nå¯ä»¥é‡‡ç”¨çº¿ç¨‹æ± æŠ€æœ¯æ¥å‡å°‘çº¿ç¨‹æ•°å’Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä½†æ²»æ ‡ä¸æ²»æœ¬ï¼Œå¦‚æœæœ‰å¾ˆå¤šè¿æ¥å»ºç«‹ï¼Œä½†é•¿æ—¶é—´ inactiveï¼Œä¼šé˜»å¡çº¿ç¨‹æ± ä¸­æ‰€æœ‰çº¿ç¨‹ï¼Œå› æ­¤ä¸é€‚åˆé•¿è¿æ¥ï¼Œåªé€‚åˆçŸ­è¿æ¥\n\n\n\nä½¿ç”¨ nio æ¥ç†è§£é˜»å¡æ¨¡å¼, å•çº¿ç¨‹\næœåŠ¡å™¨ç«¯\n// 0. ByteBuffer\nByteBuffer buffer = ByteBuffer.allocate(16);\n// 1. åˆ›å»ºäº†æœåŠ¡å™¨\nServerSocketChannel ssc = ServerSocketChannel.open();\n\n// 2. ç»‘å®šç›‘å¬ç«¯å£\nssc.bind(new InetSocketAddress(8080));\n\n// 3. è¿æ¥é›†åˆ\nList&lt;SocketChannel> channels = new ArrayList&lt;>();\nwhile (true) &#123;\n    // 4. accept å»ºç«‹ä¸å®¢æˆ·ç«¯è¿æ¥ï¼Œ SocketChannel ç”¨æ¥ä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡\n    log.debug(\"connecting...\");\n    SocketChannel sc = ssc.accept(); // é˜»å¡æ–¹æ³•ï¼Œçº¿ç¨‹åœæ­¢è¿è¡Œ\n    log.debug(\"connected... &#123;&#125;\", sc);\n    channels.add(sc);\n    for (SocketChannel channel : channels) &#123;\n        // 5. æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æ•°æ®\n        log.debug(\"before read... &#123;&#125;\", channel);\n        channel.read(buffer); // é˜»å¡æ–¹æ³•ï¼Œçº¿ç¨‹åœæ­¢è¿è¡Œ\n        buffer.flip();\n        debugRead(buffer);\n        buffer.clear();\n        log.debug(\"after read...&#123;&#125;\", channel);\n    &#125;\n&#125;\n\nå®¢æˆ·ç«¯\nSocketChannel sc = SocketChannel.open();\nsc.connect(new InetSocketAddress(\"localhost\", 8080));\nSystem.out.println(\"waiting...\");\n\néé˜»å¡\néé˜»å¡æ¨¡å¼ä¸‹ï¼Œç›¸å…³æ–¹æ³•éƒ½ä¸ä¼šè®©çº¿ç¨‹æš‚åœ\nåœ¨ ServerSocketChannel.accept åœ¨æ²¡æœ‰è¿æ¥å»ºç«‹æ—¶ï¼Œä¼šè¿”å› nullï¼Œç»§ç»­è¿è¡Œ\nSocketChannel.read åœ¨æ²¡æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œä¼šè¿”å› 0ï¼Œçº¿ç¨‹ä¸å¿…é˜»å¡ï¼Œå¯ä»¥å»æ‰§è¡Œå…¶å®ƒ SocketChannel çš„ read æˆ–æ˜¯å»æ‰§è¡Œ ServerSocketChannel.accept \nå†™æ•°æ®æ—¶ï¼Œçº¿ç¨‹åªç­‰å¾…æ•°æ®å†™å…¥ Channel å³å¯ï¼Œæ— éœ€ç­‰ Channel é€šè¿‡ç½‘ç»œæŠŠæ•°æ®å‘é€å‡ºå»\n\n\nä½†éé˜»å¡æ¨¡å¼ä¸‹ï¼Œå³ä½¿æ²¡æœ‰è¿æ¥å»ºç«‹å’Œå¯è¯»æ•°æ®ï¼Œçº¿ç¨‹ä»ç„¶åœ¨ä¸æ–­è¿è¡Œï¼Œç™½ç™½æµªè´¹äº† cpu\næ•°æ®å¤åˆ¶è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹å®é™…è¿˜æ˜¯é˜»å¡çš„ï¼ˆAIO æ”¹è¿›çš„åœ°æ–¹ï¼‰\n\nä½¿ç”¨ nio æ¥ç†è§£éé˜»å¡æ¨¡å¼, å•çº¿ç¨‹\næœåŠ¡å™¨ç«¯ï¼Œå®¢æˆ·ç«¯ä»£ç ä¸å˜\n// 0. ByteBuffer\nByteBuffer buffer = ByteBuffer.allocate(16);\n// 1. åˆ›å»ºäº†æœåŠ¡å™¨\nServerSocketChannel ssc = ServerSocketChannel.open();\nssc.configureBlocking(false); // éé˜»å¡æ¨¡å¼\n// 2. ç»‘å®šç›‘å¬ç«¯å£\nssc.bind(new InetSocketAddress(8080));\n// 3. è¿æ¥é›†åˆ\nList&lt;SocketChannel> channels = new ArrayList&lt;>();\nwhile (true) &#123;\n    // 4. accept å»ºç«‹ä¸å®¢æˆ·ç«¯è¿æ¥ï¼Œ SocketChannel ç”¨æ¥ä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡\n    SocketChannel sc = ssc.accept(); // éé˜»å¡ï¼Œçº¿ç¨‹è¿˜ä¼šç»§ç»­è¿è¡Œï¼Œå¦‚æœæ²¡æœ‰è¿æ¥å»ºç«‹ï¼Œä½†scæ˜¯null\n    if (sc != null) &#123;\n        log.debug(\"connected... &#123;&#125;\", sc);\n        sc.configureBlocking(false); // éé˜»å¡æ¨¡å¼\n        channels.add(sc);\n    &#125;\n    for (SocketChannel channel : channels) &#123;\n        // 5. æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æ•°æ®\n        int read = channel.read(buffer);//éé˜»å¡ï¼Œçº¿ç¨‹ä»ç„¶ä¼šç»§ç»­è¿è¡Œï¼Œæ²¡æœ‰è¯»åˆ°æ•°æ®ï¼Œread è¿”å› 0\n        if (read > 0) &#123;\n            buffer.flip();\n            debugRead(buffer);\n            buffer.clear();\n            log.debug(\"after read...&#123;&#125;\", channel);\n        &#125;\n    &#125;\n&#125;\n\n\n\nå¤šè·¯å¤ç”¨å•çº¿ç¨‹å¯ä»¥é…åˆ Selector å®Œæˆå¯¹å¤šä¸ª Channel å¯è¯»å†™äº‹ä»¶çš„ç›‘æ§ï¼Œè¿™ç§°ä¹‹ä¸ºå¤šè·¯å¤ç”¨\n\nå¤šè·¯å¤ç”¨ä»…é’ˆå¯¹ç½‘ç»œ IOã€æ™®é€šæ–‡ä»¶ IO æ²¡æ³•åˆ©ç”¨å¤šè·¯å¤ç”¨\nå¦‚æœä¸ç”¨ Selector çš„éé˜»å¡æ¨¡å¼ï¼Œçº¿ç¨‹å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨åšæ— ç”¨åŠŸï¼Œè€Œ Selector èƒ½å¤Ÿä¿è¯\næœ‰å¯è¿æ¥äº‹ä»¶æ—¶æ‰å»è¿æ¥\næœ‰å¯è¯»äº‹ä»¶æ‰å»è¯»å–\næœ‰å¯å†™äº‹ä»¶æ‰å»å†™å…¥\né™äºç½‘ç»œä¼ è¾“èƒ½åŠ›ï¼ŒChannel æœªå¿…æ—¶æ—¶å¯å†™ï¼Œä¸€æ—¦ Channel å¯å†™ï¼Œä¼šè§¦å‘ Selector çš„å¯å†™äº‹ä»¶\n\n\n\n\n\nSelector\ngraph TD\nsubgraph selector ç‰ˆ\nthread --> selector\nselector --> c1(channel)\nselector --> c2(channel)\nselector --> c3(channel)\nend\n\nå¥½å¤„\n\nä¸€ä¸ªçº¿ç¨‹é…åˆ selector å°±å¯ä»¥ç›‘æ§å¤šä¸ª channel çš„äº‹ä»¶ï¼Œäº‹ä»¶å‘ç”Ÿçº¿ç¨‹æ‰å»å¤„ç†ã€‚é¿å…éé˜»å¡æ¨¡å¼ä¸‹æ‰€åšæ— ç”¨åŠŸ\nè®©è¿™ä¸ªçº¿ç¨‹èƒ½å¤Ÿè¢«å……åˆ†åˆ©ç”¨\nèŠ‚çº¦äº†çº¿ç¨‹çš„æ•°é‡\nå‡å°‘äº†çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢\n\nåˆ›å»ºSelector selector = Selector.open();\n\nç»‘å®š Channel äº‹ä»¶ä¹Ÿç§°ä¹‹ä¸ºæ³¨å†Œäº‹ä»¶ï¼Œç»‘å®šçš„äº‹ä»¶ selector æ‰ä¼šå…³å¿ƒ \nchannel.configureBlocking(false);\nSelectionKey key = channel.register(selector, ç»‘å®šäº‹ä»¶);\n\n\nchannel å¿…é¡»å·¥ä½œåœ¨éé˜»å¡æ¨¡å¼\nFileChannel æ²¡æœ‰éé˜»å¡æ¨¡å¼ï¼Œå› æ­¤ä¸èƒ½é…åˆ selector ä¸€èµ·ä½¿ç”¨\nç»‘å®šçš„äº‹ä»¶ç±»å‹å¯ä»¥æœ‰\nconnect - å®¢æˆ·ç«¯è¿æ¥æˆåŠŸæ—¶è§¦å‘\naccept - æœåŠ¡å™¨ç«¯æˆåŠŸæ¥å—è¿æ¥æ—¶è§¦å‘\nread - æ•°æ®å¯è¯»å…¥æ—¶è§¦å‘ï¼Œæœ‰å› ä¸ºæ¥æ”¶èƒ½åŠ›å¼±ï¼Œæ•°æ®æš‚ä¸èƒ½è¯»å…¥çš„æƒ…å†µ\nwrite - æ•°æ®å¯å†™å‡ºæ—¶è§¦å‘ï¼Œæœ‰å› ä¸ºå‘é€èƒ½åŠ›å¼±ï¼Œæ•°æ®æš‚ä¸èƒ½å†™å‡ºçš„æƒ…å†µ\n\n\n\nç›‘å¬ Channel äº‹ä»¶å¯ä»¥é€šè¿‡ä¸‹é¢ä¸‰ç§æ–¹æ³•æ¥ç›‘å¬æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œæ–¹æ³•çš„è¿”å›å€¼ä»£è¡¨æœ‰å¤šå°‘ channel å‘ç”Ÿäº†äº‹ä»¶\næ–¹æ³•1ï¼Œé˜»å¡ç›´åˆ°ç»‘å®šäº‹ä»¶å‘ç”Ÿ\nint count = selector.select();\n\næ–¹æ³•2ï¼Œé˜»å¡ç›´åˆ°ç»‘å®šäº‹ä»¶å‘ç”Ÿï¼Œæˆ–æ˜¯è¶…æ—¶ï¼ˆæ—¶é—´å•ä½ä¸º msï¼‰\nint count = selector.select(long timeout);\n\næ–¹æ³•3ï¼Œä¸ä¼šé˜»å¡ï¼Œä¹Ÿå°±æ˜¯ä¸ç®¡æœ‰æ²¡æœ‰äº‹ä»¶ï¼Œç«‹åˆ»è¿”å›ï¼Œè‡ªå·±æ ¹æ®è¿”å›å€¼æ£€æŸ¥æ˜¯å¦æœ‰äº‹ä»¶\nint count = selector.selectNow();\n\nselect ä½•æ—¶ä¸é˜»å¡\näº‹ä»¶å‘ç”Ÿæ—¶\nå®¢æˆ·ç«¯å‘èµ·è¿æ¥è¯·æ±‚ï¼Œä¼šè§¦å‘ accept äº‹ä»¶\nå®¢æˆ·ç«¯å‘é€æ•°æ®è¿‡æ¥ï¼Œå®¢æˆ·ç«¯æ­£å¸¸ã€å¼‚å¸¸å…³é—­æ—¶ï¼Œéƒ½ä¼šè§¦å‘ read äº‹ä»¶ï¼Œå¦å¤–å¦‚æœå‘é€çš„æ•°æ®å¤§äº buffer ç¼“å†²åŒºï¼Œä¼šè§¦å‘å¤šæ¬¡è¯»å–äº‹ä»¶\nchannel å¯å†™ï¼Œä¼šè§¦å‘ write äº‹ä»¶\nåœ¨ linux ä¸‹ nio bug å‘ç”Ÿæ—¶\n\n\nè°ƒç”¨ selector.wakeup()\nè°ƒç”¨ selector.close()\nselector æ‰€åœ¨çº¿ç¨‹ interrupt\n\nå¤„ç† accept äº‹ä»¶å®¢æˆ·ç«¯ä»£ç ä¸º\npublic class Client &#123;\n    public static void main(String[] args) &#123;\n        try (Socket socket = new Socket(\"localhost\", 8080)) &#123;\n            System.out.println(socket);\n            socket.getOutputStream().write(\"world\".getBytes());\n            System.in.read();\n        &#125; catch (IOException e) &#123;\n            e.printStackTrace();\n        &#125;\n    &#125;\n&#125;\n\n\n\næœåŠ¡å™¨ç«¯ä»£ç ä¸º\n@Slf4j\npublic class ChannelDemo6 &#123;\n    public static void main(String[] args) &#123;\n        try (ServerSocketChannel channel = ServerSocketChannel.open()) &#123;\n            channel.bind(new InetSocketAddress(8080));\n            System.out.println(channel);\n            Selector selector = Selector.open();\n            channel.configureBlocking(false);\n            channel.register(selector, SelectionKey.OP_ACCEPT);\n\n            while (true) &#123;\n                int count = selector.select();\n//                int count = selector.selectNow();\n                log.debug(\"select count: &#123;&#125;\", count);\n//                if(count &lt;= 0) &#123;\n//                    continue;\n//                &#125;\n\n                // è·å–æ‰€æœ‰äº‹ä»¶\n                Set&lt;SelectionKey> keys = selector.selectedKeys();\n\n                // éå†æ‰€æœ‰äº‹ä»¶ï¼Œé€ä¸€å¤„ç†\n                Iterator&lt;SelectionKey> iter = keys.iterator();\n                while (iter.hasNext()) &#123;\n                    SelectionKey key = iter.next();\n                    // åˆ¤æ–­äº‹ä»¶ç±»å‹\n                    if (key.isAcceptable()) &#123;\n                        ServerSocketChannel c = (ServerSocketChannel) key.channel();\n                        // å¿…é¡»å¤„ç†\n                        SocketChannel sc = c.accept();\n                        log.debug(\"&#123;&#125;\", sc);\n                    &#125;\n                    // å¤„ç†å®Œæ¯•ï¼Œå¿…é¡»å°†äº‹ä»¶ç§»é™¤\n                    iter.remove();\n                &#125;\n            &#125;\n        &#125; catch (IOException e) &#123;\n            e.printStackTrace();\n        &#125;\n    &#125;\n&#125;\n\n äº‹ä»¶å‘ç”Ÿåï¼Œè¦ä¹ˆå¤„ç†ï¼Œè¦ä¹ˆå–æ¶ˆï¼ˆcancelï¼‰ï¼Œä¸èƒ½ä»€ä¹ˆéƒ½ä¸åšï¼Œå¦åˆ™ä¸‹æ¬¡è¯¥äº‹ä»¶ä»ä¼šè§¦å‘ï¼Œè¿™æ˜¯å› ä¸º nio åº•å±‚ä½¿ç”¨çš„æ˜¯æ°´å¹³è§¦å‘\nå¤„ç† read äº‹ä»¶@Slf4j\npublic class ChannelDemo6 &#123;\n    public static void main(String[] args) &#123;\n        try (ServerSocketChannel channel = ServerSocketChannel.open()) &#123;\n            channel.bind(new InetSocketAddress(8080));\n            System.out.println(channel);\n            Selector selector = Selector.open();\n            channel.configureBlocking(false);\n            channel.register(selector, SelectionKey.OP_ACCEPT);\n\n            while (true) &#123;\n                int count = selector.select();\n//                int count = selector.selectNow();\n                log.debug(\"select count: &#123;&#125;\", count);\n//                if(count &lt;= 0) &#123;\n//                    continue;\n//                &#125;\n\n                // è·å–æ‰€æœ‰äº‹ä»¶\n                Set&lt;SelectionKey> keys = selector.selectedKeys();\n\n                // éå†æ‰€æœ‰äº‹ä»¶ï¼Œé€ä¸€å¤„ç†\n                Iterator&lt;SelectionKey> iter = keys.iterator();\n                while (iter.hasNext()) &#123;\n                    SelectionKey key = iter.next();\n                    // åˆ¤æ–­äº‹ä»¶ç±»å‹\n                    if (key.isAcceptable()) &#123;\n                        ServerSocketChannel c = (ServerSocketChannel) key.channel();\n                        // å¿…é¡»å¤„ç†\n                        SocketChannel sc = c.accept();\n                        sc.configureBlocking(false);\n                        sc.register(selector, SelectionKey.OP_READ);\n                        log.debug(\"è¿æ¥å·²å»ºç«‹: &#123;&#125;\", sc);\n                    &#125; else if (key.isReadable()) &#123;\n                        SocketChannel sc = (SocketChannel) key.channel();\n                        ByteBuffer buffer = ByteBuffer.allocate(128);\n                        int read = sc.read(buffer);\n                        if(read == -1) &#123;\n//cancel ä¼šå–æ¶ˆæ³¨å†Œåœ¨ selector ä¸Šçš„ channelï¼Œå¹¶ä» keys é›†åˆä¸­åˆ é™¤ key åç»­ä¸ä¼šå†ç›‘å¬äº‹ä»¶\n                            key.cancel();\n                            sc.close();\n                        &#125; else &#123;\n                            buffer.flip();\n                            debug(buffer);\n                        &#125;\n                    &#125;\n                    // å¤„ç†å®Œæ¯•ï¼Œå¿…é¡»å°†äº‹ä»¶ç§»é™¤\n                    iter.remove();\n                &#125;\n            &#125;\n        &#125; catch (IOException e) &#123;\n            e.printStackTrace();\n        &#125;\n    &#125;\n&#125;\n\nå¼€å¯ä¸¤ä¸ªå®¢æˆ·ç«¯ï¼Œä¿®æ”¹ä¸€ä¸‹å‘é€æ–‡å­—ï¼Œè¾“å‡º\nsun.nio.ch.ServerSocketChannelImpl[&#x2F;0:0:0:0:0:0:0:0:8080]\n21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1\n21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - è¿æ¥å·²å»ºç«‹: java.nio.channels.SocketChannel[connected local&#x3D;&#x2F;127.0.0.1:8080 remote&#x3D;&#x2F;127.0.0.1:60367]\n21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 68 65 6c 6c 6f                                  |hello           |\n+--------+-------------------------------------------------+----------------+\n21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1\n21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - è¿æ¥å·²å»ºç«‹: java.nio.channels.SocketChannel[connected local&#x3D;&#x2F;127.0.0.1:8080 remote&#x3D;&#x2F;127.0.0.1:60378]\n21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 77 6f 72 6c 64                                  |world           |\n+--------+-------------------------------------------------+----------------+\n\nä¸ºä½•è¦ iter.remove()\n\n\n\n\n\n\n\n\nå› ä¸º select åœ¨äº‹ä»¶å‘ç”Ÿåï¼Œå°±ä¼šå°†ç›¸å…³çš„ key æ”¾å…¥ selectedKeys é›†åˆï¼Œä½†ä¸ä¼šåœ¨å¤„ç†å®Œåä» selectedKeys é›†åˆä¸­ç§»é™¤ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±ç¼–ç åˆ é™¤ã€‚ä¾‹å¦‚\n\nç¬¬ä¸€æ¬¡è§¦å‘äº† ssckey ä¸Šçš„ accept äº‹ä»¶ï¼Œæ²¡æœ‰ç§»é™¤ ssckey \nç¬¬äºŒæ¬¡è§¦å‘äº† sckey ä¸Šçš„ read äº‹ä»¶ï¼Œä½†è¿™æ—¶ selectedKeys ä¸­è¿˜æœ‰ä¸Šæ¬¡çš„ ssckey ï¼Œåœ¨å¤„ç†æ—¶å› ä¸ºæ²¡æœ‰çœŸæ­£çš„ serverSocket è¿ä¸Šäº†ï¼Œå°±ä¼šå¯¼è‡´ç©ºæŒ‡é’ˆå¼‚å¸¸\n\nå¤„ç†æ¶ˆæ¯çš„è¾¹ç•Œ\nä¸€ç§æ€è·¯æ˜¯å›ºå®šæ¶ˆæ¯é•¿åº¦ï¼Œæ•°æ®åŒ…å¤§å°ä¸€æ ·ï¼ŒæœåŠ¡å™¨æŒ‰é¢„å®šé•¿åº¦è¯»å–ï¼Œç¼ºç‚¹æ˜¯æµªè´¹å¸¦å®½\nå¦ä¸€ç§æ€è·¯æ˜¯æŒ‰åˆ†éš”ç¬¦æ‹†åˆ†ï¼Œç¼ºç‚¹æ˜¯æ•ˆç‡ä½\nTLV æ ¼å¼ï¼Œå³ Type ç±»å‹ã€Length é•¿åº¦ã€Value æ•°æ®ï¼Œç±»å‹å’Œé•¿åº¦å·²çŸ¥çš„æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥æ–¹ä¾¿è·å–æ¶ˆæ¯å¤§å°ï¼Œåˆ†é…åˆé€‚çš„ bufferï¼Œç¼ºç‚¹æ˜¯ buffer éœ€è¦æå‰åˆ†é…ï¼Œå¦‚æœå†…å®¹è¿‡å¤§ï¼Œåˆ™å½±å“ server ååé‡\nHttp 1.1 æ˜¯ TLV æ ¼å¼\nHttp 2.0 æ˜¯ LTV æ ¼å¼\n\n\n\nsequenceDiagram \nparticipant c1 as å®¢æˆ·ç«¯1\nparticipant s as æœåŠ¡å™¨\nparticipant b1 as ByteBuffer1\nparticipant b2 as ByteBuffer2\nc1 ->> s: å‘é€ 01234567890abcdef3333\\r\ns ->> b1: ç¬¬ä¸€æ¬¡ read å­˜å…¥ 01234567890abcdef\ns ->> b2: æ‰©å®¹\nb1 ->> b2: æ‹·è´ 01234567890abcdef\ns ->> b2: ç¬¬äºŒæ¬¡ read å­˜å…¥ 3333\\r\nb2 ->> b2: 01234567890abcdef3333\\r\n\næœåŠ¡å™¨ç«¯\nprivate static void split(ByteBuffer source) &#123;\n    source.flip();\n    for (int i = 0; i &lt; source.limit(); i++) &#123;\n        // æ‰¾åˆ°ä¸€æ¡å®Œæ•´æ¶ˆæ¯\n        if (source.get(i) == '\\n') &#123;\n            int length = i + 1 - source.position();\n            // æŠŠè¿™æ¡å®Œæ•´æ¶ˆæ¯å­˜å…¥æ–°çš„ ByteBuffer\n            ByteBuffer target = ByteBuffer.allocate(length);\n            // ä» source è¯»ï¼Œå‘ target å†™\n            for (int j = 0; j &lt; length; j++) &#123;\n                target.put(source.get());\n            &#125;\n            debugAll(target);\n        &#125;\n    &#125;\n    source.compact(); // 0123456789abcdef  position 16 limit 16\n&#125;\n\npublic static void main(String[] args) throws IOException &#123;\n    // 1. åˆ›å»º selector, ç®¡ç†å¤šä¸ª channel\n    Selector selector = Selector.open();\n    ServerSocketChannel ssc = ServerSocketChannel.open();\n    ssc.configureBlocking(false);\n    // 2. å»ºç«‹ selector å’Œ channel çš„è”ç³»ï¼ˆæ³¨å†Œï¼‰\n    // SelectionKey å°±æ˜¯å°†æ¥äº‹ä»¶å‘ç”Ÿåï¼Œé€šè¿‡å®ƒå¯ä»¥çŸ¥é“äº‹ä»¶å’Œå“ªä¸ªchannelçš„äº‹ä»¶\n    SelectionKey sscKey = ssc.register(selector, 0, null);\n    // key åªå…³æ³¨ accept äº‹ä»¶\n    sscKey.interestOps(SelectionKey.OP_ACCEPT);\n    log.debug(\"sscKey:&#123;&#125;\", sscKey);\n    ssc.bind(new InetSocketAddress(8080));\n    while (true) &#123;\n        // 3. select æ–¹æ³•, æ²¡æœ‰äº‹ä»¶å‘ç”Ÿï¼Œçº¿ç¨‹é˜»å¡ï¼Œæœ‰äº‹ä»¶ï¼Œçº¿ç¨‹æ‰ä¼šæ¢å¤è¿è¡Œ\n        // select åœ¨äº‹ä»¶æœªå¤„ç†æ—¶ï¼Œå®ƒä¸ä¼šé˜»å¡, äº‹ä»¶å‘ç”Ÿåè¦ä¹ˆå¤„ç†ï¼Œè¦ä¹ˆå–æ¶ˆï¼Œä¸èƒ½ç½®ä¹‹ä¸ç†\n        selector.select();\n        // 4. å¤„ç†äº‹ä»¶, selectedKeys å†…éƒ¨åŒ…å«äº†æ‰€æœ‰å‘ç”Ÿçš„äº‹ä»¶\n        Iterator&lt;SelectionKey> iter = selector.selectedKeys().iterator(); // accept, read\n        while (iter.hasNext()) &#123;\n            SelectionKey key = iter.next();\n            // å¤„ç†key æ—¶ï¼Œè¦ä» selectedKeys é›†åˆä¸­åˆ é™¤ï¼Œå¦åˆ™ä¸‹æ¬¡å¤„ç†å°±ä¼šæœ‰é—®é¢˜\n            iter.remove();\n            log.debug(\"key: &#123;&#125;\", key);\n            // 5. åŒºåˆ†äº‹ä»¶ç±»å‹\n            if (key.isAcceptable()) &#123; // å¦‚æœæ˜¯ accept\n                ServerSocketChannel channel = (ServerSocketChannel) key.channel();\n                SocketChannel sc = channel.accept();\n                sc.configureBlocking(false);\n                ByteBuffer buffer = ByteBuffer.allocate(16); // attachment\n                // å°†ä¸€ä¸ª byteBuffer ä½œä¸ºé™„ä»¶å…³è”åˆ° selectionKey ä¸Š\n                SelectionKey scKey = sc.register(selector, 0, buffer);\n                scKey.interestOps(SelectionKey.OP_READ);\n                log.debug(\"&#123;&#125;\", sc);\n                log.debug(\"scKey:&#123;&#125;\", scKey);\n            &#125; else if (key.isReadable()) &#123; // å¦‚æœæ˜¯ read\n                try &#123;\n                    SocketChannel channel = (SocketChannel) key.channel(); // æ‹¿åˆ°è§¦å‘äº‹ä»¶çš„channel\n                    // è·å– selectionKey ä¸Šå…³è”çš„é™„ä»¶\n                  ByteBuffer buffer = (ByteBuffer) key.attachment();\n                  int read = channel.read(buffer); // å¦‚æœæ˜¯æ­£å¸¸æ–­å¼€ï¼Œread çš„æ–¹æ³•çš„è¿”å›å€¼æ˜¯ -1\n                    if(read == -1) &#123;\n                        key.cancel();\n                    &#125; else &#123;\n                        split(buffer);\n                        // éœ€è¦æ‰©å®¹\n                        if (buffer.position() == buffer.limit()) &#123;\n                     ByteBuffer newBuffer = ByteBuffer.allocate(buffer.capacity() * 2);\n                            buffer.flip();\n                            newBuffer.put(buffer); // 0123456789abcdef3333\\n\n                            key.attach(newBuffer);\n                        &#125;\n                    &#125;\n\n                &#125; catch (IOException e) &#123;\n                    e.printStackTrace();\n                    key.cancel();  // å› ä¸ºå®¢æˆ·ç«¯æ–­å¼€äº†,å› æ­¤éœ€è¦å°† key å–æ¶ˆï¼ˆä» selector çš„ keys é›†åˆä¸­çœŸæ­£åˆ é™¤ keyï¼‰\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n&#125;\n\nå®¢æˆ·ç«¯\nSocketChannel sc = SocketChannel.open();\nsc.connect(new InetSocketAddress(\"localhost\", 8080));\nSocketAddress address = sc.getLocalAddress();\n// sc.write(Charset.defaultCharset().encode(\"hello\\nworld\\n\"));\nsc.write(Charset.defaultCharset().encode(\"0123\\n456789abcdef\"));\nsc.write(Charset.defaultCharset().encode(\"0123456789abcdef3333\\n\"));\nSystem.in.read();\n\nByteBuffer å¤§å°åˆ†é…\næ¯ä¸ª channel éƒ½éœ€è¦è®°å½•å¯èƒ½è¢«åˆ‡åˆ†çš„æ¶ˆæ¯ï¼Œå› ä¸º ByteBuffer ä¸èƒ½è¢«å¤šä¸ª channel å…±åŒä½¿ç”¨ï¼Œå› æ­¤éœ€è¦ä¸ºæ¯ä¸ª channel ç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„ ByteBuffer\nByteBuffer ä¸èƒ½å¤ªå¤§ï¼Œæ¯”å¦‚ä¸€ä¸ª ByteBuffer 1Mb çš„è¯ï¼Œè¦æ”¯æŒç™¾ä¸‡è¿æ¥å°±è¦ 1Tb å†…å­˜ï¼Œå› æ­¤éœ€è¦è®¾è®¡å¤§å°å¯å˜çš„ ByteBuffer\nä¸€ç§æ€è·¯æ˜¯é¦–å…ˆåˆ†é…ä¸€ä¸ªè¾ƒå°çš„ bufferï¼Œä¾‹å¦‚ 4kï¼Œå¦‚æœå‘ç°æ•°æ®ä¸å¤Ÿï¼Œå†åˆ†é… 8k çš„ bufferï¼Œå°† 4k buffer å†…å®¹æ‹·è´è‡³ 8k bufferï¼Œä¼˜ç‚¹æ˜¯æ¶ˆæ¯è¿ç»­å®¹æ˜“å¤„ç†ï¼Œç¼ºç‚¹æ˜¯æ•°æ®æ‹·è´è€—è´¹æ€§èƒ½ï¼Œå‚è€ƒå®ç° http://tutorials.jenkov.com/java-performance/resizable-array.html\nå¦ä¸€ç§æ€è·¯æ˜¯ç”¨å¤šä¸ªæ•°ç»„ç»„æˆ bufferï¼Œä¸€ä¸ªæ•°ç»„ä¸å¤Ÿï¼ŒæŠŠå¤šå‡ºæ¥çš„å†…å®¹å†™å…¥æ–°çš„æ•°ç»„ï¼Œä¸å‰é¢çš„åŒºåˆ«æ˜¯æ¶ˆæ¯å­˜å‚¨ä¸è¿ç»­è§£æå¤æ‚ï¼Œä¼˜ç‚¹æ˜¯é¿å…äº†æ‹·è´å¼•èµ·çš„æ€§èƒ½æŸè€—\n\n\n\nå¤„ç† write äº‹ä»¶ä¸€æ¬¡æ— æ³•å†™å®Œä¾‹å­\néé˜»å¡æ¨¡å¼ä¸‹ï¼Œæ— æ³•ä¿è¯æŠŠ buffer ä¸­æ‰€æœ‰æ•°æ®éƒ½å†™å…¥ channelï¼Œå› æ­¤éœ€è¦è¿½è¸ª write æ–¹æ³•çš„è¿”å›å€¼ï¼ˆä»£è¡¨å®é™…å†™å…¥å­—èŠ‚æ•°ï¼‰\nç”¨ selector ç›‘å¬æ‰€æœ‰ channel çš„å¯å†™äº‹ä»¶ï¼Œæ¯ä¸ª channel éƒ½éœ€è¦ä¸€ä¸ª key æ¥è·Ÿè¸ª bufferï¼Œä½†è¿™æ ·åˆä¼šå¯¼è‡´å ç”¨å†…å­˜è¿‡å¤šï¼Œå°±æœ‰ä¸¤é˜¶æ®µç­–ç•¥\nå½“æ¶ˆæ¯å¤„ç†å™¨ç¬¬ä¸€æ¬¡å†™å…¥æ¶ˆæ¯æ—¶ï¼Œæ‰å°† channel æ³¨å†Œåˆ° selector ä¸Š\nselector æ£€æŸ¥ channel ä¸Šçš„å¯å†™äº‹ä»¶ï¼Œå¦‚æœæ‰€æœ‰çš„æ•°æ®å†™å®Œäº†ï¼Œå°±å–æ¶ˆ channel çš„æ³¨å†Œ\nå¦‚æœä¸å–æ¶ˆï¼Œä¼šæ¯æ¬¡å¯å†™å‡ä¼šè§¦å‘ write äº‹ä»¶\n\n\n\npublic class WriteServer &#123;\n\n    public static void main(String[] args) throws IOException &#123;\n        ServerSocketChannel ssc = ServerSocketChannel.open();\n        ssc.configureBlocking(false);\n        ssc.bind(new InetSocketAddress(8080));\n\n        Selector selector = Selector.open();\n        ssc.register(selector, SelectionKey.OP_ACCEPT);\n\n        while(true) &#123;\n            selector.select();\n\n            Iterator&lt;SelectionKey> iter = selector.selectedKeys().iterator();\n            while (iter.hasNext()) &#123;\n                SelectionKey key = iter.next();\n                iter.remove();\n                if (key.isAcceptable()) &#123;\n                    SocketChannel sc = ssc.accept();\n                    sc.configureBlocking(false);\n                    SelectionKey sckey = sc.register(selector, SelectionKey.OP_READ);\n                    // 1. å‘å®¢æˆ·ç«¯å‘é€å†…å®¹\n                    StringBuilder sb = new StringBuilder();\n                    for (int i = 0; i &lt; 3000000; i++) &#123;\n                        sb.append(\"a\");\n                    &#125;\n                    ByteBuffer buffer = Charset.defaultCharset().encode(sb.toString());\n                    int write = sc.write(buffer);\n                    // 3. write è¡¨ç¤ºå®é™…å†™äº†å¤šå°‘å­—èŠ‚\n                    System.out.println(\"å®é™…å†™å…¥å­—èŠ‚:\" + write);\n                    // 4. å¦‚æœæœ‰å‰©ä½™æœªè¯»å­—èŠ‚ï¼Œæ‰éœ€è¦å…³æ³¨å†™äº‹ä»¶\n                    if (buffer.hasRemaining()) &#123;\n                        // read 1  write 4\n                        // åœ¨åŸæœ‰å…³æ³¨äº‹ä»¶çš„åŸºç¡€ä¸Šï¼Œå¤šå…³æ³¨ å†™äº‹ä»¶\n                        sckey.interestOps(sckey.interestOps() + SelectionKey.OP_WRITE);\n                        // æŠŠ buffer ä½œä¸ºé™„ä»¶åŠ å…¥ sckey\n                        sckey.attach(buffer);\n                    &#125;\n                &#125; else if (key.isWritable()) &#123;\n                    ByteBuffer buffer = (ByteBuffer) key.attachment();\n                    SocketChannel sc = (SocketChannel) key.channel();\n                    int write = sc.write(buffer);\n                    System.out.println(\"å®é™…å†™å…¥å­—èŠ‚:\" + write);\n                    if (!buffer.hasRemaining()) &#123; // å†™å®Œäº†\n          //åªè¦å‘ channel å‘é€æ•°æ®æ—¶ï¼Œsocket ç¼“å†²å¯å†™ï¼Œè¿™ä¸ªäº‹ä»¶ä¼šé¢‘ç¹è§¦å‘ï¼Œå› æ­¤åº”å½“åªåœ¨ socket ç¼“å†²åŒº\t\t   //å†™ä¸ä¸‹æ—¶å†å…³æ³¨å¯å†™äº‹ä»¶ï¼Œæ•°æ®å†™å®Œä¹‹åå†å–æ¶ˆå…³æ³¨\n                        key.interestOps(key.interestOps() - SelectionKey.OP_WRITE);\n                        key.attach(null);\n                    &#125;\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n&#125;\n\nå®¢æˆ·ç«¯\npublic class WriteClient &#123;\n    public static void main(String[] args) throws IOException &#123;\n        Selector selector = Selector.open();\n        SocketChannel sc = SocketChannel.open();\n        sc.configureBlocking(false);\n        sc.register(selector, SelectionKey.OP_CONNECT | SelectionKey.OP_READ);\n        sc.connect(new InetSocketAddress(\"localhost\", 8080));\n        int count = 0;\n        while (true) &#123;\n            selector.select();\n            Iterator&lt;SelectionKey> iter = selector.selectedKeys().iterator();\n            while (iter.hasNext()) &#123;\n                SelectionKey key = iter.next();\n                iter.remove();\n                if (key.isConnectable()) &#123;\n                    System.out.println(sc.finishConnect());\n                &#125; else if (key.isReadable()) &#123;\n                    ByteBuffer buffer = ByteBuffer.allocate(1024 * 1024);\n                    count += sc.read(buffer);\n                    buffer.clear();\n                    System.out.println(count);\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n&#125;\n\nåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒServerSocketChannel å’Œ SocketChannel çš„é€šä¿¡æµç¨‹å¦‚ä¸‹ï¼š\n1.é¦–å…ˆï¼ŒæœåŠ¡å™¨ç«¯è°ƒç”¨ ServerSocketChannel.open() æ–¹æ³• æ‰“å¼€ä¸€ä¸ª ServerSocketChannel é€šé“ï¼Œå¹¶è°ƒç”¨ configureBlocking(false) å°†å…¶è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ã€‚\n2.æ¥ç€ï¼ŒæœåŠ¡å™¨ç«¯è°ƒç”¨ ServerSocketChannel.bind() æ–¹æ³•ç»‘å®šç›‘å¬çš„ç«¯å£ï¼Œå¹¶é€šè¿‡è°ƒç”¨ Selector.open() åˆ›å»ºä¸€ä¸ª Selector å¯¹è±¡ã€‚ç„¶åï¼Œé€šè¿‡ ServerSocketChannel.register() æ–¹æ³•å°† ServerSocketChannel æ³¨å†Œåˆ° Selector ä¸­ï¼Œç›‘å¬ SelectionKey.ACCEPT äº‹ä»¶ã€‚\n3.å½“å®¢æˆ·ç«¯å‘èµ·è¿æ¥è¯·æ±‚æ—¶ï¼ŒæœåŠ¡å™¨ç«¯çš„ Selector ç›‘å¬åˆ°è¯¥è¯·æ±‚å¹¶è§¦å‘äº‹ä»¶ï¼ŒæœåŠ¡å™¨ç«¯é€šè¿‡ Selector.selectedKeys() æ–¹æ³•è·å–è¯¥äº‹ä»¶å¯¹åº”çš„ SelectionKeyï¼Œå¹¶é€šè¿‡ SelectionKey.channel() è·å–å…¶å¯¹åº”çš„ ServerSocketChannel å¯¹è±¡ã€‚\n4.æœåŠ¡å™¨ç«¯é€šè¿‡ ServerSocketChannel.accept() æ–¹æ³•å“åº”è¿æ¥è¯·æ±‚ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ SocketChannel å¯¹è±¡ã€‚\n5.æœåŠ¡å™¨ç«¯é€šè¿‡ SocketChannel.configureBlocking(false) å°† SocketChannel å¯¹è±¡è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ° Selector å¯¹è±¡ä¸Šï¼Œç›‘å¬ SelectionKey.OP_READ äº‹ä»¶ã€‚\n6.å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯å‡å·²ç»åœ¨å„è‡ªçš„ Selector å¯¹è±¡ä¸Šæ³¨å†Œäº† OP_READ äº‹ä»¶ï¼Œè¡¨ç¤ºå¯ä»¥äº’ç›¸ä¼ è¾“æ•°æ®ã€‚\n7.å½“ Selector ç›‘å¬åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®æ—¶ï¼Œä¼šè§¦å‘ SelectableChannel çš„ OP_READ äº‹ä»¶ï¼Œæ­¤æ—¶æœåŠ¡å™¨ç«¯é€šè¿‡ Selector.selectedKeys() æ–¹æ³•è·å–è¯¥äº‹ä»¶å¯¹åº”çš„ SelectionKeyï¼Œå¹¶é€šè¿‡ SelectionKey.channel() è·å–å…¶å¯¹åº”çš„ SocketChannel å¯¹è±¡ã€‚\n8.é€šè¿‡ SocketChannel çš„ read() æ–¹æ³•è¯»å–æ•°æ®ï¼Œå¹¶é€šè¿‡ Selector.register() æ–¹æ³•å‘ Selector ä¸Šæ³¨å†Œ SelectionKey.OP_WRITE äº‹ä»¶ï¼Œè¡¨ç¤ºæœåŠ¡å™¨éœ€è¦ç»™å®¢æˆ·ç«¯å‘é€æ•°æ®ã€‚\n9.å½“ Selector ç›‘å¬åˆ°æœåŠ¡å™¨è°ƒç”¨ SocketChannel çš„ write() æ–¹æ³•å‡†å¤‡å‘é€æ•°æ®æ—¶ï¼Œä¼šè§¦å‘ SelectableChannel çš„ OP_WRITE äº‹ä»¶ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯é€šè¿‡ Selector.selectedKeys() æ–¹æ³•è·å–è¯¥äº‹ä»¶å¯¹åº”çš„ SelectionKeyï¼Œå¹¶é€šè¿‡ SelectionKey.channel() è·å–å…¶å¯¹åº”çš„ SocketChannel å¯¹è±¡ã€‚\n10.é€šè¿‡ SocketChannel çš„ write() æ–¹æ³•å‘å®¢æˆ·ç«¯å‘é€æ•°æ®ã€‚\nä»¥ä¸Šå³ä¸º SocketChannel å’Œ ServerSocketChannel ä¹‹é—´é€šä¿¡çš„åŸºæœ¬æµç¨‹ï¼Œé€šè¿‡ Selector ç›‘å¬äº‹ä»¶å¹¶è§¦å‘å¤„ç†ï¼Œå®ç°äº†å¤šä¸ª Channel ä¹‹é—´çš„ I&#x2F;O é€šä¿¡ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿˜éœ€è¦å¤„ç†å¼‚å¸¸æƒ…å†µã€å…³é—­ Channel å’Œ Selector ç­‰æ“ä½œã€‚\nåˆ©ç”¨å¤šçº¿ç¨‹ä¼˜åŒ–å‰é¢çš„ä»£ç åªæœ‰ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œæ²¡æœ‰å……åˆ†åˆ©ç”¨å¤šæ ¸ cpuï¼Œå¦‚ä½•æ”¹è¿›å‘¢ï¼Ÿ\nåˆ†ä¸¤ç»„é€‰æ‹©å™¨\n\nå•çº¿ç¨‹é…ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œä¸“é—¨å¤„ç† accept äº‹ä»¶\nåˆ›å»º cpu æ ¸å¿ƒæ•°çš„çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹é…ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œè½®æµå¤„ç† read äº‹ä»¶\n\npublic class ChannelDemo7 &#123;\n    public static void main(String[] args) throws IOException &#123;\n        new BossEventLoop().register();\n    &#125;\n\n\n    @Slf4j\n    static class BossEventLoop implements Runnable &#123;\n        private Selector boss;\n        private WorkerEventLoop[] workers;\n        private volatile boolean start = false;\n        AtomicInteger index = new AtomicInteger();\n\n        public void register() throws IOException &#123;\n            if (!start) &#123;\n                ServerSocketChannel ssc = ServerSocketChannel.open();\n                ssc.bind(new InetSocketAddress(8080));\n                ssc.configureBlocking(false);\n                boss = Selector.open();\n                SelectionKey ssckey = ssc.register(boss, 0, null);\n                ssckey.interestOps(SelectionKey.OP_ACCEPT);\n                workers = initEventLoops();\n                new Thread(this, \"boss\").start();\n                log.debug(\"boss start...\");\n                start = true;\n            &#125;\n        &#125;\n\n        public WorkerEventLoop[] initEventLoops() &#123;\n//        EventLoop[] eventLoops = new EventLoop[Runtime.getRuntime().availableProcessors()];\n            WorkerEventLoop[] workerEventLoops = new WorkerEventLoop[2];\n            for (int i = 0; i &lt; workerEventLoops.length; i++) &#123;\n                workerEventLoops[i] = new WorkerEventLoop(i);\n            &#125;\n            return workerEventLoops;\n        &#125;\n\n        @Override\n        public void run() &#123;\n            while (true) &#123;\n                try &#123;\n                    boss.select();\n                    Iterator&lt;SelectionKey> iter = boss.selectedKeys().iterator();\n                    while (iter.hasNext()) &#123;\n                        SelectionKey key = iter.next();\n                        iter.remove();\n                        if (key.isAcceptable()) &#123;\n                            ServerSocketChannel c = (ServerSocketChannel) key.channel();\n                            SocketChannel sc = c.accept();\n                            sc.configureBlocking(false);\n                            log.debug(\"&#123;&#125; connected\", sc.getRemoteAddress());\n                      workers[index.getAndIncrement() % workers.length].register(sc);\n                        &#125;\n                    &#125;\n                &#125; catch (IOException e) &#123;\n                    e.printStackTrace();\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n\n    @Slf4j\n    static class WorkerEventLoop implements Runnable &#123;\n        private Selector worker;\n        private volatile boolean start = false;\n        private int index;\n\n     private final ConcurrentLinkedQueue&lt;Runnable> tasks = new ConcurrentLinkedQueue&lt;>();\n\n        public WorkerEventLoop(int index) &#123;\n            this.index = index;\n        &#125;\n\n        public void register(SocketChannel sc) throws IOException &#123;\n            if (!start) &#123;\n                worker = Selector.open();\n                new Thread(this, \"worker-\" + index).start();\n                start = true;\n            &#125;\n            tasks.add(() -> &#123;\n                try &#123;\n                    SelectionKey sckey = sc.register(worker, 0, null);\n                    sckey.interestOps(SelectionKey.OP_READ);\n                    worker.selectNow();\n                &#125; catch (IOException e) &#123;\n                    e.printStackTrace();\n                &#125;\n            &#125;);\n            worker.wakeup();\n        &#125;\n\n        @Override\n        public void run() &#123;\n            while (true) &#123;\n                try &#123;\n                    worker.select();\n                    Runnable task = tasks.poll();\n                    if (task != null) &#123;\n                        task.run();\n                    &#125;\n                    Set&lt;SelectionKey> keys = worker.selectedKeys();\n                    Iterator&lt;SelectionKey> iter = keys.iterator();\n                    while (iter.hasNext()) &#123;\n                        SelectionKey key = iter.next();\n                        if (key.isReadable()) &#123;\n                            SocketChannel sc = (SocketChannel) key.channel();\n                            ByteBuffer buffer = ByteBuffer.allocate(128);\n                            try &#123;\n                                int read = sc.read(buffer);\n                                if (read == -1) &#123;\n                                    key.cancel();\n                                    sc.close();\n                                &#125; else &#123;\n                                    buffer.flip();\n                                    log.debug(\"&#123;&#125; message:\", sc.getRemoteAddress());\n                                    debugAll(buffer);\n                                &#125;\n                            &#125; catch (IOException e) &#123;\n                                e.printStackTrace();\n                                key.cancel();\n                                sc.close();\n                            &#125;\n                        &#125;\n                        iter.remove();\n                    &#125;\n                &#125; catch (IOException e) &#123;\n                    e.printStackTrace();\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n&#125;\n\n\n\nUDP\nUDP æ˜¯æ— è¿æ¥çš„ï¼Œclient å‘é€æ•°æ®ä¸ä¼šç®¡ server æ˜¯å¦å¼€å¯\nserver è¿™è¾¹çš„ receive æ–¹æ³•ä¼šå°†æ¥æ”¶åˆ°çš„æ•°æ®å­˜å…¥ byte bufferï¼Œä½†å¦‚æœæ•°æ®æŠ¥æ–‡è¶…è¿‡ buffer å¤§å°ï¼Œå¤šå‡ºæ¥çš„æ•°æ®ä¼šè¢«é»˜é»˜æŠ›å¼ƒ\n\né¦–å…ˆå¯åŠ¨æœåŠ¡å™¨ç«¯\npublic class UdpServer &#123;\n    public static void main(String[] args) &#123;\n        try (DatagramChannel channel = DatagramChannel.open()) &#123;\n            channel.socket().bind(new InetSocketAddress(9999));\n            System.out.println(\"waiting...\");\n            ByteBuffer buffer = ByteBuffer.allocate(32);\n            channel.receive(buffer);\n            buffer.flip();\n            debug(buffer);\n        &#125; catch (IOException e) &#123;\n            e.printStackTrace();\n        &#125;\n    &#125;\n&#125;\n\nè¾“å‡º\nwaiting...\n\n\n\nè¿è¡Œå®¢æˆ·ç«¯\npublic class UdpClient &#123;\n    public static void main(String[] args) &#123;\n        try (DatagramChannel channel = DatagramChannel.open()) &#123;\n            ByteBuffer buffer = StandardCharsets.UTF_8.encode(\"hello\");\n            InetSocketAddress address = new InetSocketAddress(\"localhost\", 9999);\n            channel.send(buffer, address);\n        &#125; catch (Exception e) &#123;\n            e.printStackTrace();\n        &#125;\n    &#125;\n&#125;\n\næ¥ä¸‹æ¥æœåŠ¡å™¨ç«¯è¾“å‡º\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 68 65 6c 6c 6f                                  |hello           |\n+--------+-------------------------------------------------+----------------+\n\nNIO vs BIOstream vs channel\nstream ä¸ä¼šè‡ªåŠ¨ç¼“å†²æ•°æ®ï¼Œchannel ä¼šåˆ©ç”¨ç³»ç»Ÿæä¾›çš„å‘é€ç¼“å†²åŒºã€æ¥æ”¶ç¼“å†²åŒºï¼ˆæ›´ä¸ºåº•å±‚ï¼‰\nstream ä»…æ”¯æŒé˜»å¡ APIï¼Œchannel åŒæ—¶æ”¯æŒé˜»å¡ã€éé˜»å¡ APIï¼Œç½‘ç»œ channel å¯é…åˆ selector å®ç°å¤šè·¯å¤ç”¨\näºŒè€…å‡ä¸ºå…¨åŒå·¥ï¼Œå³è¯»å†™å¯ä»¥åŒæ—¶è¿›è¡Œ\n\nIO æ¨¡å‹åŒæ­¥é˜»å¡ã€åŒæ­¥éé˜»å¡ã€åŒæ­¥å¤šè·¯å¤ç”¨ã€å¼‚æ­¥é˜»å¡ï¼ˆæ²¡æœ‰æ­¤æƒ…å†µï¼‰ã€å¼‚æ­¥éé˜»å¡\n\nåŒæ­¥ï¼šçº¿ç¨‹è‡ªå·±å»è·å–ç»“æœï¼ˆä¸€ä¸ªçº¿ç¨‹ï¼‰\nå¼‚æ­¥ï¼šçº¿ç¨‹è‡ªå·±ä¸å»è·å–ç»“æœï¼Œè€Œæ˜¯ç”±å…¶å®ƒçº¿ç¨‹é€ç»“æœï¼ˆè‡³å°‘ä¸¤ä¸ªçº¿ç¨‹ï¼‰\n\nå½“è°ƒç”¨ä¸€æ¬¡ channel.read æˆ– stream.read åï¼Œä¼šåˆ‡æ¢è‡³æ“ä½œç³»ç»Ÿå†…æ ¸æ€æ¥å®ŒæˆçœŸæ­£æ•°æ®è¯»å–ï¼Œè€Œè¯»å–åˆåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«ä¸ºï¼š\n\nç­‰å¾…æ•°æ®é˜¶æ®µ\nå¤åˆ¶æ•°æ®é˜¶æ®µ\n\n\n\né˜»å¡ IO\n\n\néé˜»å¡  IO\n\n\nå¤šè·¯å¤ç”¨\n\n\nä¿¡å·é©±åŠ¨\n\nå¼‚æ­¥ IO\n\n\né˜»å¡ IO vs å¤šè·¯å¤ç”¨\n\n\n\n\né›¶æ‹·è´ä¼ ç»Ÿ IO é—®é¢˜ä¼ ç»Ÿçš„ IO å°†ä¸€ä¸ªæ–‡ä»¶é€šè¿‡ socket å†™å‡º\nFile f = new File(\"helloword/data.txt\");\nRandomAccessFile file = new RandomAccessFile(file, \"r\");\n\nbyte[] buf = new byte[(int)f.length()];\nfile.read(buf);\n\nSocket socket = ...;\nsocket.getOutputStream().write(buf);\n\nå†…éƒ¨å·¥ä½œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š\n\n\njava æœ¬èº«å¹¶ä¸å…·å¤‡ IO è¯»å†™èƒ½åŠ›ï¼Œå› æ­¤ read æ–¹æ³•è°ƒç”¨åï¼Œè¦ä» java ç¨‹åºçš„ç”¨æˆ·æ€åˆ‡æ¢è‡³å†…æ ¸æ€ï¼Œå»è°ƒç”¨æ“ä½œç³»ç»Ÿï¼ˆKernelï¼‰çš„è¯»èƒ½åŠ›ï¼Œå°†æ•°æ®è¯»å…¥å†…æ ¸ç¼“å†²åŒºã€‚è¿™æœŸé—´ç”¨æˆ·çº¿ç¨‹é˜»å¡ï¼Œæ“ä½œç³»ç»Ÿä½¿ç”¨ DMAï¼ˆDirect Memory Accessï¼‰æ¥å®ç°æ–‡ä»¶è¯»ï¼Œå…¶é—´ä¹Ÿä¸ä¼šä½¿ç”¨ cpu\n\n\n\n\n\n\n\n\n\nDMA ä¹Ÿå¯ä»¥ç†è§£ä¸ºç¡¬ä»¶å•å…ƒï¼Œç”¨æ¥è§£æ”¾ cpu å®Œæˆæ–‡ä»¶ IO\n\nä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€ï¼Œå°†æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºè¯»å…¥ç”¨æˆ·ç¼“å†²åŒºï¼ˆå³ byte[] bufï¼‰ï¼Œè¿™æœŸé—´ cpu ä¼šå‚ä¸æ‹·è´ï¼Œæ— æ³•åˆ©ç”¨ DMA\n\nè°ƒç”¨ write æ–¹æ³•ï¼Œè¿™æ—¶å°†æ•°æ®ä»ç”¨æˆ·ç¼“å†²åŒºï¼ˆbyte[] bufï¼‰å†™å…¥ socket ç¼“å†²åŒºï¼Œcpu ä¼šå‚ä¸æ‹·è´\n\næ¥ä¸‹æ¥è¦å‘ç½‘å¡å†™æ•°æ®ï¼Œè¿™é¡¹èƒ½åŠ› java åˆä¸å…·å¤‡ï¼Œå› æ­¤åˆå¾—ä»ç”¨æˆ·æ€åˆ‡æ¢è‡³å†…æ ¸æ€ï¼Œè°ƒç”¨æ“ä½œç³»ç»Ÿçš„å†™èƒ½åŠ›ï¼Œä½¿ç”¨ DMA å°† socket ç¼“å†²åŒºçš„æ•°æ®å†™å…¥ç½‘å¡ï¼Œä¸ä¼šä½¿ç”¨ cpu\n\n\nå¯ä»¥çœ‹åˆ°ä¸­é—´ç¯èŠ‚è¾ƒå¤šï¼Œjava çš„ IO å®é™…ä¸æ˜¯ç‰©ç†è®¾å¤‡çº§åˆ«çš„è¯»å†™ï¼Œè€Œæ˜¯ç¼“å­˜çš„å¤åˆ¶ï¼Œåº•å±‚çš„çœŸæ­£è¯»å†™æ˜¯æ“ä½œç³»ç»Ÿæ¥å®Œæˆçš„\n\nç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢å‘ç”Ÿäº† 3 æ¬¡ï¼Œè¿™ä¸ªæ“ä½œæ¯”è¾ƒé‡é‡çº§\næ•°æ®æ‹·è´äº†å…± 4 æ¬¡\n\nNIO ä¼˜åŒ–é€šè¿‡ DirectByteBuf \n\nByteBuffer.allocate(10)  HeapByteBuffer ä½¿ç”¨çš„è¿˜æ˜¯ java å†…å­˜\nByteBuffer.allocateDirect(10)  DirectByteBuffer ä½¿ç”¨çš„æ˜¯æ“ä½œç³»ç»Ÿå†…å­˜\n\n\nå¤§éƒ¨åˆ†æ­¥éª¤ä¸ä¼˜åŒ–å‰ç›¸åŒï¼Œä¸å†èµ˜è¿°ã€‚å”¯æœ‰ä¸€ç‚¹ï¼šjava å¯ä»¥ä½¿ç”¨ DirectByteBuf å°†å †å¤–å†…å­˜æ˜ å°„åˆ° jvm å†…å­˜ä¸­æ¥ç›´æ¥è®¿é—®ä½¿ç”¨\n\nè¿™å—å†…å­˜ä¸å— jvm åƒåœ¾å›æ”¶çš„å½±å“ï¼Œå› æ­¤å†…å­˜åœ°å€å›ºå®šï¼Œæœ‰åŠ©äº IO è¯»å†™\njava ä¸­çš„ DirectByteBuf å¯¹è±¡ä»…ç»´æŠ¤äº†æ­¤å†…å­˜çš„è™šå¼•ç”¨ï¼Œå†…å­˜å›æ”¶åˆ†æˆä¸¤æ­¥\nDirectByteBuf å¯¹è±¡è¢«åƒåœ¾å›æ”¶ï¼Œå°†è™šå¼•ç”¨åŠ å…¥å¼•ç”¨é˜Ÿåˆ—\né€šè¿‡ä¸“é—¨çº¿ç¨‹è®¿é—®å¼•ç”¨é˜Ÿåˆ—ï¼Œæ ¹æ®è™šå¼•ç”¨é‡Šæ”¾å †å¤–å†…å­˜\n\n\nå‡å°‘äº†ä¸€æ¬¡æ•°æ®æ‹·è´ï¼Œç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢æ¬¡æ•°æ²¡æœ‰å‡å°‘\n\nè¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆåº•å±‚é‡‡ç”¨äº† linux 2.1 åæä¾›çš„ sendFile æ–¹æ³•ï¼‰ï¼Œjava ä¸­å¯¹åº”ç€ä¸¤ä¸ª channel è°ƒç”¨ transferTo&#x2F;transferFrom æ–¹æ³•æ‹·è´æ•°æ®\n\n\njava è°ƒç”¨ transferTo æ–¹æ³•åï¼Œè¦ä» java ç¨‹åºçš„ç”¨æˆ·æ€åˆ‡æ¢è‡³å†…æ ¸æ€ï¼Œä½¿ç”¨ DMAå°†æ•°æ®è¯»å…¥å†…æ ¸ç¼“å†²åŒºï¼Œä¸ä¼šä½¿ç”¨ cpu\næ•°æ®ä»å†…æ ¸ç¼“å†²åŒºä¼ è¾“åˆ° socket ç¼“å†²åŒºï¼Œcpu ä¼šå‚ä¸æ‹·è´\næœ€åä½¿ç”¨ DMA å°† socket ç¼“å†²åŒºçš„æ•°æ®å†™å…¥ç½‘å¡ï¼Œä¸ä¼šä½¿ç”¨ cpu\n\nå¯ä»¥çœ‹åˆ°\n\nåªå‘ç”Ÿäº†ä¸€æ¬¡ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢\næ•°æ®æ‹·è´äº† 3 æ¬¡\n\nè¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆlinux 2.4ï¼‰\n\n\njava è°ƒç”¨ transferTo æ–¹æ³•åï¼Œè¦ä» java ç¨‹åºçš„ç”¨æˆ·æ€åˆ‡æ¢è‡³å†…æ ¸æ€ï¼Œä½¿ç”¨ DMAå°†æ•°æ®è¯»å…¥å†…æ ¸ç¼“å†²åŒºï¼Œä¸ä¼šä½¿ç”¨ cpu\nåªä¼šå°†ä¸€äº› offset å’Œ length ä¿¡æ¯æ‹·å…¥ socket ç¼“å†²åŒºï¼Œå‡ ä¹æ— æ¶ˆè€—\nä½¿ç”¨ DMA å°† å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®å†™å…¥ç½‘å¡ï¼Œä¸ä¼šä½¿ç”¨ cpu\n\næ•´ä¸ªè¿‡ç¨‹ä»…åªå‘ç”Ÿäº†ä¸€æ¬¡ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæ•°æ®æ‹·è´äº† 2 æ¬¡ã€‚æ‰€è°“çš„ã€é›¶æ‹·è´ã€‘ï¼Œå¹¶ä¸æ˜¯çœŸæ­£æ— æ‹·è´ï¼Œè€Œæ˜¯åœ¨ä¸ä¼šæ‹·è´é‡å¤æ•°æ®åˆ° jvm å†…å­˜ä¸­ï¼Œé›¶æ‹·è´çš„ä¼˜ç‚¹æœ‰\n\næ›´å°‘çš„ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢\nä¸åˆ©ç”¨ cpu è®¡ç®—ï¼Œå‡å°‘ cpu ç¼“å­˜ä¼ªå…±äº«\né›¶æ‹·è´é€‚åˆå°æ–‡ä»¶ä¼ è¾“\n\nAIOï¼ˆAsynchronous I&#x2F;Oï¼Œå¼‚æ­¥I&#x2F;Oï¼‰æ˜¯ä¸€ç§ I&#x2F;O æ“ä½œçš„æŠ€æœ¯AIO ç”¨æ¥è§£å†³æ•°æ®å¤åˆ¶é˜¶æ®µçš„é˜»å¡é—®é¢˜\n\nåŒæ­¥æ„å‘³ç€ï¼Œåœ¨è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œçº¿ç¨‹éœ€è¦ç­‰å¾…ç»“æœï¼Œè¿˜æ˜¯ç›¸å½“äºé—²ç½®\nå¼‚æ­¥æ„å‘³ç€ï¼Œåœ¨è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œçº¿ç¨‹ä¸å¿…ç­‰å¾…ç»“æœï¼Œè€Œæ˜¯å°†æ¥ç”±æ“ä½œç³»ç»Ÿæ¥é€šè¿‡å›è°ƒæ–¹å¼ç”±å¦å¤–çš„çº¿ç¨‹æ¥è·å¾—ç»“æœ\n\n\n\n\n\n\n\n\n\n\nå¼‚æ­¥æ¨¡å‹éœ€è¦åº•å±‚æ“ä½œç³»ç»Ÿï¼ˆKernelï¼‰æä¾›æ”¯æŒ\n\nWindows ç³»ç»Ÿé€šè¿‡ IOCP å®ç°äº†çœŸæ­£çš„å¼‚æ­¥ IO\nLinux ç³»ç»Ÿå¼‚æ­¥ IO åœ¨ 2.6 ç‰ˆæœ¬å¼•å…¥ï¼Œä½†å…¶åº•å±‚å®ç°è¿˜æ˜¯ç”¨å¤šè·¯å¤ç”¨æ¨¡æ‹Ÿäº†å¼‚æ­¥ IOï¼Œæ€§èƒ½æ²¡æœ‰ä¼˜åŠ¿\n\næ–‡ä»¶ AIOå…ˆæ¥çœ‹çœ‹ AsynchronousFileChannel\n@Slf4j\npublic class AioDemo1 &#123;\n    public static void main(String[] args) throws IOException &#123;\n        try&#123;\n            AsynchronousFileChannel s = \n                AsynchronousFileChannel.open(\n                \tPaths.get(\"1.txt\"), StandardOpenOption.READ);\n            ByteBuffer buffer = ByteBuffer.allocate(2);\n            log.debug(\"begin...\");\n            s.read(buffer, 0, null, new CompletionHandler&lt;Integer, ByteBuffer>() &#123;\n                @Override\n                public void completed(Integer result, ByteBuffer attachment) &#123;\n                    log.debug(\"read completed...&#123;&#125;\", result);\n                    buffer.flip();\n                    debug(buffer);\n                &#125;\n\n                @Override\n                public void failed(Throwable exc, ByteBuffer attachment) &#123;\n                    log.debug(\"read failed...\");\n                &#125;\n            &#125;);\n\n        &#125; catch (IOException e) &#123;\n            e.printStackTrace();\n        &#125;\n        log.debug(\"do other things...\");\n        System.in.read();\n    &#125;\n&#125;\n\nè¾“å‡º\n13:44:56 [DEBUG] [main] c.i.aio.AioDemo1 - begin...\n13:44:56 [DEBUG] [main] c.i.aio.AioDemo1 - do other things...\n13:44:56 [DEBUG] [Thread-5] c.i.aio.AioDemo1 - read completed...2\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 61 0d                                           |a.              |\n+--------+-------------------------------------------------+----------------+\n\nå¯ä»¥çœ‹åˆ°\n\nå“åº”æ–‡ä»¶è¯»å–æˆåŠŸçš„æ˜¯å¦ä¸€ä¸ªçº¿ç¨‹ Thread-5\nä¸»çº¿ç¨‹å¹¶æ²¡æœ‰ IO æ“ä½œé˜»å¡\n\nå®ˆæŠ¤çº¿ç¨‹é»˜è®¤æ–‡ä»¶ AIO ä½¿ç”¨çš„çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œæ‰€ä»¥æœ€åè¦æ‰§è¡Œ System.in.read() ä»¥é¿å…å®ˆæŠ¤çº¿ç¨‹æ„å¤–ç»“æŸ\nç½‘ç»œ AIOpublic class AioServer &#123;\n    public static void main(String[] args) throws IOException &#123;\n        AsynchronousServerSocketChannel ssc = AsynchronousServerSocketChannel.open();\n        ssc.bind(new InetSocketAddress(8080));\n        ssc.accept(null, new AcceptHandler(ssc));\n        System.in.read();\n    &#125;\n\n    private static void closeChannel(AsynchronousSocketChannel sc) &#123;\n        try &#123;\n            System.out.printf(\"[%s] %s close\\n\", Thread.currentThread().getName(), sc.getRemoteAddress());\n            sc.close();\n        &#125; catch (IOException e) &#123;\n            e.printStackTrace();\n        &#125;\n    &#125;\n\n    private static class ReadHandler implements CompletionHandler&lt;Integer, ByteBuffer> &#123;\n        private final AsynchronousSocketChannel sc;\n\n        public ReadHandler(AsynchronousSocketChannel sc) &#123;\n            this.sc = sc;\n        &#125;\n\n        @Override\n        public void completed(Integer result, ByteBuffer attachment) &#123;\n            try &#123;\n                if (result == -1) &#123;\n                    closeChannel(sc);\n                    return;\n                &#125;\n                System.out.printf(\"[%s] %s read\\n\", Thread.currentThread().getName(), sc.getRemoteAddress());\n                attachment.flip();\n                System.out.println(Charset.defaultCharset().decode(attachment));\n                attachment.clear();\n                // å¤„ç†å®Œç¬¬ä¸€ä¸ª read æ—¶ï¼Œéœ€è¦å†æ¬¡è°ƒç”¨ read æ–¹æ³•æ¥å¤„ç†ä¸‹ä¸€ä¸ª read äº‹ä»¶\n                sc.read(attachment, attachment, this);\n            &#125; catch (IOException e) &#123;\n                e.printStackTrace();\n            &#125;\n        &#125;\n\n        @Override\n        public void failed(Throwable exc, ByteBuffer attachment) &#123;\n            closeChannel(sc);\n            exc.printStackTrace();\n        &#125;\n    &#125;\n\n    private static class WriteHandler implements CompletionHandler&lt;Integer, ByteBuffer> &#123;\n        private final AsynchronousSocketChannel sc;\n\n        private WriteHandler(AsynchronousSocketChannel sc) &#123;\n            this.sc = sc;\n        &#125;\n\n        @Override\n        public void completed(Integer result, ByteBuffer attachment) &#123;\n            // å¦‚æœä½œä¸ºé™„ä»¶çš„ buffer è¿˜æœ‰å†…å®¹ï¼Œéœ€è¦å†æ¬¡ write å†™å‡ºå‰©ä½™å†…å®¹\n            if (attachment.hasRemaining()) &#123;\n                sc.write(attachment);\n            &#125;\n        &#125;\n\n        @Override\n        public void failed(Throwable exc, ByteBuffer attachment) &#123;\n            exc.printStackTrace();\n            closeChannel(sc);\n        &#125;\n    &#125;\n\n    private static class AcceptHandler implements CompletionHandler&lt;AsynchronousSocketChannel, Object> &#123;\n        private final AsynchronousServerSocketChannel ssc;\n\n        public AcceptHandler(AsynchronousServerSocketChannel ssc) &#123;\n            this.ssc = ssc;\n        &#125;\n\n        @Override\n        public void completed(AsynchronousSocketChannel sc, Object attachment) &#123;\n            try &#123;\n                System.out.printf(\"[%s] %s connected\\n\", Thread.currentThread().getName(), sc.getRemoteAddress());\n            &#125; catch (IOException e) &#123;\n                e.printStackTrace();\n            &#125;\n            ByteBuffer buffer = ByteBuffer.allocate(16);\n            // è¯»äº‹ä»¶ç”± ReadHandler å¤„ç†\n            sc.read(buffer, buffer, new ReadHandler(sc));\n            // å†™äº‹ä»¶ç”± WriteHandler å¤„ç†\n            sc.write(Charset.defaultCharset().encode(\"server hello!\"), ByteBuffer.allocate(16), new WriteHandler(sc));\n            // å¤„ç†å®Œç¬¬ä¸€ä¸ª accpet æ—¶ï¼Œéœ€è¦å†æ¬¡è°ƒç”¨ accept æ–¹æ³•æ¥å¤„ç†ä¸‹ä¸€ä¸ª accept äº‹ä»¶\n            ssc.accept(null, this);\n        &#125;\n\n        @Override\n        public void failed(Throwable exc, Object attachment) &#123;\n            exc.printStackTrace();\n        &#125;\n    &#125;\n&#125;\n\n\n\n","slug":"NIO","date":"2023-05-25T02:38:47.000Z","categories_index":"","tags_index":"IO","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"a48e6dda0c21e40880cba7e763278b04","title":"Docker","content":"Dockerçš„ç”¨é€”Dockerå¦‚ä½•è§£å†³å¤§å‹é¡¹ç›®ä¾èµ–å…³ç³»å¤æ‚ï¼Œä¸åŒç»„ä»¶ä¾èµ–çš„å…¼å®¹æ€§é—®é¢˜ï¼Ÿ\n\nDockerå…è®¸å¼€å‘ä¸­å°†åº”ç”¨ã€ä¾èµ–ã€å‡½æ•°åº“ã€é…ç½®ä¸€èµ·æ‰“åŒ…ï¼Œå½¢æˆå¯ç§»æ¤é•œåƒ\nDockeråº”ç”¨è¿è¡Œåœ¨å®¹å™¨ä¸­ï¼Œä½¿ç”¨æ²™ç®±æœºåˆ¶ï¼Œç›¸äº’éš”ç¦»\n\nDockerå¦‚ä½•è§£å†³å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒæœ‰å·®å¼‚çš„é—®é¢˜ï¼Ÿ\n\nDockeré•œåƒä¸­åŒ…å«å®Œæ•´è¿è¡Œç¯å¢ƒï¼ŒåŒ…æ‹¬ç³»ç»Ÿå‡½æ•°åº“ï¼Œä»…ä¾èµ–ç³»ç»Ÿçš„Linuxå†…æ ¸ï¼Œå› æ­¤å¯ä»¥åœ¨ä»»æ„Linuxæ“ä½œç³»ç»Ÿä¸Šè¿è¡Œ\n\nDockeræ˜¯ä¸€ä¸ªå¿«é€Ÿäº¤ä»˜åº”ç”¨ã€è¿è¡Œåº”ç”¨çš„æŠ€æœ¯ï¼Œå…·å¤‡ä¸‹åˆ—ä¼˜åŠ¿ï¼š\n\nå¯ä»¥å°†ç¨‹åºåŠå…¶ä¾èµ–ã€è¿è¡Œç¯å¢ƒä¸€èµ·æ‰“åŒ…ä¸ºä¸€ä¸ªé•œåƒï¼Œå¯ä»¥è¿ç§»åˆ°ä»»æ„Linuxæ“ä½œç³»ç»Ÿ\nè¿è¡Œæ—¶åˆ©ç”¨æ²™ç®±æœºåˆ¶å½¢æˆéš”ç¦»å®¹å™¨ï¼Œå„ä¸ªåº”ç”¨äº’ä¸å¹²æ‰°\nå¯åŠ¨ã€ç§»é™¤éƒ½å¯ä»¥é€šè¿‡ä¸€è¡Œå‘½ä»¤å®Œæˆï¼Œæ–¹ä¾¿å¿«æ·\n\nDockerå’Œè™šæ‹Ÿæœºçš„åŒºåˆ«Dockerå¯ä»¥è®©ä¸€ä¸ªåº”ç”¨åœ¨ä»»ä½•æ“ä½œç³»ç»Ÿä¸­éå¸¸æ–¹ä¾¿çš„è¿è¡Œã€‚è€Œä»¥å‰æˆ‘ä»¬æ¥è§¦çš„è™šæ‹Ÿæœºï¼Œä¹Ÿèƒ½åœ¨ä¸€ä¸ªæ“ä½œç³»ç»Ÿä¸­ï¼Œè¿è¡Œå¦å¤–ä¸€ä¸ªæ“ä½œç³»ç»Ÿï¼Œä¿æŠ¤ç³»ç»Ÿä¸­çš„ä»»ä½•åº”ç”¨ã€‚\nè™šæ‹Ÿæœºï¼ˆvirtual machineï¼‰æ˜¯åœ¨æ“ä½œç³»ç»Ÿä¸­æ¨¡æ‹Ÿç¡¬ä»¶è®¾å¤‡ï¼Œç„¶åè¿è¡Œå¦ä¸€ä¸ªæ“ä½œç³»ç»Ÿï¼Œæ¯”å¦‚åœ¨ Windows ç³»ç»Ÿé‡Œé¢è¿è¡Œ Ubuntu ç³»ç»Ÿï¼Œè¿™æ ·å°±å¯ä»¥è¿è¡Œä»»æ„çš„Ubuntuåº”ç”¨äº†ã€‚\nDockerä»…ä»…æ˜¯å°è£…å‡½æ•°åº“ï¼Œå¹¶æ²¡æœ‰æ¨¡æ‹Ÿå®Œæ•´çš„æ“ä½œç³»ç»Ÿã€‚\nå¯¹æ¯”ï¼š\n\n\n\nç‰¹æ€§\nDocker\nè™šæ‹Ÿæœº\n\n\n\næ€§èƒ½\næ¥è¿‘åŸç”Ÿ\næ€§èƒ½è¾ƒå·®\n\n\nç£ç›˜å ç”¨\nä¸€èˆ¬ä¸ºMB\nä¸€èˆ¬ä¸ºGB\n\n\nå¯åŠ¨\nç§’çº§\nåˆ†é’Ÿçº§\n\n\nDockerå’Œè™šæ‹Ÿæœºçš„å·®å¼‚ï¼š\n\ndockeræ˜¯ä¸€ä¸ªç³»ç»Ÿè¿›ç¨‹ï¼›è™šæ‹Ÿæœºæ˜¯åœ¨æ“ä½œç³»ç»Ÿä¸­çš„æ“ä½œç³»ç»Ÿ\n\ndockerä½“ç§¯å°ã€å¯åŠ¨é€Ÿåº¦å¿«ã€æ€§èƒ½å¥½ï¼›è™šæ‹Ÿæœºä½“ç§¯å¤§ã€å¯åŠ¨é€Ÿåº¦æ…¢ã€æ€§èƒ½ä¸€èˆ¬\n\n\nDockeræ¶æ„é•œåƒå’Œå®¹å™¨Dockerä¸­æœ‰å‡ ä¸ªé‡è¦çš„æ¦‚å¿µï¼š\né•œåƒï¼ˆImageï¼‰ï¼šDockerå°†åº”ç”¨ç¨‹åºåŠå…¶æ‰€éœ€çš„ä¾èµ–ã€å‡½æ•°åº“ã€ç¯å¢ƒã€é…ç½®ç­‰æ–‡ä»¶æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œç§°ä¸ºé•œåƒã€‚\nå®¹å™¨ï¼ˆContainerï¼‰ï¼šé•œåƒä¸­çš„åº”ç”¨ç¨‹åºè¿è¡Œåå½¢æˆçš„è¿›ç¨‹å°±æ˜¯å®¹å™¨ï¼Œåªæ˜¯Dockerä¼šç»™å®¹å™¨è¿›ç¨‹åšéš”ç¦»ï¼Œå¯¹å¤–ä¸å¯è§ã€‚\nä¸€åˆ‡åº”ç”¨æœ€ç»ˆéƒ½æ˜¯ä»£ç ç»„æˆï¼Œéƒ½æ˜¯ç¡¬ç›˜ä¸­çš„ä¸€ä¸ªä¸ªçš„å­—èŠ‚å½¢æˆçš„æ–‡ä»¶ã€‚åªæœ‰è¿è¡Œæ—¶ï¼Œæ‰ä¼šåŠ è½½åˆ°å†…å­˜ï¼Œå½¢æˆè¿›ç¨‹ã€‚\né•œåƒï¼Œå°±æ˜¯æŠŠä¸€ä¸ªåº”ç”¨åœ¨ç¡¬ç›˜ä¸Šçš„æ–‡ä»¶ã€åŠå…¶è¿è¡Œç¯å¢ƒã€éƒ¨åˆ†ç³»ç»Ÿå‡½æ•°åº“æ–‡ä»¶ä¸€èµ·æ‰“åŒ…å½¢æˆçš„æ–‡ä»¶åŒ…ã€‚è¿™ä¸ªæ–‡ä»¶åŒ…æ˜¯åªè¯»çš„ã€‚\nå®¹å™¨ï¼Œå°±æ˜¯å°†è¿™äº›æ–‡ä»¶ä¸­ç¼–å†™çš„ç¨‹åºã€å‡½æ•°åŠ è½½åˆ°å†…å­˜ä¸­å…è®¸ï¼Œå½¢æˆè¿›ç¨‹ï¼Œåªä¸è¿‡è¦éš”ç¦»èµ·æ¥ã€‚å› æ­¤ä¸€ä¸ªé•œåƒå¯ä»¥å¯åŠ¨å¤šæ¬¡ï¼Œå½¢æˆå¤šä¸ªå®¹å™¨è¿›ç¨‹ã€‚\nDockerHubå¼€æºåº”ç”¨ç¨‹åºéå¸¸å¤šï¼Œæ‰“åŒ…è¿™äº›åº”ç”¨å¾€å¾€æ˜¯é‡å¤çš„åŠ³åŠ¨ã€‚ä¸ºäº†é¿å…è¿™äº›é‡å¤åŠ³åŠ¨ï¼Œäººä»¬å°±ä¼šå°†è‡ªå·±æ‰“åŒ…çš„åº”ç”¨é•œåƒï¼Œä¾‹å¦‚Redisã€MySQLé•œåƒæ”¾åˆ°ç½‘ç»œä¸Šï¼Œå…±äº«ä½¿ç”¨ï¼Œå°±åƒGitHubçš„ä»£ç å…±äº«ä¸€æ ·ã€‚\n\nDockerHubï¼šDockerHubæ˜¯ä¸€ä¸ªå®˜æ–¹çš„Dockeré•œåƒçš„æ‰˜ç®¡å¹³å°ã€‚è¿™æ ·çš„å¹³å°ç§°ä¸ºDocker Registryã€‚\n\nå›½å†…ä¹Ÿæœ‰ç±»ä¼¼äºDockerHub çš„å…¬å¼€æœåŠ¡ï¼Œæ¯”å¦‚ ç½‘æ˜“äº‘é•œåƒæœåŠ¡ã€é˜¿é‡Œäº‘é•œåƒåº“ç­‰ã€‚\n\n\nDockeræ¶æ„Dockeræ˜¯ä¸€ä¸ªCSæ¶æ„çš„ç¨‹åºï¼Œç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š\n\næœåŠ¡ç«¯(server)ï¼šDockerå®ˆæŠ¤è¿›ç¨‹ï¼Œè´Ÿè´£å¤„ç†DockeræŒ‡ä»¤ï¼Œç®¡ç†é•œåƒã€å®¹å™¨ç­‰\n\nå®¢æˆ·ç«¯(client)ï¼šé€šè¿‡å‘½ä»¤æˆ–RestAPIå‘DockeræœåŠ¡ç«¯å‘é€æŒ‡ä»¤ã€‚å¯ä»¥åœ¨æœ¬åœ°æˆ–è¿œç¨‹å‘æœåŠ¡ç«¯å‘é€æŒ‡ä»¤ã€‚\n\n\n\nå®‰è£…Dockerå¸è½½yum remove docker \\\n                  docker-client \\\n                  docker-client-latest \\\n                  docker-common \\\n                  docker-latest \\\n                  docker-latest-logrotate \\\n                  docker-logrotate \\\n                  docker-selinux \\\n                  docker-engine-selinux \\\n                  docker-engine \\\n                  docker-ce\n\nå®‰è£…dockerå®‰è£…yumå·¥å…·\nyum install -y yum-utils \\\n           device-mapper-persistent-data \\\n           lvm2 --skip-broken\n\nç„¶åæ›´æ–°æœ¬åœ°é•œåƒæºï¼š\nyum-config-manager \\\n    --add-repo \\\n    https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\n    \nsed -i 's/download.docker.com/mirrors.aliyun.com\\/docker-ce/g' /etc/yum.repos.d/docker-ce.repo\n\nyum makecache fast\n\nç„¶åè¾“å…¥å‘½ä»¤ï¼š\nyum install -y docker-ce\n\ndockerå¯åŠ¨ç›¸å…³å‘½ä»¤# å…³é—­\nsystemctl stop firewalld\n# ç¦æ­¢å¼€æœºå¯åŠ¨é˜²ç«å¢™\nsystemctl disable firewalld\n\nsystemctl start docker  # å¯åŠ¨dockeræœåŠ¡\n\nsystemctl stop docker  # åœæ­¢dockeræœåŠ¡\n\nsystemctl restart docker  # é‡å¯dockeræœåŠ¡\n\ndocker -v\t\t\t#æŸ¥çœ‹dockerç‰ˆæœ¬\n\nCentOS7å®‰è£…DockerComposeä¸‹è½½Linuxä¸‹éœ€è¦é€šè¿‡å‘½ä»¤ä¸‹è½½ï¼š\n# å®‰è£…\ncurl -L https://github.com/docker/compose/releases/download/1.23.1/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose\n\nä¿®æ”¹æ–‡ä»¶æƒé™# ä¿®æ”¹æƒé™\nchmod +x /usr/local/bin/docker-compose\n\nBaseè‡ªåŠ¨è¡¥å…¨å‘½ä»¤# è¡¥å…¨å‘½ä»¤\ncurl -L https://raw.githubusercontent.com/docker/compose/1.29.1/contrib/completion/bash/docker-compose > /etc/bash_completion.d/docker-compose\n\nå¦‚æœè¿™é‡Œå‡ºç°é”™è¯¯ï¼Œéœ€è¦ä¿®æ”¹è‡ªå·±çš„hostsæ–‡ä»¶ï¼š\necho \"199.232.68.133 raw.githubusercontent.com\" >> /etc/hosts\n\nDockerçš„åŸºæœ¬æ“ä½œé•œåƒæ“ä½œé•œåƒåç§°\né•œåƒçš„åç§°ç»„æˆï¼š\n\né•œåç§°ä¸€èˆ¬åˆ†ä¸¤éƒ¨åˆ†ç»„æˆï¼š[repository]:[tag]ã€‚\nåœ¨æ²¡æœ‰æŒ‡å®štagæ—¶ï¼Œé»˜è®¤æ˜¯latestï¼Œä»£è¡¨æœ€æ–°ç‰ˆæœ¬çš„é•œåƒ\n\nmysql:5.7\tä¸­mysqlå°±æ˜¯repositoryï¼Œ5.7å°±æ˜¯tagï¼Œåˆä¸€èµ·å°±æ˜¯é•œåƒåç§°ï¼Œä»£è¡¨5.7ç‰ˆæœ¬çš„MySQLé•œåƒã€‚\né•œåƒå‘½ä»¤\néœ€æ±‚ï¼šä»DockerHubä¸­æ‹‰å–ä¸€ä¸ªnginxé•œåƒå¹¶æŸ¥çœ‹\n\né¦–å…ˆå»é•œåƒä»“åº“æœç´¢nginxé•œåƒï¼Œæ¯”å¦‚DockerHub:\n\næ ¹æ®æŸ¥çœ‹åˆ°çš„é•œåƒåç§°ï¼Œæ‹‰å–è‡ªå·±éœ€è¦çš„é•œåƒï¼Œé€šè¿‡å‘½ä»¤ï¼šdocker pull nginx\n\né€šè¿‡å‘½ä»¤ï¼šdocker images æŸ¥çœ‹æ‹‰å–åˆ°çš„é•œåƒ\n\n\néœ€æ±‚ï¼šåˆ©ç”¨docker saveå°†nginxé•œåƒå¯¼å‡ºç£ç›˜ï¼Œç„¶åå†é€šè¿‡loadåŠ è½½å›æ¥\n\nåˆ©ç”¨docker xx --helpå‘½ä»¤æŸ¥çœ‹docker saveå’Œdocker loadçš„è¯­æ³•ï¼›å¦‚docker save --help\n\nâ€‹\tå‘½ä»¤æ ¼å¼ï¼š\ndocker save -o [ä¿å­˜çš„ç›®æ ‡æ–‡ä»¶åç§°] [é•œåƒåç§°]\n\n\nä½¿ç”¨docker saveå¯¼å‡ºé•œåƒåˆ°ç£ç›˜\n\ndocker save -o nginx.tar nginx:latest\n\n\nä½¿ç”¨docker loadåŠ è½½é•œåƒ\n\nâ€‹\t\tå…ˆåˆ é™¤æœ¬åœ°çš„nginxé•œåƒï¼šdocker rmi nginx:latest\nâ€‹\t\tç„¶åè¿è¡Œå‘½ä»¤ï¼ŒåŠ è½½æœ¬åœ°æ–‡ä»¶ï¼šdocker load -i nginx.tar\nå®¹å™¨æ“ä½œå®¹å™¨ç›¸å…³å‘½ä»¤å®¹å™¨æ“ä½œçš„å‘½ä»¤å¦‚å›¾ï¼š\n\nå®¹å™¨ä¿æŠ¤ä¸‰ä¸ªçŠ¶æ€ï¼š\n\nè¿è¡Œï¼šè¿›ç¨‹æ­£å¸¸è¿è¡Œ\næš‚åœï¼šè¿›ç¨‹æš‚åœï¼ŒCPUä¸å†è¿è¡Œï¼Œå¹¶ä¸é‡Šæ”¾å†…å­˜\nåœæ­¢ï¼šè¿›ç¨‹ç»ˆæ­¢ï¼Œå›æ”¶è¿›ç¨‹å ç”¨çš„å†…å­˜ã€CPUç­‰èµ„æº\n\nå®¹å™¨æ“ä½œçš„å¸¸ç”¨å‘½ä»¤\n\ndocker runï¼šåˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ªå®¹å™¨ï¼Œå¤„äºè¿è¡ŒçŠ¶æ€\n\ndocker pauseï¼šè®©ä¸€ä¸ªè¿è¡Œçš„å®¹å™¨æš‚åœ\n\ndocker unpauseï¼šè®©ä¸€ä¸ªå®¹å™¨ä»æš‚åœçŠ¶æ€æ¢å¤è¿è¡Œ\n\ndocker stopï¼šåœæ­¢ä¸€ä¸ªè¿è¡Œçš„å®¹å™¨\n\ndocker startï¼šè®©ä¸€ä¸ªåœæ­¢çš„å®¹å™¨å†æ¬¡è¿è¡Œ\n\ndocker rmï¼šåˆ é™¤ä¸€ä¸ªå®¹å™¨\n\n\néœ€æ±‚ï¼šåˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ªå®¹å™¨ï¼›ä¾‹å¦‚nginx\n# åˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ªå®¹å™¨\ndocker run --name containerName -p 80:80 -d nginx\n\nå‘½ä»¤è§£è¯»ï¼š\n\ndocker run ï¼šåˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ªå®¹å™¨\nâ€“name : ç»™å®¹å™¨èµ·ä¸€ä¸ªåå­—\n-p ï¼šå°†å®¿ä¸»æœºç«¯å£ä¸å®¹å™¨ç«¯å£æ˜ å°„ï¼Œå†’å·å·¦ä¾§æ˜¯å®¿ä¸»æœºç«¯å£ï¼Œå³ä¾§æ˜¯å®¹å™¨ç«¯å£\n-dï¼šåå°è¿è¡Œå®¹å™¨\nnginxï¼šé•œåƒåç§°ï¼Œä¾‹å¦‚nginx\n\né»˜è®¤æƒ…å†µä¸‹ï¼Œå®¹å™¨æ˜¯éš”ç¦»ç¯å¢ƒï¼Œæˆ‘ä»¬ç›´æ¥è®¿é—®å®¿ä¸»æœºçš„80ç«¯å£ï¼Œè‚¯å®šè®¿é—®ä¸åˆ°å®¹å™¨ä¸­çš„nginxã€‚ç°åœ¨ï¼Œå°†å®¹å™¨çš„80ä¸å®¿ä¸»æœºçš„80å…³è”èµ·æ¥ï¼Œå½“æˆ‘ä»¬è®¿é—®å®¿ä¸»æœºçš„80ç«¯å£æ—¶ï¼Œå°±ä¼šè¢«æ˜ å°„åˆ°å®¹å™¨çš„80ï¼Œè¿™æ ·å°±èƒ½è®¿é—®åˆ°nginxã€‚\n\néœ€æ±‚ï¼šæ¡ˆä¾‹-è¿›å…¥å®¹å™¨ï¼Œä¿®æ”¹æ–‡ä»¶ï¼›å¦‚ï¼šè¿›å…¥Nginxå®¹å™¨ï¼Œä¿®æ”¹HTMLæ–‡ä»¶å†…å®¹\nè¿›å…¥å®¹å™¨ã€‚è¿›å…¥åˆšåˆšåˆ›å»ºçš„nginxå®¹å™¨çš„å‘½ä»¤ä¸ºï¼š\ndocker exec containerName -it  bash\n\nå‘½ä»¤è§£è¯»ï¼š\n\ndocker exec ï¼šè¿›å…¥å®¹å™¨å†…éƒ¨ï¼Œæ‰§è¡Œä¸€ä¸ªå‘½ä»¤\n\n-it : ç»™å½“å‰è¿›å…¥çš„å®¹å™¨åˆ›å»ºä¸€ä¸ªæ ‡å‡†è¾“å…¥ã€è¾“å‡ºç»ˆç«¯ï¼Œå…è®¸æˆ‘ä»¬ä¸å®¹å™¨äº¤äº’\n\ncontainerName ï¼šè¦è¿›å…¥çš„å®¹å™¨çš„åç§°\n\nbashï¼šè¿›å…¥å®¹å™¨åæ‰§è¡Œçš„å‘½ä»¤ï¼Œbashæ˜¯ä¸€ä¸ªlinuxç»ˆç«¯äº¤äº’å‘½ä»¤\n\n\nè¿›å…¥nginxçš„HTMLæ‰€åœ¨ç›®å½• &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html\nå®¹å™¨å†…éƒ¨ä¼šæ¨¡æ‹Ÿä¸€ä¸ªç‹¬ç«‹çš„Linuxæ–‡ä»¶ç³»ç»Ÿï¼Œçœ‹èµ·æ¥å¦‚åŒä¸€ä¸ªlinuxæœåŠ¡å™¨ä¸€æ ·\n\nnginxçš„ç¯å¢ƒã€é…ç½®ã€è¿è¡Œæ–‡ä»¶å…¨éƒ¨éƒ½åœ¨è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­ï¼ŒåŒ…æ‹¬æˆ‘ä»¬è¦ä¿®æ”¹çš„htmlæ–‡ä»¶ã€‚\næŸ¥çœ‹DockerHubç½‘ç«™ä¸­çš„nginxé¡µé¢ï¼Œå¯ä»¥çŸ¥é“nginxçš„htmlç›®å½•ä½ç½®åœ¨/usr/share/nginx/html\næ•°æ®å·ï¼ˆå®¹å™¨æ•°æ®ç®¡ç†ï¼‰åœ¨ä¹‹å‰çš„nginxæ¡ˆä¾‹ä¸­ï¼Œä¿®æ”¹nginxçš„htmlé¡µé¢æ—¶ï¼Œéœ€è¦è¿›å…¥nginxå†…éƒ¨ã€‚å¹¶ä¸”å› ä¸ºæ²¡æœ‰ç¼–è¾‘å™¨ï¼Œä¿®æ”¹æ–‡ä»¶ä¹Ÿå¾ˆéº»çƒ¦ã€‚è¿™å°±æ˜¯å› ä¸ºå®¹å™¨ä¸æ•°æ®ï¼ˆå®¹å™¨å†…æ–‡ä»¶ï¼‰è€¦åˆå¸¦æ¥çš„åæœã€‚è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¿…é¡»å°†æ•°æ®ä¸å®¹å™¨è§£è€¦ï¼Œè¿™å°±è¦ç”¨åˆ°æ•°æ®å·äº†ã€‚\næ•°æ®å·ï¼ˆvolumeï¼‰æ˜¯ä¸€ä¸ªè™šæ‹Ÿç›®å½•ï¼ŒæŒ‡å‘å®¿ä¸»æœºæ–‡ä»¶ç³»ç»Ÿä¸­çš„æŸä¸ªç›®å½•ã€‚\n\nä¸€æ—¦å®Œæˆæ•°æ®å·æŒ‚è½½ï¼Œå¯¹å®¹å™¨çš„ä¸€åˆ‡æ“ä½œéƒ½ä¼šä½œç”¨åœ¨æ•°æ®å·å¯¹åº”çš„å®¿ä¸»æœºç›®å½•äº†ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬æ“ä½œå®¿ä¸»æœºçš„&#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes&#x2F;htmlç›®å½•ï¼Œå°±ç­‰äºæ“ä½œå®¹å™¨å†…çš„&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;htmlç›®å½•äº†\næ•°æ®é›†æ“ä½œå‘½ä»¤æ•°æ®å·æ“ä½œçš„åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼šdocker volume [COMMAND]\ndocker volumeå‘½ä»¤æ˜¯æ•°æ®å·æ“ä½œï¼Œæ ¹æ®å‘½ä»¤åè·Ÿéšçš„commandæ¥ç¡®å®šä¸‹ä¸€æ­¥çš„æ“ä½œï¼š\n\ncreate åˆ›å»ºä¸€ä¸ªvolume\ninspect æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªvolumeçš„ä¿¡æ¯,åŒ…æ‹¬å…³è”çš„å®¿ä¸»æœºç›®å½•ä½ç½®\nls åˆ—å‡ºæ‰€æœ‰çš„volume\nprune åˆ é™¤æœªä½¿ç”¨çš„volume\nrm åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‡å®šçš„volume\n\nåˆ›å»ºå’ŒæŸ¥çœ‹æ•°æ®å·éœ€æ±‚ï¼šåˆ›å»ºä¸€ä¸ªæ•°æ®å·ï¼Œå¹¶æŸ¥çœ‹æ•°æ®å·åœ¨å®¿ä¸»æœºçš„ç›®å½•ä½ç½®\nåˆ›å»ºæ•°æ®å·\ndocker volume create html\n\næŸ¥çœ‹æ‰€æœ‰æ•°æ®\ndocker volume ls\n\n æŸ¥çœ‹æ•°æ®å·è¯¦ç»†ä¿¡æ¯å·\ndocker volume inspect html\n\nå¯ä»¥çœ‹åˆ°htmlè¿™ä¸ªæ•°æ®å·å…³è”çš„å®¿ä¸»æœºç›®å½•\næŒ‚è½½æ•°æ®å·å¯ä»¥é€šè¿‡ -v å‚æ•°æ¥æŒ‚è½½ä¸€ä¸ªæ•°æ®å·åˆ°æŸä¸ªå®¹å™¨å†…ç›®å½•ï¼Œå‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š\ndocker run \\\n  --name mn \\\n  -v html:/root/html \\\n  -p 8080:80\n  nginx \\\n\n-v html:/root/htm ï¼šæŠŠhtmlæ•°æ®å·æŒ‚è½½åˆ°å®¹å™¨å†…çš„&#x2F;root&#x2F;htmlè¿™ä¸ªç›®å½•ä¸­\nDockerfileè‡ªå®šä¹‰é•œåƒå¸¸è§çš„é•œåƒåœ¨DockerHubå°±èƒ½æ‰¾åˆ°ï¼Œä½†æ˜¯æˆ‘ä»¬è‡ªå·±å†™çš„é¡¹ç›®å°±å¿…é¡»è‡ªå·±æ„å»ºé•œåƒäº†ã€‚\nDockerfileè¯­æ³•","slug":"Docker","date":"2023-05-24T11:24:04.000Z","categories_index":"","tags_index":"Docker","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"f515c75be93536d047fb1ea7dd55160d","title":"SQLä¼˜åŒ–","content":"SQLä¼˜åŒ–æ’å…¥æ•°æ®insert\nå¦‚æœæˆ‘ä»¬éœ€è¦ä¸€æ¬¡æ€§å¾€æ•°æ®åº“è¡¨ä¸­æ’å…¥å¤šæ¡è®°å½•ï¼Œå¯ä»¥ä»ä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢è¿›è¡Œä¼˜åŒ–ã€‚\n ä¼˜åŒ–æ–¹æ¡ˆä¸€\t\tæ‰¹é‡æ’å…¥æ•°æ®\nInsert into tb_test values(1,&#39;Tom&#39;),(2,&#39;Cat&#39;),(3,&#39;Jerry&#39;); \n\n ä¼˜åŒ–æ–¹æ¡ˆäºŒ\t\tæ‰‹åŠ¨æ§åˆ¶äº‹åŠ¡\nstart transaction;\ninsert into tb_test values(1,&#39;Tom&#39;),(2,&#39;Cat&#39;),(3,&#39;Jerry&#39;);\ninsert into tb_test values(4,&#39;Tom&#39;),(5,&#39;Cat&#39;),(6,&#39;Jerry&#39;);\ninsert into tb_test values(7,&#39;Tom&#39;),(8,&#39;Cat&#39;),(9,&#39;Jerry&#39;);\ncommit;\n\nä¼˜åŒ–æ–¹æ¡ˆä¸‰\t\tä¸»é”®é¡ºåºæ’å…¥ï¼Œæ€§èƒ½è¦é«˜äºä¹±åºæ’å…¥ã€‚\nä¸»é”®ä¹±åºæ’å…¥ : 8 1 9 21 88 2 4 15 89 5 7 3\nä¸»é”®é¡ºåºæ’å…¥ : 1 2 3 4 5 7 8 9 15 21 88 89\n\nå¤§æ‰¹é‡æ’å…¥æ•°æ®\nå¦‚æœä¸€æ¬¡æ€§éœ€è¦æ’å…¥å¤§æ‰¹é‡æ•°æ®(æ¯”å¦‚: å‡ ç™¾ä¸‡çš„è®°å½•)ï¼Œä½¿ç”¨insertè¯­å¥æ’å…¥æ€§èƒ½è¾ƒä½ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨MySQLæ•°æ®åº“æä¾›çš„loadæŒ‡ä»¤è¿›è¡Œæ’å…¥ã€‚æ“ä½œå¦‚ä¸‹ï¼š\n-- å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯æ—¶ï¼ŒåŠ ä¸Šå‚æ•° -â€“local-infile\nmysql â€“-local-infile -u root -p\n\n-- è®¾ç½®å…¨å±€å‚æ•°local_infileä¸º1ï¼Œå¼€å¯ä»æœ¬åœ°åŠ è½½æ–‡ä»¶å¯¼å…¥æ•°æ®çš„å¼€å…³\nset global local_infile &#x3D; 1;\n\n-- æ‰§è¡ŒloadæŒ‡ä»¤å°†å‡†å¤‡å¥½çš„æ•°æ®ï¼ŒåŠ è½½åˆ°è¡¨ç»“æ„ä¸­\nload data local infile &#39;&#x2F;root&#x2F;sql1.log&#39; into table tb_user fields\nterminated by &#39;,&#39; lines terminated by &#39;\\n&#39; ;\n\nç¤ºä¾‹æ¼”ç¤º:\nCREATE TABLE &#96;tb_user&#96; (\n&#96;id&#96; INT(11) NOT NULL AUTO_INCREMENT,\n&#96;username&#96; VARCHAR(50) NOT NULL,\n&#96;password&#96; VARCHAR(50) NOT NULL,\n&#96;name&#96; VARCHAR(20) NOT NULL,\n&#96;birthday&#96; DATE DEFAULT NULL,\n&#96;sex&#96; CHAR(1) DEFAULT NULL,\nPRIMARY KEY (&#96;id&#96;),\nUNIQUE KEY &#96;unique_user_username&#96; (&#96;username&#96;)\n) ENGINE&#x3D;INNODB DEFAULT CHARSET&#x3D;utf8 ;\n\nè®¾ç½®å‚æ•°\n-- å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯æ—¶ï¼ŒåŠ ä¸Šå‚æ•° -â€“local-infile\nmysql â€“-local-infile -u root -p\n\n-- è®¾ç½®å…¨å±€å‚æ•°local_infileä¸º1ï¼Œå¼€å¯ä»æœ¬åœ°åŠ è½½æ–‡ä»¶å¯¼å…¥æ•°æ®çš„å¼€å…³\nset global local_infile &#x3D; 1;\n\n loadåŠ è½½æ•°æ®\nload data local infile &#39;&#x2F;root&#x2F;load_user_100w_sort.sql&#39; into table tb_user fields terminated by &#39;,&#39; lines terminated by &#39;\\n&#39; ;\n\nåœ¨loadæ—¶ï¼Œä¸»é”®é¡ºåºæ’å…¥æ€§èƒ½é«˜äºä¹±åºæ’å…¥\nä¸»é”®ä¼˜åŒ–ä¸»é”®é¡ºåºæ’å…¥çš„æ€§èƒ½æ˜¯è¦é«˜äºä¹±åºæ’å…¥çš„å…·ä½“åŸå› \næ•°æ®ç»„ç»‡æ–¹å¼\nåœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œè¡¨æ•°æ®éƒ½æ˜¯æ ¹æ®ä¸»é”®é¡ºåºç»„ç»‡å­˜æ”¾çš„ï¼Œè¿™ç§å­˜å‚¨æ–¹å¼çš„è¡¨ç§°ä¸ºç´¢å¼•ç»„ç»‡è¡¨(index organized table IOT)ã€‚è¡Œæ•°æ®ï¼Œéƒ½æ˜¯å­˜å‚¨åœ¨èšé›†ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¸Šçš„ã€‚è€Œæˆ‘ä»¬ä¹‹å‰ä¹Ÿè®²è§£è¿‡InnoDBçš„é€»è¾‘ç»“æ„å›¾ï¼š\n","slug":"SQLä¼˜åŒ–","date":"2023-05-23T13:48:45.000Z","categories_index":"","tags_index":"MySQL","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"84c6604e94d88eec227a0b74aad54f6e","title":"Spring MVC","content":"Spring MVCWebMvcConfigurerWebMvcConfigureræ˜¯ä¸€ä¸ªSpring MVCçš„é…ç½®æ¥å£ï¼Œå®ƒæä¾›äº†ä¸€äº›æ–¹æ³•æ¥è¿›è¡Œå„ç§é…ç½®ã€‚WebConfigç±»å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨è¿™äº›æ–¹æ³•æ¥é…ç½®åº”ç”¨ç¨‹åºã€‚ä¾‹å¦‚ï¼šaddInterceptors()ï¼šç”¨äºæ·»åŠ æ‹¦æˆªå™¨ã€‚addResourceHandlers()ï¼šç”¨äºé…ç½®é™æ€èµ„æºå¤„ç†å™¨ã€‚configureContentNegotiation()ï¼šç”¨äºé…ç½®å†…å®¹åå•†ç­–ç•¥ã€‚configureDefaultServletHandling()ï¼šç”¨äºé…ç½®é™æ€èµ„æºå¤„ç†ã€‚é€šè¿‡å®ç°è¿™äº›æ–¹æ³•ï¼Œå¯ä»¥ç»†ç²’åº¦åœ°æ§åˆ¶Spring MVCæ¡†æ¶çš„è¡Œä¸ºã€‚WebConfigç±»å¯ä»¥è¢«è§†ä¸ºæ˜¯ä¸€ä¸ªæ›¿ä»£Spring MVCæ¡†æ¶é»˜è®¤é…ç½®çš„ç±»ï¼Œå®ƒå¯ä»¥æ ¹æ®å¼€å‘è€…çš„éœ€æ±‚æ¥æä¾›ä¸åŒçš„é…ç½®ï¼Œä»è€Œå®ç°ä¸ªæ€§åŒ–çš„åº”ç”¨ç¨‹åºéœ€æ±‚ã€‚\n","slug":"Spring-MVC","date":"2023-05-20T12:40:51.000Z","categories_index":"","tags_index":"Spring,Spring MVC","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"12e6f0c825691db3e38970eadda0c57d","title":"InnoDBå­˜å‚¨å¼•æ“_MVCCåŸç†","content":"InnoDBå¼•æ“é€»è¾‘å­˜å‚¨ç»“æ„InnoDBçš„é€»è¾‘å­˜å‚¨ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤º:\n\n è¡¨ç©ºé—´\nè¡¨ç©ºé—´æ˜¯InnoDBå­˜å‚¨å¼•æ“é€»è¾‘ç»“æ„çš„æœ€é«˜å±‚ï¼Œ å¦‚æœç”¨æˆ·å¯ç”¨äº†å‚æ•° innodb_file_per_table(åœ¨8.0ç‰ˆæœ¬ä¸­é»˜è®¤å¼€å¯) ï¼Œåˆ™æ¯å¼ è¡¨éƒ½ä¼šæœ‰ä¸€ä¸ªè¡¨ç©ºé—´ï¼ˆxxx.ibdï¼‰ï¼Œä¸€ä¸ªmysqlå®ä¾‹å¯ä»¥å¯¹åº”å¤šä¸ªè¡¨ç©ºé—´ï¼Œç”¨äºå­˜å‚¨è®°å½•ã€ç´¢å¼•ç­‰æ•°æ®ã€‚\næ®µ\næ®µï¼Œåˆ†ä¸ºæ•°æ®æ®µï¼ˆLeaf node segmentï¼‰ã€ç´¢å¼•æ®µï¼ˆNon-leaf node segmentï¼‰ã€å›æ»šæ®µï¼ˆRollback segmentï¼‰ï¼ŒInnoDBæ˜¯ç´¢å¼•ç»„ç»‡è¡¨ï¼Œæ•°æ®æ®µå°±æ˜¯B+æ ‘çš„å¶å­èŠ‚ç‚¹ï¼Œ ç´¢å¼•æ®µå³ä¸ºB+æ ‘çš„éå¶å­èŠ‚ç‚¹ã€‚æ®µç”¨æ¥ç®¡ç†å¤šä¸ªExtentï¼ˆåŒºï¼‰ã€‚\nåŒº\nåŒºï¼Œè¡¨ç©ºé—´çš„å•å…ƒç»“æ„ï¼Œæ¯ä¸ªåŒºçš„å¤§å°ä¸º1Mã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œ InnoDBå­˜å‚¨å¼•æ“é¡µå¤§å°ä¸º16Kï¼Œ å³ä¸€ä¸ªåŒºä¸­ä¸€å…±æœ‰64ä¸ªè¿ç»­çš„é¡µã€‚\n é¡µ\né¡µï¼Œæ˜¯InnoDB å­˜å‚¨å¼•æ“ç£ç›˜ç®¡ç†çš„æœ€å°å•å…ƒï¼Œæ¯ä¸ªé¡µçš„å¤§å°é»˜è®¤ä¸º 16KBã€‚ä¸ºäº†ä¿è¯é¡µçš„è¿ç»­æ€§ï¼ŒInnoDB å­˜å‚¨å¼•æ“æ¯æ¬¡ä»ç£ç›˜ç”³è¯· 4-5 ä¸ªåŒºã€‚\nè¡Œ\nè¡Œï¼ŒInnoDB å­˜å‚¨å¼•æ“æ•°æ®æ˜¯æŒ‰è¡Œè¿›è¡Œå­˜æ”¾çš„ã€‚\nåœ¨è¡Œä¸­ï¼Œé»˜è®¤æœ‰ä¸¤ä¸ªéšè—å­—æ®µï¼š\nâ€‹\t\tTrx_idï¼šæ¯æ¬¡å¯¹æŸæ¡è®°å½•è¿›è¡Œæ”¹åŠ¨æ—¶ï¼Œéƒ½ä¼šæŠŠå¯¹åº”çš„äº‹åŠ¡idèµ‹å€¼ç»™trx_idéšè—åˆ—ã€‚\nâ€‹\t\tRoll_pointerï¼šæ¯æ¬¡å¯¹æŸæ¡å¼•è®°å½•è¿›è¡Œæ”¹åŠ¨æ—¶ï¼Œéƒ½ä¼šæŠŠæ—§çš„ç‰ˆæœ¬å†™å…¥åˆ°undoæ—¥å¿—ä¸­ï¼Œç„¶åè¿™ä¸ªéšè—åˆ—å°±ç›¸å½“äºä¸€ä¸ªæŒ‡é’ˆï¼Œå¯ä»¥é€šè¿‡å®ƒæ¥æ‰¾åˆ°è¯¥è®°å½•ä¿®æ”¹å‰çš„ä¿¡æ¯ã€‚\næ¶æ„MySQL5.5 ç‰ˆæœ¬å¼€å§‹ï¼Œé»˜è®¤ä½¿ç”¨InnoDBå­˜å‚¨å¼•æ“ï¼Œå®ƒæ“…é•¿äº‹åŠ¡å¤„ç†ï¼Œå…·æœ‰å´©æºƒæ¢å¤ç‰¹æ€§ï¼Œåœ¨æ—¥å¸¸å¼€å‘ä¸­ä½¿ç”¨éå¸¸å¹¿æ³›ã€‚ä¸‹é¢æ˜¯InnoDBæ¶æ„å›¾ï¼Œå·¦ä¾§ä¸ºå†…å­˜ç»“æ„ï¼Œå³ä¾§ä¸ºç£ç›˜ç»“æ„ã€‚\n\nå†…å­˜ç»“æ„\nä¸»è¦åˆ†ä¸ºè¿™ä¹ˆå››å¤§å—å„¿ï¼š Buffer Poolã€Change Bufferã€Adaptive Hash Indexã€Log Bufferã€‚ \n Buffer Pool\nInnoDBå­˜å‚¨å¼•æ“åŸºäºç£ç›˜æ–‡ä»¶å­˜å‚¨ï¼Œè®¿é—®ç‰©ç†ç¡¬ç›˜å’Œåœ¨å†…å­˜ä¸­è¿›è¡Œè®¿é—®ï¼Œé€Ÿåº¦ç›¸å·®å¾ˆå¤§ï¼Œä¸ºäº†å°½å¯èƒ½å¼¥è¡¥è¿™ä¸¤è€…ä¹‹é—´çš„I&#x2F;Oæ•ˆç‡çš„å·®å€¼ï¼Œå°±éœ€è¦æŠŠç»å¸¸ä½¿ç”¨çš„æ•°æ®åŠ è½½åˆ°ç¼“å†²æ± ä¸­ï¼Œé¿å…æ¯æ¬¡è®¿é—®éƒ½è¿›è¡Œç£ç›˜I&#x2F;O\nåœ¨InnoDBçš„ç¼“å†²æ± ä¸­ä¸ä»…ç¼“å­˜äº†ç´¢å¼•é¡µå’Œæ•°æ®é¡µï¼Œè¿˜åŒ…å«äº†undoé¡µã€æ’å…¥ç¼“å­˜ã€è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•ä»¥åŠInnoDBçš„é”ä¿¡æ¯ç­‰ç­‰\nç¼“å†²æ±  Buffer Poolï¼Œæ˜¯ä¸»å†…å­˜ä¸­çš„ä¸€ä¸ªåŒºåŸŸï¼Œé‡Œé¢å¯ä»¥ç¼“å­˜ç£ç›˜ä¸Šç»å¸¸æ“ä½œçš„çœŸå®æ•°æ®ï¼Œåœ¨æ‰§è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œæ—¶ï¼Œå…ˆæ“ä½œç¼“å†²æ± ä¸­çš„æ•°æ®ï¼ˆè‹¥ç¼“å†²æ± æ²¡æœ‰æ•°æ®ï¼Œåˆ™ä»ç£ç›˜åŠ è½½å¹¶ç¼“å­˜ï¼‰ï¼Œç„¶åå†ä»¥ä¸€å®šé¢‘ç‡åˆ·æ–°åˆ°ç£ç›˜ï¼Œä»è€Œå‡å°‘ç£ç›˜IOï¼ŒåŠ å¿«å¤„ç†é€Ÿåº¦ã€‚\nç¼“å†²æ± ä»¥Pageé¡µä¸ºå•ä½ï¼Œåº•å±‚é‡‡ç”¨é“¾è¡¨æ•°æ®ç»“æ„ç®¡ç†Pageã€‚æ ¹æ®çŠ¶æ€ï¼Œå°†Pageåˆ†ä¸ºä¸‰ç§ç±»å‹ï¼š\nâ€‹\tfree pageï¼šç©ºé—²pageï¼Œæœªè¢«ä½¿ç”¨ã€‚\nâ€‹\tclean pageï¼šè¢«ä½¿ç”¨pageï¼Œæ•°æ®æ²¡æœ‰è¢«ä¿®æ”¹è¿‡ã€‚\nâ€‹\tdirty pageï¼šè„é¡µï¼Œè¢«ä½¿ç”¨pageï¼Œæ•°æ®è¢«ä¿®æ”¹è¿‡ï¼Œé¡µä¸­æ•°æ®ä¸ç£ç›˜çš„æ•°æ®äº§ç”Ÿäº†ä¸ä¸€è‡´ã€‚\nåœ¨ä¸“ç”¨æœåŠ¡å™¨ä¸Šï¼Œé€šå¸¸å°†å¤šè¾¾80ï¼…çš„ç‰©ç†å†…å­˜åˆ†é…ç»™ç¼“å†²æ±  ã€‚å‚æ•°è®¾ç½®ï¼šshow variables like  &#39;innodb_buffer_pool_size&#39;;\nChange Buffer\nChange Bufferï¼Œæ›´æ”¹ç¼“å†²åŒºï¼ˆé’ˆå¯¹äºéå”¯ä¸€çš„äºŒçº§ç´¢å¼•é¡µï¼‰ï¼Œåœ¨æ‰§è¡ŒDMLè¯­å¥æ—¶ï¼Œå¦‚æœè¿™äº›æ•°æ®Pageæ²¡æœ‰åœ¨Buffer Poolä¸­ï¼Œä¸ä¼šç›´æ¥æ“ä½œç£ç›˜ï¼Œè€Œä¼šå°†æ•°æ®å˜æ›´å­˜åœ¨æ›´æ”¹ç¼“å†²åŒº Change Bufferä¸­ï¼Œåœ¨æœªæ¥æ•°æ®è¢«è¯»å–æ—¶ï¼Œå†å°†æ•°æ®åˆå¹¶æ¢å¤åˆ°Buffer Poolä¸­ï¼Œå†å°†åˆå¹¶åçš„æ•°æ®åˆ·æ–°åˆ°ç£ç›˜ä¸­ã€‚\nChange Bufferçš„æ„ä¹‰æ˜¯ä»€ä¹ˆå‘¢?\nä¸èšé›†ç´¢å¼•ä¸åŒï¼ŒäºŒçº§ç´¢å¼•é€šå¸¸æ˜¯éå”¯ä¸€çš„ï¼Œå¹¶ä¸”ä»¥ç›¸å¯¹éšæœºçš„é¡ºåºæ’å…¥äºŒçº§ç´¢å¼•ã€‚åŒæ ·ï¼Œåˆ é™¤å’Œæ›´æ–°å¯èƒ½ä¼šå½±å“ç´¢å¼•æ ‘ä¸­ä¸ç›¸é‚»çš„äºŒçº§ç´¢å¼•é¡µï¼Œå¦‚æœæ¯ä¸€æ¬¡éƒ½æ“ä½œç£ç›˜ï¼Œä¼šé€ æˆå¤§é‡çš„ç£ç›˜IOã€‚æœ‰äº†ChangeBufferä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¼“å†²æ± ä¸­è¿›è¡Œåˆå¹¶å¤„ç†ï¼Œå‡å°‘ç£ç›˜IOã€‚\n Adaptive Hash Index\nå‚æ•°ï¼š adaptive_hash_index\nè‡ªé€‚åº”hashç´¢å¼•ï¼Œç”¨äºä¼˜åŒ–å¯¹Buffer Poolæ•°æ®çš„æŸ¥è¯¢ã€‚MySQLçš„InnoDBå¼•æ“ä¸­è™½ç„¶æ²¡æœ‰ç›´æ¥æ”¯æŒhashç´¢å¼•ï¼Œä½†æ˜¯ç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªåŠŸèƒ½å°±æ˜¯è¿™ä¸ªè‡ªé€‚åº”hashç´¢å¼•ã€‚å› ä¸ºå‰é¢æˆ‘ä»¬è®²åˆ°è¿‡ï¼Œhashç´¢å¼•åœ¨è¿›è¡Œç­‰å€¼åŒ¹é…æ—¶ï¼Œä¸€èˆ¬æ€§èƒ½æ˜¯è¦é«˜äºB+æ ‘çš„ï¼Œå› ä¸ºhashç´¢å¼•ä¸€èˆ¬åªéœ€è¦ä¸€æ¬¡IOå³å¯ï¼Œè€ŒB+æ ‘ï¼Œå¯èƒ½éœ€è¦å‡ æ¬¡åŒ¹é…ï¼Œæ‰€ä»¥hashç´¢å¼•çš„æ•ˆç‡è¦é«˜ï¼Œä½†æ˜¯hashç´¢å¼•åˆä¸é€‚åˆåšèŒƒå›´æŸ¥è¯¢ã€æ¨¡ç³ŠåŒ¹é…ç­‰ã€‚\nInnoDBå­˜å‚¨å¼•æ“ä¼šç›‘æ§å¯¹è¡¨ä¸Šå„ç´¢å¼•é¡µçš„æŸ¥è¯¢ï¼Œå¦‚æœè§‚å¯Ÿåˆ°åœ¨ç‰¹å®šçš„æ¡ä»¶ä¸‹hashç´¢å¼•å¯ä»¥æå‡é€Ÿåº¦ï¼Œåˆ™å»ºç«‹hashç´¢å¼•ï¼Œç§°ä¹‹ä¸ºè‡ªé€‚åº”hashç´¢å¼•ã€‚è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•ï¼Œæ— éœ€äººå·¥å¹²é¢„ï¼Œæ˜¯ç³»ç»Ÿæ ¹æ®æƒ…å†µè‡ªåŠ¨å®Œæˆã€‚\n Log Buffer\ninnodb_log_buffer_sizeï¼šç¼“å†²åŒºå¤§å°\ninnodb_flush_log_at_trx_commitï¼šæ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜æ—¶æœºï¼Œå–å€¼ä¸»è¦åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªï¼š\nâ€‹\t\t1: æ—¥å¿—åœ¨æ¯æ¬¡äº‹åŠ¡æäº¤æ—¶å†™å…¥å¹¶åˆ·æ–°åˆ°ç£ç›˜ï¼Œé»˜è®¤å€¼ã€‚\nâ€‹\t\t0: æ¯ç§’å°†æ—¥å¿—å†™å…¥å¹¶åˆ·æ–°åˆ°ç£ç›˜ä¸€æ¬¡ã€‚\nâ€‹\t\t2: æ—¥å¿—åœ¨æ¯æ¬¡äº‹åŠ¡æäº¤åå†™å…¥ï¼Œå¹¶æ¯ç§’åˆ·æ–°åˆ°ç£ç›˜ä¸€æ¬¡ã€‚\nLog Bufferï¼šæ—¥å¿—ç¼“å†²åŒºï¼Œç”¨æ¥ä¿å­˜è¦å†™å…¥åˆ°ç£ç›˜ä¸­çš„logæ—¥å¿—æ•°æ®ï¼ˆredo log ã€undo logï¼‰ï¼Œé»˜è®¤å¤§å°ä¸º 16MBï¼Œæ—¥å¿—ç¼“å†²åŒºçš„æ—¥å¿—ä¼šå®šæœŸåˆ·æ–°åˆ°ç£ç›˜ä¸­ã€‚å¦‚æœéœ€è¦æ›´æ–°ã€æ’å…¥æˆ–åˆ é™¤è®¸å¤šè¡Œçš„äº‹åŠ¡ï¼Œå¢åŠ æ—¥å¿—ç¼“å†²åŒºçš„å¤§å°å¯ä»¥èŠ‚çœç£ç›˜ I&#x2F;Oã€‚\nç£ç›˜ç»“æ„InnoDBä½“ç³»ç»“æ„çš„ç£ç›˜ç»“æ„ï¼š\n\n System Tablespace\nå‚æ•°ï¼šinnodb_data_file_path\nç³»ç»Ÿè¡¨ç©ºé—´æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„InnoDBè¡¨ç©ºé—´ï¼Œå®ƒæ˜¯ç”¨æ¥å­˜å‚¨ç³»ç»Ÿè¡¨å’Œç´¢å¼•çš„åœ°æ–¹ã€‚è™½ç„¶ä½ å¯ä»¥åœ¨å…¶ä»–è¡¨ç©ºé—´ä¸­åˆ›å»ºè¡¨ï¼Œåœ¨ç³»ç»Ÿè¡¨ç©ºé—´ä¸­åŒ…å«è¿™äº›è¡¨å’Œç´¢å¼•æ•°æ®ï¼Œå…è®¸InnoDBä½¿ç”¨æ›´å°‘çš„å†…å­˜å’Œç£ç›˜ç©ºé—´ï¼Œå› ä¸ºç³»ç»Ÿè¡¨ç©ºé—´æ˜¯è¢«å½“åšä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶å¤„ç†ã€‚ç³»ç»Ÿè¡¨ç©ºé—´ï¼Œé»˜è®¤çš„æ–‡ä»¶åå« ibdata1ã€‚\nå½“ä½ ä½¿ç”¨InnoDBå¼•æ“æ—¶ï¼Œç³»ç»Ÿè¡¨ç©ºé—´åœ¨å­˜å‚¨InnoDBçš„ç¼“å­˜æ± ä¸­å‘æŒ¥ç€é‡è¦çš„ä½œç”¨ã€‚MySQLä½¿ç”¨ç¼“å­˜æœºåˆ¶æ¥æœ€å°åŒ–å¯¹ç¡¬ç›˜I&#x2F;Oè®¿é—®çš„æ¬¡æ•°ï¼Œæ¥æé«˜InnoDBæ€§èƒ½ã€‚ç³»ç»Ÿè¡¨ç©ºé—´æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼ŒInnoDBä¼šå°†è¯»å–çš„æ•°æ®ç¼“å­˜åˆ°ç³»ç»Ÿè¡¨ç©ºé—´ä¸­ï¼Œå¹¶ä½¿ç”¨ç³»ç»Ÿè¡¨ç©ºé—´å°†å­˜å‚¨çš„æ•°æ®è¿›è¡Œå…±äº«ï¼Œé¿å…äº†ä¸å¿…è¦çš„å‰¯æœ¬ã€‚\nç³»ç»Ÿè¡¨ç©ºé—´æ˜¯é€šè¿‡é…ç½®æ–‡ä»¶å‚æ•°innodb_data_file_pathæ¥å®šä¹‰çš„ã€‚é€šå¸¸ï¼Œç³»ç»Ÿè¡¨ç©ºé—´ä¼šè¢«å®šä¹‰ä¸ºä¸€ä¸ªæ›´æ”¹ç¼“å†²åŒºå’Œä¸€ä¸ªUNDOæ—¥å¿—ç©ºé—´çš„å…±åŒæ–‡ä»¶ã€‚åœ¨MySQL 5.xç‰ˆæœ¬ä¸­ï¼Œç”±äºInnoDBå­˜å‚¨ä¸€äº›ç‰¹æ®Šçš„å…ƒæ•°æ®å’Œäº‹åŠ¡ä¿¡æ¯ï¼Œæ‰€ä»¥ç³»ç»Ÿè¡¨ç©ºé—´è¿˜åŒ…å«äº†InnoDBæ•°æ®å­—å…¸ã€undologç­‰ï¼Œç”¨æ¥æ”¯æŒäº‹åŠ¡å’Œé”ç­‰æœºåˆ¶çš„å®ç°ã€‚\nFile-Per-Table Tablespaces\nå¼€å…³å‚æ•°ï¼šinnodb_file_per_table ï¼Œè¯¥å‚æ•°é»˜è®¤å¼€å¯ã€‚\nå¦‚æœå¼€å¯äº†innodb_file_per_tableå¼€å…³ ï¼Œåˆ™æ¯ä¸ªè¡¨çš„æ–‡ä»¶è¡¨ç©ºé—´åŒ…å«å•ä¸ªInnoDBè¡¨çš„æ•°æ®å’Œç´¢å¼• ï¼Œå¹¶å­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šçš„å•ä¸ªæ•°æ®æ–‡ä»¶ä¸­ã€‚æˆ‘ä»¬æ¯åˆ›å»ºä¸€ä¸ªè¡¨ï¼Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªè¡¨ç©ºé—´æ–‡ä»¶\n General Tablespaces\né€šç”¨è¡¨ç©ºé—´ï¼Œéœ€è¦é€šè¿‡ CREATE TABLESPACE è¯­æ³•åˆ›å»ºé€šç”¨è¡¨ç©ºé—´ï¼Œåœ¨åˆ›å»ºè¡¨æ—¶ï¼Œå¯ä»¥æŒ‡å®šè¯¥è¡¨ç©ºé—´ã€‚\nåˆ›å»ºè¡¨ç©ºé—´\nCREATE TABLESPACE ts_name ADD DATAFILE 'file_name' ENGINE = engine_name;\n-- åˆ›å»ºè¡¨æ—¶æŒ‡å®šè¡¨ç©ºé—´\nCREATE TABLE xxx ... TABLESPACE ts_name;\n\nUndo Tablespaces\næ’¤é”€è¡¨ç©ºé—´ï¼ŒMySQLå®ä¾‹åœ¨åˆå§‹åŒ–æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºä¸¤ä¸ªé»˜è®¤çš„undoè¡¨ç©ºé—´åˆå§‹å¤§å°16Mï¼Œç”¨äºå­˜å‚¨undo logæ—¥å¿—\nTemporary Tablespaces\nInnoDB ä½¿ç”¨ä¼šè¯ä¸´æ—¶è¡¨ç©ºé—´å’Œå…¨å±€ä¸´æ—¶è¡¨ç©ºé—´ã€‚å­˜å‚¨ç”¨æˆ·åˆ›å»ºçš„ä¸´æ—¶è¡¨ç­‰æ•°æ®ã€‚\nDoublewrite Buffer Files\nåŒå†™ç¼“å†²åŒºï¼ŒInnoDBå¼•æ“å°†æ•°æ®é¡µä»Buffer Poolåˆ·æ–°åˆ°ç£ç›˜å‰ï¼Œå…ˆå°†æ•°æ®é¡µå†™å…¥åŒå†™ç¼“å†²åŒºæ–‡ä»¶ä¸­ï¼Œä¾¿äºç³»ç»Ÿå¼‚å¸¸æ—¶æ¢å¤æ•°æ®ã€‚\næ¶‰åŠæ–‡ä»¶ï¼š#ib_16384_0.dblwrã€#ib_16384_1.dblwr\nRedo Log\né‡åšæ—¥å¿—ï¼Œæ˜¯ç”¨æ¥å®ç°äº‹åŠ¡çš„æŒä¹…æ€§ã€‚è¯¥æ—¥å¿—æ–‡ä»¶ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šé‡åšæ—¥å¿—ç¼“å†²ï¼ˆredo log bufferï¼‰ä»¥åŠé‡åšæ—¥å¿—æ–‡ä»¶ï¼ˆredo logï¼‰,å‰è€…æ˜¯åœ¨å†…å­˜ä¸­ï¼Œåè€…åœ¨ç£ç›˜ä¸­ã€‚å½“äº‹åŠ¡æäº¤ä¹‹åä¼šæŠŠæ‰€æœ‰ä¿®æ”¹ä¿¡æ¯éƒ½ä¼šå­˜åˆ°è¯¥æ—¥å¿—ä¸­, ç”¨äºåœ¨åˆ·æ–°è„é¡µåˆ°ç£ç›˜æ—¶,å‘ç”Ÿé”™è¯¯æ—¶, è¿›è¡Œæ•°æ®æ¢å¤ä½¿ç”¨\nä»¥å¾ªç¯æ–¹å¼å†™å…¥é‡åšæ—¥å¿—æ–‡ä»¶ï¼Œæ¶‰åŠä¸¤ä¸ªæ–‡ä»¶ï¼šib_logfile0ã€iblogfile1\nåå°çº¿ç¨‹\nåœ¨InnoDBçš„åå°çº¿ç¨‹ä¸­ï¼Œåˆ†ä¸º4ç±»ï¼š\nMaster Thread ã€IO Threadã€Purge Threadã€Page Cleaner Thread\n Master Thread\næ ¸å¿ƒåå°çº¿ç¨‹ï¼Œè´Ÿè´£è°ƒåº¦å…¶ä»–çº¿ç¨‹ï¼Œè¿˜è´Ÿè´£å°†ç¼“å†²æ± ä¸­çš„æ•°æ®å¼‚æ­¥åˆ·æ–°åˆ°ç£ç›˜ä¸­, ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§ï¼Œè¿˜åŒ…æ‹¬è„é¡µçš„åˆ·æ–°ã€åˆå¹¶æ’å…¥ç¼“å­˜ã€undoé¡µçš„å›æ”¶ ã€‚\n IO Thread\nåœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­å¤§é‡ä½¿ç”¨äº†AIOæ¥å¤„ç†IOè¯·æ±‚, è¿™æ ·å¯ä»¥æå¤§åœ°æé«˜æ•°æ®åº“çš„æ€§èƒ½ï¼Œè€ŒIO Threadä¸»è¦è´Ÿè´£è¿™äº›IOè¯·æ±‚çš„å›è°ƒã€‚\næŸ¥çœ‹åˆ°InnoDBçš„çŠ¶æ€ä¿¡æ¯ï¼Œå…¶ä¸­å°±åŒ…å«IO Threadä¿¡æ¯\nshow engine innodb status \\G;\n\n\n\n\nçº¿ç¨‹ç±»å‹\né»˜è®¤ä¸ªæ•°\nèŒè´£\n\n\n\nRead thread\n4\nè´Ÿè´£è¯»æ“ä½œ\n\n\nWrite thread\n4\nè´Ÿè´£å†™æ“ä½œ\n\n\nLog thread\n1\nè´Ÿè´£å°†æ—¥å¿—ç¼“å†²åŒºåˆ·æ–°åˆ°ç£ç›˜\n\n\nInsert buffer thread\n1\nè´Ÿè´£å°†å†™ç¼“å†²åŒºå†…å®¹åˆ·æ–°åˆ°ç£ç›˜\n\n\n Purge Thread\nä¸»è¦ç”¨äºå›æ”¶äº‹åŠ¡å·²ç»æäº¤äº†çš„undo logï¼Œåœ¨äº‹åŠ¡æäº¤ä¹‹åï¼Œundo logå¯èƒ½ä¸ç”¨äº†ï¼Œå°±ç”¨å®ƒæ¥å›æ”¶ã€‚\nPage Cleaner Thread\nååŠ© Master Thread åˆ·æ–°è„é¡µåˆ°ç£ç›˜çš„çº¿ç¨‹ï¼Œå®ƒå¯ä»¥å‡è½» Master Thread çš„å·¥ä½œå‹åŠ›ï¼Œå‡å°‘é˜»å¡ã€‚\näº‹åŠ¡åŸç†æˆ‘ä»¬ç ”ç©¶äº‹åŠ¡çš„åŸç†ï¼Œå°±æ˜¯ç ”ç©¶MySQLçš„InnoDBå¼•æ“æ˜¯å¦‚ä½•ä¿è¯äº‹åŠ¡çš„è¿™å››å¤§ç‰¹æ€§çš„ã€‚\nè€Œå¯¹äºè¿™å››å¤§ç‰¹æ€§ï¼Œå®é™…ä¸Šåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ã€‚ å…¶ä¸­çš„åŸå­æ€§ã€ä¸€è‡´æ€§ã€æŒä¹…åŒ–ï¼Œå®é™…ä¸Šæ˜¯ç”±InnoDBä¸­çš„ä¸¤ä»½æ—¥å¿—æ¥ä¿è¯çš„ï¼Œä¸€ä»½æ˜¯redo logæ—¥å¿—ï¼Œä¸€ä»½æ˜¯undo logæ—¥å¿—ã€‚ è€Œéš”ç¦»æ€§æ˜¯é€šè¿‡æ•°æ®åº“çš„é”ï¼ŒåŠ ä¸ŠMVCCæ¥ä¿è¯çš„ã€‚\n\nredo log\né‡åšæ—¥å¿—ï¼Œè®°å½•çš„æ˜¯äº‹åŠ¡æäº¤æ—¶æ•°æ®é¡µçš„ç‰©ç†ä¿®æ”¹ï¼Œæ˜¯ç”¨æ¥å®ç°äº‹åŠ¡çš„æŒä¹…æ€§ã€‚\nè¯¥æ—¥å¿—æ–‡ä»¶ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šé‡åšæ—¥å¿—ç¼“å†²ï¼ˆredo log bufferï¼‰ä»¥åŠé‡åšæ—¥å¿—æ–‡ä»¶ï¼ˆredo log fileï¼‰,å‰è€…æ˜¯åœ¨å†…å­˜ä¸­ï¼Œåè€…åœ¨ç£ç›˜ä¸­ã€‚å½“äº‹åŠ¡æäº¤ä¹‹åä¼šæŠŠæ‰€æœ‰ä¿®æ”¹ä¿¡æ¯éƒ½å­˜åˆ°è¯¥æ—¥å¿—æ–‡ä»¶ä¸­, ç”¨äºåœ¨åˆ·æ–°è„é¡µåˆ°ç£ç›˜,å‘ç”Ÿé”™è¯¯æ—¶, è¿›è¡Œæ•°æ®æ¢å¤ä½¿ç”¨ã€‚\nå¦‚æœæ²¡æœ‰redologï¼Œå¯èƒ½ä¼šå­˜åœ¨ä»€ä¹ˆé—®é¢˜çš„ï¼Ÿ\n\nåœ¨InnoDBå¼•æ“ä¸­çš„å†…å­˜ç»“æ„ä¸­ï¼Œä¸»è¦çš„å†…å­˜åŒºåŸŸå°±æ˜¯ç¼“å†²æ± ï¼Œåœ¨ç¼“å†²æ± ä¸­ç¼“å­˜äº†å¾ˆå¤šçš„æ•°æ®é¡µã€‚ å½“æˆ‘ä»¬åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œæ‰§è¡Œå¤šä¸ªå¢åˆ æ”¹çš„æ“ä½œæ—¶ï¼ŒInnoDBå¼•æ“ä¼šå…ˆæ“ä½œç¼“å†²æ± ä¸­çš„æ•°æ®ï¼Œå¦‚æœç¼“å†²åŒºæ²¡æœ‰å¯¹åº”çš„æ•°æ®ï¼Œä¼šé€šè¿‡åå°çº¿ç¨‹å°†ç£ç›˜ä¸­çš„æ•°æ®åŠ è½½å‡ºæ¥ï¼Œå­˜æ”¾åœ¨ç¼“å†²åŒºä¸­ï¼Œç„¶åå°†ç¼“å†²æ± ä¸­çš„æ•°æ®ä¿®æ”¹ï¼Œä¿®æ”¹åçš„æ•°æ®é¡µæˆ‘ä»¬ç§°ä¸ºè„é¡µã€‚ è€Œè„é¡µåˆ™ä¼šåœ¨ä¸€å®šçš„æ—¶æœºï¼Œé€šè¿‡åå°çº¿ç¨‹åˆ·æ–°åˆ°ç£ç›˜ä¸­ï¼Œä»è€Œä¿è¯ç¼“å†²åŒºä¸ç£ç›˜çš„æ•°æ®ä¸€è‡´ã€‚ è€Œç¼“å†²åŒºçš„è„é¡µæ•°æ®å¹¶ä¸æ˜¯å®æ—¶åˆ·æ–°çš„ï¼Œè€Œæ˜¯ä¸€æ®µæ—¶é—´ä¹‹åå°†ç¼“å†²åŒºçš„æ•°æ®åˆ·æ–°åˆ°ç£ç›˜ä¸­ï¼Œå‡å¦‚åˆ·æ–°åˆ°ç£ç›˜çš„è¿‡ç¨‹å‡ºé”™äº†ï¼Œè€Œæç¤ºç»™ç”¨æˆ·äº‹åŠ¡æäº¤æˆåŠŸï¼Œæ•°æ®å´æ²¡æœ‰æŒä¹…åŒ–ä¸‹æ¥ï¼Œè¿™å°±å‡ºç°é—®é¢˜äº†ï¼Œæ²¡æœ‰ä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§ã€‚\nåœ¨InnoDBä¸­æä¾›äº†ä¸€ä»½æ—¥å¿— redo logï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†æ¥çœ‹çœ‹ï¼Œé€šè¿‡redologå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\n\næœ‰äº†redologä¹‹åï¼Œå½“å¯¹ç¼“å†²åŒºçš„æ•°æ®è¿›è¡Œå¢åˆ æ”¹ä¹‹åï¼Œä¼šé¦–å…ˆå°†æ“ä½œçš„æ•°æ®é¡µçš„å˜åŒ–ï¼Œè®°å½•åœ¨redolog bufferä¸­ã€‚åœ¨äº‹åŠ¡æäº¤æ—¶ï¼Œä¼šå°†redo log bufferä¸­çš„æ•°æ®åˆ·æ–°åˆ°redo logç£ç›˜æ–‡ä»¶ä¸­ã€‚è¿‡ä¸€æ®µæ—¶é—´ä¹‹åï¼Œå¦‚æœåˆ·æ–°ç¼“å†²åŒºçš„è„é¡µåˆ°ç£ç›˜æ—¶ï¼Œå‘ç”Ÿé”™è¯¯ï¼Œæ­¤æ—¶å°±å¯ä»¥å€ŸåŠ©äºredo logè¿›è¡Œæ•°æ®æ¢å¤ï¼Œè¿™æ ·å°±ä¿è¯äº†äº‹åŠ¡çš„æŒä¹…æ€§ã€‚ è€Œå¦‚æœè„é¡µæˆåŠŸåˆ·æ–°åˆ°ç£ç›˜ æˆ– æˆ–è€…æ¶‰åŠåˆ°çš„æ•°æ®å·²ç»è½ç›˜ï¼Œæ­¤æ—¶redologå°±æ²¡æœ‰ä½œç”¨äº†ï¼Œå°±å¯ä»¥åˆ é™¤äº†ï¼Œæ‰€ä»¥å­˜åœ¨çš„ä¸¤ä¸ªredo logæ–‡ä»¶æ˜¯å¾ªç¯å†™çš„ã€‚\né‚£ä¸ºä»€ä¹ˆæ¯ä¸€æ¬¡æäº¤äº‹åŠ¡ï¼Œè¦åˆ·æ–°redo log åˆ°ç£ç›˜ä¸­å‘¢ï¼Œè€Œä¸æ˜¯ç›´æ¥å°†buffer poolä¸­çš„è„é¡µåˆ·æ–°åˆ°ç£ç›˜å‘¢ ?\nå› ä¸ºåœ¨ä¸šåŠ¡æ“ä½œä¸­ï¼Œæˆ‘ä»¬æ“ä½œæ•°æ®ä¸€èˆ¬éƒ½æ˜¯éšæœºè¯»å†™ç£ç›˜çš„ï¼Œè€Œä¸æ˜¯é¡ºåºè¯»å†™ç£ç›˜ã€‚ è€Œredo logåœ¨å¾€ç£ç›˜æ–‡ä»¶ä¸­å†™å…¥æ•°æ®ï¼Œç”±äºæ˜¯æ—¥å¿—æ–‡ä»¶ï¼Œæ‰€ä»¥éƒ½æ˜¯é¡ºåºå†™çš„ã€‚é¡ºåºå†™çš„æ•ˆç‡ï¼Œè¦è¿œå¤§äºéšæœºå†™ã€‚ è¿™ç§å…ˆå†™æ—¥å¿—çš„æ–¹å¼ï¼Œç§°ä¹‹ä¸º WALï¼ˆWrite-Ahead Loggingï¼‰\nundo log\nå›æ»šæ—¥å¿—ï¼Œç”¨äºè®°å½•æ•°æ®è¢«ä¿®æ”¹å‰çš„ä¿¡æ¯ , ä½œç”¨åŒ…å«ä¸¤ä¸ª : æä¾›å›æ»š(ä¿è¯äº‹åŠ¡çš„åŸå­æ€§) å’ŒMVCC(å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶) \nundo logå’Œredo logè®°å½•ç‰©ç†æ—¥å¿—ä¸ä¸€æ ·ï¼Œå®ƒæ˜¯é€»è¾‘æ—¥å¿—ã€‚å¯ä»¥è®¤ä¸ºå½“deleteä¸€æ¡è®°å½•æ—¶ï¼Œundo logä¸­ä¼šè®°å½•ä¸€æ¡å¯¹åº”çš„insertè®°å½•ï¼Œåä¹‹äº¦ç„¶ï¼Œå½“updateä¸€æ¡è®°å½•æ—¶ï¼Œå®ƒè®°å½•ä¸€æ¡å¯¹åº”ç›¸åçš„updateè®°å½•ã€‚å½“æ‰§è¡Œrollbackæ—¶ï¼Œå°±å¯ä»¥ä»undo logä¸­çš„é€»è¾‘è®°å½•è¯»å–åˆ°ç›¸åº”çš„å†…å®¹å¹¶è¿›è¡Œå›æ»šã€‚\nUndo logé”€æ¯ï¼šundo logåœ¨äº‹åŠ¡æ‰§è¡Œæ—¶äº§ç”Ÿï¼Œäº‹åŠ¡æäº¤æ—¶ï¼Œå¹¶ä¸ä¼šç«‹å³åˆ é™¤undo logï¼Œå› ä¸ºè¿™äº›æ—¥å¿—å¯èƒ½è¿˜ç”¨äºMVCCã€‚\nUndo logå­˜å‚¨ï¼šundo logé‡‡ç”¨æ®µçš„æ–¹å¼è¿›è¡Œç®¡ç†å’Œè®°å½•ï¼Œå­˜æ”¾åœ¨å‰é¢ä»‹ç»çš„ rollback segmentå›æ»šæ®µä¸­ï¼Œå†…éƒ¨åŒ…å«1024ä¸ªundo log segmentã€‚\nMVCCMVCCå…¨ç§°ä¸ºMulti-Version Concurrency Controlï¼Œå³å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ã€‚å®ƒæ˜¯ä¸€ç§ç”¨äºå®ç°æ•°æ®åº“äº‹åŠ¡çš„å¹¶å‘æ§åˆ¶æ–¹å¼ï¼Œä¸»è¦åº”ç”¨äºå¤šç”¨æˆ·ã€å¤šäº‹åŠ¡åŒæ—¶æ‰§è¡Œçš„ç¯å¢ƒä¸‹ï¼Œç”¨æ¥ä¿è¯äº‹åŠ¡çš„éš”ç¦»æ€§å’Œå¹¶å‘æ€§ã€‚\nMVCCçš„ä¸»è¦æ€æƒ³æ˜¯ä¸ºæ¯ä¸ªæ•°æ®åº“è®°å½•ç»´æŠ¤å¤šä¸ªç‰ˆæœ¬ï¼Œæ¯ä¸ªç‰ˆæœ¬éƒ½å¯¹åº”ç€ä¸åŒçš„äº‹åŠ¡æ›´æ–°ã€‚è¿™æ ·ï¼Œå³ä½¿æœ‰å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œï¼Œæ¯ä¸ªäº‹åŠ¡çœ‹åˆ°çš„éƒ½æ˜¯ä¸€è‡´æ€§çš„æ•°æ®ï¼Œè€Œä¸ä¼šå‘ç”Ÿè„è¯»ã€ä¸å¯é‡å¤è¯»ç­‰é—®é¢˜ã€‚\nå½“å‰è¯»\nè¯»å–çš„æ˜¯è®°å½•çš„æœ€æ–°ç‰ˆæœ¬ï¼Œè¯»å–æ—¶è¿˜è¦ä¿è¯å…¶ä»–å¹¶å‘äº‹åŠ¡ä¸èƒ½ä¿®æ”¹å½“å‰è®°å½•ï¼Œä¼šå¯¹è¯»å–çš„è®°å½•è¿›è¡ŒåŠ é”ã€‚å¯¹äºæˆ‘ä»¬æ—¥å¸¸çš„æ“ä½œï¼Œå¦‚ï¼šselect â€¦ lock in share mode(å…±äº«é”)ï¼Œselect â€¦ for updateã€updateã€insertã€delete(æ’ä»–é”)éƒ½æ˜¯ä¸€ç§å½“å‰è¯»ã€‚\n\nå³ä½¿æ˜¯åœ¨é»˜è®¤çš„RRéš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡Aä¸­ä¾ç„¶å¯ä»¥è¯»å–åˆ°äº‹åŠ¡Bæœ€æ–°æäº¤çš„å†…å®¹ï¼Œå› ä¸ºåœ¨æŸ¥è¯¢è¯­å¥åé¢åŠ ä¸Šäº† lock in share mode å…±äº«é”ï¼Œæ­¤æ—¶æ˜¯å½“å‰è¯»æ“ä½œã€‚å½“ç„¶ï¼Œå½“æˆ‘ä»¬åŠ æ’ä»–é”çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯å½“å‰è¯»æ“ä½œã€‚\n å¿«ç…§è¯»\nç®€å•çš„selectï¼ˆä¸åŠ é”ï¼‰å°±æ˜¯å¿«ç…§è¯»ï¼Œå¿«ç…§è¯»ï¼Œè¯»å–çš„æ˜¯è®°å½•æ•°æ®çš„å¯è§ç‰ˆæœ¬ï¼Œæœ‰å¯èƒ½æ˜¯å†å²æ•°æ®ï¼Œä¸åŠ é”ï¼Œæ˜¯éé˜»å¡è¯»ã€‚\nRead Committedï¼šæ¯æ¬¡selectï¼Œéƒ½ç”Ÿæˆä¸€ä¸ªå¿«ç…§è¯»ã€‚\nRepeatable Readï¼šå¼€å¯äº‹åŠ¡åç¬¬ä¸€ä¸ªselectè¯­å¥æ‰æ˜¯å¿«ç…§è¯»çš„åœ°æ–¹ã€‚\nSerializableï¼šå¿«ç…§è¯»ä¼šé€€åŒ–ä¸ºå½“å‰è¯»ã€‚\næ¼”ç¤ºRR\n\nåˆ°å³ä½¿äº‹åŠ¡Bæäº¤äº†æ•°æ®,äº‹åŠ¡Aä¸­ä¹ŸæŸ¥è¯¢ä¸åˆ°ã€‚ åŸå› å°±æ˜¯å› ä¸ºæ™®é€šçš„selectæ˜¯å¿«ç…§è¯»ï¼Œè€Œåœ¨å½“å‰é»˜è®¤çš„RRéš”ç¦»çº§åˆ«ä¸‹ï¼Œå¼€å¯äº‹åŠ¡åç¬¬ä¸€ä¸ªselectè¯­å¥æ‰æ˜¯å¿«ç…§è¯»çš„åœ°æ–¹ï¼Œåé¢æ‰§è¡Œç›¸åŒçš„selectè¯­å¥éƒ½æ˜¯ä»å¿«ç…§ä¸­è·å–æ•°æ®ï¼Œå¯èƒ½ä¸æ˜¯å½“å‰çš„æœ€æ–°æ•°æ®ï¼Œè¿™æ ·ä¹Ÿå°±ä¿è¯äº†å¯é‡å¤è¯»ã€‚\n MVCC\nå…¨ç§° Multi-Version Concurrency Controlï¼Œå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ã€‚æŒ‡ç»´æŠ¤ä¸€ä¸ªæ•°æ®çš„å¤šä¸ªç‰ˆæœ¬ï¼Œä½¿å¾—è¯»å†™æ“ä½œæ²¡æœ‰å†²çªï¼Œå¿«ç…§è¯»ä¸ºMySQLå®ç°MVCCæä¾›äº†ä¸€ä¸ªéé˜»å¡è¯»åŠŸèƒ½ã€‚MVCCçš„å…·ä½“å®ç°ï¼Œè¿˜éœ€è¦ä¾èµ–äºæ•°æ®åº“è®°å½•ä¸­çš„ä¸‰ä¸ªéšå¼å­—æ®µã€undo logæ—¥å¿—ã€readViewã€‚\néšè—å­—æ®µ\næˆ‘ä»¬åˆ›å»ºäº†ä¸€å¼ è¡¨ï¼Œåœ¨æŸ¥çœ‹è¡¨ç»“æ„çš„æ—¶å€™ï¼Œå°±å¯ä»¥æ˜¾å¼çš„çœ‹åˆ°è¿™å¼ è¡¨çš„å­—æ®µã€‚å®é™…ä¸Šé™¤äº†æ˜¾å¼å­—æ®µä»¥å¤–ï¼ŒInnoDBè¿˜ä¼šè‡ªåŠ¨çš„ç»™æˆ‘ä»¬æ·»åŠ ä¸‰ä¸ªéšè—å­—æ®µåŠå…¶å«ä¹‰åˆ†åˆ«æ˜¯\n\n\n\néšè—å­—æ®µ\nå«ä¹‰\n\n\n\nDB_TRX_ID\næœ€è¿‘ä¿®æ”¹äº‹åŠ¡IDï¼Œè®°å½•æ’å…¥è¿™æ¡è®°å½•æˆ–æœ€åä¸€æ¬¡ä¿®æ”¹è¯¥è®°å½•çš„äº‹åŠ¡IDã€‚\n\n\nDB_ROLL_PTR\nå›æ»šæŒ‡é’ˆï¼ŒæŒ‡å‘è¿™æ¡è®°å½•çš„ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼Œç”¨äºé…åˆundo logï¼ŒæŒ‡å‘ä¸Šä¸€ä¸ªç‰ˆæœ¬\n\n\nDB_ROW_ID\néšè—ä¸»é”®ï¼Œå¦‚æœè¡¨ç»“æ„æ²¡æœ‰æŒ‡å®šä¸»é”®ï¼Œå°†ä¼šç”Ÿæˆè¯¥éšè—å­—æ®µ\n\n\næµ‹è¯•\næŸ¥çœ‹æœ‰ä¸»é”®çš„è¡¨ stu\nè¿›å…¥æœåŠ¡å™¨ä¸­çš„ &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;hj&#x2F; , æŸ¥çœ‹stuçš„è¡¨ç»“æ„ä¿¡æ¯, é€šè¿‡å¦‚ä¸‹æŒ‡ä»¤:\nibd2sdi stu.ibd\n\né™¤äº†æˆ‘ä»¬å»ºè¡¨æ—¶æŒ‡å®šçš„å­—æ®µä»¥å¤–ï¼Œè¿˜æœ‰é¢å¤–çš„ä¸¤ä¸ªå­—æ®µ åˆ†åˆ«æ˜¯ï¼šDB_TRX_ID ã€ DB_ROLL_PTR ï¼Œå› ä¸ºè¯¥è¡¨æœ‰ä¸»é”®ï¼Œæ‰€ä»¥æ²¡æœ‰DB_ROW_IDéšè—å­—æ®µ\næŸ¥çœ‹æ²¡æœ‰ä¸»é”®çš„è¡¨ employee\nibd2sdi employee.ibd\n\nå¤„ç†æˆ‘ä»¬å»ºè¡¨æ—¶æŒ‡å®šçš„å­—æ®µä»¥å¤–ï¼Œè¿˜æœ‰é¢å¤–çš„ä¸‰ä¸ªå­—æ®µ åˆ†åˆ«æ˜¯ï¼šDB_TRX_ID ã€ DB_ROLL_PTR ã€DB_ROW_IDï¼Œå› ä¸ºemployeeè¡¨æ˜¯æ²¡æœ‰æŒ‡å®šä¸»é”®çš„\n ç‰ˆæœ¬é“¾\næœ‰ä¸€å¼ è¡¨åŸå§‹æ•°æ®ä¸ºï¼š\n\nDB_TRX_ID : ä»£è¡¨æœ€è¿‘ä¿®æ”¹äº‹åŠ¡IDï¼Œè®°å½•æ’å…¥è¿™æ¡è®°å½•æˆ–æœ€åä¸€æ¬¡ä¿®æ”¹è¯¥è®°å½•çš„äº‹åŠ¡IDï¼Œæ˜¯è‡ªå¢çš„ã€‚\nDB_ROLL_PTR ï¼š ç”±äºè¿™æ¡æ•°æ®æ˜¯æ‰æ’å…¥çš„ï¼Œæ²¡æœ‰è¢«æ›´æ–°è¿‡ï¼Œæ‰€ä»¥è¯¥å­—æ®µå€¼ä¸ºnullã€‚\næœ‰å››ä¸ªå¹¶å‘äº‹åŠ¡åŒæ—¶åœ¨è®¿é—®è¿™å¼ è¡¨\n\nå½“äº‹åŠ¡2æ‰§è¡Œç¬¬ä¸€æ¡ä¿®æ”¹è¯­å¥æ—¶ï¼Œä¼šè®°å½•undo logæ—¥å¿—ï¼Œè®°å½•æ•°æ®å˜æ›´ä¹‹å‰çš„æ ·å­; ç„¶åæ›´æ–°è®°å½•ï¼Œå¹¶ä¸”è®°å½•æœ¬æ¬¡æ“ä½œçš„äº‹åŠ¡IDï¼Œå›æ»šæŒ‡é’ˆï¼Œå›æ»šæŒ‡é’ˆç”¨æ¥æŒ‡å®šå¦‚æœå‘ç”Ÿå›æ»šï¼Œå›æ»šåˆ°å“ªä¸€ä¸ªç‰ˆæœ¬ã€‚\n\nç´§æ¥ç€äº‹åŠ¡ä¸‰æ“ä½œ\n\nå½“äº‹åŠ¡3æ‰§è¡Œç¬¬ä¸€æ¡ä¿®æ”¹è¯­å¥æ—¶ï¼Œä¹Ÿä¼šè®°å½•undo logæ—¥å¿—ï¼Œè®°å½•æ•°æ®å˜æ›´ä¹‹å‰çš„æ ·å­; ç„¶åæ›´æ–°è®°å½•ï¼Œå¹¶ä¸”è®°å½•æœ¬æ¬¡æ“ä½œçš„äº‹åŠ¡IDï¼Œå›æ»šæŒ‡é’ˆï¼Œå›æ»šæŒ‡é’ˆç”¨æ¥æŒ‡å®šå¦‚æœå‘ç”Ÿå›æ»šï¼Œå›æ»šåˆ°å“ªä¸€ä¸ªç‰ˆæœ¬ã€‚\n\næœ€ç»ˆå‘ç°ä¸åŒäº‹åŠ¡æˆ–ç›¸åŒäº‹åŠ¡å¯¹åŒä¸€æ¡è®°å½•è¿›è¡Œä¿®æ”¹ï¼Œä¼šå¯¼è‡´è¯¥è®°å½•çš„undologç”Ÿæˆä¸€æ¡è®°å½•ç‰ˆæœ¬é“¾è¡¨ï¼Œé“¾è¡¨çš„å¤´éƒ¨æ˜¯æœ€æ–°çš„æ—§è®°å½•ï¼Œé“¾è¡¨å°¾éƒ¨æ˜¯æœ€æ—©çš„æ—§è®°å½•ã€‚\nreadview\nReadViewï¼ˆè¯»è§†å›¾ï¼‰æ˜¯å¿«ç…§è¯»SQLæ‰§è¡Œæ—¶MVCCæå–æ•°æ®çš„ä¾æ®ï¼Œè®°å½•å¹¶ç»´æŠ¤ç³»ç»Ÿå½“å‰æ´»è·ƒçš„æœªæäº¤äº‹åŠ¡çš„idã€‚åœ¨ä½¿ç”¨ MVCC è¿›è¡Œäº‹åŠ¡å¹¶å‘æ§åˆ¶æ—¶ï¼Œæ•°æ®åº“éœ€è¦ç»´æŠ¤ä¸€ä¸ª ReadView(è¯»è§†å›¾)ï¼Œå®ƒæ˜¯å¿«ç…§è¯»åœ¨ SQL æ‰§è¡Œè¿‡ç¨‹ä¸­æå–æ•°æ®çš„ä¾æ®ã€‚\nReadView è®°å½•ç€ç³»ç»Ÿå½“å‰æ´»è·ƒçš„äº‹åŠ¡çš„ idã€‚ä¸€ä¸ªäº‹åŠ¡è¢«è§†ä½œâ€œæ´»è·ƒâ€çš„æ¡ä»¶æ˜¯å®ƒå·²ç»å¯åŠ¨ï¼Œä½†å°šæœªæäº¤æˆ–å›æ»šã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰åœ¨æäº¤æˆ–å›æ»šæ—¶ï¼Œäº‹åŠ¡æ‰ç®—ç»“æŸï¼Œå®ƒçš„ id æ‰è¢«ä» ReadView ä¸­ç§»é™¤ã€‚\nReadView ä¸­çš„äº‹åŠ¡ id ç”¨æ¥åˆ¤æ–­ä¸€ä¸ªå¿«ç…§è¯»çš„æ•°æ®ç‰ˆæœ¬æ˜¯å¦å¯è§ã€‚å½“ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œå¿«ç…§è¯»æ—¶ï¼Œå®ƒä¼šè¯»å– ReadView çš„äº‹åŠ¡ idï¼Œç”¨äºç¡®å®šäº‹åŠ¡å¼€å§‹å‰é‚£ä¸€åˆ»çš„æ•°æ®ç‰ˆæœ¬ã€‚å¦‚æœåœ¨å®ƒä¹‹å‰å¯åŠ¨çš„æ´»è·ƒäº‹åŠ¡å·²ç»å¯¹æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆè¿™äº›ä¿®æ”¹çš„æ•°æ®ç‰ˆæœ¬å¯¹è¯¥äº‹åŠ¡æ¥è¯´æ˜¯ä¸å¯è§çš„ï¼Œå› ä¸ºå®ƒçš„äº‹åŠ¡ id åœ¨ ReadView ä¸­ã€‚è€Œè¯»è§†å›¾åªä¼šçœ‹åˆ°åœ¨å®ƒä¹‹å‰å¯åŠ¨çš„äº‹åŠ¡çš„æ›´æ–°ï¼Œå®ƒä¹‹åå¯åŠ¨çš„äº‹åŠ¡çš„æ›´æ–°å®ƒæ˜¯ä¸å¯è§çš„ã€‚\nå› æ­¤ï¼Œä¿æŒ ReadView ä¸­çš„ id ç»´æŠ¤äº†ç³»ç»Ÿå½“å‰çš„å¹¶å‘çŠ¶æ€ï¼Œä½¿å¾—å¿«ç…§è¯»èƒ½å¤Ÿåœ¨ä¸€è‡´æ€§çš„åŸºç¡€ä¸Šæå–æ•°æ®ï¼Œé¿å…äº†ä¸åˆé€‚çš„ç»“æœã€‚\nReadViewä¸­åŒ…å«äº†å››ä¸ªæ ¸å¿ƒå­—æ®µï¼š\n\n\n\nå­—æ®µ\nå«ä¹‰\n\n\n\nm_ids\nå½“å‰æ´»è·ƒçš„äº‹åŠ¡IDé›†åˆ\n\n\nmin_trx_id\næœ€å°æ´»è·ƒäº‹åŠ¡ID\n\n\nmax_trx_id\né¢„åˆ†é…äº‹åŠ¡IDï¼Œå½“å‰æœ€å¤§äº‹åŠ¡ID+1ï¼ˆå› ä¸ºäº‹åŠ¡IDæ˜¯è‡ªå¢çš„ï¼‰\n\n\ncreator_trx_id\nReadViewåˆ›å»ºè€…çš„äº‹åŠ¡ID\n\n\nè€Œåœ¨readviewä¸­å°±è§„å®šäº†ç‰ˆæœ¬é“¾æ•°æ®çš„è®¿é—®è§„åˆ™ï¼š\nâ€‹\ttrx_id ä»£è¡¨å½“å‰undo logç‰ˆæœ¬é“¾å¯¹åº”äº‹åŠ¡IDã€‚\n\n\n\næ¡ä»¶\næ˜¯å¦å¯ä»¥è®¿é—®\nè¯´æ˜\n\n\n\ntrx_id &#x3D;&#x3D; creator_trx_id\nå¯ä»¥è®¿é—®è¯¥ç‰ˆæœ¬\næˆç«‹ï¼Œè¯´æ˜æ•°æ®æ˜¯å½“å‰è¿™ä¸ªäº‹åŠ¡æ›´æ”¹çš„ã€‚\n\n\ntrx_id &lt; min_trx_id\nå¯ä»¥è®¿é—®è¯¥ç‰ˆæœ¬\næˆç«‹ï¼Œè¯´æ˜æ•°æ®å·²ç»æäº¤äº†ã€‚\n\n\ntrx_id &gt; max_trx_id\nä¸å¯ä»¥è®¿é—®è¯¥ç‰ˆæœ¬\næˆç«‹ï¼Œè¯´æ˜è¯¥äº‹åŠ¡æ˜¯åœ¨ReadViewç”Ÿæˆåæ‰å¼€å¯ã€‚\n\n\nmin_trx_id &lt;&#x3D; trx_id &lt;&#x3D; max_trx_id\nå¦‚æœtrx_idä¸åœ¨m_idsä¸­ï¼Œæ˜¯å¯ä»¥è®¿é—®è¯¥ç‰ˆæœ¬çš„\næˆç«‹ï¼Œè¯´æ˜æ•°æ®å·²ç»æäº¤ã€‚\n\n\nä¸åŒçš„éš”ç¦»çº§åˆ«ï¼Œç”ŸæˆReadViewçš„æ—¶æœºä¸åŒï¼š\nâ€‹\tREAD COMMITTED ï¼šåœ¨äº‹åŠ¡ä¸­æ¯ä¸€æ¬¡æ‰§è¡Œå¿«ç…§è¯»æ—¶ç”ŸæˆReadViewã€‚\nâ€‹\tREPEATABLE READï¼šä»…åœ¨äº‹åŠ¡ä¸­ç¬¬ä¸€æ¬¡æ‰§è¡Œå¿«ç…§è¯»æ—¶ç”ŸæˆReadViewï¼Œåç»­å¤ç”¨è¯¥ReadViewã€‚\nåŸç†åˆ†æ\nRCéš”ç¦»çº§åˆ«\nRCéš”ç¦»çº§åˆ«ä¸‹ï¼Œåœ¨äº‹åŠ¡ä¸­æ¯ä¸€æ¬¡æ‰§è¡Œå¿«ç…§è¯»æ—¶ç”ŸæˆReadViewã€‚\næˆ‘ä»¬å°±æ¥åˆ†æäº‹åŠ¡5ä¸­ï¼Œä¸¤æ¬¡å¿«ç…§è¯»è¯»å–æ•°æ®ï¼Œæ˜¯å¦‚ä½•è·å–æ•°æ®çš„?\nåœ¨äº‹åŠ¡5ä¸­ï¼ŒæŸ¥è¯¢äº†ä¸¤æ¬¡idä¸º30çš„è®°å½•ï¼Œç”±äºéš”ç¦»çº§åˆ«ä¸ºRead Committedï¼Œæ‰€ä»¥æ¯ä¸€æ¬¡è¿›è¡Œå¿«ç…§è¯»éƒ½ä¼šç”Ÿæˆä¸€ä¸ªReadViewï¼Œé‚£ä¹ˆä¸¤æ¬¡ç”Ÿæˆçš„ReadViewå¦‚ä¸‹ã€‚\n\né‚£ä¹ˆè¿™ä¸¤æ¬¡å¿«ç…§è¯»åœ¨è·å–æ•°æ®æ—¶ï¼Œå°±éœ€è¦æ ¹æ®æ‰€ç”Ÿæˆçš„ReadViewä»¥åŠReadViewçš„ç‰ˆæœ¬é“¾è®¿é—®è§„åˆ™ï¼Œåˆ°undo logç‰ˆæœ¬é“¾ä¸­åŒ¹é…æ•°æ®ï¼Œæœ€ç»ˆå†³å®šæ­¤æ¬¡å¿«ç…§è¯»è¿”å›çš„æ•°æ®ã€‚\nå…ˆæ¥çœ‹ç¬¬ä¸€æ¬¡å¿«ç…§è¯»å…·ä½“çš„è¯»å–è¿‡ç¨‹ï¼š\n\n\nåœ¨è¿›è¡ŒåŒ¹é…æ—¶ï¼Œä¼šä»undo logçš„ç‰ˆæœ¬é“¾ï¼Œä»ä¸Šåˆ°ä¸‹è¿›è¡ŒæŒ¨ä¸ªåŒ¹é…ï¼š\nå…ˆåŒ¹é… DB_TRX_ID &#x3D; 4ï¼Œä¹Ÿå°±æ˜¯å°†4å¸¦å…¥å³ä¾§çš„åŒ¹é…è§„åˆ™ä¸­ã€‚ â‘ ä¸æ»¡è¶³ â‘¡ä¸æ»¡è¶³ â‘¢ä¸æ»¡è¶³ â‘£ä¹Ÿä¸æ»¡è¶³ ï¼Œéƒ½ä¸æ»¡è¶³ï¼Œåˆ™ç»§ç»­åŒ¹é…undo logç‰ˆæœ¬é“¾çš„ä¸‹ä¸€æ¡ã€‚\nå†åŒ¹é…ç¬¬äºŒæ¡DB_TRX_ID &#x3D; 3ï¼Œå°†3å¸¦å…¥å³ä¾§çš„åŒ¹é…è§„åˆ™ä¸­ã€‚â‘ ä¸æ»¡è¶³ â‘¡ä¸æ»¡è¶³ â‘¢ä¸æ»¡è¶³ â‘£ä¹Ÿä¸æ»¡è¶³ ï¼Œéƒ½ä¸æ»¡è¶³ï¼Œåˆ™ç»§ç»­åŒ¹é…undo logç‰ˆæœ¬é“¾çš„ä¸‹ä¸€æ¡\nå†åŒ¹é…ç¬¬ä¸‰æ¡DB_TRX_ID &#x3D; 2ï¼Œå°†2å¸¦å…¥å³ä¾§çš„åŒ¹é…è§„åˆ™ä¸­ã€‚â‘ ä¸æ»¡è¶³ â‘¡æ»¡è¶³ ç»ˆæ­¢åŒ¹é…ï¼Œæ­¤æ¬¡å¿«ç…§è¯»ï¼Œè¿”å›çš„æ•°æ®å°±æ˜¯ç‰ˆæœ¬é“¾ä¸­è®°å½•çš„è¿™æ¡æ•°æ®\nå†æ¥çœ‹ç¬¬äºŒæ¬¡å¿«ç…§è¯»å…·ä½“çš„è¯»å–è¿‡ç¨‹:\n\n\nåœ¨è¿›è¡ŒåŒ¹é…æ—¶ï¼Œä¼šä»undo logçš„ç‰ˆæœ¬é“¾ï¼Œä»ä¸Šåˆ°ä¸‹è¿›è¡ŒæŒ¨ä¸ªåŒ¹é…ï¼š\nå…ˆåŒ¹é… DB_TRX_ID &#x3D; 4ï¼Œå°†4å¸¦å…¥å³ä¾§çš„åŒ¹é…è§„åˆ™ä¸­ã€‚ â‘ ä¸æ»¡è¶³ â‘¡ä¸æ»¡è¶³ â‘¢ä¸æ»¡è¶³ â‘£ä¹Ÿä¸æ»¡è¶³ ï¼Œéƒ½ä¸æ»¡è¶³ï¼Œåˆ™ç»§ç»­åŒ¹é…undo logç‰ˆæœ¬é“¾çš„ä¸‹ä¸€æ¡ã€‚\nå†åŒ¹é…DB_TRX_ID &#x3D; 3ï¼Œå°†3å¸¦å…¥å³ä¾§çš„åŒ¹é…è§„åˆ™ä¸­ã€‚â‘ ä¸æ»¡è¶³ â‘¡æ»¡è¶³ ã€‚ç»ˆæ­¢åŒ¹é…ï¼Œæ­¤æ¬¡å¿«ç…§è¯»ï¼Œè¿”å›çš„æ•°æ®å°±æ˜¯ç‰ˆæœ¬é“¾ä¸­è®°å½•çš„è¿™æ¡æ•°æ®ã€‚\n RRéš”ç¦»çº§åˆ«\nRRéš”ç¦»çº§åˆ«ä¸‹ï¼Œä»…åœ¨äº‹åŠ¡ä¸­ç¬¬ä¸€æ¬¡æ‰§è¡Œå¿«ç…§è¯»æ—¶ç”ŸæˆReadViewï¼Œåç»­å¤ç”¨è¯¥ReadViewã€‚ è€ŒRR æ˜¯å¯é‡å¤è¯»ï¼Œåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œæ‰§è¡Œä¸¤æ¬¡ç›¸åŒçš„selectè¯­å¥ï¼ŒæŸ¥è¯¢åˆ°çš„ç»“æœæ˜¯ä¸€æ ·çš„ã€‚\n\nåœ¨RRéš”ç¦»çº§åˆ«ä¸‹ï¼Œåªæ˜¯åœ¨äº‹åŠ¡ä¸­ç¬¬ä¸€æ¬¡å¿«ç…§è¯»æ—¶ç”ŸæˆReadViewï¼Œåç»­éƒ½æ˜¯å¤ç”¨è¯¥ReadViewï¼Œé‚£ä¹ˆæ—¢ç„¶ReadViewéƒ½ä¸€æ ·ï¼Œ ReadViewçš„ç‰ˆæœ¬é“¾åŒ¹é…è§„åˆ™ä¹Ÿä¸€æ ·ï¼Œ é‚£ä¹ˆæœ€ç»ˆå¿«ç…§è¯»è¿”å›çš„ç»“æœä¹Ÿæ˜¯ä¸€æ ·çš„\næ‰€ä»¥MVCCçš„å®ç°åŸç†å°±æ˜¯é€šè¿‡ InnoDBè¡¨çš„éšè—å­—æ®µã€UndoLog ç‰ˆæœ¬é“¾ã€ReadViewæ¥å®ç°çš„ã€‚è€ŒMVCC + é”ï¼Œåˆ™å®ç°äº†äº‹åŠ¡çš„éš”ç¦»æ€§ã€‚ è€Œä¸€è‡´æ€§åˆ™æ˜¯ç”±redolog ä¸ undologä¿è¯\n\n","slug":"InnoDBå­˜å‚¨å¼•æ“-MVCCåŸç†","date":"2023-05-20T02:00:56.000Z","categories_index":"","tags_index":"MySQL","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"083e3a4ebfcb19d327b53b7d73aaddd3","title":"MySQL_é”","content":"é”â€‹\t\té”æ˜¯è®¡ç®—æœºåè°ƒå¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹å¹¶å‘è®¿é—®æŸä¸€èµ„æºçš„æœºåˆ¶ã€‚åœ¨æ•°æ®åº“ä¸­ï¼Œé™¤ä¼ ç»Ÿçš„è®¡ç®—èµ„æºï¼ˆCPUã€RAMã€I&#x2F;Oï¼‰çš„äº‰ç”¨ä»¥å¤–ï¼Œæ•°æ®ä¹Ÿæ˜¯ä¸€ç§ä¾›è®¸å¤šç”¨æˆ·å…±äº«çš„èµ„æºã€‚å¦‚ä½•ä¿è¯æ•°æ®å¹¶å‘è®¿é—®çš„ä¸€è‡´æ€§ã€æœ‰æ•ˆæ€§æ˜¯æ‰€æœ‰æ•°æ®åº“å¿…é¡»è§£å†³çš„ä¸€ä¸ªé—®é¢˜ï¼Œé”å†²çªä¹Ÿæ˜¯å½±å“æ•°æ®åº“å¹¶å‘è®¿é—®æ€§èƒ½çš„ä¸€ä¸ªé‡è¦å› ç´ ã€‚ä»è¿™ä¸ªè§’åº¦æ¥è¯´ï¼Œé”å¯¹æ•°æ®åº“è€Œè¨€æ˜¾å¾—å°¤å…¶é‡è¦ï¼Œä¹Ÿæ›´åŠ å¤æ‚ã€‚\nMySQLä¸­çš„é”ï¼ŒæŒ‰ç…§é”çš„ç²’åº¦åˆ†ï¼Œåˆ†ä¸ºä»¥ä¸‹ä¸‰ç±»ï¼š\n\nå…¨å±€é”ï¼šé”å®šæ•°æ®åº“ä¸­çš„æ‰€æœ‰è¡¨ã€‚\n\nè¡¨çº§é”ï¼šæ¯æ¬¡æ“ä½œé”ä½æ•´å¼ è¡¨ã€‚\n\nè¡Œçº§é”ï¼šæ¯æ¬¡æ“ä½œé”ä½å¯¹åº”çš„è¡Œæ•°æ®\n\n\nå…¨å±€é”â€‹\t\tå…¨å±€é”å°±æ˜¯å¯¹æ•´ä¸ªæ•°æ®åº“å®ä¾‹åŠ é”ï¼ŒåŠ é”åæ•´ä¸ªå®ä¾‹å°±å¤„äºåªè¯»çŠ¶æ€ï¼Œåç»­çš„DMLçš„å†™è¯­å¥ï¼ŒDDLè¯­å¥ï¼Œå·²ç»æ›´æ–°æ“ä½œçš„äº‹åŠ¡æäº¤è¯­å¥éƒ½å°†è¢«é˜»å¡ã€‚\nâ€‹\t\tå…¶å…¸å‹çš„ä½¿ç”¨åœºæ™¯æ˜¯åšå…¨åº“çš„é€»è¾‘å¤‡ä»½ï¼Œå¯¹æ‰€æœ‰çš„è¡¨è¿›è¡Œé”å®šï¼Œä»è€Œè·å–ä¸€è‡´æ€§è§†å›¾ï¼Œä¿è¯æ•°æ®çš„å®Œæ•´æ€§ã€‚\nä¸ºä»€ä¹ˆå…¨åº“é€»è¾‘å¤‡ä»½ï¼Œå°±éœ€è¦åŠ å…¨å°±é”å‘¢ï¼Ÿ\nä¸åŠ å…¨å±€é”ï¼Œå¯èƒ½å­˜åœ¨çš„é—®é¢˜ã€‚\nå‡è®¾åœ¨æ•°æ®åº“ä¸­å­˜åœ¨è¿™æ ·ä¸‰å¼ è¡¨: tb_stock åº“å­˜è¡¨ï¼Œtb_order è®¢å•è¡¨ï¼Œtb_orderlog è®¢å•æ—¥å¿—è¡¨ã€‚\n\nâ€‹\t\tåœ¨è¿›è¡Œæ•°æ®å¤‡ä»½æ—¶ï¼Œå…ˆå¤‡ä»½äº†tb_stockåº“å­˜è¡¨ã€‚\nâ€‹\t\tç„¶åæ¥ä¸‹æ¥ï¼Œåœ¨ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œæ‰§è¡Œäº†ä¸‹å•æ“ä½œï¼Œæ‰£å‡åº“å­˜ï¼Œç”Ÿæˆè®¢å•ï¼ˆæ›´æ–°tb_stockè¡¨ï¼Œæ’å…¥tb_orderè¡¨ï¼‰ã€‚\nâ€‹\t\tç„¶åå†æ‰§è¡Œå¤‡ä»½ tb_orderè¡¨çš„é€»è¾‘ã€‚\nâ€‹\t\tä¸šåŠ¡ä¸­æ‰§è¡Œæ’å…¥è®¢å•æ—¥å¿—æ“ä½œã€‚\næœ€åï¼Œåˆå¤‡ä»½äº†tb_orderlogè¡¨ã€‚\næ­¤æ—¶å¤‡ä»½å‡ºæ¥çš„æ•°æ®ï¼Œæ˜¯å­˜åœ¨é—®é¢˜çš„ã€‚å› ä¸ºå¤‡ä»½å‡ºæ¥çš„æ•°æ®ï¼Œtb_stockè¡¨ä¸tb_orderè¡¨çš„æ•°æ®ä¸ä¸€è‡´(æœ‰æœ€æ–°æ“ä½œçš„è®¢å•ä¿¡æ¯,ä½†æ˜¯åº“å­˜æ•°æ²¡å‡)\næ­¤æ—¶å°±å¯ä»¥å€ŸåŠ©äºMySQLçš„å…¨å±€é”æ¥è§£å†³\n\nå¯¹æ•°æ®åº“è¿›è¡Œè¿›è¡Œé€»è¾‘å¤‡ä»½ä¹‹å‰ï¼Œå…ˆå¯¹æ•´ä¸ªæ•°æ®åº“åŠ ä¸Šå…¨å±€é”ï¼Œä¸€æ—¦åŠ äº†å…¨å±€é”ä¹‹åï¼Œå…¶ä»–çš„DDLã€DMLå…¨éƒ¨éƒ½å¤„äºé˜»å¡çŠ¶æ€ï¼Œä½†æ˜¯å¯ä»¥æ‰§è¡ŒDQLè¯­å¥ï¼Œä¹Ÿå°±æ˜¯å¤„äºåªè¯»çŠ¶æ€ï¼Œè€Œæ•°æ®å¤‡ä»½å°±æ˜¯æŸ¥è¯¢æ“ä½œã€‚é‚£ä¹ˆæ•°æ®åœ¨è¿›è¡Œé€»è¾‘å¤‡ä»½çš„è¿‡ç¨‹ä¸­ï¼Œæ•°æ®åº“ä¸­çš„æ•°æ®å°±æ˜¯ä¸ä¼šå‘ç”Ÿå˜åŒ–çš„ï¼Œè¿™æ ·å°±ä¿è¯äº†æ•°æ®çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ã€‚\nè¯­æ³•\n åŠ å…¨å±€é”\nflush tables with read lock ;\n\n æ•°æ®å¤‡ä»½\nmysqldump [--single-transaction] -uroot â€“p1234 hj > hj.sql\n--   mysqldump: æ˜¯MySQLå¤‡ä»½å·¥å…·ã€‚\n--   -u : æŒ‡å®šè¿æ¥æ•°æ®åº“æ‰€ç”¨çš„ç”¨æˆ·å\n--   â€“p : æŒ‡å®šè¿æ¥æ•°æ®åº“æ‰€ç”¨çš„å¯†ç \n--   hj : è¦å¤‡ä»½çš„æ•°æ®åº“åç§°ã€‚\n--   > hj.sql : å°†å¤‡ä»½æ–‡ä»¶è¾“å‡ºåˆ°itcast.sqlæ–‡ä»¶ä¸­ï¼Œä½¿ç”¨\">\"ç¬¦å·æ˜¯å°†å¤‡ä»½æ–‡ä»¶çš„å†…å®¹å¯¼å‡ºåˆ°æŒ‡å®šæ–‡ä»¶ã€‚\n\né‡Šæ”¾é”\nunlock tables;\n\næ•°æ®åº“ä¸­åŠ å…¨å±€é”ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡çš„æ“ä½œï¼Œå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š\n\nå¦‚æœåœ¨ä¸»åº“ä¸Šå¤‡ä»½ï¼Œé‚£ä¹ˆåœ¨å¤‡ä»½æœŸé—´éƒ½ä¸èƒ½æ‰§è¡Œæ›´æ–°ï¼Œä¸šåŠ¡åŸºæœ¬ä¸Šå°±å¾—åœæ‘†ã€‚\n\nå¦‚æœåœ¨ä»åº“ä¸Šå¤‡ä»½ï¼Œé‚£ä¹ˆåœ¨å¤‡ä»½æœŸé—´ä»åº“ä¸èƒ½æ‰§è¡Œä¸»åº“åŒæ­¥è¿‡æ¥çš„äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆbinlogï¼‰ï¼Œä¼šå¯¼è‡´ä¸»ä»å»¶è¿Ÿã€‚\n\n\nåœ¨InnoDBå¼•æ“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¤‡ä»½æ—¶åŠ ä¸Šå‚æ•° â€“single-transaction å‚æ•°æ¥å®Œæˆä¸åŠ é”çš„ä¸€è‡´æ€§æ•°æ®å¤‡ä»½ã€‚\nè¯¥å‘½ä»¤æ‰§è¡ŒæœŸé—´ï¼Œåœ¨å¤‡ä»½å¼€å§‹æ—¶ä½¿ç”¨START TRANSACTIONè¯­å¥æ¥å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œè¿™ä¸ªäº‹åŠ¡ä¼šåœ¨å¤‡ä»½æœŸé—´ä¸€ç›´æ‰§è¡Œï¼Œéš”ç¦»çº§åˆ«é»˜è®¤ä¸ºâ€œå¯é‡å¤è¯»â€çº§åˆ«ã€‚åœ¨å¤‡ä»½å®Œæˆåï¼Œä½¿ç”¨COMMITè¯­å¥æ¥æäº¤äº‹åŠ¡ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯å¤‡ä»½æ˜¯ä¸€è‡´æ€§çš„ï¼Œä¸ä¼šå—åˆ°æ­£åœ¨è¿›è¡Œçš„å…¶ä»–äº‹åŠ¡çš„å½±å“ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨--single-transactionå‚æ•°åªé€‚ç”¨äºæ²¡æœ‰å†™é”çš„è¡¨ã€‚å¦‚æœæœ‰è¡¨æ­£åœ¨æ‰§è¡ŒDDLè¯­å¥ï¼Œæˆ–è€…æœ‰ä½¿ç”¨ALTER TABLEï¼ŒOPTIMIZE TABLEç­‰è¯­å¥çš„è¯ï¼Œè¿™äº›è¡¨ä»ç„¶ä¼šè¢«åŠ é”ï¼Œå¤‡ä»½ä¹Ÿä¼šå—åˆ°å½±å“ã€‚\nè¡¨çº§é”è¡¨çº§é”ï¼Œæ¯æ¬¡æ“ä½œé”ä½æ•´å¼ è¡¨ã€‚é”å®šç²’åº¦å¤§ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€é«˜ï¼Œå¹¶å‘åº¦æœ€ä½ã€‚åº”ç”¨åœ¨MyISAMã€InnoDBã€BDBç­‰å­˜å‚¨å¼•æ“ä¸­ã€‚\nå¯¹äºè¡¨çº§é”ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰ç±»ï¼š\n\nè¡¨é”\n\nâ€‹\t\t- è¡¨å…±äº«è¯»é”ï¼ˆread lockï¼‰\nâ€‹\t\t- è¡¨ç‹¬å å†™é”ï¼ˆwrite lockï¼‰\n\nå…ƒæ•°æ®é”ï¼ˆmeta data lockï¼ŒMDLï¼‰\n\næ„å‘é”\n\n\nè¡¨é”è¯­æ³•ï¼š\n-- åŠ é”ï¼š\nlock tables è¡¨å... read/write\n-- é‡Šæ”¾é”\nunlock tables / å®¢æˆ·ç«¯æ–­å¼€è¿æ¥\n\n è¯»é”\n\nè¯»å†™æ¼”ç¤ºï¼š\n\nå¯¹æŒ‡å®šè¡¨åŠ äº†è¯»é”ï¼ŒåŠ é”çš„ä¼šè¯æœªè§£é”æ—¶æ‰§è¡ŒDML&#x2F;DDLä¼šæŠ¥é”™ï¼›\n\nè¯»é”ä¸ä¼šå½±å“å…¶ä»–ä¼šè¯çš„è¯»ï¼Œä½†æ˜¯ä¼šé˜»å¡ï¼ˆä¸æ˜¯æŠ¥é”™ï¼‰å…¶ä»–ä¼šè¯çš„å†™ã€‚\nå†™é”\n\nå·¦ä¾§ä¸ºå®¢æˆ·ç«¯ä¸€ï¼Œå¯¹æŒ‡å®šè¡¨åŠ äº†å†™é”ï¼Œä¼šé˜»å¡å³ä¾§å®¢æˆ·ç«¯çš„è¯»å’Œå†™ã€‚\nç»“è®º: è¯»é”ä¸ä¼šé˜»å¡å…¶ä»–å®¢æˆ·ç«¯çš„è¯»ï¼Œä½†æ˜¯ä¼šé˜»å¡å†™ã€‚å†™é”æ—¢ä¼šé˜»å¡å…¶ä»–å®¢æˆ·ç«¯çš„è¯»ï¼Œåˆä¼šé˜»å¡å…¶ä»–å®¢æˆ·ç«¯çš„å†™ã€‚\nå…ƒæ•°æ®é”\t\nmeta data lock , å…ƒæ•°æ®é”ï¼Œç®€å†™MDLã€‚\nMDLåŠ é”è¿‡ç¨‹æ˜¯ç³»ç»Ÿè‡ªåŠ¨æ§åˆ¶ï¼Œæ— éœ€æ˜¾å¼ä½¿ç”¨ï¼Œåœ¨è®¿é—®ä¸€å¼ è¡¨çš„æ—¶å€™ä¼šè‡ªåŠ¨åŠ ä¸Šã€‚MDLé”ä¸»è¦ä½œç”¨æ˜¯ç»´æŠ¤è¡¨å…ƒæ•°æ®çš„æ•°æ®ä¸€è‡´æ€§ï¼Œåœ¨è¡¨ä¸Šæœ‰æ´»åŠ¨äº‹åŠ¡çš„æ—¶å€™ï¼Œä¸å¯ä»¥å¯¹å…ƒæ•°æ®è¿›è¡Œå†™å…¥æ“ä½œã€‚ä¸ºäº†é¿å…DMLä¸DDLå†²çªï¼Œä¿è¯è¯»å†™çš„æ­£ç¡®æ€§ã€‚\nMDLé”èƒ½å¤Ÿç¡®ä¿åœ¨è¿›è¡Œè¡¨ç»“æ„ä¿®æ”¹æ—¶ï¼Œä¸ä¼šåŒæ—¶å­˜åœ¨å…¶ä»–è¯»å’Œå†™æ“ä½œï¼Œé¿å…å¹¶å‘æ“ä½œå¯¼è‡´çš„æ•°æ®å†²çªå’Œé”™è¯¯ã€‚åœ¨MySQL5.5ä¸­å¼•å…¥äº†MDLï¼Œå½“å¯¹ä¸€å¼ è¡¨è¿›è¡Œå¢åˆ æ”¹æŸ¥çš„æ—¶å€™ï¼ŒåŠ MDLè¯»é”(å…±äº«)ï¼›å½“å¯¹è¡¨ç»“æ„è¿›è¡Œå˜æ›´æ“ä½œçš„æ—¶å€™ï¼ŒåŠ MDLå†™é”(æ’ä»–)ã€‚\nå¸¸è§çš„SQLæ“ä½œæ—¶ï¼Œæ‰€æ·»åŠ çš„å…ƒæ•°æ®é”ï¼š\n\n\n\nå¯¹åº”SQL\né”ç±»å‹\nè¯´æ˜\n\n\n\nlock tables xxx read &#x2F; write\nSHARED_READ_ONLY &#x2F; SHARED_NO_READ_WRITE\n\n\n\nselect ã€select â€¦ lock in share mode\nSHARED_READ\nä¸SHARED_READã€SHARED_WRITEå…¼å®¹ï¼Œä¸EXCLUSIVEäº’æ–¥\n\n\ninsert ã€updateã€deleteã€select â€¦ for update\nSHARED_WRITE\nä¸SHARED_READã€SHARED_WRITEå…¼å®¹ï¼Œä¸EXCLUSIVEäº’æ–¥\n\n\nalter table â€¦\nEXCLUSIVE\nä¸å…¶ä»–çš„MDLéƒ½äº’æ–¥\n\n\næˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„SQLï¼Œæ¥æŸ¥çœ‹æ•°æ®åº“ä¸­çš„å…ƒæ•°æ®é”çš„æƒ…å†µï¼š\nselect object_type,object_schema,object_name,lock_type,lock_duration from performance_schema.metadata_locks ;\n\né”çš„å…¼å®¹æ¼”ç¤º\n\n\nSHARED_READä¸SHARED_WRITEå…¼å®¹\n\n\nSHARED_READä¸EXCLUSIVEäº’æ–¥\næ„å‘é”\nä¸ºäº†é¿å…DMLåœ¨æ‰§è¡Œæ—¶ï¼ŒåŠ çš„è¡Œé”ä¸è¡¨é”çš„å†²çªï¼Œåœ¨InnoDBä¸­å¼•å…¥äº†æ„å‘é”ï¼Œä½¿å¾—è¡¨é”ä¸ç”¨æ£€æŸ¥æ¯è¡Œæ•°æ®æ˜¯å¦åŠ é”ï¼Œä½¿ç”¨æ„å‘é”æ¥å‡å°‘è¡¨é”çš„æ£€æŸ¥ã€‚\nå‡å¦‚æ²¡æœ‰æ„å‘é”ï¼Œå®¢æˆ·ç«¯ä¸€å¯¹è¡¨åŠ äº†è¡Œé”åï¼Œå®¢æˆ·ç«¯äºŒå¦‚ä½•ç»™è¡¨åŠ è¡¨é”å‘¢ï¼Œæ¥é€šè¿‡ç¤ºæ„å›¾ç®€å•åˆ†æä¸€ä¸‹ï¼š\né¦–å…ˆå®¢æˆ·ç«¯ä¸€ï¼Œå¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œç„¶åæ‰§è¡ŒDMLæ“ä½œï¼Œåœ¨æ‰§è¡ŒDMLè¯­å¥æ—¶ï¼Œä¼šå¯¹æ¶‰åŠåˆ°çš„è¡ŒåŠ è¡Œé”ã€‚\n\nå½“å®¢æˆ·ç«¯äºŒï¼Œæƒ³å¯¹è¿™å¼ è¡¨åŠ è¡¨é”æ—¶ï¼Œä¼šæ£€æŸ¥å½“å‰è¡¨æ˜¯å¦æœ‰å¯¹åº”çš„è¡Œé”ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æ·»åŠ è¡¨é”ï¼Œæ­¤æ—¶å°±ä¼šä»ç¬¬ä¸€è¡Œæ•°æ®ï¼Œæ£€æŸ¥åˆ°æœ€åä¸€è¡Œæ•°æ®ï¼Œæ•ˆç‡è¾ƒä½ã€‚\n\næœ‰äº†æ„å‘é”ä¹‹å :\nå®¢æˆ·ç«¯ä¸€ï¼Œåœ¨æ‰§è¡ŒDMLæ“ä½œæ—¶ï¼Œä¼šå¯¹æ¶‰åŠçš„è¡ŒåŠ è¡Œé”ï¼ŒåŒæ—¶ä¹Ÿä¼šå¯¹è¯¥è¡¨åŠ ä¸Šæ„å‘é”ã€‚\n\nè€Œå…¶ä»–å®¢æˆ·ç«¯ï¼Œåœ¨å¯¹è¿™å¼ è¡¨åŠ è¡¨é”çš„æ—¶å€™ï¼Œä¼šæ ¹æ®è¯¥è¡¨ä¸Šæ‰€åŠ çš„æ„å‘é”æ¥åˆ¤å®šæ˜¯å¦å¯ä»¥æˆåŠŸåŠ è¡¨é”ï¼Œè€Œä¸ç”¨é€è¡Œåˆ¤æ–­è¡Œé”æƒ…å†µäº†ã€‚\n\n åˆ†ç±»\næ„å‘å…±äº«é”(IS): ç”±è¯­å¥select â€¦ lock in share modeæ·»åŠ  ã€‚ä¸è¡¨é”å…±äº«é”(read)å…¼å®¹ï¼Œä¸è¡¨é”æ’ä»–é”(write)äº’æ–¥ã€‚\næ„å‘æ’ä»–é”(IX): ç”±insertã€updateã€deleteã€selectâ€¦for updateæ·»åŠ  ã€‚ä¸è¡¨é”å…±äº«é”(read)åŠæ’ä»–é”(write)éƒ½äº’æ–¥ï¼Œæ„å‘é”ä¹‹é—´ä¸ä¼šäº’æ–¥ã€‚\nä¸€æ—¦äº‹åŠ¡æäº¤äº†ï¼Œæ„å‘å…±äº«é”ã€æ„å‘æ’ä»–é”ï¼Œéƒ½ä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚\næŸ¥çœ‹æ„å‘é”åŠè¡Œé”çš„åŠ é”æƒ…å†µï¼š\nselect object_schema,object_name,index_name,lock_type,lock_mode,lock_data from performance_schema.data_locks;\n\næ„å‘é”æ¼”ç¤º\næ„å‘å…±äº«é”(IS)ä¸è¡¨é”å…±äº«é”å…¼å®¹ï¼Œä¸è¡¨é”æ’ä»–é”äº’æ–¥\n\n\n æ„å‘æ’ä»–é”(IX)ä¸è¡¨è¯»é”ã€å†™é”éƒ½æ˜¯äº’æ–¥çš„\n\n\nè¡Œçº§é”è¡Œçº§é”ï¼Œæ¯æ¬¡æ“ä½œé”ä½å¯¹åº”çš„è¡Œæ•°æ®ã€‚é”å®šç²’åº¦æœ€å°ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€ä½ï¼Œå¹¶å‘åº¦æœ€é«˜ã€‚åº”ç”¨åœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­.\nInnoDBçš„æ•°æ®æ˜¯åŸºäºç´¢å¼•ç»„ç»‡çš„ï¼Œè¡Œé”æ˜¯é€šè¿‡å¯¹ç´¢å¼•ä¸Šçš„ç´¢å¼•é¡¹åŠ é”æ¥å®ç°çš„ï¼Œè€Œä¸æ˜¯å¯¹è®°å½•åŠ çš„\né”ã€‚å¯¹äºè¡Œçº§é”ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰ç±»ï¼š\n\nè¡Œé”ï¼ˆRecord Lockï¼‰ï¼šé”å®šå•ä¸ªè¡Œè®°å½•çš„é”ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡å¯¹æ­¤è¡Œè¿›è¡Œupdateå’Œdeleteã€‚åœ¨RCã€RRéš”ç¦»çº§åˆ«ä¸‹éƒ½æ”¯æŒ\n\n\n\né—´éš™é”ï¼ˆGap Lockï¼‰ï¼šé”å®šç´¢å¼•è®°å½•é—´éš™ï¼ˆä¸å«è¯¥è®°å½•ï¼‰ï¼Œç¡®ä¿ç´¢å¼•è®°å½•é—´éš™ä¸å˜ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨è¿™ä¸ªé—´éš™è¿›è¡Œinsertï¼Œäº§ç”Ÿå¹»è¯»ã€‚åœ¨RRéš”ç¦»çº§åˆ«ä¸‹éƒ½æ”¯æŒ\n\n\n\nä¸´é”®é”ï¼ˆNext-Key Lockï¼‰ï¼šè¡Œé”å’Œé—´éš™é”ç»„åˆï¼ŒåŒæ—¶é”ä½æ•°æ®ï¼Œå¹¶é”ä½æ•°æ®å‰é¢çš„é—´éš™Gapã€‚åœ¨RRéš”ç¦»çº§åˆ«ä¸‹æ”¯æŒã€‚\n\n\nè¡Œé”\nInnoDBå®ç°äº†ä»¥ä¸‹ä¸¤ç§ç±»å‹çš„è¡Œé”ï¼š\n\nå…±äº«é”ï¼ˆSï¼‰ï¼šå…è®¸ä¸€ä¸ªäº‹åŠ¡å»è¯»ä¸€è¡Œï¼Œé˜»æ­¢å…¶ä»–äº‹åŠ¡è·å¾—ç›¸åŒæ•°æ®é›†çš„æ’å®ƒé”ã€‚\n\næ’ä»–é”ï¼ˆXï¼‰ï¼šå…è®¸è·å–æ’ä»–é”çš„äº‹åŠ¡æ›´æ–°æ•°æ®ï¼Œé˜»æ­¢å…¶ä»–äº‹åŠ¡è·å¾—ç›¸åŒæ•°æ®é›†çš„å…±äº«é”å’Œæ’ä»–é”ã€‚\n\n\nä¸¤ç§è¡Œé”çš„å…¼å®¹æƒ…å†µå¦‚ä¸‹:\n\n\n\nå½“å‰é”çš„ç±»å‹\nè¯·æ±‚é”çš„ç±»å‹\nå…¼å®¹æƒ…å†µ\n\n\n\nS(å…±äº«é”)\nS(å…±äº«é”)\nå…¼å®¹\n\n\nS(å…±äº«é”)\nX(æ’ä»–é”)\nå†²çª\n\n\nX(æ’ä»–é”)\nX(æ’ä»–é”)\nå†²çª\n\n\nX(æ’ä»–é”)\nS(å…±äº«é”)\nå†²çª\n\n\nå¸¸è§çš„SQLè¯­å¥ï¼Œåœ¨æ‰§è¡Œæ—¶ï¼Œæ‰€åŠ çš„è¡Œé”å¦‚ä¸‹ï¼š\n\n\n\nSQL\nè¡Œé”ç±»å‹\nè¯´æ˜\n\n\n\nINSERT â€¦\næ’ä»–é”\nè‡ªåŠ¨åŠ é”\n\n\nUPDATE â€¦\næ’ä»–é”\nè‡ªåŠ¨åŠ é”\n\n\nDELETE â€¦\næ’ä»–é”\nè‡ªåŠ¨åŠ é”\n\n\nSELECTï¼ˆæ­£å¸¸ï¼‰\nä¸åŠ ä»»ä½•é”\n\n\n\nSELECT â€¦ LOCK IN SHARE MODE\nå…±äº«é”\néœ€è¦æ‰‹åŠ¨åœ¨SELECTä¹‹ååŠ LOCK IN SHARE MODE\n\n\nSELECT â€¦ FOR UPDATE\næ’ä»–é”\néœ€è¦æ‰‹åŠ¨åœ¨SELECTä¹‹ååŠ FOR UPDATE\n\n\né»˜è®¤æƒ…å†µä¸‹ï¼ŒInnoDBä½¿ç”¨next-key é”æ¥å®ç° REPEATABLE READ éš”ç¦»çº§åˆ«ï¼Œå®ƒæ˜¯ä¸€ç§ç»„åˆé”ï¼ŒåŒ…å«ç´¢å¼•è®°å½•é”å’Œé—´éš™é”ã€‚è¯¥é”çš„ä¸»è¦ä½œç”¨æ˜¯åœ¨æ‰§è¡Œç´¢å¼•æ‰«ææ—¶ï¼Œå¯¹äºæ‰€æŸ¥æ‰¾çš„æ¯æ¡è®°å½•ï¼Œéƒ½è¦è·å–è®°å½•é”ä»¥åŠå¯¹åº”çš„é—´éš™é”ï¼Œä»¥ä¿è¯äº‹åŠ¡åœ¨è¯»å–æ•°æ®æ—¶ä¸ä¼šå‡ºç°å¹»è¯»é—®é¢˜ã€‚\n\né’ˆå¯¹å”¯ä¸€ç´¢å¼•è¿›è¡Œæ£€ç´¢æ—¶ï¼Œå¯¹å·²å­˜åœ¨çš„è®°å½•è¿›è¡Œç­‰å€¼åŒ¹é…æ—¶ï¼Œå°†ä¼šè‡ªåŠ¨ä¼˜åŒ–ä¸ºè¡Œé”ã€‚\n\nInnoDBçš„è¡Œé”æ˜¯é’ˆå¯¹äºç´¢å¼•åŠ çš„é”ï¼Œä¸é€šè¿‡ç´¢å¼•æ¡ä»¶æ£€ç´¢æ•°æ®ï¼Œé‚£ä¹ˆInnoDBå°†å¯¹è¡¨ä¸­çš„æ‰€æœ‰è®°å½•åŠ é”ï¼Œæ­¤æ—¶ å°±ä¼šå‡çº§ä¸ºè¡¨é”ã€‚\n\n\næŸ¥çœ‹æ„å‘é”åŠè¡Œé”çš„åŠ é”æƒ…å†µï¼š\nselect object_schema,object_name,index_name,lock_type,lock_mode,lock_data from performance_schema.data_locks;\n\n æ¼”ç¤ºï¼šè¡¨ç»“æ„å¦‚ä¸‹\nCREATE TABLE `stu` (\n`id` int NOT NULL PRIMARY KEY AUTO_INCREMENT,\n`name` varchar(255) DEFAULT NULL,\n`age` int NOT NULL\n) ENGINE = InnoDB CHARACTER SET = utf8mb4;\n\n selectâ€¦lock in share modeï¼ŒåŠ å…±äº«é”ï¼Œå…±äº«é”ä¸å…±äº«é”ä¹‹é—´å…¼å®¹ã€‚\n\n\nå…±äº«é”ä¸æ’ä»–é”ä¹‹é—´äº’æ–¥ã€‚\n\n\næ— ç´¢å¼•è¡Œé”å‡çº§ä¸ºè¡¨é”\n\n\nå¼€å¯äº‹åŠ¡ï¼Œå¹¶æ‰§è¡Œupdateè¯­å¥ï¼Œæ›´æ–°nameä¸ºtomçš„æ•°æ® ã€‚ç„¶ååœ¨å¦ä¸€ä¸ªä¼šè¯ä¸­æ›´æ–°nameä¸ºroseçš„è®°å½•ï¼Œå´ä¸èƒ½ç›´æ¥æ‰§è¡Œï¼Œä¼šå¤„äºé˜»å¡çŠ¶æ€ã€‚åŸå› å°±æ˜¯ï¼Œä¼šè¯ä¸€æ ¹æ®nameå­—æ®µè¿›è¡Œæ›´æ–°æ—¶ï¼Œnameå­—æ®µæ˜¯æ²¡æœ‰ç´¢å¼•çš„ï¼Œå¦‚æœæ²¡æœ‰ç´¢å¼•ï¼Œæ­¤æ—¶è¡Œé”ä¼šå‡çº§ä¸ºè¡¨é”ï¼ˆå› ä¸ºè¡Œé”æ˜¯å¯¹ç´¢å¼•é¡¹åŠ çš„é”ï¼Œè€Œnameæ²¡æœ‰ç´¢å¼•ï¼‰\nå†é’ˆå¯¹nameå­—æ®µå»ºç«‹ç´¢å¼•ï¼Œç´¢å¼•å»ºç«‹ä¹‹åï¼Œå†æ¬¡åšä¸€ä¸ªæµ‹è¯•ï¼š\n\n\nè¿™æ ·å°±è¯´æ˜ï¼Œæˆ‘ä»¬æ ¹æ®ç´¢å¼•å­—æ®µè¿›è¡Œæ›´æ–°æ“ä½œï¼Œå°±å¯ä»¥é¿å…è¡Œé”å‡çº§ä¸ºè¡¨é”çš„æƒ…å†µã€‚\né—´éš™é”&amp;ä¸´é”®é”\né»˜è®¤æƒ…å†µä¸‹ï¼ŒInnoDBåœ¨ REPEATABLE READäº‹åŠ¡éš”ç¦»çº§åˆ«è¿è¡Œï¼ŒInnoDBä½¿ç”¨ next-key é”è¿›è¡Œæœç´¢å’Œç´¢å¼•æ‰«æï¼Œä»¥é˜²æ­¢å¹»è¯»ã€‚ä¸´é”®é”ï¼ˆNext-Key Lockï¼‰æ˜¯InnoDBå¼•æ“åœ¨å®ç°é—´éš™é”ï¼ˆGap Lockï¼‰æ—¶æ‰€åŠ çš„é”ï¼Œå…¶ä½œç”¨æ˜¯é”å®šé—´éš™å¹¶ä¿æŠ¤é—´éš™å†…çš„ä¸‹ä¸€ä¸ªè®°å½•ï¼Œä»¥é˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨é—´éš™å†…æ’å…¥è®°å½•ã€‚\n\nç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢(å”¯ä¸€ç´¢å¼•)ï¼Œç»™ä¸å­˜åœ¨çš„è®°å½•åŠ é”æ—¶, ä¼˜åŒ–ä¸ºé—´éš™é” ã€‚\n\nç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢(éå”¯ä¸€æ™®é€šç´¢å¼•)ï¼Œå‘å³éå†æ—¶æœ€åä¸€ä¸ªå€¼ä¸æ»¡è¶³æŸ¥è¯¢éœ€æ±‚æ—¶ï¼Œnext-keyé”é€€åŒ–ä¸ºé—´éš™é”ã€‚\n\nç´¢å¼•ä¸Šçš„èŒƒå›´æŸ¥è¯¢(å”¯ä¸€ç´¢å¼•)â€“ä¼šè®¿é—®åˆ°ä¸æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå€¼ä¸ºæ­¢ã€‚\n\n\né—´éš™é”å”¯ä¸€ç›®çš„æ˜¯é˜²æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥é—´éš™ã€‚é—´éš™é”å¯ä»¥å…±å­˜ï¼Œä¸€ä¸ªäº‹åŠ¡é‡‡ç”¨çš„é—´éš™é”ä¸ä¼šé˜»æ­¢å¦ä¸€ä¸ªäº‹åŠ¡åœ¨åŒä¸€é—´éš™ä¸Šé‡‡ç”¨é—´éš™é”ã€‚\nç¤ºä¾‹æ¼”ç¤º\n ç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢(å”¯ä¸€ç´¢å¼•)ï¼Œç»™ä¸å­˜åœ¨çš„è®°å½•åŠ é”æ—¶, ä¼˜åŒ–ä¸ºé—´éš™é” ã€‚\n\n\næŸ¥è¯¢ï¼ˆåŠ å…±äº«é”ï¼‰æˆ–è€…æ›´æ–°ä¸å­˜åœ¨çš„è®°å½•æ—¶ï¼Œè¡Œé”ï¼ˆSæˆ–è€…Xï¼‰ä¼šä¼˜åŒ–æˆé—´éš™é”ï¼ˆGAPï¼‰,å½“åœ¨åŠ äº†é—´éš™é”çš„èŒƒå›´å†…insertæ’å…¥æ•°æ®æ—¶ä¼šé˜»å¡ï¼Œupdate&#x2F;deleteä¸ä¼šé˜»å¡ã€‚\nç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢(éå”¯ä¸€æ™®é€šç´¢å¼•)ï¼Œå‘å³éå†æ—¶æœ€åä¸€ä¸ªå€¼ä¸æ»¡è¶³æŸ¥è¯¢éœ€æ±‚æ—¶ï¼Œnext-keyé”é€€åŒ–ä¸ºé—´éš™é”ã€‚ \nInnoDBçš„B+æ ‘ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹æ˜¯æœ‰åºçš„åŒå‘é“¾è¡¨ã€‚ å‡å¦‚ï¼Œæˆ‘ä»¬è¦æ ¹æ®è¿™ä¸ªäºŒçº§ç´¢å¼•æŸ¥è¯¢å€¼ä¸º18çš„æ•°æ®ï¼Œå¹¶åŠ ä¸Šå…±äº«é”ï¼Œæˆ‘ä»¬æ˜¯åªé”å®š18è¿™ä¸€è¡Œå°±å¯ä»¥äº†å—ï¼Ÿ å¹¶ä¸æ˜¯ï¼Œå› ä¸ºæ˜¯éå”¯ä¸€ç´¢å¼•ï¼Œè¿™ä¸ªç»“æ„ä¸­å¯èƒ½æœ‰å¤šä¸ª18çš„å­˜åœ¨ï¼Œæ‰€ä»¥ï¼Œåœ¨åŠ é”æ—¶ä¼šç»§ç»­å¾€åæ‰¾ï¼Œæ‰¾åˆ°ä¸€ä¸ªä¸æ»¡è¶³æ¡ä»¶çš„å€¼ï¼ˆå½“å‰æ¡ˆä¾‹ä¸­ä¹Ÿå°±æ˜¯29ï¼‰ã€‚æ­¤æ—¶ä¼šå¯¹18åŠ ä¸´é”®é”ï¼Œå¹¶å¯¹29ä¹‹å‰çš„é—´éš™åŠ é”ã€‚\n\nå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç´¢å¼•åˆ—aï¼Œå¯¹äºå€¼1åˆ°5ä¹‹é—´çš„åŒºé—´ï¼Œå¦‚æœæˆ‘ä»¬è®¾ç½®äº†ä¸´é”®é”ï¼Œé‚£ä¹ˆé™¤äº†a&#x3D;1å’Œa&#x3D;5ä¸¤æ¡ç´¢å¼•è®°å½•ä¸Šçš„é”ï¼Œè¿˜ä¼šé”ä½1&lt;a&lt;2, 2&lt;a&lt;3, 3&lt;a&lt;4å’Œ4&lt;a&lt;5è¿™å››ä¸ªé—´éš™ä¸Šï¼Œä»¥ä¿æŠ¤åœ¨è¯¥åŒºé—´èŒƒå›´å†…ä¸‹ä¸€ä¸ªå¯èƒ½æ’å…¥çš„è®°å½•ä¸è¢«å…¶ä»–äº‹åŠ¡æ’å…¥ã€‚\nç¤ºä¾‹\n\n\nç´¢å¼•ä¸Šçš„èŒƒå›´æŸ¥è¯¢(å”¯ä¸€ç´¢å¼•)â€“ä¼šè®¿é—®åˆ°ä¸æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå€¼ä¸ºæ­¢\n\næŸ¥è¯¢çš„æ¡ä»¶ä¸ºid&gt;&#x3D;19ï¼Œå¹¶æ·»åŠ å…±äº«é”ã€‚ æ­¤æ—¶æˆ‘ä»¬å¯ä»¥æ ¹æ®æ•°æ®åº“è¡¨ä¸­ç°æœ‰çš„æ•°æ®ï¼Œå°†æ•°æ®åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š\n[19]\n(19,25]\n(25,+âˆ]\næ‰€ä»¥æ•°æ®åº“æ•°æ®åœ¨åŠ é”æ˜¯ï¼Œå°±æ˜¯å°†19åŠ äº†è¡Œé”ï¼Œ25çš„ä¸´é”®é”ï¼ˆåŒ…å«25åŠ25ä¹‹å‰çš„é—´éš™ï¼‰ï¼Œæ­£æ— ç©·çš„ä¸´é”®é”(æ­£æ— ç©·åŠä¹‹å‰çš„é—´éš™)ã€‚\n","slug":"MySQL-é”","date":"2023-05-19T01:39:57.000Z","categories_index":"","tags_index":"MySQL","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"7a80ec680e8c46b9ee58692b58f8ab63","title":"åŸºäºsessionå®ç°è®¤è¯","content":"ä»€ä¹ˆæ˜¯è®¤è¯è®¤è¯ ï¼šç”¨æˆ·è®¤è¯å°±æ˜¯åˆ¤æ–­ä¸€ä¸ªç”¨æˆ·çš„èº«ä»½æ˜¯å¦åˆæ³•çš„è¿‡ç¨‹ï¼Œç”¨æˆ·å»è®¿é—®ç³»ç»Ÿèµ„æºæ—¶ç³»ç»Ÿè¦æ±‚éªŒè¯ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼Œèº«ä»½åˆæ³•æ–¹å¯ç»§ç»­è®¿é—®ï¼Œä¸åˆæ³•åˆ™æ‹’ç»è®¿é—®ã€‚å¸¸è§çš„ç”¨æˆ·èº«ä»½è®¤è¯æ–¹å¼æœ‰ï¼šç”¨æˆ·åå¯†ç ç™»å½•ï¼ŒäºŒç»´ç ç™»å½•ï¼Œæ‰‹æœºçŸ­ä¿¡ç™»å½•ï¼ŒæŒ‡çº¹è®¤è¯ç­‰æ–¹å¼ã€‚\nä»€ä¹ˆæ˜¯ä¼šè¯ç”¨æˆ·è®¤è¯é€šè¿‡åï¼Œä¸ºäº†é¿å…ç”¨æˆ·çš„æ¯æ¬¡æ“ä½œéƒ½è¿›è¡Œè®¤è¯å¯å°†ç”¨æˆ·çš„ä¿¡æ¯ä¿è¯åœ¨ä¼šè¯ä¸­ã€‚ä¼šè¯å°±æ˜¯ç³»ç»Ÿä¸ºäº†ä¿æŒå½“å‰ç”¨æˆ·çš„ç™»å½•çŠ¶æ€æ‰€æä¾›çš„æœºåˆ¶ï¼Œå¸¸è§çš„æœ‰åŸºäºsessionæ–¹å¼ã€åŸºäºtokenæ–¹å¼ç­‰ã€‚\nåŸºäºsessionçš„è®¤è¯æ–¹å¼å¦‚ä¸‹å›¾ï¼š\n\nå®ƒçš„äº¤äº’æµç¨‹æ˜¯ï¼Œç”¨æˆ·è®¤è¯æˆåŠŸåï¼Œåœ¨æœåŠ¡ç«¯ç”Ÿæˆç”¨æˆ·ç›¸å…³çš„æ•°æ®ä¿å­˜åœ¨session(å½“å‰ä¼šè¯)ä¸­ï¼Œå‘ç»™å®¢æˆ·ç«¯sesssion_id å­˜æ”¾åˆ° cookie ä¸­ï¼Œè¿™æ ·ç”¨æˆ·å®¢æˆ·ç«¯è¯·æ±‚æ—¶å¸¦ä¸Š session_id å°±å¯ä»¥éªŒè¯æœåŠ¡å™¨ç«¯æ˜¯å¦å­˜åœ¨ session æ•°æ®ï¼Œä»¥æ­¤å®Œæˆç”¨æˆ·çš„åˆæ³•æ ¡éªŒï¼Œå½“ç”¨æˆ·é€€å‡ºç³»ç»Ÿæˆ–sessionè¿‡æœŸé”€æ¯æ—¶,å®¢æˆ·ç«¯çš„session_idä¹Ÿå°±æ— æ•ˆäº†ã€‚\nåŸºäºtokenæ–¹å¼å¦‚ä¸‹å›¾ï¼š\n\nå®ƒçš„äº¤äº’æµç¨‹æ˜¯ï¼Œç”¨æˆ·è®¤è¯æˆåŠŸåï¼ŒæœåŠ¡ç«¯ç”Ÿæˆä¸€ä¸ªtokenå‘ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ”¾åˆ° cookie æˆ– localStorageç­‰å­˜å‚¨ä¸­ï¼Œæ¯æ¬¡è¯·æ±‚æ—¶å¸¦ä¸Š tokenï¼ŒæœåŠ¡ç«¯æ”¶åˆ°tokené€šè¿‡éªŒè¯åå³å¯ç¡®è®¤ç”¨æˆ·èº«ä»½ã€‚\nä¼˜ç•¥åˆ†æ\nåŸºäºsessionçš„è®¤è¯æ–¹å¼ç”±Servletè§„èŒƒå®šåˆ¶ï¼ŒæœåŠ¡ç«¯è¦å­˜å‚¨sessionä¿¡æ¯éœ€è¦å ç”¨å†…å­˜èµ„æºï¼Œå®¢æˆ·ç«¯éœ€è¦æ”¯æŒcookieï¼›åŸºäºtokençš„æ–¹å¼åˆ™ä¸€èˆ¬ä¸éœ€è¦æœåŠ¡ç«¯å­˜å‚¨tokenï¼Œå¹¶ä¸”ä¸é™åˆ¶å®¢æˆ·ç«¯çš„å­˜å‚¨æ–¹å¼ã€‚å¦‚ä»Šç§»åŠ¨äº’è”ç½‘æ—¶ä»£æ›´å¤šç±»å‹çš„å®¢æˆ·ç«¯éœ€è¦æ¥å…¥ç³»ç»Ÿï¼Œç³»ç»Ÿå¤šæ˜¯é‡‡ç”¨å‰åç«¯åˆ†ç¦»çš„æ¶æ„è¿›è¡Œå®ç°ï¼Œæ‰€ä»¥åŸºäºtokençš„æ–¹å¼æ›´é€‚åˆã€‚\nä»€ä¹ˆæ˜¯æˆæƒæˆæƒæ˜¯ç”¨æˆ·è®¤è¯é€šè¿‡æ ¹æ®ç”¨æˆ·çš„æƒé™æ¥æ§åˆ¶ç”¨æˆ·è®¿é—®èµ„æºçš„è¿‡ç¨‹ï¼Œæ‹¥æœ‰èµ„æºçš„è®¿é—®æƒé™åˆ™æ­£å¸¸è®¿é—®ï¼Œæ²¡æœ‰æƒé™åˆ™æ‹’ç»è®¿é—®\nåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶\nRBACåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRole-Based Access Controlï¼‰æ˜¯æŒ‰è§’è‰²è¿›è¡Œæˆæƒï¼Œåˆ¤æ–­é€»è¾‘ï¼š\nif(ä¸»ä½“.hasRole(\"æ€»ç»ç†è§’è‰²id\"))&#123;\næŸ¥è¯¢å·¥èµ„\n&#125;\n\næŸ¥è¯¢å·¥èµ„æ‰€éœ€è¦çš„è§’è‰²å˜åŒ–ä¸ºæ€»ç»ç†å’Œéƒ¨é—¨ç»ç†\néœ€è¦ä¿®æ”¹åˆ¤æ–­é€»è¾‘ä¸ºâ€œåˆ¤æ–­ç”¨æˆ·çš„è§’è‰²æ˜¯å¦æ˜¯æ€»ç»ç†æˆ–éƒ¨é—¨ç»ç†â€\nif(ä¸»ä½“.hasRole(\"æ€»ç»ç†è§’è‰²id\") || ä¸»ä½“.hasRole(\"éƒ¨é—¨ç»ç†è§’è‰²id\"))&#123;\næŸ¥è¯¢å·¥èµ„\n&#125;\n\nå°±éœ€è¦ä¿®æ”¹æˆæƒçš„ç›¸å…³ä»£ç ï¼Œç³»ç»Ÿå¯æ‰©å±•æ€§å·®ã€‚\nåŸºäºèµ„æºçš„è®¿é—®æ§åˆ¶\nRBACåŸºäºèµ„æºçš„è®¿é—®æ§åˆ¶ï¼ˆResource-Based Access Controlï¼‰æ˜¯æŒ‰èµ„æºï¼ˆæˆ–æƒé™ï¼‰è¿›è¡Œæˆæƒã€‚\næˆæƒä»£ç å¯ä»¥è¡¨ç¤ºä¸ºï¼š\nif(ä¸»ä½“.hasPermission(&quot;æŸ¥è¯¢å·¥èµ„æƒé™æ ‡è¯†&quot;))&#123;\næŸ¥è¯¢å·¥èµ„\n&#125;\n\nä¼˜ç‚¹ï¼šç³»ç»Ÿè®¾è®¡æ—¶å®šä¹‰å¥½æŸ¥è¯¢å·¥èµ„çš„æƒé™æ ‡è¯†ï¼Œå³ä½¿æŸ¥è¯¢å·¥èµ„æ‰€éœ€è¦çš„è§’è‰²å˜åŒ–ä¸ºæ€»ç»ç†å’Œéƒ¨é—¨ç»ç†ä¹Ÿä¸éœ€è¦ä¿®æ”¹æˆæƒä»£ç ï¼Œç³»ç»Ÿå¯æ‰©å±•æ€§å¼ºã€‚\nåŸºäºSessionçš„è®¤è¯æ–¹å¼\nåŸºäºSessionçš„è®¤è¯æœºåˆ¶ç”±Servletè§„èŒƒå®šåˆ¶ï¼ŒServletå®¹å™¨å·²å®ç°ï¼Œç”¨æˆ·é€šè¿‡HttpSessionçš„æ“ä½œæ–¹æ³•å³å¯å®ç°ã€‚\næœ¬æ¡ˆä¾‹å·¥ç¨‹ä½¿ç”¨mavenè¿›è¡Œæ„å»ºï¼Œä½¿ç”¨SpringMVCã€Servlet3.0å®ç°ã€‚\n","slug":"åŸºäºsessionå®ç°è®¤è¯","date":"2023-05-18T14:10:28.000Z","categories_index":"","tags_index":"è®¤è¯æˆæƒ","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"ca0fb70bccc39b11cac4043db766085d","title":"MySQL_å­˜å‚¨å¼•æ“_ç´¢å¼•","content":"MySQLå­˜å‚¨å¼•æ“MySQLä½“ç³»ç»“æ„\nè¿æ¥å±‚\næœ€ä¸Šå±‚æ˜¯ä¸€äº›å®¢æˆ·ç«¯å’Œé“¾æ¥æœåŠ¡ï¼ŒåŒ…å«æœ¬åœ°sock é€šä¿¡å’Œå¤§å¤šæ•°åŸºäºå®¢æˆ·ç«¯&#x2F;æœåŠ¡ç«¯å·¥å…·å®ç°çš„ç±»ä¼¼äº\nTCP&#x2F;IPçš„é€šä¿¡ã€‚ä¸»è¦å®Œæˆä¸€äº›ç±»ä¼¼äºè¿æ¥å¤„ç†ã€æˆæƒè®¤è¯ã€åŠç›¸å…³çš„å®‰å…¨æ–¹æ¡ˆã€‚åœ¨è¯¥å±‚ä¸Šå¼•å…¥äº†çº¿ç¨‹\næ± çš„æ¦‚å¿µï¼Œä¸ºé€šè¿‡è®¤è¯å®‰å…¨æ¥å…¥çš„å®¢æˆ·ç«¯æä¾›çº¿ç¨‹ã€‚åŒæ ·åœ¨è¯¥å±‚ä¸Šå¯ä»¥å®ç°åŸºäºSSLçš„å®‰å…¨é“¾æ¥ã€‚æœåŠ¡\nå™¨ä¹Ÿä¼šä¸ºå®‰å…¨æ¥å…¥çš„æ¯ä¸ªå®¢æˆ·ç«¯éªŒè¯å®ƒæ‰€å…·æœ‰çš„æ“ä½œæƒé™ã€‚\næœåŠ¡å±‚\nç¬¬äºŒå±‚æ¶æ„ä¸»è¦å®Œæˆå¤§å¤šæ•°çš„æ ¸å¿ƒæœåŠ¡åŠŸèƒ½ï¼Œå¦‚SQLæ¥å£ï¼Œå¹¶å®Œæˆç¼“å­˜çš„æŸ¥è¯¢ï¼ŒSQLçš„åˆ†æå’Œä¼˜åŒ–ï¼Œéƒ¨\nåˆ†å†…ç½®å‡½æ•°çš„æ‰§è¡Œã€‚æ‰€æœ‰è·¨å­˜å‚¨å¼•æ“çš„åŠŸèƒ½ä¹Ÿåœ¨è¿™ä¸€å±‚å®ç°ï¼Œå¦‚ è¿‡ç¨‹ã€å‡½æ•°ç­‰ã€‚åœ¨è¯¥å±‚ï¼ŒæœåŠ¡å™¨ä¼šè§£\nææŸ¥è¯¢å¹¶åˆ›å»ºç›¸åº”çš„å†…éƒ¨è§£ææ ‘ï¼Œå¹¶å¯¹å…¶å®Œæˆç›¸åº”çš„ä¼˜åŒ–å¦‚ç¡®å®šè¡¨çš„æŸ¥è¯¢çš„é¡ºåºï¼Œæ˜¯å¦åˆ©ç”¨ç´¢å¼•ç­‰ï¼Œ\næœ€åç”Ÿæˆç›¸åº”çš„æ‰§è¡Œæ“ä½œã€‚å¦‚æœæ˜¯selectè¯­å¥ï¼ŒæœåŠ¡å™¨è¿˜ä¼šæŸ¥è¯¢å†…éƒ¨çš„ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜ç©ºé—´è¶³å¤Ÿå¤§ï¼Œ\nè¿™æ ·åœ¨è§£å†³å¤§é‡è¯»æ“ä½œçš„ç¯å¢ƒä¸­èƒ½å¤Ÿå¾ˆå¥½çš„æå‡ç³»ç»Ÿçš„æ€§èƒ½ã€‚\nå¼•æ“å±‚\nå­˜å‚¨å¼•æ“å±‚ï¼Œ å­˜å‚¨å¼•æ“çœŸæ­£çš„è´Ÿè´£äº†MySQLä¸­æ•°æ®çš„å­˜å‚¨å’Œæå–ï¼ŒæœåŠ¡å™¨é€šè¿‡APIå’Œå­˜å‚¨å¼•æ“è¿›è¡Œé€š\nä¿¡ã€‚ä¸åŒçš„å­˜å‚¨å¼•æ“å…·æœ‰ä¸åŒçš„åŠŸèƒ½ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦ï¼Œæ¥é€‰å–åˆé€‚çš„å­˜å‚¨å¼•æ“ã€‚æ•°æ®åº“\nä¸­çš„ç´¢å¼•æ˜¯åœ¨å­˜å‚¨å¼•æ“å±‚å®ç°çš„\nå­˜å‚¨å±‚\næ•°æ®å­˜å‚¨å±‚ï¼Œ ä¸»è¦æ˜¯å°†æ•°æ®(å¦‚: redologã€undologã€æ•°æ®ã€ç´¢å¼•ã€äºŒè¿›åˆ¶æ—¥å¿—ã€é”™è¯¯æ—¥å¿—ã€æŸ¥è¯¢\næ—¥å¿—ã€æ…¢æŸ¥è¯¢æ—¥å¿—ç­‰)å­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šï¼Œå¹¶å®Œæˆä¸å­˜å‚¨å¼•æ“çš„äº¤äº’ã€‚\nå…¶ä»–æ•°æ®åº“ç›¸æ¯”\nMySQLæœ‰ç‚¹ä¸ä¼—ä¸åŒï¼Œå®ƒçš„æ¶æ„å¯ä»¥åœ¨å¤šç§ä¸åŒåœºæ™¯ä¸­åº”ç”¨å¹¶å‘æŒ¥è‰¯å¥½ä½œç”¨ã€‚ä¸»è¦ä½“ç°åœ¨å­˜å‚¨å¼•æ“ä¸Šï¼Œæ’ä»¶å¼çš„å­˜å‚¨å¼•æ“æ¶æ„ï¼Œå°†æŸ¥è¯¢å¤„ç†å’Œå…¶ä»–çš„ç³»ç»Ÿä»»åŠ¡ä»¥åŠæ•°æ®çš„å­˜å‚¨æå–åˆ†ç¦»ï¼Œè¿™ç§æ¶æ„å¯ä»¥æ ¹æ®ä¸šåŠ¡çš„éœ€æ±‚å’Œå®é™…éœ€è¦é€‰æ‹©åˆé€‚çš„å­˜å‚¨å¼•æ“\nå­˜å‚¨å¼•æ“ä»‹ç»å­˜å‚¨å¼•æ“å°±æ˜¯å­˜å‚¨æ•°æ®ã€å»ºç«‹ç´¢å¼•ã€æ›´æ–°&#x2F;æŸ¥è¯¢æ•°æ®ç­‰æŠ€æœ¯çš„å®ç°æ–¹å¼ ã€‚å­˜å‚¨å¼•æ“æ˜¯åŸºäºè¡¨çš„ï¼Œè€Œä¸æ˜¯\nåŸºäºåº“çš„ï¼Œæ‰€ä»¥å­˜å‚¨å¼•æ“ä¹Ÿå¯è¢«ç§°ä¸ºè¡¨ç±»å‹ã€‚æˆ‘ä»¬å¯ä»¥åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™ï¼Œæ¥æŒ‡å®šé€‰æ‹©çš„å­˜å‚¨å¼•æ“ï¼Œå¦‚æœ\næ²¡æœ‰æŒ‡å®šå°†è‡ªåŠ¨é€‰æ‹©é»˜è®¤çš„å­˜å‚¨å¼•æ“ã€‚\tMySQLé»˜è®¤å­˜å‚¨å¼•æ“: InnoDB\n å»ºè¡¨æ—¶æŒ‡å®šå­˜å‚¨å¼•æ“\nCREATE TABLE è¡¨å(\nå­—æ®µ1 å­—æ®µ1ç±»å‹ [ COMMENT å­—æ®µ1æ³¨é‡Š ] ,\n......\nå­—æ®µn å­—æ®µnç±»å‹ [COMMENT å­—æ®µnæ³¨é‡Š ]\n) ENGINE = INNODB [ COMMENT è¡¨æ³¨é‡Š ] ;\n\næŸ¥è¯¢å½“å‰æ•°æ®åº“æ”¯æŒçš„å­˜å‚¨å¼•æ“\nshow engines;\n\nå­˜å‚¨å¼•æ“ç‰¹ç‚¹InnoDB\nInnoDBæ˜¯ä¸€ç§å…¼é¡¾é«˜å¯é æ€§å’Œé«˜æ€§èƒ½çš„é€šç”¨å­˜å‚¨å¼•æ“ï¼Œåœ¨ MySQL 5.5 ä¹‹åï¼ŒInnoDBæ˜¯é»˜è®¤çš„MySQL å­˜å‚¨å¼•æ“ã€‚\nç‰¹ç‚¹\n\nDMLæ“ä½œéµå¾ªACIDæ¨¡å‹ï¼Œæ”¯æŒäº‹åŠ¡ï¼›\n\nè¡Œçº§é”ï¼Œæé«˜å¹¶å‘è®¿é—®æ€§èƒ½ï¼›\n\næ”¯æŒå¤–é”®FOREIGN KEYçº¦æŸï¼Œä¿è¯æ•°æ®çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§ï¼›\n\n\næ–‡ä»¶\nxxx.ibdï¼šxxxä»£è¡¨çš„æ˜¯è¡¨åï¼ŒinnoDBå¼•æ“çš„æ¯å¼ è¡¨éƒ½ä¼šå¯¹åº”è¿™æ ·ä¸€ä¸ªè¡¨ç©ºé—´æ–‡ä»¶ï¼Œå­˜å‚¨è¯¥è¡¨çš„è¡¨ç»“æ„ï¼ˆfrm-æ—©æœŸçš„ ã€sdi-æ–°ç‰ˆçš„ï¼‰ã€æ•°æ®å’Œç´¢å¼•ã€‚\næŸ¥çœ‹å‚æ•°ï¼šinnodb_file_per_table\nshow variables like 'innodb_file_per_table';\n\nå¦‚æœè¯¥å‚æ•°å¼€å¯ï¼Œä»£è¡¨å¯¹äºInnoDBå¼•æ“çš„è¡¨ï¼Œæ¯ä¸€å¼ è¡¨éƒ½å¯¹åº”ä¸€ä¸ªibdæ–‡ä»¶ã€‚ \næ¯ä¸€ä¸ªibdæ–‡ä»¶å°±å¯¹åº”ä¸€å¼ è¡¨ï¼Œæ¯”å¦‚ï¼šæˆ‘ä»¬æœ‰ä¸€å¼ è¡¨ accountï¼Œå°±æœ‰è¿™æ ·çš„ä¸€ä¸ªaccount.ibdæ–‡ä»¶ï¼Œè€Œåœ¨è¿™ä¸ªibdæ–‡ä»¶ä¸­ä¸ä»…å­˜æ”¾è¡¨ç»“æ„ã€æ•°æ®ï¼Œè¿˜ä¼šå­˜æ”¾è¯¥è¡¨å¯¹åº”çš„ç´¢å¼•ä¿¡æ¯ã€‚ è€Œè¯¥æ–‡ä»¶æ˜¯åŸºäºäºŒè¿›åˆ¶å­˜å‚¨çš„ï¼Œä¸èƒ½ç›´æ¥åŸºäºè®°äº‹æœ¬æ‰“å¼€ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨mysqlæä¾›çš„ä¸€ä¸ªæŒ‡ä»¤ ibd2sdi ï¼Œé€šè¿‡è¯¥æŒ‡ä»¤å°±å¯ä»¥ä»ibdæ–‡ä»¶ä¸­æå–sdiä¿¡æ¯ï¼Œè€Œsdiæ•°æ®å­—å…¸ä¿¡æ¯ä¸­å°±åŒ…å«è¯¥è¡¨show variables like â€˜innodb_file_per_tableâ€™; \n é€»è¾‘å­˜å‚¨ç»“æ„\n\nè¡¨ç©ºé—´ : InnoDBå­˜å‚¨å¼•æ“é€»è¾‘ç»“æ„çš„æœ€é«˜å±‚ï¼Œibdæ–‡ä»¶å…¶å®å°±æ˜¯è¡¨ç©ºé—´æ–‡ä»¶ï¼Œåœ¨è¡¨ç©ºé—´ä¸­å¯ä»¥\nåŒ…å«å¤šä¸ªSegmentæ®µã€‚\næ®µ : è¡¨ç©ºé—´æ˜¯ç”±å„ä¸ªæ®µç»„æˆçš„ï¼Œ å¸¸è§çš„æ®µæœ‰æ•°æ®æ®µã€ç´¢å¼•æ®µã€å›æ»šæ®µç­‰ã€‚InnoDBä¸­å¯¹äºæ®µçš„ç®¡\nç†ï¼Œéƒ½æ˜¯å¼•æ“è‡ªèº«å®Œæˆï¼Œä¸éœ€è¦äººä¸ºå¯¹å…¶æ§åˆ¶ï¼Œä¸€ä¸ªæ®µä¸­åŒ…å«å¤šä¸ªåŒºã€‚\nåŒº : åŒºæ˜¯è¡¨ç©ºé—´çš„å•å…ƒç»“æ„ï¼Œæ¯ä¸ªåŒºçš„å¤§å°ä¸º1Mã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œ InnoDBå­˜å‚¨å¼•æ“é¡µå¤§å°ä¸º\n16Kï¼Œ å³ä¸€ä¸ªåŒºä¸­ä¸€å…±æœ‰64ä¸ªè¿ç»­çš„é¡µã€‚\né¡µ : é¡µæ˜¯ç»„æˆåŒºçš„æœ€å°å•å…ƒï¼Œé¡µä¹Ÿæ˜¯InnoDBå­˜å‚¨å¼•æ“ç£ç›˜ç®¡ç†çš„æœ€å°å•å…ƒï¼Œæ¯ä¸ªé¡µçš„å¤§å°é»˜\nè®¤ä¸º 16KBã€‚ä¸ºäº†ä¿è¯é¡µçš„è¿ç»­æ€§ï¼ŒInnoDB å­˜å‚¨å¼•æ“æ¯æ¬¡ä»ç£ç›˜ç”³è¯· 4-5 ä¸ªåŒºã€‚\nè¡Œ : InnoDB å­˜å‚¨å¼•æ“æ˜¯é¢å‘è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ•°æ®æ˜¯æŒ‰è¡Œè¿›è¡Œå­˜æ”¾çš„ï¼Œåœ¨æ¯ä¸€è¡Œä¸­é™¤äº†å®šä¹‰è¡¨æ—¶\næ‰€æŒ‡å®šçš„å­—æ®µä»¥å¤–ï¼Œè¿˜åŒ…å«ä¸¤ä¸ªéšè—å­—æ®µ(åé¢ä¼šè¯¦ç»†ä»‹ç»)\nMyISAM\nMyISAMæ˜¯MySQLæ—©æœŸçš„é»˜è®¤å­˜å‚¨å¼•æ“ã€‚\nç‰¹ç‚¹\n\nä¸æ”¯æŒäº‹åŠ¡ï¼Œä¸æ”¯æŒå¤–é”®\n\næ”¯æŒè¡¨é”ï¼Œä¸æ”¯æŒè¡Œé”\n\nè®¿é—®é€Ÿåº¦å¿«\n\n\n æ–‡ä»¶\nxxx.sdiï¼šå­˜å‚¨è¡¨ç»“æ„ä¿¡æ¯\nxxx.MYDï¼šå­˜å‚¨æ•°æ®\nxxx.MYIï¼šå­˜å‚¨ç´¢å¼•\nMemory\nMemoryå¼•æ“çš„è¡¨æ•°æ®æ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œç”±äºå—åˆ°ç¡¬ä»¶é—®é¢˜ã€æˆ–æ–­ç”µé—®é¢˜çš„å½±å“ï¼Œåªèƒ½å°†è¿™äº›è¡¨ä½œä¸ºä¸´æ—¶è¡¨æˆ–ç¼“å­˜ä½¿ç”¨\nç‰¹ç‚¹\nå†…å­˜å­˜æ”¾\n hashç´¢å¼•ï¼ˆé»˜è®¤ï¼‰\næ–‡ä»¶\nxxx.sdiï¼šå­˜å‚¨è¡¨ç»“æ„ä¿¡æ¯\nåŒºåˆ«åŠç‰¹ç‚¹\n\n\nç‰¹ç‚¹\nInnoDB\nMyISAM\nMemory\n\n\n\nå­˜å‚¨é™åˆ¶\n64TB\nå­˜åœ¨å—é™\nå­˜åœ¨å—é™\n\n\näº‹åŠ¡å®‰å…¨\næ”¯æŒ\nä¸æ”¯æŒ\nä¸æ”¯æŒ\n\n\né”æœºåˆ¶\nè¡¨é”ï¼Œè¡Œé”\nè¡¨é”\nè¡¨é”\n\n\nB+treeç´¢å¼•\næ”¯æŒ\næ”¯æŒ\næ”¯æŒ\n\n\nHashç´¢å¼•\nä¸æ”¯æŒ\nä¸æ”¯æŒ\næ”¯æŒ\n\n\nå…¨æ–‡ç´¢å¼•\næ”¯æŒ(5.6ç‰ˆæœ¬ä¹‹å)\næ”¯æŒ\nä¸æ”¯æŒ\n\n\nç©ºé—´ä½¿ç”¨\né«˜\nä½\nN&#x2F;A\n\n\nå†…å­˜ä½¿ç”¨\né«˜\nä½\nä¸­ç­‰\n\n\næ‰¹é‡æ’å…¥é€Ÿåº¦\nä½\né«˜\né«˜\n\n\næ”¯æŒå¤–é”®\næ”¯æŒ\nä¸æ”¯æŒ\nä¸æ”¯æŒ\n\n\nå­˜å‚¨å¼•æ“é€‰æ‹©\nåœ¨é€‰æ‹©å­˜å‚¨å¼•æ“æ—¶ï¼Œåº”è¯¥æ ¹æ®åº”ç”¨ç³»ç»Ÿçš„ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„å­˜å‚¨å¼•æ“ã€‚å¯¹äºå¤æ‚çš„åº”ç”¨ç³»ç»Ÿï¼Œè¿˜å¯ä»¥æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©å¤šç§å­˜å‚¨å¼•æ“è¿›è¡Œç»„åˆã€‚\nInnoDB: æ˜¯Mysqlçš„é»˜è®¤å­˜å‚¨å¼•æ“ï¼Œæ”¯æŒäº‹åŠ¡ã€å¤–é”®ã€‚å¦‚æœåº”ç”¨å¯¹äº‹åŠ¡çš„å®Œæ•´æ€§æœ‰æ¯”è¾ƒé«˜çš„è¦æ±‚ï¼Œåœ¨å¹¶å‘æ¡ä»¶ä¸‹è¦æ±‚æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæ•°æ®æ“ä½œé™¤äº†æ’å…¥å’ŒæŸ¥è¯¢ä¹‹å¤–ï¼Œè¿˜åŒ…å«å¾ˆå¤šçš„æ›´æ–°ã€åˆ é™¤æ“ä½œï¼Œé‚£ä¹ˆInnoDBå­˜å‚¨å¼•æ“æ˜¯æ¯”è¾ƒåˆé€‚çš„é€‰æ‹©ã€‚\nMyISAM ï¼š å¦‚æœåº”ç”¨æ˜¯ä»¥è¯»æ“ä½œå’Œæ’å…¥æ“ä½œä¸ºä¸»ï¼Œåªæœ‰å¾ˆå°‘çš„æ›´æ–°å’Œåˆ é™¤æ“ä½œï¼Œå¹¶ä¸”å¯¹äº‹åŠ¡çš„å®Œæ•´æ€§ã€å¹¶å‘æ€§è¦æ±‚ä¸æ˜¯å¾ˆé«˜ï¼Œé‚£ä¹ˆé€‰æ‹©è¿™ä¸ªå­˜å‚¨å¼•æ“æ˜¯éå¸¸åˆé€‚çš„ã€‚\nMEMORYï¼šå°†æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œè®¿é—®é€Ÿåº¦å¿«ï¼Œé€šå¸¸ç”¨äºä¸´æ—¶è¡¨åŠç¼“å­˜ã€‚MEMORYçš„ç¼ºé™·å°±æ˜¯å¯¹è¡¨çš„å¤§å°æœ‰é™åˆ¶ï¼Œå¤ªå¤§çš„è¡¨æ— æ³•ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œè€Œä¸”æ— æ³•ä¿éšœæ•°æ®çš„å®‰å…¨æ€§ã€‚\nç´¢å¼•ç´¢å¼•ï¼ˆindexï¼‰æ˜¯å¸®åŠ©MySQLé«˜æ•ˆè·å–æ•°æ®çš„æ•°æ®ç»“æ„(æœ‰åº)ã€‚åœ¨æ•°æ®ä¹‹å¤–ï¼Œæ•°æ®åº“ç³»ç»Ÿè¿˜ç»´æŠ¤ç€æ»¡è¶³ç‰¹å®šæŸ¥æ‰¾ç®—æ³•çš„æ•°æ®ç»“æ„ï¼Œè¿™äº›æ•°æ®ç»“æ„ä»¥æŸç§æ–¹å¼å¼•ç”¨ï¼ˆæŒ‡å‘ï¼‰æ•°æ®ï¼Œ è¿™æ ·å°±å¯ä»¥åœ¨è¿™äº›æ•°æ®ç»“æ„ä¸Šå®ç°é«˜çº§æŸ¥æ‰¾ç®—æ³•è¿™ç§æ•°æ®ç»“æ„å°±æ˜¯ç´¢å¼•ã€‚\nåœ¨æ— ç´¢å¼•æƒ…å†µä¸‹ï¼Œå°±éœ€è¦ä»ç¬¬ä¸€è¡Œå¼€å§‹æ‰«æï¼Œä¸€ç›´æ‰«æåˆ°æœ€åä¸€è¡Œï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º å…¨è¡¨æ‰«æï¼Œæ€§èƒ½å¾ˆä½ã€‚\nç´¢å¼•çš„ä¼˜ç•¥ \nä¼˜åŠ¿\n\næé«˜æ•°æ®æ£€ç´¢çš„æ•ˆç‡ï¼Œé™ä½æ•°æ®åº“çš„IOæˆæœ¬\né€šè¿‡ç´¢å¼•åˆ—å¯¹æ•°æ®è¿›è¡Œæ’åºï¼Œé™ä½æ•°æ®æ’åºçš„æˆæœ¬ï¼Œé™ä½CPUçš„æ¶ˆè€—ã€‚\n\nåŠ£åŠ¿\n\nç´¢å¼•åˆ—ä¹Ÿæ˜¯è¦å ç”¨ç©ºé—´çš„ã€‚\nç´¢å¼•å¤§å¤§æé«˜äº†æŸ¥è¯¢æ•ˆç‡ï¼ŒåŒæ—¶å´ä¹Ÿé™ä½æ›´æ–°è¡¨çš„é€Ÿåº¦ï¼Œå¦‚å¯¹è¡¨è¿›è¡ŒINSERTã€UPDATEã€DELETEæ—¶ï¼Œæ•ˆç‡é™ä½ã€‚\n\nç´¢å¼•ç»“æ„\nMySQLçš„ç´¢å¼•æ˜¯åœ¨å­˜å‚¨å¼•æ“å±‚å®ç°çš„ï¼Œä¸åŒçš„å­˜å‚¨å¼•æ“æœ‰ä¸åŒçš„ç´¢å¼•ç»“æ„ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ç§ï¼š\n\n\n\nç´¢å¼•ç»“æ„\næè¿°\n\n\n\nB+Treeç´¢å¼•\næœ€å¸¸è§çš„ç´¢å¼•ç±»å‹ï¼Œå¤§éƒ¨åˆ†å¼•æ“éƒ½æ”¯æŒ B+ æ ‘ç´¢å¼•\n\n\nHashç´¢å¼•\nåº•å±‚æ•°æ®ç»“æ„æ˜¯ç”¨å“ˆå¸Œè¡¨å®ç°çš„, åªæœ‰ç²¾ç¡®åŒ¹é…ç´¢å¼•åˆ—çš„æŸ¥è¯¢æ‰æœ‰æ•ˆ, ä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢\n\n\nR-tree(ç©ºé—´ç´¢å¼•ï¼‰\nç©ºé—´ç´¢å¼•æ˜¯MyISAMå¼•æ“çš„ä¸€ä¸ªç‰¹æ®Šç´¢å¼•ç±»å‹ï¼Œä¸»è¦ç”¨äºåœ°ç†ç©ºé—´æ•°æ®ç±»å‹ï¼Œé€šå¸¸ä½¿ç”¨è¾ƒå°‘\n\n\nFull-text(å…¨æ–‡ç´¢å¼•)\næ˜¯ä¸€ç§é€šè¿‡å»ºç«‹å€’æ’ç´¢å¼•,å¿«é€ŸåŒ¹é…æ–‡æ¡£çš„æ–¹å¼ã€‚ç±»ä¼¼äºLucene,Solr,ES\n\n\nä¸åŒçš„å­˜å‚¨å¼•æ“å¯¹äºç´¢å¼•ç»“æ„çš„æ”¯æŒæƒ…å†µã€‚\n\n\n\nç´¢å¼•\nInnoDB\nMyISAM\nMemory\n\n\n\nB+treeç´¢å¼•\næ”¯æŒ\næ”¯æŒ\næ”¯æŒ\n\n\nHash ç´¢å¼•\nä¸æ”¯æŒ\nä¸æ”¯æŒ\næ”¯æŒ\n\n\nR-tree ç´¢å¼•\nä¸æ”¯æŒ\næ”¯æŒ\nä¸æ”¯æŒ\n\n\nFull-text\n5.6ç‰ˆæœ¬ä¹‹åæ”¯æŒ\næ”¯æŒ\nä¸æ”¯æŒ\n\n\næˆ‘ä»¬å¹³å¸¸æ‰€è¯´çš„ç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰ç‰¹åˆ«æŒ‡æ˜ï¼Œéƒ½æ˜¯æŒ‡B+æ ‘ç»“æ„ç»„ç»‡çš„ç´¢å¼•ã€‚\näºŒå‰æ ‘\nâ€‹\tå‡å¦‚è¯´MySQLçš„ç´¢å¼•ç»“æ„é‡‡ç”¨äºŒå‰æ ‘çš„æ•°æ®ç»“æ„ï¼Œæ¯”è¾ƒç†æƒ³çš„ç»“æ„å¦‚ä¸‹ï¼š\n\nå¦‚æœä¸»é”®æ˜¯é¡ºåºæ’å…¥çš„ï¼Œåˆ™ä¼šå½¢æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œç»“æ„å¦‚ä¸‹ï¼š\n\næ‰€ä»¥ï¼Œå¦‚æœé€‰æ‹©äºŒå‰æ ‘ä½œä¸ºç´¢å¼•ç»“æ„ï¼Œä¼šå­˜åœ¨ä»¥ä¸‹ç¼ºç‚¹ï¼š\n\né¡ºåºæ’å…¥æ—¶ï¼Œä¼šå½¢æˆä¸€ä¸ªé“¾è¡¨ï¼ŒæŸ¥è¯¢æ€§èƒ½å¤§å¤§é™ä½ã€‚\n\nå¤§æ•°æ®é‡æƒ…å†µä¸‹ï¼Œå±‚çº§è¾ƒæ·±ï¼Œæ£€ç´¢é€Ÿåº¦æ…¢ã€‚\n\n\næˆ‘ä»¬å¯ä»¥é€‰æ‹©çº¢é»‘æ ‘ï¼Œçº¢é»‘æ ‘æ˜¯ä¸€é¢—è‡ªå¹³è¡¡äºŒå‰æ ‘ï¼Œé‚£è¿™æ ·å³ä½¿æ˜¯é¡ºåºæ’å…¥æ•°æ®ï¼Œæœ€ç»ˆå½¢æˆçš„æ•°æ®ç»“æ„ä¹Ÿæ˜¯ä¸€é¢—å¹³è¡¡çš„äºŒå‰æ ‘,ç»“æ„å¦‚ä¸‹\n\nä½†æ˜¯ï¼Œå³ä½¿å¦‚æ­¤ï¼Œç”±äºçº¢é»‘æ ‘ä¹Ÿæ˜¯ä¸€é¢—äºŒå‰æ ‘ï¼Œæ‰€ä»¥ä¹Ÿä¼šå­˜åœ¨ä¸€ä¸ªç¼ºç‚¹ï¼š\n\nå¤§æ•°æ®é‡æƒ…å†µä¸‹ï¼Œå±‚çº§è¾ƒæ·±ï¼Œæ£€ç´¢é€Ÿåº¦æ…¢\n\næ‰€ä»¥ï¼Œåœ¨MySQLçš„ç´¢å¼•ç»“æ„ä¸­ï¼Œå¹¶æ²¡æœ‰é€‰æ‹©äºŒå‰æ ‘æˆ–è€…çº¢é»‘æ ‘ï¼Œè€Œé€‰æ‹©çš„æ˜¯B+Treeã€‚\nB-Tree\nâ€‹\tBæ ‘æ˜¯ä¸€ç§å¤šå‰è·¯è¡¡æŸ¥æ‰¾æ ‘ï¼Œç›¸å¯¹äºäºŒå‰æ ‘ï¼ŒBæ ‘æ¯ä¸ªèŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªåˆ†æ”¯ï¼Œå³å¤šå‰ã€‚ä»¥ä¸€é¢—æœ€å¤§åº¦æ•°ï¼ˆæ ‘çš„åº¦æ•°æŒ‡çš„æ˜¯ä¸€ä¸ªèŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸ªæ•°ï¼‰ä¸º5(5é˜¶)çš„b-treeä¸ºä¾‹ï¼Œé‚£è¿™ä¸ªBæ ‘æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šå­˜å‚¨4ä¸ªkeyï¼Œ5ä¸ªæŒ‡é’ˆï¼š\n\nç‰¹ç‚¹ï¼š\n\n5é˜¶çš„Bæ ‘ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹æœ€å¤šå­˜å‚¨4ä¸ªkeyï¼Œå¯¹åº”5ä¸ªæŒ‡é’ˆã€‚\n\nä¸€æ—¦èŠ‚ç‚¹å­˜å‚¨çš„keyæ•°é‡åˆ°è¾¾5ï¼Œå°±ä¼šè£‚å˜ï¼Œä¸­é—´å…ƒç´ å‘ä¸Šåˆ†è£‚ã€‚\n\nåœ¨Bæ ‘ä¸­ï¼Œéå¶å­èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹éƒ½ä¼šå­˜æ”¾æ•°æ®ã€‚\n\n\nB+Tree\nâ€‹\tB+Treeæ˜¯B-Treeçš„å˜ç§ï¼Œæˆ‘ä»¬ä»¥ä¸€é¢—æœ€å¤§åº¦æ•°ï¼ˆmax-degreeï¼‰ä¸º4ï¼ˆ4é˜¶ï¼‰çš„b+treeä¸ºä¾‹ï¼Œæ¥çœ‹ä¸€ä¸‹å…¶ç»“æ„ç¤ºæ„å›¾ï¼š\n\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸¤éƒ¨åˆ†ï¼š\n\nç»¿è‰²æ¡†æ¡†èµ·æ¥çš„éƒ¨åˆ†ï¼Œæ˜¯ç´¢å¼•éƒ¨åˆ†ï¼Œä»…ä»…èµ·åˆ°ç´¢å¼•æ•°æ®çš„ä½œç”¨ï¼Œä¸å­˜å‚¨æ•°æ®ã€‚\n\nçº¢è‰²æ¡†æ¡†èµ·æ¥çš„éƒ¨åˆ†ï¼Œæ˜¯æ•°æ®å­˜å‚¨éƒ¨åˆ†ï¼Œåœ¨å…¶å¶å­èŠ‚ç‚¹ä¸­è¦å­˜å‚¨å…·ä½“çš„æ•°æ®ã€‚\n\n\nB+Tree ä¸ B-Treeç›¸æ¯”ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç‚¹åŒºåˆ«ï¼š\n\næ‰€æœ‰çš„æ•°æ®éƒ½ä¼šå‡ºç°åœ¨å¶å­èŠ‚ç‚¹ã€‚\n\nå¶å­èŠ‚ç‚¹å½¢æˆä¸€ä¸ªå•å‘é“¾è¡¨ã€‚\n\néå¶å­èŠ‚ç‚¹ä»…ä»…èµ·åˆ°ç´¢å¼•æ•°æ®ä½œç”¨ï¼Œå…·ä½“çš„æ•°æ®éƒ½æ˜¯åœ¨å¶å­èŠ‚ç‚¹å­˜æ”¾çš„ã€‚\n\n\nMySQLä¸­ä¼˜åŒ–ä¹‹åçš„B+Tree\nâ€‹\tMySQLç´¢å¼•æ•°æ®ç»“æ„å¯¹ç»å…¸çš„B+Treeè¿›è¡Œäº†ä¼˜åŒ–ã€‚åœ¨åŸB+Treeçš„åŸºç¡€ä¸Šï¼Œå¢åŠ ä¸€ä¸ªæŒ‡å‘ç›¸é‚»å¶å­èŠ‚ç‚¹çš„é“¾è¡¨æŒ‡é’ˆï¼Œå°±å½¢æˆäº†å¸¦æœ‰é¡ºåºæŒ‡é’ˆçš„B+Treeï¼Œæé«˜åŒºé—´è®¿é—®çš„æ€§èƒ½ï¼Œåˆ©äºæ’åºã€‚\n\nHash\nâ€‹\tMySQLä¸­é™¤äº†æ”¯æŒB+Treeç´¢å¼•ï¼Œè¿˜æ”¯æŒä¸€ç§ç´¢å¼•ç±»å‹â€”Hashç´¢å¼•ã€‚\n ç»“æ„\nâ€‹\tå“ˆå¸Œç´¢å¼•å°±æ˜¯é‡‡ç”¨ä¸€å®šçš„hashç®—æ³•ï¼Œå°†é”®å€¼æ¢ç®—æˆæ–°çš„hashå€¼ï¼Œæ˜ å°„åˆ°å¯¹åº”çš„æ§½ä½ä¸Šï¼Œç„¶åå­˜å‚¨åœ¨hashè¡¨ä¸­ã€‚å¦‚æœä¸¤ä¸ª(æˆ–å¤šä¸ª)é”®å€¼ï¼Œæ˜ å°„åˆ°ä¸€ä¸ªç›¸åŒçš„æ§½ä½ä¸Šï¼Œä»–ä»¬å°±äº§ç”Ÿäº†hashå†²çªï¼ˆä¹Ÿç§°ä¸ºhashç¢°æ’ï¼‰ï¼Œå¯ä»¥é€šè¿‡é“¾è¡¨æ¥è§£å†³ã€‚\n\nç‰¹ç‚¹\n\nHashç´¢å¼•åªèƒ½ç”¨äºå¯¹ç­‰æ¯”è¾ƒ(&#x3D;ï¼Œin)ï¼Œä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ï¼ˆbetweenï¼Œ&gt;ï¼Œ&lt; ï¼Œâ€¦ï¼‰\n\næ— æ³•åˆ©ç”¨ç´¢å¼•å®Œæˆæ’åºæ“ä½œ\n\næŸ¥è¯¢æ•ˆç‡é«˜ï¼Œé€šå¸¸(ä¸å­˜åœ¨hashå†²çªçš„æƒ…å†µ)åªéœ€è¦ä¸€æ¬¡æ£€ç´¢å°±å¯ä»¥äº†ï¼Œæ•ˆç‡é€šå¸¸è¦é«˜äºB+treeç´¢å¼•\n\n\n æ”¯æŒhashçš„å­˜å‚¨å¼•æ“\nåœ¨MySQLä¸­ï¼Œæ”¯æŒhashç´¢å¼•çš„æ˜¯Memoryå­˜å‚¨å¼•æ“ã€‚ è€ŒInnoDBä¸­å…·æœ‰è‡ªé€‚åº”hashåŠŸèƒ½ï¼Œhashç´¢å¼•æ˜¯InnoDBå­˜å‚¨å¼•æ“æ ¹æ®B+Treeç´¢å¼•åœ¨æŒ‡å®šæ¡ä»¶ä¸‹è‡ªåŠ¨æ„å»ºçš„ã€‚\nä¸ºä»€ä¹ˆInnoDBå­˜å‚¨å¼•æ“é€‰æ‹©ä½¿ç”¨B+treeç´¢å¼•ç»“æ„?\n\nç›¸å¯¹äºäºŒå‰æ ‘ï¼Œå±‚çº§æ›´å°‘ï¼Œæœç´¢æ•ˆç‡é«˜ï¼›\n\nå¯¹äºB-treeï¼Œæ— è®ºæ˜¯å¶å­èŠ‚ç‚¹è¿˜æ˜¯éå¶å­èŠ‚ç‚¹ï¼Œéƒ½ä¼šä¿å­˜æ•°æ®ï¼Œè¿™æ ·å¯¼è‡´ä¸€é¡µä¸­å­˜å‚¨\n\nçš„é”®å€¼å‡å°‘ï¼ŒæŒ‡é’ˆè·Ÿç€å‡å°‘ï¼Œè¦åŒæ ·ä¿å­˜å¤§é‡æ•°æ®ï¼Œåªèƒ½å¢åŠ æ ‘çš„é«˜åº¦ï¼Œå¯¼è‡´æ€§èƒ½é™ä½ï¼›\n\nç›¸å¯¹Hashç´¢å¼•ï¼ŒB+treeæ”¯æŒèŒƒå›´åŒ¹é…åŠæ’åºæ“ä½œï¼›\n\n\nç´¢å¼•åˆ†ç±»åœ¨MySQLæ•°æ®åº“ï¼Œå°†ç´¢å¼•çš„å…·ä½“ç±»å‹ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼šä¸»é”®ç´¢å¼•ã€å”¯ä¸€ç´¢å¼•ã€å¸¸è§„ç´¢å¼•ã€å…¨æ–‡ç´¢å¼•ã€‚\n\n\n\nåˆ†ç±»\nå«ä¹‰\nç‰¹ç‚¹\nå…³é”®å­—\n\n\n\nä¸»é”®ç´¢å¼•\né’ˆå¯¹äºè¡¨ä¸­ä¸»é”®åˆ›å»ºçš„ç´¢å¼•\né»˜è®¤è‡ªåŠ¨åˆ›å»º, åªèƒ½æœ‰ä¸€ä¸ª\nPRIMARY\n\n\nå”¯ä¸€ç´¢å¼•\né¿å…åŒä¸€ä¸ªè¡¨ä¸­æŸæ•°æ®åˆ—ä¸­çš„å€¼é‡å¤\nå¯ä»¥æœ‰å¤šä¸ª\nUNIQUE\n\n\nå¸¸è§„ç´¢å¼•\nå¿«é€Ÿå®šä½ç‰¹å®šæ•°æ®\nå¯ä»¥æœ‰å¤šä¸ª\n\n\n\nå…¨æ–‡ç´¢å¼•\nå…¨æ–‡ç´¢å¼•æŸ¥æ‰¾çš„æ˜¯æ–‡æœ¬ä¸­çš„å…³é”®è¯ï¼Œè€Œä¸æ˜¯æ¯”è¾ƒç´¢å¼•ä¸­çš„å€¼\nå¯ä»¥æœ‰å¤šä¸ª\nFULLTEXT\n\n\nèšé›†ç´¢å¼•&amp;äºŒçº§ç´¢å¼•\nåœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œæ ¹æ®ç´¢å¼•çš„å­˜å‚¨å½¢å¼ï¼Œåˆå¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§ï¼š\n\n\n\nåˆ†ç±»\nå«ä¹‰\nç‰¹ç‚¹\n\n\n\nèšé›†ç´¢å¼•(Clustered Index)\nå°†æ•°æ®å­˜å‚¨ä¸ç´¢å¼•æ”¾åˆ°äº†ä¸€å—ï¼Œç´¢å¼•ç»“æ„çš„å¶å­èŠ‚ç‚¹ä¿å­˜äº†è¡Œæ•°æ®\nå¿…é¡»æœ‰,è€Œä¸”åªæœ‰ä¸€ä¸ª\n\n\näºŒçº§ç´¢å¼•(Secondary Index)\nå°†æ•°æ®ä¸ç´¢å¼•åˆ†å¼€å­˜å‚¨ï¼Œç´¢å¼•ç»“æ„çš„å¶å­èŠ‚ç‚¹å…³è”çš„æ˜¯å¯¹åº”çš„ä¸»é”®\nå¯ä»¥å­˜åœ¨å¤šä¸ª\n\n\nèšé›†ç´¢å¼•é€‰å–è§„åˆ™:\n\nå¦‚æœå­˜åœ¨ä¸»é”®ï¼Œä¸»é”®ç´¢å¼•å°±æ˜¯èšé›†ç´¢å¼•ã€‚\n\nå¦‚æœä¸å­˜åœ¨ä¸»é”®ï¼Œå°†ä½¿ç”¨ç¬¬ä¸€ä¸ªå”¯ä¸€ï¼ˆUNIQUEï¼‰ç´¢å¼•ä½œä¸ºèšé›†ç´¢å¼•ã€‚\n\nå¦‚æœè¡¨æ²¡æœ‰ä¸»é”®ï¼Œæˆ–æ²¡æœ‰åˆé€‚çš„å”¯ä¸€ç´¢å¼•ï¼Œåˆ™InnoDBä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªrowidä½œä¸ºéšè—çš„èšé›†ç´¢å¼•\n\n\nèšé›†ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•çš„å…·ä½“ç»“æ„å¦‚ä¸‹ï¼š\n\nèšé›†ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¸‹æŒ‚çš„æ˜¯è¿™ä¸€è¡Œçš„æ•°æ® ã€‚\näºŒçº§ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¸‹æŒ‚çš„æ˜¯è¯¥å­—æ®µå€¼å¯¹åº”çš„ä¸»é”®å€¼ã€‚\nå½“æˆ‘ä»¬æ‰§è¡Œå¦‚ä¸‹çš„SQLè¯­å¥æ—¶ï¼Œå…·ä½“çš„æŸ¥æ‰¾è¿‡ç¨‹æ˜¯è¿™æ ·å­çš„ï¼š\n\n\nç”±äºæ˜¯æ ¹æ®nameå­—æ®µè¿›è¡ŒæŸ¥è¯¢ï¼Œæ‰€ä»¥å…ˆæ ¹æ®name&#x3D;â€™Armâ€™åˆ°nameå­—æ®µçš„äºŒçº§ç´¢å¼•ä¸­è¿›è¡ŒåŒ¹é…æŸ¥æ‰¾ã€‚ä½†æ˜¯åœ¨äºŒçº§ç´¢å¼•ä¸­åªèƒ½æŸ¥æ‰¾åˆ° Arm å¯¹åº”çš„ä¸»é”®å€¼ 10ã€‚\n\nç”±äºæŸ¥è¯¢è¿”å›çš„æ•°æ®æ˜¯*ï¼Œæ‰€ä»¥æ­¤æ—¶ï¼Œè¿˜éœ€è¦æ ¹æ®ä¸»é”®å€¼10ï¼Œåˆ°èšé›†ç´¢å¼•ä¸­æŸ¥æ‰¾10å¯¹åº”çš„è®°å½•ï¼Œæœ€ç»ˆæ‰¾åˆ°10å¯¹åº”çš„è¡Œrowã€‚\n\næœ€ç»ˆæ‹¿åˆ°è¿™ä¸€è¡Œçš„æ•°æ®ï¼Œç›´æ¥è¿”å›å³å¯ã€‚\n\n\nå›è¡¨æŸ¥è¯¢ï¼š è¿™ç§å…ˆåˆ°äºŒçº§ç´¢å¼•ä¸­æŸ¥æ‰¾æ•°æ®ï¼Œæ‰¾åˆ°ä¸»é”®å€¼ï¼Œç„¶åå†åˆ°èšé›†ç´¢å¼•ä¸­æ ¹æ®ä¸»é”®å€¼ï¼Œè·å–æ•°æ®çš„æ–¹å¼ï¼Œå°±ç§°ä¹‹ä¸ºå›è¡¨æŸ¥è¯¢ã€‚\nInnoDBä¸»é”®ç´¢å¼•çš„B+treeé«˜åº¦ä¸ºå¤šé«˜å‘¢?\nä¸€èˆ¬æ˜¯ä¸‰å±‚ï¼Œå¦‚æœæ ‘çš„é«˜åº¦ä¸º3ï¼Œåˆ™å¯ä»¥å­˜å‚¨ 2200w å·¦å³çš„è®°å½•\nç´¢å¼•è¯­æ³•åˆ›å»ºç´¢å¼•\nCREATE [ UNIQUE | FULLTEXT ] INDEX index_name ON table_name (index_col_name,... ) ;\n\næŸ¥çœ‹ç´¢å¼•\nSHOW INDEX FROM table_name ;\n\n åˆ é™¤ç´¢å¼•\nDROP INDEX index_name ON table_name ;\n\n å°æ¡ˆä¾‹ï¼š\ncreate table tb_user(\nid int primary key auto_increment comment 'ä¸»é”®',\nname varchar(50) not null comment 'ç”¨æˆ·å',\nphone varchar(11) not null comment 'æ‰‹æœºå·',\nemail varchar(100) comment 'é‚®ç®±',\nprofession varchar(11) comment 'ä¸“ä¸š',\nage tinyint unsigned comment 'å¹´é¾„',\ngender char(1) comment 'æ€§åˆ« , 1: ç”·, 2: å¥³',\nstatus char(1) comment 'çŠ¶æ€',\ncreatetime datetime comment 'åˆ›å»ºæ—¶é—´'\n) comment 'ç³»ç»Ÿç”¨æˆ·è¡¨';\n\n-- nameå­—æ®µä¸ºå§“åå­—æ®µï¼Œè¯¥å­—æ®µçš„å€¼å¯èƒ½ä¼šé‡å¤ï¼Œä¸ºè¯¥å­—æ®µåˆ›å»ºç´¢å¼•\ncreate index idx_user_name on tb_user(name);\n-- phoneæ‰‹æœºå·æ˜¯éç©ºï¼Œä¸”å”¯ä¸€ï¼Œä¸ºè¯¥å­—æ®µåˆ›å»ºå”¯ä¸€ç´¢å¼•\ncreate unique index idx_user_phone on tb_user(phone);\n--  ä¸ºprofessionã€ageã€statusåˆ›å»ºè”åˆç´¢å¼•ã€‚\ncreate index idx_user_pro_age_sta on tb_user(profession,age,status);\n-- ä¸ºemailå»ºç«‹åˆé€‚çš„ç´¢å¼•æ¥æå‡æŸ¥è¯¢æ•ˆç‡\ncreate index idx_email on tb_user(email);\n\nSQLæ€§èƒ½åˆ†æSQLæ‰§è¡Œé¢‘ç‡\nMySQL å®¢æˆ·ç«¯è¿æ¥æˆåŠŸåï¼Œé€šè¿‡ show [session|global] status å‘½ä»¤å¯ä»¥æä¾›æœåŠ¡å™¨çŠ¶æ€ä¿¡æ¯ã€‚é€šè¿‡å¦‚ä¸‹æŒ‡ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹å½“å‰æ•°æ®åº“çš„INSERTã€UPDATEã€DELETEã€SELECTçš„è®¿é—®é¢‘æ¬¡\n-- session æ˜¯æŸ¥çœ‹å½“å‰ä¼šè¯ ;\n-- global æ˜¯æŸ¥è¯¢å…¨å±€æ•°æ® ;\nSHOW GLOBAL STATUS LIKE 'Com_______';\n-- Com_delete: åˆ é™¤æ¬¡æ•°\n-- Com_select: æŸ¥è¯¢æ¬¡æ•°\n-- Com_update: æ›´æ–°æ¬¡æ•°\n-- Com_insert: æ’å…¥æ¬¡æ•°\n\né€šè¿‡ä¸Šè¿°æŒ‡ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹åˆ°å½“å‰æ•°æ®åº“åˆ°åº•æ˜¯ä»¥æŸ¥è¯¢ä¸ºä¸»ï¼Œè¿˜æ˜¯ä»¥å¢åˆ æ”¹ä¸ºä¸»ï¼Œä»è€Œä¸ºæ•°æ®åº“ä¼˜åŒ–æä¾›å‚è€ƒä¾æ®ã€‚ å¦‚æœæ˜¯ä»¥å¢åˆ æ”¹ä¸ºä¸»ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä¸å¯¹å…¶è¿›è¡Œç´¢å¼•çš„ä¼˜åŒ–ã€‚ å¦‚æœæ˜¯ä»¥æŸ¥è¯¢ä¸ºä¸»ï¼Œé‚£ä¹ˆå°±è¦è€ƒè™‘å¯¹æ•°æ®åº“çš„ç´¢å¼•è¿›è¡Œä¼˜åŒ–äº†ã€‚\næ…¢æŸ¥è¯¢æ—¥å¿—\næ…¢æŸ¥è¯¢æ—¥å¿—è®°å½•äº†æ‰€æœ‰æ‰§è¡Œæ—¶é—´è¶…è¿‡æŒ‡å®šå‚æ•°ï¼ˆlong_query_timeï¼Œå•ä½ï¼šç§’ï¼Œé»˜è®¤10ç§’ï¼‰çš„æ‰€æœ‰SQLè¯­å¥çš„æ—¥å¿—\nMySQLçš„æ…¢æŸ¥è¯¢æ—¥å¿—é»˜è®¤æ²¡æœ‰å¼€å¯ï¼Œå¯ä»¥æŸ¥çœ‹ä¸€ä¸‹ç³»ç»Ÿå˜é‡ slow_query_log\nå¦‚æœè¦å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œéœ€è¦åœ¨MySQLçš„é…ç½®æ–‡ä»¶ï¼ˆ&#x2F;etc&#x2F;my.cnfï¼‰ä¸­é…ç½®å¦‚ä¸‹ä¿¡æ¯ï¼š\n# å¼€å¯MySQLæ…¢æ—¥å¿—æŸ¥è¯¢å¼€å…³\nslow_query_log=1\n# è®¾ç½®æ…¢æ—¥å¿—çš„æ—¶é—´ä¸º2ç§’ï¼ŒSQLè¯­å¥æ‰§è¡Œæ—¶é—´è¶…è¿‡2ç§’ï¼Œå°±ä¼šè§†ä¸ºæ…¢æŸ¥è¯¢ï¼Œè®°å½•æ…¢æŸ¥è¯¢æ—¥å¿—\nlong_query_time=2\n\n\n\nprofileè¯¦æƒ…\nshow profiles èƒ½å¤Ÿåœ¨åšSQLä¼˜åŒ–æ—¶å¸®åŠ©æˆ‘ä»¬äº†è§£æ—¶é—´éƒ½è€—è´¹åˆ°å“ªé‡Œå»äº†ã€‚é€šè¿‡have_profilingå‚æ•°ï¼Œèƒ½å¤Ÿçœ‹åˆ°å½“å‰MySQLæ˜¯å¦æ”¯æŒprofileæ“ä½œï¼š\nSELECT @@have_profiling ;\n-- å¯ä»¥é€šè¿‡setè¯­å¥åœ¨session/globalçº§åˆ«å¼€å¯profiling\nset profiling = 1;\n\nå¼€å…³å·²ç»æ‰“å¼€äº†ï¼Œæ¥ä¸‹æ¥æ‰€æ‰§è¡Œçš„SQLè¯­å¥ï¼Œéƒ½ä¼šè¢«MySQLè®°å½•ï¼Œå¹¶è®°å½•æ‰§è¡Œæ—¶é—´æ¶ˆè€—åˆ°å“ªå„¿å»äº†ã€‚ æˆ‘ä»¬ç›´æ¥æ‰§è¡Œå¦‚ä¸‹çš„SQLè¯­å¥ï¼š\nselect * from tb_user;\nselect * from tb_user where id = 1;\nselect * from tb_user where name = 'ç™½èµ·';\nselect count(*) from tb_sku;\n\n\n-- æŸ¥çœ‹æ¯ä¸€æ¡SQLçš„è€—æ—¶åŸºæœ¬æƒ…å†µ\nshow profiles;\n\n-- æŸ¥çœ‹æŒ‡å®šquery_idçš„SQLè¯­å¥å„ä¸ªé˜¶æ®µçš„è€—æ—¶æƒ…å†µ\nshow profile for query query_id;\n\n-- æŸ¥çœ‹æŒ‡å®šquery_idçš„SQLè¯­å¥CPUçš„ä½¿ç”¨æƒ…å†µ\nshow profile cpu for query query_id;\n\nexplain\nEXPLAIN æˆ–è€… DESCå‘½ä»¤è·å– MySQL å¦‚ä½•æ‰§è¡Œ SELECT è¯­å¥çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬åœ¨ SELECT è¯­å¥æ‰§è¡Œè¿‡ç¨‹ä¸­è¡¨å¦‚ä½•è¿æ¥å’Œè¿æ¥çš„é¡ºåºã€‚\nè¯­æ³•:\n-- ç›´æ¥åœ¨selectè¯­å¥ä¹‹å‰åŠ ä¸Šå…³é”®å­— explain / desc\nEXPLAIN SELECT å­—æ®µåˆ—è¡¨ FROM è¡¨å WHERE æ¡ä»¶ ;\n\nExplain æ‰§è¡Œè®¡åˆ’ä¸­å„ä¸ªå­—æ®µçš„å«ä¹‰:\n\n\n\nå­—æ®µ\nå«ä¹‰\n\n\n\nid\nselectæŸ¥è¯¢çš„åºåˆ—å·ï¼Œè¡¨ç¤ºæŸ¥è¯¢ä¸­æ‰§è¡Œselectå­å¥æˆ–è€…æ˜¯æ“ä½œè¡¨çš„é¡ºåº(idç›¸åŒï¼Œæ‰§è¡Œé¡ºåºä»ä¸Šåˆ°ä¸‹ï¼›idä¸åŒï¼Œå€¼è¶Šå¤§ï¼Œè¶Šå…ˆæ‰§è¡Œ)\n\n\nselect_type\nè¡¨ç¤º SELECT çš„ç±»å‹ï¼Œå¸¸è§çš„å–å€¼æœ‰ SIMPLEï¼ˆç®€å•è¡¨ï¼Œå³ä¸ä½¿ç”¨è¡¨è¿æ¥æˆ–è€…å­æŸ¥è¯¢ï¼‰ã€PRIMARYï¼ˆä¸»æŸ¥è¯¢ï¼Œå³å¤–å±‚çš„æŸ¥è¯¢ï¼‰ã€UNIONï¼ˆUNION ä¸­çš„ç¬¬äºŒä¸ªæˆ–è€…åé¢çš„æŸ¥è¯¢è¯­å¥ï¼‰ã€SUBQUERYï¼ˆSELECT&#x2F;WHEREä¹‹ååŒ…å«äº†å­æŸ¥è¯¢ï¼‰ç­‰\n\n\ntype\nè¡¨ç¤ºè¿æ¥ç±»å‹ï¼Œæ€§èƒ½ç”±å¥½åˆ°å·®çš„è¿æ¥ç±»å‹ä¸ºNULLã€systemã€constã€eq_refã€refã€rangeã€ indexã€all ã€‚\n\n\npossible_key\næ˜¾ç¤ºå¯èƒ½åº”ç”¨åœ¨è¿™å¼ è¡¨ä¸Šçš„ç´¢å¼•ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªã€‚\n\n\nkey\nå®é™…ä½¿ç”¨çš„ç´¢å¼•ï¼Œå¦‚æœä¸ºNULLï¼Œåˆ™æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ã€‚\n\n\nkey_len\nè¡¨ç¤ºç´¢å¼•ä¸­ä½¿ç”¨çš„å­—èŠ‚æ•°ï¼Œ è¯¥å€¼ä¸ºç´¢å¼•å­—æ®µæœ€å¤§å¯èƒ½é•¿åº¦ï¼Œå¹¶éå®é™…ä½¿ç”¨é•¿åº¦ï¼Œåœ¨ä¸æŸå¤±ç²¾ç¡®æ€§çš„å‰æä¸‹ï¼Œ é•¿åº¦è¶ŠçŸ­è¶Šå¥½ ã€‚\n\n\nrows\nMySQLè®¤ä¸ºå¿…é¡»è¦æ‰§è¡ŒæŸ¥è¯¢çš„è¡Œæ•°ï¼Œåœ¨innodbå¼•æ“çš„è¡¨ä¸­ï¼Œæ˜¯ä¸€ä¸ªä¼°è®¡å€¼ï¼Œå¯èƒ½å¹¶ä¸æ€»æ˜¯å‡†ç¡®çš„ã€‚\n\n\nfiltered\nè¡¨ç¤ºè¿”å›ç»“æœçš„è¡Œæ•°å éœ€è¯»å–è¡Œæ•°çš„ç™¾åˆ†æ¯”ï¼Œ filtered çš„å€¼è¶Šå¤§è¶Šå¥½ã€‚\n\n\nç´¢å¼•ä½¿ç”¨tb_user è¡¨æ‰€åˆ›å»ºçš„ç´¢å¼•\n\næœ€å·¦å‰ç¼€æ³•åˆ™\nå¦‚æœç´¢å¼•äº†å¤šåˆ—ï¼ˆè”åˆç´¢å¼•ï¼‰ï¼Œè¦éµå®ˆæœ€å·¦å‰ç¼€æ³•åˆ™ã€‚æœ€å·¦å‰ç¼€æ³•åˆ™æŒ‡çš„æ˜¯æŸ¥è¯¢ä»ç´¢å¼•çš„æœ€å·¦åˆ—å¼€å§‹ï¼Œå¹¶ä¸”ä¸è·³è¿‡ç´¢å¼•ä¸­çš„åˆ—ã€‚å¦‚æœè·³è·ƒæŸä¸€åˆ—ï¼Œç´¢å¼•å°†ä¼šéƒ¨åˆ†å¤±æ•ˆ(åé¢çš„å­—æ®µç´¢å¼•å¤±æ•ˆ)\nåœ¨ tb_user è¡¨ä¸­ï¼Œæœ‰ä¸€ä¸ªè”åˆç´¢å¼•ï¼Œè¿™ä¸ªè”åˆç´¢å¼•æ¶‰åŠåˆ°ä¸‰ä¸ªå­—æ®µï¼Œé¡ºåºåˆ†åˆ«ä¸ºï¼šprofessionï¼Œageï¼Œstatusã€‚å¯¹äºæœ€å·¦å‰ç¼€æ³•åˆ™æŒ‡çš„æ˜¯ï¼ŒæŸ¥è¯¢æ—¶ï¼Œæœ€å·¦å˜çš„åˆ—ï¼Œä¹Ÿå°±æ˜¯professionå¿…é¡»å­˜åœ¨ï¼Œå¦åˆ™ç´¢å¼•å…¨éƒ¨å¤±æ•ˆã€‚è€Œä¸”ä¸­é—´ä¸èƒ½è·³è¿‡æŸä¸€åˆ—ï¼Œå¦åˆ™è¯¥åˆ—åé¢çš„å­—æ®µç´¢å¼•å°†å¤±æ•ˆã€‚ \nexplain select * from tb_user where profession = 'è½¯ä»¶å·¥ç¨‹' and age = 31 and status= '0';\n\n\nexplain select * from tb_user where profession = 'è½¯ä»¶å·¥ç¨‹' and age = 31;\n\n\nexplain select * from tb_user where profession = 'è½¯ä»¶å·¥ç¨‹';\n\n\nåªè¦è”åˆç´¢å¼•æœ€å·¦è¾¹çš„å­—æ®µ professionå­˜åœ¨ï¼Œç´¢å¼•å°±ç”Ÿæ•ˆï¼Œåªä¸è¿‡ç´¢å¼•çš„é•¿åº¦ä¸åŒã€‚ è€Œä¸”ç”±ä»¥ä¸Šä¸‰ç»„æµ‹è¯•ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ¨æµ‹å‡ºprofessionå­—æ®µç´¢å¼•é•¿åº¦ä¸º47ã€ageå­—æ®µç´¢å¼•é•¿åº¦ä¸º2ã€statuså­—æ®µç´¢å¼•é•¿åº¦ä¸º5ã€‚\nexplain select * from tb_user where age = 31 and status = '0';\n\n\nexplain select * from tb_user where status = '0';\n\n\nä¸Šé¢çš„è¿™ä¸¤ç»„æµ‹è¯•ï¼Œç´¢å¼•å¹¶æ²¡æœ‰ç”Ÿæ•ˆï¼ŒåŸå› æ˜¯å› ä¸ºä¸æ»¡è¶³æœ€å·¦å‰ç¼€æ³•åˆ™ï¼Œè”åˆç´¢å¼•æœ€å·¦è¾¹çš„åˆ—professionä¸å­˜åœ¨\nexplain select * from tb_user where profession = 'è½¯ä»¶å·¥ç¨‹' and status = '0';\n\n\nå­˜åœ¨professionå­—æ®µï¼Œæœ€å·¦è¾¹çš„åˆ—æ˜¯å­˜åœ¨çš„ï¼Œç´¢å¼•æ»¡è¶³æœ€å·¦å‰ç¼€æ³•åˆ™çš„åŸºæœ¬æ¡ä»¶ã€‚ä½†æ˜¯æŸ¥è¯¢æ—¶ï¼Œè·³è¿‡äº†ageè¿™ä¸ªåˆ—ï¼Œæ‰€ä»¥åé¢çš„åˆ—ç´¢å¼•æ˜¯ä¸ä¼šä½¿ç”¨çš„ï¼Œä¹Ÿå°±æ˜¯ç´¢å¼•éƒ¨åˆ†ç”Ÿæ•ˆï¼Œæ‰€ä»¥ç´¢å¼•çš„é•¿åº¦å°±æ˜¯47ã€‚\n-- æ‰“ä¹±é¡ºåºæµ‹è¯•\nexplain select * from tb_user where age = 31 and status = '0' and profession = 'è½¯ä»¶å·¥ç¨‹'ï¼›\n\n\næ˜¯å®Œå…¨æ»¡è¶³æœ€å·¦å‰ç¼€æ³•åˆ™çš„ï¼Œç´¢å¼•é•¿åº¦54ï¼Œè”åˆç´¢å¼•æ˜¯ç”Ÿæ•ˆçš„ã€‚\næœ€å·¦å‰ç¼€æ³•åˆ™ä¸­æŒ‡çš„æœ€å·¦è¾¹çš„åˆ—ï¼Œæ˜¯æŒ‡åœ¨æŸ¥è¯¢æ—¶ï¼Œè”åˆç´¢å¼•çš„æœ€å·¦è¾¹çš„å­—æ®µ(å³æ˜¯ç¬¬ä¸€ä¸ªå­—æ®µ)å¿…é¡»å­˜åœ¨ï¼Œä¸æˆ‘ä»¬ç¼–å†™SQLæ—¶ï¼Œæ¡ä»¶ç¼–å†™çš„å…ˆåé¡ºåºæ— å…³ã€‚\nèŒƒå›´æŸ¥è¯¢\nè”åˆç´¢å¼•ä¸­ï¼Œå‡ºç°èŒƒå›´æŸ¥è¯¢(&gt;,&lt;)ï¼ŒèŒƒå›´æŸ¥è¯¢å³ä¾§çš„åˆ—ç´¢å¼•å¤±æ•ˆã€‚\nexplain select * from tb_user where profession = 'è½¯ä»¶å·¥ç¨‹' and age > 30 and status = '0';\n\n\nèŒƒå›´æŸ¥è¯¢ä½¿ç”¨&gt; æˆ– &lt; æ—¶ï¼Œèµ°è”åˆç´¢å¼•äº†ï¼Œä½†æ˜¯ç´¢å¼•çš„é•¿åº¦ä¸º49ï¼Œè¯´æ˜èŒƒå›´æŸ¥è¯¢å³è¾¹çš„statuså­—æ®µæ˜¯æ²¡æœ‰èµ°ç´¢å¼•ã€‚\nexplain select * from tb_user where profession = 'è½¯ä»¶å·¥ç¨‹' and age >= 30 and status = '0';\n\n\nå½“èŒƒå›´æŸ¥è¯¢ä½¿ç”¨&gt;&#x3D; æˆ– &lt;&#x3D; æ—¶ï¼Œèµ°è”åˆç´¢å¼•äº†ï¼Œä½†æ˜¯ç´¢å¼•çš„é•¿åº¦ä¸º54ï¼Œå°±è¯´æ˜æ‰€æœ‰çš„å­—æ®µéƒ½æ˜¯èµ°ç´¢å¼•çš„ã€‚\næ‰€ä»¥ï¼Œå°½å¯èƒ½çš„ä½¿ç”¨ç±»ä¼¼äº &gt;&#x3D; æˆ– &lt;&#x3D; è¿™ç±»çš„èŒƒå›´æŸ¥è¯¢ï¼Œè€Œé¿å…ä½¿ç”¨ &gt; æˆ– &lt;\nç´¢å¼•å¤±æ•ˆæƒ…å†µ\nåœ¨ç´¢å¼•åˆ—ä¸Šè¿›è¡Œè¿ç®—æ“ä½œï¼Œ ç´¢å¼•å°†å¤±æ•ˆã€‚\nåœ¨tb_userè¡¨ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªphoneå­—æ®µçš„å•åˆ—ç´¢å¼•ã€‚\nå½“æ ¹æ®phoneå­—æ®µè¿›è¡Œç­‰å€¼åŒ¹é…æŸ¥è¯¢æ—¶, ç´¢å¼•ç”Ÿæ•ˆã€‚\nexplain select * from tb_user where phone = '17799990015';\n\n\n å½“æ ¹æ®phoneå­—æ®µè¿›è¡Œå‡½æ•°è¿ç®—æ“ä½œä¹‹åï¼Œç´¢å¼•å¤±æ•ˆã€‚Â·\nexplain select * from tb_user where substring(phone,10,2) = '15';\n\n\nå­—ç¬¦ä¸²ä¸åŠ å¼•å·\nå­—ç¬¦ä¸²ç±»å‹å­—æ®µä½¿ç”¨æ—¶ï¼Œä¸åŠ å¼•å·ï¼Œç´¢å¼•å°†å¤±æ•ˆã€‚\nexplain select * from tb_user where profession = 'è½¯ä»¶å·¥ç¨‹' and age = 31 and status = '0';\nexplain select * from tb_user where profession = 'è½¯ä»¶å·¥ç¨‹' and age = 31 and status = 0;\n\n\nexplain select * from tb_user where phone = '17799990015';\nexplain select * from tb_user where phone = 17799990015;\n\n\nå¦‚æœå­—ç¬¦ä¸²ä¸åŠ å•å¼•å·ï¼Œå¯¹äºæŸ¥è¯¢ç»“æœï¼Œæ²¡ä»€ä¹ˆå½±å“ï¼Œä½†æ˜¯æ•°æ®åº“å­˜åœ¨éšå¼ç±»å‹è½¬æ¢ï¼Œç´¢å¼•å°†å¤±æ•ˆ\næ¨¡ç³ŠæŸ¥è¯¢\nä»…ä»…æ˜¯å°¾éƒ¨æ¨¡ç³ŠåŒ¹é…ï¼Œç´¢å¼•ä¸ä¼šå¤±æ•ˆã€‚å¦‚æœæ˜¯å¤´éƒ¨æ¨¡ç³ŠåŒ¹é…ï¼Œç´¢å¼•å¤±æ•ˆ\næ ¹æ®professionå­—æ®µæŸ¥è¯¢ï¼Œç¬¦åˆæœ€å·¦å‰ç¼€æ³•åˆ™ï¼Œè”åˆç´¢å¼•æ˜¯å¯ä»¥ç”Ÿæ•ˆçš„ï¼Œæˆ‘ä»¬ä¸»è¦çœ‹ä¸€ä¸‹ï¼Œæ¨¡ç³ŠæŸ¥è¯¢æ—¶ï¼Œ%åŠ åœ¨å…³é”®å­—ä¹‹å‰ï¼Œå’ŒåŠ åœ¨å…³é”®å­—ä¹‹åçš„å½±å“\nexplain select * from tb_user where profession like 'è½¯ä»¶%';\nexplain select * from tb_user where profession like '%å·¥ç¨‹';\nexplain select * from tb_user where profession like '%å·¥%';\n\n\nåœ¨likeæ¨¡ç³ŠæŸ¥è¯¢ä¸­ï¼Œåœ¨å…³é”®å­—åé¢åŠ %ï¼Œç´¢å¼•å¯ä»¥ç”Ÿæ•ˆã€‚è€Œå¦‚æœåœ¨å…³é”®å­—å‰é¢åŠ äº†%ï¼Œç´¢å¼•å°†ä¼šå¤±æ•ˆ\n orè¿æ¥æ¡ä»¶\nç”¨oråˆ†å‰²å¼€çš„æ¡ä»¶ï¼Œ å¦‚æœorå‰çš„æ¡ä»¶ä¸­çš„åˆ—æœ‰ç´¢å¼•ï¼Œè€Œåé¢çš„åˆ—ä¸­æ²¡æœ‰ç´¢å¼•ï¼Œé‚£ä¹ˆæ¶‰åŠçš„ç´¢å¼•éƒ½ä¸ä¼šè¢«ç”¨åˆ°ã€‚\nexplain select * from tb_user where id = 10 or age = 23;\nexplain select * from tb_user where phone = '17799990017' or age = 23;\n\n\nç”±äºageæ²¡æœ‰ç´¢å¼•ï¼Œæ‰€ä»¥å³ä½¿idã€phoneæœ‰ç´¢å¼•ï¼Œç´¢å¼•ä¹Ÿä¼šå¤±æ•ˆã€‚æ‰€ä»¥éœ€è¦é’ˆå¯¹äºageä¹Ÿè¦å»ºç«‹ç´¢å¼•ã€‚\nç„¶åï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ageå­—æ®µå»ºç«‹ç´¢å¼•ã€‚\ncreate index idx_user_age on tb_user(age);\n\næˆ‘ä»¬å†æ¬¡æ‰§è¡Œä¸Šè¿°çš„SQLè¯­å¥ï¼Œçœ‹çœ‹å‰åæ‰§è¡Œè®¡åˆ’çš„å˜åŒ–ã€‚\nexplain select * from tb_user where id = 10 or age = 23;\nexplain select * from tb_user where phone = '17799990017' or age = 23;\n\n\nå½“orè¿æ¥çš„æ¡ä»¶ï¼Œå·¦å³ä¸¤ä¾§å­—æ®µéƒ½æœ‰ç´¢å¼•æ—¶ï¼Œç´¢å¼•æ‰ä¼šç”Ÿæ•ˆã€‚\n æ•°æ®åˆ†å¸ƒå½±å“\nå¦‚æœMySQLè¯„ä¼°ä½¿ç”¨ç´¢å¼•æ¯”å…¨è¡¨æ›´æ…¢ï¼Œåˆ™ä¸ä½¿ç”¨ç´¢å¼•ã€‚\nselect * from tb_user where phone >= '17799990005';\nselect * from tb_user where phone >= '17799990015';\n\n\n\nç›¸åŒçš„SQLè¯­å¥ï¼Œåªæ˜¯ä¼ å…¥çš„å­—æ®µå€¼ä¸åŒï¼Œæœ€ç»ˆçš„æ‰§è¡Œè®¡åˆ’ä¹Ÿå®Œå…¨ä¸ä¸€æ ·ã€‚\nå°±æ˜¯å› ä¸ºMySQLåœ¨æŸ¥è¯¢æ—¶ï¼Œä¼šè¯„ä¼°ä½¿ç”¨ç´¢å¼•çš„æ•ˆç‡ä¸èµ°å…¨è¡¨æ‰«æçš„æ•ˆç‡ï¼Œå¦‚æœèµ°å…¨è¡¨æ‰«ææ›´å¿«ï¼Œåˆ™æ”¾å¼ƒç´¢å¼•ï¼Œèµ°å…¨è¡¨æ‰«æã€‚ å› ä¸ºç´¢å¼•æ˜¯ç”¨æ¥ç´¢å¼•å°‘é‡æ•°æ®çš„ï¼Œå¦‚æœé€šè¿‡ç´¢å¼•æŸ¥è¯¢è¿”å›å¤§æ‰¹é‡çš„æ•°æ®ï¼Œåˆ™è¿˜ä¸å¦‚èµ°å…¨è¡¨æ‰«ææ¥çš„å¿«ï¼Œæ­¤æ—¶ç´¢å¼•å°±ä¼šå¤±æ•ˆã€‚\nis null ä¸ is not null æ“ä½œ\nexplain select * from tb_user where profession is null;\nexplain select * from tb_user where profession is not null;\n\n\nå°†professionå­—æ®µå€¼å…¨éƒ¨æ›´æ–°ä¸ºnullï¼Œå†æ¬¡æ‰§è¡Œä¸Šè¿°çš„ä¸¤æ¡SQLï¼ŒæŸ¥çœ‹SQLè¯­å¥çš„æ‰§è¡Œè®¡åˆ’ã€‚\nupdate tb_user set profession = null;\nexplain select * from tb_user where profession is null;\nexplain select * from tb_user where profession is not null;\n\n\nä¸€æ¨¡ä¸€æ ·çš„SQLè¯­å¥ï¼Œå…ˆåæ‰§è¡Œäº†ä¸¤æ¬¡ï¼Œç»“æœæŸ¥è¯¢è®¡åˆ’æ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿™æ˜¯å’Œæ•°æ®åº“çš„æ•°æ®åˆ†å¸ƒæœ‰å…³ç³»ã€‚æŸ¥è¯¢æ—¶MySQLä¼šè¯„ä¼°ï¼Œèµ°ç´¢å¼•å¿«ï¼Œè¿˜æ˜¯å…¨è¡¨æ‰«æå¿«ï¼Œå¦‚æœå…¨è¡¨æ‰«ææ›´å¿«ï¼Œåˆ™æ”¾å¼ƒç´¢å¼•èµ°å…¨è¡¨æ‰«æã€‚ å› æ­¤ï¼Œis null ã€is not nullæ˜¯å¦èµ°ç´¢å¼•ï¼Œå¾—å…·ä½“æƒ…å†µå…·ä½“åˆ†æï¼Œå¹¶ä¸æ˜¯å›ºå®šçš„ã€‚\nSQLæç¤ºç›®å‰tb_userè¡¨ç´¢å¼•æƒ…å†µå¦‚ä¸‹\n\nidx_user_age, idx_email è¿™ä¸¤ä¸ªç´¢å¼•ç›´æ¥åˆ é™¤\ndrop index idx_user_age on tb_user;\ndrop index idx_email on tb_user;\n\næ‰§è¡ŒSQLï¼ŒæŸ¥è¯¢èµ°äº†è”åˆç´¢å¼•\nexplain select * from tb_user where profession = 'è½¯ä»¶å·¥ç¨‹';\n\n\nåˆ›å»ºprofessionçš„å•åˆ—ç´¢å¼•\ncreate index idx_user_pro on tb_user(profession);\n\nå†æ¬¡æ‰§è¡ŒSQLè¯­å¥ï¼ŒæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼Œçœ‹çœ‹åˆ°åº•èµ°å“ªä¸ªç´¢å¼•\nexplain select * from tb_user where profession &#x3D; &#39;è½¯ä»¶å·¥ç¨‹&#39;;\n\n\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œpossible_keysä¸­ idx_user_pro_age_staï¼Œidx_user_pro è¿™ä¸¤ä¸ªç´¢å¼•éƒ½å¯èƒ½ç”¨åˆ°ï¼Œæœ€ç»ˆMySQLé€‰æ‹©äº†idx_user_pro_age_staç´¢å¼•ã€‚è¿™æ˜¯MySQLè‡ªåŠ¨é€‰æ‹©çš„ç»“æœã€‚\næ­¤æ—¶å°±å¯ä»¥å€ŸåŠ©äºMySQLçš„SQLæç¤ºæ¥å®Œæˆæ¥æŒ‡å®šä½¿ç”¨å“ªä¸ªç´¢å¼•\n use index ï¼š å»ºè®®MySQLä½¿ç”¨å“ªä¸€ä¸ªç´¢å¼•å®Œæˆæ­¤æ¬¡æŸ¥è¯¢ï¼ˆä»…ä»…æ˜¯å»ºè®®ï¼Œmysqlå†…éƒ¨è¿˜ä¼šå†æ¬¡è¿›è¡Œè¯„ä¼°ï¼‰ã€‚\nexplain select * from tb_user use index(idx_user_pro) where profession &#x3D; &#39;è½¯ä»¶å·¥ç¨‹&#39;;\n\n\n ignore index ï¼š å¿½ç•¥æŒ‡å®šçš„ç´¢å¼•ã€‚\nexplain select * from tb_user ignore index(idx_user_pro) where profession &#x3D; &#39;è½¯ä»¶å·¥ç¨‹&#39;;\n\n\n force index ï¼š å¼ºåˆ¶ä½¿ç”¨ç´¢å¼•ã€‚\nexplain select * from tb_user force index(idx_user_pro_age_sta) where profession &#x3D;\n&#39;è½¯ä»¶å·¥ç¨‹&#39;;\n\n\nè¦†ç›–ç´¢å¼•\nè¦†ç›–ç´¢å¼•æ˜¯æŒ‡æŸ¥è¯¢ä½¿ç”¨äº†ç´¢å¼•ï¼Œå¹¶ä¸”éœ€è¦è¿”å›çš„åˆ—ï¼Œåœ¨è¯¥ç´¢å¼•ä¸­å·²ç»å…¨éƒ¨èƒ½å¤Ÿæ‰¾åˆ° ã€‚\nå°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œå‡å°‘select *\næŸ¥çœ‹ä¸€ç»„SQLçš„æ‰§è¡Œè®¡åˆ’\nexplain select id, profession from tb_user where profession = 'è½¯ä»¶å·¥ç¨‹' and age =\n31 and status = '0' ;\n\nexplain select id,profession,age, status from tb_user where profession = 'è½¯ä»¶å·¥ç¨‹'\nand age = 31 and status = '0' ;\n\nexplain select id,profession,age, status, name from tb_user where profession = 'è½¯\nä»¶å·¥ç¨‹' and age = 31 and status = '0' ;\n\nexplain select * from tb_user where profession = 'è½¯ä»¶å·¥ç¨‹' and age = 31 and status\n= '0';\n\næ‰§è¡Œç»“æœä¸º:\n\nè¿™å››æ¡SQLè¯­å¥çš„æ‰§è¡Œè®¡åˆ’å‰é¢æ‰€æœ‰çš„æŒ‡æ ‡éƒ½æ˜¯ä¸€æ ·çš„ï¼Œçœ‹ä¸å‡ºæ¥å·®å¼‚ã€‚ä½†æ˜¯æ­¤æ—¶ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨çš„æ˜¯åé¢çš„Extraï¼Œå‰é¢ä¸¤å¤©SQLçš„ç»“æœä¸º Using where; Using Index ; è€Œåé¢ä¸¤æ¡SQLçš„ç»“æœä¸º: Using index condition ã€‚\n\n\n\nExtra\nå«ä¹‰\n\n\n\nUsing where; Using Index\næŸ¥æ‰¾ä½¿ç”¨äº†ç´¢å¼•ï¼Œä½†æ˜¯éœ€è¦çš„æ•°æ®éƒ½åœ¨ç´¢å¼•åˆ—ä¸­èƒ½æ‰¾åˆ°ï¼Œæ‰€ä»¥ä¸éœ€è¦å›è¡¨æŸ¥è¯¢æ•°æ®\n\n\nUsing index condition\næŸ¥æ‰¾ä½¿ç”¨äº†ç´¢å¼•ï¼Œä½†æ˜¯éœ€è¦å›è¡¨æŸ¥è¯¢æ•°æ®\n\n\nå› ä¸ºï¼Œåœ¨tb_userè¡¨ä¸­æœ‰ä¸€ä¸ªè”åˆç´¢å¼• idx_user_pro_age_staï¼Œè¯¥ç´¢å¼•å…³è”äº†ä¸‰ä¸ªå­—æ®µprofessionã€ageã€statusï¼Œè€Œè¿™ä¸ªç´¢å¼•ä¹Ÿæ˜¯ä¸€ä¸ªäºŒçº§ç´¢å¼•ï¼Œæ‰€ä»¥å¶å­èŠ‚ç‚¹ä¸‹é¢æŒ‚çš„æ˜¯è¿™ä¸€è¡Œçš„ä¸»é”®idã€‚ æ‰€ä»¥å½“æˆ‘ä»¬æŸ¥è¯¢è¿”å›çš„æ•°æ®åœ¨ idã€professionã€ageã€status ä¹‹ä¸­ï¼Œåˆ™ç›´æ¥èµ°äºŒçº§ç´¢å¼•ç›´æ¥è¿”å›æ•°æ®äº†ã€‚ å¦‚æœè¶…å‡ºè¿™ä¸ªèŒƒå›´ï¼Œå°±éœ€è¦æ‹¿åˆ°ä¸»é”®idï¼Œå†å»æ‰«æèšé›†ç´¢å¼•ï¼Œå†è·å–é¢å¤–çš„æ•°æ®äº†ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯å›è¡¨ã€‚ è€Œæˆ‘ä»¬å¦‚æœä¸€ç›´ä½¿ç”¨select * æŸ¥è¯¢è¿”å›æ‰€æœ‰å­—æ®µå€¼ï¼Œå¾ˆå®¹æ˜“å°±ä¼šé€ æˆå›è¡¨æŸ¥è¯¢ï¼ˆé™¤éæ˜¯æ ¹æ®ä¸»é”®æŸ¥è¯¢ï¼Œæ­¤æ—¶åªä¼šæ‰«æèšé›†ç´¢å¼•ï¼‰\nä»€ä¹ˆæ˜¯è¦†ç›–ç´¢å¼•ï¼Œä»€ä¹ˆæ˜¯å›è¡¨æŸ¥è¯¢\n è¡¨ç»“æ„åŠç´¢å¼•ç¤ºæ„å›¾\n\nidæ˜¯ä¸»é”®ï¼Œæ˜¯ä¸€ä¸ªèšé›†ç´¢å¼•ã€‚ nameå­—æ®µå»ºç«‹äº†æ™®é€šç´¢å¼•ï¼Œæ˜¯ä¸€ä¸ªäºŒçº§ç´¢å¼•ï¼ˆè¾…åŠ©ç´¢å¼•ï¼‰ã€‚\næ‰§è¡ŒSQL :\nselect * from tb_user where id &#x3D; 2;\n\n\næ ¹æ®idæŸ¥è¯¢ï¼Œç›´æ¥èµ°èšé›†ç´¢å¼•æŸ¥è¯¢ï¼Œä¸€æ¬¡ç´¢å¼•æ‰«æï¼Œç›´æ¥è¿”å›æ•°æ®ï¼Œæ€§èƒ½é«˜ã€‚\næ‰§è¡ŒSQL\nselet id,name from tb_user where name &#x3D; &#39;Arm&#39;\n\n\nè™½ç„¶æ˜¯æ ¹æ®nameå­—æ®µæŸ¥è¯¢ï¼ŒæŸ¥è¯¢äºŒçº§ç´¢å¼•ï¼Œä½†æ˜¯ç”±äºæŸ¥è¯¢è¿”å›åœ¨å­—æ®µä¸º idï¼Œnameï¼Œåœ¨nameçš„äºŒçº§ç´¢å¼•ä¸­ï¼Œè¿™ä¸¤ä¸ªå€¼éƒ½æ˜¯å¯ä»¥ç›´æ¥è·å–åˆ°çš„ï¼Œå› ä¸ºè¦†ç›–ç´¢å¼•ï¼Œæ‰€ä»¥ä¸éœ€è¦å›è¡¨æŸ¥è¯¢ï¼Œæ€§èƒ½é«˜ã€‚\næ‰§è¡ŒSQL\nselet id,name,gender from tb_user where name &#x3D; &#39;Arm&#39;;\n\n\nç”±äºåœ¨nameçš„äºŒçº§ç´¢å¼•ä¸­ï¼Œä¸åŒ…å«genderï¼Œæ‰€ä»¥ï¼Œéœ€è¦ä¸¤æ¬¡ç´¢å¼•æ‰«æï¼Œä¹Ÿå°±æ˜¯éœ€è¦å›è¡¨æŸ¥è¯¢ï¼Œæ€§èƒ½ç›¸å¯¹è¾ƒå·®ä¸€ç‚¹\nå‰ç¼€ç´¢å¼•\nå½“å­—æ®µç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼ˆvarcharï¼Œtextï¼Œlongtextç­‰ï¼‰æ—¶ï¼Œæœ‰æ—¶å€™éœ€è¦ç´¢å¼•å¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼Œè¿™ä¼šè®©ç´¢å¼•å˜å¾—å¾ˆå¤§ï¼ŒæŸ¥è¯¢æ—¶ï¼Œæµªè´¹å¤§é‡çš„ç£ç›˜IOï¼Œ å½±å“æŸ¥è¯¢æ•ˆç‡ã€‚æ­¤æ—¶å¯ä»¥åªå°†å­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ†å‰ç¼€ï¼Œå»ºç«‹ç´¢å¼•ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§èŠ‚çº¦ç´¢å¼•ç©ºé—´ï¼Œä»è€Œæé«˜ç´¢å¼•æ•ˆç‡ã€‚\nè¯­æ³•\ncreate index idx_xxxx on table_name(column(n)) ;\n\nä¸ºtb_userè¡¨çš„emailå­—æ®µï¼Œå»ºç«‹é•¿åº¦ä¸º5çš„å‰ç¼€ç´¢å¼•ã€‚\ncreate index idx_email_5 on tb_user(email(5));\n\n\nå‰ç¼€é•¿åº¦\nå¯ä»¥æ ¹æ®ç´¢å¼•çš„é€‰æ‹©æ€§æ¥å†³å®šï¼Œè€Œé€‰æ‹©æ€§æ˜¯æŒ‡ä¸é‡å¤çš„ç´¢å¼•å€¼ï¼ˆåŸºæ•°ï¼‰å’Œæ•°æ®è¡¨çš„è®°å½•æ€»æ•°çš„æ¯”å€¼ï¼Œç´¢å¼•é€‰æ‹©æ€§è¶Šé«˜åˆ™æŸ¥è¯¢æ•ˆç‡è¶Šé«˜ï¼Œ å”¯ä¸€ç´¢å¼•çš„é€‰æ‹©æ€§æ˜¯1ï¼Œè¿™æ˜¯æœ€å¥½çš„ç´¢å¼•é€‰æ‹©æ€§ï¼Œæ€§èƒ½ä¹Ÿæ˜¯æœ€å¥½çš„ã€‚\nselect count(distinct email) &#x2F; count(*) from tb_user ;\nselect count(distinct substring(email,1,5)) &#x2F; count(*) from tb_user ;\n\nå‰ç¼€ç´¢å¼•çš„æŸ¥è¯¢æµç¨‹\n\nå•åˆ—ç´¢å¼•ä¸è”åˆç´¢å¼•\nå•åˆ—ç´¢å¼•ï¼šå³ä¸€ä¸ªç´¢å¼•åªåŒ…å«å•ä¸ªåˆ—ã€‚\nè”åˆç´¢å¼•ï¼šå³ä¸€ä¸ªç´¢å¼•åŒ…å«äº†å¤šä¸ªåˆ—ã€‚\ntb_user è¡¨ä¸­çš„ç´¢å¼•æƒ…å†µ\n\næ‰§è¡Œä¸€æ¡SQLè¯­å¥ï¼Œçœ‹çœ‹å…¶æ‰§è¡Œè®¡åˆ’ï¼š\nexplain select id,phone,name from tb_stu where phone &#x3D; &#39;17799990010&#39; and name &#x3D; &#39;éŸ©ä¿¡&#39;;\n\nåœ¨andè¿æ¥çš„ä¸¤ä¸ªå­—æ®µ phoneã€nameä¸Šéƒ½æ˜¯æœ‰å•åˆ—ç´¢å¼•çš„ï¼Œä½†æ˜¯æœ€ç»ˆmysqlåªä¼šé€‰æ‹©ä¸€ä¸ªç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªèƒ½èµ°ä¸€ä¸ªå­—æ®µçš„ç´¢å¼•ï¼Œæ­¤æ—¶æ˜¯ä¼šå›è¡¨æŸ¥è¯¢çš„ã€‚\nå†åˆ›å»ºä¸€ä¸ªphoneå’Œnameå­—æ®µçš„è”åˆç´¢å¼•æ¥æŸ¥è¯¢ä¸€ä¸‹æ‰§è¡Œè®¡åˆ’\ncreate unique index idx_user_phone_name on tb_user(phone,name);\n\nexplain select id,phone,name from tb_stu where phone &#x3D; &#39;17799990010&#39; and name &#x3D; &#39;éŸ©ä¿¡&#39;;\n\n\nå¦‚æœå­˜åœ¨å¤šä¸ªæŸ¥è¯¢æ¡ä»¶ï¼Œè€ƒè™‘é’ˆå¯¹äºæŸ¥è¯¢å­—æ®µå»ºç«‹ç´¢å¼•æ—¶ï¼Œå»ºè®®å»ºç«‹è”åˆç´¢å¼•ï¼Œè€Œéå•åˆ—ç´¢å¼•ã€‚\nè”åˆç´¢å¼•å…·ä½“çš„ç»“æ„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š\n\nç´¢å¼•è®¾è®¡åŸåˆ™\né’ˆå¯¹äºæ•°æ®é‡è¾ƒå¤§ï¼Œä¸”æŸ¥è¯¢æ¯”è¾ƒé¢‘ç¹çš„è¡¨å»ºç«‹ç´¢å¼•ã€‚\n\né’ˆå¯¹äºå¸¸ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ï¼ˆwhereï¼‰ã€æ’åºï¼ˆorder byï¼‰ã€åˆ†ç»„ï¼ˆgroup byï¼‰æ“ä½œçš„å­—æ®µå»ºç«‹ç´¢å¼•ã€‚\n\nå°½é‡é€‰æ‹©åŒºåˆ†åº¦é«˜çš„åˆ—ä½œä¸ºç´¢å¼•ï¼Œå°½é‡å»ºç«‹å”¯ä¸€ç´¢å¼•ï¼ŒåŒºåˆ†åº¦è¶Šé«˜ï¼Œä½¿ç”¨ç´¢å¼•çš„æ•ˆç‡è¶Šé«˜ã€‚\n\nå¦‚æœæ˜¯å­—ç¬¦ä¸²ç±»å‹çš„å­—æ®µï¼Œå­—æ®µçš„é•¿åº¦è¾ƒé•¿ï¼Œå¯ä»¥é’ˆå¯¹äºå­—æ®µçš„ç‰¹ç‚¹ï¼Œå»ºç«‹å‰ç¼€ç´¢å¼•ã€‚\n\nå°½é‡ä½¿ç”¨è”åˆç´¢å¼•ï¼Œå‡å°‘å•åˆ—ç´¢å¼•ï¼ŒæŸ¥è¯¢æ—¶ï¼Œè”åˆç´¢å¼•å¾ˆå¤šæ—¶å€™å¯ä»¥è¦†ç›–ç´¢å¼•ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´ï¼Œé¿å…å›è¡¨ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚\n\nè¦æ§åˆ¶ç´¢å¼•çš„æ•°é‡ï¼Œç´¢å¼•å¹¶ä¸æ˜¯å¤šå¤šç›Šå–„ï¼Œç´¢å¼•è¶Šå¤šï¼Œç»´æŠ¤ç´¢å¼•ç»“æ„çš„ä»£ä»·ä¹Ÿå°±è¶Šå¤§ï¼Œä¼šå½±å“å¢åˆ æ”¹çš„æ•ˆç‡ã€‚\n\nå¦‚æœç´¢å¼•åˆ—ä¸èƒ½å­˜å‚¨NULLå€¼ï¼Œè¯·åœ¨åˆ›å»ºè¡¨æ—¶ä½¿ç”¨NOT NULLçº¦æŸå®ƒã€‚å½“ä¼˜åŒ–å™¨çŸ¥é“æ¯åˆ—æ˜¯å¦åŒ…å«NULLå€¼æ—¶ï¼Œå®ƒå¯ä»¥æ›´å¥½åœ°ç¡®å®šå“ªä¸ªç´¢å¼•æœ€æœ‰æ•ˆåœ°ç”¨äºæŸ¥è¯¢ã€‚\n\n\n","slug":"MySQL-å­˜å‚¨å¼•æ“-ç´¢å¼•","date":"2023-05-18T02:31:14.000Z","categories_index":"","tags_index":"MySQL","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"c1f6d722cc4602038235f2e7924e8ff2","title":"MySQLäº‹åŠ¡","content":"äº‹åŠ¡äº‹åŠ¡ æ˜¯ä¸€ç»„æ“ä½œçš„é›†åˆï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ï¼Œäº‹åŠ¡ä¼šæŠŠæ‰€æœ‰çš„æ“ä½œä½œä¸ºä¸€ä¸ªæ•´ä½“ä¸€èµ·å‘ç³»\nç»Ÿæäº¤æˆ–æ’¤é”€æ“ä½œè¯·æ±‚ï¼Œå³è¿™äº›æ“ä½œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ã€‚\né»˜è®¤MySQLçš„äº‹åŠ¡æ˜¯è‡ªåŠ¨æäº¤çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æ‰§è¡Œå®Œä¸€æ¡DMLè¯­å¥æ—¶ï¼ŒMySQLä¼šç«‹å³éš\nå¼çš„æäº¤äº‹åŠ¡ã€‚\näº‹åŠ¡æ“ä½œæœªæ§åˆ¶äº‹åŠ¡\næµ‹è¯•æ­£å¸¸æƒ…å†µ\n-- 1. æŸ¥è¯¢å¼ ä¸‰ä½™é¢\nselect * from account where name = 'å¼ ä¸‰';\n-- 2. å¼ ä¸‰çš„ä½™é¢å‡å°‘1000\nupdate account set money = money - 1000 where name = 'å¼ ä¸‰';\n-- 3. æå››çš„ä½™é¢å¢åŠ 1000\nupdate account set money = money + 1000 where name = 'æå››';\n\nå¯ä»¥çœ‹åˆ°æ•°æ®æ“ä½œå‰åæ˜¯ä¸€è‡´çš„ã€‚\næµ‹è¯•å¼‚å¸¸æƒ…å†µ\n-- 1. æŸ¥è¯¢å¼ ä¸‰ä½™é¢\nselect * from account where name = 'å¼ ä¸‰';\n-- 2. å¼ ä¸‰çš„ä½™é¢å‡å°‘1000\nupdate account set money = money - 1000 where name = 'å¼ ä¸‰';\nå‡ºé”™äº†....\n-- 3. æå››çš„ä½™é¢å¢åŠ 1000\nupdate account set money = money + 1000 where name = 'æå››';\n\n(å‡ºé”™äº†â€¦.) è¿™å¥è¯ä¸ç¬¦åˆSQLè¯­æ³•,æ‰§è¡Œå°±ä¼šæŠ¥é”™ï¼Œæ£€æŸ¥æœ€ç»ˆçš„æ•°æ®æƒ…å†µ, å‘ç°æ•°æ®åœ¨æ“ä½œå‰åä¸ä¸€è‡´äº†ã€‚\næ§åˆ¶äº‹åŠ¡\næŸ¥çœ‹&#x2F;è®¾ç½®äº‹åŠ¡æäº¤æ–¹å¼\nselect @@autocommit;\n-- autocommitä¸º1æ ‡è¯†å¼€å¯äº‹åŠ¡è‡ªåŠ¨æäº¤   ä¸º0è¡¨ç¤ºæ‰‹åŠ¨æäº¤äº‹åŠ¡\nset @@autocommit = 0;\n\næäº¤äº‹åŠ¡\ncommit;\n\nå›æ»šäº‹åŠ¡\nrollback;\n\nå¼€å¯äº‹åŠ¡\nstart transaction;\n-- æˆ–è€…\nbegin;\n\nè½¬è´¦æ¡ˆä¾‹ï¼š\n-- å¼€å¯äº‹åŠ¡\nstart transaction\n-- 1. æŸ¥è¯¢å¼ ä¸‰ä½™é¢\nselect * from account where name = 'å¼ ä¸‰';\n-- 2. å¼ ä¸‰çš„ä½™é¢å‡å°‘1000\nupdate account set money = money - 1000 where name = 'å¼ ä¸‰';\n-- 3. æå››çš„ä½™é¢å¢åŠ 1000\nupdate account set money = money + 1000 where name = 'æå››';\n-- å¦‚æœæ­£å¸¸æ‰§è¡Œå®Œæ¯•, åˆ™æäº¤äº‹åŠ¡\ncommit;\n-- å¦‚æœæ‰§è¡Œè¿‡ç¨‹ä¸­æŠ¥é”™, åˆ™å›æ»šäº‹åŠ¡\n-- rollback;\n\näº‹åŠ¡å››å¤§ç‰¹æ€§åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šäº‹åŠ¡æ˜¯ä¸å¯åˆ†å‰²çš„æœ€å°æ“ä½œå•å…ƒï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚\nä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šäº‹åŠ¡å®Œæˆæ—¶ï¼Œå¿…é¡»ä½¿æ‰€æœ‰çš„æ•°æ®éƒ½ä¿æŒä¸€è‡´çŠ¶æ€ã€‚\néš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šæ•°æ®åº“ç³»ç»Ÿæä¾›çš„éš”ç¦»æœºåˆ¶ï¼Œä¿è¯äº‹åŠ¡åœ¨ä¸å—å¤–éƒ¨å¹¶å‘æ“ä½œå½±å“çš„ç‹¬ç«‹ç¯å¢ƒä¸‹è¿è¡Œã€‚\næŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šäº‹åŠ¡ä¸€æ—¦æäº¤æˆ–å›æ»šï¼Œå®ƒå¯¹æ•°æ®åº“ä¸­çš„æ•°æ®çš„æ”¹å˜å°±æ˜¯æ°¸ä¹…çš„ã€‚\nä¸Šè¿°å°±æ˜¯äº‹åŠ¡çš„å››å¤§ç‰¹æ€§ï¼Œç®€ç§°ACIDã€‚\nå¹¶å‘äº‹åŠ¡é—®é¢˜\n èµƒè¯»ï¼šä¸€ä¸ªäº‹åŠ¡è¯»åˆ°å¦å¤–ä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ã€‚\n\næ¯”å¦‚Bè¯»å–åˆ°äº†Aæœªæäº¤çš„æ•°æ®ã€‚\nä¸å¯é‡å¤è¯»ï¼šä¸€ä¸ªäº‹åŠ¡å…ˆåè¯»å–åŒä¸€æ¡è®°å½•ï¼Œä½†ä¸¤æ¬¡è¯»å–çš„æ•°æ®ä¸åŒï¼Œç§°ä¹‹ä¸ºä¸å¯é‡å¤è¯»\n\n äº‹åŠ¡Aä¸¤æ¬¡è¯»å–åŒä¸€æ¡è®°å½•ï¼Œä½†æ˜¯è¯»å–åˆ°çš„æ•°æ®å´æ˜¯ä¸ä¸€æ ·çš„ã€‚\n å¹»è¯»ï¼šä¸€ä¸ªäº‹åŠ¡æŒ‰ç…§æ¡ä»¶æŸ¥è¯¢æ•°æ®æ—¶ï¼Œæ²¡æœ‰å¯¹åº”çš„æ•°æ®è¡Œï¼Œä½†æ˜¯åœ¨æ’å…¥æ•°æ®æ—¶ï¼Œåˆå‘ç°è¿™è¡Œæ•°æ®å·²ç»å­˜åœ¨ï¼Œå¥½åƒå‡ºç°äº† â€œå¹»å½±â€ã€‚\n\näº‹åŠ¡éš”ç¦»çº§åˆ«\n\n\n\néš”ç¦»çº§åˆ«\nè„è¯»\nä¸å¯é‡å¤è¯»\nå¹»è¯»\n\n\n\nRead uncommitted\nå­˜åœ¨\nå­˜åœ¨\nå­˜åœ¨\n\n\nRead committed\nä¸å­˜åœ¨\nå­˜åœ¨\nå­˜åœ¨\n\n\nRepeatable Read(default)\nä¸å­˜åœ¨\nä¸å­˜åœ¨\nå­˜åœ¨\n\n\nSerializable\nä¸å­˜åœ¨\nä¸å­˜åœ¨\nä¸å­˜åœ¨\n\n\n æŸ¥çœ‹äº‹åŠ¡éš”ç¦»çº§åˆ«\nselect @@TRANSACTION_IOSLATION;\n\nè®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«\nSET [SESSION | GLOBAL] TRANSACTION IOSLATION LEVEL\n[READ COMMITTED | READ UNCOMMITTED | REPEATABLE READ | SERIALIZABLE]\n\näº‹åŠ¡éš”ç¦»çº§åˆ«è¶Šé«˜ï¼Œæ•°æ®è¶Šå®‰å…¨ï¼Œä½†æ˜¯æ€§èƒ½è¶Šä½ã€‚\n","slug":"MySQL-äº‹åŠ¡","date":"2023-05-17T13:51:38.000Z","categories_index":"","tags_index":"MySQL","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"f293b2fcfae54b8509d50db2914ed7a0","title":"MySQL_çº¦æŸ_å¤šè¡¨æŸ¥è¯¢","content":"çº¦æŸæ¦‚å¿µï¼šçº¦æŸæ˜¯ä½œç”¨äºè¡¨ä¸­å­—æ®µä¸Šçš„è§„åˆ™ï¼Œç”¨äºé™åˆ¶å­˜å‚¨åœ¨è¡¨ä¸­çš„æ•°æ®ã€‚\nç›®çš„ï¼šä¿è¯æ•°æ®åº“ä¸­æ•°æ®çš„æ­£ç¡®ã€æœ‰æ•ˆæ€§å’Œå®Œæ•´æ€§ã€‚\n\n\n\nçº¦æŸ\næè¿°\nå…³é”®è¯\n\n\n\néç©ºçº¦æŸ\né™åˆ¶è¯¥å­—æ®µçš„æ•°æ®ä¸èƒ½ä¸ºnull\nNOT NULL\n\n\nå”¯ä¸€çº¦æŸ\nä¿è¯è¯¥å­—æ®µçš„æ‰€æœ‰æ•°æ®éƒ½æ˜¯å”¯ä¸€ã€ä¸é‡å¤çš„\nUNIQUE\n\n\nä¸»é”®çº¦æŸ\nä¸»é”®æ˜¯ä¸€è¡Œæ•°æ®çš„å”¯ä¸€æ ‡è¯†ï¼Œè¦æ±‚éç©ºä¸”å”¯ä¸€\nPRIMARY KEY\n\n\né»˜è®¤çº¦æŸ\nä¿å­˜æ•°æ®æ—¶ï¼Œå¦‚æœæœªæŒ‡å®šè¯¥å­—æ®µçš„å€¼ï¼Œåˆ™é‡‡ç”¨é»˜è®¤å€¼\nDEFAULT\n\n\næ£€æŸ¥çº¦æŸ(8.0.16ç‰ˆæœ¬ä¹‹å)\nä¿è¯å­—æ®µå€¼æ»¡è¶³æŸä¸€ä¸ªæ¡ä»¶\nCHECK\n\n\nå¤–é”®çº¦æŸ\nç”¨æ¥è®©ä¸¤å¼ è¡¨çš„æ•°æ®ä¹‹é—´å»ºç«‹è¿æ¥ï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§\nFOREIGN KEY\n\n\nçº¦æŸæ˜¯ä½œç”¨äºè¡¨ä¸­å­—æ®µä¸Šçš„ï¼Œå¯ä»¥åœ¨åˆ›å»ºè¡¨&#x2F;ä¿®æ”¹è¡¨çš„æ—¶å€™æ·»åŠ çº¦æŸã€‚\ncreate table tb_user(\nid int primary key auto_increment comment 'IDå”¯ä¸€æ ‡è¯†',\nname varchar(10) not null unique comment 'å§“å',\nage int check (age between 0 and 120) comment 'å¹´é¾„',\nstatus char(1) default 1 comment 'çŠ¶æ€',\ngender char(1) comment 'æ€§åˆ«'\n)comment 'å­¦ç”Ÿè¡¨';\n\nå¤–é”®çº¦æŸ\nå¤–é”®ï¼šç”¨æ¥è®©ä¸¤å¼ è¡¨çš„æ•°æ®ä¹‹é—´å»ºç«‹è¿æ¥ï¼Œä»è€Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ã€‚\ncreate table dept(\n\tid int auto_increment primary key comment 'ID',\n    name varchar(50) not null comment 'éƒ¨é—¨åç§°',    \n)comment 'éƒ¨é—¨è¡¨';\n\nCREATE TABLE `emp` (\n  `id` int DEFAULT NULL COMMENT 'ç¼–å·',\n  `workno` varchar(10) DEFAULT NULL,\n  `name` varchar(10) DEFAULT NULL COMMENT 'å§“å',\n  `gender` char(1) DEFAULT NULL COMMENT 'æ€§åˆ«',\n  `age` tinyint unsigned DEFAULT NULL COMMENT 'å¹´é¾„',\n  `idcard` char(18) DEFAULT NULL COMMENT 'èº«ä»½è¯å·',\n  `workaddress` varchar(50) DEFAULT NULL COMMENT 'å·¥ä½œåœ°å€',\n  `entrydate` date DEFAULT NULL COMMENT 'å…¥èŒæ—¶é—´',\n  `dept_id` int DEFAULT '1' COMMENT 'éƒ¨é—¨id'\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='å‘˜å·¥è¡¨'\n\nä¸ºempè¡¨çš„dept_idå­—æ®µæ·»åŠ å¤–é”®çº¦æŸ,å…³è”deptè¡¨çš„ä¸»é”®idã€‚\nalter table emp add constraint fk_emp_dept foreign key(dept_id) references dept(id);\n\nå‘½ä»¤ä¸­çš„ â€œalter table empâ€ è¡¨ç¤ºå°†è¦ä¿®æ”¹çš„è¡¨æ˜¯ empï¼Œâ€œadd constraintâ€ è¡¨ç¤ºæ·»åŠ ä¸€ä¸ªçº¦æŸï¼Œâ€œfk_emp_dept_idâ€ æ˜¯è¿™ä¸ªçº¦æŸçš„åç§°ï¼Œâ€œforeign key (dept_id)â€ è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¤–é”®çº¦æŸï¼Œå…³è”çš„åˆ—æ˜¯ emp è¡¨ä¸­çš„ dept_id åˆ—ï¼Œâ€œreferences dept(id)â€ è¡¨ç¤ºå¤–é”®å¼•ç”¨äº† dept è¡¨çš„ id åˆ—ã€‚è¿™ä¸ªçº¦æŸçš„ä½œç”¨æ˜¯ç¡®ä¿ emp è¡¨ä¸­çš„ dept_id å€¼å¿…é¡»åœ¨ dept è¡¨çš„ id åˆ—ä¸­å­˜åœ¨ï¼Œä»è€Œä¿è¯äº†å‚ç…§å®Œæ•´æ€§ã€‚\næ·»åŠ äº†å¤–é”®çº¦æŸä¹‹åï¼Œæˆ‘ä»¬å†åˆ°deptè¡¨(çˆ¶è¡¨)åˆ é™¤idä¸º1çš„è®°å½•ï¼Œç„¶åçœ‹ä¸€ä¸‹ä¼šå‘ç”Ÿä»€ä¹ˆç°è±¡ã€‚ æ­¤æ—¶å°†ä¼šæŠ¥é”™ï¼Œä¸èƒ½åˆ é™¤æˆ–æ›´æ–°çˆ¶è¡¨è®°å½•ï¼Œå› ä¸ºå­˜åœ¨å¤–é”®çº¦æŸã€‚\n1451 - Cannot delete or update a parent row: a foreign key constraint fails (hj.emp, CONSTRAINT fk_emp_dept FOREIGN KEY (dept_id) REFERENCES dept (id))\n åˆ é™¤å¤–é”®\nALTER TABLE è¡¨å DROP FOREIGN KEY å¤–é”®åç§°;\n\nalter table emp drop foreign key fk_emp_dept;\n\nåˆ é™¤&#x2F;æ›´æ–°è¡Œä¸º\næ·»åŠ äº†å¤–é”®ä¹‹åï¼Œå†åˆ é™¤çˆ¶è¡¨æ•°æ®æ—¶äº§ç”Ÿçš„çº¦æŸè¡Œä¸ºï¼Œæˆ‘ä»¬å°±ç§°ä¸ºåˆ é™¤&#x2F;æ›´æ–°è¡Œä¸ºã€‚\nå…·ä½“çš„åˆ é™¤&#x2F;æ›´æ–°è¡Œä¸ºæœ‰ä»¥ä¸‹å‡ ç§:\n\n\n\nè¡Œä¸º\nè¯´æ˜\n\n\n\nNO ACTION\nå½“åœ¨çˆ¶è¡¨ä¸­åˆ é™¤&#x2F;æ›´æ–°å¯¹åº”è®°å½•æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥è¯¥è®°å½•æ˜¯å¦æœ‰å¯¹åº”å¤–é”®ï¼Œå¦‚æœæœ‰åˆ™ä¸å…è®¸åˆ é™¤&#x2F;æ›´æ–°ã€‚ (ä¸ RESTRICT ä¸€è‡´) é»˜è®¤è¡Œä¸º\n\n\nRESTRICT\nå½“åœ¨çˆ¶è¡¨ä¸­åˆ é™¤&#x2F;æ›´æ–°å¯¹åº”è®°å½•æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥è¯¥è®°å½•æ˜¯å¦æœ‰å¯¹åº”å¤–é”®ï¼Œå¦‚æœæœ‰åˆ™ä¸å…è®¸åˆ é™¤&#x2F;æ›´æ–°ã€‚ (ä¸ NO ACTION ä¸€è‡´) é»˜è®¤è¡Œä¸º\n\n\nCASCADE\nå½“åœ¨çˆ¶è¡¨ä¸­åˆ é™¤&#x2F;æ›´æ–°å¯¹åº”è®°å½•æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥è¯¥è®°å½•æ˜¯å¦æœ‰å¯¹åº”å¤–é”®ï¼Œå¦‚æœæœ‰ï¼Œåˆ™ä¹Ÿåˆ é™¤&#x2F;æ›´æ–°å¤–é”®åœ¨å­è¡¨ä¸­çš„è®°å½•ã€‚\n\n\nSET NULL\nå½“åœ¨çˆ¶è¡¨ä¸­åˆ é™¤å¯¹åº”è®°å½•æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥è¯¥è®°å½•æ˜¯å¦æœ‰å¯¹åº”å¤–é”®ï¼Œå¦‚æœæœ‰åˆ™è®¾ç½®å­è¡¨ä¸­è¯¥å¤–é”®å€¼ä¸ºnullï¼ˆè¿™å°±è¦æ±‚è¯¥å¤–é”®å…è®¸å–nullï¼‰ã€‚\n\n\nSET DEFAULT\nçˆ¶è¡¨æœ‰å˜æ›´æ—¶ï¼Œå­è¡¨å°†å¤–é”®åˆ—è®¾ç½®æˆä¸€ä¸ªé»˜è®¤çš„å€¼ (Innodbä¸æ”¯æŒ)\n\n\nå…·ä½“è¯­æ³•ä¸º:\nALTER TABLE è¡¨å ADD CONSTRAINT å¤–é”®åç§° FOREIGN KEY (å¤–é”®å­—æ®µ) REFERENCES\nä¸»è¡¨å (ä¸»è¡¨å­—æ®µå) ON UPDATE è¡Œä¸º ON DELETE è¡Œä¸º;\n\nå°æ¡ˆä¾‹ï¼šCASCADEè¡Œä¸ºä¸‹  ä¿®æ”¹çˆ¶è¡¨idä¸º1çš„è®°å½•ï¼Œå°†idä¿®æ”¹ä¸º6\nalter table emp add constraint kf_emp_dept_id foreign key (dept_id) references dept(id)\non update cascade on delete cascade;\n\nupdate dept set id = 6 where id = 1;\n\ndelete form dept where id = 6;\n\næˆ‘ä»¬å‘ç°:\nåŸæ¥åœ¨å­è¡¨ä¸­dept_idå€¼ä¸º1çš„è®°å½•ï¼Œç°åœ¨ä¹Ÿå˜ä¸º6äº†ï¼Œè¿™å°±æ˜¯cascadeçº§è”çš„æ•ˆæœã€‚\nçˆ¶è¡¨çš„æ•°æ®åˆ é™¤æˆåŠŸäº†ï¼Œä½†æ˜¯å­è¡¨ä¸­å…³è”çš„è®°å½•ä¹Ÿè¢«çº§è”åˆ é™¤äº†ã€‚\n SET NULL\nalter table emp add constraint fk_emp_dept_id foreign key (dept_id) references dept(id)\non update set null on delete set null;\n\ndelete from dept where id = 3;\n\nupdate dept set id = 7 where id = 5;\n\nçˆ¶è¡¨çš„è®°å½•æ˜¯å¯ä»¥æ­£å¸¸çš„åˆ é™¤çš„ï¼Œçˆ¶è¡¨çš„æ•°æ®åˆ é™¤&#x2F;è·Ÿæ–°ä¹‹åï¼Œå†æ‰“å¼€å­è¡¨ empï¼Œæˆ‘ä»¬å‘ç°å­è¡¨empçš„dept_idå­—æ®µï¼ŒåŸæ¥dept_idä¸º1çš„æ•°æ®ï¼Œç°åœ¨éƒ½è¢«ç½®ä¸ºNULLäº†ã€‚\nå¤šè¡¨æŸ¥è¯¢å¤šè¡¨å…³ç³»ä¸€å¯¹å¤š(å¤šå¯¹ä¸€) \nå¦‚ï¼šéƒ¨é—¨ ä¸ å‘˜å·¥çš„å…³ç³»ï¼Œä¸€ä¸ªéƒ¨é—¨å¯¹åº”å¤šä¸ªå‘˜å·¥ï¼Œä¸€ä¸ªå‘˜å·¥å¯¹åº”ä¸€ä¸ªéƒ¨é—¨\nå®ç°: åœ¨å¤šçš„ä¸€æ–¹å»ºç«‹å¤–é”®ï¼ŒæŒ‡å‘ä¸€çš„ä¸€æ–¹çš„ä¸»é”®\ncreate table emp(\nid int auto_increment comment 'ID' primary key,\nname varchar(50) not null comment 'å§“å',\nage int comment 'å¹´é¾„',\njob varchar(20) comment 'èŒä½',\nsalary int comment 'è–ªèµ„',\nentrydate date comment 'å…¥èŒæ—¶é—´',\nmanagerid int comment 'ç›´å±é¢†å¯¼ID',\ndept_id int comment 'éƒ¨é—¨ID',\nconstraint fk_emp_dept_id foreign key (dept_id) references dept(id)\non update cascade on delete cascade\n)comment 'å‘˜å·¥è¡¨';\n\ncreate table dept(\nid int auto_increment comment 'ID' primary key,\nname varchar(50) not null comment 'éƒ¨é—¨åç§°'\n)comment 'éƒ¨é—¨è¡¨';\n\n\nå¤šå¯¹å¤š\nå¦‚ï¼š å­¦ç”Ÿ ä¸ è¯¾ç¨‹çš„å…³ç³»ï¼Œ ä¸€ä¸ªå­¦ç”Ÿå¯ä»¥é€‰ä¿®å¤šé—¨è¯¾ç¨‹ï¼Œä¸€é—¨è¯¾ç¨‹ä¹Ÿå¯ä»¥ä¾›å¤šä¸ªå­¦ç”Ÿé€‰æ‹©\nå®ç°: å»ºç«‹ç¬¬ä¸‰å¼ ä¸­é—´è¡¨ï¼Œä¸­é—´è¡¨è‡³å°‘åŒ…å«ä¸¤ä¸ªå¤–é”®ï¼Œåˆ†åˆ«å…³è”ä¸¤æ–¹ä¸»é”®\nreate table course(\nid int auto_increment primary key comment 'ä¸»é”®ID',\nname varchar(10) comment 'è¯¾ç¨‹åç§°'\n) comment 'è¯¾ç¨‹è¡¨';\n\n\ncreate table tb_user(\nid int auto_increment primary key comment 'ä¸»é”®ID',\nname varchar(10) comment 'å§“å',\nage int comment 'å¹´é¾„',\ngender char(1) comment '1: ç”· , 2: å¥³',\nphone char(11) comment 'æ‰‹æœºå·'\n) comment 'ç”¨æˆ·åŸºæœ¬ä¿¡æ¯è¡¨';\n\n\ncreate table tb_user_edu(\nid int auto_increment primary key comment 'ä¸»é”®ID',\ndegree varchar(20) comment 'å­¦å†',\nmajor varchar(50) comment 'ä¸“ä¸š',\nprimaryschool varchar(50) comment 'å°å­¦',\nmiddleschool varchar(50) comment 'ä¸­å­¦',\nuniversity varchar(50) comment 'å¤§å­¦',\nuserid int unique comment 'ç”¨æˆ·ID',\nconstraint fk_userid foreign key (userid) references tb_user(id)\n) comment 'ç”¨æˆ·æ•™è‚²ä¿¡æ¯è¡¨';\n\n\nä¸€å¯¹ä¸€\nå¦‚ï¼šç”¨æˆ· ä¸ ç”¨æˆ·è¯¦æƒ…çš„å…³ç³»ï¼Œ ä¸€å¯¹ä¸€å…³ç³»ï¼Œå¤šç”¨äºå•è¡¨æ‹†åˆ†ï¼Œå°†ä¸€å¼ è¡¨çš„åŸºç¡€å­—æ®µæ”¾åœ¨ä¸€å¼ è¡¨ä¸­ï¼Œå…¶ä»–è¯¦æƒ…å­—æ®µæ”¾åœ¨å¦ä¸€å¼ è¡¨ä¸­ï¼Œä»¥æå‡æ“ä½œæ•ˆç‡\nå®ç°: åœ¨ä»»æ„ä¸€æ–¹åŠ å…¥å¤–é”®ï¼Œå…³è”å¦å¤–ä¸€æ–¹çš„ä¸»é”®ï¼Œå¹¶ä¸”è®¾ç½®å¤–é”®ä¸ºå”¯ä¸€çš„(UNIQUE)\ncreate table tb_user(\nid int auto_increment primary key comment 'ä¸»é”®ID',\nname varchar(10) comment 'å§“å',\nage int comment 'å¹´é¾„',\ngender char(1) comment '1: ç”· , 2: å¥³',\nphone char(11) comment 'æ‰‹æœºå·'\n) comment 'ç”¨æˆ·åŸºæœ¬ä¿¡æ¯è¡¨';\n\ncreate table tb_user_edu(\nid int auto_increment primary key comment 'ä¸»é”®ID',\ndegree varchar(20) comment 'å­¦å†',\nmajor varchar(50) comment 'ä¸“ä¸š',\nprimaryschool varchar(50) comment 'å°å­¦',\nmiddleschool varchar(50) comment 'ä¸­å­¦',\nuniversity varchar(50) comment 'å¤§å­¦',\nuserid int unique comment 'ç”¨æˆ·ID',\nconstraint fk_userid foreign key (userid) references tb_user(id)\n) comment 'ç”¨æˆ·æ•™è‚²ä¿¡æ¯è¡¨';\n\nå¤šè¡¨æŸ¥è¯¢æ¦‚è¿°è¦æ‰§è¡Œå¤šè¡¨æŸ¥è¯¢ï¼Œå°±åªéœ€è¦ä½¿ç”¨é€—å·åˆ†éš”å¤šå¼ è¡¨å³å¯ï¼Œå¦‚ï¼š select * from emp , dept;\n å…·ä½“çš„æ‰§è¡Œç»“æœå¦‚ä¸‹:\næˆ‘ä»¬çœ‹åˆ°æŸ¥è¯¢ç»“æœä¸­åŒ…å«äº†å¤§é‡çš„ç»“æœé›†ï¼Œæ€»å…±102æ¡è®°å½•ï¼Œè€Œè¿™å…¶å®å°±æ˜¯å‘˜å·¥è¡¨empæ‰€æœ‰çš„è®°å½•(17) ä¸ éƒ¨é—¨è¡¨deptæ‰€æœ‰è®°å½•(6) çš„æ‰€æœ‰ç»„åˆæƒ…å†µï¼Œè¿™ç§ç°è±¡ç§°ä¹‹ä¸ºç¬›å¡å°”ç§¯ã€‚æ¥ä¸‹æ¥ï¼Œå°±æ¥ç®€å•ä»‹ç»ä¸‹ç¬›å¡å°”ç§¯ã€‚\nç¬›å¡å°”ç§¯: ç¬›å¡å°”ä¹˜ç§¯æ˜¯æŒ‡åœ¨æ•°å­¦ä¸­ï¼Œä¸¤ä¸ªé›†åˆAé›†åˆ å’Œ Bé›†åˆçš„æ‰€æœ‰ç»„åˆæƒ…å†µã€‚\n\nè€Œåœ¨å¤šè¡¨æŸ¥è¯¢ä¸­ï¼Œæˆ‘ä»¬æ˜¯éœ€è¦æ¶ˆé™¤æ— æ•ˆçš„ç¬›å¡å°”ç§¯çš„ï¼Œåªä¿ç•™ä¸¤å¼ è¡¨å…³è”éƒ¨åˆ†çš„æ•°æ®ã€‚\n\nselect * from emp , dept where emp.dept_id = dept.id;\n\nè¿æ¥æŸ¥è¯¢åˆ†ç±»\nâ€‹\tå†…è¿æ¥ï¼šç›¸å½“äºæŸ¥è¯¢Aã€Bäº¤é›†éƒ¨åˆ†æ•°æ® \nâ€‹\tå¤–è¿æ¥ï¼š\nâ€‹\t\tå·¦å¤–è¿æ¥ï¼šæŸ¥è¯¢å·¦è¡¨æ‰€æœ‰æ•°æ®ï¼Œä»¥åŠä¸¤å¼ è¡¨äº¤é›†éƒ¨åˆ†æ•°æ®\nâ€‹\t\tå³å¤–è¿æ¥ï¼šæŸ¥è¯¢å³è¡¨æ‰€æœ‰æ•°æ®ï¼Œä»¥åŠä¸¤å¼ è¡¨äº¤é›†éƒ¨åˆ†æ•°æ®\nâ€‹\tè‡ªè¿æ¥ï¼šå½“å‰è¡¨ä¸è‡ªèº«çš„è¿æ¥æŸ¥è¯¢ï¼Œè‡ªè¿æ¥å¿…é¡»ä½¿ç”¨è¡¨åˆ«å\nå†…è¿æ¥\nå†…è¿æ¥çš„è¯­æ³•åˆ†ä¸ºä¸¤ç§: éšå¼å†…è¿æ¥ã€æ˜¾å¼å†…è¿æ¥ã€‚\néšå¼å†…è¿æ¥\nSELECT å­—æ®µåˆ—è¡¨ FROM è¡¨1 , è¡¨2 WHERE æ¡ä»¶ ... ;\n\næ˜¾å¼å†…è¿æ¥\nSELECT å­—æ®µåˆ—è¡¨ FROM è¡¨1 [ INNER ] JOIN è¡¨2 ON è¿æ¥æ¡ä»¶ ... ;\n\nå°æ¡ˆä¾‹ï¼šæŸ¥è¯¢æ¯ä¸€ä¸ªå‘˜å·¥çš„å§“å , åŠå…³è”çš„éƒ¨é—¨çš„åç§° (éšå¼å†…è¿æ¥å®ç°)\n -- éšå¼å†…è¿æ¥å®ç°\nselect emp.name, dept.name from emp,dept where emp.dept_id = dept.id;\n\nselect emp.name, dept.name from emp join dept on emp.dept_id = dept.id;\n\nå¤–è¿æ¥\nå¤–è¿æ¥åˆ†ä¸ºä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯ï¼šå·¦å¤–è¿æ¥ å’Œ å³å¤–è¿æ¥\nå…·ä½“çš„è¯­æ³•ç»“æ„ä¸ºï¼š\nå·¦å¤–è¿æ¥ \nç›¸å½“äºæŸ¥è¯¢è¡¨1(å·¦è¡¨)çš„æ‰€æœ‰æ•°æ®ï¼Œå½“ç„¶ä¹ŸåŒ…å«è¡¨1å’Œè¡¨2äº¤é›†éƒ¨åˆ†çš„æ•°æ®ã€‚\nSELECT å­—æ®µåˆ—è¡¨ FROM è¡¨1 LEFT [ OUTER ] JOIN è¡¨2 ON æ¡ä»¶ ... ;\n\n å°æ¡ˆä¾‹ï¼šæŸ¥è¯¢empè¡¨çš„æ‰€æœ‰æ•°æ®, å’Œå¯¹åº”çš„éƒ¨é—¨ä¿¡æ¯\nåˆ†æï¼šè¦æŸ¥è¯¢empçš„æ‰€æœ‰æ•°æ®ï¼Œæ‰€ä»¥æ˜¯ä¸èƒ½å†…è¿æ¥æŸ¥è¯¢çš„ï¼Œéœ€è¦è€ƒè™‘ä½¿ç”¨å¤–è¿æ¥æŸ¥è¯¢ã€‚\nselect e.*, d.name from emp e left outer join dept d on e.dept_id = d.id;\n\nselect e.*, d.name from emp e left join dept d on e.dept_id = d.id;\n\nå°æ¡ˆä¾‹ï¼š æŸ¥è¯¢deptè¡¨çš„æ‰€æœ‰æ•°æ®, å’Œå¯¹åº”çš„å‘˜å·¥ä¿¡æ¯(å³å¤–è¿æ¥)\nselect dept.*, emp.* from emp right outer join dept on emp.dept_id = dept.id;\n\nå·¦å¤–è¿æ¥å’Œå³å¤–è¿æ¥æ˜¯å¯ä»¥ç›¸äº’æ›¿æ¢çš„ï¼Œåªéœ€è¦è°ƒæ•´åœ¨è¿æ¥æŸ¥è¯¢æ—¶SQLä¸­ï¼Œè¡¨ç»“æ„çš„å…ˆåé¡ºåºå°±å¯ä»¥äº†ã€‚è€Œæˆ‘ä»¬åœ¨æ—¥å¸¸å¼€å‘ä½¿ç”¨æ—¶ï¼Œæ›´åå‘äºå·¦å¤–è¿æ¥ã€‚\nè‡ªè¿æ¥\né¡¾åæ€ä¹‰ï¼Œå°±æ˜¯è‡ªå·±è¿æ¥è‡ªå·±ï¼Œä¹Ÿå°±æ˜¯æŠŠä¸€å¼ è¡¨è¿æ¥æŸ¥è¯¢å¤šæ¬¡ã€‚\næŸ¥è¯¢è¯­æ³•\nSELECT å­—æ®µåˆ—è¡¨ FROM è¡¨A åˆ«åA JOIN è¡¨A åˆ«åB ON æ¡ä»¶ ... ;\n\nå°æ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥ åŠå…¶ æ‰€å±é¢†å¯¼çš„åå­—ï¼Œå¦‚æœå‘˜å·¥æ²¡æœ‰é¢†å¯¼, ä¹Ÿéœ€è¦æŸ¥è¯¢å‡ºæ¥\nselect a.name, b.name from emp a left join emp b on a.managerid = b.id;\n\nåœ¨è‡ªè¿æ¥æŸ¥è¯¢ä¸­ï¼Œå¿…é¡»è¦ä¸ºè¡¨èµ·åˆ«åï¼Œè¦ä¸ç„¶æˆ‘ä»¬ä¸æ¸…æ¥šæ‰€æŒ‡å®šçš„æ¡ä»¶ã€è¿”å›çš„å­—æ®µï¼Œåˆ°åº•æ˜¯å“ªä¸€å¼ è¡¨çš„å­—æ®µã€‚\nè”åˆæŸ¥è¯¢\nå¯¹äºunionæŸ¥è¯¢ï¼Œå°±æ˜¯æŠŠå¤šæ¬¡æŸ¥è¯¢çš„ç»“æœåˆå¹¶èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªæ–°çš„æŸ¥è¯¢ç»“æœé›†ã€‚\nè¯­æ³•ï¼š\nSELECT å­—æ®µåˆ—è¡¨ FROM è¡¨A ...\nUNION [ ALL ]\nSELECT å­—æ®µåˆ—è¡¨ FROM è¡¨B ....;\n\nå¯¹äºè”åˆæŸ¥è¯¢çš„å¤šå¼ è¡¨çš„åˆ—æ•°å¿…é¡»ä¿æŒä¸€è‡´ï¼Œå­—æ®µç±»å‹ä¹Ÿéœ€è¦ä¿æŒä¸€è‡´ã€‚å¦‚æœå¤šæ¡æŸ¥è¯¢è¯­å¥æŸ¥è¯¢å‡ºæ¥çš„ç»“æœï¼Œå­—æ®µæ•°é‡ä¸ä¸€è‡´ï¼Œåœ¨è¿›è¡Œunion&#x2F;union allè”åˆæŸ¥è¯¢æ—¶ï¼Œå°†ä¼šæŠ¥é”™\nunion all ä¼šå°†å…¨éƒ¨çš„æ•°æ®ç›´æ¥åˆå¹¶åœ¨ä¸€èµ·ï¼Œunion ä¼šå¯¹åˆå¹¶ä¹‹åçš„æ•°æ®å»é‡ã€‚\nå­æŸ¥è¯¢\nSQLè¯­å¥ä¸­åµŒå¥—SELECTè¯­å¥ï¼Œç§°ä¸ºåµŒå¥—æŸ¥è¯¢ï¼Œåˆç§°å­æŸ¥è¯¢\nè¯­æ³•\nSELECT * FROM t1 WHERE column1 = ( SELECT column1 FROM t2 );\n\nå­æŸ¥è¯¢å¤–éƒ¨çš„è¯­å¥å¯ä»¥æ˜¯INSERT &#x2F; UPDATE &#x2F; DELETE &#x2F; SELECT çš„ä»»ä½•ä¸€ä¸ªã€‚\næ ¹æ®å­æŸ¥è¯¢ä½ç½®ï¼Œåˆ†ä¸ºï¼šWHEREä¹‹å\t\t FROMä¹‹å\t\tSELECTä¹‹å\næ ‡é‡å­æŸ¥è¯¢ ï¼šå­æŸ¥è¯¢è¿”å›çš„ç»“æœæ˜¯å•ä¸ªå€¼\t\tå¸¸ç”¨çš„æ“ä½œç¬¦ï¼š&#x3D;   &lt;&gt;   &gt;   &gt;&#x3D;   &lt;  &lt;&#x3D; \næ¡ˆä¾‹ï¼šæŸ¥è¯¢ â€œé”€å”®éƒ¨â€ çš„æ‰€æœ‰å‘˜å·¥ä¿¡æ¯\nselect * from emp where dept_id = (select id from dept where name = 'é”€å”®éƒ¨');\n\nåˆ—å­æŸ¥è¯¢\nå­æŸ¥è¯¢è¿”å›çš„ç»“æœæ˜¯ä¸€åˆ—ï¼ˆå¯ä»¥æ˜¯å¤šè¡Œï¼‰ï¼Œè¿™ç§å­æŸ¥è¯¢ç§°ä¸ºåˆ—å­æŸ¥è¯¢ã€‚\nå¸¸ç”¨çš„æ“ä½œç¬¦ï¼šIN ã€NOT IN ã€ ANY ã€SOME ã€ ALL\n\n\n\næ“ä½œç¬¦\næè¿°\n\n\n\nIN\nåœ¨æŒ‡å®šçš„é›†åˆèŒƒå›´ä¹‹å†…ï¼Œå¤šé€‰ä¸€\n\n\nNOT IN\nä¸åœ¨æŒ‡å®šçš„é›†åˆèŒƒå›´ä¹‹å†…\n\n\nANY\nå­æŸ¥è¯¢è¿”å›åˆ—è¡¨ä¸­ï¼Œæœ‰ä»»æ„ä¸€ä¸ªæ»¡è¶³å³å¯\n\n\nSOME\nä¸ANYç­‰åŒï¼Œä½¿ç”¨SOMEçš„åœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨ANY\n\n\nALL\nå­æŸ¥è¯¢è¿”å›åˆ—è¡¨çš„æ‰€æœ‰å€¼éƒ½å¿…é¡»æ»¡è¶³\n\n\nå°æ¡ˆä¾‹ï¼šæŸ¥è¯¢ â€œé”€å”®éƒ¨â€ å’Œ â€œå¸‚åœºéƒ¨â€ çš„æ‰€æœ‰å‘˜å·¥ä¿¡æ¯\nselect * from emp where id in\n(select id from dept where name = 'é”€å”®éƒ¨' or name = 'å¸‚åœºéƒ¨');\n\n å°æ¡ˆä¾‹ï¼šæŸ¥è¯¢æ¯” è´¢åŠ¡éƒ¨ æ‰€æœ‰äººå·¥èµ„éƒ½é«˜çš„å‘˜å·¥ä¿¡æ¯\nselect * from emp where salary > all ( select salary from emp where dept_id =\n(select id from dept where name = 'è´¢åŠ¡éƒ¨') );\n\n å°æ¡ˆä¾‹ï¼šæŸ¥è¯¢æ¯”ç ”å‘éƒ¨å…¶ä¸­ä»»æ„ä¸€äººå·¥èµ„é«˜çš„å‘˜å·¥ä¿¡æ¯\nselect * from emp where salary > any(select salary from emp where dept_id = \n(select id from dept where name = 'ç ”å‘éƒ¨'));\n\nè¡Œå­æŸ¥è¯¢\nå­æŸ¥è¯¢è¿”å›çš„ç»“æœæ˜¯ä¸€è¡Œï¼ˆå¯ä»¥æ˜¯å¤šåˆ—ï¼‰ï¼Œè¿™ç§å­æŸ¥è¯¢ç§°ä¸ºè¡Œå­æŸ¥è¯¢ã€‚\nå¸¸ç”¨çš„æ“ä½œç¬¦ï¼š&#x3D; ã€&lt;&gt; ã€IN ã€NOT IN\nå°æ¡ˆä¾‹ï¼šæŸ¥è¯¢ä¸ â€œå¼ æ— å¿Œâ€ çš„è–ªèµ„åŠç›´å±é¢†å¯¼ç›¸åŒçš„å‘˜å·¥ä¿¡æ¯ ;\nselect * from emp where (salary,managerid) = (select salary, managerid from emp where name ='å¼ æ— å¿Œ');\n\nè¡¨å­æŸ¥è¯¢\nå­æŸ¥è¯¢è¿”å›çš„ç»“æœæ˜¯å¤šè¡Œå¤šåˆ—ï¼Œè¿™ç§å­æŸ¥è¯¢ç§°ä¸ºè¡¨å­æŸ¥è¯¢ã€‚å¸¸ç”¨çš„æ“ä½œç¬¦ï¼šIN\nå°æ¡ˆä¾‹ï¼šæŸ¥è¯¢ä¸ â€œé¹¿æ–å®¢â€ , â€œå®‹è¿œæ¡¥â€ çš„èŒä½å’Œè–ªèµ„ç›¸åŒçš„å‘˜å·¥ä¿¡æ¯\nselect * from emp where (job,salary) in ( select job, salary from emp where name =\n'é¹¿æ–å®¢' or name = 'å®‹è¿œæ¡¥' );\n\nå°æ¡ˆä¾‹ï¼šæŸ¥è¯¢å…¥èŒæ—¥æœŸæ˜¯ â€œ2006-01-01â€ ä¹‹åçš„å‘˜å·¥ä¿¡æ¯ , åŠå…¶éƒ¨é—¨ä¿¡æ¯\n````\n\n å°æ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥çš„å§“åã€å¹´é¾„ã€èŒä½ã€éƒ¨é—¨ä¿¡æ¯ ï¼ˆéšå¼å†…è¿æ¥ï¼‰\n\n\nå°æ¡ˆä¾‹ï¼š æŸ¥è¯¢å¹´é¾„å°äº30å²çš„å‘˜å·¥çš„å§“åã€å¹´é¾„ã€èŒä½ã€éƒ¨é—¨ä¿¡æ¯ï¼ˆæ˜¾å¼å†…è¿æ¥ï¼‰\n\n\nå°æ¡ˆä¾‹ï¼šæŸ¥è¯¢æ‹¥æœ‰å‘˜å·¥çš„éƒ¨é—¨IDã€éƒ¨é—¨åç§°\n\n\nå°æ¡ˆä¾‹ï¼šæŸ¥è¯¢æ‰€æœ‰å¹´é¾„å¤§äº40å²çš„å‘˜å·¥, åŠå…¶å½’å±çš„éƒ¨é—¨åç§°; å¦‚æœå‘˜å·¥æ²¡æœ‰åˆ†é…éƒ¨é—¨, ä¹Ÿéœ€è¦å±•ç¤ºå‡ºæ¥(å¤–è¿æ¥)\n\n\nå°æ¡ˆä¾‹ï¼šæŸ¥è¯¢æ‰€æœ‰å‘˜å·¥çš„å·¥èµ„ç­‰çº§\n\n\nå°æ¡ˆä¾‹ï¼šæŸ¥è¯¢ &quot;ç ”å‘éƒ¨&quot; æ‰€æœ‰å‘˜å·¥çš„ä¿¡æ¯åŠ å·¥èµ„ç­‰çº§\n\n\nå°æ¡ˆä¾‹ï¼š æŸ¥è¯¢ &quot;ç ”å‘éƒ¨&quot; å‘˜å·¥çš„å¹³å‡å·¥èµ„\n\n\nå°æ¡ˆä¾‹ï¼š æŸ¥è¯¢å·¥èµ„æ¯” &quot;ç­ç»&quot; é«˜çš„å‘˜å·¥ä¿¡æ¯ã€‚\n\n\nå°æ¡ˆä¾‹ï¼š æŸ¥è¯¢æ¯”å¹³å‡è–ªèµ„é«˜çš„å‘˜å·¥ä¿¡æ¯\n\n\nå°æ¡ˆä¾‹ï¼šæŸ¥è¯¢ä½äºæœ¬éƒ¨é—¨å¹³å‡å·¥èµ„çš„å‘˜å·¥ä¿¡æ¯\n\n\nå°æ¡ˆä¾‹ï¼šæŸ¥è¯¢æ‰€æœ‰çš„éƒ¨é—¨ä¿¡æ¯, å¹¶ç»Ÿè®¡éƒ¨é—¨çš„å‘˜å·¥äººæ•°\n\n\nå°æ¡ˆä¾‹ï¼šæŸ¥è¯¢æ‰€æœ‰å­¦ç”Ÿçš„é€‰è¯¾æƒ…å†µ, å±•ç¤ºå‡ºå­¦ç”Ÿåç§°, å­¦å·, è¯¾ç¨‹åç§°\n\n\n\n","slug":"MySQL-çº¦æŸ-å¤šè¡¨è”æŸ¥","date":"2023-05-16T13:40:42.000Z","categories_index":"","tags_index":"MySQL","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"8f9e88b96addebc57d8b075bdae2d985","title":"MySQL_DCL_å‡½æ•°","content":"DCLData Control Language(æ•°æ®æ§åˆ¶è¯­è¨€)ï¼Œç”¨æ¥ç®¡ç†æ•°æ®åº“ç”¨æˆ·ã€æ§åˆ¶æ•°æ®åº“çš„è®¿é—®æƒé™ã€‚\nç®¡ç†ç”¨æˆ·æŸ¥è¯¢ç”¨æˆ·\nselect * from mysql.user;\n\n\nå…¶ä¸­ Hostä»£è¡¨å½“å‰ç”¨æˆ·è®¿é—®çš„ä¸»æœº, å¦‚æœä¸ºlocalhost, ä»…ä»£è¡¨åªèƒ½å¤Ÿåœ¨å½“å‰æœ¬æœºè®¿é—®ï¼Œæ˜¯ä¸å¯ä»¥è¿œç¨‹è®¿é—®çš„ã€‚Userä»£è¡¨çš„æ˜¯è®¿é—®è¯¥æ•°æ®åº“çš„ç”¨æˆ·åã€‚åœ¨MySQLä¸­éœ€è¦é€šè¿‡Hostå’ŒUseræ¥å”¯ä¸€æ ‡è¯†ä¸€ä¸ªç”¨æˆ·ã€‚\nåˆ›å»ºç”¨æˆ·\nCREATE USER 'ç”¨æˆ·å'@'ä¸»æœºå' IDENTIFIED BY 'å¯†ç ';\n\nä¿®æ”¹ç”¨æˆ·å¯†ç \nALTER USER 'ç”¨æˆ·å'@'ä¸»æœºå·' IDENTIFIED WITH mysql_native_password BY 'æ–°å¯†ç ';\n\nåˆ é™¤ç”¨æˆ·\nDROP USER 'ç”¨æˆ·å'@'ä¸»æœºå';\n\nåœ¨MySQLä¸­éœ€è¦é€šè¿‡ç”¨æˆ·å@ä¸»æœºåçš„æ–¹å¼ï¼Œæ¥å”¯ä¸€æ ‡è¯†ä¸€ä¸ªç”¨æˆ·ã€‚\nä¸»æœºåå¯ä»¥ä½¿ç”¨ % é€šé…ã€‚\nè¿™ç±»SQLå¼€å‘äººå‘˜æ“ä½œçš„æ¯”è¾ƒå°‘ï¼Œä¸»è¦æ˜¯DBAï¼ˆ Database Administrator æ•°æ®åº“ç®¡ç†å‘˜ï¼‰ä½¿ç”¨ã€‚\næƒé™æ§åˆ¶\nMySQLä¸­å®šä¹‰äº†å¾ˆå¤šç§æƒé™ï¼Œä½†æ˜¯å¸¸ç”¨çš„å°±ä»¥ä¸‹å‡ ç§\n\n\n\næƒé™\nè¯´æ˜\n\n\n\nALL,  ALL PRIVILEGES\næ‰€æœ‰æƒé™\n\n\nSELECT\næŸ¥è¯¢æ•°æ®\n\n\nINSERT\næ’å…¥æ•°æ®\n\n\nUPDATE\nä¿®æ”¹æ•°æ®\n\n\nDELETE\nåˆ é™¤æ•°æ®\n\n\nALTER\nä¿®æ”¹è¡¨\n\n\nDROP\nåˆ é™¤æ•°æ®åº“&#x2F;è¡¨&#x2F;è§†å›¾\n\n\nCREATE\nåˆ›å»ºæ•°æ®åº“&#x2F;è¡¨\n\n\næŸ¥è¯¢æƒé™\nSHOW GRANTS FOR 'ç”¨æˆ·å'@'ä¸»æœºå';\n\næˆäºˆæƒé™\nGRANT æƒé™åˆ—è¡¨ ON æ•°æ®åº“å.è¡¨å TO 'ç”¨æˆ·å'@'ä¸»æœºå';\n\næ’¤é”€æƒé™\nREVOKE æƒé™åˆ—è¡¨ ON æ•°æ®åº“å.è¡¨å FROM 'ç”¨æˆ·å'@'ä¸»æœºå';\n\n å¤šä¸ªæƒé™ä¹‹é—´ï¼Œä½¿ç”¨é€—å·åˆ†éš”\næˆæƒæ—¶ï¼Œ æ•°æ®åº“åå’Œè¡¨åå¯ä»¥ä½¿ç”¨ * è¿›è¡Œé€šé…ï¼Œä»£è¡¨æ‰€æœ‰ã€‚\nSHOW GRANTS FOR 'hj'@'%';\n-- è¿è¡Œç»“æœï¼š\n-- GRANT ALL PRIVILEGES ON `hj`.* TO `hj`@`%`\n-- è¯¥å‘½ä»¤ä¸º MySQL çš„æˆæƒè¯­æ³•ï¼Œæ„æ€æ˜¯æˆæƒç”¨æˆ· hj åœ¨ä»»ä½•ä¸»æœºåœ°å€ä¸Šï¼ˆ%ï¼‰å¯¹æ•°æ®åº“ hj ä¸­æ‰€æœ‰è¡¨æ‹¥æœ‰æ‰€æœ‰æƒé™ï¼ˆALL PRIVILEGESï¼‰ã€‚å¯ä»¥æ‰§è¡Œå¦‚ä¸‹ SQL å‘½ä»¤è¿›è¡Œæˆæƒ\n-- GRANT USAGE ON *.* TO `hj`@`%`\n-- è¯¥å‘½ä»¤ä¸º MySQL çš„æˆæƒè¯­æ³•ï¼Œæ„æ€æ˜¯æˆæƒç”¨æˆ· `hj` åœ¨ä»»ä½•ä¸»æœºåœ°å€ä¸Šï¼ˆ`%`ï¼‰å¯¹æ‰€æœ‰çš„æ•°æ®åº“ã€è¡¨ã€å‡½æ•°ã€å­˜å‚¨è¿‡ç¨‹ç­‰å¯¹è±¡éƒ½æ‹¥æœ‰ä½¿ç”¨æƒé™ï¼ˆ`USAGE`ï¼‰ã€‚\n\nå‡½æ•°MySQLä¸­çš„å‡½æ•°ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å››ç±»ï¼š å­—ç¬¦ä¸²å‡½æ•°ã€æ•°å€¼å‡½æ•°ã€æ—¥æœŸå‡½æ•°ã€æµç¨‹å‡½æ•°ã€‚\nå­—ç¬¦ä¸²å‡½æ•°\n\n\n\nå‡½æ•°\nåŠŸèƒ½\n\n\n\nCONCAT(S1,S2,â€¦Sn)\nå­—ç¬¦ä¸²æ‹¼æ¥ï¼Œå°†S1ï¼ŒS2ï¼Œâ€¦ Snæ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²\n\n\nLOWER(str)\nå°†å­—ç¬¦ä¸²strå…¨éƒ¨è½¬ä¸ºå°å†™\n\n\nUPPER(str)\nå°†å­—ç¬¦ä¸²strå…¨éƒ¨è½¬ä¸ºå¤§å†™\n\n\nLPAD(str,n,pad)\nå·¦å¡«å……ï¼Œç”¨å­—ç¬¦ä¸²padå¯¹strçš„å·¦è¾¹è¿›è¡Œå¡«å……ï¼Œè¾¾åˆ°nä¸ªå­—ç¬¦ä¸²é•¿åº¦\n\n\nRPAD(str,n,pad)\nå³å¡«å……ï¼Œç”¨å­—ç¬¦ä¸²padå¯¹strçš„å³è¾¹è¿›è¡Œå¡«å……ï¼Œè¾¾åˆ°nä¸ªå­—ç¬¦ä¸²é•¿åº¦\n\n\nTRIM(str)\nå»æ‰å­—ç¬¦ä¸²å¤´éƒ¨å’Œå°¾éƒ¨çš„ç©ºæ ¼\n\n\nSUBSTRING(str,start,len)\nè¿”å›ä»å­—ç¬¦ä¸²strä»startä½ç½®èµ·çš„lenä¸ªé•¿åº¦çš„å­—ç¬¦ä¸²\n\n\n concat : å­—ç¬¦ä¸²æ‹¼æ¥\nselect concat('Hello' , ' MySQL');\n\nlpad : å·¦å¡«å……\nselect lpad('01', 5, '-');\n\n rpad : å³å¡«å……\nselect rpad('01',5,'23456789');\n-- 01234\nselect rpad('01',5,'23');\n-- 01232\n\n trim : å»é™¤ç©ºæ ¼\nselect trim(' Hello MySQL ');\n-- 'Hello MySQL'\n\n substring : æˆªå–å­å­—ç¬¦ä¸²\nselect substring('Hello MySQL',1,5);\n-- Hello\n\næ¡ˆä¾‹ï¼šç”±äºä¸šåŠ¡éœ€æ±‚å˜æ›´ï¼Œä¼ä¸šå‘˜å·¥çš„å·¥å·ï¼Œç»Ÿä¸€ä¸º5ä½æ•°ï¼Œç›®å‰ä¸è¶³5ä½æ•°çš„å…¨éƒ¨åœ¨å‰é¢è¡¥0ã€‚æ¯”å¦‚ï¼š 1å·å‘˜å·¥çš„å·¥å·åº”è¯¥ä¸º00001ã€‚\nupdate workno = lpad(workno, 5, '0');\n\næ•°å€¼å‡½æ•°\n\n\n\nå‡½æ•°\nåŠŸèƒ½\n\n\n\nCEIL(x)\nå‘ä¸Šå–æ•´\n\n\nFLOOR(x)\nå‘ä¸‹å–æ•´\n\n\nMOD(x,y)\nè¿”å›x&#x2F;yçš„æ¨¡\n\n\nRAND()\nè¿”å›0~1å†…çš„éšæœºæ•°\n\n\nROUND(x,y)\næ±‚å‚æ•°xçš„å››èˆäº”å…¥çš„å€¼ï¼Œä¿ç•™yä½å°æ•°\n\n\n ceilï¼šå‘ä¸Šå–æ•´\nselect ceil(1.1);\n\n floorï¼šå‘ä¸‹å–æ•´\nselect floor(1.9);\n\nmodï¼šå–æ¨¡\nselect mod(7,4);\n\n randï¼šè·å–éšæœºæ•°\nselect rand();\n\nroundï¼šå››èˆäº”å…¥\nselect round(2.344,2);\n\nå°æ¡ˆä¾‹ï¼šé€šè¿‡æ•°æ®åº“çš„å‡½æ•°ï¼Œç”Ÿæˆä¸€ä¸ªå…­ä½æ•°çš„éšæœºéªŒè¯ç ã€‚\nselect lpad('',6,substring(concat(rand(),''),3,9)) code;\n\næ—¥æœŸå‡½æ•°\n\n\n\nå‡½æ•°\nåŠŸèƒ½\n\n\n\nCURDATE()\nè¿”å›å½“å‰æ—¥æœŸ\n\n\nCURTIME()\nè¿”å›å½“å‰æ—¶é—´\n\n\nNOW()\nè¿”å›å½“å‰æ—¥æœŸå’Œæ—¶é—´\n\n\nYEAR(date)\nè·å–æŒ‡å®šdateçš„å¹´ä»½\n\n\nMONTH(date)\nè·å–æŒ‡å®šdateçš„æœˆä»½\n\n\nDAY(date)\nè·å–æŒ‡å®šdateçš„æ—¥æœŸ\n\n\nDATE_ADD(date,INTERVAL expr type)\nè¿”å›ä¸€ä¸ªæ—¥æœŸ&#x2F;æ—¶é—´å€¼åŠ ä¸Šä¸€ä¸ªæ—¶é—´é—´éš”expråçš„æ—¶é—´å€¼\n\n\nDATEDIFF(date1,date2)\nè¿”å›èµ·å§‹æ—¶é—´date1 å’Œ ç»“æŸæ—¶é—´date2ä¹‹é—´çš„å¤©æ•°\n\n\n curdateï¼šå½“å‰æ—¥æœŸ\nselect curdate();\n\n curtimeï¼šå½“å‰æ—¶é—´\nselect curtime();\n\n nowï¼šå½“å‰æ—¥æœŸå’Œæ—¶é—´\nselect now();\n\nYEAR , MONTH , DAYï¼šå½“å‰å¹´ã€æœˆã€æ—¥\nselect year(now());\nselect month(now());\nselect day(now());\n\ndate_addï¼šå¢åŠ æŒ‡å®šçš„æ—¶é—´é—´éš”\nselect date_add(now(),INTERVAL 70 YEAR);\nselect date_add('2023-05-16', INTERVAL 29 DAY);\n\n datediffï¼šè·å–ä¸¤ä¸ªæ—¥æœŸç›¸å·®çš„å¤©æ•°\nselect datediff('2023-05-16','2023-06-14');\n\nå°æ¡ˆä¾‹ï¼šæŸ¥è¯¢æ‰€æœ‰å‘˜å·¥çš„å…¥èŒå¤©æ•°ï¼Œå¹¶æ ¹æ®å…¥èŒå¤©æ•°å€’åºæ’åºã€‚\nselect name , datediff(curdate(), entrydate) workday from emp order by workday desc;\n\næµç¨‹å‡½æ•°\næµç¨‹å‡½æ•°ä¹Ÿæ˜¯å¾ˆå¸¸ç”¨çš„ä¸€ç±»å‡½æ•°ï¼Œå¯ä»¥åœ¨SQLè¯­å¥ä¸­å®ç°æ¡ä»¶ç­›é€‰ï¼Œä»è€Œæé«˜è¯­å¥çš„æ•ˆç‡ã€‚\n\n\n\nå‡½æ•°\nåŠŸèƒ½\n\n\n\nIF(value, t, f)\nå¦‚æœvalueä¸ºtrueï¼Œåˆ™è¿”å›tï¼Œå¦åˆ™è¿”å›f\n\n\nIFNULL(value1, value2)\nå¦‚æœvalue1ä¸ä¸ºç©ºï¼Œè¿”å›value1ï¼Œå¦åˆ™è¿”å›value2\n\n\nCASE WHEN [vall] THEN [res1] â€¦ ELSE [default] END\nå¦‚æœval1ä¸ºtrueï¼Œè¿”å›res1ï¼Œâ€¦ å¦åˆ™è¿”å›defaulté»˜è®¤å€¼\n\n\nCASE [expr] WHEN [val1] THEN [res1] â€¦  ELSE [default] END\nå¦‚æœexprçš„å€¼ç­‰äºval1ï¼Œè¿”å›res1ï¼Œâ€¦ å¦åˆ™è¿”å›defaulté»˜è®¤å€¼\n\n\n if\nselect if(false, 'Ok', 'Error');\n-- é»˜è®¤çš„falseå€¼è¿˜æœ‰ 0, '', null\n\n ifnull\nselect ifnull('Ok','Default');\nselect ifnull('','Default');\nselect ifnull(null,'Default')\n-- åªæœ‰nullä¼šè¢«è¯†åˆ«ä¸ºç©º\n\n case when then else end\næŸ¥è¯¢empè¡¨çš„å‘˜å·¥å§“åå’Œå·¥ä½œåœ°å€ (åŒ—äº¬&#x2F;ä¸Šæµ·   æ›¿æ¢æˆ   ä¸€çº¿åŸå¸‚ , å…¶ä»–   æ›¿æ¢æˆ   äºŒçº¿åŸå¸‚)\nselect name, (case workaddress when 'åŒ—äº¬' then 'ä¸€çº¿åŸå¸‚' when 'ä¸Šæµ·' then 'ä¸€çº¿åŸå¸‚' else 'äºŒçº¿åŸå¸‚' end) 'å·¥ä½œåœ°ç‚¹' from emp;\n\næ¡ˆä¾‹ï¼šå°†å­¦ç”Ÿçš„å„ä¸ªå­¦ç§‘çš„æˆç»©åˆ†ç­‰çº§å±•ç¤ºï¼Œå¤§äºç­‰äº85 ä¸ºä¼˜ç§€ï¼Œ(85ï¼Œ60]ä¸ºåŠæ ¼ï¼Œå¦åˆ™ä¸åŠæ ¼\ncreate table score(\nid int comment 'ID',\nname varchar(20) comment 'å§“å',\nmath  tinyint unsigned comment 'æ•°å­¦',\nenglish tinyint unsigned comment 'è‹±è¯­',\nchinese tinyint unsigned comment 'è¯­æ–‡'\n) comment 'å­¦ç”Ÿæˆç»©è¡¨';\ninsert into score(id, name, math, english, chinese) VALUES \n(1, 'Tom', 67, 88, 95),\n (2, 'Rose' , 23, 66, 90),\n (3, 'Jack', 56, 98, 76);\n \n select name , \n(case when math >= 85 then 'ä¼˜ç§€' when math >=60 then 'åŠæ ¼' else 'ä¸åŠæ ¼' end ) math_score,\n(case when english >= 85 then 'ä¼˜ç§€' when english >=60 then 'åŠæ ¼' else 'ä¸åŠæ ¼' end ) english_score,\n(case when chinese >= 85 then 'ä¼˜ç§€' when chinese >=60 then 'åŠæ ¼' else 'ä¸åŠæ ¼' end ) chinese_score \n from score;\n\n","slug":"MySQL-DCL-å‡½æ•°","date":"2023-05-16T08:56:15.000Z","categories_index":"","tags_index":"MySQL","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"b886b366f3cb34006709f66f49ec6b62","title":"çŠ¶æ€æ¨¡å¼","content":"çŠ¶æ€æ¨¡å¼å®ƒå°†å¯¹è±¡çš„è¡Œä¸ºä¸å…¶å†…éƒ¨çŠ¶æ€åˆ†ç¦»å¼€æ¥ï¼Œä½¿å¾—å¯¹è±¡å¯ä»¥æ ¹æ®å…¶å†…éƒ¨çŠ¶æ€çš„å˜åŒ–è€Œæ”¹å˜å…¶è¡Œä¸ºã€‚çŠ¶æ€æ¨¡å¼é€šè¿‡å°†çŠ¶æ€çš„åˆ‡æ¢å°è£…åœ¨çŠ¶æ€ç±»ä¸­ï¼Œä½¿å¾—çŠ¶æ€è½¬æ¢å…·æœ‰å¯æ‰©å±•æ€§å’Œçµæ´»æ€§ï¼Œå¹¶é¿å…äº†ç”±äºçŠ¶æ€è½¬æ¢æ‰€å¸¦æ¥çš„â€œif-elseâ€åµŒå¥—è¿‡å¤šçš„é—®é¢˜ã€‚\nçŠ¶æ€æ¨¡å¼çš„åŸºæœ¬æœºåˆ¶æ˜¯å°†çŠ¶æ€æŠ½è±¡ä¸ºä¸€ä¸ªæ¥å£æˆ–è€…æŠ½è±¡ç±»ï¼Œæ¯ä¸ªå…·ä½“çŠ¶æ€ç±»éƒ½å®ç°è¯¥æ¥å£æˆ–è€…æŠ½è±¡ç±»ï¼Œå¹¶ä¸”åœ¨å…·ä½“çŠ¶æ€ç±»ä¸­å®ç°å…¶å¯¹åº”çš„è¡Œä¸ºã€‚åœ¨çŠ¶æ€æ¨¡å¼ä¸­ï¼Œå¯¹è±¡çš„çŠ¶æ€åˆ‡æ¢æ˜¯é€šè¿‡æ”¹å˜å¯¹è±¡æŒæœ‰çš„çŠ¶æ€å®ä¾‹æ¥å®ç°çš„ã€‚å½“å¯¹è±¡éœ€è¦çŠ¶æ€è½¬æ¢æ—¶ï¼Œå®ƒä¼šå§”æ‰˜å½“å‰çŠ¶æ€å®ä¾‹å¤„ç†çŠ¶æ€è½¬æ¢ï¼Œä»è€Œä½¿å¾—å¯¹è±¡çš„è¡Œä¸ºå’ŒçŠ¶æ€ç›¸äº’è§£è€¦ï¼Œå…·æœ‰æ›´å¥½çš„å¯æ‰©å±•æ€§å’Œçµæ´»æ€§ã€‚\nçŠ¶æ€æ¨¡å¼ç¬¦åˆâ€œå•ä¸€èŒè´£åŸåˆ™â€å’Œâ€œå¼€é—­åŸåˆ™â€ä¸¤ä¸ªè½¯ä»¶è®¾è®¡åŸåˆ™ã€‚å…¶ä¸­ï¼Œâ€œå•ä¸€èŒè´£åŸåˆ™â€æŒ‡ä¸€ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªèŒè´£ï¼ŒçŠ¶æ€æ¨¡å¼å°†çŠ¶æ€æŠ½è±¡ä¸ºä¸€ä¸ªç‹¬ç«‹çš„ç±»ï¼Œä½¿å¾—æ¯ä¸ªçŠ¶æ€ç±»åªè´Ÿè´£å¤„ç†ä¸€ä¸ªçŠ¶æ€ï¼Œä»è€Œä½¿å¾—æ¯ä¸ªç±»éƒ½å…·æœ‰å•ä¸€çš„èŒè´£ï¼›â€œå¼€é—­åŸåˆ™â€æŒ‡å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼ŒçŠ¶æ€æ¨¡å¼é€šè¿‡å¢åŠ æ–°çš„çŠ¶æ€ç±»æ¥æ‰©å±•çŠ¶æ€è½¬æ¢è¿‡ç¨‹ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹åŸæœ‰çš„ä»£ç ï¼Œä»è€Œç¬¦åˆâ€œå¼€é—­åŸåˆ™â€ã€‚\nçŠ¶æ€æ¨¡å¼å­˜åœ¨ä¸‰ä¸ªè§’è‰²ï¼š\n\nç¯å¢ƒï¼ˆContextï¼‰è§’è‰²ï¼šå®ƒå®šä¹‰äº†å®¢æˆ·ç«¯æ‰€æ„Ÿå…´è¶£çš„æ¥å£ï¼Œé€šå¸¸åŒ…å«ä¸€ä¸ªçŠ¶æ€å®ä¾‹å¹¶ç»´æŠ¤ä¸€ä¸ªæŒ‡å‘å…·ä½“çŠ¶æ€å¯¹è±¡çš„å¼•ç”¨ã€‚è¿™ä¸ªä¸Šä¸‹æ–‡ç±»å¯ä»¥å¤„ç†è¯·æ±‚å¹¶å°†å…¶å§”æ‰˜ç»™å½“å‰çŠ¶æ€å¯¹è±¡ã€‚\næŠ½è±¡çŠ¶æ€ï¼ˆStateï¼‰è§’è‰²ï¼šå®ƒæŠŠæ‰€æœ‰å…·ä½“çŠ¶æ€ç±»çš„å…±åŒç‚¹æŠ½è±¡å‡ºæ¥ï¼Œå®šä¹‰äº†è¿™äº›å…±åŒç‚¹å¯¹åº”çš„æ¥å£æˆ–æŠ½è±¡ç±»ï¼Œå¹¶åœ¨å…¶ä¸­å®šä¹‰äº†è¯¥çŠ¶æ€ä¸‹å¯¹è±¡çš„è¡Œä¸ºã€‚\nå…·ä½“çŠ¶æ€ï¼ˆConcrete Stateï¼‰è§’è‰²ï¼šå®ƒå®ç°äº†æŠ½è±¡çŠ¶æ€çš„æ¥å£æˆ–æŠ½è±¡ç±»ï¼Œå¹¶ä¸”å®šä¹‰äº†åœ¨è¯¥çŠ¶æ€ä¸‹å¯¹è±¡çš„è¡Œä¸ºã€‚\n\nå‡è®¾æˆ‘ä»¬è¦è®¾è®¡ä¸€ä¸ªç”µç¯ç±»ï¼Œç”µç¯å¯ä»¥å¤„äº3ä¸ªä¸åŒçš„çŠ¶æ€ï¼š\nå…³é—­çŠ¶æ€ã€å¼€å¯çŠ¶æ€å’Œé—ªçƒçŠ¶æ€ã€‚ç”µç¯ç±»çš„ä»£ç å¦‚ä¸‹ï¼š\npublic class Light &#123;\n    private State state;\n\n    public Light() &#123;\n        this.state = new OffState();\n    &#125;\n\n    public void setState(State state) &#123;\n        this.state = state;\n    &#125;\n\n    public void turnOn() &#123;\n        state.turnOn(this);\n    &#125;\n\n    public void turnOff() &#123;\n        state.turnOff(this);\n    &#125;\n\n    public void blink() &#123;\n        state.blink(this);\n    &#125;\n&#125;\n\nåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†ç”µç¯çš„çŠ¶æ€æŠ½è±¡æˆäº†æ¥å£Stateï¼Œç„¶åå®šä¹‰äº†3ä¸ªå…·ä½“çš„çŠ¶æ€ç±»ï¼šOffStateã€OnStateå’ŒBlinkStateï¼Œè¿™3ä¸ªç±»å®ç°äº†Stateæ¥å£ã€‚\npublic interface State &#123;\n    void turnOn(Light light);\n    void turnOff(Light light);\n    void blink(Light light);\n&#125;\n\npublic class OffState implements State &#123;\n    @Override\n    public void turnOn(Light light) &#123;\n        System.out.println(\"ç”µç¯å¼€å¯\");\n        light.setState(new OnState());\n    &#125;\n\n    @Override\n    public void turnOff(Light light) &#123;\n        System.out.println(\"ç”µç¯å·²ç»å…³é—­ï¼Œä¸èƒ½å†å…³é—­\");\n    &#125;\n\n    @Override\n    public void blink(Light light) &#123;\n        System.out.println(\"ç”µç¯æœªå¼€å¯ï¼Œä¸èƒ½é—ªçƒ\");\n    &#125;\n&#125;\n\npublic class OnState implements State &#123;\n    @Override\n    public void turnOn(Light light) &#123;\n        System.out.println(\"ç”µç¯å·²ç»å¼€å¯ï¼Œä¸éœ€è¦å†å¼€å¯\");\n    &#125;\n\n    @Override\n    public void turnOff(Light light) &#123;\n        System.out.println(\"ç”µç¯å…³é—­\");\n        light.setState(new OffState());\n    &#125;\n\n    @Override\n    public void blink(Light light) &#123;\n        System.out.println(\"ç”µç¯å¼€å§‹é—ªçƒ\");\n        light.setState(new BlinkState());\n    &#125;\n&#125;\n\npublic class BlinkState implements State &#123;\n    @Override\n    public void turnOn(Light light) &#123;\n        System.out.println(\"ç”µç¯å·²ç»å¼€å¯ï¼Œä¸éœ€è¦å†å¼€å¯\");\n    &#125;\n\n    @Override\n    public void turnOff(Light light) &#123;\n        System.out.println(\"ç”µç¯å…³é—­\");\n        light.setState(new OffState());\n    &#125;\n\n    @Override\n    public void blink(Light light) &#123;\n        System.out.println(\"ç”µç¯åœæ­¢é—ªçƒ\");\n        light.setState(new OnState());\n    &#125;\n&#125;\n\nåœ¨ç”µç¯ç±»ä¸­ï¼Œå¼•å…¥äº†ä¸€ä¸ªStateç±»å‹çš„å˜é‡stateï¼Œè¡¨ç¤ºå½“å‰ç”µç¯å¤„äºå“ªç§çŠ¶æ€ã€‚å½“ç”µç¯éœ€è¦æ”¹å˜çŠ¶æ€æ—¶ï¼Œå®ƒä¼šè°ƒç”¨stateçš„å¯¹åº”æ–¹æ³•ï¼Œç„¶åå°†stateè®¾ä¸ºæ–°çš„çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œå½“ç”µç¯éœ€è¦å¼€å¯æ—¶ï¼Œå®ƒå°†è°ƒç”¨OnStateçš„turnOnæ–¹æ³•ï¼Œå¹¶å°†stateè®¾ä¸ºOnStateå®ä¾‹ã€‚\nä¸‹é¢æ˜¯ä¸€ä¸ªåº”ç”¨ç”µç¯ç±»çš„ä¾‹å­ï¼š\npublic static void main(String[] args) &#123;\n    Light light = new Light();\n    light.turnOn();  // ç”µç¯å¼€å¯\n    light.turnOn();  // ç”µç¯å·²ç»å¼€å¯ï¼Œä¸éœ€è¦å†å¼€å¯\n    light.blink();   // ç”µç¯å¼€å§‹é—ªçƒ\n    light.turnOff(); // ç”µç¯å…³é—­\n    light.blink();   // ç”µç¯æœªå¼€å¯ï¼Œä¸èƒ½é—ªçƒ\n    light.turnOff(); // ç”µç¯å·²ç»å…³é—­ï¼Œä¸èƒ½å†å…³é—­\n&#125;\n\nåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªç”µç¯å®ä¾‹lightï¼Œç„¶åé€šè¿‡è°ƒç”¨å®ƒçš„turnOnã€blinkå’ŒturnOffæ–¹æ³•ï¼Œæ”¹å˜äº†å®ƒçš„çŠ¶æ€ï¼Œå¹¶è¾“å‡ºäº†ç›¸åº”çš„ä¿¡æ¯ã€‚\nè¿™ä¸ªä¾‹å­å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç†è§£çŠ¶æ€æ¨¡å¼çš„åŸºæœ¬ç”¨æ³•å’ŒåŸç†ï¼ŒåŒæ—¶ä¹Ÿèƒ½è®©æˆ‘ä»¬æ„Ÿå—åˆ°çŠ¶æ€æ¨¡å¼æ‰€æä¾›çš„å¯æ‰©å±•æ€§å’Œçµæ´»æ€§ã€‚å½“éœ€è¦æ–°å¢æˆ–ä¿®æ”¹çŠ¶æ€æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦æ·»åŠ æˆ–ä¿®æ”¹ç›¸åº”çš„çŠ¶æ€ç±»ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹ç”µç¯ç±»çš„ä»£ç ï¼Œä»è€Œå¤§å¤§é™ä½äº†ä»£ç çš„è€¦åˆåº¦å’Œç»´æŠ¤æˆæœ¬ã€‚\n","slug":"çŠ¶æ€æ¨¡å¼","date":"2023-05-15T10:11:38.000Z","categories_index":"","tags_index":"Java,è®¾è®¡æ¨¡å¼","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"ab4a664e2e3638cd67bb057e6ee644aa","title":"è¿­ä»£å™¨æ¨¡å¼","content":"è¿­ä»£å™¨æ¨¡å¼å®ƒæä¾›ä¸€ç§æ–¹ä¾¿çš„æ–¹å¼æ¥è®¿é—®å¹¶éå†é›†åˆå¯¹è±¡çš„å…ƒç´ ï¼Œè€Œæ— éœ€æš´éœ²é›†åˆçš„å†…éƒ¨è¡¨ç¤ºã€‚è¯¥æ¨¡å¼å°†éå†é›†åˆçš„è¿‡ç¨‹ä¸é›†åˆçš„å®ç°åˆ†ç¦»å¼€æ¥ï¼Œä½¿å¾—å¯ä»¥åœ¨ä¸å½±å“å®¢æˆ·ç«¯ä»£ç çš„æƒ…å†µä¸‹æ›´æ”¹é›†åˆçš„å†…éƒ¨å®ç°ã€‚\nè¿­ä»£å™¨æ¨¡å¼åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªå…ƒç´ ï¼š\n1.è¿­ä»£å™¨æ¥å£ï¼ˆIteratorï¼‰ï¼šå®šä¹‰äº†ç”¨äºè®¿é—®å’Œéå†é›†åˆå…ƒç´ çš„æ ‡å‡†æ–¹æ³•ã€‚\n2.å…·ä½“è¿­ä»£å™¨ï¼ˆConcrete Iteratorï¼‰ï¼šå®ç°äº†Iteratoræ¥å£ï¼Œç”¨äºéå†é›†åˆä¸­çš„å…ƒç´ ã€‚\n3.é›†åˆæ¥å£ï¼ˆAggregateï¼‰ï¼šå®šä¹‰äº†ä¸€ç»„ç”¨äºé›†åˆç®¡ç†å’Œè®¿é—®å…ƒç´ çš„æ–¹æ³•ã€‚\n4.å…·ä½“é›†åˆï¼ˆConcrete Aggregateï¼‰ï¼šå®ç°äº†Aggregateæ¥å£ï¼Œç”¨äºç®¡ç†å’Œè®¿é—®å…ƒç´ é›†åˆã€‚\né€šè¿‡ä½¿ç”¨è¿­ä»£å™¨æ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥å°†éå†å’Œé›†åˆçš„å®ç°åˆ†ç¦»å¼€æ¥ï¼Œä»è€Œä½¿å¾—å¯ä»¥æ–¹ä¾¿åœ°å¯¹é›†åˆè¿›è¡Œä¿®æ”¹è€Œä¸ä¼šå½±å“éå†çš„è¿‡ç¨‹ã€‚å¦å¤–ï¼Œé€šè¿‡æä¾›ä¸åŒçš„è¿­ä»£å™¨å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°å®ç°ä¸€äº›é«˜çº§çš„éå†éœ€æ±‚ï¼Œæ¯”å¦‚å€’åºéå†ã€è¿‡æ»¤éå†ç­‰ã€‚\nè¿­ä»£å™¨æ¨¡å¼ç¬¦åˆä»¥ä¸‹è½¯ä»¶è®¾è®¡åŸåˆ™ï¼š\n1.å•ä¸€èŒè´£åŸåˆ™ï¼šè¯¥æ¨¡å¼å°†é›†åˆçš„éå†ä¸é›†åˆæœ¬èº«çš„å®ç°åˆ†ç¦»å¼€æ¥ï¼Œä¿è¯æ¯ä¸ªå¯¹è±¡åªè´Ÿè´£è‡ªå·±çš„å•ä¸€èŒè´£ã€‚\n2.å¼€é—­åŸåˆ™ï¼šæ–°å¢ä¸€ç§é›†åˆç±»å‹æˆ–ä¿®æ”¹ç°æœ‰é›†åˆç±»å‹çš„å®ç°æ–¹å¼éƒ½ä¸ä¼šå½±å“åˆ°å·²æœ‰çš„è¿­ä»£å™¨å®ç°ï¼Œå› æ­¤è¯¥æ¨¡å¼å¯¹ä¿®æ”¹å…³é—­ï¼Œå¯¹æ‰©å±•å¼€æ”¾ã€‚\n3.ä¾èµ–å€’ç½®åŸåˆ™ï¼šåœ¨è¿­ä»£å™¨æ¨¡å¼ä¸­ï¼Œå®¢æˆ·ç«¯åªä¾èµ–äºè¿­ä»£å™¨æ¥å£ï¼Œè€Œä¸ä¾èµ–äºé›†åˆçš„å†…éƒ¨è¡¨ç¤ºï¼Œä»è€Œå°†é«˜å±‚æ¬¡æ¨¡å—ä»åº•å±‚æ¨¡å—ä¸­è§£è€¦å‡ºæ¥ã€‚\n4.è¿ªç±³ç‰¹åŸåˆ™ï¼šè¯¥æ¨¡å¼é€šè¿‡å°†éå†é›†åˆçš„è®¿é—®æ–¹æ³•å§”æ‰˜ç»™è¿­ä»£å™¨å¯¹è±¡æ¥éµå¾ªè¿ªç±³ç‰¹åŸåˆ™ï¼Œå³ä¸€ä¸ªå¯¹è±¡åº”è¯¥å¯¹å…¶ä»–å¯¹è±¡æœ‰æœ€å°‘çš„äº†è§£ã€‚\nä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„Javaæ¡ˆä¾‹ï¼Œæ¼”ç¤ºäº†è¿­ä»£å™¨çš„ä½¿ç”¨æ–¹å¼ï¼š\n//è¿­ä»£å™¨æ¥å£\ninterface Iterator&lt;T> &#123;\n    boolean hasNext();\n    T next();\n&#125;\n\n//é›†åˆæ¥å£\ninterface Aggregate&lt;T> &#123;\n    void add(T element);\n    void remove(T element);\n    Iterator&lt;T> iterator();\n&#125;\n\n//å…·ä½“é›†åˆ\nclass MyList&lt;T> implements Aggregate&lt;T> &#123;\n    private T[] elements;\n    private int size;\n    private int capacity;\n\n    public MyList(int capacity) &#123;\n        this.elements = (T[]) new Object[capacity];\n        this.size = 0;\n        this.capacity = capacity;\n    &#125;\n\n    public void add(T element) &#123;\n        if(size &lt; capacity) &#123;\n            elements[size] = element;\n            size++;\n        &#125;\n    &#125;\n\n    public void remove(T element) &#123;\n        for(int i = 0; i &lt; size; i++) &#123;\n            if(elements[i].equals(element)) &#123;\n                for(int j = i; j &lt; size - 1; j++) &#123;\n                    elements[j] = elements[j+1];\n                &#125;\n                size--;\n                break;\n            &#125;\n        &#125;\n    &#125;\n\n    public Iterator&lt;T> iterator() &#123;\n        return new MyListIterator();\n    &#125;\n\n    //å…·ä½“è¿­ä»£å™¨\n    private class MyListIterator implements Iterator&lt;T> &#123;\n        private int index = 0;\n\n        public boolean hasNext() &#123;\n            return index &lt; size;\n        &#125;\n\n        public T next() &#123;\n            T element = elements[index];\n            index++;\n            return element;\n        &#125;\n    &#125;\n&#125;\n\n//å®¢æˆ·ç«¯ä»£ç \npublic class IteratorDemo &#123;\n    public static void main(String[] args) &#123;\n        // åˆ›å»ºä¸€ä¸ªåˆ—è¡¨\n        MyList&lt;String> list = new MyList&lt;>(5);\n        list.add(\"One\");\n        list.add(\"Two\");\n        list.add(\"Three\");\n        list.add(\"Four\");\n        list.add(\"Five\");\n\n        // éå†åˆ—è¡¨ä¸­çš„å…ƒç´ \n            Iterator&lt;String> iterator = list.iterator();\n    while (iterator.hasNext()) &#123;\n        String element = iterator.next();\n        System.out.println(\"Element: \" + element);\n    &#125;\n&#125;\n\n åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå…·ä½“é›†åˆç±»MyListï¼Œè¯¥ç±»å®ç°äº†Aggregateæ¥å£ï¼Œå¹¶åŒ…å«äº†ä¸€ä¸ªå…·ä½“è¿­ä»£å™¨ç±»MyListIteratorã€‚æˆ‘ä»¬è¿˜å®šä¹‰äº†å®¢æˆ·ç«¯ä»£ç ç”¨äºæµ‹è¯•é›†åˆçš„éå†ï¼Œåˆ›å»ºäº†ä¸€ä¸ªåˆ—è¡¨å¹¶æ·»åŠ äº†å…ƒç´ ï¼Œç„¶åä½¿ç”¨è¿­ä»£å™¨éå†åˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ã€‚æ‰§è¡Œè¯¥ç¨‹åºï¼Œä¼šè¾“å‡ºä»¥ä¸‹ç»“æœï¼š \nElement: One\nElement: Two\nElement: Three\nElement: Four\nElement: Five\n\nåœ¨è¿­ä»£å™¨æ¨¡å¼ä¸­ï¼Œé›†åˆå’Œè¿­ä»£å™¨æ˜¯ç´§å¯†ç›¸å…³è”çš„ã€‚é›†åˆæä¾›äº†å¿«é€Ÿè®¿é—®è¿­ä»£å™¨çš„æ–¹æ³•ï¼Œè€Œè¿­ä»£å™¨åˆ™æä¾›äº†éå†æ•´ä¸ªé›†åˆçš„æ–¹æ³•ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›å»ºä¸åŒçš„è¿­ä»£å™¨å¯¹è±¡æ¥å®ç°ä¸åŒçš„éå†æ–¹å¼ï¼Œè€Œä¸ä¼šå½±å“åˆ°é›†åˆçš„åº•å±‚å®ç°ã€‚å› æ­¤ï¼Œè¿­ä»£å™¨æ¨¡å¼éå¸¸é€‚åˆäºéœ€è¦è®¿é—®å’Œéå†é›†åˆå…ƒç´ çš„åœºæ™¯ï¼Œå¯ä»¥æä¾›ä¸€ç§æ¸…æ™°ä¸”çµæ´»çš„è§£å†³æ–¹æ¡ˆã€‚\n","slug":"è¿­ä»£å™¨æ¨¡å¼","date":"2023-05-15T09:44:26.000Z","categories_index":"","tags_index":"Java,è®¾è®¡æ¨¡å¼","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"35b7e7d45f0bf660fac88351c60754e3","title":"å‘½ä»¤æ¨¡å¼","content":"å‘½ä»¤æ¨¡å¼å®ƒå…è®¸å°†è¯·æ±‚å°è£…ä¸ºå¯¹è±¡ï¼Œä»è€Œä½¿å¾—è¯·æ±‚çš„å‘é€è€…å’Œæ¥æ”¶è€…è§£è€¦ï¼ŒåŒæ—¶å¯å®ç°è¯·æ±‚çš„é˜Ÿåˆ—åŒ–ã€æ’¤é”€å’Œæ¢å¤ã€‚\nè¯¥æ¨¡å¼çš„å…³é”®ç‚¹æ˜¯å°†è¯·æ±‚ä¸å®ç°è§£è€¦å¹¶å¼•å…¥å‘½ä»¤å¯¹è±¡ï¼Œä»¥ä¾¿å°†è¯·æ±‚å‘é€ç»™ä¸åŒçš„å¯¹è±¡ï¼Œå¹¶å¯éšæ—¶è¿›è¡Œæ’¤é”€å’Œæ¢å¤ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå‘½ä»¤å¯¹è±¡åŒ…å«æ‰§è¡Œè¯·æ±‚çš„æ¥æ”¶è€…ã€è¯·æ±‚æ•°æ®ä»¥åŠå®ç°è¯¥è¯·æ±‚çš„æ–¹æ³•ã€‚\nå‘½ä»¤æ¨¡å¼åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªå…ƒç´ ï¼š\n1.å‘½ä»¤æ¥å£ï¼ˆCommandï¼‰ï¼šæ­¤æ¥å£å®šä¹‰äº†ä¸€ä¸ªexecute()æ–¹æ³•ï¼Œå½“Commandå¯¹è±¡è¢«è°ƒç”¨æ—¶ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨å…·ä½“å‘½ä»¤çš„execute()æ–¹æ³•ã€‚\n2.å…·ä½“å‘½ä»¤ç±»ï¼ˆConcrete Commandï¼‰ï¼šæ­¤ç±»å®ç°äº†Commandæ¥å£çš„execute()æ–¹æ³•ï¼Œå®ƒåŒ…å«äº†ä¸€ä¸ªReceiverå¯¹è±¡ï¼Œå¹¶åŒ…å«äº†æ‰§è¡Œæ‰€éœ€çš„æ‰€æœ‰å‚æ•°ã€‚\n3.æ¥æ”¶è€…ï¼ˆReceiverï¼‰ï¼šè¯¥ç»„ä»¶åŒ…å«äº†å®ç°å‘½ä»¤æ‰€éœ€çš„ä»£ç å’Œé€»è¾‘ã€‚\n4.è°ƒç”¨è€…ï¼ˆInvokerï¼‰ï¼šè¯¥ç»„ä»¶è´Ÿè´£å‘é€å‘½ä»¤ï¼Œé€šå¸¸ä¼šåŒ…å«ä¸€ä¸ªCommandå¯¹è±¡çš„å¼•ç”¨ã€‚å®ƒè¿˜å¯ç»´æŠ¤ä¸€ä¸ªå‘½ä»¤å†å²è®°å½•ï¼Œä»¥ä¾¿æ”¯æŒæ’¤é”€å’Œæ¢å¤æ“ä½œã€‚\n5.å®¢æˆ·ç«¯ï¼ˆClientï¼‰ï¼šè¯¥ç»„ä»¶åˆ›å»ºå…·ä½“å‘½ä»¤å¯¹è±¡ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™è°ƒç”¨è€…å¯¹è±¡ä»¥æ‰§è¡Œæ‰€éœ€çš„æ“ä½œã€‚\né€šè¿‡ä½¿ç”¨å‘½ä»¤æ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¯·æ±‚è€…ä¸å®ç°è€…å½»åº•è§£è€¦ï¼Œä½¿å¾—è¯·æ±‚è€…æ— éœ€çŸ¥é“å…·ä½“æ‰§è¡Œè€…çš„å­˜åœ¨å’Œå®ç°ç»†èŠ‚ï¼Œå¹¶ä¸”å¯ä»¥è½»æ¾åœ°å¯¹è¯·æ±‚è¿›è¡Œæ§åˆ¶ã€è¯„ä¼°ã€æµ‹è¯•å’Œç®¡ç†ã€‚åŒæ—¶ï¼Œå‘½ä»¤æ¨¡å¼è¿˜èƒ½å®ç°è¯·æ±‚çš„æ’¤é”€å’Œæ¢å¤ï¼Œå¤§å¤§æå‡ç³»ç»Ÿçš„å¯é æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚\nä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„Javaæ¡ˆä¾‹ï¼Œæ¼”ç¤ºäº†å‘½ä»¤æ¨¡å¼çš„ä½¿ç”¨æ–¹å¼ï¼š\n//å‘½ä»¤æ¥å£\npublic interface Command &#123;\n    void execute();\n&#125;\n\n//å…·ä½“å‘½ä»¤ç±»: æ‰“å¼€æ–‡ä»¶å‘½ä»¤\npublic class OpenCommand implements Command &#123;\n    private Receiver receiver;\n\n    public OpenCommand(Receiver receiver) &#123;\n        this.receiver = receiver;\n    &#125;\n\n    public void execute() &#123;\n        receiver.open();\n    &#125;\n&#125;\n\n//å…·ä½“å‘½ä»¤ç±»: å…³é—­æ–‡ä»¶å‘½ä»¤\npublic class CloseCommand implements Command &#123;\n    private Receiver receiver;\n\n    public CloseCommand(Receiver receiver) &#123;\n        this.receiver = receiver;\n    &#125;\n\n    public void execute() &#123;\n        receiver.close();\n    &#125;\n&#125;\n\n//æ¥æ”¶è€…ï¼šæ–‡ä»¶ç¼–è¾‘å™¨\npublic class Receiver &#123;\n    public void open() &#123;\n        System.out.println(\"æ‰“å¼€æ–‡ä»¶\");\n    &#125;\n\n    public void close() &#123;\n        System.out.println(\"å…³é—­æ–‡ä»¶\");\n    &#125;\n&#125;\n\n//è°ƒç”¨è€…ï¼šæ–‡æœ¬ç¼–è¾‘å™¨\npublic class Invoker &#123;\n    private Command openCommand;\n    private Command closeCommand;\n\n    public Invoker(Command openCommand, Command closeCommand) &#123;\n        this.openCommand = openCommand;\n        this.closeCommand = closeCommand;\n    &#125;\n\n    public void clickOpen() &#123;\n        openCommand.execute();\n    &#125;\n\n    public void clickClose() &#123;\n        closeCommand.execute();\n    &#125;\n&#125;\n\n//å®¢æˆ·ç«¯ä»£ç \npublic class CommandDemo &#123;\n    public static void main(String[] args) &#123;\n        // åˆ›å»ºæ¥æ”¶è€…\n        Receiver receiver = new Receiver();\n\n        // åˆ›å»ºå…·ä½“å‘½ä»¤å¯¹è±¡\n        Command openCommand = new OpenCommand(receiver);\n        Command closeCommand = new CloseCommand(receiver);\n\n        // åˆ›å»ºè°ƒç”¨è€…å¹¶å°†å…·ä½“å‘½ä»¤å¯¹è±¡ä¼ ç»™å®ƒ\n        Invoker invoker = new Invoker(openCommand, closeCommand);\n\n        // ç‚¹å‡»æ‰“å¼€æ–‡ä»¶æŒ‰é’®\n        invoker.clickOpen();\n\n        // ç‚¹å‡»å…³é—­æ–‡ä»¶æŒ‰é’®\n        invoker.clickClose();\n    &#125;\n&#125;\n\nåœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†å‘½ä»¤æ¥å£CommandåŠä¸¤ä¸ªå…·ä½“å‘½ä»¤ç±»OpenCommandå’ŒCloseCommandï¼Œå¯¹åº”äºæ–‡ä»¶çš„æ‰“å¼€å’Œå…³é—­æ“ä½œã€‚æˆ‘ä»¬è¿˜å®šä¹‰äº†ä¸€ä¸ªæ¥æ”¶è€…Receiverï¼Œè¡¨ç¤ºæ–‡ä»¶ç¼–è¾‘å™¨ï¼Œæ‹¥æœ‰æ‰“å¼€å’Œå…³é—­æ–‡ä»¶çš„æ“ä½œã€‚Invokerè´Ÿè´£è°ƒç”¨å…·ä½“å‘½ä»¤å¯¹è±¡æ‰§è¡Œå¯¹åº”çš„æ“ä½œï¼Œå³ç‚¹å‡»æ‰“å¼€æˆ–å…³é—­æ–‡ä»¶æŒ‰é’®ã€‚å®¢æˆ·ç«¯ä»£ç åˆ›å»ºå…·ä½“å‘½ä»¤å¯¹è±¡å’Œè°ƒç”¨è€…ï¼Œå¹¶ä¼ å…¥ã€‚\n","slug":"å‘½ä»¤æ¨¡å¼","date":"2023-05-15T09:17:29.000Z","categories_index":"","tags_index":"Java,è®¾è®¡æ¨¡å¼","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"d75c20296e97428894e8c62bab0f606e","title":"è®¿é—®è€…æ¨¡å¼","content":"è®¿é—®è€…æ¨¡å¼å®ƒå°†ç®—æ³•å°è£…åˆ°ç‹¬ç«‹çš„å¯¹è±¡ä¸­ï¼Œä½¿å…¶å¯ä»¥åœ¨ä¸ä¿®æ”¹ç°æœ‰å¯¹è±¡ç»“æ„çš„æƒ…å†µä¸‹å¢åŠ æ–°çš„æ“ä½œã€‚è®¿é—®è€…æ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨è¢«è®¿é—®çš„å¯¹è±¡ä¸Šå®šä¹‰ä¸€ä¸ªæ¥å—è®¿é—®è€…å¯¹è±¡çš„æ¥å£ï¼Œç„¶åè®¿é—®è€…å¯¹è±¡é€šè¿‡è¯¥æ¥å£è®¿é—®è¢«è®¿é—®å¯¹è±¡ã€‚è¿™æ ·å¯ä»¥ä½¿å¾—è¢«è®¿é—®å¯¹è±¡ä¿æŒç¨³å®šï¼Œè€Œè®¿é—®è€…å¯¹è±¡å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œæ‰©å±•ã€‚\nè®¿é—®è€…æ¨¡å¼åŒ…å«ä»¥ä¸‹å‡ ä¸ªå…ƒç´ ï¼š\n1.è®¿é—®è€…ï¼ˆVisitorï¼‰ï¼šè¯¥ç»„ä»¶å®šä¹‰äº†å¤„ç†å¯¹è±¡ç»“æ„ä¸­å„ä¸ªå…ƒç´ æ‰€è¦æ‰§è¡Œçš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•æ¥å—çš„å‚æ•°å¯ä»¥æ˜¯å…ƒç´ æœ¬èº«ï¼Œä¹Ÿå¯ä»¥æ˜¯å…ƒç´ çš„ç‰¹å®šå±æ€§ã€‚\n2.å…·ä½“è®¿é—®è€…ï¼ˆConcrete Visitorï¼‰ï¼šè¯¥ç»„ä»¶å®ç°äº†è®¿é—®è€…å®šä¹‰çš„æ–¹æ³•ï¼Œä»¥ä¾¿å¯ä»¥å¯¹å¯¹è±¡ç»“æ„ä¸­çš„ä¸åŒå…ƒç´ æ‰§è¡Œç‰¹å®šçš„æ“ä½œã€‚\n3.å…ƒç´ ï¼ˆElementï¼‰ï¼šè¯¥ç»„ä»¶å®šä¹‰äº†è®¿é—®è€…èƒ½å¤Ÿè®¿é—®çš„æ¥å£ï¼Œä¸€èˆ¬å®ƒåŒ…å«ä¸€ä¸ª accept() æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªè®¿é—®è€…ä½œä¸ºå‚æ•°ã€‚\n4.å…·ä½“å…ƒç´ ï¼ˆConcrete Elementï¼‰ï¼šè¯¥ç»„ä»¶å®ç°äº†å…ƒç´ çš„æ¥å£ï¼Œå®ƒå¯ä»¥è¢«ä¸€ä¸ªå…·ä½“è®¿é—®è€…å®ä¾‹è®¿é—®å¹¶æ‰§è¡Œç‰¹å®šçš„æ“ä½œã€‚\n5.å¯¹è±¡ç»“æ„ï¼ˆObject Structureï¼‰ï¼šè¯¥ç»„ä»¶æ˜¯å…ƒç´ çš„é›†åˆï¼Œå®ƒå®šä¹‰äº†å…ƒç´ çš„é›†åˆä»¥åŠæä¾›å¯ä»¥æ¥å—è®¿é—®è€…è®¿é—®çš„æ¥å£ã€‚\nä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„Javaæ¡ˆä¾‹ï¼Œæ¼”ç¤ºäº†è®¿é—®è€…æ¨¡å¼çš„ä½¿ç”¨æ–¹å¼ï¼š\nå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå›¾å½¢ç±»å±‚æ¬¡ç»“æ„ï¼ŒåŒ…æ‹¬Rectangleã€Circleå’ŒTriangleä¸‰ä¸ªå…·ä½“ç±»å‹ã€‚æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªVisitoræ¥å£ï¼Œå°†ä¸åŒçš„æ“ä½œå®šä¹‰ä¸ºVisitorçš„æ–¹æ³•ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥å®ç°å…·ä½“çš„Visitorç±» RectangleVisitorã€CircleVisitorå’ŒTriangleVisitorï¼Œå¹¶ä¸ºæ¯ä¸ªå…·ä½“ç±»æä¾›accept()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªVisitorå¯¹è±¡å¹¶è°ƒç”¨visit()æ–¹æ³•ã€‚\n// Elementæ¥å£\ninterface Shape &#123;\n    void accept(Visitor v);\n&#125;\n\n// å…·ä½“å…ƒç´ ç±»ï¼šçŸ©å½¢\nclass Rectangle implements Shape &#123;\n    public void accept(Visitor v) &#123;\n        v.visit(this);\n    &#125;\n&#125;\n\n// å…·ä½“å…ƒç´ ç±»ï¼šåœ†å½¢\nclass Circle implements Shape &#123;\n    public void accept(Visitor v) &#123;\n        v.visit(this);\n    &#125;\n&#125;\n\n// å…·ä½“å…ƒç´ ç±»ï¼šä¸‰è§’å½¢\nclass Triangle implements Shape &#123;\n    public void accept(Visitor v) &#123;\n        v.visit(this);\n    &#125;\n&#125;\n\n// Visitoræ¥å£\ninterface Visitor &#123;\n    void visit(Rectangle r);\n    void visit(Circle c);\n    void visit(Triangle t);\n&#125;\n\n// å…·ä½“è®¿é—®è€…ç±»ï¼šç”¨äºè®¡ç®—å›¾å½¢é¢ç§¯\nclass AreaVisitor implements Visitor &#123;\n    public void visit(Rectangle r) &#123;\n        System.out.println(\"è®¡ç®—çŸ©å½¢çš„é¢ç§¯\");\n    &#125;\n    public void visit(Circle c) &#123;\n        System.out.println(\"è®¡ç®—åœ†å½¢çš„é¢ç§¯\");\n    &#125;\n    public void visit(Triangle t) &#123;\n        System.out.println(\"è®¡ç®—ä¸‰è§’å½¢çš„é¢ç§¯\");\n    &#125;\n&#125;\n\n// å…·ä½“è®¿é—®è€…ç±»ï¼šç”¨äºè®¡ç®—å›¾å½¢å‘¨é•¿\nclass PerimeterVisitor implements Visitor &#123;\n    public void visit(Rectangle r) &#123;\n        System.out.println(\"è®¡ç®—çŸ©å½¢çš„å‘¨é•¿\");\n    &#125;\n    public void visit(Circle c) &#123;\n        System.out.println(\"è®¡ç®—åœ†å½¢çš„å‘¨é•¿\");\n    &#125;\n    public void visit(Triangle t) &#123;\n        System.out.println(\"è®¡ç®—ä¸‰è§’å½¢çš„å‘¨é•¿\");\n    &#125;\n&#125;\n\n// æµ‹è¯•ä»£ç \npublic class VisitorDemo &#123;\n    public static void main(String[] args) &#123;\n        // åˆ›å»ºå›¾å½¢åˆ—è¡¨\n        Shape[] shapes = &#123; new Rectangle(), new Circle(), new Triangle() &#125;;\n\n        // è®¡ç®—é¢ç§¯\n        Visitor areaVisitor = new AreaVisitor();\n        for (Shape shape : shapes) &#123;\n            shape.accept(areaVisitor);\n        &#125;\n\n        // è®¡ç®—å‘¨é•¿\n        Visitor perimeterVisitor = new PerimeterVisitor();\n        for (Shape shape : shapes) &#123;\n            shape.accept(perimeterVisitor);\n        &#125;\n    &#125;\n&#125;\n\nåœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸‰ä¸ªå…·ä½“å…ƒç´ ç±»ï¼šçŸ©å½¢ã€åœ†å½¢å’Œä¸‰è§’å½¢ï¼Œå¹¶å®šä¹‰äº†ä¸¤ä¸ªå…·ä½“è®¿é—®è€…ç±»ï¼šç”¨äºè®¡ç®—é¢ç§¯å’Œå‘¨é•¿ã€‚åœ¨æµ‹è¯•ä»£ç ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå›¾å½¢åˆ—è¡¨ï¼Œéå†è¯¥åˆ—è¡¨å¹¶åˆ†åˆ«ä½¿ç”¨AreaVisitorå’ŒPerimeterVisitorè®¿é—®å™¨è®¡ç®—æ¯ä¸€ä¸ªå›¾å½¢çš„é¢ç§¯å’Œå‘¨é•¿ã€‚æ‰§è¡Œè¯¥ç¨‹åºä¼šè¾“å‡ºå¦‚ä¸‹ç»“æœï¼š\nè®¡ç®—çŸ©å½¢çš„é¢ç§¯\nè®¡ç®—åœ†å½¢çš„é¢ç§¯\nè®¡ç®—ä¸‰è§’å½¢çš„é¢ç§¯\nè®¡ç®—çŸ©å½¢çš„å‘¨é•¿\nè®¡ç®—åœ†å½¢çš„å‘¨é•¿\nè®¡ç®—ä¸‰è§’å½¢çš„å‘¨é•¿\n\næ¡ˆä¾‹äºŒ\nä¸‹é¢æ˜¯ä¸€ä¸ªJavaå®ç°è®¿é—®è€…æ¨¡å¼çš„å°æ¡ˆä¾‹ã€‚å‡è®¾æœ‰ä¸€ä¸ªç”µå•†å¹³å°ï¼Œéœ€è¦å¯¹ç”¨æˆ·è´­ä¹°è®°å½•è¿›è¡Œåˆ†æï¼ŒåŒ…æ‹¬è®¡ç®—ç”¨æˆ·è´­ä¹°æ€»é‡‘é¢ã€è®¡ç®—ç”¨æˆ·è´­ä¹°ç‰©å“ç§ç±»æ•°ç­‰ç»Ÿè®¡å·¥ä½œã€‚é¦–å…ˆå®šä¹‰è¢«è®¿é—®å¯¹è±¡ï¼šè´­ç‰©è½¦æ¡ç›®CartItemå’Œç”¨æˆ·è´­ç‰©è½¦Cartï¼š\npublic interface CartItem &#123;\n    void accept(Visitor visitor);\n&#125;\n\npublic class ProductCartItem implements CartItem &#123;\n    private String name;\n    private double price;\n\n    public ProductCartItem(String name, double price) &#123;\n        this.name = name;\n        this.price = price;\n    &#125;\n\n    public String getName() &#123;\n        return name;\n    &#125;\n\n    public double getPrice() &#123;\n        return price;\n    &#125;\n\n    @Override\n    public void accept(Visitor visitor) &#123;\n        visitor.visit(this);\n    &#125;\n&#125;\n\npublic class ServiceCartItem implements CartItem &#123;\n    private String name;\n    private double fee;\n\n    public ServiceCartItem(String name, double fee) &#123;\n        this.name = name;\n        this.fee = fee;\n    &#125;\n\n    public String getName() &#123;\n        return name;\n    &#125;\n\n    public double getFee() &#123;\n        return fee;\n    &#125;\n\n    @Override\n    public void accept(Visitor visitor) &#123;\n        visitor.visit(this);\n    &#125;\n&#125;\n\npublic class Cart &#123;\n    private List&lt;CartItem> cartItems = new ArrayList&lt;>();\n\n    public void addItem(CartItem item) &#123;\n        cartItems.add(item);\n    &#125;\n\n    public void removeItem(CartItem item) &#123;\n        cartItems.remove(item);\n    &#125;\n\n    public void accept(Visitor visitor) &#123;\n        for (CartItem item : cartItems) &#123;\n            item.accept(visitor);\n        &#125;\n        visitor.visit(this);\n    &#125;\n&#125;\n\nå…¶ä¸­ï¼ŒCartç±»ä¸ºè´­ç‰©è½¦ç±»ï¼Œå¯ä»¥æ·»åŠ å’Œåˆ é™¤è´­ç‰©é¡¹ï¼Œacceptæ–¹æ³•æ¥å—Visitorè®¿é—®ã€‚\nç„¶åå®šä¹‰è®¿é—®è€…Visitorï¼Œç”¨æ¥è®¡ç®—è´­ç‰©è½¦ä¸­çš„ç»Ÿè®¡æ•°æ®ï¼š\npublic interface Visitor &#123;\n    void visit(ProductCartItem item);\n    void visit(ServiceCartItem item);\n    void visit(Cart cart);\n&#125;\n\npublic class CartStatisticsVisitor implements Visitor &#123;\n    private double totalAmount;\n    private int distinctProductCount;\n\n    public double getTotalAmount() &#123;\n        return totalAmount;\n    &#125;\n\n    public int getDistinctProductCount() &#123;\n        return distinctProductCount;\n    &#125;\n\n    @Override\n    public void visit(ProductCartItem item) &#123;\n        totalAmount += item.getPrice();\n        distinctProductCount++;\n    &#125;\n\n    @Override\n    public void visit(ServiceCartItem item) &#123;\n        totalAmount += item.getFee();\n    &#125;\n\n    @Override\n    public void visit(Cart cart) &#123;\n        System.out.printf(\"Total amount: $%.2f, distinct product count: %d%n\", \n            totalAmount, distinctProductCount);\n    &#125;\n&#125;\n\nCartStatisticsVisitorç±»å®ç°äº†Visitoræ¥å£ï¼Œè®¡ç®—è´­ç‰©è½¦ä¸­çš„æ•°é‡å’Œæ€»é‡‘é¢ã€‚visitæ–¹æ³•æ ¹æ®è¢«è®¿é—®å¯¹è±¡è¿›è¡Œç›¸åº”çš„è®¡ç®—ï¼Œå¹¶å°†ç»“æœè®°å½•åœ¨ä¸­é—´å˜é‡ä¸­ã€‚æœ€åï¼Œvisit(Cart cart)æ–¹æ³•è¾“å‡ºç»“æœã€‚\nä½¿ç”¨è®¿é—®è€…æ¨¡å¼ç»Ÿè®¡è´­ç‰©è½¦ä¸Šçš„æ€»é‡‘é¢å’Œä¸åŒå•†å“æ•°é‡ï¼š\npublic class Main &#123;\n    public static void main(String[] args) &#123;\n        Cart cart = new Cart();\n        cart.addItem(new ProductCartItem(\"Apple\", 3.99));\n        cart.addItem(new ProductCartItem(\"Banana\", 2.99));\n        cart.addItem(new ServiceCartItem(\"Delivery fee\", 5.99));\n\n        CartStatisticsVisitor visitor = new CartStatisticsVisitor();\n        cart.accept(visitor);\n    &#125;\n&#125;\n\nè¾“å‡ºç»“æœä¸ºï¼š\nTotal amount: $12.97, distinct product count: 2\n\nè¿™æ ·ï¼Œé€šè¿‡è®¿é—®è€…æ¨¡å¼å¯ä»¥æ–¹ä¾¿åœ°å¯¹è´­ç‰©è½¦æ•°æ®è¿›è¡Œç»Ÿè®¡åˆ†æï¼Œè€Œä¸ä¼šä¿®æ”¹ç°æœ‰ä»£ç ã€‚\n","slug":"è®¿é—®è€…æ¨¡å¼","date":"2023-05-15T08:21:18.000Z","categories_index":"","tags_index":"Java,è®¾è®¡æ¨¡å¼","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"ba45023a93415880bd8ff889992600c8","title":"ä¸­ä»‹è€…æ¨¡å¼","content":"ä¸­ä»‹è€…æ¨¡å¼å®ƒçš„ä½œç”¨æ˜¯å‡å°‘å¯¹è±¡ä¹‹é—´çš„ç›´æ¥è€¦åˆå…³ç³»ï¼Œé€šè¿‡å¼•å…¥ä¸€ä¸ªä¸­ä»‹è€…å¯¹è±¡æ¥åè°ƒå¤šä¸ªå¯¹è±¡ä¹‹é—´çš„äº¤äº’è¡Œä¸ºï¼Œä»è€Œå°†ç³»ç»Ÿä¸­å¤æ‚çš„ç½‘çŠ¶å…³ç³»å˜ä¸ºç®€å•çš„æ˜Ÿå‹ç»“æ„ã€‚\nä¸­ä»‹è€…æ¨¡å¼çš„æœºåˆ¶åŸºäºä»¥ä¸‹ä¸¤ä¸ªå…³é”®ç‚¹ï¼š\n\næŠ½è±¡ä¸­ä»‹è€…ï¼ˆMediatorï¼‰ï¼šä¸ºäº†æŠŠå„åŒäº‹ç±»çš„è€¦åˆåº¦é™åˆ°æœ€ä½ï¼Œå°†å¯¹è±¡é—´é€šä¿¡çš„æ§åˆ¶äº¤ç»™ä¸€ä¸ªä¸­ä»‹è€…æ¥åè°ƒè°ƒåº¦ï¼Œå…·ä½“åŒäº‹ç±»éƒ½ä¾èµ–ä¸­ä»‹è€…ï¼Œç”±ä¸­ä»‹è€…è´Ÿè´£æ¶ˆæ¯çš„è½¬å‘å’Œåè°ƒã€‚\nå…·ä½“ä¸­ä»‹è€…ï¼ˆConcrete Mediatorï¼‰ï¼šå®ƒä»å…·ä½“çš„åŒäº‹ç±»æ¥æ”¶æ¶ˆæ¯ï¼Œå¹¶å‘å…·ä½“åŒäº‹ç±»å‘é€å‘½ä»¤ã€‚å®ƒå°†å„ä¸ªåŒäº‹å¯¹è±¡ä¹‹é—´çš„äº¤äº’è¿‡ç¨‹æ‰€éœ€çš„ä¿¡æ¯è¿›è¡Œäº†å°è£…ï¼Œä½¿å¾—å„ä¸ªåŒäº‹ç±»ä¸å†éœ€è¦æ˜¾å¼åœ°å¼•ç”¨å…¶ä»–åŒäº‹ç±»ã€‚\n\nä¸­ä»‹è€…æ¨¡å¼çš„ä¼˜ç‚¹æœ‰ï¼š\n\nä¸­ä»‹è€…æ¨¡å¼ç®€åŒ–äº†å¯¹è±¡ä¹‹é—´çš„äº¤äº’å…³ç³»ï¼Œå°†å¯¹è±¡ä¹‹é—´å¤æ‚çš„ç½‘çŠ¶ç»“æ„è½¬å˜ä¸ºç®€å•çš„æ˜Ÿå‹ç»“æ„ã€‚\nä¸­ä»‹è€…æ¨¡å¼ä½¿å¾—å„å¯¹è±¡ä¹‹é—´çš„è€¦åˆåº¦å¤§å¤§é™ä½ï¼Œå¯ä»¥ç‹¬ç«‹åœ°å˜åŒ–å’Œå¤ç”¨ã€‚\nä¸­ä»‹è€…æ¨¡å¼æ˜“äºæ‰©å±•ï¼Œå¢åŠ æ–°çš„åŒäº‹ç±»æ—¶ä¸éœ€è¦ä¿®æ”¹åŸæœ‰çš„ä»£ç ï¼Œåªéœ€è¦æŒ‰ç…§åŒæ ·çš„æ–¹å¼å®ç°æ–°çš„åŒäº‹ç±»å³å¯ã€‚\n\nä¸­ä»‹è€…æ¨¡å¼çš„ç¼ºç‚¹æœ‰ï¼š\n\nä¸­ä»‹è€…æ¨¡å¼ä¼šå¢åŠ ç³»ç»Ÿä¸­å¯¹è±¡çš„ä¸ªæ•°ï¼Œä½¿å¾—ç³»ç»Ÿå˜å¾—å¤æ‚ã€‚\nä¸­ä»‹è€…æ¨¡å¼ä¸­ï¼Œä¸­ä»‹è€…å¯¹è±¡å¯èƒ½ä¼šå˜å¾—è¿‡äºå¤æ‚ï¼Œéš¾ä»¥ç»´æŠ¤ä¸æ›´æ–°ã€‚\n\nä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¸­ä»‹è€…æ¨¡å¼çš„ç¤ºä¾‹ï¼Œå‡è®¾æœ‰ä¸‰ä¸ªå¯¹è±¡ä¹‹é—´éœ€è¦è¿›è¡Œé€šä¿¡ï¼šä¹°æ–¹ã€å–æ–¹å’Œä¸­ä»‹è€…ã€‚ä¹°æ–¹æƒ³è¦è´­ä¹°ç‰©å“ï¼Œå–æ–¹æƒ³è¦å‡ºå”®ç‰©å“ï¼Œè€Œä¸­ä»‹è€…ä½œä¸ºåè°ƒè€…æ¥å¸®åŠ©ä¹°å–åŒæ–¹è¿›è¡Œäº¤æ˜“ã€‚\n// å®šä¹‰ä¹°æ–¹ç±»\npublic class Buyer &#123;\n    private Mediator mediator;\n\n    public void setMediator(Mediator mediator) &#123;\n        this.mediator = mediator;\n    &#125;\n\n    public void buyItem() &#123;\n        mediator.buyItem();\n    &#125;\n\n    public void receiveItem() &#123;\n        System.out.println(\"Received item from seller.\");\n    &#125;\n&#125;\n\n// å®šä¹‰å–æ–¹ç±»\npublic class Seller &#123;\n    private Mediator mediator;\n\n    public void setMediator(Mediator mediator) &#123;\n        this.mediator = mediator;\n    &#125;\n\n    public void sellItem() &#123;\n        mediator.sellItem();\n    &#125;\n\n    public void receivePayment() &#123;\n        System.out.println(\"Received payment from buyer.\");\n    &#125;\n&#125;\n\n// å®šä¹‰ä¸­ä»‹è€…æ¥å£\npublic interface Mediator &#123;\n    void buyItem();\n    void sellItem();\n&#125;\n\n// å®šä¹‰å…·ä½“ä¸­ä»‹è€…ç±»\npublic class TradeMediator implements Mediator &#123;\n    private Buyer buyer;\n    private Seller seller;\n\n    public void setBuyer(Buyer buyer) &#123;\n        this.buyer = buyer;\n        buyer.setMediator(this);\n    &#125;\n\n    public void setSeller(Seller seller) &#123;\n        this.seller = seller;\n        seller.setMediator(this);\n    &#125;\n\n    public void buyItem() &#123;\n        seller.receivePayment();\n        buyer.receiveItem();\n    &#125;\n\n    public void sellItem() &#123;\n        buyer.receivePayment();\n        seller.receiveItem();\n    &#125;\n&#125;\n\n// æµ‹è¯•ç±»\npublic class MediatorTest &#123;\n    public static void main(String[] args) &#123;\n        TradeMediator mediator = new TradeMediator();\n        Buyer buyer = new Buyer();\n        Seller seller = new Seller();\n\n        mediator.setBuyer(buyer);\n        mediator.setSeller(seller);\n\n        buyer.buyItem();\n        seller.sellItem();\n    &#125;\n&#125;\n\nåœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œå„ä¸ªç±»åˆ†åˆ«ä»£è¡¨äº†ä¹°æ–¹ã€å–æ–¹å’Œä¸­ä»‹è€…ã€‚ä¹°æ–¹éœ€è¦è´­ä¹°ç‰©å“å¹¶æ¥æ”¶ç‰©å“ï¼Œå–æ–¹éœ€è¦å‡ºå”®ç‰©å“å¹¶æ¥æ”¶ä»˜æ¬¾ï¼Œè€Œä¸­ä»‹è€…åˆ™è´Ÿè´£è°ƒèŠ‚ä¹°å–åŒæ–¹ä¹‹é—´çš„äº¤æ˜“ã€‚é€šè¿‡ä¸­ä»‹è€…æ¨¡å¼ï¼Œä¹°æ–¹å’Œå–æ–¹å¯ä»¥é€šè¿‡ä¸­ä»‹è€…æ¥è¿›è¡Œé€šä¿¡ï¼Œå®ƒä»¬ä¸éœ€è¦ç›´æ¥ç›¸äº’äº†è§£ï¼Œä»è€Œé™ä½äº†è€¦åˆåº¦ã€‚\n","slug":"ä¸­ä»‹è€…æ¨¡å¼","date":"2023-05-15T07:45:06.000Z","categories_index":"","tags_index":"Java,è®¾è®¡æ¨¡å¼","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"4fe76f7b940933ddf5de5f39814faa1c","title":"MySQL_DQL","content":"DQLDQLè‹±æ–‡å…¨ç§°æ˜¯Data Query Language(æ•°æ®æŸ¥è¯¢è¯­è¨€)ï¼Œæ•°æ®æŸ¥è¯¢è¯­è¨€ï¼Œç”¨æ¥æŸ¥è¯¢æ•°æ®åº“ä¸­è¡¨çš„è®°å½•\nåŸºæœ¬è¯­æ³•DQL æŸ¥è¯¢è¯­å¥ï¼Œè¯­æ³•ç»“æ„å¦‚ä¸‹ï¼š\nSELET\n\tå­—æ®µåˆ—è¡¨\nFROM\n\tè¡¨ååˆ—è¡¨\nWHERE\n\tæ¡ä»¶åˆ—è¡¨\nGROUP BY\n\tåˆ†ç»„å­—æ®µåˆ—è¡¨\nHAVING\n\tåˆ†ç»„åæ¡ä»¶åˆ—è¡¨\nORDER BY\n\tæ’åºå­—æ®µåˆ—è¡¨\nLIMIT\n\tåˆ†é¡µå‚æ•°\n\n\nåŸºæœ¬æŸ¥è¯¢ï¼ˆä¸å¸¦ä»»ä½•æ¡ä»¶ï¼‰\n\næ¡ä»¶æŸ¥è¯¢ï¼ˆWHEREï¼‰\n\nèšåˆå‡½æ•°ï¼ˆcountã€maxã€minã€avgã€sumï¼‰\n\nåˆ†ç»„æŸ¥è¯¢ï¼ˆgroup byï¼‰\n\næ’åºæŸ¥è¯¢ï¼ˆorder byï¼‰\n\nåˆ†é¡µæŸ¥è¯¢ï¼ˆlimitï¼‰\n\n\nåŸºç¡€æŸ¥è¯¢ * å·ä»£è¡¨æŸ¥è¯¢æ‰€æœ‰å­—æ®µï¼Œåœ¨å®é™…å¼€å‘ä¸­å°½é‡å°‘ç”¨ï¼ˆä¸ç›´è§‚ã€å½±å“æ•ˆç‡ï¼‰\n æŸ¥è¯¢å¤šä¸ªå­—æ®µ\nSELECT å­—æ®µ1, å­—æ®µ2, å­—æ®µ3 ... FROM è¡¨å ;\n\nSELECT * FROM è¡¨å ;\n\nå­—æ®µè®¾ç½®åˆ«å\nSELECT å­—æ®µ1 [ AS åˆ«å1 ] , å­—æ®µ2 [ AS åˆ«å2 ] ... FROM è¡¨å; \n\nSELECT å­—æ®µ1 [ åˆ«å1 ] , å­—æ®µ2 [ åˆ«å2 ] ... FROM è¡¨å;\n\nå»é™¤é‡å¤è®°å½•(DISTINCT)\nSELECT DISTINCT å­—æ®µåˆ—è¡¨ FROM è¡¨å;\n\næŸ¥è¯¢æ‰€æœ‰å‘˜å·¥çš„å·¥ä½œåœ°å€,èµ·åˆ«å,ä¸é‡å¤\nSELECT DISTINCT workaddress 'å·¥ä½œåœ°å€' from  emp;\n\næ¡ä»¶æŸ¥è¯¢è¯­æ³•\nSELECT å­—æ®µå from è¡¨å WHERE æ¡ä»¶åˆ—è¡¨; \n\n\n\n\nè¿ç®—ç¬¦\nåŠŸèƒ½\n\n\n\n&gt; ã€&gt;&#x3D;\nå¤§äºã€å¤§äºç­‰äº\n\n\n&lt; ã€&lt;&#x3D;\nå°äºã€å°äºç­‰äº\n\n\n&#x3D;\nç­‰äº\n\n\n&lt;&gt; ã€!&#x3D;\nä¸ç­‰äº\n\n\nBETWEEN â€¦ AND â€¦\nåœ¨æŸä¸ªèŒƒå›´ä¹‹å†…(åŒ…å«æœ€å°ã€æœ€å¤§å€¼)\n\n\nIN(â€¦)\nåœ¨inä¹‹åçš„åˆ—è¡¨ä¸­çš„å€¼\n\n\nLIKE  å ä½ç¬¦\næ¨¡ç³ŠåŒ¹é…(_åŒ¹é…å•ä¸ªå­—ç¬¦, %åŒ¹é…ä»»æ„ä¸ªå­—ç¬¦)\n\n\nIS  NOT NULL\nä¸æ˜¯NULL\n\n\nIS  NULL\næ˜¯NULL\n\n\nAND ã€&amp;&amp;\nå¹¶ä¸” (å¤šä¸ªæ¡ä»¶åŒæ—¶æˆç«‹)\n\n\nOR ã€||\næˆ–è€… (å¤šä¸ªæ¡ä»¶ä»»æ„ä¸€ä¸ªæˆç«‹)\n\n\nNOT ã€!\né , ä¸æ˜¯\n\n\n å°æ¡ˆä¾‹ï¼šæŸ¥è¯¢æ²¡æœ‰èº«ä»½è¯å·çš„å‘˜å·¥ä¿¡æ¯\nä¸å¯ä»¥ä½¿ç”¨ &#x3D; null\nSELECT * FROM emp WHERE idcard IS NULL;\n\nèšåˆå‡½æ•°\nå°†ä¸€åˆ—æ•°æ®ä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œè¿›è¡Œçºµå‘è®¡ç®—\nå¸¸è§çš„èšåˆå‡½æ•°\n\n\n\nå‡½æ•°\næè¿°\n\n\n\ncount\nç»Ÿè®¡æ•°é‡\n\n\nmax\næœ€å¤§å€¼\n\n\nmin\næœ€å°å€¼\n\n\navg\nå¹³å‡å€¼\n\n\nsum\næ±‚å’Œ\n\n\nè¯­æ³•\nSELECT èšåˆå‡½æ•°(å­—æ®µåˆ—è¡¨) FROM è¡¨å [æ¡ä»¶æŸ¥è¯¢] ...;\n\næ³¨æ„ :NULLå€¼æ˜¯ä¸å‚ä¸æ‰€æœ‰èšåˆå‡½æ•°è¿ç®—çš„\nå¯¹äºcountèšåˆå‡½æ•°ï¼Œç»Ÿè®¡ç¬¦åˆæ¡ä»¶çš„æ€»è®°å½•æ•°ï¼Œè¿˜å¯ä»¥é€šè¿‡ count(æ•°å­—&#x2F;å­—ç¬¦ä¸²)çš„å½¢å¼è¿›è¡Œç»Ÿè®¡æŸ¥è¯¢\nå°æ¡ˆä¾‹ï¼šç»Ÿè®¡è¯¥ä¼ä¸šå‘˜å·¥æ•°é‡\nSELECT count(idcard) from emp;\t-- å­—æ®µå€¼ä¸ºNULLï¼Œæ˜¯ä¸å‚ä¸æ‰€æœ‰èšåˆå‡½æ•°è¿ç®—çš„\nSELECT count(*) from emp;\nSELECT count(1) from emp;\n\nåˆ†ç»„æŸ¥è¯¢\nSELECT å­—æ®µåˆ—è¡¨ FROM è¡¨å [ WHERE æ¡ä»¶ ] GROUP BY åˆ†ç»„å­—æ®µå [ HAVING åˆ†ç»„\nåè¿‡æ»¤æ¡ä»¶ ];\n\n whereä¸havingåŒºåˆ«\n\næ‰§è¡Œæ—¶æœºä¸åŒï¼šwhereæ˜¯åˆ†ç»„ä¹‹å‰è¿›è¡Œè¿‡æ»¤ï¼Œä¸æ»¡è¶³whereæ¡ä»¶ï¼Œä¸å‚ä¸åˆ†ç»„ï¼›è€Œhavingæ˜¯åˆ†ç»„ä¹‹åå¯¹ç»“æœè¿›è¡Œè¿‡æ»¤\n\nåˆ¤æ–­æ¡ä»¶ä¸åŒï¼šwhereä¸èƒ½å¯¹èšåˆå‡½æ•°è¿›è¡Œåˆ¤æ–­ï¼Œè€Œhavingå¯ä»¥\n\n\næ³¨æ„äº‹é¡¹:\n\nåˆ†ç»„ä¹‹åï¼ŒæŸ¥è¯¢çš„å­—æ®µä¸€èˆ¬ä¸ºèšåˆå‡½æ•°å’Œåˆ†ç»„å­—æ®µï¼ŒæŸ¥è¯¢å…¶ä»–å­—æ®µæ— ä»»ä½•æ„ä¹‰ã€‚\n\næ‰§è¡Œé¡ºåº: where &gt; èšåˆå‡½æ•° &gt; having ã€‚\n\næ”¯æŒå¤šå­—æ®µåˆ†ç»„, å…·ä½“è¯­æ³•ä¸º : group by columnA,columnB\n\n\nå°æ¡ˆä¾‹ï¼šæŸ¥è¯¢å¹´é¾„å°äº45çš„å‘˜å·¥ , å¹¶æ ¹æ®å·¥ä½œåœ°å€åˆ†ç»„ , è·å–å‘˜å·¥æ•°é‡å¤§äºç­‰äº3çš„å·¥ä½œåœ°å€\nselect workaddress,count(*) number from emp \nwhere age &lt; 45 \ngroup by workaddress\nhaving number >= 3;\n\nå°æ¡ˆä¾‹ï¼š ç»Ÿè®¡å„ä¸ªå·¥ä½œåœ°å€ä¸Šç­çš„ç”·æ€§åŠå¥³æ€§å‘˜å·¥çš„æ•°é‡\nselect workaddress,gender,count(*) number from emp GROUP BY workaddress, gender;\n\næ’åºæŸ¥è¯¢ è¯­æ³•\nSELECT å­—æ®µåˆ—è¡¨ FROM è¡¨å ORDER BY å­—æ®µ1 æ’åºæ–¹å¼1 , å­—æ®µ2 æ’åºæ–¹å¼2 ;\n\n æ’åºæ–¹å¼      ASC : å‡åº(é»˜è®¤å€¼)      DESC: é™åº\nå¦‚æœæ˜¯å‡åº, å¯ä»¥ä¸æŒ‡å®šæ’åºæ–¹å¼ASC ;\nå¦‚æœæ˜¯å¤šå­—æ®µæ’åºï¼Œå½“ç¬¬ä¸€ä¸ªå­—æ®µå€¼ç›¸åŒæ—¶ï¼Œæ‰ä¼šæ ¹æ®ç¬¬äºŒä¸ªå­—æ®µè¿›è¡Œæ’åº ;\nå°æ¡ˆä¾‹ï¼šæ ¹æ®å¹´é¾„å¯¹å…¬å¸çš„å‘˜å·¥è¿›è¡Œå‡åºæ’åº , å¹´é¾„ç›¸åŒ , å†æŒ‰ç…§å…¥èŒæ—¶é—´è¿›è¡Œé™åºæ’åº\nselect * from emp order by age desc, entrydate desc;\n\nåˆ†é¡µæŸ¥è¯¢è¯­æ³•\nèµ·å§‹ç´¢å¼•ä»0å¼€å§‹ï¼Œèµ·å§‹ç´¢å¼• &#x3D; ï¼ˆæŸ¥è¯¢é¡µç  - 1ï¼‰* æ¯é¡µæ˜¾ç¤ºè®°å½•æ•°ã€‚\nåˆ†é¡µæŸ¥è¯¢æ˜¯æ•°æ®åº“çš„æ–¹è¨€ï¼Œä¸åŒçš„æ•°æ®åº“æœ‰ä¸åŒçš„å®ç°ï¼ŒMySQLä¸­æ˜¯LIMITã€‚\nå¦‚æœæŸ¥è¯¢çš„æ˜¯ç¬¬ä¸€é¡µæ•°æ®ï¼Œèµ·å§‹ç´¢å¼•å¯ä»¥çœç•¥ï¼Œç›´æ¥ç®€å†™ä¸º limit 10ã€‚\nSELECT å­—æ®µåˆ—è¡¨ FROM è¡¨å LIMIT èµ·å§‹ç´¢å¼•, æŸ¥è¯¢è®°å½•æ•° ;\n\nå°æ¡ˆä¾‹ï¼šæŸ¥è¯¢ç¬¬2é¡µå‘˜å·¥æ•°æ®, æ¯é¡µå±•ç¤º10æ¡è®°å½• â€”â€”â€“&gt; (é¡µç -1)*é¡µå±•ç¤ºè®°å½•æ•°\nselect * from emp limit 10, 10;\n\næ‰§è¡Œé¡ºåº\néªŒè¯  : æŸ¥è¯¢å¹´é¾„å¤§äº15çš„å‘˜å·¥å§“åã€å¹´é¾„ï¼Œå¹¶æ ¹æ®å¹´é¾„è¿›è¡Œå‡åºæ’åº\nselect name, age from emp where age > 15 order by age asc;\n\nåœ¨æŸ¥è¯¢æ—¶ï¼Œæˆ‘ä»¬ç»™empè¡¨èµ·ä¸€ä¸ªåˆ«å eï¼Œç„¶ååœ¨select åŠ whereä¸­ä½¿ç”¨è¯¥åˆ«åã€‚\nselect e.name, e.age from emp e where e.age > 15 order by age asc;\n\næ‰§è¡Œä¸Šè¿°SQLè¯­å¥åï¼Œæˆ‘ä»¬çœ‹åˆ°ä¾ç„¶å¯ä»¥æ­£å¸¸çš„æŸ¥è¯¢åˆ°ç»“æœï¼Œæ­¤æ—¶å°±è¯´æ˜ï¼š from å…ˆæ‰§è¡Œ, ç„¶åwhere å’Œ select æ‰§è¡Œã€‚\né‚£ where å’Œ select åˆ°åº•å“ªä¸ªå…ˆæ‰§è¡Œå‘¢?\næ­¤æ—¶ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥ç»™selectåé¢çš„å­—æ®µèµ·åˆ«åï¼Œç„¶ååœ¨ where ä¸­ä½¿ç”¨è¿™ä¸ªåˆ«åï¼Œç„¶åçœ‹çœ‹æ˜¯å¦å¯ä»¥æ‰§è¡ŒæˆåŠŸã€‚\nselect e.name, e.age eage from emp e where eage > 15 order by e.age asc;\n\næ‰§è¡Œä¸Šè¿°SQLæŠ¥é”™äº†:1054 - Unknown column â€˜eageâ€™ in â€˜where clauseâ€™\nè¯´æ˜æ˜¯æ‰§è¡Œå®Œfromä¹‹åï¼Œåˆ°æ‰§è¡Œwhereã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ‰§è¡Œå¦‚ä¸‹SQLè¯­å¥ï¼ŒæŸ¥çœ‹æ‰§è¡Œæ•ˆæœï¼š\nselect e.name ename , e.age eage from emp e where e.age > 15 order by eage asc;\n\nç»“æœæ‰§è¡ŒæˆåŠŸã€‚ é‚£ä¹ˆä¹Ÿå°±éªŒè¯äº†: order by æ˜¯åœ¨select è¯­å¥ä¹‹åæ‰§è¡Œçš„ã€‚\nç»¼ä¸Šæ‰€è¿°ï¼ŒDQLè¯­å¥çš„æ‰§è¡Œé¡ºåºä¸ºï¼š\nfrom ... where ... group by ...having ... select ... order by ... limit ...\n\n","slug":"MySQL-DQL","date":"2023-05-14T06:22:31.000Z","categories_index":"","tags_index":"MySQL","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"676b4ad0d6495672245716dc73cc8c9e","title":"MySQL_DML","content":"DMLDMLè‹±æ–‡å…¨ç§°æ˜¯Data Manipulation Language(æ•°æ®æ“ä½œè¯­è¨€)ï¼Œç”¨æ¥å¯¹æ•°æ®åº“ä¸­è¡¨çš„æ•°æ®è®°å½•è¿›\nè¡Œå¢ã€åˆ ã€æ”¹æ“ä½œã€‚\næ·»åŠ æ•°æ® ç»™æŒ‡å®šå­—æ®µæ·»åŠ æ•°æ®\nINSERT INTO è¡¨å(å­—æ®µ1, å­—æ®µ2, ...) VALUES(å€¼1, å€¼2, ...);\n\næ¡ˆä¾‹: ç»™employeeè¡¨æ‰€æœ‰çš„å­—æ®µæ·»åŠ æ•°æ®\nINSERT INTO employee(id,workno,name,gender,age,idcard,entrydate)\nVALUES(1,'1','HJ','å¥³',20,'450802200206141527','2023-05-14');\n\nç»™å…¨éƒ¨å­—æ®µæ·»åŠ æ•°æ®\nINSERT INTO employee \nvalues(2,'2','H','ç”·',23,'45080220001121057X','2023-07-10');\n\næ‰¹é‡æ·»åŠ æ•°æ®\nINSERT INTO è¡¨å(å­—æ®µ1ï¼Œå­—æ®µ2, ...) values\n(v1, v2, ...),(a1, a2, ...),(b1, b2, ...);\n/*\næˆ–è€…\n*/\nINSERT INTO è¡¨å\nVALUES (v1, v2, ...),(a1, a2, ...),(b1, b2, ...);\n\næ‰§è¡ŒDMLè¯­å¥ï¼Œä¼šæ£€æŸ¥æ’å…¥çš„å­—æ®µæ˜¯å¦ç¬¦åˆå­—æ®µçš„ç±»å‹ï¼Œä¸ç¬¦åˆä¼šæŠ¥é”™ã€‚\n æ’å…¥æ•°æ®æ—¶ï¼ŒæŒ‡å®šçš„å­—æ®µé¡ºåºéœ€è¦ä¸å€¼çš„é¡ºåºæ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚\n å­—ç¬¦ä¸²å’Œæ—¥æœŸå‹æ•°æ®åº”è¯¥åŒ…å«åœ¨å¼•å·ä¸­ã€‚\næ’å…¥çš„æ•°æ®å¤§å°ï¼Œåº”è¯¥åœ¨å­—æ®µçš„è§„å®šèŒƒå›´å†…ã€‚\næ—¥æœŸç±»å‹è¦è¿ç»­ï¼Œå¦åˆ™ä¼šæŠ¥é”™\nä¿®æ”¹æ•°æ®\nUPDATE è¡¨å SET å­—æ®µ1 &#x3D; V1, å­—æ®µ2 &#x3D; V2, ... [WHERE æ¡ä»¶];\n\nåˆ é™¤æ•°æ®\nDELEDE FROM è¡¨å [WHERE æ¡ä»¶];\n\nâ€¢ DELETE è¯­å¥çš„æ¡ä»¶å¯ä»¥æœ‰ï¼Œä¹Ÿå¯ä»¥æ²¡æœ‰ï¼Œå¦‚æœæ²¡æœ‰æ¡ä»¶ï¼Œåˆ™ä¼šåˆ é™¤æ•´å¼ è¡¨çš„æ‰€æœ‰æ•°æ®ã€‚\nâ€¢ DELETE è¯­å¥ä¸èƒ½åˆ é™¤æŸä¸€ä¸ªå­—æ®µçš„å€¼(å¯ä»¥ä½¿ç”¨UPDATEï¼Œå°†è¯¥å­—æ®µå€¼ç½®ä¸ºNULLå³å¯)ã€‚\n\n\n\nç±»å‹\nå¤§å°\næœ‰ç¬¦å·èŒƒå›´\næ— ç¬¦å·èŒƒå›´\næè¿°\n\n\n\nTINYINT\n1byte\n(-2^7ï¼Œ2^7-1)\n(0ï¼Œ2^8-1)\nå°æ•´æ•°å€¼\n\n\nSMALLINT\n2bytes\n(-2^15ï¼Œ2^15-1)\n(0ï¼Œ2^16-1)\nå¤§æ•´æ•°å€¼\n\n\nMEDIUMINT\n3bytes\n(-2^23ï¼Œ2^23-1)\n(0ï¼Œ2^24-1)\nå¤§æ•´æ•°å€¼\n\n\nINT&#x2F;INTEGER\n4bytes\n(-2^31ï¼Œ2^31-1)\n(0ï¼Œ2^32-1)\nå¤§æ•´æ•°å€¼\n\n\nBIGINT\n8bytes\n(-2^63ï¼Œ2^63-1)\n(0ï¼Œ2^64-1)\nå¤§æ•´æ•°å€¼\n\n\nFLOAT\n4bytes\n(-3.402823466 E+38ï¼Œ3.402823466351 E+38)\n\nåŒç²¾åº¦æµ®ç‚¹æ•°å€¼\n\n\nDOUBLE\n8bytes\n(-1.7976931348623157E+308ï¼Œ1.7976931348623157E+308)\n\nå•ç²¾åº¦æµ®ç‚¹æ•°å€¼\n\n\nDECIMAL\n\nä¾èµ–äºM(ç²¾åº¦)å’ŒD(æ ‡åº¦)\nä¾èµ–äºM(ç²¾åº¦)å’ŒD(æ ‡åº¦)\nå°æ•°å€¼(ç²¾ç¡®å®šç‚¹æ•°)\n\n\n\n\n\nç±»å‹\nå¤§å°\næè¿°\n\n\n\nCHAR\n0-255 bytes\nå®šé•¿å­—ç¬¦ä¸²(éœ€è¦æŒ‡å®šé•¿åº¦)\n\n\nVARCHAR\n0-65535 bytes\nå˜é•¿å­—ç¬¦ä¸²(éœ€è¦æŒ‡å®šé•¿åº¦)\n\n\nTINYBLOB\n0-255 bytes\nä¸è¶…è¿‡255ä¸ªå­—ç¬¦çš„äºŒè¿›åˆ¶æ•°æ®\n\n\nTINYTEXT\n0-255 bytes\nçŸ­æ–‡æœ¬å­—ç¬¦ä¸²\n\n\nBLOB\n0-65 535 bytes\näºŒè¿›åˆ¶å½¢å¼çš„é•¿æ–‡æœ¬æ•°æ®\n\n\nTEXT\n0-65 535 bytes\né•¿æ–‡æœ¬æ•°æ®\n\n\nMEDIUMBLOB\n0-16 777 215 bytes\näºŒè¿›åˆ¶å½¢å¼çš„ä¸­ç­‰é•¿åº¦æ–‡æœ¬æ•°æ®\n\n\nMEDIUMTEXT\n0-16 777 215 bytes\nä¸­ç­‰é•¿åº¦æ–‡æœ¬æ•°æ®\n\n\nLONGBLOB\n0-4 294 967 295 bytes\näºŒè¿›åˆ¶å½¢å¼çš„æå¤§æ–‡æœ¬æ•°æ®\n\n\nLONGTEXT\n0-4 294 967 295 bytes\næå¤§æ–‡æœ¬æ•°æ®\n\n\n\n\n\nç±»å‹\nå¤§å°\nèŒƒå›´\næ ¼å¼\næè¿°\n\n\n\nDATE\n3\n1000-01-01 è‡³ 9999-12-31\nYYYY-MM-DD\næ—¥æœŸå€¼\n\n\nTIME\n3\n-838:59:59 è‡³ 838:59:59\nHH:MM:SS\næ—¶é—´å€¼æˆ–æŒç»­æ—¶é—´\n\n\nYEAR\n1\n1901 è‡³ 2155\nYYYY\nå¹´ä»½å€¼\n\n\nDATETIME\n8\n1000-01-01 00:00:00 è‡³9999-12-31 23:59:59\nYYYY-MM-DD HH:MM:SS\næ··åˆæ—¥æœŸå’Œæ—¶é—´å€¼\n\n\nTIMESTAMP\n4\n1970-01-01 00:00:01 è‡³2038-01-19 03:14:07\nYYYY-MM-DD HH:MM:SS\næ··åˆæ—¥æœŸå’Œæ—¶é—´å€¼ï¼Œæ—¶é—´æˆ³\n\n\n","slug":"MySQL-DML","date":"2023-05-14T01:30:25.000Z","categories_index":"","tags_index":"MySQL","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"56fbe19991b11dc0bb9030f36adcdf92","title":"MySQL_DDL_Linux","content":"å¯åŠ¨MySQLæœåŠ¡å¯åŠ¨mysqlæœåŠ¡\nsystemctl start mysqld\n\né‡å¯mysqlæœåŠ¡\nsystemctl restart mysqld\n\nåœæ­¢mysqlæœåŠ¡\nsystemctl stop mysqld\n\næŸ¥è¯¢é¦–æ¬¡å®‰è£…æ•°æ®åº“è‡ªåŠ¨ç”Ÿæˆçš„rootå¯†ç grep 'temporary password' /var/log/mysqld.log\n\nå‘½ä»¤è¡Œæ‰§è¡ŒæŒ‡ä»¤\nmysql [-h 127.0.0.1] -u root -på¯†ç \n\nä¿®æ”¹rootç”¨æˆ·å¯†ç ç™»å½•åˆ°MySQLä¹‹åï¼Œéœ€è¦å°†è‡ªåŠ¨ç”Ÿæˆçš„ä¸ä¾¿è®°å¿†çš„å¯†ç ä¿®æ”¹äº†ï¼Œä¿®æ”¹æˆè‡ªå·±ç†Ÿæ‚‰çš„ä¾¿äºè®°å¿†çš„å¯†ç \nALTER USER 'root'@'localhost' IDENTIDFIED BY 'hj0614';\n\næ‰§è¡Œä¸Šè¿°çš„SQLä¼šæŠ¥é”™ï¼ŒåŸå› æ˜¯å› ä¸ºè®¾ç½®çš„å¯†ç å¤ªç®€å•ï¼Œå¯†ç å¤æ‚åº¦ä¸å¤Ÿã€‚\nè®¾ç½®å¯†ç çš„å¤æ‚åº¦ä¸ºç®€å•ç±»å‹\nset global validate_password.policy = 0;\n\nè®¾ç½®å¯†ç é•¿åº¦ä¸º6\nset global validate_password.length = 6;\n\nå†æ¬¡æ‰§è¡Œä¸Šè¿°ä¿®æ”¹å¯†ç çš„æŒ‡ä»¤!\nåˆ›å»ºç”¨æˆ·é»˜è®¤çš„rootç”¨æˆ·åªèƒ½å½“å‰èŠ‚ç‚¹localhostè®¿é—®ï¼Œæ˜¯æ— æ³•è¿œç¨‹è®¿é—®çš„\næˆ‘ä»¬è¿˜éœ€è¦åˆ›å»ºä¸€ä¸ªrootè´¦æˆ·ï¼Œç”¨æˆ·è¿œç¨‹è®¿é—®\ncreate user 'root'@'%' IDENTIFIDE WITH mysql_native_password BY 'hj0614';\n\nç»™ç”¨æˆ·åˆ†é…æƒé™grant all on root.* to 'root'@'%';\n\né‡æ–°è¿æ¥mysql\næŸ¥çœ‹æƒé™show grants for  'root'@'%';\n\næ’¤é”€æƒé™revoke all on root.* from 'root'@'%'\n\nSQLé€šç”¨è¯­æ³•\nSQLè¯­å¥å¯ä»¥å•è¡Œæˆ–å¤šè¡Œä¹¦å†™ï¼Œä»¥åˆ†å· ; ç»“å°¾ã€‚\nSQLè¯­å¥å¯ä»¥ä½¿ç”¨ç©ºæ ¼ &#x2F; ç¼©è¿›æ¥å¢å¼ºè¯­å¥çš„å¯è¯»æ€§ã€‚\nMySQLæ•°æ®åº“çš„SQLè¯­å¥ä¸åŒºåˆ†å¤§å°å†™ï¼Œå…³é”®å­—å»ºè®®ä½¿ç”¨å¤§å†™ã€‚\næ³¨é‡Šï¼š\nå•è¡Œæ³¨é‡Šï¼šâ€“ æ³¨é‡Šå†…å®¹ æˆ– # æ³¨é‡Šå†…å®¹\nå¤šè¡Œæ³¨é‡Šï¼š&#x2F;* æ³¨é‡Šå†…å®¹ *&#x2F;\n\nSQLåˆ†ç±»SQLè¯­å¥ï¼Œæ ¹æ®å…¶åŠŸèƒ½ï¼Œä¸»è¦åˆ†ä¸ºå››ç±»ï¼šDDLã€DMLã€DQLã€DCL\n\n\n\nDDLï¼šData Definition Language\næ•°æ®å®šä¹‰è¯­è¨€ï¼Œç”¨æ¥å®šä¹‰æ•°æ®åº“å¯¹è±¡(æ•°æ®åº“ï¼Œè¡¨ï¼Œå­—æ®µï¼‰\n\n\n\nDMLï¼šData Manipulation  Language\næ•°æ®æ“ä½œè¯­è¨€ï¼Œç”¨æ¥å¯¹æ•°æ®åº“è¡¨ä¸­çš„æ•°æ®è¿›è¡Œå¢åˆ æ”¹\n\n\nDQLï¼šData Query Language\næ•°æ®æŸ¥è¯¢è¯­è¨€ï¼Œç”¨æ¥æŸ¥è¯¢æ•°æ®åº“ä¸­è¡¨çš„è®°å½•\n\n\nDCLï¼šData Control Language\næ•°æ®æ§åˆ¶è¯­è¨€ï¼Œç”¨æ¥åˆ›å»ºæ•°æ®åº“ç”¨æˆ·ã€æ§åˆ¶æ•°æ®åº“çš„è®¿é—®æƒé™\n\n\nDDLè¯­å¥æŸ¥è¯¢æ‰€æœ‰æ•°æ®åº“\nshow databases;\n\næŸ¥è¯¢å½“å‰æ•°æ®åº“\nselect database();\n\nåˆ›å»ºæ•°æ®åº“ [è¡¨ç¤ºå¯é€‰é¡¹]\ncreate database [if not exists] æ•°æ®åº“å [default charset å­—ç¬¦é›†] [collate æ’åºè§„åˆ™];\n\nç¤ºä¾‹ï¼šåˆ›ä¸€ä¸ªæ•°æ®åº“ä½¿ç”¨é»˜è®¤çš„å­—ç¬¦é›†ï¼Œé»˜è®¤æ’åˆ—\ncreate database if not exists test; \n\nåˆ é™¤æ•°æ®åº“     å¦‚æœåˆ é™¤ä¸€ä¸ªä¸å­˜åœ¨çš„æ•°æ®åº“ï¼Œå°†ä¼šæŠ¥é”™ã€‚æ­¤æ—¶ï¼Œå¯ä»¥åŠ ä¸Šå‚æ•° if exists\ndrop database [if exists] æ•°æ®åº“å;\n\nåˆ‡æ¢æ•°æ®åº“\nuse æ•°æ®åº“å;\n\næŸ¥è¯¢å½“å‰æ•°æ®åº“æ‰€æœ‰è¡¨\nshow tables;\n\næŸ¥çœ‹æŒ‡å®šè¡¨ç»“æ„\né€šè¿‡è¿™æ¡æŒ‡ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹åˆ°æŒ‡å®šè¡¨çš„å­—æ®µï¼Œå­—æ®µçš„ç±»å‹ã€æ˜¯å¦å¯ä»¥ä¸ºNULLï¼Œæ˜¯å¦å­˜åœ¨é»˜è®¤å€¼ç­‰ä¿¡æ¯\ndesc è¡¨å;\n\næŸ¥è¯¢æŒ‡å®šè¡¨çš„å»ºè¡¨è¯­å¥\né€šè¿‡è¿™æ¡æŒ‡ä»¤ï¼Œä¸»è¦æ˜¯ç”¨æ¥æŸ¥çœ‹å»ºè¡¨è¯­å¥çš„ï¼Œè€Œæœ‰éƒ¨åˆ†å‚æ•°æˆ‘ä»¬åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™ï¼Œå¹¶æœªæŒ‡å®šä¹Ÿä¼šæŸ¥è¯¢\nåˆ°ï¼Œå› ä¸ºè¿™éƒ¨åˆ†æ˜¯æ•°æ®åº“çš„é»˜è®¤å€¼ï¼Œå¦‚ï¼šå­˜å‚¨å¼•æ“ã€å­—ç¬¦é›†ç­‰ã€‚\nshow create table è¡¨å;\n\nå°æ¡ˆä¾‹ï¼šæŸ¥çœ‹employeeè¡¨çš„å»ºè¡¨è¯­å¥\nemployee\tCREATE TABLE `employee` (\n  `id` int DEFAULT NULL COMMENT 'ç¼–å·',\n  `workno` varchar(10) DEFAULT NULL,\n  `name` varchar(10) DEFAULT NULL COMMENT 'å§“å',\n  `gender` char(1) DEFAULT NULL COMMENT 'æ€§åˆ«',\n  `age` tinyint unsigned DEFAULT NULL COMMENT 'å¹´é¾„',\n  `idcard` char(18) DEFAULT NULL COMMENT 'èº«ä»½è¯å·',\n  `workaddress` varchar(50) DEFAULT NULL COMMENT 'å·¥ä½œåœ°å€',\n  `entrydate` date DEFAULT NULL COMMENT 'å…¥èŒæ—¶é—´'\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='å‘˜å·¥è¡¨'\n\nåˆ›å»ºè¡¨ç»“æ„\t\næœ€åä¸€ä¸ªå­—æ®µåé¢æ²¡æœ‰é€—å·\nCREATE TABLE è¡¨å(\nå­—æ®µ1 å­—æ®µ1ç±»å‹ [COMMENT å­—æ®µ1æ³¨é‡Š],\nå­—æ®µ2 å­—æ®µ2ç±»å‹ [COMMENT å­—æ®µ2æ³¨é‡Š],\n...\nå­—æ®µn å­—æ®µnç±»å‹ [COMMENT å­—æ®µnæ³¨é‡Š]\n) [COMMENT è¡¨æ³¨é‡Š];\n\nå°æ¡ˆä¾‹ï¼šè®¾è®¡ä¸€å¼ å‘˜å·¥ä¿¡æ¯è¡¨ï¼Œè¦æ±‚å¦‚ä¸‹ï¼š\n\nç¼–å·ï¼ˆçº¯æ•°å­—ï¼‰\n\nå‘˜å·¥å·¥å· (å­—ç¬¦ä¸²ç±»å‹ï¼Œé•¿åº¦ä¸è¶…è¿‡10ä½)\n\nå‘˜å·¥å§“åï¼ˆå­—ç¬¦ä¸²ç±»å‹ï¼Œé•¿åº¦ä¸è¶…è¿‡10ä½ï¼‰\n\næ€§åˆ«ï¼ˆç”·&#x2F;å¥³ï¼Œå­˜å‚¨ä¸€ä¸ªæ±‰å­—ï¼‰\n\nå¹´é¾„ï¼ˆæ­£å¸¸äººå¹´é¾„ï¼Œä¸å¯èƒ½å­˜å‚¨è´Ÿæ•°ï¼‰\n\nèº«ä»½è¯å·ï¼ˆäºŒä»£èº«ä»½è¯å·å‡ä¸º18ä½ï¼Œèº«ä»½è¯ä¸­æœ‰Xè¿™æ ·çš„å­—ç¬¦ï¼‰\n\nå…¥èŒæ—¶é—´ï¼ˆå–å€¼å¹´æœˆæ—¥å³å¯ï¼‰\n\n\ncreate table emp(\n id int comment 'ç¼–å·',\n workno varchar(10) comment 'å‘˜å·¥å·¥å·',\n name varchar(10) comment 'å‘˜å·¥å§“å',\n sex char(1) comment 'æ€§åˆ«',\n age tinyint comment 'å¹´é¾„',\n idcard char(18) comment 'èº«ä»½è¯',\n entrydate date  comment 'å…¥èŒæ—¶é—´'\n) comment 'å‘˜å·¥ä¿¡æ¯è¡¨'\n\næ·»åŠ è¡¨å­—æ®µ(ADD)\nALTER TABLE è¡¨å ADD å­—æ®µå ç±»å‹(é•¿åº¦) [comment æ³¨é‡Š] [çº¦æŸ];\n\nå°æ¡ˆä¾‹ï¼šä¸ºempæ·»åŠ ä¸€ä¸ªæ–°çš„å­—æ®µâ€æ˜µç§°â€ä¸ºnicknameï¼Œç±»å‹ä¸ºvarchar(20);\nALTER TABLE emp ADD nickname varchar(20) comment 'æ˜µç§°';\n\nä¿®æ”¹æ•°æ®ç±»å‹(MODIFY)\nALTER TABLE è¡¨å MODIFY å­—æ®µå æ–°æ•°æ®ç±»å‹(é•¿åº¦);\n\n ä¿®æ”¹å­—æ®µåå’Œå­—æ®µç±»å‹(CHANGE)\nALTER TABLE è¡¨å CHANGE æ—§å­—æ®µå æ–°å­—æ®µå ç±»å‹(é•¿åº¦) [comment æ³¨é‡Š] [çº¦æŸ]\n\nå°æ¡ˆä¾‹ï¼šå°†empè¡¨çš„nicknameå­—æ®µä¿®æ”¹ä¸ºusernameï¼Œç±»å‹ä¸ºvarchar(30)\nALTER TABLE emp CHANGE nikename username varchar(30) comment 'æ˜µç§°';\n\nåˆ é™¤å­—æ®µ(DROP)\nALTER TABLE è¡¨å DROP å­—æ®µå;\n\nå°æ¡ˆä¾‹ï¼šå°†empè¡¨çš„å­—æ®µusernameåˆ é™¤\nALTER TABLE emp DROP username;\n\nä¿®æ”¹è¡¨å(RENAME TO)\nALTER TABLE è¡¨å RENAME TO æ–°è¡¨å;\n\nå°æ¡ˆä¾‹ï¼šå°†empè¡¨çš„è¡¨åä¿®æ”¹ä¸º employee\nALTER TABLE emp RANAME TO employee;\n\n åˆ é™¤è¡¨\nDROP TABLE [IF EXISTS] è¡¨å;\n\nå°æ¡ˆä¾‹ï¼šå¦‚æœtb_userè¡¨å­˜åœ¨ï¼Œåˆ™åˆ é™¤tb_userè¡¨\nDROP TABLE IF EXISTS tb_user;\n\n åˆ é™¤æŒ‡å®šè¡¨, å¹¶é‡æ–°åˆ›å»ºè¡¨\nTRUNCATE TABLE è¡¨å;\n\n","slug":"MySQL-DDL","date":"2023-05-13T10:36:19.000Z","categories_index":"","tags_index":"Linux,MySQL","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"b847fc9b240aefdbf95225a3e7dc9026","title":"Spring Beançš„ç”Ÿå‘½å‘¨æœŸ","content":"Spring Beançš„ç”Ÿå‘½å‘¨æœŸgetBeanæ–¹æ³•éƒ½ä¼šè°ƒç”¨doGetBeançš„é€»è¾‘\n    public &lt;T> T getBean(String name, @Nullable Class&lt;T> requiredType, @Nullable Object... args) throws BeansException &#123;\n        return this.doGetBean(name, requiredType, args, false);\n    &#125;\n\nprotected &lt;T> T doGetBean(String name, @Nullable Class&lt;T> requiredType, @Nullable Object[] args, boolean typeCheckOnly) throws BeansException &#123;\n    ....\n    &#125;\n\nbean çš„ç”Ÿå‘½å‘¨æœŸä»è°ƒç”¨ beanFactory çš„ getBean å¼€å§‹ï¼Œåˆ°è¿™ä¸ª bean è¢«é”€æ¯ï¼Œå¯ä»¥æ€»ç»“ä¸ºä»¥ä¸‹ä¸ƒä¸ªé˜¶æ®µï¼š\n\nå¤„ç†åç§°ï¼Œæ£€æŸ¥ç¼“å­˜\nå¤„ç†çˆ¶å­å®¹å™¨\nå¤„ç† dependsOn\né€‰æ‹© scope ç­–ç•¥\nåˆ›å»ºsingleton\nåˆ›å»ºprototype\nåˆ›å»ºå…¶ä»–scope\n\n\nåˆ›å»º bean\nåˆ›å»ºbeanå®ä¾‹\nä¾èµ–æ³¨å…¥\nåˆå§‹åŒ–\nç™»è®°å¯é”€æ¯çš„bean\n\n\nç±»å‹è½¬æ¢å¤„ç†\né”€æ¯ bean\n\n\n\n\n\n\n\n\n\n\næ³¨æ„\n\nåˆ’åˆ†çš„é˜¶æ®µå’Œåç§°å¹¶ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯ç†è§£æ•´ä¸ªè¿‡ç¨‹ä¸­åšäº†å“ªäº›äº‹æƒ…\n\n1. å¤„ç†åç§°ï¼Œæ£€æŸ¥ç¼“å­˜\n\nè¿™ä¸€æ­¥ä¼šå¤„ç†åˆ«åï¼Œå°†åˆ«åè§£æä¸ºå®é™…åç§°\nå¯¹ FactoryBean ä¹Ÿä¼šç‰¹æ®Šå¤„ç†ï¼Œå¦‚æœä»¥ &amp; å¼€å¤´è¡¨ç¤ºè¦è·å– FactoryBean æœ¬èº«ï¼Œå¦åˆ™è¡¨ç¤ºè¦è·å–å…¶äº§å“\nè¿™é‡Œé’ˆå¯¹å•ä¾‹å¯¹è±¡ä¼šæ£€æŸ¥ä¸€çº§ã€äºŒçº§ã€ä¸‰çº§ç¼“å­˜\nsingletonFactories ä¸‰çº§ç¼“å­˜ï¼Œå­˜æ”¾å•ä¾‹å·¥å‚å¯¹è±¡\nearlySingletonObjects äºŒçº§ç¼“å­˜ï¼Œå­˜æ”¾å•ä¾‹å·¥å‚çš„äº§å“å¯¹è±¡\nå¦‚æœå‘ç”Ÿå¾ªç¯ä¾èµ–ï¼Œäº§å“æ˜¯ä»£ç†ï¼›æ— å¾ªç¯ä¾èµ–ï¼Œäº§å“æ˜¯åŸå§‹å¯¹è±¡\n\n\nsingletonObjects ä¸€çº§ç¼“å­˜ï¼Œå­˜æ”¾å•ä¾‹æˆå“å¯¹è±¡\n\n\n\n2. å¤„ç†çˆ¶å­å®¹å™¨\n\nå¦‚æœå½“å‰å®¹å™¨æ ¹æ®åå­—æ‰¾ä¸åˆ°è¿™ä¸ª beanï¼Œæ­¤æ—¶è‹¥çˆ¶å®¹å™¨å­˜åœ¨ï¼Œåˆ™æ‰§è¡Œçˆ¶å®¹å™¨çš„ getBean æµç¨‹\nçˆ¶å­å®¹å™¨çš„ bean åç§°å¯ä»¥é‡å¤\n\n3. å¤„ç† dependsOn\n\nå¦‚æœå½“å‰ bean æœ‰é€šè¿‡ dependsOn æŒ‡å®šäº†éæ˜¾å¼ä¾èµ–çš„ beanï¼Œè¿™ä¸€æ­¥ä¼šæå‰åˆ›å»ºè¿™äº› dependsOn çš„ bean \næ‰€è°“éæ˜¾å¼ä¾èµ–ï¼Œå°±æ˜¯æŒ‡ä¸¤ä¸ª bean ä¹‹é—´ä¸å­˜åœ¨ç›´æ¥ä¾èµ–å…³ç³»ï¼Œä½†éœ€è¦æ§åˆ¶å®ƒä»¬çš„åˆ›å»ºå…ˆåé¡ºåº\n\n4. é€‰æ‹© scope ç­–ç•¥\n\nå¯¹äº singleton scopeï¼Œé¦–å…ˆåˆ°å•ä¾‹æ± å»è·å– beanï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥è¿”å›ï¼Œæ²¡æœ‰å†è¿›å…¥åˆ›å»ºæµç¨‹\nå¯¹äº prototype scopeï¼Œæ¯æ¬¡éƒ½ä¼šè¿›å…¥åˆ›å»ºæµç¨‹\nå¯¹äºè‡ªå®šä¹‰ scopeï¼Œä¾‹å¦‚ requestï¼Œé¦–å…ˆåˆ° request åŸŸè·å– beanï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥è¿”å›ï¼Œæ²¡æœ‰å†è¿›å…¥åˆ›å»ºæµç¨‹\n\npublic class TestScope &#123;\n    public static void main(String[] args) &#123;\n        testRequestScope();\n    &#125;\n\n    // å•ä¾‹ bean ä» refresh è¢«åˆ›å»º, åˆ° close è¢«é”€æ¯, BeanFactory ä¼šè®°å½•å“ªäº› bean è¦è°ƒç”¨é”€æ¯æ–¹æ³•\n    private static void testSingletonScope() &#123;\n        GenericApplicationContext context = new GenericApplicationContext();\n        context.registerBean(\"bean1\", Bean1.class);\n        context.registerBean(CommonAnnotationBeanPostProcessor.class);\n        context.refresh(); // getBean\n        context.close();\n    &#125;\n\n    // å¤šä¾‹ bean ä»é¦–æ¬¡ getBean è¢«åˆ›å»º, åˆ°è°ƒç”¨ BeanFactory çš„ destroyBean è¢«é”€æ¯\n    private static void testPrototypeScope() &#123;\n        GenericApplicationContext context = new GenericApplicationContext();\n        context.registerBean(\"bean1\", Bean1.class, bd -> bd.setScope(\"prototype\"));\n        context.registerBean(CommonAnnotationBeanPostProcessor.class);\n        context.refresh();\n\n        Bean1 bean = context.getBean(Bean1.class);\n        // æ²¡è°è®°å½•è¯¥ bean è¦è°ƒç”¨é”€æ¯æ–¹æ³•, éœ€è¦æˆ‘ä»¬è‡ªè¡Œè°ƒç”¨\n        context.getDefaultListableBeanFactory().destroyBean(bean);\n\n        context.close();\n    &#125;\n\n    // request bean ä»é¦–æ¬¡ getBean è¢«åˆ›å»º, åˆ° request ç»“æŸå‰è¢«é”€æ¯\n    private static void testRequestScope() &#123;\n        GenericApplicationContext context = new GenericApplicationContext();\n        context.getDefaultListableBeanFactory().registerScope(\"request\", new RequestScope());\n        context.registerBean(\"bean1\", Bean1.class, bd -> bd.setScope(\"request\"));\n        context.registerBean(CommonAnnotationBeanPostProcessor.class);\n        context.refresh();\n\n        for (int i = 0; i &lt; 2; i++) &#123;\n            new Thread(() -> &#123;\n                MockHttpServletRequest request = new MockHttpServletRequest();\n                // æ¯ä¸ª webRequest å¯¹è±¡ä¼šè®°å½•å“ªäº› bean è¦è°ƒç”¨é”€æ¯æ–¹æ³•\n                ServletWebRequest webRequest = new ServletWebRequest(request);\n                RequestContextHolder.setRequestAttributes(webRequest);\n\n                Bean1 bean = context.getBean(Bean1.class);\n                LoggerUtils.get().debug(\"&#123;&#125;\", bean);\n                LoggerUtils.get().debug(\"&#123;&#125;\", request.getAttribute(\"bean1\"));\n\n                // request è¯·æ±‚ç»“æŸå‰è°ƒç”¨è¿™äº›é”€æ¯æ–¹æ³•\n                webRequest.requestCompleted();\n            &#125;).start();\n        &#125;\n\n    &#125;\n\n    static class Bean1 &#123;\n        @PostConstruct\n        public void init() &#123;\n            LoggerUtils.get().debug(\"&#123;&#125; - init\", this);\n        &#125;\n\n        @PreDestroy\n        public void destroy() &#123;\n            LoggerUtils.get().debug(\"&#123;&#125; - destroy\", this);\n        &#125;\n    &#125;\n&#125;\n\n\n\n\n\n5.1 åˆ›å»º bean - åˆ›å»º bean å®ä¾‹   \tåˆ›å»ºå‡ºç©ºçš„å®ä¾‹\n\n\n\nè¦ç‚¹\næ€»ç»“\n\n\n\næœ‰è‡ªå®šä¹‰ TargetSource çš„æƒ…å†µ\nç”± AnnotationAwareAspectJAutoProxyCreator åˆ›å»ºä»£ç†è¿”å›\n\n\nSupplier æ–¹å¼åˆ›å»º bean å®ä¾‹\nä¸º Spring 5.0 æ–°å¢åŠŸèƒ½ï¼Œæ–¹ä¾¿ç¼–ç¨‹æ–¹å¼åˆ›å»º  bean  å®ä¾‹\n\n\nFactoryMethod æ–¹å¼  åˆ›å»º bean  å®ä¾‹\nâ‘  åˆ†æˆé™æ€å·¥å‚ä¸å®ä¾‹å·¥å‚ï¼›â‘¡ å·¥å‚æ–¹æ³•è‹¥æœ‰å‚æ•°ï¼Œéœ€è¦å¯¹å·¥å‚æ–¹æ³•å‚æ•°è¿›è¡Œè§£æï¼Œåˆ©ç”¨  resolveDependencyï¼›â‘¢ å¦‚æœæœ‰å¤šä¸ªå·¥å‚æ–¹æ³•å€™é€‰è€…ï¼Œè¿˜è¦è¿›ä¸€æ­¥æŒ‰æƒé‡ç­›é€‰\n\n\nAutowiredAnnotationBeanPostProcessor\nâ‘  ä¼˜å…ˆé€‰æ‹©å¸¦  @Autowired  æ³¨è§£çš„æ„é€ ï¼›â‘¡ è‹¥æœ‰å”¯ä¸€çš„å¸¦å‚æ„é€ ï¼Œä¹Ÿä¼šå…¥é€‰\n\n\nmbd.getPreferredConstructors\né€‰æ‹©æ‰€æœ‰å…¬å…±æ„é€ ï¼Œè¿™äº›æ„é€ ä¹‹é—´æŒ‰æƒé‡ç­›é€‰\n\n\né‡‡ç”¨é»˜è®¤æ„é€ \nå¦‚æœä¸Šé¢çš„åå¤„ç†å™¨å’Œ BeanDefiniation éƒ½æ²¡æ‰¾åˆ°æ„é€ ï¼Œé‡‡ç”¨é»˜è®¤æ„é€ ï¼Œå³ä½¿æ˜¯ç§æœ‰çš„\n\n\n5.2 åˆ›å»º bean - ä¾èµ–æ³¨å…¥\n\n\n\nè¦ç‚¹\næ€»ç»“\n\n\n\nAutowiredAnnotationBeanPostProcessor\nè¯†åˆ«   @Autowired  åŠ @Value  æ ‡æ³¨çš„æˆå‘˜ï¼Œå°è£…ä¸º  InjectionMetadata è¿›è¡Œä¾èµ–æ³¨å…¥\n\n\nCommonAnnotationBeanPostProcessor\nè¯†åˆ«   @Resource  æ ‡æ³¨çš„æˆå‘˜ï¼Œå°è£…ä¸º  InjectionMetadata è¿›è¡Œä¾èµ–æ³¨å…¥\n\n\nresolveDependency\nç”¨æ¥æŸ¥æ‰¾è¦è£…é…çš„å€¼ï¼Œå¯ä»¥è¯†åˆ«ï¼šâ‘  Optionalï¼›â‘¡ ObjectFactory åŠ ObjectProviderï¼›â‘¢ @Lazy  æ³¨è§£ï¼›â‘£ @Value  æ³¨è§£ï¼ˆ${  }, #{ }, ç±»å‹è½¬æ¢ï¼‰ï¼›â‘¤ é›†åˆç±»å‹ï¼ˆCollectionï¼ŒMapï¼Œæ•°ç»„ç­‰ï¼‰ï¼›â‘¥ æ³›å‹å’Œ  @Qualifierï¼ˆç”¨æ¥åŒºåˆ†ç±»å‹æ­§ä¹‰ï¼‰ï¼›â‘¦ primary  åŠåå­—åŒ¹é…ï¼ˆç”¨æ¥åŒºåˆ†ç±»å‹æ­§ä¹‰ï¼‰\n\n\nAUTOWIRE_BY_NAME\næ ¹æ®æˆå‘˜åå­—ï¼ˆsetæ–¹æ³•çš„åå­—ï¼‰æ‰¾ bean å¯¹è±¡ï¼Œä¿®æ”¹ mbd çš„ propertyValuesï¼Œä¸ä¼šè€ƒè™‘ç®€å•ç±»å‹çš„æˆå‘˜\n\n\nAUTOWIRE_BY_TYPE\næ ¹æ®æˆå‘˜ç±»å‹æ‰§è¡Œ resolveDependency æ‰¾åˆ°ä¾èµ–æ³¨å…¥çš„å€¼ï¼Œä¿®æ”¹  mbd çš„ propertyValues\n\n\napplyPropertyValues\næ ¹æ® mbd çš„ propertyValues è¿›è¡Œä¾èµ–æ³¨å…¥ï¼ˆå³xmlä¸­ &#96;&lt;property name ref\n\n\nä¾èµ–æ³¨å…¥çš„ä¼˜å…ˆçº§// æµ‹è¯•å¦‚æœå¯¹åŒä¸€å±æ€§è¿›è¡Œçš„ @Autowired æ³¨å…¥ã€AUTOWIRE_BY_NAMEã€ç²¾ç¡®æŒ‡å®šæ³¨å…¥åç§°, ä¼˜å…ˆçº§æ˜¯æ€æ ·çš„\npublic class TestInjection &#123;\n    public static void main(String[] args) &#123;\n        GenericApplicationContext context = new GenericApplicationContext();\n        AnnotationConfigUtils.registerAnnotationConfigProcessors(context.getDefaultListableBeanFactory());\n        context.registerBean(\"bean1\", Bean1.class, bd -> &#123;\n            // ä¼˜å…ˆçº§æœ€é«˜çš„ï¼šç²¾ç¡®æŒ‡å®šæ³¨å…¥ bean çš„åç§° &lt;property name=\"bean3\" ref=\"bean2\"/> \t\t\t\t//propertyæ ‡ç­¾ä¹Ÿæ˜¯æ ¹æ®setæ–¹æ³•è¿›è¡Œæ³¨å…¥çš„\n            bd.getPropertyValues().add(\"bean3\", new RuntimeBeanReference(\"bean2\"));\n            // ä¼˜å…ˆçº§æ¬¡ä¹‹çš„ï¼šé€šè¿‡ AUTOWIRE_BY_NAME åŒ¹é…\n            ((RootBeanDefinition) bd).setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_NAME);\n        &#125;);\n        context.registerBean(\"bean2\", Bean2.class);\n        context.registerBean(\"bean3\", Bean3.class);\n        context.registerBean(\"bean4\", Bean4.class);\n\n        context.refresh();\n    &#125;\n\n    static class Bean1 &#123;\n        MyInterface bean;\n\n        // ä¼˜å…ˆçº§æœ€ä½çš„ï¼š@Autowired åŒ¹é…\n        @Autowired @Qualifier(\"bean4\")\n        public void setBean3(MyInterface bean) &#123;\n            System.out.println(bean);\n            this.bean = bean;\n        &#125;\n    &#125;\n\n    interface MyInterface &#123;\n    &#125;\n\n    static class Bean2 implements MyInterface &#123;\n    &#125;\n\n    static class Bean3 implements MyInterface &#123;\n    &#125;\n\n    static class Bean4 implements MyInterface &#123;\n    &#125;\n&#125;\n\nç²¾ç¡®åŒ¹é…çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œå…¶æ¬¡åˆ°æŒ‰åå­—åŒ¹é…AUTOWIRE_BY_NAMEï¼Œæœ€åæ˜¯æ³¨è§£æ–¹å¼\n5.3 åˆ›å»º bean - åˆå§‹åŒ–\n\n\n\nè¦ç‚¹\næ€»ç»“\n\n\n\nå†…ç½® Aware æ¥å£çš„è£…é…\nåŒ…æ‹¬ BeanNameAwareï¼ŒBeanFactoryAware ç­‰\n\n\næ‰©å±• Aware æ¥å£çš„è£…é…\nç”± ApplicationContextAwareProcessor è§£æï¼Œæ‰§è¡Œæ—¶æœºåœ¨  postProcessBeforeInitialization\n\n\n@PostConstruct\nç”± CommonAnnotationBeanPostProcessor è§£æï¼Œæ‰§è¡Œæ—¶æœºåœ¨  postProcessBeforeInitialization\n\n\nInitializingBean\né€šè¿‡æ¥å£å›è°ƒæ‰§è¡Œåˆå§‹åŒ–\n\n\ninitMethod\næ ¹æ® BeanDefinition å¾—åˆ°çš„åˆå§‹åŒ–æ–¹æ³•æ‰§è¡Œåˆå§‹åŒ–ï¼Œå³ &lt;bean init-method&gt; æˆ– @Bean(initMethod)\n\n\nåˆ›å»º aop ä»£ç†\nç”± AnnotationAwareAspectJAutoProxyCreator åˆ›å»ºï¼Œæ‰§è¡Œæ—¶æœºåœ¨  postProcessAfterInitialization\n\n\nåˆå§‹åŒ–æ–¹æ³•çš„æ‰§è¡Œé¡ºåºpublic class TestInitialization &#123;\n\n    public static void main(String[] args) &#123;\n        GenericApplicationContext context = new GenericApplicationContext();\n        context.registerBean(CommonAnnotationBeanPostProcessor.class);\n        // &lt;bean init-method=\"initMethod\">\n        context.registerBean(\"bean1\", Bean1.class, bd -> bd.setInitMethodName(\"initMethod\"));\n        context.refresh();\n    &#125;\n\n    static class Bean1 implements InitializingBean, BeanFactoryAware &#123;\n\n        @Override\n        public void afterPropertiesSet() throws Exception &#123;\n            System.out.println(1);\n        &#125;\n\n        @PostConstruct\n        public void init() &#123;\n            System.out.println(2);\n        &#125;\n\n        public void initMethod() &#123;\n            System.out.println(3);\n        &#125;\n\n        @Override\n        public void setBeanFactory(BeanFactory beanFactory) throws BeansException &#123;\n            System.out.println(4);\n        &#125;\n    &#125;\n&#125;\n\nå…ˆæ‰§è¡Œå†…ç½® Aware æ¥å£ -&gt;@PostConstruct -&gt;InitializingBean -&gt; initMethod\n4\n2\n1\n3\n\n5.4 åˆ›å»º bean - æ³¨å†Œå¯é”€æ¯ bean\nåœ¨è¿™ä¸€æ­¥åˆ¤æ–­å¹¶ç™»è®°å¯é”€æ¯ bean\n\nåˆ¤æ–­ä¾æ®\nå¦‚æœå®ç°äº† DisposableBean æˆ– AutoCloseable æ¥å£ï¼Œåˆ™ä¸ºå¯é”€æ¯ bean\nå¦‚æœè‡ªå®šä¹‰äº† destroyMethodï¼Œåˆ™ä¸ºå¯é”€æ¯ bean\nå¦‚æœé‡‡ç”¨ @Bean æ²¡æœ‰æŒ‡å®š destroyMethodï¼Œåˆ™é‡‡ç”¨è‡ªåŠ¨æ¨æ–­æ–¹å¼è·å–é”€æ¯æ–¹æ³•åï¼ˆcloseï¼Œshutdownï¼‰\nå¦‚æœæœ‰ @PreDestroy æ ‡æ³¨çš„æ–¹æ³•\n\n\nå­˜å‚¨ä½ç½®\nsingleton scope çš„å¯é”€æ¯ bean ä¼šå­˜å‚¨äº beanFactory çš„æˆå‘˜å½“ä¸­\nè‡ªå®šä¹‰ scope çš„å¯é”€æ¯ bean ä¼šå­˜å‚¨äºå¯¹åº”çš„åŸŸå¯¹è±¡å½“ä¸­\nprototype scope ä¸ä¼šå­˜å‚¨ï¼Œéœ€è¦è‡ªå·±æ‰¾åˆ°æ­¤å¯¹è±¡é”€æ¯\n\n\nå­˜å‚¨æ—¶éƒ½ä¼šå°è£…ä¸º DisposableBeanAdapter ç±»å‹å¯¹é”€æ¯æ–¹æ³•çš„è°ƒç”¨è¿›è¡Œé€‚é…ï¼Œä½“ç°äº†é€‚é…å™¨æ¨¡å¼\n\n6. ç±»å‹è½¬æ¢å¤„ç†\n\nå¦‚æœ getBean çš„ requiredType å‚æ•°ä¸å®é™…å¾—åˆ°çš„å¯¹è±¡ç±»å‹ä¸åŒï¼Œä¼šå°è¯•è¿›è¡Œç±»å‹è½¬æ¢\n\n7. é”€æ¯ bean\n\né”€æ¯æ—¶æœº\nsingleton bean çš„é”€æ¯åœ¨ ApplicationContext.close æ—¶ï¼Œæ­¤æ—¶ä¼šæ‰¾åˆ°æ‰€æœ‰ DisposableBean çš„åå­—ï¼Œé€ä¸€é”€æ¯\nè‡ªå®šä¹‰ scope bean çš„é”€æ¯åœ¨ä½œç”¨åŸŸå¯¹è±¡ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶\nprototype bean çš„é”€æ¯å¯ä»¥é€šè¿‡è‡ªå·±æ‰‹åŠ¨è°ƒç”¨ AutowireCapableBeanFactory.destroyBean æ–¹æ³•æ‰§è¡Œé”€æ¯\n\n\nåŒä¸€ bean ä¸­ä¸åŒå½¢å¼é”€æ¯æ–¹æ³•çš„è°ƒç”¨æ¬¡åº\nä¼˜å…ˆåå¤„ç†å™¨é”€æ¯ï¼Œå³ @PreDestroy\nå…¶æ¬¡ DisposableBean æ¥å£é”€æ¯\næœ€å destroyMethod é”€æ¯ï¼ˆåŒ…æ‹¬è‡ªå®šä¹‰åç§°ï¼Œæ¨æ–­åç§°ï¼ŒAutoCloseable æ¥å£ å¤šé€‰ä¸€ï¼‰\n\n\n\n","slug":"Spring Beançš„ç”Ÿå‘½å‘¨æœŸ","date":"2023-05-13T04:32:54.000Z","categories_index":"","tags_index":"Java,Spring,é¢è¯•é¢˜","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"ec47f8662f4dbcb9ad26f0a7bcc5e407","title":"Spring refreshæµç¨‹","content":"refresh æ˜¯ AbstractApplicationContext ä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼Œè´Ÿè´£åˆå§‹åŒ– ApplicationContext å®¹å™¨ï¼Œå®¹å™¨å¿…é¡»è°ƒç”¨ refresh æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚å®ƒçš„å†…éƒ¨ä¸»è¦ä¼šè°ƒç”¨ 12 ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬æŠŠå®ƒä»¬ç§°ä¸º refresh çš„ 12 ä¸ªæ­¥éª¤ï¼š\n\nprepareRefresh â€“åšå¥½å‡†å¤‡å·¥ä½œ\n\nobtainFreshBeanFactory â€“åˆ›å»ºæˆ–è·å–BeanFactory\n\nprepareBeanFactory â€“å‡†å¤‡BeanFactory\n\npostProcessBeanFactory â€“ å­ç±»æ‹“å±•BeanFactory\n\ninvokeBeanFactoryPostProcessors â€“åå¤„ç†å™¨æ‹“å±•BeanFactory\n\nregisterBeanPostProcessors â€“å‡†å¤‡Beanåå¤„ç†å™¨\n\ninitMessageSource â€“ä¸ºApplicationContextæä¾›å›½é™…åŒ–åŠŸèƒ½\n\ninitApplicationEventMulticaster â€“ä¸ºApplicationContextæä¾›äº‹ä»¶å‘å¸ƒå™¨\n\nonRefresh â€“ ç•™ç»™å­ç±»æ‹“å±•\n\nregisterListeners â€“ä¸ºApplicationContextå‡†å¤‡ç›‘å¬å™¨\n\nfinishBeanFactoryInitialization â€“ åˆå§‹åŒ–å•ä¾‹Beanï¼Œæ‰§è¡ŒBeanåå¤„ç†å™¨æ‹“å±•\n\nfinishRefresh â€“ å‡†å¤‡ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨ï¼Œå‘å¸ƒContextRefreshedäº‹ä»¶\n\n\n\n\n\n\n\n\n\n\n\nåŠŸèƒ½åˆ†ç±»\n\n1 ä¸ºå‡†å¤‡ç¯å¢ƒ\n\n2 3 4 5 6 ä¸ºå‡†å¤‡ BeanFactory\n\n7 8 9 10 12 ä¸ºå‡†å¤‡ ApplicationContext\n\n11 ä¸ºåˆå§‹åŒ– BeanFactory ä¸­éå»¶è¿Ÿå•ä¾‹ bean\n\n\n1. prepareRefresh\n\nè¿™ä¸€æ­¥åˆ›å»ºå’Œå‡†å¤‡äº† Environment å¯¹è±¡ï¼Œå®ƒä½œä¸º ApplicationContext çš„ä¸€ä¸ªæˆå‘˜å˜é‡\n\nEnvironment å¯¹è±¡çš„ä½œç”¨ä¹‹ä¸€æ˜¯ä¸ºåç»­ @Valueï¼Œå€¼æ³¨å…¥æ—¶æä¾›é”®å€¼\n\nEnvironment åˆ†æˆä¸‰ä¸ªä¸»è¦éƒ¨åˆ†\n\nsystemProperties - ä¿å­˜ java ç¯å¢ƒé”®å€¼\nsystemEnvironment - ä¿å­˜ç³»ç»Ÿç¯å¢ƒé”®å€¼\nè‡ªå®šä¹‰ PropertySource - ä¿å­˜è‡ªå®šä¹‰é”®å€¼ï¼Œä¾‹å¦‚æ¥è‡ªäº *.properties æ–‡ä»¶çš„é”®å€¼\n\n\n\n\nç¤ºä¾‹// å¦‚ä½•è·å¾—å’Œè§£æ @Value å†…å®¹\npublic class TestEnvironment &#123;\n    public static void main(String[] args) throws NoSuchFieldException, IOException &#123;\n        // 1) è·å¾— @Value çš„å€¼\n        System.out.println(\"=======================> ä»…è·å– @Value å€¼\");\n        QualifierAnnotationAutowireCandidateResolver resolver = new QualifierAnnotationAutowireCandidateResolver();\n        Object name = resolver.getSuggestedValue(new DependencyDescriptor(Bean1.class.getDeclaredField(\"name\"), false));\n        System.out.println(name);\n\n        // 2) è§£æ @Value çš„å€¼\n        System.out.println(\"=======================> è·å– @Value å€¼, å¹¶è§£æ$&#123;&#125;\");\n        Object javaHome = resolver.getSuggestedValue(new DependencyDescriptor(Bean1.class.getDeclaredField(\"javaHome\"), false));\n        System.out.println(javaHome);\n        System.out.println(getEnvironment().resolvePlaceholders(javaHome.toString()));\n\n        // 3) è§£æ SpEL è¡¨è¾¾å¼\n        System.out.println(\"=======================> è·å– @Value å€¼, å¹¶è§£æ#&#123;&#125;\");\n        Object expression = resolver.getSuggestedValue(new DependencyDescriptor(Bean1.class.getDeclaredField(\"expression\"), false));\n        System.out.println(expression);\n        String v1 = getEnvironment().resolvePlaceholders(expression.toString());\n        System.out.println(v1);\n        //è§£æ #&#123;&#125;\n        System.out.println(new StandardBeanExpressionResolver().evaluate(v1, new BeanExpressionContext(new DefaultListableBeanFactory(),null)));\n    &#125;\n\n    private static Environment getEnvironment() throws IOException &#123;\n        //æ˜¯Environmentçš„é‡è¦å®ç°ï¼Œé»˜è®¤åªèƒ½è¯†åˆ«ç³»ç»Ÿçš„é”®å€¼ï¼Œæ— æ³•è§£æè‡ªå®šä¹‰çš„é”®å€¼\n        //éœ€è¦çŸ¥é“è‡ªå®šä¹‰é”®å€¼çš„ä½ç½®æ‰èƒ½è§£æ\n        StandardEnvironment env = new StandardEnvironment();\n        //æ·»åŠ è‡ªå®šæ–‡ä»¶çš„é”®å€¼\n        env.getPropertySources().addLast(new ResourcePropertySource(\"jdbc\", new ClassPathResource(\"jdbc.properties\")));\n        return env;\n    &#125;\n\n    static class Bean1 &#123;\n        @Value(\"hello\")\n        private String name;\n\n        @Value(\"$&#123;jdbc.username&#125;\")\n        private String javaHome;\n\t\t\t\t//SpELè¡¨è¾¾å¼\n        @Value(\"#&#123;'class version:' + '$&#123;java.class.version&#125;'&#125;\")\n        private String expression;\n    &#125;\n&#125;\n\nç»“æœ=======================> ä»…è·å– @Value å€¼\nhello\n=======================> è·å– @Value å€¼, å¹¶è§£æ$&#123;&#125;\n$&#123;jdbc.username&#125;\nroot\n=======================> è·å– @Value å€¼, å¹¶è§£æ#&#123;&#125;\n#&#123;'class version:' + '$&#123;java.class.version&#125;'&#125;\n#&#123;'class version:' + '61.0'&#125;\nclass version:61.0\n\né¦–å…ˆï¼Œåˆ›å»ºäº†ä¸€ä¸ª QualifierAnnotationAutowireCandidateResolver çš„å®ä¾‹ï¼Œç”¨æ¥è§£æ@Valueçš„å€™å¤„ç†å™¨ã€‚ç„¶ååˆ›å»ºäº†ä¸€ä¸ª new DependencyDescriptor(Bean1.class.getDeclaredField(â€œnameâ€), false) çš„å®ä¾‹ç”¨æ¥æè¿° Bean1 ç±»çš„ name å±æ€§ï¼Œè¿™ä¸ªå®ä¾‹ä¸­åŒ…å«äº†è¯¥å±æ€§æ‰€åœ¨ç±»çš„ä¿¡æ¯ã€å±æ€§çš„åç§°ç­‰è¯¦ç»†ä¿¡æ¯ã€‚è°ƒç”¨ QualifierAnnotationAutowireCandidateResolver çš„ getSuggestedValue æ–¹æ³•ï¼Œå¹¶ä¼ å…¥ DependencyDescriptor çš„å®ä¾‹æ¥è·å–ä¸€ä¸ªæ¨èçš„å±æ€§å€¼ã€‚\n2. obtainFreshBeanFactory\n\nè¿™ä¸€æ­¥è·å–ï¼ˆæˆ–åˆ›å»ºï¼‰ BeanFactoryï¼Œå®ƒä¹Ÿæ˜¯ä½œä¸º ApplicationContext çš„ä¸€ä¸ªæˆå‘˜å˜é‡\nBeanFactory çš„ä½œç”¨æ˜¯è´Ÿè´£ bean çš„åˆ›å»ºã€ä¾èµ–æ³¨å…¥å’Œåˆå§‹åŒ–ï¼Œbean çš„å„é¡¹ç‰¹å¾ç”± BeanDefinition å®šä¹‰\nBeanDefinition ä½œä¸º bean çš„è®¾è®¡è“å›¾ï¼Œè§„å®šäº† bean çš„ç‰¹å¾ï¼Œå¦‚å•ä¾‹å¤šä¾‹ã€ä¾èµ–å…³ç³»ã€åˆå§‹é”€æ¯æ–¹æ³•ç­‰\nBeanDefinition çš„æ¥æºæœ‰å¤šç§å¤šæ ·ï¼Œå¯ä»¥æ˜¯é€šè¿‡ xml è·å¾—ã€é…ç½®ç±»è·å¾—ã€ç»„ä»¶æ‰«æè·å¾—ï¼Œä¹Ÿå¯ä»¥æ˜¯ç¼–ç¨‹æ·»åŠ \n\n\næ‰€æœ‰çš„ BeanDefinition ä¼šå­˜å…¥ BeanFactory ä¸­çš„ beanDefinitionMap é›†åˆ\n\n\n// æ¼”ç¤ºå„ç§ BeanDefinition çš„æ¥æº\npublic class TestBeanDefinition &#123;\n    public static void main(String[] args) &#123;\n        System.out.println(\"========================> ä¸€å¼€å§‹\");\n        DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory();\n        System.out.println(Arrays.toString(beanFactory.getBeanDefinitionNames()));\n\n        System.out.println(\"========================> 1) ä» xml è·å– \");\n        XmlBeanDefinitionReader reader1 = new XmlBeanDefinitionReader(beanFactory);\n        reader1.loadBeanDefinitions(new ClassPathResource(\"bd.xml\"));\n        System.out.println(Arrays.toString(beanFactory.getBeanDefinitionNames()));\n\n        System.out.println(\"========================> 2) ä»é…ç½®ç±»è·å– \");\n        beanFactory.registerBeanDefinition(\"config1\", BeanDefinitionBuilder.genericBeanDefinition(Config1.class).getBeanDefinition());\n\n        ConfigurationClassPostProcessor postProcessor = new ConfigurationClassPostProcessor();\n        postProcessor.postProcessBeanDefinitionRegistry(beanFactory);\n        System.out.println(Arrays.toString(beanFactory.getBeanDefinitionNames()));\n\n        System.out.println(\"========================> 3) æ‰«æè·å– \");\n        ClassPathBeanDefinitionScanner scanner = new ClassPathBeanDefinitionScanner(beanFactory);\n        scanner.scan(\"day04.refresh.sub\");\n        System.out.println(Arrays.toString(beanFactory.getBeanDefinitionNames()));\n    &#125;\n\n    static class Bean1 &#123;\n\n    &#125;\n\n    static class Bean2 &#123;\n\n    &#125;\n\n    static class Config1 &#123;\n        @Bean\n        public Bean2 bean2() &#123;\n            return new Bean2();\n        &#125;\n    &#125;\n&#125;\n\n&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?>\n&lt;beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd\">\n\n    &lt;bean id=\"bean1\" class=\"day04.refresh.TestBeanDefinition$Bean1\"/>\n\n&lt;/beans>\n\npackage day04.refresh.sub;\n\nimport org.springframework.stereotype.Component;\n\n@Component\npublic class Bean3 &#123;\n&#125;\n\nç»“æœ&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; ä¸€å¼€å§‹\n[]\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; 1) ä» xml è·å– \n[bean1]\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; 2) ä»é…ç½®ç±»è·å– \n[bean1, config1, bean2]\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; 3) æ‰«æè·å– \n[bean1, config1, bean2, bean3, org.springframework.context.annotation.internalConfigurationAnnotationProcessor, org.springframework.context.annotation.internalAutowiredAnnotationProcessor, org.springframework.context.annotation.internalCommonAnnotationProcessor, org.springframework.context.event.internalEventListenerProcessor, org.springframework.context.event.internalEventListenerFactory]\n\n\n3. prepareBeanFactory\n\nè¿™ä¸€æ­¥ä¼šè¿›ä¸€æ­¥å®Œå–„ BeanFactoryï¼Œä¸ºå®ƒçš„å„é¡¹æˆå‘˜å˜é‡èµ‹å€¼\nbeanExpressionResolver ç”¨æ¥è§£æ SpELï¼Œå¸¸è§å®ç°ä¸º StandardBeanExpressionResolver\npropertyEditorRegistrars ä¼šæ³¨å†Œç±»å‹è½¬æ¢å™¨\nå®ƒåœ¨è¿™é‡Œä½¿ç”¨äº† ResourceEditorRegistrar å®ç°ç±»\nå¹¶åº”ç”¨ ApplicationContext æä¾›çš„ Environment å®Œæˆ ${ } è§£æ\n\n\nregisterResolvableDependency æ¥æ³¨å†Œ beanFactory ä»¥åŠ ApplicationContextï¼Œè®©å®ƒä»¬ä¹Ÿèƒ½ç”¨äºä¾èµ–æ³¨å…¥\nbeanPostProcessors æ˜¯ bean åå¤„ç†å™¨é›†åˆï¼Œä¼šå·¥ä½œåœ¨ bean çš„ç”Ÿå‘½å‘¨æœŸå„ä¸ªé˜¶æ®µï¼Œæ­¤å¤„ä¼šæ·»åŠ ä¸¤ä¸ªï¼š\nApplicationContextAwareProcessor ç”¨æ¥è§£æ Aware æ¥å£\nApplicationListenerDetector ç”¨æ¥è¯†åˆ«å®¹å™¨ä¸­ ApplicationListener ç±»å‹çš„ bean\n\n\n\n\n4. postProcessBeanFactory\n\nè¿™ä¸€æ­¥æ˜¯ç©ºå®ç°ï¼Œç•™ç»™å­ç±»æ‰©å±•ã€‚\nä¸€èˆ¬ Web ç¯å¢ƒçš„ App0licationContext éƒ½è¦åˆ©ç”¨å®ƒæ³¨å†Œæ–°çš„ Scopeï¼Œå®Œå–„ Web ä¸‹çš„ BeanFactory\n\n\nè¿™é‡Œä½“ç°çš„æ˜¯æ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼\n\n5. invokeBeanFactoryPostProcessors\n\nè¿™ä¸€æ­¥ä¼šè°ƒç”¨ beanFactory åå¤„ç†å™¨\nbeanFactory åå¤„ç†å™¨ï¼Œå……å½“ beanFactory çš„æ‰©å±•ç‚¹ï¼Œå¯ä»¥ç”¨æ¥è¡¥å……æˆ–ä¿®æ”¹ BeanDefinition\nå¸¸è§çš„ beanFactory åå¤„ç†å™¨æœ‰\nConfigurationClassPostProcessor â€“ è§£æ @Configurationã€@Beanã€@Importã€@PropertySource ç­‰\nPropertySourcesPlaceHolderConfigurer â€“ æ›¿æ¢ BeanDefinition ä¸­çš„ ${ }\nMapperScannerConfigurer â€“ è¡¥å…… Mapper æ¥å£å¯¹åº”çš„ BeanDefinition\n\n\n\n\n6. registerBeanPostProcessors\n\nè¿™ä¸€æ­¥æ˜¯ç»§ç»­ä» beanFactory ä¸­æ‰¾å‡º bean åå¤„ç†å™¨ï¼Œæ·»åŠ è‡³ beanPostProcessors é›†åˆä¸­\nbean åå¤„ç†å™¨ï¼Œå……å½“ bean çš„æ‰©å±•ç‚¹ï¼Œå¯ä»¥å·¥ä½œåœ¨ bean çš„å®ä¾‹åŒ–ã€ä¾èµ–æ³¨å…¥ã€åˆå§‹åŒ–é˜¶æ®µï¼Œå¸¸è§çš„æœ‰ï¼š\nAutowiredAnnotationBeanPostProcessor åŠŸèƒ½æœ‰ï¼šè§£æ @Autowiredï¼Œ@Value æ³¨è§£\nCommonAnnotationBeanPostProcessor åŠŸèƒ½æœ‰ï¼šè§£æ @Resourceï¼Œ@PostConstructï¼Œ@PreDestroy\nAnnotationAwareAspectJAutoProxyCreator åŠŸèƒ½æœ‰ï¼šä¸ºç¬¦åˆåˆ‡ç‚¹çš„ç›®æ ‡ bean è‡ªåŠ¨åˆ›å»ºä»£ç†\n\n\n\n\nç¤ºä¾‹public class TestBeanPostProcessor &#123;\n\n    public static void main(String[] args) &#123;\n        GenericApplicationContext context = new GenericApplicationContext();\n        DefaultListableBeanFactory beanFactory = context.getDefaultListableBeanFactory();\n        beanFactory.registerBeanDefinition(\"bean1\", BeanDefinitionBuilder.genericBeanDefinition(Bean1.class).getBeanDefinition());\n        beanFactory.registerBeanDefinition(\"bean2\", BeanDefinitionBuilder.genericBeanDefinition(Bean2.class).getBeanDefinition());\n        beanFactory.registerBeanDefinition(\"bean3\", BeanDefinitionBuilder.genericBeanDefinition(Bean3.class).getBeanDefinition());\n        beanFactory.registerBeanDefinition(\"aspect1\", BeanDefinitionBuilder.genericBeanDefinition(Aspect1.class).getBeanDefinition());\n        beanFactory.registerBeanDefinition(\"processor1\",\n                BeanDefinitionBuilder.genericBeanDefinition(AutowiredAnnotationBeanPostProcessor.class).getBeanDefinition());\n        beanFactory.registerBeanDefinition(\"processor2\",\n                BeanDefinitionBuilder.genericBeanDefinition(CommonAnnotationBeanPostProcessor.class).getBeanDefinition());\n        beanFactory.registerBeanDefinition(\"processor3\",\n                BeanDefinitionBuilder.genericBeanDefinition(AnnotationAwareAspectJAutoProxyCreator.class).getBeanDefinition());\n\n        context.refresh();\n        beanFactory.getBean(Bean1.class).foo();\n    &#125;\n\n    static class Bean1 &#123;\n        Bean2 bean2;\n        Bean3 bean3;\n\n        @Autowired\n        public void setBean2(Bean2 bean2) &#123;\n            System.out.println(\"å‘ç”Ÿäº†ä¾èµ–æ³¨å…¥...\" + bean2);\n            this.bean2 = bean2;\n        &#125;\n\n        @Resource\n        public void setBean3(Bean3 bean3) &#123;\n            System.out.println(\"å‘ç”Ÿäº†ä¾èµ–æ³¨å…¥...\" + bean3);\n            this.bean3 = bean3;\n        &#125;\n\n        public void foo() &#123;\n            System.out.println(\"foo\");\n        &#125;\n    &#125;\n\n    static class Bean2 &#123;\n\n    &#125;\n\n    static class Bean3 &#123;\n\n    &#125;\n\n    @Aspect\n    static class Aspect1 &#123;\n        @Before(\"execution(* foo())\")\n        public void before() &#123;\n            System.out.println(\"before...\");\n        &#125;\n    &#125;\n&#125;\n\nç»“æœå‘ç”Ÿäº†ä¾èµ–æ³¨å…¥...day04.refresh.TestBeanPostProcessor$Bean3@19b843ba\nå‘ç”Ÿäº†ä¾èµ–æ³¨å…¥...day04.refresh.TestBeanPostProcessor$Bean2@dc9876b\nbefore...\nfoo\n\n7. initMessageSource\n\nè¿™ä¸€æ­¥æ˜¯ä¸º ApplicationContext æ·»åŠ  messageSource æˆå‘˜ï¼Œå®ç°å›½é™…åŒ–åŠŸèƒ½\nå» beanFactory å†…æ‰¾åä¸º messageSource çš„ beanï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æä¾›ç©ºçš„ MessageSource å®ç°\n\n\n8. initApplicationContextEventMulticaster\n\nè¿™ä¸€æ­¥ä¸º ApplicationContext æ·»åŠ äº‹ä»¶å¹¿æ’­å™¨æˆå‘˜ï¼Œå³ applicationContextEventMulticaster\nå®ƒçš„ä½œç”¨æ˜¯å‘å¸ƒäº‹ä»¶ç»™ç›‘å¬å™¨\nå» beanFactory æ‰¾åä¸º applicationEventMulticaster çš„ bean ä½œä¸ºäº‹ä»¶å¹¿æ’­å™¨ï¼Œè‹¥æ²¡æœ‰ï¼Œä¼šåˆ›å»ºé»˜è®¤çš„äº‹ä»¶å¹¿æ’­å™¨\nä¹‹åå°±å¯ä»¥è°ƒç”¨ ApplicationContext.publishEvent(äº‹ä»¶å¯¹è±¡) æ¥å‘å¸ƒäº‹ä»¶\n\n\n9. onRefresh\n\nè¿™ä¸€æ­¥æ˜¯ç©ºå®ç°ï¼Œç•™ç»™å­ç±»æ‰©å±•\nSpringBoot ä¸­çš„å­ç±»åœ¨è¿™é‡Œå‡†å¤‡äº† WebServerï¼Œå³å†…åµŒ web å®¹å™¨\n\n\nä½“ç°çš„æ˜¯æ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼\n\n10. registerListeners\n\nè¿™ä¸€æ­¥ä¼šä»å¤šç§é€”å¾„æ‰¾åˆ°äº‹ä»¶ç›‘å¬å™¨ï¼Œå¹¶æ·»åŠ è‡³ applicationEventMulticaster\näº‹ä»¶ç›‘å¬å™¨é¡¾åæ€ä¹‰ï¼Œç”¨æ¥æ¥æ”¶äº‹ä»¶å¹¿æ’­å™¨å‘å¸ƒçš„äº‹ä»¶ï¼Œæœ‰å¦‚ä¸‹æ¥æº\näº‹å…ˆç¼–ç¨‹æ·»åŠ çš„\næ¥è‡ªå®¹å™¨ä¸­çš„ bean\næ¥è‡ªäº @EventListener çš„è§£æ\n\n\nè¦å®ç°äº‹ä»¶ç›‘å¬å™¨ï¼Œåªéœ€è¦å®ç° ApplicationListener æ¥å£ï¼Œé‡å†™å…¶ä¸­ onApplicationEvent(E e) æ–¹æ³•å³å¯\n\n\n11. finishBeanFactoryInitialization\n\nè¿™ä¸€æ­¥ä¼šå°† beanFactory çš„æˆå‘˜è¡¥å……å®Œæ¯•ï¼Œå¹¶åˆå§‹åŒ–æ‰€æœ‰éå»¶è¿Ÿå•ä¾‹ bean\nconversionService ä¹Ÿæ˜¯ä¸€å¥—è½¬æ¢æœºåˆ¶ï¼Œä½œä¸ºå¯¹ PropertyEditor çš„è¡¥å……\nembeddedValueResolvers å³å†…åµŒå€¼è§£æå™¨ï¼Œç”¨æ¥è§£æ @Value ä¸­çš„ ${ }ï¼Œå€Ÿç”¨çš„æ˜¯ Environment çš„åŠŸèƒ½\nsingletonObjects å³å•ä¾‹æ± ï¼Œç¼“å­˜æ‰€æœ‰å•ä¾‹å¯¹è±¡\nå¯¹è±¡çš„åˆ›å»ºéƒ½åˆ†ä¸‰ä¸ªé˜¶æ®µï¼Œæ¯ä¸€é˜¶æ®µéƒ½æœ‰ä¸åŒçš„ bean åå¤„ç†å™¨å‚ä¸è¿›æ¥ï¼Œæ‰©å±•åŠŸèƒ½\n\n\n\n\n12. finishRefresh\n\nè¿™ä¸€æ­¥ä¼šä¸º ApplicationContext æ·»åŠ  lifecycleProcessor æˆå‘˜ï¼Œç”¨æ¥æ§åˆ¶å®¹å™¨å†…éœ€è¦ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„ bean\nå¦‚æœå®¹å™¨ä¸­æœ‰åç§°ä¸º lifecycleProcessor çš„ bean å°±ç”¨å®ƒï¼Œå¦åˆ™åˆ›å»ºé»˜è®¤çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨\nå‡†å¤‡å¥½ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨ï¼Œå°±å¯ä»¥å®ç°\nè°ƒç”¨ context çš„ startï¼Œå³å¯è§¦å‘æ‰€æœ‰å®ç° LifeCycle æ¥å£ bean çš„ start\nè°ƒç”¨ context çš„ stopï¼Œå³å¯è§¦å‘æ‰€æœ‰å®ç° LifeCycle æ¥å£ bean çš„ stop\n\n\nå‘å¸ƒ ContextRefreshed äº‹ä»¶ï¼Œæ•´ä¸ª refresh æ‰§è¡Œå®Œæˆ\n\n\n","slug":"Spring-refreshæµç¨‹","date":"2023-05-13T01:19:52.000Z","categories_index":"","tags_index":"Java,Spring,é¢è¯•é¢˜","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"2846594611fd32071ec8e1a72cd8f17d","title":"Springå¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–","content":"Springå¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–è§£å†³Setå¾ªç¯ä¾èµ–æ³¨å…¥Springä¸€çº§ç¼“å­˜singletonObjects\nsingletonObjectsæ˜¯ä¸€çº§ç¼“å­˜ï¼Œç”¨äºå­˜å‚¨å•ä¾‹Beançš„å®ä¾‹å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“Springå®¹å™¨åˆ›å»ºä¸€ä¸ªå•ä¾‹Beanæ—¶ï¼Œä¼šå°†è¯¥Beançš„å®ä¾‹å¯¹è±¡æ”¾å…¥ä¸€çº§ç¼“å­˜ä¸­ï¼Œåœ¨åç»­ä½¿ç”¨è¯¥Beanæ—¶ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­è·å–å®ä¾‹å¯¹è±¡ï¼Œé¿å…äº†é‡å¤åˆ›å»ºå®ä¾‹å¯¹è±¡çš„è¿‡ç¨‹ã€‚\nå½“æ²¡æœ‰å¾ªç¯ä¾èµ–æ³¨å…¥æ—¶ï¼Œå¯ä»¥æ­£å¸¸åˆ›å»ºBean\n\nå­˜åœ¨é—®é¢˜ï¼šæ— æ³•è§£å†³å¾ªç¯ä¾èµ–\né¦–å…ˆè°ƒç”¨Açš„getBean()åˆ°ä¸€çº§ç¼“å­˜çœ‹çœ‹Aæ˜¯å¦åˆ›å»ºï¼Œå¦‚æœè¿”å›ä¸ºnullè¡¨ç¤ºæ²¡æ‰¾åˆ°ï¼Œå°±å¼€å§‹åˆ›å»ºAï¼Œæ­¤æ—¶éœ€è¦ç”¨åˆ°Bè¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œåˆå»ä¸€çº§ç¼“å­˜æ‰¾æœ‰æ²¡æœ‰Bï¼Œå¦‚æœæ²¡æœ‰å°±å¼€å§‹åˆ›å»ºBï¼Œæ­¤æ—¶Båˆéœ€è¦ç”¨åˆ°Aï¼Œåˆå»ä¸€çº§ç¼“å­˜æ‰¾Aâ€¦..\nå¯è§åªæœ‰ä¸€çº§ç¼“å­˜æ˜¯æ— æ³•è§£å†³å¾ªç¯ä¾èµ–æ³¨å…¥çš„\n\nå¼•å…¥Springçš„ä¸‰çº§ç¼“å­˜singltonFactories\nè§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ï¼š\nå…ˆåˆ°ä¸€çº§ç¼“å­˜çœ‹çœ‹Aæ˜¯å¦åˆ›å»ºï¼Œå¦‚æœè¿”å›ä¸ºnullè¡¨ç¤ºæ²¡æ‰¾åˆ°ï¼Œå°±å¼€å§‹åˆ›å»ºAï¼Œæ­¤æ—¶åˆ›å»ºçš„æ˜¯ä¸€ä¸ªåŠæˆå“çš„Aï¼ˆå·¥å‚å¯¹è±¡ï¼‰ï¼ŒæŠŠAæ”¾å…¥ä¸‰çº§ç¼“å­˜ï¼Œæ­¤æ—¶éœ€è¦ç”¨åˆ°Bè¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œåˆå»ä¸€çº§ç¼“å­˜æ‰¾æœ‰æ²¡æœ‰Bï¼Œå¦‚æœæ²¡æœ‰å°±å¼€å§‹åˆ›å»ºBï¼Œæ­¤æ—¶åˆ›å»ºçš„ä¹Ÿæ˜¯ä¸€ä¸ªåŠæˆå“çš„Bï¼Œæ­¤æ—¶Båˆéœ€è¦ç”¨åˆ°Aï¼Œåˆå»ä¸€çº§ç¼“å­˜æ‰¾Aå‘ç°æ²¡æœ‰ï¼Œåˆå»ä¸‰çº§ç¼“å­˜æ‰¾ï¼Œæ‰¾åˆ°äº†Aï¼Œå¹¶å®Œæˆä¾èµ–æ³¨å…¥ï¼ŒæŠŠBçš„æˆå“æ”¾å…¥singletonObjectsï¼Œç„¶åæ¸…é™¤singletonFactorieså†…çš„åŠæˆå“Bã€‚è¿™æ˜¯Aå°±å¯ä»¥æ‹¿åˆ°Bï¼Œå®Œæˆåˆå§‹åŒ–ã€‚æŠŠAæ”¾åˆ°ä¸€çº§ç¼“å­˜ï¼Œå¹¶æ¸…é™¤ä¸‰çº§ç¼“å­˜çš„Aã€‚\n\né—®é¢˜åˆæ¥äº†ï¼šSpringæ³¨å…¥çš„å¯¹è±¡å¤§å¤šæ˜¯ä»£ç†å¯¹è±¡ï¼Œé‚£ä¹ˆèƒ½å¦å®Œæˆæ³¨å…¥å‘¢\nå…ˆåˆ°ä¸€çº§ç¼“å­˜çœ‹çœ‹Aæ˜¯å¦åˆ›å»ºï¼Œå¦‚æœè¿”å›ä¸ºnullè¡¨ç¤ºæ²¡æ‰¾åˆ°ï¼Œå°±å¼€å§‹åˆ›å»ºAï¼Œæ­¤æ—¶åˆ›å»ºçš„æ˜¯ä¸€ä¸ªåŠæˆå“çš„Aï¼ˆå·¥å‚å¯¹è±¡ï¼‰ï¼ŒæŠŠAæ”¾å…¥ä¸‰çº§ç¼“å­˜ï¼Œæ­¤æ—¶éœ€è¦ç”¨åˆ°Bè¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œåˆå»ä¸€çº§ç¼“å­˜æ‰¾æœ‰æ²¡æœ‰Bï¼Œå¦‚æœæ²¡æœ‰å°±å¼€å§‹åˆ›å»ºBï¼Œæ­¤æ—¶åˆ›å»ºçš„ä¹Ÿæ˜¯ä¸€ä¸ªåŠæˆå“çš„Bï¼Œæ­¤æ—¶Båˆéœ€è¦ç”¨åˆ°Aï¼Œåˆå»ä¸€çº§ç¼“å­˜æ‰¾Aå‘ç°æ²¡æœ‰ï¼Œåˆå»ä¸‰çº§ç¼“å­˜æ‰¾ï¼Œæ‰¾åˆ°äº†Aï¼Œå¹¶å®Œæˆä¾èµ–æ³¨å…¥ï¼ˆè¿™æ—¶æ³¨å…¥çš„å¹¶ä¸æ˜¯ä»£ç†å¯¹è±¡ï¼‰ï¼Œåˆå§‹åŒ–Bå¹¶åˆ›å»ºBçš„ä»£ç†ï¼ŒæŠŠBçš„ä»£ç†æ”¾å…¥singletonObjectsï¼Œç„¶åæ¸…é™¤singletonFactorieså†…çš„åŠæˆå“Bã€‚è¿™æ˜¯Aå°±å¯ä»¥æ‹¿åˆ°Bçš„ä»£ç†ï¼Œå®Œæˆåˆå§‹åŒ–ã€‚æŠŠAæ”¾åˆ°ä¸€çº§ç¼“å­˜ï¼Œå¹¶æ¸…é™¤ä¸‰çº§ç¼“å­˜çš„Aã€‚å¯ä»¥çœ‹åˆ°ï¼ŒBæ³¨å…¥çš„å¹¶ä¸æ˜¯ä»£ç†ï¼Œæ‰€æœ‰åªæœ‰ä¸¤ä¸ªç¼“å­˜æ˜¯ä¸å¯ä»¥è§£å†³Springå…³äºçš„ä»£ç†å¯¹è±¡çš„ä¾èµ–æ³¨å…¥ã€‚\næ€»çš„æ¥è¯´æ˜¯å› ä¸ºå­˜åœ¨å¾ªç¯ä¾èµ–æ—¶ï¼Œæ˜¯ä¾èµ–æ³¨å…¥å…ˆå‘ç”Ÿï¼Œåˆ›å»ºä»£ç†åå‘ç”Ÿ\n\nå¼•å…¥SpringäºŒçº§ç¼“å­˜earlySingletonObjects\nè§£å†³æ–¹æ³•ï¼šæå‰åˆ›å»ºä»£ç†\nSpringå¹¶ä¸æ˜¯å¯¹æ‰€æœ‰Beançš„åˆ›å»ºéƒ½æå‰åˆ›å»ºä»£ç†ï¼Œåªæœ‰å­˜åœ¨å¾ªç¯ä¾èµ–æ—¶æ‰æå‰åˆ›å»ºä»£ç†\n\nè§£å†³Constructå¾ªç¯ä¾èµ–æ³¨å…¥Açš„æ„é€ ä¾èµ–Bï¼Œæ‰€æœ‰Aæ— æ³•åˆ›å»ºå·¥å‚å¯¹è±¡æ”¾å…¥ä¸‰çº§ç¼“å­˜ï¼ŒBçš„æ„é€ ä¹Ÿä¾èµ–Aï¼ŒBä¹Ÿæ— æ³•åˆ›å»ºå·¥å‚å¯¹è±¡æ”¾å…¥ç¼“å­˜\n\nSpringçš„ä¸‰çº§ç¼“å­˜æ— æ³•è§£å†³æ„é€ å™¨ä¾èµ–æ³¨å…¥ã€‚\nå¦‚ä½•è§£å†³æ„é€ å™¨çš„å¾ªç¯ä¾èµ–å‘¢ï¼Ÿ\næ–¹æ³•ä¸€\nå¯ä»¥ç»™Aæ³¨å…¥ä¸€ä¸ªBçš„ä»£ç†å¯¹è±¡ï¼ˆå¹¶ä¸æ˜¯çœŸçš„Bä»£ç†å¯¹è±¡ï¼Œè€Œæ˜¯åˆ›å»ºäº†ä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»çš„TargetSourceå®ç°ï¼Œå½“çœŸæ­£ä½¿ç”¨åˆ°Bçš„æ–¹æ³•æ—¶ï¼Œä¼šé€šè¿‡BeanFactoryè·å–Bï¼Œå†è°ƒç”¨ï¼‰ï¼Œåªè¦ä¸å¦¨ç¢Açš„åˆ›å»ºä»¥åŠåˆå§‹åŒ–å°±è¡Œï¼Œå½“AæˆåŠŸåˆ›å»ºä¹‹åï¼ŒBä¹Ÿèƒ½æˆåŠŸåˆ›å»ºï¼Œè¿™æ—¶Aæƒ³è¦ç”¨Bçš„æ–¹æ³•ï¼Œåªéœ€è¦é€šè¿‡ä»£ç†æ‰¾åˆ°çœŸæ­£çš„Bè°ƒç”¨æ–¹æ³•\n\næ–¹æ³•äºŒ\nå¯ä»¥ç»™Aæ³¨å…¥ä¸€ä¸ªå·¥å‚å¯¹è±¡ï¼Œåªè¦ä¸å¦¨ç¢Açš„åˆ›å»ºä»¥åŠåˆå§‹åŒ–å°±è¡Œï¼Œå½“AæˆåŠŸåˆ›å»ºä¹‹åï¼ŒBä¹Ÿèƒ½æˆåŠŸåˆ›å»ºï¼Œè¿™æ—¶Aæƒ³è¦ç”¨Bçš„æ–¹æ³•ï¼Œåªéœ€è¦é€šè¿‡å·¥å‚å¯¹è±¡è·å–Bï¼Œå†è°ƒç”¨æ–¹æ³•\n\nä»¥ä¸Šä¸¤ç§éƒ½æ˜¯é€šè¿‡å»¶è¿Ÿå¯¹è±¡çš„åˆ›å»ºæ¥è§£ææ„é€ å™¨å¾ªç¯ä¾èµ–\né‚£ä¹ˆå®ƒä»¬çš„å»¶è¿Ÿåˆ›å»ºåœ¨Springä¸­å¦‚ä½•ä½“ç°å‘¢ï¼Ÿä½¿ç”¨@Lazy\nåœ¨Springä¸­ï¼Œå¯ä»¥åœ¨æ„é€ å™¨å¾ªç¯ä¾èµ–çš„å…¶ä¸­ä¸€ä¸ªå¯¹è±¡çš„æ„é€ çš„å‚æ•°ä¸Šæ·»åŠ @Lazyæ¥å»¶è¿Ÿå¯¹è±¡çš„åˆ›å»º\nä¸‹é¢æ˜¯ä¸€ä¸ªåœ¨æ„é€ å™¨å¾ªç¯ä¾èµ–æƒ…å†µä¸‹ä½¿ç”¨ @Lazy æ³¨è§£çš„ç¤ºä¾‹ä»£ç ï¼š\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.context.annotation.AnnotationConfigUtils;\nimport org.springframework.context.annotation.Lazy;\nimport org.springframework.context.support.GenericApplicationContext;\n\nimport javax.annotation.PostConstruct;\n\npublic class TestConstructDelayCreate &#123;\n    static class A &#123;\n        private static final Logger log = LoggerFactory.getLogger(\"A\");\n        private B b;;\n        public A(@Lazy B b) &#123;\n            log.debug(\"Aå†…çš„b>>>>&#123;&#125;\", b.getClass());\n            this.b = b;\n        &#125;\n        @PostConstruct\n        public void init() &#123;log.debug(\"init()\");&#125;\n    &#125;\n    static class B &#123;\n        private static final Logger log = LoggerFactory.getLogger(\"B\");\n        private A a;\n        public B(A a) &#123;\n            log.debug(\"Bå†…çš„a>>>>&#123;&#125;\", a.getClass());\n            this.a = a;\n        &#125;\n        @PostConstruct\n        public void init() &#123;log.debug(\"init()\");&#125;\n    &#125;\n\n    public static void main(String[] args) &#123;\n        GenericApplicationContext context = new GenericApplicationContext();\n        context.registerBean(\"a\",A.class);\n        context.registerBean(\"b\",B.class);\n        AnnotationConfigUtils.registerAnnotationConfigProcessors(context.getDefaultListableBeanFactory());\n        context.refresh();\n\n        System.out.println(context.getBean(A.class).b.getClass());\n        System.out.println(context.getBean(B.class).getClass());\n\n\n    &#125;\n&#125;\n\nè¿è¡Œç»“æœ:[DEBUG] 23:49:27.836 [main] - Aå†…çš„b>>>>class day04.boot.TestConstructDelayCreate$B$$EnhancerBySpringCGLIB$$f09826e3 \n[DEBUG] 23:49:27.842 [main] - init() \n[DEBUG] 23:49:27.845 [main] - Bå†…çš„a>>>>class day04.boot.TestConstructDelayCreate$A \n[DEBUG] 23:49:27.845 [main] - init() \nclass day04.boot.TestConstructDelayCreate$B$$EnhancerBySpringCGLIB$$f09826e3\nclass day04.boot.TestConstructDelayCreate$B\n\nè·Ÿè¸ª@Lazy\nObject result = this.getAutowireCandidateResolver().getLazyResolutionProxyIfNecessary(descriptor, requestingBeanName);\næ£€æŸ¥æ˜¯å¦æœ‰@Lazyæ³¨è§£ï¼Œæ˜¯å¦éœ€è¦åˆ›å»ºä»£ç†\n\nreturn this.isLazy(descriptor) ? this.buildLazyResolutionProxy(descriptor, beanName) : null;\næ˜¯å¦éœ€è¦åˆ›å»ºä»£ç†\n\nçœ‹çœ‹åˆ›å»ºä»£ç†çš„é€»è¾‘  buildLazyResolutionProxy\nåˆ›å»ºäº†ä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»çš„TargetSourceå®ç°\n\nçœ‹çœ‹TargetSourceçš„å®ç°\nå½“è°ƒç”¨getTarget()æ—¶ï¼Œä¼šé€šè¿‡BeanFactoryè·å–Bï¼Œå†è°ƒç”¨\n\nåœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œå¯ä»¥ç»™Aæ³¨å…¥ä¸€ä¸ªBçš„ä»£ç†å¯¹è±¡ï¼Œå¹¶ä¸æ˜¯çœŸçš„Bä»£ç†å¯¹è±¡ï¼Œè€Œæ˜¯åˆ›å»ºäº†ä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»çš„TargetSourceå®ç°ï¼Œå†…éƒ¨å…³è”äº†BeanFactoryï¼Œå½“è°ƒç”¨getTarget()æ—¶ï¼Œä¼šé€šè¿‡BeanFactoryè·å–Bï¼Œå†è°ƒç”¨ã€‚\næ›¿æ¢æˆObjectFactoryå·¥å‚å¯¹è±¡\nä¸‹é¢æ˜¯ObjectFactoryç¤ºä¾‹ä»£ç ï¼š\npublic class TestConstructDelayCreate &#123;\n    static class A &#123;\n        private static final Logger log = LoggerFactory.getLogger(\"A\");\n        private ObjectFactory&lt;B> b;;\n        public A(ObjectFactory&lt;B> b) &#123;\n            log.debug(\"Aå†…çš„b>>>>&#123;&#125;\", b.getClass());\n            this.b = b;\n        &#125;\n        @PostConstruct\n        public void init() &#123;log.debug(\"init()\");&#125;\n    &#125;\n    static class B &#123;\n        private static final Logger log = LoggerFactory.getLogger(\"B\");\n        private A a;\n        public B(A a) &#123;\n            log.debug(\"Bå†…çš„a>>>>&#123;&#125;\", a.getClass());\n            this.a = a;\n        &#125;\n        @PostConstruct\n        public void init() &#123;log.debug(\"init()\");&#125;\n    &#125;\n\n    public static void main(String[] args) &#123;\n        GenericApplicationContext context = new GenericApplicationContext();\n        context.registerBean(\"a\",A.class);\n        context.registerBean(\"b\",B.class);\n        AnnotationConfigUtils.registerAnnotationConfigProcessors(context.getDefaultListableBeanFactory());\n        context.refresh();\n\n        System.out.println(context.getBean(A.class).b.getObject());\n        System.out.println(context.getBean(B.class));\n    &#125;\n&#125;\n\nè¿è¡Œç»“æœï¼š\n[DEBUG] 16:33:27.224 [main] - Aå†…çš„b>>>>class org.springframework.beans.factory.support.DefaultListableBeanFactory$DependencyObjectProvider \n[DEBUG] 16:33:27.230 [main] - init() \n[DEBUG] 16:33:27.233 [main] - Bå†…çš„a>>>>class day04.boot.TestConstructDelayCreate$A \n[DEBUG] 16:33:27.234 [main] - init() \nday04.boot.TestConstructDelayCreate$B@7bd4937b\nday04.boot.TestConstructDelayCreate$B@7bd4937b\n\nä¼˜ç‚¹ï¼šä¸ä¼šäº§ç”Ÿä»£ç†ï¼Œå‡å°‘å†…å­˜å¼€é”€\næ›¿æ¢æˆObjectProviderå¯¹è±¡ï¼ˆObjectFactoryçš„å­ç±»ï¼‰\npublic class TestConstructDelayCreate &#123;\n    static class A &#123;\n        private static final Logger log &#x3D; LoggerFactory.getLogger(&quot;A&quot;);\n        private ObjectProvider&lt;B&gt; b;;\n        public A(ObjectProvider&lt;B&gt; b) &#123;\n            log.debug(&quot;Aå†…çš„b&gt;&gt;&gt;&gt;&#123;&#125;&quot;, b.getClass());\n            this.b &#x3D; b;\n        &#125;\n        @PostConstruct\n        public void init() &#123;log.debug(&quot;init()&quot;);&#125;\n    &#125;\n    static class B &#123;\n        private static final Logger log &#x3D; LoggerFactory.getLogger(&quot;B&quot;);\n        private A a;\n        public B(A a) &#123;\n            log.debug(&quot;Bå†…çš„a&gt;&gt;&gt;&gt;&#123;&#125;&quot;, a.getClass());\n            this.a &#x3D; a;\n        &#125;\n        @PostConstruct\n        public void init() &#123;log.debug(&quot;init()&quot;);&#125;\n    &#125;\n\n    public static void main(String[] args) &#123;\n        GenericApplicationContext context &#x3D; new GenericApplicationContext();\n        context.registerBean(&quot;a&quot;,A.class);\n        context.registerBean(&quot;b&quot;,B.class);\n        AnnotationConfigUtils.registerAnnotationConfigProcessors(context.getDefaultListableBeanFactory());\n        context.refresh();\n\n        System.out.println(context.getBean(A.class).b.getObject());\n        System.out.println(context.getBean(B.class));\n    &#125;\n&#125;\n\nè¿è¡Œç»“æœ\n[DEBUG] 16:36:43.644 [main] - Aå†…çš„b>>>>class org.springframework.beans.factory.support.DefaultListableBeanFactory$DependencyObjectProvider \n[DEBUG] 16:36:43.649 [main] - init() \n[DEBUG] 16:36:43.652 [main] - Bå†…çš„a>>>>class day04.boot.TestConstructDelayCreate$A \n[DEBUG] 16:36:43.653 [main] - init() \nday04.boot.TestConstructDelayCreate$B@21e360a\nday04.boot.TestConstructDelayCreate$B@21e360a\n\nObjectProviderã€ObjectFactoryéƒ½æ˜¯Springæä¾›çš„å·¥å‚æ¥å£\nProviderï¼šJavaå®˜æ–¹æä¾›çš„ä¸€å¥—å·¥å‚æ¥å£\n&lt;dependency>\n          &lt;groupId>javax.inject&lt;/groupId>\n          &lt;artifactId>javax.inject&lt;/artifactId>\n          &lt;version>1&lt;/version>\n      &lt;/dependency>\n\npublic class TestConstructDelayCreate &#123;\n    static class A &#123;\n        private static final Logger log = LoggerFactory.getLogger(\"A\");\n        private Provider&lt;B> b;;\n        public A(Provider&lt;B> b) &#123;\n            log.debug(\"Aå†…çš„b>>>>&#123;&#125;\", b.getClass());\n            this.b = b;\n        &#125;\n        @PostConstruct\n        public void init() &#123;log.debug(\"init()\");&#125;\n    &#125;\n    static class B &#123;\n        private static final Logger log = LoggerFactory.getLogger(\"B\");\n        private A a;\n        public B(A a) &#123;\n            log.debug(\"Bå†…çš„a>>>>&#123;&#125;\", a.getClass());\n            this.a = a;\n        &#125;\n        @PostConstruct\n        public void init() &#123;log.debug(\"init()\");&#125;\n    &#125;\n\n    public static void main(String[] args) &#123;\n        GenericApplicationContext context = new GenericApplicationContext();\n        context.registerBean(\"a\",A.class);\n        context.registerBean(\"b\",B.class);\n        AnnotationConfigUtils.registerAnnotationConfigProcessors(context.getDefaultListableBeanFactory());\n        context.refresh();\n\n        System.out.println(context.getBean(A.class).b.get());\n        System.out.println(context.getBean(B.class));\n\n    &#125;\n&#125;\n\nè¿è¡Œç»“æœï¼š\n[DEBUG] 16:45:43.783 [main] - Aå†…çš„b>>>>class org.springframework.beans.factory.support.DefaultListableBeanFactory$Jsr330Factory$Jsr330Provider \n[DEBUG] 16:45:43.788 [main] - init() \n[DEBUG] 16:45:43.792 [main] - Bå†…çš„a>>>>class day04.boot.TestConstructDelayCreate$A \n[DEBUG] 16:45:43.792 [main] - init() \nday04.boot.TestConstructDelayCreate$B@43dac38f\nday04.boot.TestConstructDelayCreate$B@43dac38f\n\nåˆ†æï¼š\npublic Object resolveDependency(DependencyDescriptor descriptor, @Nullable String requestingBeanName, @Nullable Set&lt;String> autowiredBeanNames, @Nullable TypeConverter typeConverter) throws BeansException &#123;\n       descriptor.initParameterNameDiscovery(this.getParameterNameDiscoverer());\n       if (Optional.class == descriptor.getDependencyType()) &#123;\n           return this.createOptionalDependency(descriptor, requestingBeanName);\n       &#125; else if (ObjectFactory.class != descriptor.getDependencyType() &amp;&amp; ObjectProvider.class != descriptor.getDependencyType()) &#123;\n           \n           //åˆ›å»ºProvider\n           if (javaxInjectProviderClass == descriptor.getDependencyType()) &#123;\n               return (new DefaultListableBeanFactory.Jsr330Factory()).createDependencyProvider(descriptor, requestingBeanName);\n               \n               \n           &#125;\n\n//è·Ÿå…¥ createDependencyProvideræ–¹æ³• æ˜¯Jsr330Factoryå·¥å‚çš„æ–¹æ³•\nprivate class Jsr330Factory implements Serializable &#123;\n        private Jsr330Factory() &#123;\n        &#125;\n\n        public Object createDependencyProvider(DependencyDescriptor descriptor, @Nullable String beanName) &#123;\n            return new DefaultListableBeanFactory.Jsr330Factory.Jsr330Provider(descriptor, beanName);\n        &#125;\n\n        private class Jsr330Provider extends DefaultListableBeanFactory.DependencyObjectProvider implements Provider&lt;Object> &#123;\n            public Jsr330Provider(DependencyDescriptor descriptor, @Nullable String beanName) &#123;\n                super(descriptor, beanName);\n            &#125;\n\n            @Nullable\n            public Object get() throws BeansException &#123;\n                return this.getValue();\n            &#125;\n        &#125;\n    &#125;\n\n//çœ‹çœ‹getæ–¹æ³•çš„getvalue()çš„å®ç°   \n@Nullable\n        protected Object getValue() throws BeansException &#123;\n            return this.optional ? DefaultListableBeanFactory.this.createOptionalDependency(this.descriptor, this.beanName) : DefaultListableBeanFactory.this.doResolveDependency(this.descriptor, this.beanName, (Set)null, (TypeConverter)null);\n        &#125;\n\nå½“b.get()è¢«è°ƒç”¨æ—¶ï¼Œä¼šè¿›å…¥DefaultListableBeanFactory.this.doResolveDependency(this.descriptor,  this.beanName, (Set)null, (TypeConverter)null)ï¼›ä½¿ç”¨å·²ç»åˆ›å»ºå¥½çš„Bean\nä½¿ç”¨Scopeæ³¨è§£ï¼Œä¹Ÿä¼šåˆ›å»ºä»£ç†è§£å†³æ„é€ å™¨å¾ªç¯ä¾èµ– \nåœ¨ç±»ä¸Šæ·»åŠ @Scope(ProxyMode &#x3D; ScopedProxyMode.TARGET.CLASS)\nä¸æ¨èä½¿ç”¨ï¼Œå› ä¸ºä¼šäº§ç”Ÿé¢å¤–çš„beanDefinationï¼Œä¹Ÿä¼šäº§ç”Ÿé¢å¤–çš„å•ä¾‹bean\n","slug":"Springå¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–","date":"2023-05-11T13:26:38.000Z","categories_index":"","tags_index":"Java,Spring,é¢è¯•é¢˜","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"a685b627e4865e5f328e43bd436e0d9e","title":"ä»£ç†çš„åˆ›å»ºæ—¶æœº","content":"ä»£ç†çš„åˆ›å»ºæ—¶æœºä»£ç†çš„åˆ›å»ºæ—¶æœº\nåˆ›å»º -&gt; ( * ) ä¾èµ–æ³¨å…¥ -&gt; åˆå§‹åŒ– ( * )\n\nåˆå§‹åŒ–ä¹‹å (æ— å¾ªç¯ä¾èµ–æ—¶)\n\nå®ä¾‹åˆ›å»ºå, ä¾èµ–æ³¨å…¥å‰ (æœ‰å¾ªç¯ä¾èµ–æ—¶), å¹¶æš‚å­˜äºäºŒçº§ç¼“å­˜\n\n\npublic class A17_1 &#123;\n\n    public static void main(String[] args) &#123;\n        GenericApplicationContext context = new GenericApplicationContext();\n        context.registerBean(ConfigurationClassPostProcessor.class);\n        context.registerBean(Config.class);\n        context.refresh();\n        context.close();\n        // åˆ›å»º -> (*) ä¾èµ–æ³¨å…¥ -> åˆå§‹åŒ– (*)\n        /*\n            å­¦åˆ°äº†ä»€ä¹ˆ\n                a. ä»£ç†çš„åˆ›å»ºæ—¶æœº\n                    1. åˆå§‹åŒ–ä¹‹å (æ— å¾ªç¯ä¾èµ–æ—¶)\n                    2. å®ä¾‹åˆ›å»ºå, ä¾èµ–æ³¨å…¥å‰ (æœ‰å¾ªç¯ä¾èµ–æ—¶), å¹¶æš‚å­˜äºäºŒçº§ç¼“å­˜\n                b. ä¾èµ–æ³¨å…¥ä¸åˆå§‹åŒ–ä¸åº”è¯¥è¢«å¢å¼º, ä»åº”è¢«æ–½åŠ äºåŸå§‹å¯¹è±¡\n         */\n    &#125;\n\n    @Configuration\n    static class Config &#123;\n        @Bean // è§£æ @Aspectã€äº§ç”Ÿä»£ç†\n        public AnnotationAwareAspectJAutoProxyCreator annotationAwareAspectJAutoProxyCreator() &#123;\n            return new AnnotationAwareAspectJAutoProxyCreator();\n        &#125;\n\n        @Bean // è§£æ @Autowired\n        public AutowiredAnnotationBeanPostProcessor autowiredAnnotationBeanPostProcessor() &#123;\n            return new AutowiredAnnotationBeanPostProcessor();\n        &#125;\n\n        @Bean // è§£æ @PostConstruct\n        public CommonAnnotationBeanPostProcessor commonAnnotationBeanPostProcessor() &#123;\n            return new CommonAnnotationBeanPostProcessor();\n        &#125;\n\n        @Bean\n        public Advisor advisor(MethodInterceptor advice) &#123;\n            AspectJExpressionPointcut pointcut = new AspectJExpressionPointcut();\n            pointcut.setExpression(\"execution(* foo())\");\n            return new DefaultPointcutAdvisor(pointcut, advice);\n        &#125;\n\n        @Bean\n        public MethodInterceptor advice() &#123;\n            return (MethodInvocation invocation) -> &#123;\n                System.out.println(\"before...\");\n                return invocation.proceed();\n            &#125;;\n        &#125;\n\n        @Bean\n        public Bean1 bean1() &#123;\n            return new Bean1();\n        &#125;\n\n        @Bean\n        public Bean2 bean2() &#123;\n            return new Bean2();\n        &#125;\n    &#125;\n\n    static class Bean1 &#123;\n        public void foo() &#123;\n\n        &#125;\n        public Bean1() &#123;\n            System.out.println(\"Bean1()\");\n        &#125;\n        /*\n        @Autowired \n        public void setBean2(Bean2 bean2) &#123;\n            System.out.println(\"Bean1 setBean2(bean2) class is: \" + bean2.getClass());\n        &#125;*/\n        @PostConstruct \n        public void init() &#123;\n            System.out.println(\"Bean1 init()\");\n        &#125;\n    &#125;\n\n    static class Bean2 &#123;\n        public Bean2() &#123;\n            System.out.println(\"Bean2()\");\n        &#125;\n        @Autowired \n        public void setBean1(Bean1 bean1) &#123;\n            System.out.println(\"Bean2 setBean1(bean1) class is: \" + bean1.getClass());\n        &#125;\n        @PostConstruct \n        public void init() &#123;\n            System.out.println(\"Bean2 init()\");\n        &#125;\n    &#125;\n&#125;\n\nä»¥ä¸Šä¾‹å­æ˜¯ä¸€ä¸ªå•å‘çš„ä¾èµ–ï¼ŒBean2çš„åˆ›å»ºä¾èµ–Bean1ã€‚ä»£ç†çš„åˆ›å»ºæ—¶æœºä¸ºç±»çš„åˆå§‹åŒ–ä¹‹å\nè¾“å‡ºç»“æœ&gt;&gt;&gt;&gt;åˆ›å»ºBean1\nBean1()\n&gt;&gt;&gt;&gt;å®Œæˆåˆå§‹åŒ–\nBean1 init()\n&gt;&gt;&gt;&gt;ä¸ºbean1åˆ›å»ºä»£ç†\n[TRACE] 21:09:48.069 [main] o.s.a.a.a.AnnotationAwareAspectJAutoProxyCreator - Creating implicit proxy for bean &#39;bean1&#39; with 0 common interceptors and 2 specific interceptors \n&gt;&gt;&gt;&gt;åˆ›å»ºBean2\nBean2()\n&gt;&gt;&gt;&gt;å®ŒæˆBean1å±æ€§çš„çš„ä¾èµ–æ³¨å…¥ï¼Œæ³¨å…¥çš„æ˜¯ä»£ç†\nBean2 setBean1(bean1) class is: class \norg.springframework.aop.framework.autoproxy.A17_1$Bean1$$EnhancerBySpringCGLIB$$2c2cbac1\n&gt;&gt;&gt;&gt;å®Œæˆåˆå§‹åŒ–\nBean2 init()\n\nä¿®æ”¹Bean1çš„ä»£ç ï¼Œè®©Bean1ï¼ŒBean2å­˜åœ¨å¾ªç¯ä¾èµ–\nstatic class Bean1 &#123;\n        public void foo() &#123;\n\n        &#125;\n        public Bean1() &#123;\n            System.out.println(\"Bean1()\");\n        &#125;\n        @Autowired \n        public void setBean2(Bean2 bean2) &#123;\n            System.out.println(\"Bean1 setBean2(bean2) class is: \" + bean2.getClass());\n        &#125;\n        @PostConstruct \n        public void init() &#123;\n            System.out.println(\"Bean1 init()\");\n        &#125;\n    &#125;\n\nè¿è¡Œç»“æœå¦‚ä¸‹ï¼š>>>åˆ›å»ºBean1ï¼ŒSpringçš„æ”¾å…¥ä¸‰çº§ç¼“å­˜ï¼Œå‘ç°éœ€è¦ä¾èµ–Bean2ï¼ŒæŸ¥æ‰¾ç¼“å­˜æ²¡æœ‰Bean2ï¼Œå°±åˆ›å»ºBean2\nBean1()\n>>>åˆ›å»ºBean2ï¼ŒSpringçš„æ”¾å…¥ä¸‰çº§ç¼“å­˜,éœ€è¦Bean1ï¼ŒæŸ¥æ‰¾ç¼“å­˜æœ‰Bean1\nBean2()\n>>>åˆ›å»ºBean1çš„ä»£ç†\n[TRACE] 21:16:39.601 [main] o.s.a.a.a.AnnotationAwareAspectJAutoProxyCreator - Creating implicit proxy for bean 'bean1' with 0 common interceptors and 2 specific interceptors \n>>>>æ³¨å…¥ä»£ç†å¯¹è±¡\nBean2 setBean1(bean1) class is: class org.springframework.aop.framework.autoproxy.A17_1$Bean1$$EnhancerBySpringCGLIB$$c459ff85\n>>>>å®Œæˆåˆå§‹åŒ–\nBean2 init()\n>>>>æ³¨å…¥Bean2çš„ä»£ç†\nBean1 setBean2(bean2) class is: class org.springframework.aop.framework.autoproxy.A17_1$Bean2\n>>>>å®Œæˆåˆå§‹åŒ–\nBean1 init()\n\nå¾ªç¯ä¾èµ–æ—¶ï¼Œä»£ç†çš„åˆ›å»ºæ—¶æœºè¢«æå‰åˆ°ä¾èµ–æ³¨å…¥ä¹‹å‰\nä¾èµ–æ³¨å…¥ï¼ˆsetæ–¹æ³•ï¼‰ä¸åˆå§‹åŒ–ï¼ˆåˆå§‹åŒ–æ–¹æ³•ï¼‰ä¸åº”è¯¥è¢«å¢å¼º, ä»ç”¨åŸå§‹å¯¹è±¡çš„setå’Œåˆå§‹åŒ–æ–¹æ³•\n\n\n","slug":"ä»£ç†çš„åˆ›å»ºæ—¶æœº","date":"2023-05-11T12:55:58.000Z","categories_index":"","tags_index":"Java,Spring,Proxy","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"a95318a81b0b3097ed11bab255c7390f","title":"ä»@Aspectåˆ°Advisor","content":"@Aspectâ€”&gt;&gt;AdvisorAnnotationAwareAspectJAutoProxyCreator\nAnnotationAwareAspectJAutoProxyCreatorçš„ä½œç”¨æ˜¯å°†é«˜çº§åˆ‡é¢è½¬æ¢æˆä½çº§åˆ‡é¢ï¼Œä½¿å…¶èƒ½å¤Ÿè¢«Springæ¡†æ¶æ‰€è¯†åˆ«å’Œä½¿ç”¨ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒä¼šè¯»å–åº”ç”¨ä¸­æ‰€æœ‰çš„@Aspectæ³¨è§£ï¼Œå¹¶å°†è¿™äº›æ³¨è§£è§£ææˆåˆ‡é¢çš„å®šä¹‰ã€‚ç„¶åï¼Œå®ƒä¼šå¯¹åˆ‡é¢å®šä¹‰è¿›è¡Œè§£æï¼Œå¹¶é€šè¿‡AspectJç¼–è¯‘å™¨å°†åˆ‡é¢è½¬æ¢æˆå¯æ‰§è¡Œçš„ä»£ç å—å’Œå¢å¼ºå™¨ï¼Œå¹¶å°†å…¶ç»‘å®šåˆ°ç›®æ ‡å¯¹è±¡çš„ä»£ç†ä¸Šã€‚\nfindEligibleAdvisors \nä»å®¹å™¨ä¸­è·å–æ‰€æœ‰çš„Advisoråˆ—è¡¨ï¼Œç„¶åé€šè¿‡åŒ¹é…åˆ‡ç‚¹å’Œç›®æ ‡å¯¹è±¡ï¼Œç­›é€‰å‡ºé€‚ç”¨äºè¯¥ç›®æ ‡å¯¹è±¡çš„Advisoråˆ—è¡¨ã€‚å…·ä½“åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š\n\nè·å–Springå®¹å™¨ä¸­çš„æ‰€æœ‰Advisorã€‚Springå®¹å™¨ä¸­çš„Advisorä»£è¡¨ç€åˆ‡é¢ä¸­å®šä¹‰çš„å¢å¼ºå™¨ï¼Œå®ƒä»¬ç”¨äºåœ¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•æ‰§è¡Œå‰åè¿›è¡Œæ‹¦æˆªå¹¶æ‰§è¡Œç›¸åº”çš„å¢å¼ºé€»è¾‘ã€‚åœ¨è¿™ä¸€æ­¥ä¸­ï¼ŒfindEligibleAdvisorsæ–¹æ³•ä¼šä»å®¹å™¨ä¸­è·å–æ‰€æœ‰Advisorå¯¹è±¡åˆ—è¡¨ã€‚\nç­›é€‰ä½¿ç”¨AspectJæ³¨è§£æ ‡æ³¨çš„Aspectå¯¹è±¡ã€‚åœ¨è¿™ä¸€æ­¥ä¸­ï¼ŒfindEligibleAdvisorsæ–¹æ³•ä¼šéå†æ‰€æœ‰çš„Advisorå¯¹è±¡ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦æ˜¯ç”±ä½¿ç”¨AspectJæ³¨è§£æ ‡æ³¨çš„Aspectå¯¹è±¡åˆ›å»ºçš„ã€‚å¦‚æœæ˜¯ï¼Œåˆ™è¡¨ç¤ºè¯¥Advisorå±äºåˆ‡é¢å®šä¹‰çš„å¢å¼ºé€»è¾‘ï¼Œéœ€è¦å‚ä¸ç›®æ ‡å¯¹è±¡çš„ä»£ç†ã€‚\n\nwrapIfNecessary\nè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯æ£€æŸ¥ç›®æ ‡å¯¹è±¡æ˜¯å¦éœ€è¦è¿›è¡Œä»£ç†ï¼Œå¦‚æœéœ€è¦ï¼Œåˆ™åˆ›å»ºä»£ç†å¯¹è±¡ã€‚è€Œç›®æ ‡å¯¹è±¡æ˜¯å¦éœ€è¦è¿›è¡Œä»£ç†ï¼Œåˆ™å–å†³äºä»¥ä¸‹å‡ ä¸ªå› ç´ ï¼š\n\næ˜¯å¦å¯ç”¨ä»£ç†ã€‚å³æ˜¯å¦ä½¿ç”¨&lt;aop:aspectj-autoproxy&gt;æ ‡ç­¾å¯ç”¨äº†è‡ªåŠ¨ä»£ç†çš„åŠŸèƒ½ï¼Œæˆ–è€…åœ¨Javaé…ç½®ä¸­ä½¿ç”¨@EnableAspectJAutoProxyæ³¨è§£å¯ç”¨äº†è‡ªåŠ¨ä»£ç†çš„åŠŸèƒ½ã€‚\næ˜¯å¦æ»¡è¶³ä»£ç†æ¡ä»¶ã€‚åœ¨Springæ¡†æ¶ä¸­ï¼Œåªæœ‰å½“ç›®æ ‡å¯¹è±¡çš„ç±»å‹æ˜¯éfinalç±»æˆ–è€…å®ç°äº†ä¸€ä¸ªæˆ–å¤šä¸ªæ¥å£æ—¶ï¼Œæ‰èƒ½å¤Ÿåˆ›å»ºä»£ç†å¯¹è±¡ã€‚å¦åˆ™ï¼ŒSpringæ¡†æ¶æ— æ³•é€šè¿‡åŠ¨æ€ä»£ç†å®ç°å¯¹ç›®æ ‡å¯¹è±¡çš„å¢å¼ºã€‚\næ˜¯å¦å­˜åœ¨å¢å¼ºå™¨ã€‚åœ¨è¿™ä¸ªæ­¥éª¤ä¸­ï¼ŒSpringæ¡†æ¶ä¼šè°ƒç”¨findAdvisorsThatCanApplyæ–¹æ³•ï¼ŒæŸ¥æ‰¾é€‚åˆç›®æ ‡å¯¹è±¡çš„å¢å¼ºå™¨åˆ—è¡¨ã€‚å¦‚æœæ‰¾åˆ°äº†é€‚åˆç›®æ ‡å¯¹è±¡çš„å¢å¼ºå™¨ï¼Œåˆ™è¡¨ç¤ºéœ€è¦ä¸ºè¯¥å¯¹è±¡åˆ›å»ºä»£ç†ã€‚\n\nå¦‚æœç›®æ ‡å¯¹è±¡éœ€è¦åˆ›å»ºä»£ç†ï¼ŒwrapIfNecessaryæ–¹æ³•å°±ä¼šæ ¹æ®ç›®æ ‡å¯¹è±¡çš„ç±»å‹ï¼Œé‡‡ç”¨ä¸åŒçš„ä»£ç†æ–¹å¼æ¥åˆ›å»ºä»£ç†å¯¹è±¡ã€‚å¦‚æœç›®æ ‡å¯¹è±¡å®ç°äº†ä¸€ä¸ªæˆ–å¤šä¸ªæ¥å£ï¼Œåˆ™ä½¿ç”¨JDKåŠ¨æ€ä»£ç†çš„æ–¹å¼è¿›è¡Œä»£ç†ï¼›å¦åˆ™ï¼Œä½¿ç”¨CGLIBä»£ç†çš„æ–¹å¼è¿›è¡Œä»£ç†ã€‚\npackage org.springframework.aop.framework.autoproxy;\n\nimport org.aopalliance.intercept.MethodInterceptor;\nimport org.aspectj.lang.annotation.Aspect;\nimport org.aspectj.lang.annotation.Before;\nimport org.springframework.aop.Advisor;\n\nimport org.springframework.aop.aspectj.AspectJExpressionPointcut;\nimport org.springframework.aop.aspectj.annotation.AnnotationAwareAspectJAutoProxyCreator;\nimport org.springframework.aop.support.DefaultPointcutAdvisor;\n\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.context.annotation.ConfigurationClassPostProcessor;\nimport org.springframework.context.support.GenericApplicationContext;\nimport org.springframework.core.annotation.Order;\n\nimport java.util.List;\n\npublic class TestAspect &#123;\n    public static void main(String[] args) &#123;\n        GenericApplicationContext context = new GenericApplicationContext();\n        context.registerBean(\"aspect1\", Aspect1.class);\n        context.registerBean(\"config\", Config.class);\n        context.registerBean(ConfigurationClassPostProcessor.class);\n        context.registerBean(AnnotationAwareAspectJAutoProxyCreator.class);\n        context.refresh();\n//        for (String name : context.getBeanDefinitionNames()) &#123;\n//            System.out.println(name);\n//        &#125;\n\n        /*\n            ç¬¬ä¸€ä¸ªé‡è¦æ–¹æ³• findEligibleAdvisors æ‰¾åˆ°æœ‰ã€èµ„æ ¼ã€‘çš„ Advisors\n                a. æœ‰ã€èµ„æ ¼ã€‘çš„ Advisor ä¸€éƒ¨åˆ†æ˜¯ä½çº§çš„, å¯ä»¥ç”±è‡ªå·±ç¼–å†™, å¦‚ä¸‹ä¾‹ä¸­çš„ advisor3\n                b. æœ‰ã€èµ„æ ¼ã€‘çš„ Advisor å¦ä¸€éƒ¨åˆ†æ˜¯é«˜çº§çš„, è§£æ @Aspect åè·å¾—\n         */\n        AnnotationAwareAspectJAutoProxyCreator creator = context.getBean(AnnotationAwareAspectJAutoProxyCreator.class);\n        List&lt;Advisor> advisors = creator.findEligibleAdvisors(Target1.class, \"target1\");\n        for (Advisor advisor : advisors) &#123;\n            System.out.println(advisor);\n        &#125;\n\n        /*\n            ç¬¬äºŒä¸ªé‡è¦æ–¹æ³• wrapIfNecessary\n                a. å®ƒå†…éƒ¨è°ƒç”¨ findEligibleAdvisors, åªè¦è¿”å›é›†åˆä¸ç©º, åˆ™è¡¨ç¤ºéœ€è¦åˆ›å»ºä»£ç†\n         */\n        Object o1 = creator.wrapIfNecessary(new Target1(), \"target1\", \"target1\");\n        System.out.println(o1.getClass());\n        Object o2 = creator.wrapIfNecessary(new Target2(), \"target2\", \"target2\");\n        System.out.println(o2.getClass());\n\n        ((Target1) o1).foo();\n        /*\n            å­¦åˆ°äº†ä»€ä¹ˆ\n                a. è‡ªåŠ¨ä»£ç†åå¤„ç†å™¨ AnnotationAwareAspectJAutoProxyCreator ä¼šå¸®æˆ‘ä»¬åˆ›å»ºä»£ç†\n                b. é€šå¸¸ä»£ç†åˆ›å»ºçš„æ´»åœ¨åŸå§‹å¯¹è±¡åˆå§‹åŒ–åæ‰§è¡Œ, ä½†ç¢°åˆ°å¾ªç¯ä¾èµ–ä¼šæå‰è‡³ä¾èµ–æ³¨å…¥ä¹‹å‰æ‰§è¡Œ\n                c. é«˜çº§çš„ @Aspect åˆ‡é¢ä¼šè½¬æ¢ä¸ºä½çº§çš„ Advisor åˆ‡é¢, ç†è§£åŸç†, å¤§é“è‡³ç®€\n         */\n    &#125;\n\n    static class Target1 &#123;\n        public void foo() &#123;\n            System.out.println(\"target1 foo\");\n        &#125;\n    &#125;\n\n    static class Target2 &#123;\n        public void bar() &#123;\n            System.out.println(\"target2 bar\");\n        &#125;\n    &#125;\n\n    @Aspect // é«˜çº§åˆ‡é¢ç±»\n//    @Order(1)\n    static class Aspect1 &#123;\n        @Before(\"execution(* foo())\")\n        public void before1() &#123;\n            System.out.println(\"aspect1 before1...\");\n        &#125;\n\n        @Before(\"execution(* foo())\")\n        public void before2() &#123;\n            System.out.println(\"aspect1 before2...\");\n        &#125;\n    &#125;\n\n    @Configuration\n    static class Config &#123;\n        @Bean // ä½çº§åˆ‡é¢\n        public Advisor advisor3(MethodInterceptor advice3) &#123;\n            AspectJExpressionPointcut pointcut = new AspectJExpressionPointcut();\n            pointcut.setExpression(\"execution(* foo())\");\n            DefaultPointcutAdvisor advisor = new DefaultPointcutAdvisor(pointcut, advice3);\n            return advisor;\n        &#125;\n        @Bean\n        public MethodInterceptor advice3() &#123;\n            return invocation -> &#123;\n                System.out.println(\"advice3 before...\");\n                Object result = invocation.proceed();\n                System.out.println(\"advice3 after...\");\n                return result;\n            &#125;;\n        &#125;\n    &#125;\n\n&#125;\n\n\nè¾“å‡ºç»“æœorg.springframework.aop.interceptor.ExposeInvocationInterceptor.ADVISOR\n>>>>>>>>>>>>>>>>>>>>>>>>>>>ä½çº§åˆ‡é¢\norg.springframework.aop.support.DefaultPointcutAdvisor: pointcut [AspectJExpressionPointcut: () execution(* foo())]; advice [org.springframework.aop.framework.autoproxy.A17$Config$$Lambda$117/0x0000000800d64950@d41f816]\n>>>>>>>>>>>>>>>>>>>>>>>>>>>è¢«è§£ææˆä½çº§åˆ‡é¢çš„é«˜çº§åˆ‡é¢\nInstantiationModelAwarePointcutAdvisor: expression [execution(* foo())]; advice method [public void org.springframework.aop.framework.autoproxy.A17$Aspect1.before1()]; perClauseKind=SINGLETON\nInstantiationModelAwarePointcutAdvisor: expression [execution(* foo())]; advice method [public void org.springframework.aop.framework.autoproxy.A17$Aspect1.before2()]; perClauseKind=SINGLETON\n>>>>>>>>>>>>>>>>>>>>>>>>Target1åŒ¹é…åˆ‡é¢ï¼Œä¼šåˆ›å»ºä»£ç†\nclass org.springframework.aop.framework.autoproxy.A17$Target1$$EnhancerBySpringCGLIB$$7efd35eb\n>>>>>>>>>>>>>>>>>>>>>>>>Target2ä¸åŒ¹é…åˆ‡é¢ï¼Œä¸ä¼šåˆ›å»ºä»£ç†\nclass org.springframework.aop.framework.autoproxy.A17$Target2\nadvice3 before...\naspect1 before1...\naspect1 before2...\ntarget1 foo\nadvice3 after...\n\n  \n\n","slug":"ä»@Aspectåˆ°Advisor","date":"2023-05-11T12:04:08.000Z","categories_index":"","tags_index":"","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"d3cf2f31cfa6170a433ba0c99bf2326a","title":"åˆ‡ç‚¹åŒ¹é…è§„åˆ™","content":"åˆ‡ç‚¹åŒ¹é…è§„åˆ™AspectJä½¿ç”¨åˆ‡ç‚¹æŒ‡ç¤ºå™¨ï¼ˆPointcut Designatorï¼‰æ¥æè¿°éœ€è¦åŒ¹é…çš„åˆ‡ç‚¹ï¼Œåˆ‡ç‚¹æŒ‡ç¤ºå™¨å®šä¹‰äº†åˆ‡ç‚¹çš„åç§°ã€å‚æ•°ã€è¿”å›ç±»å‹ã€æ ‡æ³¨ç­‰ä¿¡æ¯ã€‚åˆ‡ç‚¹æŒ‡ç¤ºå™¨å¯ä»¥æ ¹æ®éœ€è¦ä½¿ç”¨é€šé…ç¬¦ã€é€»è¾‘è¿ç®—ç¬¦ã€æ­£åˆ™è¡¨è¾¾å¼ç­‰æ–¹å¼æ¥æè¿°åˆ‡ç‚¹ã€‚\nAspectJä¸­çš„åˆ‡ç‚¹æŒ‡ç¤ºç¬¦ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š\n\nexecutionï¼šåŒ¹é…æ–¹æ³•æ‰§è¡Œçš„è¿æ¥ç‚¹ï¼Œä»¥æ–¹æ³•çš„è®¿é—®ä¿®é¥°ç¬¦ã€è¿”å›ç±»å‹ã€ç±»åã€æ–¹æ³•åå’Œå‚æ•°å†³å®šã€‚\nwithinï¼šåŒ¹é…æŒ‡å®šç±»å‹å†…çš„æ–¹æ³•æ‰§è¡Œã€‚\nthisï¼šåŒ¹é…å½“å‰AOPä»£ç†å¯¹è±¡ç±»å‹çš„æ‰§è¡Œæ–¹æ³•ã€‚\ntargetï¼šåŒ¹é…å½“å‰ç›®æ ‡å¯¹è±¡ç±»å‹çš„æ‰§è¡Œæ–¹æ³•ã€‚\nargsï¼šåŒ¹é…å½“å‰æ‰§è¡Œçš„æ–¹æ³•ä¼ å…¥å‚æ•°ä¸ºæŒ‡å®šç±»å‹çš„æ‰§è¡Œæ–¹æ³•ã€‚\nannotationï¼šåŒ¹é…å½“å‰æ‰§è¡Œæ–¹æ³•æŒæœ‰æŒ‡å®šæ³¨è§£çš„æ–¹æ³•æ‰§è¡Œã€‚\nbeanï¼šåŒ¹é…æŒ‡å®šåç§°çš„beanä¸­çš„æ–¹æ³•æ‰§è¡Œã€‚\ncflowï¼šåŒ¹é…æ»¡è¶³æ¡ä»¶çš„æ–¹æ³•çš„ä»»ä½•è°ƒç”¨ã€‚\nifï¼šç”¨äºç»„åˆå…¶ä»–åˆ‡ç‚¹æŒ‡ç¤ºå™¨ã€‚\n\nä½¿ç”¨åˆ‡ç‚¹æŒ‡ç¤ºå™¨å¯ä»¥éå¸¸æ–¹ä¾¿çš„å®šä¹‰Springä¸­çš„åˆ‡ç‚¹è¡¨è¾¾å¼ï¼Œå¦‚ï¼š@Pointcut(&quot;execution(* com.example.service.*.*(..))&quot;)\npublic void servicePointcut() &#123;&#125;\n\n@Pointcut(&quot;execution(* com.example.dao.*.*(..))&quot;)\npublic void daoPointcut() &#123;&#125;\n\n@Pointcut(&quot;within(com.example.*)&quot;)\npublic void withinPointcut() &#123;&#125;\n\n@Pointcut(&quot;@annotation(com.example.annotation.Loggable)&quot;)\npublic void annotationPointcut() &#123;&#125;\n\nä¸Šé¢çš„ä»£ç å®šä¹‰äº†å››ä¸ªåˆ‡ç‚¹è¡¨è¾¾å¼ï¼Œåˆ†åˆ«å¯¹åº”äºæ‹¦æˆªserviceåŒ…ã€daoåŒ…ã€com.exampleåŒ…ä¸‹çš„æ‰€æœ‰æ–¹æ³•å’Œæ‰€æœ‰æ ‡æœ‰@Loggableæ³¨è§£çš„æ–¹æ³•çš„æ‹¦æˆªã€‚åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œå¯ä»¥å°†è¿™äº›åˆ‡ç‚¹è¡¨è¾¾å¼å’ŒAdviceç»„åˆæˆAdvisorï¼Œé€šè¿‡ä½¿ç”¨AOPæ¥å®ç°å¯¹ç›®æ ‡æ–¹æ³•çš„æ‹¦æˆªã€‚\naspectj åˆ‡ç‚¹çš„å±€é™æ€§\nå®é™…çš„ @Transactional åˆ‡ç‚¹å®ç°ï¼Œæ— æ³•åŒ¹é…å®ç°äº†æ¥å£æ·»åŠ äº†@Transactionalæ³¨è§£çš„ç±»çš„æ–¹æ³•\nimport org.springframework.aop.aspectj.AspectJExpressionPointcut;\nimport org.springframework.aop.support.StaticMethodMatcherPointcut;\nimport org.springframework.core.annotation.MergedAnnotations;\nimport org.springframework.transaction.annotation.Transactional;\n\nimport java.lang.reflect.Method;\n\npublic class A16 &#123;\n    public static void main(String[] args) throws NoSuchMethodException &#123;\n//        AspectJExpressionPointcutæ— æ³•å¤„ç†åŠ è½½ç±»ä¸Šçš„ä¿¡æ¯\n//        æ£€æŸ¥æ˜¯å¦åŒ¹é…æˆåŠŸ  execution\n        AspectJExpressionPointcut pt1 = new AspectJExpressionPointcut();\n        pt1.setExpression(\"execution(* bar())\");\n        System.out.println(pt1.matches(T1.class.getMethod(\"foo\"), T1.class));//false\n        System.out.println(pt1.matches(T1.class.getMethod(\"bar\"), T1.class));//true\n//        æ ¹æ®æ–¹æ³•æ³¨è§£è¿›è¡ŒåŒ¹é…  @annotationè¡¨è¾¾å¼\n        AspectJExpressionPointcut pt2 = new AspectJExpressionPointcut();\n        pt2.setExpression(\"@annotation(org.springframework.transaction.annotation.Transactional)\");\n        System.out.println(pt2.matches(T1.class.getMethod(\"foo\"), T1.class));//true\n        System.out.println(pt2.matches(T1.class.getMethod(\"bar\"), T3.class));//false\n       \n    &#125;\n    static class T1 &#123;\n        @Transactional\n        public void foo() &#123;\n        &#125;\n        public void bar() &#123;\n        &#125;\n    &#125;\n\n    @Transactional\n    static class T2 &#123;\n        public void foo() &#123;\n        &#125;\n    &#125;\n\n    @Transactional\n    interface I3 &#123;\n        void foo();\n    &#125;\n    static class T3 implements I3 &#123;\n        public void foo() &#123;\n        &#125;\n    &#125;\n&#125;\n\nSpringå¦‚ä½•è§£å†³\nStaticMethodMatcherPointcutæ˜¯Springæ¡†æ¶ä¸­ç”¨äºåŒ¹é…é™æ€æ–¹æ³•çš„åˆ‡ç‚¹å¯¹è±¡ã€‚åœ¨AOPç¼–ç¨‹ä¸­ï¼Œåˆ‡ç‚¹ç”¨äºå®šä¹‰åœ¨å“ªäº›æ–¹æ³•æ‰§è¡Œæ—¶ä¼šè¢«æ‹¦æˆªå¹¶æ‰§è¡Œå¢å¼ºé€»è¾‘ã€‚StaticMethodMatcherPointcutåŸºäºæŒ‡å®šçš„è§„åˆ™åŒ¹é…é™æ€æ–¹æ³•å¹¶ç¡®å®šåœ¨è¿™äº›æ–¹æ³•æ‰§è¡Œæ—¶æ˜¯å¦è¦è¿›è¡Œæ‹¦æˆªã€‚\nStaticMethodMatcherPointcutçš„åŒ¹é…è§„åˆ™æ ¹æ®ä¼ å…¥çš„Classå’Œæ–¹æ³•Methodå¯¹è±¡è¿›è¡Œåˆ¤æ–­ï¼Œåªæœ‰å½“æ–¹æ³•ç¬¦åˆé¢„å®šä¹‰çš„è§„åˆ™æ—¶ï¼Œåˆ‡ç‚¹æ‰ä¼šæ‹¦æˆªæ–¹æ³•æ‰§è¡Œï¼Œå¦åˆ™ä¼šè¢«å¿½ç•¥ã€‚é€šå¸¸ï¼Œå¯ä»¥é€šè¿‡å®ç°matchesæ–¹æ³•æ¥è‡ªå®šä¹‰åŒ¹é…è§„åˆ™ï¼Œåªæ‹¦æˆªç¬¦åˆæ¡ä»¶çš„ç›®æ ‡æ–¹æ³•ã€‚\n//        StaticMethodMatcherPointcutæŠ½è±¡ç±»å¯ä»¥å¤„ç†ç±»ä¸Šçš„ä¿¡æ¯ï¼Œå®ç°matchæ–¹æ³•\n        StaticMethodMatcherPointcut pt3 = new StaticMethodMatcherPointcut() &#123;\n            @Override               //æ–¹æ³•                    ç±»\n            public boolean matches(Method method, Class&lt;?> targetClass) &#123;\n                // è¯»å–æ–¹æ³•ä¿¡æ¯ï¼Œæ£€æŸ¥æ–¹æ³•ä¸Šæ˜¯å¦åŠ äº† Transactional æ³¨è§£\n                MergedAnnotations annotations = MergedAnnotations.from(method);\n                if (annotations.isPresent(Transactional.class)) &#123;\n                    return true;\n                &#125;\n    \t\t\t// è¯»å–æ–¹æ³•ä¿¡æ¯ç±»ä¿¡æ¯ï¼ŒæŸ¥çœ‹ç±»ä¸Šæ˜¯å¦åŠ äº† Transactional æ³¨è§£\n                //é»˜è®¤åªæŸ¥çœ‹æœ¬ç±»åˆ æ˜¯å¦å«æœ‰ç›¸åº”ä¿¡æ¯ï¼Œä¿®æ”¹æˆSearchStrategy.TYPE_HIERARCHY\n                annotations = MergedAnnotations.from(targetClass, MergedAnnotations.SearchStrategy.TYPE_HIERARCHY);\n                if (annotations.isPresent(Transactional.class)) &#123;\n                    return true;\n                &#125;\n                return false;\n            &#125;\n        &#125;;\n\n        System.out.println(pt3.matches(T1.class.getMethod(\"foo\"), T1.class));//true\n        System.out.println(pt3.matches(T1.class.getMethod(\"bar\"), T1.class));//false\n        System.out.println(pt3.matches(T2.class.getMethod(\"foo\"), T2.class));//true\n        System.out.println(pt3.matches(T3.class.getMethod(\"foo\"), T3.class));//true\n\n\n\n\nåº•å±‚åˆ‡ç‚¹å®ç°æ˜¯å¦‚ä½•åŒ¹é…çš„: è°ƒç”¨äº† aspectj çš„åŒ¹é…æ–¹æ³•\n\næ¯”è¾ƒå…³é”®çš„æ˜¯å®ƒå®ç°äº† MethodMatcher æ¥å£, ç”¨æ¥æ‰§è¡Œæ–¹æ³•çš„åŒ¹é…\n\n\n","slug":"åˆ‡ç‚¹åŒ¹é…è§„åˆ™","date":"2023-05-11T09:35:15.000Z","categories_index":"","tags_index":"Java,Spring","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"42403d33a4a316854760bf766fee144b","title":"JDKå’ŒCGlibåœ¨Springä¸­çš„ç»Ÿä¸€","content":"JDKå’ŒCGlibåœ¨Springä¸­çš„ç»Ÿä¸€Spring ä¸­å¯¹åˆ‡ç‚¹ã€é€šçŸ¥ã€åˆ‡é¢çš„æŠ½è±¡å¦‚ä¸‹\n\nåˆ‡ç‚¹ï¼šæ¥å£ Pointcutï¼Œå…¸å‹å®ç° AspectJExpressionPointcut\né€šçŸ¥ï¼šå…¸å‹æ¥å£ä¸º MethodInterceptor ä»£è¡¨ç¯ç»•é€šçŸ¥\nåˆ‡é¢ï¼šAdvisorï¼ŒåŒ…å«ä¸€ä¸ª Advice é€šçŸ¥ï¼ŒPointcutAdvisor åŒ…å«ä¸€ä¸ª Advice é€šçŸ¥å’Œä¸€ä¸ª Pointcut\n\nclassDiagram\n\nclass Advice\nclass MethodInterceptor\nclass Advisor\nclass PointcutAdvisor\n\nPointcut &lt;|-- AspectJExpressionPointcut\nAdvice &lt;|-- MethodInterceptor\nAdvisor &lt;|-- PointcutAdvisor\nPointcutAdvisor o-- \"ä¸€\" Pointcut\nPointcutAdvisor o-- \"ä¸€\" Advice\n\n&lt;&lt;interface>> Advice\n&lt;&lt;interface>> MethodInterceptor\n&lt;&lt;interface>> Pointcut\n&lt;&lt;interface>> Advisor\n&lt;&lt;interface>> PointcutAdvisor\n\nä»£ç†ç›¸å…³ç±»å›¾\n\nAopProxyFactory æ ¹æ® proxyTargetClass ç­‰è®¾ç½®é€‰æ‹© AopProxy å®ç°\nAopProxy é€šè¿‡ getProxy åˆ›å»ºä»£ç†å¯¹è±¡\nå›¾ä¸­ Proxy éƒ½å®ç°äº† Advised æ¥å£ï¼Œèƒ½å¤Ÿè·å¾—å…³è”çš„åˆ‡é¢é›†åˆä¸ç›®æ ‡ï¼ˆå…¶å®æ˜¯ä» ProxyFactory å–å¾—ï¼‰\nè°ƒç”¨ä»£ç†æ–¹æ³•æ—¶ï¼Œä¼šå€ŸåŠ© ProxyFactory å°†é€šçŸ¥ç»Ÿä¸€è½¬ä¸ºç¯ç»•é€šçŸ¥ï¼šMethodInterceptor\n\nclassDiagram\n\nAdvised &lt;|-- ProxyFactory\nProxyFactory o-- Target\nProxyFactory o-- \"å¤š\" Advisor\n\nProxyFactory --> AopProxyFactory : ä½¿ç”¨\nAopProxyFactory --> AopProxy\nAdvised &lt;|-- åŸºäºCGLIBçš„Proxy\nåŸºäºCGLIBçš„Proxy &lt;-- ObjenesisCglibAopProxy : åˆ›å»º\nAopProxy &lt;|-- ObjenesisCglibAopProxy\nAopProxy &lt;|-- JdkDynamicAopProxy\nåŸºäºJDKçš„Proxy &lt;-- JdkDynamicAopProxy : åˆ›å»º\nAdvised &lt;|-- åŸºäºJDKçš„Proxy\n\nclass AopProxy &#123;\n   +getProxy() Object\n&#125;\n\nclass ProxyFactory &#123;\n\tproxyTargetClass : boolean\n&#125;\n\nclass ObjenesisCglibAopProxy &#123;\n\tadvised : ProxyFactory\n&#125;\n\nclass JdkDynamicAopProxy &#123;\n\tadvised : ProxyFactory\n&#125;\n\n&lt;&lt;interface>> Advised\n&lt;&lt;interface>> AopProxyFactory\n&lt;&lt;interface>> AopProxy\n\n\n\nåœ¨ Spring ä¸­ï¼ŒJDKåŠ¨æ€ä»£ç†å’ŒCGLIBåŠ¨æ€ä»£ç†ä¼šè¢«è‡ªåŠ¨åœ°ç»Ÿä¸€ä½¿ç”¨ã€‚Springæ¡†æ¶ä¼šè‡ªåŠ¨é€‰æ‹©åˆé€‚çš„ä»£ç†æ–¹å¼ï¼Œä»¥ç¡®ä¿ä»£ç†å¯¹è±¡çš„æ­£ç¡®æ€§å’Œé«˜æ•ˆæ€§ã€‚\nå¦‚æœæˆ‘ä»¬å¸Œæœ›ä»£ç†çš„å¯¹è±¡å®ç°äº†æ¥å£ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ã€‚ç›¸æ¯” CGLIB åŠ¨æ€ä»£ç†ï¼ŒJDK åŠ¨æ€ä»£ç†çš„ä»£ç†å¯¹è±¡æ›´åŠ è½»é‡çº§ï¼Œå› ä¸ºç›´æ¥å®ç°äº†ç›®æ ‡å¯¹è±¡çš„æ¥å£ã€‚\nå¦‚æœæˆ‘ä»¬å¸Œæœ›ä»£ç†å¯¹è±¡æ²¡æœ‰å®ç°æ¥å£ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªèƒ½ä½¿ç”¨ CGLIB åŠ¨æ€ä»£ç†ã€‚CGLIB åŠ¨æ€ä»£ç†ä¼šåœ¨è¿è¡Œæ—¶ç”Ÿæˆä»£ç†å¯¹è±¡çš„å­ç±»ï¼Œå¹¶é‡å†™ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ã€‚æ‰€ä»¥ CGLIB åŠ¨æ€ä»£ç†çš„ä»£ç†å¯¹è±¡æ¯” JDK åŠ¨æ€ä»£ç†çš„ä»£ç†å¯¹è±¡æ›´åŠ å¼ºå¤§å’Œçµæ´»ï¼Œä½†åŒæ—¶ä¹Ÿæ›´åŠ é‡é‡çº§ã€‚\næ€»ä¹‹ï¼Œåœ¨ä½¿ç”¨ Spring æ¡†æ¶ä¸­çš„ AOP æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨ä»£ç†å¯¹è±¡æ˜¯å¦å®ç°äº†æ¥å£ï¼ŒSpring ä¼šæ ¹æ®æƒ…å†µè‡ªåŠ¨é€‰æ‹©ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†è¿˜æ˜¯ CGLIB åŠ¨æ€ä»£ç†ã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›é€‰æ‹©ç‰¹å®šçš„ä»£ç†æ–¹å¼ï¼Œå¯ä»¥é€šè¿‡åœ¨ Spring é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œé…ç½®æ¥å®ç°ã€‚\næ¨¡æ‹ŸSpringåˆ›å»ºä»£ç†çš„ä½¿ç”¨jdkæˆ–è€…cglib&#x2F;&#x2F;è¦æ³¨æ„å¯¼åŒ…ï¼šMethodInterceptoræ˜¯ä¸ cglibçš„ MethodInterceptor åŒåçš„\nimport org.aopalliance.intercept.MethodInterceptor;\nimport org.springframework.aop.aspectj.AspectJExpressionPointcut;\nimport org.springframework.aop.framework.ProxyFactory;\nimport org.springframework.aop.support.DefaultPointcutAdvisor;\n\npublic class TestSpringAop &#123;\n    public static void main(String[] args) &#123;\n        &#x2F;*\n            ä¸¤ä¸ªåˆ‡é¢æ¦‚å¿µ\n            aspect &#x3D;\n                é€šçŸ¥1(advice) +  åˆ‡ç‚¹1(pointcut)\n                é€šçŸ¥2(advice) +  åˆ‡ç‚¹2(pointcut)\n                é€šçŸ¥3(advice) +  åˆ‡ç‚¹3(pointcut)\n                ...\n            advisor &#x3D; æ›´ç»†ç²’åº¦çš„åˆ‡é¢ï¼ŒåŒ…å«ä¸€ä¸ªé€šçŸ¥å’Œåˆ‡ç‚¹\n         *&#x2F;\n\n        &#x2F;&#x2F; 1. å‡†å¤‡å¥½åˆ‡ç‚¹\n        AspectJExpressionPointcut pointcut &#x3D; new AspectJExpressionPointcut();\n        pointcut.setExpression(&quot;execution(* foo())&quot;);\n        &#x2F;&#x2F; 2. å‡†å¤‡å¥½é€šçŸ¥  MethodInterceptorä¸cglibçš„MethodInterceptorä¸ä¸€æ ·\n        &#x2F;&#x2F;æœ¬è´¨ä¸Šæ˜¯ç¯ç»•é€šçŸ¥\n        MethodInterceptor advice &#x3D; new MethodInterceptor() &#123;\n            @Override\n            public Object invoke(MethodInvocation invocation) throws Throwable &#123;\n                System.out.println(&quot;before...&quot;);\n                Object result &#x3D; invocation.proceed(); &#x2F;&#x2F; è°ƒç”¨ç›®æ ‡\n                System.out.println(&quot;after...&quot;);\n                return result;\n            &#125;\n        &#125;;\n        &#x2F;&#x2F; 3. å¤‡å¥½åˆ‡é¢\n        DefaultPointcutAdvisor advisor &#x3D; new DefaultPointcutAdvisor(pointcut, advice);\n        &#x2F;&#x2F; 4. åˆ›å»ºä»£ç†\n        Target2 target &#x3D; new Target2();\n        ProxyFactory factory &#x3D; new ProxyFactory();\n        factory.setTarget(target);\n        factory.addAdvisor(advisor);\n        &#x2F;&#x2F;è·å–æ¥å£ç±»å‹ factoryæ— æ³•åˆ¤æ–­æ˜¯å¦å®ç°äº†æ¥å£ï¼Œéœ€è¦æ‰‹åŠ¨è®¾ç½®\n        factory.setInterfaces(target.getClass().getInterfaces());\n        factory.setProxyTargetClass(false);\n        Target2 proxy &#x3D; (Target2) factory.getProxy();\n        &#x2F;&#x2F;cglibä»£ç†\n        System.out.println(proxy.getClass());\n        proxy.foo();\n        proxy.bar();\n        &#x2F;*\n            å­¦åˆ°äº†ä»€ä¹ˆ\n                a. Spring çš„ä»£ç†é€‰æ‹©è§„åˆ™\n                b. åº•å±‚çš„åˆ‡ç‚¹å®ç°\n                c. åº•å±‚çš„é€šçŸ¥å®ç°\n                d. ProxyFactory æ˜¯ç”¨æ¥åˆ›å»ºä»£ç†çš„æ ¸å¿ƒå®ç°, ç”¨ AopProxyFactory é€‰æ‹©å…·ä½“ä»£ç†å®ç°\n                    - JdkDynamicAopProxy\n                    - ObjenesisCglibAopProxy\n         *&#x2F;\n    &#125;\n\n    interface I1 &#123;\n        void foo();\n\n        void bar();\n    &#125;\n\n    static class Target1 implements I1 &#123;\n        public void foo() &#123;\n            System.out.println(&quot;target1 foo&quot;);\n        &#125;\n\n        public void bar() &#123;\n            System.out.println(&quot;target1 bar&quot;);\n        &#125;\n    &#125;\n\n    static class Target2 &#123;\n        public void foo() &#123;\n            System.out.println(&quot;target2 foo&quot;);\n        &#125;\n\n        public void bar() &#123;\n            System.out.println(&quot;target2 bar&quot;);\n        &#125;\n    &#125;\n&#125;\n\nSpring çš„ä»£ç†é€‰æ‹©è§„ï¼š\n\nproxyTargetClass &#x3D; false, ç›®æ ‡å®ç°äº†æ¥å£, ç”¨ jdk å®ç°\nproxyTargetClass &#x3D; false,  ç›®æ ‡æ²¡æœ‰å®ç°æ¥å£, ç”¨ cglib å®ç°\nproxyTargetClass &#x3D; true, æ€»æ˜¯ä½¿ç”¨ cglib å®ç°\n\n","slug":"JDKå’ŒCGlibåœ¨Springä¸­çš„ç»Ÿä¸€","date":"2023-05-11T05:01:11.000Z","categories_index":"","tags_index":"Java,Spring,Proxy","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"f73a8e23e6f6f669cf99c7dba8fa0722","title":"","content":"title: AOPå®ç°ä¹‹proxydate: 2023-05-10 16:38:34tags:\n\nAOP\nSpring\nJava\n\nAOPå®ç°ä¹‹proxyjdkåŠ¨æ€ä»£ç†\nåŠ¨æ€ä»£ç†æ˜¯é€šè¿‡åå°„æœºåˆ¶å®ç°çš„ï¼Œå¯ä»¥åŠ¨æ€åœ°ç”Ÿæˆä»£ç†ç±»å’Œä»£ç†å¯¹è±¡ï¼Œåœ¨è¿è¡Œæ—¶å°†éœ€è¦å¢å¼ºçš„ä»£ç ç»‡å…¥åˆ°ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ä¸­ã€‚\nå®ç°åŠ¨æ€ä»£ç†ï¼Œéœ€è¦ç”¨åˆ°ä»¥ä¸‹ç±»å’Œæ¥å£ï¼š\n\njava.lang.reflect.Proxyï¼šæä¾›äº†ç”¨äºåˆ›å»ºåŠ¨æ€ä»£ç†çš„æ–¹æ³•newProxyInstance()ã€‚\njava.lang.reflect.InvocationHandlerï¼šå®šä¹‰äº†ä»£ç†å¯¹è±¡çš„è°ƒç”¨å¤„ç†å™¨ï¼Œè´Ÿè´£å®ç°ä»£ç†å¯¹è±¡è°ƒç”¨çš„é€»è¾‘ä»¥åŠéœ€è¦å¢å¼ºçš„ä»£ç ã€‚\n\nä»£ç†å¯¹è±¡è°ƒç”¨çš„æµç¨‹å¦‚ä¸‹ï¼š\n\nå½“ä»£ç†å¯¹è±¡çš„æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œä¼šè¢«è½¬å‘åˆ°InvocationHandlerçš„invoke()æ–¹æ³•ã€‚\nåœ¨invoke()æ–¹æ³•ä¸­ï¼Œæ ¹æ®è°ƒç”¨çš„æ–¹æ³•åå’Œå‚æ•°ï¼Œåˆ¤æ–­éœ€è¦æ‰§è¡Œä»€ä¹ˆæ ·çš„ä¸šåŠ¡é€»è¾‘ã€‚\nå¦‚æœéœ€è¦å¢å¼ºæ–¹æ³•ï¼Œå°†å¢å¼ºé€»è¾‘æ’å…¥åˆ°è°ƒç”¨æ–¹æ³•å‰æˆ–åæ‰§è¡Œï¼Œå¦åˆ™ç›´æ¥è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ã€‚\n\nä¼˜ç‚¹\nä½¿ç”¨jdkåŠ¨æ€ä»£ç†çš„å¥½å¤„æ˜¯å¯ä»¥é¿å…æ‰‹åŠ¨ç¼–å†™ä»£ç†ç±»ï¼Œæé«˜ä»£ç çš„å¤ç”¨åº¦ã€‚åŒæ—¶ï¼Œç”±äºjdkåŠ¨æ€ä»£ç†æ˜¯è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œå› æ­¤ä¸éœ€è¦é’ˆå¯¹æ¯ä¸ªè¢«ä»£ç†çš„ç±»æ‰‹åŠ¨åˆ›å»ºä»£ç†ç±»ï¼Œæé«˜äº†å¼€å‘æ•ˆç‡ã€‚\nç¼ºç‚¹\n\nä»£ç†å¯¹è±¡å¿…é¡»å®ç°æ¥å£ï¼šç”±äºjdkåŠ¨æ€ä»£ç†æ˜¯åŸºäºæ¥å£è¿›è¡Œä»£ç†çš„ï¼Œå› æ­¤åªèƒ½å¤Ÿä¸ºæ¥å£ç±»å‹çš„ç±»åˆ›å»ºä»£ç†å¯¹è±¡ã€‚å¦‚æœéœ€è¦å¯¹éæ¥å£ç±»å‹çš„ç±»è¿›è¡Œä»£ç†ï¼Œå¯ä»¥ä½¿ç”¨CGLibåº“ã€‚\n\nè¡¥å……è¯´æ˜\nJDK åªèƒ½é’ˆå¯¹æ¥å£ä»£ç†ï¼Œä»£ç†å¯¹è±¡å’Œç›®æ ‡å¯¹è±¡ä¹‹é—´æ˜¯å¹³çº§å…„å¼Ÿå…³ç³»ï¼Œä¹Ÿå°±æ˜¯è¯´ä»£ç†å¯¹è±¡å¹¶ä¸æ˜¯ç›®æ ‡å¯¹è±¡çš„å­ç±»ï¼Œè€Œæ˜¯å®ç°äº†ç›¸åŒæ¥å£çš„æ–°ç±»å‹ã€‚å› æ­¤ï¼Œåœ¨ç†è®ºä¸Šï¼Œä»£ç†å¯¹è±¡å’Œç›®æ ‡å¯¹è±¡çš„ç±»å‹å¯ä»¥æ˜¯ç›¸åŒçš„ï¼Œç”šè‡³ç›®æ ‡å¯¹è±¡å¯ä»¥è¢« final ä¿®é¥°ã€‚\nç¤ºä¾‹import java.lang.reflect.InvocationHandler;\nimport java.lang.reflect.Method;\nimport java.lang.reflect.Proxy;\n\ninterface Hello &#123;\n    void sayHello();\n&#125;\n\nclass HelloImpl implements Hello &#123;\n    public void sayHello() &#123;\n        System.out.println(\"Hello world!\");\n    &#125;\n&#125;\n\nclass MyInvocationHandler implements InvocationHandler &#123;\n    private Object target;// ç›®æ ‡å¯¹è±¡\n\n    public MyInvocationHandler(Object target) &#123;\n        this.target = target;\n    &#125;\n\n    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;\n        System.out.println(\"Before Method Invoke\");\n        // æ–¹æ³•.invoke(ç›®æ ‡, å‚æ•°);\n        Object result = method.invoke(target, args);\n        System.out.println(\"After Method Invoke\");\n        return result;\n    &#125;\n&#125;\n\npublic class ProxyTest &#123;\n    public static void main(String[] args) &#123;\n        HelloImpl hello = new HelloImpl();\n        MyInvocationHandler handler = new MyInvocationHandler(hello);\n        //å‚æ•°ï¼ˆç›®æ ‡ç±»çš„ç±»åŠ è½½å™¨ç”¨äºè¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆå­—èŠ‚ç ï¼Œæ¥å£ç±»å‹ï¼ŒInvocationHandlerçš„å…·ä½“å®ç°ï¼‰\n        Hello proxyHello = Proxy.newProxyInstance(hello.getClass().getClassLoader(),\n                hello.getClass().getInterfaces(), handler);\n        proxyHello.sayHello();\n    &#125;\n&#125;\n\n\n\nCGlibä»£ç†CGlibæ˜¯ä¸€ä¸ªå¼€æºçš„Javaå­—èŠ‚ç å¢å¼ºåº“ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°ç”Ÿæˆä¸€ä¸ªç›®æ ‡ç±»çš„å­ç±»ï¼Œé€šè¿‡è¿™ä¸ªå­ç±»æ¥å®ç°å¯¹ç›®æ ‡ç±»çš„ä»£ç†ï¼ˆä»£ç†çš„å…·ä½“å®ç°æ–¹å¼è§†æƒ…å†µè€Œå®šï¼‰ã€‚ä¸JDKåŠ¨æ€ä»£ç†ç›¸æ¯”ï¼ŒCGlibä»£ç†æ— éœ€ç›®æ ‡å¯¹è±¡å®ç°æ¥å£ï¼Œèƒ½å¤Ÿä»£ç†ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬privateã€protectedä¿®é¥°çš„æ–¹æ³•ã€‚\nCGlibä»£ç†çš„å®ç°ä¸­ï¼Œéœ€è¦ä½¿ç”¨åˆ°ASMåº“æ¥ç”Ÿæˆä»£ç†ç±»çš„å­—èŠ‚ç ã€‚å…·ä½“è€Œè¨€ï¼ŒASMæ˜¯ä¸€ä¸ªè½»é‡çº§Javaå­—èŠ‚ç æ“ä½œå’Œç”Ÿæˆåº“ï¼Œèƒ½å¤Ÿåœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆç±»çš„å­—èŠ‚ç ï¼Œä»¥è¾¾åˆ°åŠ¨æ€ä¿®æ”¹ç±»çš„ç›®çš„ã€‚\nä½¿ç”¨CGlibä»£ç†æ—¶ï¼Œæˆ‘ä»¬ä¸€èˆ¬éœ€è¦å®ç°ä¸€ä¸ªMethodInterceptoræ¥å£ï¼Œç”¨æ¥å¯¹ç›®æ ‡ç±»çš„æ–¹æ³•è¿›è¡Œæ‹¦æˆªå’Œå¢å¼ºã€‚\nCGLibå®ç°ä»£ç†çš„åŸç†å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š\n\nå®šä¹‰ä¸€ä¸ªç±»ï¼Œç»§æ‰¿è¢«ä»£ç†ç±»ï¼›\nåœ¨ä»£ç†ç±»ä¸­å®šä¹‰ä¸€ä¸ªå˜é‡ï¼Œç”¨äºæŒæœ‰è¢«ä»£ç†ç±»çš„å¼•ç”¨ï¼›\nåœ¨ä»£ç†ç±»ä¸­é‡å†™è¢«ä»£ç†ç±»ä¸­çš„æ‰€æœ‰éœ€è¦ä»£ç†çš„æ–¹æ³•ï¼›\nåœ¨é‡å†™çš„æ–¹æ³•ä¸­åŠ å…¥é¢å¤–çš„ä»£ç†é€»è¾‘ï¼ˆä¾‹å¦‚è®°å½•æ–¹æ³•è°ƒç”¨çš„æ—¥å¿—ã€è¿›è¡Œæƒé™éªŒè¯ç­‰ï¼‰ã€‚\n\nCGLibå®ç°ä»£ç†çš„æ­¥éª¤ï¼š\n\nè®¾ç½®CGLibçš„Enhancerå¯¹è±¡çš„SuperClasså’ŒCallbackå±æ€§ï¼Œè¿™æ ·Enhancerå°±çŸ¥é“è¦ä»£ç†å“ªä¸ªç±»ä»¥åŠä»£ç†çš„å…·ä½“å®ç°æ–¹å¼ï¼›\nä½¿ç”¨Enhancerå¯¹è±¡çš„create()æ–¹æ³•æ¥ç”Ÿæˆä»£ç†å¯¹è±¡ã€‚\n\né€šè¿‡å®ä¾‹äº†è§£ä¸€ä¸‹cglibçš„å·¥ä½œå¤§æ¦‚æµç¨‹\nç¤ºä¾‹1import net.sf.cglib.proxy.Enhancer;\nimport net.sf.cglib.proxy.MethodInterceptor;\nimport net.sf.cglib.proxy.MethodProxy;\n\nimport java.lang.reflect.Method;\n\npublic class CGLibProxyDemo &#123;\n\n    public static void main(String[] args) &#123;\n        RealSubject realSubject = new RealSubject();\n        RealSubject proxy = (RealSubject) Enhancer.create(RealSubject.class, new MyMethodInterceptor(realSubject));\n        proxy.request();\n    &#125;\n\n    static class RealSubject &#123;\n        public void request() &#123;\n            System.out.println(\"RealSubject.request()\");\n        &#125;\n    &#125;\n\t//å®ç°ä¸€ä¸ªMethodInterceptoræ¥å£\n    static class MyMethodInterceptor implements MethodInterceptor &#123;\n        private Object target;//ç›®æ ‡\n\n        public MyMethodInterceptor(Object target) &#123;\n            this.target = target;\n        &#125;\n\n        @Override\n        public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable &#123;\n            System.out.println(\"Before method: \" + method);\n            Object result = method.invoke(target, objects);\n            System.out.println(\"After method: \" + method);\n            return result;\n        &#125;\n    &#125;\n&#125;\n\nåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒMyMethodInterceptorç±»æ˜¯å®ç°äº†CGLibçš„MethodInterceptoræ¥å£ï¼Œå®ƒçš„ä½œç”¨æ˜¯åœ¨ä»£ç†ç±»çš„æ–¹æ³•æ‰§è¡Œæ—¶è¿›è¡Œæ‹¦æˆªå’Œå¢å¼ºã€‚\né€šè¿‡è°ƒç”¨Enhancer.create()æ–¹æ³•ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œå®ƒæ‹¥æœ‰RealSubjectç±»çš„å…¨éƒ¨æ–¹æ³•ï¼Œä½†æ˜¯åœ¨æ‰§è¡Œrequestæ–¹æ³•æ—¶ä¼šç»è¿‡CGLibç”Ÿæˆçš„MyMethodInterceptoræ‹¦æˆªå™¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªæ‹¦æˆªå™¨ä¸­è¿›è¡Œè‡ªå·±çš„é€»è¾‘å¤„ç†ã€‚\nç¤ºä¾‹2import org.springframework.cglib.proxy.Enhancer;\nimport org.springframework.cglib.proxy.MethodInterceptor;\nimport org.springframework.cglib.proxy.MethodProxy;\n\nimport java.lang.reflect.Method;\nimport java.util.Arrays;\n\npublic class CglibProxyDemo &#123;\n\n    static class Target &#123;\n        public void foo() &#123;\n            System.out.println(\"target foo\");\n        &#125;\n    &#125;\n\n    // ä»£ç†æ˜¯å­ç±»å‹, ç›®æ ‡æ˜¯çˆ¶ç±»å‹\n    public static void main(String[] param) &#123;\n//        Target target = new Target();\n\n        Target proxy = (Target) Enhancer.create(Target.class, new MethodInterceptor() &#123;\n            @Override\n            public Object intercept(Object p, Method method, Object[] args, MethodProxy methodProxy) throws Throwable &#123;\n                System.out.println(\"before...\");\n//  Object result = method.invoke(target, args); // ç”¨æ–¹æ³•åå°„è°ƒç”¨ç›®æ ‡\n// methodProxy å®ƒå¯ä»¥é¿å…åå°„è°ƒç”¨\n//  Object result = methodProxy.invoke(target, args); // å†…éƒ¨æ²¡æœ‰ç”¨åå°„, éœ€è¦ç›®æ ‡ ï¼ˆspringï¼‰\n    Object result = methodProxy.invokeSuper(p, args); // å†…éƒ¨æ²¡æœ‰ç”¨åå°„, éœ€è¦ä»£ç†\n                System.out.println(\"after...\");\n                return result;\n            &#125;\n        &#125;);\n\n        proxy.foo();\n\n    &#125;\n&#125;\n\næœ‰ä¸‰ç§è°ƒç”¨æ–¹å¼ï¼šmethod.invoke(target, args)  ç”¨åå°„è°ƒç”¨ç›®æ ‡ï¼Œæ€§èƒ½è¾ƒä½ï¼Œéœ€è¦ç›®æ ‡å¯¹è±¡\nâ€‹\t\t\t\t\t\t\t\tmethodProxy.invoke(target, args) å†…éƒ¨æ²¡æœ‰ä½¿ç”¨åå°„ï¼Œéœ€è¦ç›®æ ‡å¯¹è±¡  springä½¿ç”¨çš„æ–¹å¼\nâ€‹\t\t\t\t\t\t\t\tmethodProxy.invokeSuper(p, args) å†…éƒ¨æ²¡æœ‰ä½¿ç”¨åå°„ï¼Œä¸éœ€è¦ç›®æ ‡å¯¹è±¡\nä»£ç†æ˜¯å­ç±»å‹, ç›®æ ‡æ˜¯çˆ¶ç±»å‹ï¼š\n\nå½“ç›®æ ‡ä½¿ç”¨finalä¿®é¥°ï¼Œæ— æ³•ä»£ç†ä¼šæŠ¥é”™\n\nå½“ä»£ç†æ–¹æ³•ä½¿ç”¨finalä¿®é¥°ï¼Œä¸ä¼šæŠŠé”™ï¼Œæ–¹æ³•æ— æ³•å¾—åˆ°å¢å¼º\n\n\næ¨¡æ‹ŸjdkåŠ¨æ€ä»£ç†æºç ç¤ºä¾‹public class Test &#123;\n    public static void main(String[] param) &#123;\n        // â¬‡ï¸1. åˆ›å»ºä»£ç†ï¼Œè¿™æ—¶ä¼ å…¥ InvocationHandler\n        Foo proxy = new $Proxy0(new InvocationHandler() &#123;    \n            // â¬‡ï¸5. è¿›å…¥ InvocationHandler\n            public Object invoke(Object proxy, Method method, Object[] args) throws Throwable&#123;\n                // â¬‡ï¸6. åŠŸèƒ½å¢å¼º\n                System.out.println(\"before...\");\n                // â¬‡ï¸7. åå°„è°ƒç”¨ç›®æ ‡æ–¹æ³•\n                return method.invoke(new Target(), args);\n            &#125;\n        &#125;);\n        // â¬‡ï¸2. è°ƒç”¨ä»£ç†æ–¹æ³•\n        proxy.foo();\n        proxy.bar();\n    &#125;\n&#125;\n\npublic interface Foo &#123;\n        void foo();\n        int bar();\n    &#125;\n\n\nstatic class Target implements Foo &#123;\n        public void foo() &#123;\n            System.out.println(\"target foo\");\n        &#125;\n\n        public int bar() &#123;\n            System.out.println(\"target bar\");\n            return 100;\n        &#125;\n    &#125;\n\n\n// â¬‡ï¸è¿™å°±æ˜¯ jdk ä»£ç†ç±»çš„æºç , ç§˜å¯†éƒ½åœ¨é‡Œé¢\npublic class $Proxy0 extends Proxy implements Foo &#123;\n\n    public $Proxy0(InvocationHandler h) &#123;\n        super(h);\n    &#125;\n    // â¬‡ï¸3. è¿›å…¥ä»£ç†æ–¹æ³•\n    public void foo() &#123;\n        try &#123;\n            // â¬‡ï¸4. å›è°ƒ InvocationHandler\n            h.invoke(this, foo, new Object[0]);\n        &#125; catch (RuntimeException | Error e) &#123;\n            throw e;\n        &#125; catch (Throwable e) &#123;\n            throw new UndeclaredThrowableException(e);\n        &#125;\n    &#125;\n\n    @Override\n    public int bar() &#123;\n        //ç”¨try-catchå¤„ç†ï¼ŒæŠŠcatchåˆ°çš„å¼‚å¸¸æŠ›å‡ºï¼Œè®©å¤–ç•ŒçŸ¥é“ä»£ç†æœ‰æ²¡æœ‰æ‰§è¡Œé”™è¯¯\n        try &#123;\n            Object result = h.invoke(this, bar, new Object[0]);\n            return (int) result;\n        &#125; catch (RuntimeException | Error e) &#123;//è¿è¡Œå¼‚å¸¸ç›´æ¥æŠ›å‡º\n            throw e;\n        &#125; catch (Throwable e) &#123;\n            throw new UndeclaredThrowableException(e);//æ£€æŸ¥å¼‚å¸¸è¦è½¬æ¢æˆè¿è¡Œå¼‚å¸¸å†æŠ›å‡º\n        &#125;\n    &#125;\n\n    static Method foo;\n    static Method bar;\n    static &#123;\n        try &#123;\n            foo = A12.Foo.class.getMethod(\"foo\");\n            bar = A12.Foo.class.getMethod(\"bar\");\n        &#125; catch (NoSuchMethodException e) &#123;\n            throw new NoSuchMethodError(e.getMessage());\n        &#125;\n    &#125;\n&#125;\n\nä»¥ä¸Šæ˜¯æ¨¡æ‹ŸjdkåŠ¨æ€ä»£ç†å¯¹è±¡çš„æºç ï¼Œé€šè¿‡æ¥å£å›è°ƒå°†ã€å¢å¼ºé€»è¾‘ã€‘ç½®äºä»£ç†ç±»ä¹‹å¤–\nä½†æ˜¯åœ¨çœŸå®çš„åœºæ™¯ä¸­ï¼Œä»£ç†å¯¹è±¡æ˜¯çœ‹ä¸åˆ°çš„ï¼Œæ˜¯ç¨‹åºåœ¨è¿è¡ŒæœŸé—´é€šè¿‡asmæŠ€æœ¯åŠ¨æ€ç”Ÿæˆä»£ç†å¯¹è±¡çš„ASMfiled\n\næŠŠASMfiledå¯¼å‡ºæˆä¸€ä¸ªç±»ï¼ˆå¯ä»¥é€šè¿‡æµè¯»å–å­—èŠ‚æ•°ç»„ï¼Œç”Ÿæˆä»£ç†å¯¹è±¡ï¼ŒæŸ¥çœ‹é‡Œé¢çš„å†…å®¹ï¼‰\n\nåœ¨Javaä»£ç†ä¸­ï¼ŒASMæ¡†æ¶é€šå¸¸æ˜¯ä½œä¸ºåŠ¨æ€ä»£ç†æœºåˆ¶çš„åº•å±‚å®ç°ï¼Œç”¨æ¥ç”Ÿæˆå­—èŠ‚ç å¹¶åˆ›å»ºä»£ç†ç±»ã€‚å…·ä½“æ¥è¯´ï¼Œä½¿ç”¨ASMæ¡†æ¶åˆ›å»ºä»£ç†ç±»çš„è¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š\n\nå®šä¹‰ä¸€ä¸ªClassWriterå¯¹è±¡ä½œä¸ºASMæ¡†æ¶ç”Ÿæˆå­—èŠ‚ç çš„è¾“å‡ºæµï¼›\né€šè¿‡ClassWriterå®šä¹‰ç±»åå’Œçˆ¶ç±»åç§°ç­‰ç›¸å…³ä¿¡æ¯ï¼Œåˆ›å»ºç±»çš„å®šä¹‰ï¼›\nå®šä¹‰ç±»çš„å­—æ®µã€æ„é€ å‡½æ•°å’Œä»£ç†æ–¹æ³•ç­‰å…ƒç´ ï¼Œè¿™äº›å…ƒç´ å°†ä¼šè¢«ç¼–ç æˆå­—èŠ‚ç ï¼›\nåˆ©ç”¨ASMçš„MethodVisitorç±»è®¿é—®å™¨ç”Ÿæˆæ–¹æ³•çš„å­—èŠ‚ç å®ç°ã€‚MethodVisitoræ˜¯å®šä¹‰åœ¨ASMæ¡†æ¶ä¸­çš„ä¸€ä¸ªè®¿é—®ç±»ï¼Œç”¨äºå¯ä»¥éšæ—¶æä¾›å…³äºæ–¹æ³•çš„ä¿¡æ¯ï¼›\nç”Ÿæˆå­—èŠ‚ç å¹¶å°†å…¶å†™å…¥è¾“å‡ºæµï¼›\n\nç¤ºä¾‹è½¬è½½è‡ªé»‘é©¬package com.itheima;\n\nimport org.springframework.asm.*;\n\npublic class $Proxy0Dump implements Opcodes &#123;\n\n    public static byte[] dump() throws Exception &#123;\n\n        ClassWriter cw = new ClassWriter(0);\n        FieldVisitor fv;\n        MethodVisitor mv;\n        AnnotationVisitor av0;\n\n        cw.visit(52, ACC_PUBLIC + ACC_SUPER, \"com/itheima/$Proxy0\", null, \"java/lang/reflect/Proxy\", new String[]&#123;\"com/itheima/Foo\"&#125;);\n\n        cw.visitSource(\"$Proxy0.java\", null);\n\n        &#123;\n            fv = cw.visitField(ACC_STATIC, \"foo\", \"Ljava/lang/reflect/Method;\", null, null);\n            fv.visitEnd();\n        &#125;\n        &#123;\n            mv = cw.visitMethod(ACC_PUBLIC, \"&lt;init>\", \"(Ljava/lang/reflect/InvocationHandler;)V\", null, null);\n            mv.visitCode();\n            Label l0 = new Label();\n            mv.visitLabel(l0);\n            mv.visitLineNumber(11, l0);\n            mv.visitVarInsn(ALOAD, 0);\n            mv.visitVarInsn(ALOAD, 1);\n            mv.visitMethodInsn(INVOKESPECIAL, \"java/lang/reflect/Proxy\", \"&lt;init>\", \"(Ljava/lang/reflect/InvocationHandler;)V\", false);\n            Label l1 = new Label();\n            mv.visitLabel(l1);\n            mv.visitLineNumber(12, l1);\n            mv.visitInsn(RETURN);\n            Label l2 = new Label();\n            mv.visitLabel(l2);\n            mv.visitLocalVariable(\"this\", \"Lcom/itheima/$Proxy0;\", null, l0, l2, 0);\n            mv.visitLocalVariable(\"h\", \"Ljava/lang/reflect/InvocationHandler;\", null, l0, l2, 1);\n            mv.visitMaxs(2, 2);\n            mv.visitEnd();\n        &#125;\n        &#123;\n            mv = cw.visitMethod(ACC_PUBLIC, \"foo\", \"()V\", null, null);\n            mv.visitCode();\n            Label l0 = new Label();\n            Label l1 = new Label();\n            Label l2 = new Label();\n            mv.visitTryCatchBlock(l0, l1, l2, \"java/lang/Throwable\");\n            mv.visitLabel(l0);\n            mv.visitLineNumber(17, l0);\n            mv.visitVarInsn(ALOAD, 0);\n            mv.visitFieldInsn(GETFIELD, \"com/itheima/$Proxy0\", \"h\", \"Ljava/lang/reflect/InvocationHandler;\");\n            mv.visitVarInsn(ALOAD, 0);\n            mv.visitFieldInsn(GETSTATIC, \"com/itheima/$Proxy0\", \"foo\", \"Ljava/lang/reflect/Method;\");\n            mv.visitInsn(ACONST_NULL);\n            mv.visitMethodInsn(INVOKEINTERFACE, \"java/lang/reflect/InvocationHandler\", \"invoke\", \"(Ljava/lang/Object;Ljava/lang/reflect/Method;[Ljava/lang/Object;)Ljava/lang/Object;\", true);\n            mv.visitInsn(POP);\n            mv.visitLabel(l1);\n            mv.visitLineNumber(20, l1);\n            Label l3 = new Label();\n            mv.visitJumpInsn(GOTO, l3);\n            mv.visitLabel(l2);\n            mv.visitLineNumber(18, l2);\n            mv.visitFrame(Opcodes.F_SAME1, 0, null, 1, new Object[]&#123;\"java/lang/Throwable\"&#125;);\n            mv.visitVarInsn(ASTORE, 1);\n            Label l4 = new Label();\n            mv.visitLabel(l4);\n            mv.visitLineNumber(19, l4);\n            mv.visitTypeInsn(NEW, \"java/lang/reflect/UndeclaredThrowableException\");\n            mv.visitInsn(DUP);\n            mv.visitVarInsn(ALOAD, 1);\n            mv.visitMethodInsn(INVOKESPECIAL, \"java/lang/reflect/UndeclaredThrowableException\", \"&lt;init>\", \"(Ljava/lang/Throwable;)V\", false);\n            mv.visitInsn(ATHROW);\n            mv.visitLabel(l3);\n            mv.visitLineNumber(21, l3);\n            mv.visitFrame(Opcodes.F_SAME, 0, null, 0, null);\n            mv.visitInsn(RETURN);\n            Label l5 = new Label();\n            mv.visitLabel(l5);\n            mv.visitLocalVariable(\"e\", \"Ljava/lang/Throwable;\", null, l4, l3, 1);\n            mv.visitLocalVariable(\"this\", \"Lcom/itheima/$Proxy0;\", null, l0, l5, 0);\n            mv.visitMaxs(4, 2);\n            mv.visitEnd();\n        &#125;\n        &#123;\n            mv = cw.visitMethod(ACC_STATIC, \"&lt;clinit>\", \"()V\", null, null);\n            mv.visitCode();\n            Label l0 = new Label();\n            Label l1 = new Label();\n            Label l2 = new Label();\n            mv.visitTryCatchBlock(l0, l1, l2, \"java/lang/NoSuchMethodException\");\n            mv.visitLabel(l0);\n            mv.visitLineNumber(26, l0);\n            mv.visitLdcInsn(Type.getType(\"Lcom/itheima/Foo;\"));\n            mv.visitLdcInsn(\"foo\");\n            mv.visitInsn(ICONST_0);\n            mv.visitTypeInsn(ANEWARRAY, \"java/lang/Class\");\n            mv.visitMethodInsn(INVOKEVIRTUAL, \"java/lang/Class\", \"getMethod\", \"(Ljava/lang/String;[Ljava/lang/Class;)Ljava/lang/reflect/Method;\", false);\n            mv.visitFieldInsn(PUTSTATIC, \"com/itheima/$Proxy0\", \"foo\", \"Ljava/lang/reflect/Method;\");\n            mv.visitLabel(l1);\n            mv.visitLineNumber(29, l1);\n            Label l3 = new Label();\n            mv.visitJumpInsn(GOTO, l3);\n            mv.visitLabel(l2);\n            mv.visitLineNumber(27, l2);\n            mv.visitFrame(Opcodes.F_SAME1, 0, null, 1, new Object[]&#123;\"java/lang/NoSuchMethodException\"&#125;);\n            mv.visitVarInsn(ASTORE, 0);\n            Label l4 = new Label();\n            mv.visitLabel(l4);\n            mv.visitLineNumber(28, l4);\n            mv.visitTypeInsn(NEW, \"java/lang/NoSuchMethodError\");\n            mv.visitInsn(DUP);\n            mv.visitVarInsn(ALOAD, 0);\n            mv.visitMethodInsn(INVOKEVIRTUAL, \"java/lang/NoSuchMethodException\", \"getMessage\", \"()Ljava/lang/String;\", false);\n            mv.visitMethodInsn(INVOKESPECIAL, \"java/lang/NoSuchMethodError\", \"&lt;init>\", \"(Ljava/lang/String;)V\", false);\n            mv.visitInsn(ATHROW);\n            mv.visitLabel(l3);\n            mv.visitLineNumber(30, l3);\n            mv.visitFrame(Opcodes.F_SAME, 0, null, 0, null);\n            mv.visitInsn(RETURN);\n            mv.visitLocalVariable(\"e\", \"Ljava/lang/NoSuchMethodException;\", null, l4, l3, 0);\n            mv.visitMaxs(3, 1);\n            mv.visitEnd();\n        &#125;\n        cw.visitEnd();\n\n        return cw.toByteArray();\n    &#125;\n&#125;\n\né€šè¿‡è°ƒç”¨ ä»£ç†ç±»çš„$Proxy0Dump.dump()è·å–å­—èŠ‚æ•°ç»„ï¼Œç”¨æ¥çš„åŠ è½½å™¨åŠ è½½å­—èŠ‚æ•°ç»„\npublic class TestProxy &#123;\n    public static void main(String[] args) throws Exception &#123;\n        byte[] dump = $Proxy0Dump.dump();\n\n        /*FileOutputStream os = new FileOutputStream(\"$Proxy0.class\");\n        os.write(dump, 0, dump.length);\n        os.close();*/\n\n        ClassLoader loader = new ClassLoader() &#123;\n            @Override\n            protected Class&lt;?> findClass(String name) throws ClassNotFoundException &#123;\n                return super.defineClass(name, dump, 0, dump.length);\n            &#125;\n        &#125;;\n        Class&lt;?> proxyClass = loader.loadClass(\"com.itheima.$Proxy0\");\n\n        Constructor&lt;?> constructor = proxyClass.getConstructor(InvocationHandler.class);\n        Foo proxy = (Foo) constructor.newInstance(new InvocationHandler() &#123;\n            @Override\n            public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;\n                System.out.println(\"before...\");\n                System.out.println(\"è°ƒç”¨ç›®æ ‡\");\n                return null;\n            &#125;\n        &#125;);\n\n        proxy.foo();\n    &#125;\n&#125;\n\n\njdkåå°„æ–¹æ³•çš„ä¼˜åŒ–import java.lang.reflect.Field;\nimport java.lang.reflect.Method;\n\n// è¿è¡Œæ—¶è¯·æ·»åŠ  --add-opens java.base/java.lang.reflect=ALL-UNNAMED --add-opens java.base/jdk.internal.reflect=ALL-UNNAMED\npublic class TestMethodInvoke &#123;\n    public static void main(String[] args) throws Exception &#123;\n        Method foo = TestMethodInvoke.class.getMethod(\"foo\", int.class);\n        for (int i = 1; i &lt;= 17; i++) &#123;\n            show(i, foo);\n            foo.invoke(null, i);\n        &#125;\n        System.in.read();\n    &#125;\n\n    // æ–¹æ³•åå°„è°ƒç”¨æ—¶, åº•å±‚ MethodAccessor çš„å®ç°ç±»\n    private static void show(int i, Method foo) throws Exception &#123;\n        Method getMethodAccessor = Method.class.getDeclaredMethod(\"getMethodAccessor\");\n        getMethodAccessor.setAccessible(true);\n        Object invoke = getMethodAccessor.invoke(foo);\n        if (invoke == null) &#123;\n            System.out.println(i + \":\" + null);\n            return;\n        &#125;\n        Field delegate = Class.forName(\"jdk.internal.reflect.DelegatingMethodAccessorImpl\").getDeclaredField(\"delegate\");\n        delegate.setAccessible(true);\n        System.out.println(i + \":\" + delegate.get(invoke));\n    &#125;\n\n    public static void foo(int i) &#123;\n        System.out.println(i + \":\" + \"foo\");\n    &#125;\n&#125;\n\n\n\nå‰ 16 æ¬¡åå°„æ€§èƒ½è¾ƒä½ï¼Œæ˜¯åŸºäºJavaçš„MethodAccessorè°ƒç”¨çš„\n\nç¬¬ 17 æ¬¡è°ƒç”¨ä¼šç”Ÿæˆä»£ç†ç±»ï¼Œä¼˜åŒ–ä¸ºéåå°„è°ƒç”¨\n\n\næ¨¡æ‹Ÿ CGlibä»£ç†å’Œ jdk åŠ¨æ€ä»£ç†åŸç†æŸ¥ä¸å¤š\n\nå›è°ƒçš„æ¥å£æ¢äº†ä¸€ä¸‹ï¼ŒInvocationHandler æ”¹æˆäº† MethodInterceptor\n\nè°ƒç”¨ç›®æ ‡æ—¶æœ‰æ‰€æ”¹è¿›ï¼Œè§ä¸‹é¢ä»£ç ç‰‡æ®µ\n\nmethod.invoke æ˜¯åå°„è°ƒç”¨ï¼Œå¿…é¡»è°ƒç”¨åˆ°è¶³å¤Ÿæ¬¡æ•°æ‰ä¼šè¿›è¡Œä¼˜åŒ–\n\nmethodProxy.invoke æ˜¯ä¸åå°„è°ƒç”¨ï¼Œå®ƒä¼šæ­£å¸¸ï¼ˆé—´æ¥ï¼‰è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ï¼ˆSpring é‡‡ç”¨ï¼‰\n\nmethodProxy.invokeSuper ä¹Ÿæ˜¯ä¸åå°„è°ƒç”¨ï¼Œå®ƒä¼šæ­£å¸¸ï¼ˆé—´æ¥ï¼‰è°ƒç”¨ä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œå¯ä»¥çœç•¥ç›®æ ‡å¯¹è±¡\n\n\n\n\n//ä»£ç†å¯¹è±¡\npublic class Proxy extends Target &#123;\n    private MethodInterceptor methodInterceptor;\n\n    public void setMethodInterceptor(MethodInterceptor methodInterceptor) &#123;\n        this.methodInterceptor = methodInterceptor;\n    &#125;\n\n    static Method save0;\n    static Method save1;\n    static Method save2;\n    static MethodProxy save0Proxy;\n    static MethodProxy save1Proxy;\n    static MethodProxy save2Proxy;\n    static &#123;\n        try &#123;\n            save0 = Target.class.getMethod(\"save\");\n            save1 = Target.class.getMethod(\"save\", int.class);\n            save2 = Target.class.getMethod(\"save\", long.class);\n            save0Proxy = MethodProxy.create(Target.class, Proxy.class, \"()V\", \"save\", \"saveSuper\");\n            save1Proxy = MethodProxy.create(Target.class, Proxy.class, \"(I)V\", \"save\", \"saveSuper\");\n            save2Proxy = MethodProxy.create(Target.class, Proxy.class, \"(J)V\", \"save\", \"saveSuper\");\n        &#125; catch (NoSuchMethodException e) &#123;\n            throw new NoSuchMethodError(e.getMessage());\n        &#125;\n    &#125;\n\n    // >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> å¸¦åŸå§‹åŠŸèƒ½çš„æ–¹æ³•\n    public void saveSuper() &#123;\n        super.save();\n    &#125;\n    public void saveSuper(int i) &#123;\n        super.save(i);\n    &#125;\n    public void saveSuper(long j) &#123;\n        super.save(j);\n    &#125;\n    // >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> å¸¦å¢å¼ºåŠŸèƒ½çš„æ–¹æ³•\n    @Override\n    public void save() &#123;\n        try &#123;\n            methodInterceptor.intercept(this, save0, new Object[0], save0Proxy);\n        &#125; catch (Throwable e) &#123;\n            throw new UndeclaredThrowableException(e);\n        &#125;\n    &#125;\n\n    @Override\n    public void save(int i) &#123;\n        try &#123;\n            methodInterceptor.intercept(this, save1, new Object[]&#123;i&#125;, save1Proxy);\n        &#125; catch (Throwable e) &#123;\n            throw new UndeclaredThrowableException(e);\n        &#125;\n    &#125;\n\n    @Override\n    public void save(long j) &#123;\n        try &#123;\n            methodInterceptor.intercept(this, save2, new Object[]&#123;j&#125;, save2Proxy);\n        &#125; catch (Throwable e) &#123;\n            throw new UndeclaredThrowableException(e);\n        &#125;\n    &#125;\n&#125;\n\n//ç›®æ ‡å¯¹è±¡\npublic class Target &#123;\n    public void save() &#123;\n        System.out.println(\"save()\");\n    &#125;\n\n    public void save(int i) &#123;\n        System.out.println(\"save(int)\");\n    &#125;\n\n    public void save(long j) &#123;\n        System.out.println(\"save(long)\");\n    &#125;\n&#125;\n\npublic class A13 &#123;\n\n    public static void main(String[] args) &#123;\n        Proxy proxy = new Proxy();\n        Target target = new Target();\n        proxy.setMethodInterceptor(new MethodInterceptor() &#123;\n            @Override\n            public Object intercept(Object p, Method method, Object[] args,\n                                    MethodProxy methodProxy) throws Throwable &#123;\n                System.out.println(\"before...\");\n//                return method.invoke(target, args); // åå°„è°ƒç”¨\n                // FastClass\n//                return methodProxy.invoke(target, args); // å†…éƒ¨æ— åå°„, ç»“åˆç›®æ ‡ç”¨\n                return methodProxy.invokeSuper(p, args); // å†…éƒ¨æ— åå°„, ç»“åˆä»£ç†ç”¨\n            &#125;\n        &#125;);\n\n        proxy.save();\n        proxy.save(1);\n        proxy.save(2L);\n    &#125;\n&#125;\n\nMethodProxy çš„ invoke æˆ– invokeSuper æ–¹æ³•æ—¶å¦‚ä½•é¿å…åå°„çš„è°ƒç”¨\nimport org.springframework.cglib.core.Signature;\n\npublic class ProxyFastClass &#123;\n    static Signature s0 = new Signature(\"saveSuper\", \"()V\");\n    static Signature s1 = new Signature(\"saveSuper\", \"(I)V\");\n    static Signature s2 = new Signature(\"saveSuper\", \"(J)V\");\n\n    // è·å–ä»£ç†æ–¹æ³•çš„ç¼–å·\n    /*\n        Proxy\n            saveSuper()              0\n            saveSuper(int)           1\n            saveSuper(long)          2\n        signature åŒ…æ‹¬æ–¹æ³•åå­—ã€å‚æ•°è¿”å›å€¼\n     */\n    public int getIndex(Signature signature) &#123;\n        if (s0.equals(signature)) &#123;\n            return 0;\n        &#125; else if (s1.equals(signature)) &#123;\n            return 1;\n        &#125; else if (s2.equals(signature)) &#123;\n            return 2;\n        &#125;\n        return -1;\n    &#125;\n\n    // æ ¹æ®æ–¹æ³•ç¼–å·, æ­£å¸¸è°ƒç”¨ç›®æ ‡å¯¹è±¡æ–¹æ³•\n    public Object invoke(int index, Object proxy, Object[] args) &#123;\n        if (index == 0) &#123;\n            ((Proxy) proxy).saveSuper();\n            return null;\n        &#125; else if (index == 1) &#123;\n            ((Proxy) proxy).saveSuper((int) args[0]);\n            return null;\n        &#125; else if (index == 2) &#123;\n            ((Proxy) proxy).saveSuper((long) args[0]);\n            return null;\n        &#125; else &#123;\n            throw new RuntimeException(\"æ— æ­¤æ–¹æ³•\");\n        &#125;\n    &#125;\n\n    public static void main(String[] args) &#123;\n        ProxyFastClass fastClass = new ProxyFastClass();\n        int index = fastClass.getIndex(new Signature(\"saveSuper\", \"()V\"));\n        System.out.println(index);\n\n        fastClass.invoke(index, new Proxy(), new Object[0]);\n    &#125;\n&#125;\n\n\nimport org.springframework.cglib.core.Signature;\n\npublic class TargetFastClass &#123;\n    static Signature s0 = new Signature(\"save\", \"()V\");\n    static Signature s1 = new Signature(\"save\", \"(I)V\");\n    static Signature s2 = new Signature(\"save\", \"(J)V\");\n\n    // è·å–ç›®æ ‡æ–¹æ³•çš„ç¼–å·\n    /*\n        Target\n            save()              0\n            save(int)           1\n            save(long)          2\n        signature åŒ…æ‹¬æ–¹æ³•åå­—ã€å‚æ•°è¿”å›å€¼\n     */\n    public int getIndex(Signature signature) &#123;\n        if (s0.equals(signature)) &#123;\n            return 0;\n        &#125; else if (s1.equals(signature)) &#123;\n            return 1;\n        &#125; else if (s2.equals(signature)) &#123;\n            return 2;\n        &#125;\n        return -1;\n    &#125;\n\n    // æ ¹æ®æ–¹æ³•ç¼–å·, æ­£å¸¸è°ƒç”¨ç›®æ ‡å¯¹è±¡æ–¹æ³•\n    public Object invoke(int index, Object target, Object[] args) &#123;\n        if (index == 0) &#123;\n            ((Target) target).save();\n            return null;\n        &#125; else if (index == 1) &#123;\n            ((Target) target).save((int) args[0]);\n            return null;\n        &#125; else if (index == 2) &#123;\n            ((Target) target).save((long) args[0]);\n            return null;\n        &#125; else &#123;\n            throw new RuntimeException(\"æ— æ­¤æ–¹æ³•\");\n        &#125;\n    &#125;\n\n    public static void main(String[] args) &#123;\n        TargetFastClass fastClass = new TargetFastClass();\n        int index = fastClass.getIndex(new Signature(\"save\", \"(I)V\"));\n        System.out.println(index);\n        fastClass.invoke(index, new Target(), new Object[]&#123;100&#125;);\n    &#125;\n&#125;\n\n\nå½“è°ƒç”¨ MethodProxy çš„ invoke æˆ– invokeSuper æ–¹æ³•æ—¶, ä¼šåŠ¨æ€ç”Ÿæˆä¸¤ä¸ªç±»\nProxyFastClass é…åˆä»£ç†å¯¹è±¡ä¸€èµ·ä½¿ç”¨, é¿å…åå°„\nTargetFastClass é…åˆç›®æ ‡å¯¹è±¡ä¸€èµ·ä½¿ç”¨, é¿å…åå°„ (Spring ç”¨çš„è¿™ç§)\n\n\nTargetFastClass è®°å½•äº† Target ä¸­æ–¹æ³•ä¸ç¼–å·çš„å¯¹åº”å…³ç³»\nsave(long) ç¼–å· 2\nsave(int) ç¼–å· 1\nsave() ç¼–å· 0\né¦–å…ˆæ ¹æ®æ–¹æ³•åå’Œå‚æ•°ä¸ªæ•°ã€ç±»å‹, ç”¨ switch å’Œ if æ‰¾åˆ°è¿™äº›æ–¹æ³•ç¼–å·\nç„¶åå†æ ¹æ®ç¼–å·å»è°ƒç”¨ç›®æ ‡æ–¹æ³•, åˆç”¨äº†ä¸€å¤§å † switch å’Œ if, ä½†é¿å…äº†åå°„\n\n\nProxyFastClass è®°å½•äº† Proxy ä¸­æ–¹æ³•ä¸ç¼–å·çš„å¯¹åº”å…³ç³»ï¼Œä¸è¿‡ Proxy é¢å¤–æä¾›äº†ä¸‹é¢å‡ ä¸ªæ–¹æ³•\nsaveSuper(long) ç¼–å· 2ï¼Œä¸å¢å¼ºï¼Œä»…æ˜¯è°ƒç”¨ super.save(long)\nsaveSuper(int) ç¼–å· 1ï¼Œä¸å¢å¼º, ä»…æ˜¯è°ƒç”¨ super.save(int)\nsaveSuper() ç¼–å· 0ï¼Œä¸å¢å¼º, ä»…æ˜¯è°ƒç”¨ super.save()\næŸ¥æ‰¾æ–¹å¼ä¸ TargetFastClass ç±»ä¼¼\n\n\nä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆéº»çƒ¦çš„ä¸€å¥—ä¸œè¥¿å‘¢ï¼Ÿ\né¿å…åå°„, æé«˜æ€§èƒ½, ä»£ä»·æ˜¯ä¸€ä¸ªä»£ç†ç±»é…ä¸¤ä¸ª FastClass ç±», ä»£ç†ç±»ä¸­è¿˜å¾—å¢åŠ ä»…è°ƒç”¨ super çš„ä¸€å †æ–¹æ³•\nç”¨ç¼–å·å¤„ç†æ–¹æ³•å¯¹åº”å…³ç³»æ¯”è¾ƒçœå†…å­˜, å¦å¤–, æœ€åˆè·å¾—æ–¹æ³•é¡ºåºæ˜¯ä¸ç¡®å®šçš„, è¿™ä¸ªè¿‡ç¨‹æ²¡æ³•å›ºå®šæ­»\n\n\n\njdkåŠ¨æ€ä»£ç†å’Œcglibçš„å¯¹æ¯”\n\njdkä¸æ˜¯ä¸€ä¸Šæ¥å°±ä¼˜åŒ–ï¼Œå…ˆè¦è°ƒç”¨16æ¬¡ï¼Œç¬¬17æ¬¡æ‰ä¼šé’ˆå¯¹ä¸€ä¸ªæ–¹æ³•äº§ç”Ÿä¸€ä¸ªä»£ç†ç±» ï¼Œåé¢çš„è°ƒç”¨éƒ½æ— éœ€åå°„\n\ncglibæ˜¯ä¸€å¼€å§‹å°±äº§ç”Ÿä»£ç†ï¼Œä¸€ä¸ªä»£ç†ç±»å¯¹åº”ä¸¤ä¸ªfastclass,ä¸€ä¸ªé…åˆä»£ç†å¯¹è±¡ä½¿ç”¨ï¼Œå¦ä¸€ä¸ªé…åˆç›®æ ‡æœ¬èº«ï¼Œæ¯ä¸ªfastclassåŒ¹é…åˆ°å¤šä¸ªæ–¹æ³•ï¼Œæ‰€æœ‰äº§ç”Ÿçš„ä»£ç†ç±»çš„æ•°ç›®ç›¸å¯¹jdkä»£ç†è¦å°‘\n\n\n&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;jdk å’Œ cglib åœ¨ Spring ä¸­çš„ç»Ÿä¸€&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;\n","slug":"AOPå®ç°ä¹‹proxy","date":"2023-05-10T08:38:34.603Z","categories_index":"","tags_index":"","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"d7e2802c58918040c31b14740192f666","title":"AOPå®ç°ä¹‹agentç±»åŠ è½½","content":"AOPå®ç°ä¹‹agentç±»åŠ è½½","slug":"AOPå®ç°ä¹‹agentç±»åŠ è½½","date":"2023-05-10T08:32:18.000Z","categories_index":"","tags_index":"Java,Spring,AOP","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"594a23198fd2599edc1d35598ede3148","title":"æ¨¡æ¿æ–¹æ³•çš„è®¾è®¡æ¨¡å¼","content":"æ¨¡æ¿æ–¹æ³•çš„è®¾è®¡æ¨¡å¼å®ƒå®šä¹‰äº†ä¸€ä¸ªç®—æ³•çš„éª¨æ¶ï¼Œå…è®¸å­ç±»åœ¨ä¸æ”¹å˜ç®—æ³•ç»“æ„çš„æƒ…å†µä¸‹é‡æ–°å®šä¹‰ç®—æ³•çš„æŸäº›æ­¥éª¤ã€‚\næ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼çš„ä¼˜ç‚¹\n\nå°†ç®—æ³•çš„å®ç°ç»†èŠ‚å’Œç®—æ³•æœ¬èº«åˆ†ç¦»å¼€ï¼Œä½¿å¾—ç®—æ³•çš„å˜åŒ–ä¸ä¼šå½±å“åˆ°ç®—æ³•çš„å®¢æˆ·ç«¯ï¼Œåªéœ€è¦ä¿®æ”¹ç®—æ³•çš„å…·ä½“å®ç°å³å¯ã€‚\né€šè¿‡æŠŠé€šç”¨æ–¹æ³•æå–åˆ°æŠ½è±¡ç±»ä¸­ï¼Œé¿å…äº†é‡å¤ä»£ç çš„å‡ºç°ï¼Œæé«˜äº†ä»£ç çš„å¯é‡ç”¨æ€§ã€‚\næé«˜äº†ä»£ç çš„å¯æ‰©å±•æ€§ï¼Œå¯ä»¥åœ¨ä¸ä¿®æ”¹ç®—æ³•éª¨æ¶ç»“æ„çš„æƒ…å†µä¸‹æ›¿æ¢éƒ¨åˆ†å†…å®¹ã€‚\nä½¿å¾—ç®—æ³•çš„å®ç°æ›´åŠ çµæ´»ï¼Œå…è®¸ä¸åŒå­ç±»å®ç°ç®—æ³•éª¨æ¶çš„ä¸åŒéƒ¨åˆ†ã€‚\n\næ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼çš„ç¼ºç‚¹\n\nç”±äºå°†ç®—æ³•ç»†èŠ‚åˆ†ç¦»å¼€ï¼Œä»£ç çš„éš¾åº¦å¯èƒ½ä¼šå¢åŠ ï¼Œè¿™ä¼šå¯¼è‡´ä»£ç çš„ç»´æŠ¤æˆæœ¬å¢åŠ ã€‚\nå­ç±»å¯¹çˆ¶ç±»çš„ä¾èµ–æ€§è¾ƒé«˜ï¼Œä½¿å¾—ç»§æ‰¿çš„æ»¥ç”¨å¯èƒ½ä¼šå¯¼è‡´ä»£ç çš„å¤æ‚æ€§å’Œä¸å¯è¯»æ€§å¢åŠ ã€‚\nå¦‚æœç®—æ³•éª¨æ¶çš„ä¿®æ”¹è¾ƒå¤šï¼Œå¯èƒ½ä¼šå¯¼è‡´å¤§é‡çš„ç±»éƒ½éœ€è¦è¿›è¡Œè°ƒæ•´ï¼Œè¿™ä¼šå¸¦æ¥ä¸€å®šçš„å¼€é”€ã€‚\n\nç¤ºä¾‹é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªæŠ½è±¡æ¨¡æ¿ç±»ï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ªç®—æ³•çš„éª¨æ¶ï¼Œå¹¶åŒ…å«ä¸€äº›æŠ½è±¡æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å°†åœ¨å­ç±»ä¸­å®ç°ã€‚\npublic abstract class AlgorithmTemplate &#123;\n    public void executeAlgorithm() &#123;\n        initialize();\n        process();\n        finalize();\n    &#125;\n\n    protected abstract void initialize();\n\n    protected abstract void process();\n\n    protected abstract void finalize();\n&#125;\n\nç„¶åï¼Œåˆ›å»ºå‡ ä¸ªç»§æ‰¿è‡ªæŠ½è±¡æ¨¡æ¿ç±»çš„å…·ä½“å­ç±»ï¼Œå¹¶å®ç°æŠ½è±¡æ–¹æ³•ã€‚\npublic class ConcreteAlgorithmA extends AlgorithmTemplate &#123;\n    protected void initialize() &#123;\n        System.out.println(&quot;ConcreteAlgorithmA: Initializing...&quot;);\n    &#125;\n\n    protected void process() &#123;\n        System.out.println(&quot;ConcreteAlgorithmA: Processing...&quot;);\n    &#125;\n\n    protected void finalize() &#123;\n        System.out.println(&quot;ConcreteAlgorithmA: Finalizing...&quot;);\n    &#125;\n&#125;\n\npublic class ConcreteAlgorithmB extends AlgorithmTemplate &#123;\n    protected void initialize() &#123;\n        System.out.println(&quot;ConcreteAlgorithmB: Initializing...&quot;);\n    &#125;\n\n    protected void process() &#123;\n        System.out.println(&quot;ConcreteAlgorithmB: Processing...&quot;);\n    &#125;\n\n    protected void finalize() &#123;\n        System.out.println(&quot;ConcreteAlgorithmB: Finalizing...&quot;);\n    &#125;\n&#125;\n\næœ€åï¼Œåœ¨ä¸»ç¨‹åºä¸­ä½¿ç”¨è¿™äº›å­ç±»æ¥æ¼”ç¤ºæ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼ã€‚\npublic class Main &#123;\n    public static void main(String[] args) &#123;\n        AlgorithmTemplate algorithmA = new ConcreteAlgorithmA();\n        AlgorithmTemplate algorithmB = new ConcreteAlgorithmB();\n\n        algorithmA.executeAlgorithm();\n        algorithmB.executeAlgorithm();\n    &#125;\n&#125;\n\nå½“æ‰§è¡Œè¯¥ç¨‹åºæ—¶ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š\nConcreteAlgorithmA: Initializing...\nConcreteAlgorithmA: Processing...\nConcreteAlgorithmA: Finalizing...\nConcreteAlgorithmB: Initializing...\nConcreteAlgorithmB: Processing...\nConcreteAlgorithmB: Finalizing...\n\nå¯ä»¥çœ‹å‡ºï¼Œå¤šä¸ªå…·ä½“å­ç±»éƒ½é€šè¿‡ç»§æ‰¿æŠ½è±¡æ¨¡æ¿ç±»æ¥å®ç°ç›¸åŒçš„ç®—æ³•éª¨æ¶ã€‚è¿™ä½¿å¾—æ›´æ”¹ç®—æ³•éª¨æ¶å˜å¾—æ›´åŠ å®¹æ˜“ï¼Œå¹¶ä¸”å¯ä»¥é¿å…é‡å¤ç¼–å†™ç›¸ä¼¼çš„ç®—æ³•ä»£ç ã€‚\n","slug":"æ¨¡æ¿æ–¹æ³•æ¨¡å¼","date":"2023-05-09T13:53:44.000Z","categories_index":"","tags_index":"Java,è®¾è®¡æ¨¡å¼","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"8ced7c3b7dad33d06ee59bde7028cd4a","title":"ç­–ç•¥æ¨¡å¼","content":"ç­–ç•¥æ¨¡å¼å®ƒå…è®¸åœ¨è¿è¡Œæ—¶æ ¹æ®ä¸åŒçš„æƒ…å†µé€‰æ‹©ç®—æ³•çš„è¡Œä¸ºæ–¹å¼ã€‚\nåœ¨ç­–ç•¥æ¨¡å¼ä¸­ï¼Œæœ‰å¤šä¸ªç®—æ³•å¯ä»¥å®ŒæˆåŒä¸€é¡¹ä»»åŠ¡ã€‚åœ¨ä½¿ç”¨ç­–ç•¥æ¨¡å¼æ—¶ï¼Œæˆ‘ä»¬å°†æ¯ä¸ªç®—æ³•éƒ½å°è£…åœ¨ä¸€ä¸ªç‹¬ç«‹çš„ç±»ä¸­ï¼Œè¿™äº›ç±»éƒ½å®ç°äº†ä¸€ä¸ªå…±åŒçš„æ¥å£ã€‚ç„¶åï¼Œåœ¨è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©åˆé€‚çš„ç®—æ³•æ¥å®Œæˆä»»åŠ¡ã€‚\nä¼˜ç‚¹\n\nå°è£…äº†ä¸€ç³»åˆ—ç®—æ³•ï¼šå°†ä¸€ç³»åˆ—ç®—æ³•å°è£…åœ¨ä¸åŒçš„ç­–ç•¥ç±»ä¸­ï¼Œä½¿å¾—è¿™äº›ç®—æ³•å¯ä»¥äº’ç›¸æ›¿æ¢è€Œä¸å½±å“å®¢æˆ·ç«¯ä½¿ç”¨ã€‚\nå¯ä»¥åŠ¨æ€åˆ‡æ¢ç®—æ³•ï¼šå®¢æˆ·ç«¯å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€é€‰æ‹©ä½¿ç”¨å“ªä¸ªç®—æ³•ï¼Œå®ç°äº†ç®—æ³•çš„åŠ¨æ€åˆ‡æ¢ã€‚\nå‡å°‘äº†å¤æ‚çš„æ¡ä»¶è¯­å¥ï¼šåœ¨ä¸ä½¿ç”¨ç­–ç•¥æ¨¡å¼æ—¶ï¼Œå¸¸å¸¸éœ€è¦ä½¿ç”¨å¤§é‡çš„æ¡ä»¶è¯­å¥æ¥å®ç°ä¸åŒçš„ç®—æ³•ï¼Œè¿™æ ·ä¼šä½¿ä»£ç å˜å¾—å¤æ‚è€Œéš¾ä»¥ç»´æŠ¤ï¼Œç­–ç•¥æ¨¡å¼å¯ä»¥é¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿã€‚\næé«˜äº†ä»£ç çš„å¯å¤ç”¨æ€§ï¼šä¸åŒçš„ç­–ç•¥ç±»å¯ä»¥è¢«å¤šä¸ªå®¢æˆ·ç«¯ä½¿ç”¨ï¼Œæé«˜äº†ä»£ç çš„é‡ç”¨æ€§å’Œå¯æ‰©å±•æ€§ã€‚\n\nç¼ºç‚¹\n\nå¢åŠ äº†ç±»çš„æ•°é‡ï¼šæ¯ä¸ªç®—æ³•éƒ½éœ€è¦ä¸€ä¸ªå¯¹åº”çš„ç­–ç•¥ç±»ï¼Œè¿™æ ·å°±ä¼šå¢åŠ ç±»çš„æ•°é‡ï¼Œä½¿ä»£ç æ›´åŠ å¤æ‚ï¼Œå› æ­¤éœ€è¦é€‚å½“è€ƒè™‘å…¶ä½¿ç”¨æƒ…å†µã€‚\nå®¢æˆ·ç«¯å¿…é¡»äº†è§£ä¸åŒçš„ç­–ç•¥ç±»ï¼šå®¢æˆ·ç«¯å¿…é¡»çŸ¥é“æ‰€æœ‰å¯ç”¨çš„ç­–ç•¥ç±»ï¼Œå¹¶ä¸”è‡ªå·±å†³å®šå“ªä¸€ä¸ªç­–ç•¥ç±»æœ€é€‚åˆè§£å†³å½“å‰çš„é—®é¢˜ï¼Œè¿™å°†å¢åŠ å®¢æˆ·ç«¯çš„å›°éš¾ã€‚\nç­–ç•¥æ¨¡å¼æ— æ³•å®Œå…¨è§£å†³å¤æ‚çš„é—®é¢˜ï¼šè™½ç„¶ç­–ç•¥æ¨¡å¼å¯ä»¥å¾ˆå¥½åœ°è§£å†³ç®€å•çš„é—®é¢˜ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦å¤šä¸ªç®—æ³•ä¹‹é—´çš„åè°ƒå’Œå¤„ç†ï¼Œè¿™æ—¶ä½¿ç”¨ç­–ç•¥æ¨¡å¼å°±å¾ˆéš¾å®ç°ã€‚\n\nç¤ºä¾‹//åˆ›å»ºä¸€ä¸ªæ¥å£ï¼Œå®ç°æ‰€æœ‰ç®—æ³•ç±»éƒ½è¦å®ç°çš„æ–¹æ³•\ninterface Operation &#123;\n    double calculate(double a, double b);\n&#125;\n\n//åˆ›å»ºç®—æ³•ç±»å’Œå®ç°Operationæ¥å£\nclass Addition implements Operation &#123;\n    public double calculate(double a, double b) &#123;\n        return a + b;\n    &#125;\n&#125;\n\nclass Subtraction implements Operation &#123;\n    public double calculate(double a, double b) &#123;\n        return a - b;\n    &#125;\n&#125;\n\nclass Multiplication implements Operation &#123;\n    public double calculate(double a, double b) &#123;\n        return a * b;\n    &#125;\n&#125;\n\n//åˆ›å»ºä¸€ä¸ªContextç±»ï¼Œç”¨æ¥è®¾ç½®å®é™…çš„ç­–ç•¥\nclass Calculator &#123;\n    private Operation operation;\n\n    public void setOperation(Operation operation) &#123;\n        this.operation = operation;\n    &#125;\n\n    public double calculate(double a, double b) &#123;\n        return operation.calculate(a, b);\n    &#125;\n&#125;\n\n//ä½¿ç”¨ç¤ºä¾‹\npublic class StrategyExample &#123;\n    public static void main(String[] args) &#123;\n        double a = 1.5;\n        double b = 2.0;\n\n        Calculator calculator = new Calculator();\n\n        //è®¾ç½®åŠ æ³•è¿ç®—ç­–ç•¥\n        calculator.setOperation(new Addition());\n        System.out.println(calculator.calculate(a, b)); //3.5\n\n        //è®¾ç½®å‡æ³•è¿ç®—ç­–ç•¥\n        calculator.setOperation(new Subtraction());\n        System.out.println(calculator.calculate(a, b)); //-0.5\n\n        //è®¾ç½®ä¹˜æ³•è¿ç®—ç­–ç•¥\n        calculator.setOperation(new Multiplication());\n        System.out.println(calculator.calculate(a, b)); //3.0\n    &#125;\n&#125;\n\n","slug":"ç­–ç•¥æ¨¡å¼","date":"2023-05-09T13:20:59.000Z","categories_index":"","tags_index":"Java,è®¾è®¡æ¨¡å¼","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"cd55e9d94b94ab2ca447027ce4beeca6","title":"è§‚å¯Ÿè€…æ¨¡å¼","content":"è§‚å¯Ÿè€…æ¨¡å¼å®ƒå…è®¸ä¸€ä¸ªå¯¹è±¡ï¼ˆç§°ä¸ºè¢«è§‚å¯Ÿè€…æˆ–ä¸»é¢˜ï¼‰ç»´æŠ¤ä¸€ç»„ä¾èµ–äºå®ƒçš„å¯¹è±¡ï¼ˆç§°ä¸ºè§‚å¯Ÿè€…ï¼‰ï¼Œå½“è¢«è§‚å¯Ÿè€…å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒä¼šé€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…ä»¥ä¾¿æ›´æ–°å®ƒä»¬è‡ªå·±çš„çŠ¶æ€ã€‚\nä¼˜ç‚¹ï¼š\n\nåœ¨è§‚å¯Ÿè€…æ¨¡å¼ä¸­ï¼Œè¢«è§‚å¯Ÿè€…å’Œè§‚å¯Ÿè€…ä¹‹é—´æ˜¯æ¾è€¦åˆçš„å…³ç³»ï¼Œä½¿å¾—å®ƒä»¬ä¹‹é—´çš„äº¤äº’å˜å¾—ç®€å•è€Œçµæ´»ã€‚\nè§‚å¯Ÿè€…æ¨¡å¼æ”¯æŒå¹¿æ’­é€šä¿¡ï¼Œå½“ä¸€ä¸ªå¯¹è±¡å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå¤šä¸ªè§‚å¯Ÿè€…ä¼šåŒæ—¶å¾—åˆ°é€šçŸ¥ï¼Œå¯ä»¥åœ¨ä¸åŒçš„å¤„ç†é€»è¾‘å¯¹å…¶è¿›è¡Œå“åº”ï¼Œæé«˜äº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€‚\nè§‚å¯Ÿè€…æ¨¡å¼ç¬¦åˆé¢å‘å¯¹è±¡è®¾è®¡åŸåˆ™ï¼Œå°†ä¸šåŠ¡åˆ†ç¦»ï¼Œä½¿å¾—ä»£ç æ›´æ˜“äºç»´æŠ¤å’Œæ‰©å±•ã€‚\n\nç¼ºç‚¹ï¼š\n\nè§‚å¯Ÿè€…æ¨¡å¼å¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿä¸­çš„è§‚å¯Ÿè€…å¯¹è±¡è¿‡å¤šï¼Œé€ æˆæ€§èƒ½ä¸Šçš„é—®é¢˜ã€‚\nè§‚å¯Ÿè€…æ¨¡å¼éœ€è¦è€ƒè™‘åˆ°å¼€å‘æ•ˆç‡ä¸è¿è¡Œæ•ˆç‡çš„å¹³è¡¡ï¼Œåœ¨ä¸€äº›ç‰¹å®šçš„åœºæ™¯ä¸‹ï¼Œä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼å¹¶ä¸æ˜¯æœ€ä½³å®è·µã€‚\n\nåº”ç”¨åœºæ™¯ï¼š\n\nä¸€ä¸ªå¯¹è±¡çš„æ”¹å˜éœ€è¦åŒæ—¶æ”¹å˜å…¶ä»–å¯¹è±¡çš„æ—¶å€™ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼ã€‚\nå½“ç³»ç»Ÿä¸­å¤šä¸ªå¯¹è±¡ä¹‹é—´å­˜åœ¨ç€ä¸€å¯¹å¤šå…³ç³»ï¼šä¸€ä¸ªå¯¹è±¡çš„æ”¹å˜ä¼šå½±å“åˆ°å…¶ä»–å¯¹è±¡çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼ã€‚\nåœ¨åˆ†å±‚æ¶æ„ä¸­ï¼Œå¯ä»¥ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼æ¥è§£è€¦å„å±‚ä¹‹é—´çš„å…³ç³»ã€‚\nå½“éœ€è¦å°†ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€åŒæ­¥åˆ°å…¶ä»–å¯¹è±¡ä¸­ï¼Œè€Œåˆä¸å¸Œæœ›è€¦åˆå¤ªå¤šä»£ç çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼ã€‚\n\nä¸‹é¢æ˜¯ä¸€ä¸ªJavaä»£ç ç¤ºä¾‹é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªä¸»é¢˜æ¥å£ï¼ˆSubjectï¼‰ï¼Œå®šä¹‰ä¸»é¢˜å¿…é¡»å®ç°çš„æ–¹æ³•ï¼š\npublic interface Subject &#123;\n    void attach(Observer observer);\n    void detach(Observer observer);\n    void notifyObservers(String msg);\n&#125;\n\nå…¶ä¸­ï¼Œattach(Observer)æ–¹æ³•å’Œdetach(Observer)æ–¹æ³•ç”¨äºæ³¨å†Œå’Œæ³¨é”€è§‚å¯Ÿè€…ï¼ŒnotifyObservers(String)æ–¹æ³•ç”¨äºé€šçŸ¥æ‰€æœ‰æ³¨å†Œçš„è§‚å¯Ÿè€…ä¸»é¢˜å‘ç”Ÿäº†å˜åŒ–ã€‚\nç„¶åï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªè§‚å¯Ÿè€…æ¥å£ï¼ˆObserverï¼‰ï¼Œè§‚å¯Ÿè€…å¿…é¡»å®ç°çš„æ–¹æ³•ï¼š\npublic interface Observer &#123;\n    void update(String msg);\n&#125;\n\nå…¶ä¸­ï¼Œupdate(String)æ–¹æ³•ç”¨äºæ¥æ”¶ä¸»é¢˜å‘ç”Ÿå˜åŒ–çš„é€šçŸ¥å¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®ç°Subjectæ¥å£ï¼š\npublic class ConcreteSubject implements Subject &#123;\n    private List&lt;Observer> observers = new ArrayList&lt;>();\n    private String state;\n\n    public void attach(Observer observer) &#123;\n        observers.add(observer);\n    &#125;\n\n    public void detach(Observer observer) &#123;\n        observers.remove(observer);\n    &#125;\n\n    public void notifyObservers(String msg) &#123;\n        for (Observer observer : observers) &#123;\n            observer.update(msg);\n        &#125;\n    &#125;\n\n    public void setState(String state) &#123;\n        this.state = state;\n        notifyObservers(\"State changed to \" + state);\n    &#125;\n&#125;\n\nå…¶ä¸­ï¼Œobserversæ˜¯ç”¨äºå­˜å‚¨æ‰€æœ‰è§‚å¯Ÿè€…å¯¹è±¡çš„åˆ—è¡¨ï¼Œstateæ˜¯ä¸»é¢˜çš„çŠ¶æ€ã€‚\nattach(Observer)æ–¹æ³•å’Œdetach(Observer)æ–¹æ³•ç”¨äºæ·»åŠ å’Œåˆ é™¤è§‚å¯Ÿè€…å¯¹è±¡ï¼ŒnotifyObservers(String)æ–¹æ³•ç”¨äºé€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…ä¸»é¢˜å‘ç”Ÿäº†å˜åŒ–ã€‚åœ¨setState(String)æ–¹æ³•ä¸­ï¼Œæ¯æ¬¡è®¾ç½®ä¸»é¢˜çŠ¶æ€æ—¶éƒ½ä¼šè°ƒç”¨notifyObservers(String)æ–¹æ³•é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…ã€‚\næœ€åï¼Œæˆ‘ä»¬å®ç°Observeræ¥å£ï¼š\npublic class ConcreteObserver implements Observer &#123;\n    private String name;\n\n    public ConcreteObserver(String name) &#123;\n        this.name = name;\n    &#125;\n\n    public void update(String msg) &#123;\n        System.out.println(name + \" received message: \" + msg);\n    &#125;\n&#125;\n\nå…¶ä¸­ï¼Œupdate()æ–¹æ³•ç”¨äºæ¥æ”¶ä¸»é¢˜å‘ç”Ÿå˜åŒ–çš„é€šçŸ¥å¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚\nä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼çš„ç¤ºä¾‹ï¼š\npublic static void main(String[] args) &#123;\n    ConcreteSubject subject = new ConcreteSubject();\n\n    ConcreteObserver observer1 = new ConcreteObserver(\"Observer 1\");\n    ConcreteObserver observer2 = new ConcreteObserver(\"Observer 2\");\n\n    subject.attach(observer1);\n    subject.attach(observer2);\n\n    subject.setState(\"New state\");\n\n    subject.detach(observer1);\n\n    subject.setState(\"Another new state\");\n&#125;\n\nåœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªConcreteSubjectå¯¹è±¡ï¼Œå¹¶åˆ›å»ºäº†ä¸¤ä¸ªConcreteObserverå¯¹è±¡ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†ä¸¤ä¸ªè§‚å¯Ÿè€…å¯¹è±¡æ³¨å†Œåˆ°ä¸»é¢˜å¯¹è±¡ä¸­ï¼Œå¹¶è®¾ç½®ä¸»é¢˜çŠ¶æ€ä¸ºâ€œNew stateâ€ï¼Œæ‰€æœ‰è§‚å¯Ÿè€…éƒ½ä¼šæ”¶åˆ°é€šçŸ¥å¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚æ¥ç€ï¼Œæˆ‘ä»¬å°†å…¶ä¸­ä¸€ä¸ªè§‚å¯Ÿè€…å¯¹è±¡ä»ä¸»é¢˜å¯¹è±¡ä¸­æ³¨é”€ï¼Œè®¾ç½®ä¸»é¢˜çŠ¶æ€ä¸ºâ€œAnother new stateâ€ï¼Œåªæœ‰ä¸€ä¸ªè§‚å¯Ÿè€…å¯¹è±¡ä¼šæ”¶åˆ°é€šçŸ¥å¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚\n","slug":"è§‚å¯Ÿè€…æ¨¡å¼","date":"2023-05-09T12:47:06.000Z","categories_index":"","tags_index":"Java,è®¾è®¡æ¨¡å¼","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"2b09bf65e737f820cf301fb7434c8c8e","title":"è´£ä»»é“¾æ¨¡å¼","content":"è´£ä»»é“¾æ¨¡å¼è´£ä»»é“¾æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œç”¨äºå°†è¯·æ±‚ä»ä¸€ä¸ªå¤„ç†ç¨‹åºä¼ é€’åˆ°å¦ä¸€ä¸ªå¤„ç†ç¨‹åºï¼Œç›´åˆ°æ‰¾åˆ°èƒ½å¤Ÿå¤„ç†è¯·æ±‚çš„å¤„ç†ç¨‹åºã€‚æ¯ä¸ªå¤„ç†ç¨‹åºéƒ½å°†è¯·æ±‚ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå¤„ç†ç¨‹åºï¼Œç›´åˆ°è¯·æ±‚è¢«å¤„ç†ä¸ºæ­¢ã€‚\nè´£ä»»é“¾æ¨¡å¼çš„ç‰¹ç‚¹\n\nè¯·æ±‚å‘é€è€…ä¸å¿…çŸ¥é“è¯·æ±‚åœ¨ä½•æ—¶ã€ä½•å¤„ä»¥åŠå¦‚ä½•è¢«å¤„ç†ã€‚\nå¯ä»¥åŠ¨æ€å¢åŠ æˆ–ä¿®æ”¹è¯·æ±‚çš„å¤„ç†æµç¨‹ï¼Œå¢å¼ºäº†ç³»ç»Ÿçš„çµæ´»æ€§ã€å¯ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§ã€‚\nå¤„ç†ç¨‹åºä¹‹é—´è§£è€¦ï¼Œäº’ç›¸ç‹¬ç«‹ï¼Œæ˜“äºå•å…ƒæµ‹è¯•å’Œè°ƒè¯•ã€‚\nå¯ä»¥é¿å…è¯·æ±‚çš„å‘é€è€…å’Œæ¥æ”¶è€…çš„è€¦åˆå…³ç³»ï¼Œæé«˜ç³»ç»Ÿçš„çµæ´»æ€§ã€‚\n\nè´£ä»»é“¾æ¨¡å¼çš„ä¼˜ç‚¹\n\nå•ä¸€èŒè´£åŸåˆ™ï¼šæ¯ä¸ªå¤„ç†ç¨‹åºåªè´Ÿè´£å¤„ç†è‡ªå·±ä¸“ä¸šé¢†åŸŸå†…çš„è¯·æ±‚ã€‚\nå¼€é—­åŸåˆ™ï¼šå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¢åŠ æˆ–åˆ é™¤å¤„ç†ç¨‹åºï¼ŒåŒæ—¶ä¸ä¼šå½±å“åˆ°å…¶ä»–å¤„ç†ç¨‹åºã€‚\næ˜“äºæ‰©å±•ï¼šå¯ä»¥æ ¹æ®éœ€è¦åŠ¨æ€åœ°å¢åŠ æˆ–ä¿®æ”¹è¯·æ±‚çš„å¤„ç†æµç¨‹ã€‚å…·æœ‰å¾ˆå¥½çš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€‚\nä»£ç å¤ç”¨æ€§é«˜ï¼šèƒ½å¤Ÿé¿å…å¤§é‡é‡å¤ä»£ç çš„äº§ç”Ÿï¼Œå‡å°‘äº†ç³»ç»Ÿçš„ç»´æŠ¤æˆæœ¬ã€‚\n\nè´£ä»»é“¾æ¨¡å¼çš„ç¼ºç‚¹\n\næ— æ³•ä¿è¯è¯·æ±‚ä¸€å®šè¢«å¤„ç†ï¼šå¦‚æœé“¾ä¸­æ²¡æœ‰ä»»ä½•ä¸€ä¸ªå¤„ç†ç¨‹åºèƒ½å¤Ÿå¤„ç†è¯·æ±‚ï¼Œé‚£ä¹ˆè¯·æ±‚å¯èƒ½ä¼šè¢«å¿½ç•¥æˆ–è€…ä¸¢å¤±ã€‚\nå¯èƒ½å¯¼è‡´ç³»ç»Ÿæ€§èƒ½ä¸‹é™ï¼šç”±äºå¤„ç†ç¨‹åºæ˜¯åŠ¨æ€æ·»åŠ çš„ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿçš„å¤„ç†è¿‡ç¨‹æ¯”è¾ƒç¼“æ…¢ã€æ•ˆç‡è¾ƒä½ã€‚\nå¯èƒ½ä¼šäº§ç”Ÿå¾ˆå¤šç»†ç²’åº¦çš„å¯¹è±¡ï¼šå¦‚æœè´£ä»»é“¾æ¯”è¾ƒé•¿ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šäº§ç”Ÿå¾ˆå¤šç»†ç²’åº¦çš„å¯¹è±¡ï¼Œå¯¼è‡´ç³»ç»Ÿèµ„æºçš„æµªè´¹ã€‚\n\nç¤ºä¾‹public abstract class Handler &#123;\n \n    protected Handler successor;\n \n    public void setSuccessor(Handler successor) &#123;\n        this.successor = successor;\n    &#125;\n \n    public abstract void handleRequest(Request request);\n&#125;\n\npublic class ConcreteHandler1 extends Handler &#123;\n \n    public void handleRequest(Request request) &#123;\n        if (request.getType() == RequestType.TYPE1) &#123;\n            System.out.println(request.getName() + \" is handled by ConcreteHandler1\");\n        &#125; else if (successor != null) &#123;\n            successor.handleRequest(request);\n        &#125;\n    &#125;\n&#125;\n\npublic class ConcreteHandler2 extends Handler &#123;\n \n    public void handleRequest(Request request) &#123;\n        if (request.getType() == RequestType.TYPE2) &#123;\n            System.out.println(request.getName() + \" is handled by ConcreteHandler2\");\n        &#125; else if (successor != null) &#123;\n            successor.handleRequest(request);\n        &#125;\n    &#125;\n&#125;\n\npublic class Request &#123;\n     \n    private RequestType type;\n    private String name;\n \n    public Request(RequestType type, String name) &#123;\n        this.type = type;\n        this.name = name;\n    &#125;\n \n    public RequestType getType() &#123;\n        return type;\n    &#125;\n \n    public String getName() &#123;\n        return name;\n    &#125;\n&#125;\n\npublic enum RequestType &#123;\n    TYPE1, TYPE2\n&#125;\n\npublic class Main &#123;\n \n    public static void main(String[] args) &#123;\n        Handler handler1 = new ConcreteHandler1();\n        Handler handler2 = new ConcreteHandler2();\n         \n        handler1.setSuccessor(handler2);\n \n        Request request1 = new Request(RequestType.TYPE1, \"Request 1\");\n        Request request2 = new Request(RequestType.TYPE2, \"Request 2\");\n \n        handler1.handleRequest(request1);\n        handler1.handleRequest(request2);\n    &#125;\n&#125;\n\nåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæŠ½è±¡å¤„ç†ç¨‹åºç±»Handlerï¼Œå®ƒåŒ…å«ä¸€ä¸ªæŒ‡å‘ä¸‹ä¸€ä¸ªå¤„ç†ç¨‹åºçš„å¼•ç”¨ã€‚ç„¶åæˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªå…·ä½“çš„å¤„ç†ç¨‹åºç±»ConcreteHandler1å’ŒConcreteHandler2ï¼Œå®ƒä»¬éƒ½ç»§æ‰¿äº†Handlerç±»å¹¶å®ç°äº†handleRequest()æ–¹æ³•ã€‚\næˆ‘ä»¬è¿˜åˆ›å»ºäº†ä¸€ä¸ªRequestç±»å’Œä¸€ä¸ªæšä¸¾ç±»å‹RequestTypeç”¨äºæ¨¡æ‹Ÿè¯·æ±‚å¯¹è±¡ã€‚æœ€åï¼Œæˆ‘ä»¬åœ¨Mainç±»ä¸­åˆ›å»ºäº†ä¸¤ä¸ªè¯·æ±‚å¯¹è±¡å¹¶å°†å®ƒä»¬ä¼ é€’ç»™é“¾ä¸­çš„ç¬¬ä¸€ä¸ªå¤„ç†ç¨‹åºConcreteHandler1ã€‚\nåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œå¦‚æœè¯·æ±‚ç±»å‹æ˜¯TYPE1ï¼Œåˆ™å®ƒç”±ConcreteHandler1å¤„ç†ï¼Œå¦åˆ™å®ƒå°†ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå¤„ç†ç¨‹åºã€‚å¦‚æœè¯·æ±‚ç±»å‹æ˜¯TYPE2ï¼Œåˆ™å®ƒç”±ConcreteHandler2å¤„ç†ï¼Œå¦åˆ™å®ƒå°†ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå¤„ç†ç¨‹åºï¼Œç›´åˆ°æ‰¾åˆ°èƒ½å¤Ÿå¤„ç†è¯·æ±‚çš„å¤„ç†ç¨‹åºã€‚\n","slug":"è´£ä»»é“¾æ¨¡å¼","date":"2023-05-09T12:16:17.000Z","categories_index":"","tags_index":"Java,è®¾è®¡æ¨¡å¼","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"424f199f6c88af138e76cfdf85fb4fa5","title":"ä»£ç†æ¨¡å¼","content":"ä»£ç†æ¨¡å¼å®ƒä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚ä»£ç†å¯¹è±¡åœ¨å®¢æˆ·ç«¯å’Œç›®æ ‡å¯¹è±¡ä¹‹é—´èµ·åˆ°ä¸­ä»‹ä½œç”¨ï¼Œå¯ä»¥è¿›è¡Œä¸€äº›é™„åŠ çš„å·¥ä½œï¼Œä¾‹å¦‚è®¿é—®æ§åˆ¶ã€è¿œç¨‹è®¿é—®ã€ç¼“å­˜ç­‰ã€‚\nä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ä»£ç†æ¨¡å¼çš„Javaä¾‹å­ï¼šinterface Image &#123;\n    void display();\n&#125;\n\nclass RealImage implements Image &#123;\n    private String filename;\n\n    public RealImage(String filename) &#123;\n        this.filename = filename;\n        loadFromDisk();\n    &#125;\n\n    private void loadFromDisk() &#123;\n        System.out.println(\"Loading \" + filename);\n    &#125;\n\n    public void display() &#123;\n        System.out.println(\"Displaying \" + filename);\n    &#125;\n&#125;\n\nclass ImageProxy implements Image &#123;\n    private String filename;\n    private RealImage image;\n\n    public ImageProxy(String filename) &#123;\n        this.filename = filename;\n    &#125;\n\n    public void display() &#123;\n        if (image == null)\n            image = new RealImage(filename);\n        image.display();\n    &#125;\n&#125;\n\npublic class ProxyDemo &#123;\n    public static void main(String[] args) &#123;\n        Image image = new ImageProxy(\"test.jpg\");\n        image.display();\n    &#125;\n&#125;\n\nåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªImageæ¥å£ï¼Œå…¶ä¸­RealImageæ˜¯å®ç°æ­¤æ¥å£çš„å…·ä½“å¯¹è±¡ï¼Œå®ƒä»£è¡¨äº†ä¸€ä¸ªçœŸå®çš„å›¾ç‰‡æ–‡ä»¶ã€‚ImageProxyç±»ä¹Ÿå®ç°äº†Imageæ¥å£ï¼Œä½†æ˜¯å®ƒå¹¶ä¸æ˜¯çœŸæ­£çš„å›¾ç‰‡ï¼Œè€Œæ˜¯ä¸€ä¸ªä»£ç†ã€‚å®ƒå¯ä»¥å»¶è¿ŸåŠ è½½RealImageå¯¹è±¡ï¼Œå¹¶ä¸”åœ¨éœ€è¦æ—¶ï¼Œé€šè¿‡ä»£ç†å®ç°å¯¹RealImageå¯¹è±¡çš„è®¿é—®ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ§åˆ¶å¯¹RealImageå¯¹è±¡çš„è®¿é—®å¹¶ä¸”å¯ä»¥åšä¸€äº›é™„åŠ çš„å·¥ä½œã€‚å½“å®¢æˆ·ç«¯è°ƒç”¨Imageçš„display()æ–¹æ³•æ—¶ï¼ŒImageProxyä¼šåˆ¤æ–­æ˜¯å¦å·²ç»åŠ è½½äº†RealImageå¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™åˆ›å»ºRealImageå¯¹è±¡å¹¶è°ƒç”¨å®ƒçš„display()æ–¹æ³•ã€‚\n","slug":"ä»£ç†æ¨¡å¼","date":"2023-05-09T11:52:50.000Z","categories_index":"","tags_index":"Java,è®¾è®¡æ¨¡å¼","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"af957b16e3777023cafc3b1e9179b2cd","title":"è£…é¥°å™¨æ¨¡å¼","content":"è£…é¥°å™¨æ¨¡å¼è£…é¥°è€…æ¨¡å¼ï¼ˆDecorator Patternï¼‰\nâ€‹\tå®ƒå…è®¸ä½ å‘ç°æœ‰å¯¹è±¡æ·»åŠ æ–°çš„åŠŸèƒ½ï¼ŒåŒæ—¶åˆä¸æ”¹å˜å…¶ç»“æ„ã€‚è£…é¥°è€…æ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†åŠŸèƒ½è¿›è¡Œåˆ†ç¦»ï¼Œè®©å„ä¸ªç±»åªä¸“æ³¨äºè‡ªå·±çš„èŒè´£ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥éå¸¸çµæ´»çš„æ–¹å¼æ‰©å±•ç³»ç»Ÿçš„åŠŸèƒ½ï¼Œè€Œä¸å¿…ä¿®æ”¹åŸæœ‰ä»£ç ã€‚\nâ€‹\tè£…é¥°å™¨æ¨¡å¼çš„ä¸»è¦ç›®çš„æ˜¯ä¸ºå¯¹è±¡åŠ¨æ€åœ°æ·»åŠ é¢å¤–çš„åŠŸèƒ½ï¼Œä¸éœ€è¦ä¿®æ”¹åŸå§‹å¯¹è±¡çš„ç»“æ„ã€‚è£…é¥°å™¨æ¥æ”¶ä¸€ä¸ªåŸå§‹å¯¹è±¡ï¼Œå¹¶åœ¨å…¶ä¸Šæ·»åŠ ä¸€äº›é¢å¤–çš„è£…é¥°æ“ä½œï¼Œä»è€Œå¢å¼ºäº†åŸå§‹å¯¹è±¡çš„åŠŸèƒ½ã€‚è£…é¥°å™¨æ¨¡å¼é¿å…äº†ä½¿ç”¨å­ç±»ç»§æ‰¿çš„æ–¹å¼è¿›è¡ŒåŠŸèƒ½æ‰©å±•ï¼Œå› ä¸ºè¿™ç§æ–¹å¼å¯èƒ½å¯¼è‡´ç±»å±‚æ¬¡ç»“æ„è¿‡äºå¤æ‚ï¼Œè€Œä¸”æ— æ³•åŠ¨æ€ä¿®æ”¹å¯¹è±¡çš„è¡Œä¸ºã€‚\nä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼š\né¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªå…·æœ‰åŸºæœ¬åŠŸèƒ½çš„æ¥å£Componentå’Œè¯¥æ¥å£çš„ä¸€ä¸ªå®ç°ç±»ConcreteComponentï¼š\npublic interface Component &#123;\n    void operation();\n&#125;\n\npublic class ConcreteComponent implements Component &#123;\n    @Override\n    public void operation() &#123;\n        System.out.println(\"This is a Concrete Component\");\n    &#125;\n&#125;\n\nç„¶åï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºè£…é¥°å™¨Decoratorï¼Œå®ƒæŒæœ‰ä¸€ä¸ªComponentå®ä¾‹ï¼Œå¹¶é‡æ–°å®ç°operationæ–¹æ³•ï¼š\npublic class Decorator implements Component &#123;\n    private Component component;\n\n    public Decorator(Component component) &#123;\n        this.component = component;\n    &#125;\n\n    @Override\n    public void operation() &#123;\n        component.operation();\n    &#125;\n&#125;\n\næœ€åï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå…·ä½“çš„è£…é¥°å™¨ConcreteDecoratorï¼Œå®ƒæ·»åŠ äº†é¢å¤–çš„åŠŸèƒ½ï¼š\npublic class ConcreteDecorator extends Decorator &#123;\n    public ConcreteDecorator(Component component) &#123;\n        super(component);\n    &#125;\n\n    @Override\n    public void operation() &#123;\n        super.operation();\n        addedFunction();\n    &#125;\n\n    private void addedFunction() &#123;\n        System.out.println(\"This is an added function\");\n    &#125;\n&#125;\n\næˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ä½¿ç”¨è£…é¥°å™¨æ¨¡å¼ï¼š\nComponent c1 = new ConcreteComponent();\nc1.operation();\n\nComponent c2 = new ConcreteDecorator(new ConcreteComponent());\nc2.operation();\n\nComponent c3 = new ConcreteDecorator(new ConcreteDecorator(new ConcreteComponent()));\nc3.operation();\n\nè¾“å‡ºç»“æœï¼š\nThis is a Concrete Component\nThis is a Concrete Component\nThis is an added function\nThis is a Concrete Component\nThis is an added function\nThis is an added function\n\nä»è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºï¼Œé€šè¿‡è£…é¥°å™¨æ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥åŠ¨æ€åœ°æ·»åŠ é¢å¤–çš„åŠŸèƒ½ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹åŸæœ‰ä»£ç ã€‚\næ€»ç»“ä¸€ä¸‹ï¼Œè£…é¥°å™¨æ¨¡å¼æ˜¯ä¸€ç§éå¸¸æœ‰ç”¨çš„è®¾è®¡æ¨¡å¼ï¼Œå®ƒå¯ä»¥è®©æˆ‘ä»¬ä»¥ä¸€ç§çµæ´»çš„æ–¹å¼æ‰©å±•ç³»ç»Ÿçš„åŠŸèƒ½ã€‚åŒæ—¶ï¼Œè£…é¥°å™¨æ¨¡å¼è®©å„ä¸ªç±»çš„èŒè´£æ›´åŠ æ¸…æ™°ï¼Œå¯ä»¥æ›´åŠ æ–¹ä¾¿åœ°è¿›è¡Œç»´æŠ¤ã€‚ä½†æ˜¯ï¼Œåœ¨ä½¿ç”¨è£…é¥°å™¨æ¨¡å¼æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä¸è¦è¿‡åº¦ä½¿ç”¨ï¼Œé¿å…é€ æˆä»£ç è¿‡äºå¤æ‚å’Œæ··ä¹±ã€‚\n","slug":"è£…é¥°å™¨æ¨¡å¼","date":"2023-05-09T11:12:05.000Z","categories_index":"","tags_index":"Java,è®¾è®¡æ¨¡å¼","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"890198f3e29403fa2d961081f54ed8cd","title":"ç»„åˆæ¨¡å¼","content":"ç»„åˆæ¨¡å¼ç»„åˆæ¨¡å¼ \nä¸»è¦é€šè¿‡å°†å¯¹è±¡ç»„åˆæˆæ ‘å½¢ç»“æ„æ¥è¡¨ç¤ºâ€œæ•´ä½“-éƒ¨åˆ†â€çš„å…³ç³»ï¼Œè®©å®¢æˆ·ç«¯èƒ½å¤Ÿä»¥ä¸€è‡´çš„æ–¹å¼å¯¹å¾…å•ä¸ªå¯¹è±¡å’Œå¯¹è±¡åˆã€‚\nä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­import java.util.ArrayList;\nimport java.util.List;\n\npublic interface Employee &#123;\n    void showDetails();\n&#125;\n\nclass Leaf implements Employee &#123;\n    private String name;\n    private String position;\n\n    Leaf(String name, String position) &#123;\n        this.name = name;\n        this.position = position;\n    &#125;\n\n    @Override\n    public void showDetails() &#123;\n        System.out.println(name + \" is a \" + position);\n    &#125;\n&#125;\n\nclass Composite implements Employee &#123;\n    private List&lt;Employee> employees = new ArrayList&lt;Employee>();\n\n    @Override\n    public void showDetails() &#123;\n        for (Employee employee : employees) &#123;\n            employee.showDetails();\n        &#125;\n    &#125;\n\n    public void addEmployee(Employee employee) &#123;\n        employees.add(employee);\n    &#125;\n\n    public void removeEmployee(Employee employee) &#123;\n        employees.remove(employee);\n    &#125;\n&#125;\n\npublic class Main &#123;\n    public static void main(String[] args) &#123;\n        Composite organization = new Composite();\n        organization.addEmployee(new Leaf(\"John Doe\", \"Manager\"));\n        Composite department = new Composite();\n        department.addEmployee(new Leaf(\"Jane Smith\", \"Team Lead\"));\n        department.addEmployee(new Leaf(\"Bob Johnson\", \"Engineer\"));\n        Composite subDepartment = new Composite();\n        subDepartment.addEmployee(new Leaf(\"Tina Turner\", \"Engineer\"));\n        subDepartment.addEmployee(new Leaf(\"Steve Rogers\", \"Engineer\"));\n        department.addEmployee(subDepartment);\n        organization.addEmployee(department);\n        organization.showDetails();\n    &#125;\n&#125;\n\nåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼ŒEmployeeæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæœ‰ä¸¤ä¸ªå®ç°ç±»ï¼šLeafå’ŒCompositeã€‚Leafä»£è¡¨çš„æ˜¯å•ä¸ªå‘˜å·¥ï¼Œè€ŒCompositeä»£è¡¨çš„æ˜¯å‘˜å·¥ç»„åˆã€‚composite å¯¹è±¡çš„ä½œç”¨æ˜¯ï¼Œå°†åˆ†æ•£çš„è°ƒç”¨é›†ä¸­èµ·æ¥ï¼Œç»Ÿä¸€è°ƒç”¨å…¥å£ï¼Œå®ƒçš„ç‰¹å¾æ˜¯ï¼Œä¸å…·ä½“å¹²æ´»çš„å®ç°å®ç°åŒä¸€ä¸ªæ¥å£ï¼Œå½“è°ƒç”¨ composite å¯¹è±¡çš„æ¥å£æ–¹æ³•æ—¶ï¼Œå…¶å®æ˜¯å§”æ‰˜å…·ä½“å¹²æ´»çš„å®ç°æ¥å®Œæˆ\nä½¿ç”¨ç»„åˆæ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªåŒ…å«å¤šä¸ªå‘˜å·¥å’Œéƒ¨é—¨çš„ç»„ç»‡ç»“æ„ï¼Œå¹¶å¯ä»¥æ–¹ä¾¿åœ°å¯¹æ•´ä¸ªç»„ç»‡ç»“æ„è¿›è¡Œæ“ä½œã€‚åœ¨ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ ¹èŠ‚ç‚¹organizationï¼Œå®ƒåŒ…å«ä¸€ä¸ªå‘˜å·¥John Doeå’Œä¸€ä¸ªéƒ¨é—¨departmentã€‚éƒ¨é—¨departmentåŒ…å«ä¸€ä¸ªå›¢é˜Ÿé¢†å¯¼Jane Smithå’Œä¸€ä¸ªå·¥ç¨‹å¸ˆBob Johnsonï¼Œä»¥åŠä¸€ä¸ªå­éƒ¨é—¨subDepartmentï¼Œå­éƒ¨é—¨subDepartmentåŒ…å«ä¸¤ä¸ªå·¥ç¨‹å¸ˆTina Turnerå’ŒSteve Rogersã€‚æœ€åï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨organization.showDetails()æ–¹æ³•æ¥æ‰“å°ç»„ç»‡ç»“æ„ä¸­æ¯ä¸ªå‘˜å·¥çš„è¯¦ç»†ä¿¡æ¯ã€‚\n","slug":"ç»„åˆæ¨¡å¼","date":"2023-05-09T10:42:25.000Z","categories_index":"","tags_index":"Java,è®¾è®¡æ¨¡å¼","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"a8b2eb4f810dce05fcecb16e8edfd126","title":"é€‚é…å™¨æ¨¡å¼","content":"é€‚é…å™¨æ¨¡å¼é€‚é…å™¨æ¨¡å¼ï¼ˆAdapter Patternï¼‰æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œå®ƒç”¨äºå°†ä¸€ä¸ªç±»çš„æ¥å£è½¬æ¢æˆå®¢æˆ·ç«¯æ‰€æœŸæœ›çš„å¦ä¸€ç§æ¥å£ï¼Œä»è€Œä½¿åŸæœ¬ä¸å…¼å®¹çš„æ¥å£èƒ½å¤ŸååŒå·¥ä½œã€‚åœ¨é€‚é…å™¨æ¨¡å¼ä¸­ï¼Œé€‚é…å™¨å……å½“äº†ä¸¤ä¸ªä¸å…¼å®¹æ¥å£ä¹‹é—´çš„æ¡¥æ¢ï¼Œå®ƒè´Ÿè´£å…è®¸è¿™äº›æ¥å£é—´èƒ½å¤Ÿç›¸äº’åä½œã€‚\nåœ¨Javaä¸­ï¼Œé€‚é…å™¨æ¨¡å¼å¸¸ç”¨äºå°†ä¸å…¼å®¹çš„æ¥å£è¿›è¡Œè½¬æ¢ï¼Œé€šå¸¸åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªè§’è‰²ï¼š\n\nTargetï¼ˆç›®æ ‡æŠ½è±¡ç±»ï¼‰ï¼šå®¢æˆ·ç«¯æ‰€æœŸæœ›çš„æ¥å£ï¼Œå®šä¹‰å®¢æˆ·ç«¯æ‰€éœ€çš„æ“ä½œã€‚\nAdapterï¼ˆé€‚é…å™¨ç±»ï¼‰ï¼šé€‚é…å™¨ï¼Œå°†Adapteeè½¬æ¢æˆTargetæ‰€æœŸæœ›çš„æ¥å£ã€‚å®ƒç»´æŠ¤äº†ä¸€ä¸ªæŒ‡å‘Adapteeå¯¹è±¡çš„å¼•ç”¨ï¼Œå¹¶å®ç°Targetæ¥å£ï¼Œä½¿å¾—å®¢æˆ·ç«¯èƒ½å¤Ÿé€šè¿‡Adapteræ¥è®¿é—®Adapteeå¯¹è±¡ã€‚\nAdapteeï¼ˆåŸæœ¬çš„ç±»ï¼‰ï¼šéœ€è¦è¢«é€‚é…çš„ç±»ï¼ŒåŒ…å«åŸæœ¬çš„æ–¹æ³•æˆ–æ¥å£ã€‚\n\nç¤ºä¾‹æˆ‘ä»¬æ¨¡æ‹Ÿäº†ä¸€ä¸ªæ—§ç‰ˆçš„Androidæ‰‹æœºï¼ˆOldAndroidPhoneï¼‰å’Œä¸€ä¸ªæ–°ç‰ˆçš„iOSæ‰‹æœºï¼ˆNewiPhoneï¼‰ï¼Œå®ƒä»¬åˆ†åˆ«æœ‰ä¸åŒçš„éŸ³ä¹æ’­æ”¾å™¨æ¥å£ï¼Œè€Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ä¸ªé€‚é…å™¨ï¼ˆMusicPlayerAdapterï¼‰æ¥å…¼å®¹å®ƒä»¬çš„æ“ä½œï¼š\n//åŸæœ‰éŸ³ä¹æ’­æ”¾æ¥å£ \ninterface MusicPlayer &#123;\n    void playMP3(String fileName);\n&#125;\n\n//æ—§ç‰ˆAndroidæ‰‹æœº\nclass OldAndroidPhone implements MusicPlayer &#123;\n    public void playMP3(String fileName) &#123;\n        System.out.println(\"Old Android phone is playing MP3 file: \" + fileName);\n    &#125;\n&#125;\n\n//æ–°ç‰ˆiPhoneæ‰‹æœº \ninterface NewiPhonePlayer &#123;\n    void playAAC(String fileName);\n&#125;\n\nclass NewiPhone implements NewiPhonePlayer &#123;\n    public void playAAC(String fileName) &#123;\n        System.out.println(\"New iPhone is playing AAC file: \" + fileName);\n    &#125;\n&#125;\n\n//é€‚é…å™¨ï¼Œå°†æ—§ç‰ˆæ‰‹æœºçš„æ“ä½œé€‚é…æˆæ–°ç‰ˆæ‰‹æœºå¯ä»¥ä½¿ç”¨çš„å½¢å¼\nclass MusicPlayerAdapter implements NewiPhonePlayer &#123;\n    private MusicPlayer player;\n    \n    public MusicPlayerAdapter(MusicPlayer player)&#123;\n        this.player = player;\n    &#125;\n    \n    //é€‚é…å™¨å°†AACæ–‡ä»¶è½¬åŒ–ä¸ºMP3æ–‡ä»¶ï¼Œå¹¶è°ƒç”¨åŸæœ‰çš„æ’­æ”¾æ–¹æ³•\n    public void playAAC(String fileName) &#123;\n        String mp3File = convertAACtoMP3(fileName);\n        player.playMP3(mp3File);\n    &#125;\n    \n    private String convertAACtoMP3(String fileName)&#123;\n        System.out.println(\"Converting AAC to MP3: \" + fileName);\n        return fileName.replace(\".aac\", \".mp3\");\n    &#125;\n&#125;\n\n//å®¢æˆ·ç«¯ä½¿ç”¨ä¾‹å­\npublic class Client &#123;\n    public static void main(String[] args) &#123;\n        //æ—§ç‰ˆAndroidæ‰‹æœºæ’­æ”¾MP3\n        MusicPlayer oldPhone = new OldAndroidPhone();\n        oldPhone.playMP3(\"old_phone_music.mp3\");\n        \n        //æ–°ç‰ˆiPhoneæ‰‹æœºæ’­æ”¾AACï¼Œä½¿ç”¨é€‚é…å™¨å…¼å®¹æ’­æ”¾MP3æ–‡ä»¶\n        NewiPhonePlayer newPhone = new NewiPhone();\n        MusicPlayerAdapter adapter = new MusicPlayerAdapter(oldPhone);\n        newPhone.playAAC(\"new_phone_music.aac\");\n        adapter.playAAC(\"new_phone_music.aac\");\n    &#125;\n&#125;\n\nåœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå®šä¹‰äº†ä¸¤ä¸ªå·²æœ‰çš„éŸ³ä¹æ’­æ”¾å™¨æ¥å£ MusicPlayer å’Œ NewiPhonePlayerï¼Œå®ƒä»¬åˆ†åˆ«è¢« OldAndroidPhone å’Œ NewiPhone å®ç°ã€‚ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨ MusicPlayerAdapter ç±»å°† OldAndroidPhone ç±»çš„ playMP3 æ–¹æ³•é€‚é…æˆ NewiPhonePlayer æ¥å£çš„ playAAC æ–¹æ³•ï¼Œé€šè¿‡è¿™ä¸ªé€‚é…å™¨ï¼Œæ–°ç‰ˆ iPhone æ‰‹æœºå¯ä»¥å…¼å®¹æ—§ç‰ˆ Android æ‰‹æœºçš„éŸ³ä¹æ’­æ”¾åŠŸèƒ½ã€‚åœ¨å®¢æˆ·ç«¯ä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬åˆ†åˆ«è°ƒç”¨äº† OldAndroidPhone çš„ playMP3 æ–¹æ³•ï¼ˆæ—§ç‰ˆ Android æ‰‹æœºï¼‰å’Œ NewiPhonePlayer çš„ playAAC æ–¹æ³•ï¼ˆæ–°ç‰ˆ iPhone æ‰‹æœºï¼Œä½¿ç”¨ MusicPlayerAdapter é€‚é…å™¨ï¼‰ã€‚\næˆ‘ä»¬å¯ä»¥çœ‹å‡ºé€‚é…å™¨æ¨¡å¼çš„ä¼˜ç‚¹ï¼š\n\nå¯ä»¥è®©åŸæœ‰çš„æ¥å£å’Œæ–°æ¥å£ä¹‹é—´ä¸å‘ç”Ÿå†²çªåœ°ååŒå·¥ä½œï¼Œä»è€Œè®©ä»£ç æ›´å¥½åœ°æ‹“å±•å’Œç»´æŠ¤ã€‚\n\n","slug":"é€‚é…å™¨æ¨¡å¼","date":"2023-05-09T08:09:59.000Z","categories_index":"","tags_index":"Java,è®¾è®¡æ¨¡å¼","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"3dbdc722104d94fc07273118e255f7fd","title":"å·¥å‚æ¨¡å¼","content":"å·¥å‚æ¨¡å¼ç®€å•â¼¯â¼šæ¨¡å¼æŒ‡ç”±â¼€ä¸ªâ¼¯â¼šå¯¹è±¡æ¥åˆ›å»ºå®ä¾‹ï¼Œå®¢æˆ·ç«¯ä¸éœ€è¦å…³æ³¨åˆ›å»ºé€»è¾‘ï¼Œåªéœ€æä¾›ä¼ â¼Šâ¼¯â¼šçš„å‚æ•°\nç®€å•å·¥å‚UMLç±»å›¾\n\né€‚â½¤äºâ¼¯â¼šç±»è´Ÿè´£åˆ›å»ºå¯¹è±¡è¾ƒå°‘çš„æƒ…å†µï¼Œç¼ºç‚¹æ˜¯å¦‚æœè¦å¢åŠ æ–°äº§å“ï¼Œå°±éœ€\nè¦ä¿®æ”¹â¼¯â¼šç±»çš„åˆ¤æ–­é€»è¾‘ï¼Œè¿èƒŒå¼€é—­åŸåˆ™ï¼Œä¸”äº§å“å¤šçš„è¯ä¼šä½¿â¼¯â¼šç±»â½è¾ƒ\nå¤æ‚ã€‚\nç®€å•å·¥å‚çš„ä¾‹å­:\nCalendarç±»çš„getInstanceæ–¹æ³•ä½¿ç”¨äº†ä¸€ç§ç®€å•å·¥å‚çš„æ–¹å¼æ¥åˆ›å»ºä¸åŒåœ°åŒºçš„æ—¥å†å¯¹è±¡ã€‚\nå…·ä½“æ¥è¯´ï¼ŒCalendarç±»æœ¬èº«æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒå®šä¹‰äº†ä¸€äº›æ–¹æ³•æ¥å¤„ç†æ—¥æœŸå’Œæ—¶é—´ã€‚ç”±äºä¸åŒåœ°åŒºæœ‰ä¸åŒçš„æ—¥å†ï¼Œå› æ­¤Calendarç±»å¹¶æ²¡æœ‰ç›´æ¥å®ç°å…·ä½“çš„æ—¥å†ï¼Œè€Œæ˜¯é€šè¿‡getInstanceæ–¹æ³•æ¥è·å–æŒ‡å®šåœ°åŒºçš„Calendarå®ä¾‹ã€‚getInstanceæ–¹æ³•æ¥å—ä¸€ä¸ªLocaleç±»å‹çš„å‚æ•°ï¼Œå®ƒæ ¹æ®ä¸åŒçš„Localeå‚æ•°è°ƒç”¨createCalendaræ–¹æ³•åˆ›å»ºå…·ä½“çš„æ—¥å†å®ä¾‹ã€‚createCalendaræ–¹æ³•æ˜¯ä¸€ä¸ªprotectedæ–¹æ³•ï¼Œç”±Calendarç±»çš„å­ç±»æ¥å®ç°ã€‚åœ¨å…·ä½“çš„å­ç±»ä¸­ï¼Œæ ¹æ®ä¼ å…¥çš„Localeå‚æ•°åˆ›å»ºç›¸åº”çš„æ—¥å†å¯¹è±¡ï¼Œç„¶åè¿”å›ã€‚è¿™é‡Œï¼ŒcreateCalendaræ–¹æ³•å°±æ‰®æ¼”äº†ä¸€ä¸ªç®€å•å·¥å‚æ¨¡å¼ä¸­çš„å·¥å‚çš„è§’è‰²ï¼Œè€ŒCalendarç±»åˆ™ç›¸å½“äºä¸€ä¸ªåˆ›å»ºå·¥å‚ï¼Œè´Ÿè´£æ•´ä¸ªæ—¥å†å¯¹è±¡çš„ç”Ÿæˆè¿‡ç¨‹çš„è°ƒåº¦ã€‚\nå·¥å‚æ–¹æ³•æ¨¡å¼åœ¨å·¥å‚æ–¹æ³•æ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬ä¸å†æä¾›ä¸€ä¸ªç»Ÿä¸€çš„å·¥å‚ç±»æ¥åˆ›å»ºæ‰€æœ‰çš„å¯¹è±¡ï¼Œè€Œæ˜¯æä¾›ä¸€ä¸ªå·¥å‚æ¥å£ï¼Œç”±ä¸åŒçš„å­ç±»æ¥å®ç°å·¥å‚æ¥å£ä¸­çš„æ–¹æ³•æ¥åˆ›å»ºä¸åŒçš„å¯¹è±¡ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å¢åŠ äº†ç³»ç»Ÿçš„æ‰©å±•æ€§å’Œçµæ´»æ€§ï¼Œå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚æ¥å¢åŠ ç›¸åº”çš„å­ç±»å’Œå·¥å‚å®ç°ã€‚\nå·¥å‚æ–¹æ³•æ¨¡å¼é€šå¸¸ç”±å››éƒ¨åˆ†ç»„æˆï¼šæŠ½è±¡äº§å“ã€å…·ä½“äº§å“ã€æŠ½è±¡å·¥å‚ã€å…·ä½“å·¥å‚ã€‚å…¶ä¸­ï¼ŒæŠ½è±¡äº§å“æ˜¯éœ€è¦åˆ›å»ºçš„å¯¹è±¡çš„é€šç”¨æ¥å£ï¼Œå…·ä½“äº§å“æ˜¯å®ç°æŠ½è±¡äº§å“æ¥å£çš„å…·ä½“ç±»ï¼ŒæŠ½è±¡å·¥å‚æ˜¯åˆ›å»ºäº§å“çš„æ¥å£ï¼Œå…·ä½“å·¥å‚æ˜¯å®ç°æŠ½è±¡å·¥å‚æ¥å£çš„å…·ä½“ç±»ã€‚\nå·¥å‚æ–¹æ³•UMLç±»å›¾ï¼š\n\nä½¿ç”¨å·¥å‚æ–¹æ³•æ¨¡å¼çš„å¥½å¤„æ˜¯ï¼š\n\nå¯æ‰©å±•æ€§æ›´å¥½ã€‚ä½¿ç”¨å·¥å‚æ–¹æ³•æ¨¡å¼å¯ä»¥æ›´åŠ å®¹æ˜“åœ°æ‰©å±•å’Œæ·»åŠ æ–°çš„äº§å“ç±»ï¼Œè€Œä¸ä¼šå½±å“åŸæœ‰çš„ä»£ç ç»“æ„ã€‚\n\næ˜“äºç»´æŠ¤ã€‚å·¥å‚æ–¹æ³•æ¨¡å¼å°†åˆ›å»ºå¯¹è±¡çš„ä»£ç é›†ä¸­åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œæ˜“äºç»´æŠ¤ã€‚å½“éœ€è¦ä¿®æ”¹æ—¶ï¼Œåªéœ€è¦ä¿®æ”¹å¯¹åº”çš„å·¥å‚ç±»å³å¯ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹å®¢æˆ·ç«¯ä»£ç ã€‚\n\né™ä½è€¦åˆåº¦ã€‚ä½¿ç”¨å·¥å‚æ–¹æ³•æ¨¡å¼å¯ä»¥å°†å®¢æˆ·ç«¯ä»£ç å’Œå…·ä½“äº§å“çš„å®ç°è§£è€¦ï¼Œä½¿å¾—å®¢æˆ·ç«¯ä»£ç ä¸éœ€è¦äº†è§£æ¯ä¸ªå…·ä½“äº§å“ç±»çš„ç»†èŠ‚ã€‚\n\n\næŠ½è±¡å·¥å‚æ–¹æ³•æ¨¡å¼æŠ½è±¡å·¥å‚æ¨¡å¼æ˜¯å·¥å‚æ–¹æ³•æ¨¡å¼çš„æ‰©å±•ï¼Œæ—¨åœ¨æä¾›ä¸€ä¸ªå·¥å‚æ¥å£æ¥åˆ›å»ºä¸€ç³»åˆ—ç›¸å…³çš„äº§å“ï¼Œè€Œä¸æ˜¯å•ä¸€çš„äº§å“ç±»ã€‚\næŠ½è±¡å·¥å‚æ¨¡å¼ä¸­ä¼šå­˜åœ¨å¤šä¸ªäº§å“æ—ï¼Œæ¯ä¸ªäº§å“æ—åŒ…å«å¤šä¸ªäº§å“ç­‰çº§ç»“æ„ã€‚äº§å“ç­‰çº§ç»“æ„æ˜¯æŒ‡å…·æœ‰ç›¸åŒåŠŸèƒ½çš„äº§å“ç»„æˆçš„é›†åˆï¼Œä¾‹å¦‚å¤§ä¼—æ±½è½¦ã€å¥¥è¿ªæ±½è½¦å’Œå¥”é©°æ±½è½¦ç»„æˆäº†ä¸€ä¸ªäº§å“æ—ï¼Œè€Œæ¯ç§æ±½è½¦éƒ½å…·æœ‰è½¦è½®ã€è½¦èº«å’Œå‘åŠ¨æœºç­‰ç­‰ç»„æˆçš„äº§å“ç­‰çº§ç»“æ„ã€‚\nåœ¨æŠ½è±¡å·¥å‚æ¨¡å¼ä¸­ï¼Œå®šä¹‰ä¸€ä¸ªæŠ½è±¡å·¥å‚æ¥å£ï¼Œå®ƒåŒ…å«äº†ä¸€ç»„ç”¨äºåˆ›å»ºäº§å“æ—ä¸­æ¯ä¸ªäº§å“ç­‰çº§ç»“æ„çš„æ–¹æ³•ã€‚æ¯ä¸ªå…·ä½“çš„å·¥å‚ç±»å®ç°è¿™ä¸ªæ¥å£ï¼Œè´Ÿè´£å®ç°è‡ªå·±çš„äº§å“æ—ç”Ÿäº§è¿‡ç¨‹ã€‚è€Œå…·ä½“äº§å“åˆ™ç”±å…·ä½“å·¥å‚ç±»ä¸­çš„å…·ä½“æ–¹æ³•å®ç°æ¥åˆ›å»ºã€‚\né€šè¿‡æŠ½è±¡å·¥å‚æ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›é€ ä¸€ä¸ªå®¶æ—çš„å¯¹è±¡ï¼Œè¿™ä¸ªå®¶æ—å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªäº§å“æ—ï¼Œè€Œæ¯ä¸ªå®¶æ—æˆå‘˜å¯ä»¥çœ‹åšæ˜¯è¿™ä¸ªäº§å“æ—ä¸­çš„æŸä¸ªäº§å“ç­‰çº§ç»“æ„ã€‚æŠ½è±¡å·¥å‚æ¨¡å¼ä¿è¯äº†å„ç§äº§å“ä¹‹é—´çš„å…¼å®¹æ€§ï¼Œå³ä¸€ä¸ªå·¥å‚åˆ›å»ºçš„äº§å“éƒ½æ˜¯è¯¥å·¥å‚åˆ›å»ºçš„å…¶ä»–äº§å“çš„å…¼å®¹ç»„åˆã€‚\næŠ½è±¡å·¥å‚UMLç±»å›¾ï¼š\n\nç¤ºä¾‹ä»£ç :é¦–å…ˆæ˜¯æ±½è½¦å·¥å‚çš„æŠ½è±¡ç±»ï¼ˆAbstract Factoryï¼‰ï¼š\n// å®šä¹‰æ±½è½¦å·¥å‚çš„æŠ½è±¡ç±»\nabstract class CarFactory &#123;\n    abstract Wheel createWheel();\n    abstract Body createBody();\n    abstract Engine createEngine();\n&#125;\n\nç„¶åæ˜¯å…·ä½“çš„å¤§ä¼—æ±½è½¦å·¥å‚ç±»ï¼ˆVolkswagen Car Factoryï¼‰å’Œå¥¥è¿ªæ±½è½¦å·¥å‚ç±»ï¼ˆAudi Car Factoryï¼‰ï¼š\n// å®šä¹‰å¤§ä¼—æ±½è½¦å·¥å‚\nclass VolkswagenFactory extends CarFactory &#123;\n    @Override\n    public Wheel createWheel() &#123;\n        return new VolkswagenWheel();\n    &#125;\n    @Override\n    public Body createBody() &#123;\n        return new VolkswagenBody();\n    &#125;\n    @Override\n    public Engine createEngine() &#123;\n        return new VolkswagenEngine();\n    &#125;\n&#125;\n\n// å®šä¹‰å¥¥è¿ªæ±½è½¦å·¥å‚\nclass AudiFactory extends CarFactory &#123;\n    @Override\n    public Wheel createWheel() &#123;\n        return new AudiWheel();\n    &#125;\n    @Override\n    public Body createBody() &#123;\n        return new AudiBody();\n    &#125;\n    @Override\n    public Engine createEngine() &#123;\n        return new AudiEngine();\n    &#125;\n&#125;\n\nç„¶åæ˜¯æ±½è½¦ç»„ä»¶çš„æŠ½è±¡ç±»ï¼ˆAbstract Productï¼‰ï¼š\n// å®šä¹‰æ±½è½¦çš„ç»„ä»¶æŠ½è±¡ç±»\nabstract class Wheel &#123;\n    public abstract void create();\n&#125;\nabstract class Body &#123;\n    public abstract void create();\n&#125;\nabstract class Engine &#123;\n    public abstract void create();\n&#125;\n\nå…·ä½“çš„å¤§ä¼—å’Œå¥¥è¿ªæ±½è½¦ç»„ä»¶çš„ç±»ï¼š\n// å®šä¹‰å¤§ä¼—æ±½è½¦ç»„ä»¶\nclass VolkswagenWheel extends Wheel &#123;\n    @Override\n    public void create() &#123;\n        System.out.println(\"ç”Ÿäº§å¤§ä¼—è½¦è½®\");\n    &#125;\n&#125;\nclass VolkswagenBody extends Body &#123;\n    @Override\n    public void create() &#123;\n        System.out.println(\"ç”Ÿäº§å¤§ä¼—è½¦èº«\");\n    &#125;\n&#125;\nclass VolkswagenEngine extends Engine &#123;\n    @Override\n    public void create() &#123;\n        System.out.println(\"ç”Ÿäº§å¤§ä¼—å‘åŠ¨æœº\");\n    &#125;\n&#125;\n\n// å®šä¹‰å¥¥è¿ªæ±½è½¦ç»„ä»¶\nclass AudiWheel extends Wheel &#123;\n    @Override\n    public void create() &#123;\n        System.out.println(\"ç”Ÿäº§å¥¥è¿ªè½¦è½®\");\n    &#125;\n&#125;\nclass AudiBody extends Body &#123;\n    @Override\n    public void create() &#123;\n        System.out.println(\"ç”Ÿäº§å¥¥è¿ªè½¦èº«\");\n    &#125;\n&#125;\nclass AudiEngine extends Engine &#123;\n    @Override\n    public void create() &#123;\n        System.out.println(\"ç”Ÿäº§å¥¥è¿ªå‘åŠ¨æœº\");\n    &#125;\n&#125;\n\næœ€åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™äº›ç±»æ¥åˆ›å»ºä¸åŒå“ç‰Œçš„æ±½è½¦ï¼š\npublic class Main &#123;\n    public static void main(String[] args) &#123;\n        // åˆ›å»ºå¤§ä¼—æ±½è½¦\n        CarFactory vwFactory = new VolkswagenFactory();\n        vwFactory.createWheel().create();\n        vwFactory.createBody().create();\n        vwFactory.createEngine().create();\n        \n        // åˆ›å»ºå¥¥è¿ªæ±½è½¦\n        CarFactory audiFactory = new AudiFactory();\n        audiFactory.createWheel().create();\n        audiFactory.createBody().create();\n        audiFactory.createEngine().create();\n    &#125;\n&#125;\n\n","slug":"å·¥å‚æ¨¡å¼","date":"2023-05-09T05:19:32.000Z","categories_index":"","tags_index":"Java,è®¾è®¡æ¨¡å¼","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"b00cac0eae3b04411014ea36945005af","title":"å»ºé€ è€…æ¨¡å¼","content":"Javaå»ºé€ è€…æ¨¡å¼Javaä¸­çš„å»ºé€ è€…æ¨¡å¼(Builder Pattern)\nä¸»è¦ç”¨äºåˆ›å»ºä¸€ä¸ªå¤æ‚å¯¹è±¡ï¼Œå®ƒé€šè¿‡ä¸€æ­¥ä¸€æ­¥åœ°æ„å»ºï¼Œå¯ä»¥åˆ›å»ºå‡ºä¸åŒçš„å¯¹è±¡è¡¨ç¤ºã€‚\nè¯¥æ¨¡å¼åŒ…å«ä»¥ä¸‹å‡ ä¸ªè§’è‰²ï¼š\n\nBuilder(å»ºé€ è€…)ï¼šæŠ½è±¡å»ºé€ è€…ï¼Œå®šä¹‰åˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œå¹¶åŒ…å«è¿”å›å»ºé€ äº§å“çš„æ–¹æ³•ã€‚\n\nConcreteBuilder(å…·ä½“å»ºé€ è€…)ï¼šå®ç°Builderæ¥å£ï¼Œå®ç°å…·ä½“äº§å“çš„åˆ›å»ºè¿‡ç¨‹ï¼Œä»¥åŠè¿”å›å…·ä½“äº§å“çš„æ–¹æ³•ã€‚\n\nDirector(å¯¼æ¼”è€…)ï¼šè´Ÿè´£è°ƒç”¨å»ºé€ è€…ç”Ÿæˆäº§å“ã€‚\n\nProduct(äº§å“)ï¼šè¡¨ç¤ºè¢«ç”Ÿæˆçš„å¤æ‚å¯¹è±¡ï¼ŒåŒ…å«å¤šä¸ªéƒ¨ä»¶ã€‚\n\n\nä»¥ä¸‹æ˜¯Javaä¸­çš„å»ºé€ è€…æ¨¡å¼ç¤ºä¾‹ä»£ç ï¼š\n// Product\nclass Car &#123;\n    private String engine;\n    private String chassis;\n    private String body;\n\n    public void setEngine(String engine) &#123;\n        this.engine = engine;\n    &#125;\n\n    public void setChassis(String chassis) &#123;\n        this.chassis = chassis;\n    &#125;\n\n    public void setBody(String body) &#123;\n        this.body = body;\n    &#125;\n\n    @Override\n    public String toString() &#123;\n        return \"Car &#123;engine='\" + engine + \"', chassis='\" + chassis + \"', body='\" + body + \"'&#125;\";\n    &#125;\n&#125;\n\n// Builder\ninterface CarBuilder &#123;\n    void buildEngine();\n    void buildChassis();\n    void buildBody();\n    Car getCar();\n&#125;\n\n// ConcreteBuilders\nclass SportsCarBuilder implements CarBuilder &#123;\n    private Car car;\n\n    public SportsCarBuilder() &#123;\n        this.car = new Car();\n    &#125;\n\n    @Override\n    public void buildEngine() &#123;\n        car.setEngine(\"3.0L V6\");\n    &#125;\n\n    @Override\n    public void buildChassis() &#123;\n        car.setChassis(\"Aluminum\");\n    &#125;\n\n    @Override\n    public void buildBody() &#123;\n        car.setBody(\"Carbon Fiber\");\n    &#125;\n\n    @Override\n    public Car getCar() &#123;\n        return this.car;\n    &#125;\n&#125;\n\nclass SedanCarBuilder implements CarBuilder &#123;\n    private Car car;\n\n    public SedanCarBuilder() &#123;\n        this.car = new Car();\n    &#125;\n\n    @Override\n    public void buildEngine() &#123;\n        car.setEngine(\"2.4L 4-cylinder\");\n    &#125;\n\n    @Override\n    public void buildChassis() &#123;\n        car.setChassis(\"Steel\");\n    &#125;\n\n    @Override\n    public void buildBody() &#123;\n        car.setBody(\"Metal\");\n    &#125;\n\n    @Override\n    public Car getCar() &#123;\n        return this.car;\n    &#125;\n&#125;\n\n\n// Director\nclass AutomotiveEngineer &#123;\n    public void build (CarBuilder builder) &#123;\n        builder.buildEngine();\n        builder.buildChassis();\n        builder.buildBody();\n    &#125;\n&#125;\n\npublic class BuilderPatternExample &#123;\n    public static void main(String[] args) &#123;\n        AutomotiveEngineer engineer = new AutomotiveEngineer();\n\n        CarBuilder sportsCarBuilder = new SportsCarBuilder();\n        engineer.build (sportsCarBuilder);\n        System.out.println(sportsCarBuilder.getCar()); \n        // Output: Car &#123;engine='3.0L V6', chassis='Aluminum', body='Carbon Fiber'&#125;\n\n        CarBuilder sedanCarBuilder = new SedanCarBuilder();\n        engineer.build (sedanCarBuilder);\n        System.out.println(sedanCarBuilder.getCar()); \n        // Output: Car &#123;engine='2.4L 4-cylinder', chassis='Steel', body='Metal'&#125;\n    &#125;\n&#125;\n\nåœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼ŒCarBuilderè¡¨ç¤ºæŠ½è±¡å»ºé€ è€…ï¼ŒSportsCarBuilderå’ŒSedanCarBuilderåˆ†åˆ«è¡¨ç¤ºå…·ä½“å»ºé€ è€…ï¼ŒAutomotiveEngineerè¡¨ç¤ºå¯¼æ¼”è€…ï¼ŒCarè¡¨ç¤ºäº§å“ã€‚é€šè¿‡å¯¼æ¼”è€…è°ƒç”¨å…·ä½“å»ºé€ è€…çš„æ„å»ºæ–¹æ³•ï¼Œå³å¯å»ºé€ å‡ºä¸åŒçš„Carå®ä¾‹ã€‚\nå®ƒçš„ä¸»è¦äº®ç‚¹æœ‰ä¸‰å¤„ï¼š\n\nè¾ƒä¸ºçµæ´»çš„æ„å»ºäº§å“å¯¹è±¡\n\nåœ¨ä¸æ‰§è¡Œæœ€å build æ–¹æ³•å‰ï¼Œäº§å“å¯¹è±¡éƒ½ä¸å¯ç”¨\n\næ„å»ºè¿‡ç¨‹é‡‡ç”¨é“¾å¼è°ƒç”¨ï¼Œçœ‹èµ·æ¥æ¯”è¾ƒçˆ½\n\n\n","slug":"å»ºé€ è€…æ¨¡å¼","date":"2023-05-09T04:38:15.000Z","categories_index":"","tags_index":"Java,è®¾è®¡æ¨¡å¼","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"0c6e8405652937a86cc3782f838cf782","title":"springä¸­å¸¸è§çš„è®¾è®¡æ¨¡å¼","content":"Springä¸­å¸¸è§çš„è®¾è®¡æ¨¡å¼1.Springä¸­çš„å•ä¾‹æ¨¡å¼å•ä¾‹æ¨¡å¼ ä¸ å•ä¾‹bean çš„åŒºåˆ«\n\næ ¹æ®å•ä¾‹æ¨¡å¼çš„ç›®çš„ Ensure a class only has one instance, and provide a global point of access to it\n\nå°±æ˜¯ç¡®ä¿åªæœ‰ä¸€ä¸ªå®ä¾‹æä¾›ç»™å…¨å±€ä½¿ç”¨\n\næ˜¾ç„¶Springä¸­çš„å•ä¾‹beanå¹¶éå®ç°äº†å•ä¾‹æ¨¡å¼ï¼Œå•ä¾‹beanåªèƒ½ä¿è¯æ¯ä¸ªå®¹å™¨å†…ï¼Œç›¸åŒidçš„beanå•å®ä¾‹\n Springä¸­ä¹Ÿæœ‰ç”¨åˆ°å•ä¾‹æ¨¡å¼\n\norg.springframework.transaction.TransactionDefinition#withDefaults\n\norg.springframework.aop.TruePointcut#INSTANCE\n\norg.springframework.aop.interceptor.ExposeInvocationInterceptor#ADVISOR\n\norg.springframework.core.annotation.AnnotationAwareOrderComparator#INSTANCE\n\norg.springframework.core.OrderComparator#INSTANCE\n\n\n2.Springä¸­çš„Builderï¼ˆå»ºé€ è€…æ¨¡å¼ï¼‰å®šä¹‰ Separate the construction of a complex object from its representation so that the same construction process can create different representations å³å°†å¤æ‚å¯¹è±¡çš„æ„å»ºä¸å…¶è¡¨ç¤ºåˆ†ç¦»ï¼Œä»¥ä¾¿åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤ºå½¢å¼ã€‚\nä¼˜ç‚¹ï¼š\n\nè¾ƒä¸ºçµæ´»çš„æ„å»ºäº§å“å¯¹è±¡\nåœ¨ä¸æ‰§è¡Œæœ€å build æ–¹æ³•å‰ï¼Œäº§å“å¯¹è±¡éƒ½ä¸å¯ç”¨\næ„å»ºè¿‡ç¨‹é‡‡ç”¨é“¾å¼è°ƒç”¨ï¼Œçœ‹èµ·æ¥æ¯”è¾ƒçˆ½\n\nSpring ä¸­ä½“ç° Builder æ¨¡å¼çš„åœ°æ–¹ï¼š\n\norg.springframework.beans.factory.support.BeanDefinitionBuilder\norg.springframework.web.util.UriComponentsBuilder\norg.springframework.http.ResponseEntity.HeadersBuilder\norg.springframework.http.ResponseEntity.BodyBuilder\n\n3.Springä¸­çš„Factory Method(å·¥å‚æ–¹æ³•æ¨¡å¼)å®šä¹‰Define an interface for creating an object, but let subclasses decide which class to instantiate. Factory Method lets a class defer instantiation to subclasses  å³ä¸€ä¸ªåˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œä½†æ˜¯è®©å­ç±»æ¥å†³å®šå®ä¾‹åŒ–å“ªä¸ªç±»ã€‚å·¥å‚æ–¹æ³•è®©ä¸€ä¸ªç±»çš„å®ä¾‹åŒ–å»¶è¿Ÿåˆ°å…¶å­ç±»ä¸­è¿›è¡Œã€‚\nSpring ä¸­çš„ ApplicationContext ä¸ BeanFactory ä¸­çš„ getBean éƒ½å¯ä»¥è§†ä¸ºå·¥å‚æ–¹æ³•ï¼Œå®ƒéšè—äº† bean ï¼ˆäº§å“ï¼‰çš„åˆ›å»ºè¿‡ç¨‹å’Œå…·ä½“å®ç°\nSpring ä¸­å…¶å®ƒå·¥å‚ï¼š\n\norg.springframework.beans.factory.FactoryBean\n\n@Bean æ ‡æ³¨çš„é™æ€æ–¹æ³•åŠå®ä¾‹æ–¹æ³•\n\nObjectFactory åŠ ObjectProvider\n\n\nå‰ä¸¤ç§å·¥å‚ä¸»è¦å°è£…ç¬¬ä¸‰æ–¹çš„ bean çš„åˆ›å»ºè¿‡ç¨‹ï¼Œåä¸¤ç§å·¥å‚å¯ä»¥æ¨è¿Ÿ bean åˆ›å»ºï¼Œè§£å†³å¾ªç¯ä¾èµ–åŠå•ä¾‹æ³¨å…¥å¤šä¾‹ç­‰é—®é¢˜\n4.Springä¸­çš„Adapter(é€‚é…å™¨æ¨¡å¼)å®šä¹‰ Convert the interface of a class into another interface clients expect. Adapter lets classes work together that couldnâ€™t otherwise because of incompatible interfaces å³ å°†ä¸€ä¸ªç±»çš„æ¥å£è½¬æ¢ä¸ºå¦ä¸€ä¸ªå®¢æˆ·ç«¯æ‰€æœŸæœ›çš„æ¥å£ã€‚é€‚é…å™¨æ¨¡å¼å¯ä»¥è®©åŸæœ¬ç”±äºæ¥å£ä¸å…¼å®¹è€Œæ— æ³•ä¸€èµ·å·¥ä½œçš„ç±»èƒ½å¤ŸååŒå·¥ä½œã€‚\nå…¸å‹çš„å®ç°æœ‰ä¸¤å¤„:\n\norg.springframework.web.servlet.HandlerAdapter â€“ å› ä¸ºæ§åˆ¶å™¨å®ç°æœ‰å„ç§å„æ ·ï¼Œæ¯”å¦‚æœ‰\n@RequestMapping æ ‡æ³¨çš„æ§åˆ¶å™¨å®ç°\nä¼ ç»Ÿçš„åŸºäº Controller æ¥å£ï¼ˆä¸æ˜¯ @Controlleræ³¨è§£å•Šï¼‰çš„å®ç°\nè¾ƒæ–°çš„åŸºäº RouterFunction æ¥å£çš„å®ç°\nå®ƒä»¬çš„å¤„ç†æ–¹æ³•éƒ½ä¸ä¸€æ ·ï¼Œä¸ºäº†ç»Ÿä¸€è°ƒç”¨ï¼Œå¿…é¡»é€‚é…ä¸º HandlerAdapter æ¥å£\n\n\norg.springframework.beans.factory.support.DisposableBeanAdapter â€“ å› ä¸ºé”€æ¯æ–¹æ³•å¤šç§å¤šæ ·ï¼Œå› æ­¤éƒ½è¦é€‚é…ä¸º DisposableBean æ¥ç»Ÿä¸€è°ƒç”¨é”€æ¯æ–¹æ³•\n\n5.Springä¸­çš„Composite(ç»„åˆæ¨¡å¼)å®šä¹‰ Compose objects into tree structures to represent part-whole hierarchies. Composite lets clients treat individual objects and compositions of objects uniformly  å³å°†å¯¹è±¡ç»„åˆæˆæ ‘å½¢ç»“æ„æ¥è¡¨ç¤ºéƒ¨åˆ†-æ•´ä½“å±‚æ¬¡ç»“æ„ã€‚ç»„åˆæ¨¡å¼å¯ä»¥è®©å®¢æˆ·ç«¯ç»Ÿä¸€åœ°å¯¹å¾…å•ä¸ªå¯¹è±¡å’Œå¯¹è±¡ç»„åˆã€‚\nå…¸å‹å®ç°æœ‰ï¼š\n\norg.springframework.web.method.support.HandlerMethodArgumentResolverComposite\norg.springframework.web.method.support.HandlerMethodReturnValueHandlerComposite\norg.springframework.web.servlet.handler.HandlerExceptionResolverComposite\norg.springframework.web.servlet.view.ViewResolverComposite\n\ncomposite å¯¹è±¡çš„ä½œç”¨æ˜¯ï¼Œå°†åˆ†æ•£çš„è°ƒç”¨é›†ä¸­èµ·æ¥ï¼Œç»Ÿä¸€è°ƒç”¨å…¥å£ï¼Œå®ƒçš„ç‰¹å¾æ˜¯ï¼šä¸å…·ä½“å¹²æ´»çš„ç±»å®ç°åŒä¸€ä¸ªæ¥å£ï¼Œå½“è°ƒç”¨ composite å¯¹è±¡çš„æ¥å£æ–¹æ³•æ—¶ï¼Œå…¶å®æ˜¯å§”æ‰˜å…·ä½“å¹²æ´»çš„ç±»å®ç°æ¥å®Œæˆ                                                                     \n6.Springä¸­çš„Decorator(è£…é¥°å™¨æ¨¡å¼)å®šä¹‰ Attach additional responsibilities to an object dynamically. Decorators provide a flexible alternative to subclassing for extending functionality å³ å‘å¯¹è±¡åŠ¨æ€åœ°é™„åŠ èŒè´£ã€‚ è£…é¥°å™¨æä¾›äº†ä¸€ç§çµæ´»çš„æ›¿ä»£ç»§æ‰¿çš„æ–¹å¼ï¼Œä»¥æ‰©å±•åŠŸèƒ½ã€‚\nå…¸å‹å®ç°ï¼š\n\norg.springframework.web.util.ContentCachingRequestWrapper\n\nContentCachingRequestWrapper é€šè¿‡åŒ…è£… HttpServletRequest å¯¹è±¡ï¼Œæä¾›äº†å¯¹è¾“å…¥æµè¿›è¡Œé‡å¤è¯»å–å’Œç¼“å­˜çš„åŠŸèƒ½ã€‚å…¶æ„é€ å‡½æ•°éœ€è¦ä¼ å…¥ä¸€ä¸ªåŸå§‹çš„ HttpServletRequest å¯¹è±¡ï¼Œç„¶åä½¿ç”¨è‡ªå·±çš„ ByteArrayOutputStream ç¼“å­˜è¯·æ±‚ä½“ï¼ŒåŒæ—¶æä¾›äº†å¤šä¸ªæ–¹æ³•æ¥è·å–è¯·æ±‚ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼š\n\ngetContentAsByteArray() : è·å–è¯·æ±‚çš„å†…å®¹ï¼ˆbyte æ•°ç»„ï¼‰ï¼Œå¦‚æœè¯·æ±‚å†…å®¹è¢«ç¼“å­˜äº†ï¼Œåˆ™è¿”å›ç¼“å­˜çš„å†…å®¹ï¼Œå¦åˆ™è¯»å–å¹¶è¿”å›åŸå§‹å†…å®¹ã€‚\ngetContentAsStream() : è¿”å›è¯·æ±‚çš„å†…å®¹æµï¼ˆServletInputStreamï¼‰ï¼Œå¦‚æœè¯·æ±‚å†…å®¹è¢«ç¼“å­˜äº†ï¼Œåˆ™è¿”å›ç¼“å­˜çš„å†…å®¹ï¼Œå¦åˆ™è¯»å–å¹¶è¿”å›åŸå§‹å†…å®¹ã€‚\ngetReader() : è¿”å›ä¸€ä¸ªè¯»å–è¯·æ±‚å†…å®¹çš„ BufferedReader å®ä¾‹ï¼Œå¦‚æœè¯·æ±‚å†…å®¹è¢«ç¼“å­˜äº†ï¼Œåˆ™è¿”å›ç¼“å­˜çš„å†…å®¹ï¼Œå¦åˆ™è¯»å–å¹¶è¿”å›åŸå§‹å†…å®¹ã€‚\n\næ€»çš„æ¥è¯´ï¼ŒContentCachingRequestWrapper çš„å®ç°éå¸¸å¥½åœ°ä½“ç°äº†è£…é¥°å™¨æ¨¡å¼çš„æ€æƒ³ï¼Œé€šè¿‡åŒ…è£…åŸå§‹è¯·æ±‚å¯¹è±¡ï¼Œæä¾›äº†é¢å¤–çš„åŠŸèƒ½ï¼Œå¹¶ä¸”ä¸æ”¹å˜åŸå§‹å¯¹è±¡çš„è¡Œä¸ºï¼Œä»è€Œå®ç°äº†è¯·æ±‚ä½“çš„ç¼“å­˜å’Œå¤šæ¬¡è¯»å–ã€‚\n7.Springä¸­çš„Proxy(ä»£ç†æ¨¡å¼)å®šä¹‰ Provide a surrogate or placeholder for another object to control access to it å³ï¼Œä¸ºå¦ä¸€ä¸ªå¯¹è±¡æä¾›ä¸€ä¸ªä»£ç†æˆ–å ä½ç¬¦æ¥æ§åˆ¶å¯¹å®ƒçš„è®¿é—®ã€‚\nä»£ç†æ¨¡å¼çš„ä¸»è¦ç›®çš„æ˜¯æ§åˆ¶å¯¹ç›®æ ‡å¯¹è±¡çš„è®¿é—®ï¼Œåœ¨ä¸æ”¹å˜åŸæœ‰ä»£ç çš„æƒ…å†µä¸‹ï¼Œä¸ºå¯¹è±¡æä¾›ä¸€ç§é—´æ¥è®¿é—®çš„æ–¹å¼ã€‚ä»£ç†æ¨¡å¼åœ¨å®¢æˆ·ç«¯å’Œç›®æ ‡å¯¹è±¡ä¹‹é—´åˆ›å»ºäº†ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œå®¢æˆ·ç«¯é€šè¿‡ä»£ç†å¯¹è±¡æ¥è®¿é—®ç›®æ ‡å¯¹è±¡ï¼Œä»è€Œå¯ä»¥å¯¹è®¿é—®è¿›è¡Œæ§åˆ¶ã€‚ä»£ç†æ¨¡å¼å¯ä»¥ç”¨äºä¿æŠ¤ç›®æ ‡å¯¹è±¡çš„è®¿é—®æ€§ã€ç¼“å­˜å¯¹è±¡ç­‰ã€‚\nä¸è£…é¥°å™¨æ¨¡å¼çš„åŒºåˆ«\nè£…é¥°å™¨æ¨¡å¼æ³¨é‡çš„æ˜¯åŠŸèƒ½å¢å¼ºï¼Œé¿å…å­ç±»ç»§æ‰¿æ–¹å¼è¿›è¡ŒåŠŸèƒ½æ‰©å±•ï¼Œè€Œä»£ç†æ¨¡å¼æ›´æ³¨é‡æ§åˆ¶ç›®æ ‡çš„è®¿é—®\nå…¸å‹å®ç°ï¼š\n\norg.springframework.aop.framework.JdkDynamicAopProxy\norg.springframework.aop.framework.ObjenesisCglibAopProxy\n\n8.Springä¸­çš„Chain of Responsibility(è´£ä»»é“¾æ¨¡å¼)å®šä¹‰ Avoid coupling the sender of a request to its receiver by giving more than one object a chance to handle the request. Chain the receiving objects and pass the request along the chain until an object handles it å³ é¿å…ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡ç›´æ¥è°ƒç”¨å¦ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œæ˜¯é€šè¿‡å°†è¯·æ±‚ä¼ é€’ç»™å¤šä¸ªå¯¹è±¡ä¸­çš„ä¸€ä¸ªæ¥å¤„ç†è¯·æ±‚ã€‚å°†æ¥æ”¶å¯¹è±¡é“¾æ¥åœ¨ä¸€èµ·ï¼Œå¹¶å°†è¯·æ±‚æ²¿ç€é“¾ä¼ é€’ï¼Œç›´åˆ°ä¸€ä¸ªå¯¹è±¡èƒ½å¤Ÿå¤„ç†å®ƒã€‚\nå…¸å‹å®ç°ï¼š\n\norg.springframework.web.servlet.HandlerInterceptor\n\nHandlerInterceptoræ”¯æŒè´£ä»»é“¾æ¨¡å¼ï¼Œé€šè¿‡é“¾å¼è°ƒç”¨å¤šä¸ªHandlerInterceptorï¼Œå¯ä»¥å¤„ç†åŒä¸€ä¸ªè¯·æ±‚çš„å¤šä¸ªè¿™æ ·çš„æ‹¦æˆªå™¨ã€‚\nå½“ä¸€ä¸ªè¯·æ±‚åˆ°è¾¾åç«¯æ§åˆ¶å™¨å‰ï¼Œå¯ä»¥é€šè¿‡å¤šä¸ªHandlerInterceptoræŒ‰ç…§ç‰¹å®šçš„é¡ºåºè¿›è¡Œå¤„ç†ã€‚æ¯ä¸ªHandlerInterceptorå¯ä»¥å¤„ç†è¯·æ±‚ï¼Œç„¶åå°†å¤„ç†ç»“æœä¼ é€’ç»™ä¸‹ä¸€ä¸ªHandlerInterceptorã€‚è¿™æ ·ï¼Œå°±å½¢æˆäº†ä¸€ä¸ªè´£ä»»é“¾ã€‚\nåœ¨è´£ä»»é“¾æ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åŠ¨æ€æ·»åŠ æˆ–åˆ é™¤HandlerInterceptorï¼Œå¹¶ä¸”å¯ä»¥å®šä¹‰å¤šä¸ªæ‹¦æˆªå™¨é“¾ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€äº›å¤æ‚çš„å¤„ç†é€»è¾‘ï¼Œå°†è¯·æ±‚æŒ‰ç…§ä¸åŒçš„æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œä»¥è¾¾åˆ°æ›´å¥½çš„æ•ˆæœã€‚\n9.Spring ä¸­çš„ Observer(è§‚å¯Ÿè€…æ¨¡å¼)å®šä¹‰ Define a one-to-many dependency between objects so that when one object changes state, all its dependents are notified and updated automatically å³ å®šä¹‰ä¸€ç§ä¸€å¯¹å¤šçš„å¯¹è±¡ä¾èµ–å…³ç³»ï¼Œè¿™æ ·å½“ä¸€ä¸ªå¯¹è±¡æ”¹å˜çŠ¶æ€æ—¶ï¼Œæ‰€æœ‰å…¶ä¾èµ–è€…å°†è‡ªåŠ¨å¾—åˆ°é€šçŸ¥å¹¶æ›´æ–°ã€‚\nå…¸å‹å®ç°ï¼š\n\norg.springframework.context.ApplicationListener\norg.springframework.context.event.ApplicationEventMulticaster\norg.springframework.context.ApplicationEvent\n\nä¸€ä¸ªäº‹ä»¶ï¼ˆApplicationEventï¼‰å¯ä»¥è¢«ApplicationContextä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªApplicationListeneræ‰€ç›‘å¬ã€‚ApplicationContextä¼šåœ¨äº‹ä»¶å‘ç”Ÿæ—¶é€šçŸ¥å·²æ³¨å†Œçš„ApplicationListenerï¼Œå¹¶ç”±ApplicationListeneræ¥è´Ÿè´£å¯¹è¯¥äº‹ä»¶åšå‡ºå“åº”ã€‚\nä¸ºäº†å®ç°è¿™ç§æ¨¡å¼ï¼ŒSpringæä¾›äº†ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š\n\nApplicationEventï¼šä»£è¡¨äº†ä¸€ä¸ªåº”ç”¨ç¨‹åºä¸­å‘ç”Ÿçš„äº‹ä»¶ï¼ŒåŒ…å«äº†äº‹ä»¶çš„ä¿¡æ¯ã€‚\nApplicationListenerï¼šè´Ÿè´£å¤„ç†äº‹ä»¶ï¼Œå¹¶è¿›è¡Œå“åº”çš„ç»„ä»¶ã€‚\nApplicationEventMulticasterï¼šç”¨äºç®¡ç†äº‹ä»¶ç›‘å¬å™¨ï¼Œè´Ÿè´£å°†äº‹ä»¶åˆ†å‘ç»™å¯¹åº”çš„ç›‘å¬å™¨è¿›è¡Œå¤„ç†ã€‚\n\nå½“ä¸€ä¸ªäº‹ä»¶è¢«è§¦å‘æ—¶ï¼ŒApplicationEventMulticasterä¼šè°ƒç”¨æ‰€æœ‰å·²æ³¨å†Œçš„ApplicationListenerå®ä¾‹çš„onApplicationEvent()æ–¹æ³•æ¥è¿›è¡Œå¤„ç†ã€‚å½“äº‹ä»¶è¢«å¤šä¸ªApplicationListenerç›‘å¬æ—¶ï¼ŒApplicationEventMulticasterä¼šæŒ‰é¡ºåºè°ƒç”¨å®ƒä»¬çš„onApplicationEvent()æ–¹æ³•ã€‚\nå› æ­¤ï¼ŒSpringçš„äº‹ä»¶é©±åŠ¨æ¨¡å‹å°±ä½“ç°äº†è§‚å¯Ÿè€…æ¨¡å¼çš„ç‰¹å¾ï¼Œå…¶ä¸­ApplicationListenerå……å½“äº†è§‚å¯Ÿè€…çš„è§’è‰²ï¼ŒApplicationEventMulticasterå……å½“äº†è¢«è§‚å¯Ÿè€…çš„è§’è‰²ã€‚\n10. Spring ä¸­çš„ Strategy(ç­–ç•¥æ¨¡å¼)å®šä¹‰ Define a family of algorithms, encapsulate each one, and make them interchangeable. Strategy lets the algorithm vary independently from clients that use it å³ï¼Œå®šä¹‰ä¸€ä¸ªç®—æ³•æ—ï¼Œå°†æ¯ä¸ªç®—æ³•å°è£…èµ·æ¥ï¼Œä½¿å®ƒä»¬å¯ä»¥äº’æ¢ã€‚ç­–ç•¥æ¨¡å¼èƒ½å¤Ÿè®©ç®—æ³•çš„å˜åŒ–ç‹¬ç«‹äºä½¿ç”¨å®ƒä»¬çš„å®¢æˆ·ç«¯ã€‚\nå…¸å‹å®ç°ï¼š\n\norg.springframework.beans.factory.support.InstantiationStrategy\norg.springframework.core.annotation.MergedAnnotations.SearchStrategy\norg.springframework.boot.autoconfigure.condition.SearchStrategy\n\norg.springframework.beans.factory.support.InstantiationStrategyï¼šå­˜åœ¨å¤šä¸ªå®ç°InstantiationStrategyæ¥å£çš„ç±»ï¼Œè¿™äº›ç±»éƒ½å®ç°äº†ä¸åŒçš„å®ä¾‹åŒ–ç­–ç•¥ï¼Œæ¯”å¦‚ï¼šCglibSubclassingInstantiationStrategyã€SimpleInstantiationStrategyå’ŒSmartInstantiationStrategyç­‰ã€‚è¿™äº›å®ç°ç±»å¯ä»¥æ ¹æ®å®é™…æƒ…å†µå–èˆï¼Œé€šè¿‡ç­–ç•¥æ¨¡å¼å®ç°äº†å®ä¾‹åŒ–ç­–ç•¥çš„åŠ¨æ€åˆ‡æ¢ã€‚\norg.springframework.core.annotation.MergedAnnotations.SearchStrategyï¼šå­˜åœ¨å¤šä¸ªå®ç°SearchStrategyæ¥å£çš„ç±»ï¼Œè¿™äº›ç±»éƒ½å®ç°äº†ä¸åŒçš„æ³¨è§£æŸ¥æ‰¾ç­–ç•¥ï¼Œæ¯”å¦‚ï¼šTypeMappedAnnotationCheckerã€RepeatableContainersã€DirectlyDeclaredAnnotationså’ŒSynthesizedAnnotationDetectionç­‰ã€‚è¿™äº›å®ç°ç±»å¯ä»¥æ ¹æ®å®é™…æƒ…å†µå–èˆï¼Œé€šè¿‡ç­–ç•¥æ¨¡å¼å®ç°äº†æ³¨è§£æŸ¥æ‰¾ç­–ç•¥çš„åŠ¨æ€åˆ‡æ¢ã€‚\norg.springframework.boot.autoconfigure.condition.SearchStrategyï¼šå­˜åœ¨å¤šä¸ªå®ç°SearchStrategyæ¥å£çš„ç±»ï¼Œè¿™äº›ç±»éƒ½å®ç°äº†ä¸åŒçš„æ¡ä»¶åˆ¤æ–­ç­–ç•¥ï¼Œæ¯”å¦‚ï¼šOnClassConditionã€ConditionalOnWebApplicationå’ŒConditionalOnPropertyç­‰ã€‚è¿™äº›å®ç°ç±»å¯ä»¥æ ¹æ®å®é™…æƒ…å†µå–èˆï¼Œé€šè¿‡ç­–ç•¥æ¨¡å¼å®ç°äº†æ¡ä»¶åˆ¤æ–­ç­–ç•¥çš„åŠ¨æ€åˆ‡æ¢ã€‚\n11. Spring ä¸­çš„ Template Method(æ¨¡æ¿æ–¹æ³•)å®šä¹‰ Define the skeleton of an algorithm in an operation, deferring some steps to subclasses. Template Method lets subclasses redefine certain steps of an algorithm without changing the algorithmâ€™s structure  åœ¨ä¸€ä¸ªæ“ä½œä¸­å®šä¹‰ç®—æ³•çš„æ¡†æ¶ï¼Œå°†æŸäº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­ã€‚æ¨¡æ¿æ–¹æ³•è®©å­ç±»é‡æ–°å®šä¹‰ç®—æ³•çš„æŸäº›æ­¥éª¤ï¼Œè€Œä¸æ”¹å˜ç®—æ³•çš„ç»“æ„ã€‚\nå…¸å‹å®ç°ï¼š\n\nå¤§éƒ¨åˆ†ä»¥ Template å‘½åçš„ç±»ï¼Œå¦‚ JdbcTemplateï¼ŒTransactionTemplate\nå¾ˆå¤šä»¥ Abstract å‘½åçš„ç±»ï¼Œå¦‚ AbstractApplicationContext\n\nåœ¨JdbcTemplateä¸­ï¼Œæ¨¡æ¿æ–¹æ³•æ˜¯execute()æ–¹æ³•ï¼Œå®ƒå°è£…äº†æ‰§è¡ŒSQLè¯­å¥çš„æµç¨‹ï¼Œå…·ä½“çš„SQLè¯­å¥å¯ä»¥é€šè¿‡ä¼ å…¥ä¸åŒçš„å‚æ•°æ¥å®ç°ã€‚execute()æ–¹æ³•ä¸­åŒ…å«äº†ä¸€äº›å›ºå®šçš„æ­¥éª¤ï¼Œå¦‚è·å–è¿æ¥ã€åˆ›å»ºStatementã€æ‰§è¡ŒSQLè¯­å¥ã€å…³é—­èµ„æºç­‰ï¼Œè¿™äº›æ­¥éª¤æ˜¯ä¸å˜çš„ï¼Œä½†æ˜¯å…·ä½“çš„SQLè¯­å¥å’Œå‚æ•°æ˜¯å¯ä»¥å˜åŒ–çš„ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒJdbcTemplateå°†é‡å¤çš„ã€æ³›åŒ–çš„æ“ä½œå°è£…åˆ°æ¨¡æ¿æ–¹æ³•ä¸­ï¼Œä½¿å¾—ä½¿ç”¨è€…åªéœ€è¦å…³æ³¨å…·ä½“çš„SQLè¯­å¥å’Œå‚æ•°ã€‚\nTransactionTemplateä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œåœ¨Springäº‹åŠ¡ç®¡ç†ä¸­ï¼Œå®ƒå°è£…äº†æ‰§è¡Œäº‹åŠ¡çš„æµç¨‹ï¼Œå…·ä½“çš„äº‹åŠ¡æ“ä½œå¯ä»¥é€šè¿‡ä¼ å…¥ä¸åŒçš„å‚æ•°æ¥å®ç°ã€‚TransactionTemplateä¸­çš„æ¨¡æ¿æ–¹æ³•æ˜¯execute()æ–¹æ³•ï¼Œå®ƒåŒ…å«äº†è·å–äº‹åŠ¡ã€æ‰§è¡Œæ–¹æ³•ã€æäº¤&#x2F;å›æ»šäº‹åŠ¡ç­‰å›ºå®šæ­¥éª¤ï¼Œè¿™äº›æ­¥éª¤æ˜¯æ¯ä¸ªäº‹åŠ¡æ“ä½œéƒ½å¿…é¡»è¦æ‰§è¡Œçš„ï¼Œä½†æ˜¯å…·ä½“çš„äº‹åŠ¡æ“ä½œå¯ä»¥æ”¹å˜ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒTransactionTemplateå°†äº‹åŠ¡ç®¡ç†çš„å¤æ‚æ€§å°è£…åˆ°æ¨¡æ¿æ–¹æ³•ä¸­ï¼Œä½¿ç”¨è€…åªéœ€è¦å…³æ³¨è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸éœ€è¦å…³å¿ƒäº‹åŠ¡çš„ç®¡ç†ã€‚\nåœ¨AbstractApplicationContextä¸­ï¼Œæ¨¡æ¿æ–¹æ³•æ˜¯refresh()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åŒ…å«äº†Springå®¹å™¨çš„åˆå§‹åŒ–æµç¨‹ï¼Œå…·ä½“çš„åˆå§‹åŒ–è¿‡ç¨‹å¯ä»¥é€šè¿‡ç»§æ‰¿AbstractApplicationContextçš„å­ç±»æ¥å®ç°ã€‚refresh()æ–¹æ³•ä¸­åŒ…å«äº†ä¸€äº›å›ºå®šçš„æ­¥éª¤ï¼Œæ¯”å¦‚è¯»å–é…ç½®æ–‡ä»¶ã€åˆ›å»º&#x2F;åˆå§‹åŒ–BeanFactoryã€åŠ è½½Beanå®šä¹‰ã€æ³¨å†ŒBeanPostProcessorç­‰ï¼Œè¿™äº›æ­¥éª¤æ˜¯ä¸å˜çš„ï¼Œä½†æ˜¯å…·ä½“çš„å®ç°å¯ä»¥æ”¹å˜ã€‚å­ç±»æ ¹æ®è‡ªå·±çš„éœ€è¦ï¼Œå¯ä»¥é€šè¿‡é‡å†™refresh()æ–¹æ³•ä¸­çš„ä¸€äº›æ­¥éª¤æ¥å®ç°è‡ªå·±çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œæ¯”å¦‚è¯»å–ä¸åŒçš„é…ç½®æ–‡ä»¶ã€ä½¿ç”¨ä¸åŒçš„BeanFactoryç­‰ã€‚\né€šè¿‡è¿™ç§æ–¹å¼ï¼ŒAbstractApplicationContextå°†Springå®¹å™¨çš„åˆå§‹åŒ–è¿‡ç¨‹å°è£…åˆ°æ¨¡æ¿æ–¹æ³•ä¸­ï¼Œä½¿å¾—ä½¿ç”¨è€…åªéœ€è¦å…³æ³¨å…·ä½“çš„Beançš„é…ç½®å’Œä½¿ç”¨ï¼Œè€Œä¸éœ€è¦å…³å¿ƒSpringå®¹å™¨çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚è¿™æ ·å¯ä»¥å¤§å¤§ç®€åŒ–ä»£ç çš„ç¼–å†™å’Œç»´æŠ¤ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚\n","slug":"Springä¸­çš„è®¾è®¡æ¨¡å¼","date":"2023-05-09T04:00:50.000Z","categories_index":"","tags_index":"Java,è®¾è®¡æ¨¡å¼,Spring,é¢è¯•é¢˜","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"5e422a9b2c69bd7294ec71b84cbbb53b","title":"å•ä¾‹æ¨¡å¼","content":"ä»€ä¹ˆæ˜¯å•ä¾‹æ¨¡å¼ï¼Ÿå•ä¾‹æ¨¡å¼çš„ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿå•ä¾‹æ¨¡å¼å±äºåˆ›å»ºå‹æ¨¡å¼ï¼Œâ¼€ä¸ªå•ä¾‹ç±»åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½åªå­˜åœ¨â¼€ä¸ªå®ä¾‹ï¼Œ\næ„é€ â½…æ³•å¿…é¡»æ˜¯ç§æœ‰çš„ã€ç”±â¾ƒâ¼°åˆ›å»ºâ¼€ä¸ªé™æ€å˜é‡å­˜å‚¨å®ä¾‹ï¼Œå¯¹å¤–æä¾›â¼€\nä¸ªé™æ€å…¬æœ‰â½…æ³•è·å–å®ä¾‹ã€‚\nä¼˜ç‚¹æ˜¯å†…å­˜ä¸­åªæœ‰â¼€ä¸ªå®ä¾‹ï¼Œå‡å°‘äº†å¼€é”€ï¼Œå°¤å…¶æ˜¯é¢‘ç¹åˆ›å»ºå’Œé”€æ¯å®ä¾‹çš„\næƒ…å†µä¸‹å¹¶ä¸”å¯ä»¥é¿å…å¯¹èµ„æºçš„å¤šé‡å â½¤ã€‚ç¼ºç‚¹æ˜¯æ²¡æœ‰æŠ½è±¡å±‚ï¼Œéš¾ä»¥æ‰©å±•ï¼Œ\nä¸å•â¼€èŒè´£åŸåˆ™å†²çªã€‚\nå•ä¾‹æ¨¡å¼çš„å¸¸â»…å†™æ³•æœ‰å“ªäº›ï¼Ÿé¥¿æ±‰å¼é¡¾åæ€ä¹‰ï¼Œç±»â¼€åŠ è½½å°±åˆ›å»ºå¯¹è±¡ï¼Œè¿™ç§â½…å¼â½è¾ƒå¸¸â½¤ï¼Œä½†å®¹æ˜“äº§â½£åƒåœ¾å¯¹è±¡ï¼Œæµªè´¹å†…å­˜ç©ºé—´ã€‚\n\nä¼˜ç‚¹ï¼šçº¿ç¨‹å®‰å…¨ï¼Œæ²¡æœ‰åŠ é”ï¼Œæ‰§â¾æ•ˆç‡è¾ƒâ¾¼\n\nç¼ºç‚¹ï¼šä¸æ˜¯æ‡’åŠ è½½ï¼Œç±»åŠ è½½æ—¶å°±åˆå§‹åŒ–ï¼Œæµªè´¹å†…å­˜ç©ºé—´\n\n\n\nçº¿ç¨‹å®‰å…¨ï¼šé¥¿æ±‰å¼å•ä¾‹æ˜¯å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨çš„å‘¢ï¼Ÿå®ƒæ˜¯åŸºäºç±»åŠ è½½æœºåˆ¶é¿å…äº†å¤šçº¿ç¨‹\nçš„åŒæ­¥é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœç±»è¢«ä¸åŒçš„ç±»åŠ è½½å™¨åŠ è½½å°±ä¼šåˆ›å»ºä¸åŒçš„å®ä¾‹ã€‚\n\n\npublic class Singleton &#123;\n // 1ã€ç§æœ‰åŒ–æ„é€ â½…æ³•\n private Singleton()&#123;&#125;\n // 2ã€å®šä¹‰â¼€ä¸ªé™æ€å˜é‡æŒ‡å‘â¾ƒâ¼°ç±»å‹\n private final static Singleton instance = new\nSingleton();\n // 3ã€å¯¹å¤–æä¾›â¼€ä¸ªå…¬å…±çš„â½…æ³•è·å–å®ä¾‹\n public static Singleton getInstance() &#123;\n return instance;\n &#125;\n&#125;\n\nä½¿â½¤åå°„ç ´åå•ä¾‹public class Test &#123;\n public static void main(String[] args) throws\nException&#123;\n // ä½¿â½¤åå°„ç ´åå•ä¾‹\n // è·å–ç©ºå‚æ„é€ â½…æ³•\n Constructor&lt;Singleton> declaredConstructor =\nSingleton.class.getDeclaredConstructor(null);\n // è®¾ç½®å¼ºåˆ¶è®¿é—®\n declaredConstructor.setAccessible(true);\n // åˆ›å»ºå®ä¾‹\n Singleton singleton =\ndeclaredConstructor.newInstance();\n System.out.println(\"åå°„åˆ›å»ºçš„å®ä¾‹\" + singleton);\n System.out.println(\"æ­£å¸¸åˆ›å»ºçš„å®ä¾‹\" +\nSingleton.getInstance());\n System.out.println(\"æ­£å¸¸åˆ›å»ºçš„å®ä¾‹\" +\nSingleton.getInstance());\n &#125;\n&#125;\n\nè¾“å‡ºç»“æœå¦‚ä¸‹åå°„åˆ›å»ºçš„å®ä¾‹\ncom.example.spring.demo.single.Singleton@6267c3bb\næ­£å¸¸åˆ›å»ºçš„å®ä¾‹\ncom.example.spring.demo.single.Singleton@533ddba\næ­£å¸¸åˆ›å»ºçš„å®ä¾‹\ncom.example.spring.demo.single.Singleton@533ddba\n\nçº¿ç¨‹ä¸å®‰å…¨çš„æ‡’æ±‰å¼è¿™ç§â½…å¼åœ¨å•çº¿ç¨‹ä¸‹ä½¿â½¤æ²¡æœ‰é—®é¢˜ï¼Œå¯¹äºå¤šçº¿ç¨‹æ˜¯â½†æ³•ä¿è¯å•ä¾‹çš„ï¼Œè¿™â¾¥åˆ—å‡ºæ¥æ˜¯ä¸ºäº†å’Œåâ¾¯ä½¿â½¤é”ä¿è¯çº¿ç¨‹å®‰å…¨çš„å•ä¾‹åšå¯¹â½\n\nä¼˜ç‚¹ï¼šæ‡’åŠ è½½\nç¼ºç‚¹ï¼šçº¿ç¨‹ä¸å®‰å…¨\n\n//çº¿ç¨‹ä¸å®‰å…¨çš„æ‡’æ±‰å¼å•ä¾‹\npublic class Singleton &#123;\n // 1ã€ç§æœ‰åŒ–æ„é€ â½…æ³•\n private Singleton()&#123; &#125;\n // 2ã€å®šä¹‰â¼€ä¸ªé™æ€å˜é‡æŒ‡å‘â¾ƒâ¼°ç±»å‹\n private static Singleton instance;\n // 3ã€å¯¹å¤–æä¾›â¼€ä¸ªå…¬å…±çš„â½…æ³•è·å–å®ä¾‹\n public static Singleton getInstance() &#123;\n // åˆ¤æ–­ä¸º null çš„æ—¶å€™å†åˆ›å»ºå¯¹è±¡\n if (instance == null) &#123;\n instance = new Singleton();\n &#125;\n return instance;\n &#125;\n&#125;\n\nçº¿ç¨‹å®‰å…¨çš„æ‡’æ±‰å¼æ‡’æ±‰å¼å•ä¾‹å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨å‘¢ï¼Ÿé€šè¿‡ synchronized å…³é”®å­—åŠ é”ä¿è¯çº¿ç¨‹\nå®‰å…¨ï¼Œ synchronized å¯ä»¥æ·»åŠ åœ¨â½…æ³•ä¸Šâ¾¯ï¼Œä¹Ÿå¯ä»¥æ·»åŠ åœ¨ä»£ç å—ä¸Šâ¾¯ï¼Œè¿™\nâ¾¥æ¼”ç¤ºæ·»åŠ åœ¨â½…æ³•ä¸Šâ¾¯ï¼Œå­˜åœ¨çš„é—®é¢˜æ˜¯ æ¯â¼€æ¬¡è°ƒâ½¤ getInstance è·å–å®ä¾‹æ—¶\néƒ½éœ€è¦åŠ é”å’Œé‡Šæ”¾é”ï¼Œè¿™æ ·æ˜¯â¾®å¸¸å½±å“æ€§èƒ½çš„ã€‚\n\nä¼˜ç‚¹ï¼šæ‡’åŠ è½½ï¼Œçº¿ç¨‹å®‰å…¨\n\nç¼ºç‚¹ï¼šæ•ˆç‡è¾ƒä½\n\n\n//æ‡’æ±‰å¼å•ä¾‹ï¼Œâ½…æ³•ä¸Šâ¾¯æ·»åŠ  synchronized ä¿è¯çº¿ç¨‹å®‰å…¨\npublic class Singleton &#123;\n // 1ã€ç§æœ‰åŒ–æ„é€ â½…æ³•\n private Singleton()&#123; &#125;\n // 2ã€å®šä¹‰â¼€ä¸ªé™æ€å˜é‡æŒ‡å‘â¾ƒâ¼°ç±»å‹\n private static Singleton instance;\n // 3ã€å¯¹å¤–æä¾›â¼€ä¸ªå…¬å…±çš„â½…æ³•è·å–å®ä¾‹\n public synchronized static Singleton getInstance() &#123;\n if (instance == null) &#123;\n instance = new Singleton();\n &#125;\n return instance;\n    &#125;\n&#125;\n\nåŒé‡æ£€æŸ¥é”(DCL)è¿™â¾¥çš„åŒé‡æ£€æŸ¥æ˜¯æŒ‡ä¸¤æ¬¡â¾®ç©ºåˆ¤æ–­ï¼Œé”æŒ‡çš„æ˜¯ synchronized åŠ é”ï¼Œä¸ºä»€ä¹ˆ\nè¦è¿›â¾åŒé‡åˆ¤æ–­ï¼Œå…¶å®å¾ˆç®€å•ï¼Œç¬¬â¼€é‡åˆ¤æ–­ï¼Œå¦‚æœå®ä¾‹å·²ç»å­˜åœ¨ï¼Œé‚£ä¹ˆå°±\nä¸å†éœ€è¦è¿›â¾åŒæ­¥æ“ä½œï¼Œâ½½æ˜¯ç›´æ¥è¿”å›è¿™ä¸ªå®ä¾‹ï¼Œå¦‚æœæ²¡æœ‰åˆ›å»ºï¼Œæ‰ä¼šè¿›\nâ¼ŠåŒæ­¥å—ï¼ŒåŒæ­¥å—çš„â½¬çš„ä¸ä¹‹å‰ç›¸åŒï¼Œâ½¬çš„æ˜¯ä¸ºäº†é˜²â½Œæœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒ\nâ½¤æ—¶ï¼Œå¯¼è‡´â½£æˆå¤šä¸ªå®ä¾‹ï¼Œæœ‰äº†åŒæ­¥å—ï¼Œæ¯æ¬¡åªèƒ½æœ‰â¼€ä¸ªçº¿ç¨‹è°ƒâ½¤è®¿é—®åŒ\næ­¥å—å†…å®¹ï¼Œå½“ç¬¬â¼€ä¸ªæŠ¢åˆ°é”çš„è°ƒâ½¤è·å–äº†å®ä¾‹ä¹‹åï¼Œè¿™ä¸ªå®ä¾‹å°±ä¼šè¢«åˆ›\nå»ºï¼Œä¹‹åçš„æ‰€æœ‰è°ƒâ½¤éƒ½ä¸ä¼šè¿›â¼ŠåŒæ­¥å—ï¼Œç›´æ¥åœ¨ç¬¬â¼€é‡åˆ¤æ–­å°±è¿”å›äº†å•\nä¾‹ã€‚\nå…³äºå†…éƒ¨çš„ç¬¬â¼†é‡ç©ºåˆ¤æ–­çš„ä½œâ½¤ï¼Œå½“å¤šä¸ªçº¿ç¨‹â¼€èµ·åˆ°è¾¾é”ä½ç½®æ—¶ï¼Œè¿›â¾é”\nç«äº‰ï¼Œå…¶ä¸­â¼€ä¸ªçº¿ç¨‹è·å–é”ï¼Œå¦‚æœæ˜¯ç¬¬â¼€æ¬¡è¿›â¼Šåˆ™ä¸º nullï¼Œä¼šè¿›â¾å•ä¾‹å¯¹\nè±¡çš„åˆ›å»ºï¼Œå®Œæˆåé‡Šæ”¾é”ï¼Œå…¶ä»–çº¿ç¨‹è·å–é”åå°±ä¼šè¢«ç©ºåˆ¤æ–­æ‹¦æˆªï¼Œç›´æ¥è¿”\nå›å·²åˆ›å»ºçš„å•ä¾‹å¯¹è±¡ã€‚\nå…¶ä¸­æœ€å…³é”®çš„â¼€ä¸ªç‚¹å°±æ˜¯ volatile å…³é”®å­—çš„ä½¿â½¤ï¼Œå…³äº volatile çš„è¯¦ç»†ä»‹\nç»å¯ä»¥ç›´æ¥æœç´¢ volatile å…³é”®å­—å³å¯ï¼Œæœ‰å¾ˆå¤šå†™çš„â¾®å¸¸å¥½çš„â½‚ç« ï¼Œè¿™â¾¥ä¸åš\nè¯¦ç»†ä»‹ç»ï¼Œç®€å•è¯´æ˜â¼€ä¸‹ï¼ŒåŒé‡æ£€æŸ¥é”ä¸­ä½¿â½¤ volatile çš„ä¸¤ä¸ªé‡è¦ç‰¹æ€§ï¼š\nå¯â»…æ€§ã€ç¦â½ŒæŒ‡ä»¤é‡æ’åº\nå½“æˆ‘ä»¬åœ¨å¼•â½¤å˜é‡ä¸Šâ¾¯æ·»åŠ  volatile å…³é”®å­—ä»¥åï¼Œä¼šé€šè¿‡åœ¨åˆ›å»ºå¯¹è±¡æŒ‡ä»¤\nçš„å‰åæ·»åŠ å†…å­˜å±éšœæ¥ç¦â½ŒæŒ‡ä»¤é‡æ’åºï¼Œå°±å¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜ï¼Œâ½½ä¸”å¯¹\nvolatile ä¿®é¥°çš„å˜é‡çš„ä¿®æ”¹å¯¹å…¶ä»–ä»»ä½•çº¿ç¨‹éƒ½æ˜¯å¯â»…çš„\npublic class Singleton &#123;\n // 1ã€ç§æœ‰åŒ–æ„é€ â½…æ³•\n private Singleton() &#123;\n &#125;\n // 2ã€å®šä¹‰â¼€ä¸ªé™æ€å˜é‡æŒ‡å‘â¾ƒâ¼°ç±»å‹\n private volatile static Singleton instance;\n // 3ã€å¯¹å¤–æä¾›â¼€ä¸ªå…¬å…±çš„â½…æ³•è·å–å®ä¾‹\n public static Singleton getInstance() &#123;\n // ç¬¬â¼€é‡æ£€æŸ¥æ˜¯å¦ä¸º null\n if (instance == null) &#123;\n // ä½¿â½¤ synchronized åŠ é”\n synchronized (Singleton.class) &#123;\n // ç¬¬â¼†é‡æ£€æŸ¥æ˜¯å¦ä¸º null\n     if (instance == null) &#123;\n // new å…³é”®å­—åˆ›å»ºå¯¹è±¡ä¸æ˜¯åŸâ¼¦æ“ä½œ\n instance = new Singleton();\n\t \t\t&#125;\n \t\t&#125;\n \t&#125;\n return instance;\n \t&#125;\n&#125;\n\n\nä¼˜ç‚¹ï¼šæ‡’åŠ è½½ï¼Œçº¿ç¨‹å®‰å…¨ï¼Œæ•ˆç‡è¾ƒâ¾¼\n\nç¼ºç‚¹ï¼šå®ç°è¾ƒå¤æ‚\n\n\né™æ€å†…éƒ¨ç±»//é™æ€å†…éƒ¨ç±»å®ç°å•ä¾‹\npublic class Singleton &#123;\n // 1ã€ç§æœ‰åŒ–æ„é€ â½…æ³•\n private Singleton() &#123;\n &#125;\n // 2ã€å¯¹å¤–æä¾›è·å–å®ä¾‹çš„å…¬å…±â½…æ³•\n public static Singleton getInstance() &#123;\n return InnerClass.INSTANCE;\n     \n // å®šä¹‰é™æ€å†…éƒ¨ç±»\n private static class InnerClass&#123;\n private final static Singleton INSTANCE = new\nSingleton();\n &#125;\n&#125;\n\n\nä¼˜ç‚¹ï¼šæ‡’åŠ è½½ï¼Œçº¿ç¨‹å®‰å…¨ï¼Œæ•ˆç‡è¾ƒâ¾¼ï¼Œå®ç°ç®€å•\n\né™æ€å†…éƒ¨ç±»å•ä¾‹æ˜¯å¦‚ä½•å®ç°æ‡’åŠ è½½çš„å‘¢ï¼Ÿâ¾¸å…ˆï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸‹ç±»çš„åŠ è½½æ—¶æœºã€‚è™šæ‹Ÿæœºè§„èŒƒè¦æ±‚æœ‰ä¸”åªæœ‰ 5 ç§æƒ…å†µå¿…é¡»â½´å³å¯¹ç±»è¿›â¾åˆå§‹åŒ–ï¼ˆåŠ è½½ã€éªŒè¯ã€å‡†å¤‡éœ€è¦åœ¨æ­¤ä¹‹å‰å¼€å§‹ï¼‰ï¼š\n\né‡åˆ° new ã€ getstatic ã€ putstatic ã€ invokestatic è¿™ 4 æ¡å­—èŠ‚ç æŒ‡ä»¤æ—¶ã€‚â½£æˆè¿™ 4 æ¡æŒ‡ä»¤æœ€å¸¸â»…çš„ Java ä»£ç åœºæ™¯æ˜¯ï¼šä½¿â½¤ new å…³é”®å­—å®ä¾‹åŒ–å¯¹è±¡çš„æ—¶å€™ã€è¯»å–æˆ–è®¾ç½®â¼€ä¸ªç±»çš„é™æ€å­—æ®µï¼ˆfinal ä¿®é¥°é™¤å¤–ï¼Œè¢«final ä¿®é¥°çš„é™æ€å­—æ®µæ˜¯å¸¸é‡ï¼Œå·²åœ¨ç¼–è¯‘æœŸæŠŠç»“æœæ”¾â¼Šå¸¸é‡æ± ï¼‰çš„æ—¶å€™ï¼Œä»¥åŠè°ƒâ½¤â¼€ä¸ªç±»çš„é™æ€â½…æ³•çš„æ—¶å€™ã€‚\nä½¿â½¤ java.lang.reflect åŒ…â½…æ³•å¯¹ç±»è¿›â¾åå°„è°ƒâ½¤çš„æ—¶å€™ã€‚\nå½“åˆå§‹åŒ–â¼€ä¸ªç±»çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°å…¶â½—ç±»è¿˜æ²¡æœ‰è¿›â¾è¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶â½—ç±»çš„åˆå§‹åŒ–ã€‚\nå½“è™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œâ½¤æˆ·éœ€è¦æŒ‡å®šâ¼€ä¸ªè¦æ‰§â¾çš„ä¸»ç±»ï¼ˆåŒ…å« main()çš„é‚£ä¸ªç±»ï¼‰ï¼Œè™šæ‹Ÿæœºä¼šå…ˆåˆå§‹åŒ–è¿™ä¸ªä¸»ç±»ã€‚\nå½“ä½¿â½¤ JDK 1.7 çš„åŠ¨æ€è¯­â¾”â½€æŒæ—¶ï¼Œå¦‚æœâ¼€ä¸ªjava.lang.invoke.MethodHandle å®ä¾‹æœ€åçš„è§£æç»“æœæ˜¯REF_getStatic ã€ REF_putStatic ã€ REF_invokeStatic çš„â½…æ³•å¥æŸ„ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘è¿™ä¸ªâ½…æ³•å¥æŸ„æ‰€å¯¹åº”çš„ç±»çš„åˆå§‹åŒ–ã€‚\n\nè¿™ 5 ç§æƒ…å†µè¢«ç§°ä¸ºæ˜¯ç±»çš„ä¸»åŠ¨å¼•â½¤ï¼Œæ³¨æ„ï¼Œè¿™â¾¥ã€Šè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­ä½¿â½¤çš„é™å®šè¯æ˜¯ â€œæœ‰ä¸”ä»…æœ‰â€ï¼Œé‚£ä¹ˆï¼Œé™¤æ­¤ä¹‹å¤–çš„æ‰€æœ‰å¼•â½¤ç±»éƒ½ä¸ä¼šå¯¹ç±»è¿›â¾åˆå§‹åŒ–ï¼Œç§°ä¸ºè¢«åŠ¨å¼•â½¤ã€‚é™æ€å†…éƒ¨ç±»å°±å±äºè¢«åŠ¨å¼•â½¤çš„æƒ…å†µã€‚\nå½“ getInstance()â½…æ³•è¢«è°ƒâ½¤æ—¶ï¼ŒInnerClass æ‰åœ¨ Singleton çš„è¿â¾æ—¶å¸¸é‡æ± â¾¥ï¼ŒæŠŠç¬¦å·å¼•â½¤æ›¿æ¢ä¸ºç›´æ¥å¼•â½¤ï¼Œè¿™æ—¶é™æ€å¯¹è±¡ INSTANCE ä¹ŸçœŸæ­£è¢«åˆ›å»ºï¼Œç„¶åå†è¢« getInstance()â½…æ³•è¿”å›å‡ºå»ï¼Œè¿™ç‚¹åŒé¥¿æ±‰æ¨¡å¼ã€‚\né‚£ä¹ˆ INSTANCE åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­â¼œæ˜¯å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨çš„å‘¢ï¼Ÿ\nè™šæ‹Ÿæœºä¼šä¿è¯â¼€ä¸ªç±»çš„ () â½…æ³•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­è¢«æ­£ç¡®åœ°åŠ é”ã€åŒæ­¥ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶å»åˆå§‹åŒ–â¼€ä¸ªç±»ï¼Œé‚£ä¹ˆåªä¼šæœ‰â¼€ä¸ªçº¿ç¨‹å»æ‰§â¾è¿™ä¸ªç±»çš„ () â½…æ³•ï¼Œå…¶ä»–çº¿ç¨‹éƒ½éœ€è¦é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æ´»åŠ¨çº¿ç¨‹æ‰§â¾() â½…æ³•å®Œæ¯•ã€‚å¦‚æœåœ¨â¼€ä¸ªç±»çš„ () â½…æ³•ä¸­æœ‰è€—æ—¶å¾ˆâ»“çš„æ“ä½œï¼Œå°±å¯èƒ½é€ æˆå¤šä¸ªè¿›ç¨‹é˜»å¡(éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå…¶ä»–çº¿ç¨‹è™½ç„¶ä¼šè¢«é˜»å¡ï¼Œä½†å¦‚æœæ‰§â¾ () â½…æ³•åï¼Œå…¶ä»–çº¿ç¨‹å”¤é†’ä¹‹åä¸ä¼šå†æ¬¡è¿›â¼Š () â½…æ³•ã€‚åŒâ¼€ä¸ªåŠ è½½å™¨ä¸‹ï¼Œâ¼€ä¸ªç±»å‹åªä¼šåˆå§‹åŒ–â¼€æ¬¡ã€‚)ï¼Œåœ¨å®é™…åº”â½¤ä¸­ï¼Œè¿™ç§é˜»å¡å¾€å¾€æ˜¯å¾ˆéšè”½çš„ã€‚\næ‰€ä»¥è¯´é™æ€å†…éƒ¨ç±»å½¢å¼çš„å•ä¾‹å¯ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä¹Ÿèƒ½ä¿è¯å•ä¾‹çš„å”¯â¼€æ€§ï¼ŒåŒæ—¶ä¹Ÿå»¶è¿Ÿäº†å•ä¾‹çš„å®ä¾‹åŒ–ã€‚\næšä¸¾å•ä¾‹//æšä¸¾å®ç°å•ä¾‹\npublic enum Singleton &#123;\n INSTANCE;\n public void doSomething(String str) &#123;\n System.out.println(str);\n &#125;\n&#125;\n\n\nä¼˜ç‚¹ï¼šç®€å•ï¼Œâ¾¼æ•ˆï¼Œçº¿ç¨‹å®‰å…¨ï¼Œå¯ä»¥é¿å…é€šè¿‡åå°„ç ´åæšä¸¾å•ä¾‹\n\næšä¸¾åœ¨ java ä¸­ä¸æ™®é€šç±»â¼€æ ·ï¼Œéƒ½èƒ½æ‹¥æœ‰å­—æ®µä¸â½…æ³•ï¼Œâ½½ä¸”æšä¸¾å®ä¾‹åˆ›å»ºæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œåœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œå®ƒéƒ½æ˜¯â¼€ä¸ªå•ä¾‹ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡å¦‚ä¸‹â½…å¼è°ƒâ½¤è·å–å®ä¾‹ï¼š\nSingleton singleton = Singleton.INSTANCE;\nä½¿â½¤ä¸‹â¾¯çš„å‘½ä»¤åç¼–è¯‘æšä¸¾ç±»\njavap Singleton.class\nå¾—åˆ°å¦‚ä¸‹å†…å®¹\nCompiled from \"Singleton.java\"\npublic final class com.spring.demo.singleton.Singleton\nextends\njava.lang.Enum&lt;com.spring.demo.singleton.Singleton> &#123;\n public static final\ncom.spring.demo.singleton.Singleton INSTANCE;\n public static com.spring.demo.singleton.Singleton[]\nvalues();\n public static com.spring.demo.singleton.Singleton\nvalueOf(java.lang.String);\n public void doSomething(java.lang.String);\n static &#123;&#125;;\n&#125;\n\nä»æšä¸¾çš„åç¼–è¯‘ç»“æœå¯ä»¥çœ‹åˆ°ï¼ŒINSTANCE è¢« static final ä¿®é¥°ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ç±»åç›´æ¥è°ƒâ½¤ï¼Œå› ä¸ºstatic ç±»å‹çš„å±æ€§ä¼šåœ¨ç±»è¢«åŠ è½½ä¹‹åè¢«åˆå§‹åŒ–ï¼Œå½“â¼€ä¸ª Java ç±»ç¬¬â¼€æ¬¡è¢«çœŸæ­£ä½¿â½¤åˆ°çš„æ—¶å€™é™æ€èµ„æºè¢«åˆå§‹åŒ–ã€Java ç±»çš„åŠ è½½å’Œåˆå§‹åŒ–è¿‡ç¨‹éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥åˆ›å»ºâ¼€ä¸ª enum ç±»å‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚\né€šè¿‡åå°„ç ´åæšä¸¾ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼špublic class Test &#123;\n public static void main(String[] args) throws\nException &#123;\n Singleton singleton = Singleton.INSTANCE;\n singleton.doSomething(\"hello enum\");\n // å°è¯•ä½¿â½¤åå°„ç ´åå•ä¾‹\n // æšä¸¾ç±»æ²¡æœ‰ç©ºå‚æ„é€ â½…æ³•ï¼Œåç¼–è¯‘åå¯ä»¥çœ‹åˆ°æšä¸¾æœ‰â¼€ä¸ªä¸¤ä¸ª\nå‚æ•°çš„æ„é€ â½…æ³•\n Constructor&lt;Singleton> declaredConstructor =\nSingleton.class.getDeclaredConstructor(String.class,\nint.class);\n // è®¾ç½®å¼ºåˆ¶è®¿é—®\n declaredConstructor.setAccessible(true);\n // åˆ›å»ºå®ä¾‹ï¼Œè¿™â¾¥ä¼šæŠ¥é”™ï¼Œå› ä¸ºâ½†æ³•é€šè¿‡åå°„åˆ›å»ºæšä¸¾çš„å®ä¾‹\n Singleton enumSingleton =\ndeclaredConstructor.newInstance();\n System.out.println(enumSingleton);\n &#125;\n&#125;\n\nè¿â¾ç»“æœæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š\nException in thread \"main\"\njava.lang.IllegalArgumentException: Cannot reflectively\ncreate enum objects at\njava.base/java.lang.reflect.Constructor.newInstanceWithCaller(Constructor.java:492) \nat java.base/java.lang.reflect.Constructor.newInstance(Constructor.java:480)\nat com.spring.demo.singleton.Test.main(Test.java:24)\n\næ‰€ä»¥â½†æ³•é€šè¿‡åå°„åˆ›å»ºæšä¸¾çš„å®ä¾‹ã€‚\n","slug":"å•ä¾‹æ¨¡å¼","date":"2023-05-08T13:10:28.000Z","categories_index":"","tags_index":"Java,è®¾è®¡æ¨¡å¼","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"064fd1f961f785b45ddfca5b3ce563ee","title":"springäº‹åŠ¡å¤±æ•ˆçš„æƒ…å†µä»¥åŠæ³¨æ„äº‹é¡¹","content":"ä»€ä¹ˆæ˜¯springäº‹åŠ¡ï¼Ÿâ€‹\tSpring Frameworkæä¾›äº†ä¸€ç§ç®€å•è€Œå¼ºå¤§çš„æœºåˆ¶æ¥ç®¡ç†äº‹åŠ¡ï¼Œè¿™ä¸ªæœºåˆ¶è¢«ç§°ä¸ºSpringäº‹åŠ¡ã€‚Springäº‹åŠ¡æ˜¯åœ¨Javaåº”ç”¨ç¨‹åºä¸­ç®¡ç†æ•°æ®åº“äº‹åŠ¡çš„ä¸€ç§å¼ºå¤§çš„æ–¹æ³•ã€‚åœ¨Springäº‹åŠ¡ä¸­ï¼Œæ‰€æœ‰çš„æ•°æ®åº“è®¿é—®æ˜¯åœ¨äº‹åŠ¡ç®¡ç†å™¨çš„ä¸Šä¸‹æ–‡ä¸­è¿›è¡Œçš„ã€‚\nâ€‹\tSpringäº‹åŠ¡çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†äº‹åŠ¡ç®¡ç†ä»å…·ä½“çš„æ•°æ®è®¿é—®ä»£ç ä¸­æŠ½è±¡å‡ºæ¥ã€‚Springæä¾›äº†ä¸€ç§é›†ä¸­å¼çš„æ–¹å¼æ¥ç®¡ç†äº‹åŠ¡ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨ä¸ä¿®æ”¹å…·ä½“æ•°æ®è®¿é—®ä»£ç çš„æƒ…å†µä¸‹è½»æ¾åœ°æ·»åŠ æˆ–åˆ é™¤äº‹åŠ¡ã€‚\nspringäº‹åŠ¡çš„ä¼˜ç‚¹Springäº‹åŠ¡å…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š\nç®€å•æ€§ - Springäº‹åŠ¡ä½¿å¾—äº‹åŠ¡ç®¡ç†å˜å¾—éå¸¸ç®€å•ï¼Œåªéœ€è¦æ·»åŠ å°‘é‡çš„æ³¨é‡Šå°±å¯ä»¥å®ç°ã€‚\nå¯æ‰©å±•æ€§ - Springäº‹åŠ¡æä¾›äº†å„ç§äº‹åŠ¡ç®¡ç†å™¨ï¼Œä»¥é€‚åº”å„ç§ä¸åŒçš„äº‹åŠ¡éœ€æ±‚ã€‚å®ƒè¿˜å…è®¸æˆ‘ä»¬è‡ªè¡Œæ‰©å±•å’Œå®šåˆ¶äº‹åŠ¡ç®¡ç†å™¨ã€‚\nç‹¬ç«‹æ€§ - Springäº‹åŠ¡æä¾›äº†ä¸€ç§ä¸åº•å±‚æ•°æ®è®¿é—®æŠ€æœ¯æ— å…³çš„äº‹åŠ¡ç®¡ç†æ–¹å¼ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°æ›´æ”¹æ•°æ®åº“ï¼Œè€Œä¸éœ€è¦æ›´æ”¹äº‹åŠ¡ç®¡ç†æ–¹å¼ã€‚\nspringäº‹åŠ¡çš„ç±»å‹Springäº‹åŠ¡æœ‰ä»¥ä¸‹å¸¸è§çš„ç±»å‹ï¼š\n\nå£°æ˜å¼äº‹åŠ¡ - è¯¥ç±»å‹çš„äº‹åŠ¡æ˜¯åœ¨é…ç½®æ–‡ä»¶æˆ–æ³¨é‡Šä¸­å£°æ˜çš„ã€‚è¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°æ·»åŠ å’Œåˆ é™¤äº‹åŠ¡ã€‚\nç¼–ç¨‹å¼äº‹åŠ¡ - è¯¥ç±»å‹çš„äº‹åŠ¡æ˜¯é€šè¿‡ç¼–å†™ä»£ç æ¥å®ç°çš„ã€‚å®ƒæä¾›äº†æ›´ç»†ç²’åº¦çš„æ§åˆ¶å’Œæ›´é«˜çš„è‡ªå®šä¹‰ç¨‹åº¦ã€‚ä½†æ˜¯ï¼Œç¼–å†™ä»£ç ä¼šä½¿å¾—ä»£ç å¤æ‚åŒ–ã€‚\n\nspringäº‹åŠ¡å¤±æ•ˆçš„æƒ…å†µäº‹åŠ¡å¤±æ•ˆçš„å…«ç§åœºæ™¯1.æŠ›å‡ºæ£€æŸ¥å¼‚å¸¸å¯¼è‡´äº‹åŠ¡ä¸èƒ½æ­£ç¡®å›æ»šè¡¥å……ä»€ä¹ˆæ˜¯æ£€æŸ¥å¼‚å¸¸ï¼š\nJavaä¸­çš„å¼‚å¸¸åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šæ£€æŸ¥å¼‚å¸¸å’Œéæ£€æŸ¥å¼‚å¸¸ã€‚\næ£€æŸ¥å¼‚å¸¸éœ€è¦ä½¿ç”¨try-catchè¯­å¥æˆ–è€…throwså£°æ˜æ¥å¤„ç†æˆ–æŠ›å‡ºï¼Œå¦åˆ™ç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚è¿™ç§å¼‚å¸¸é€šå¸¸è¡¨ç¤ºç¨‹åºè¿è¡Œæ—¶å¿…é¡»è§£å†³çš„æŸäº›é”™è¯¯æˆ–ä¸åˆæ³•æ“ä½œã€‚ä¾‹å¦‚ï¼šIOExceptionã€SQLExceptionã€ClassNotFoundExceptionç­‰ã€‚\néæ£€æŸ¥å¼‚å¸¸æ˜¯æŒ‡RuntimeExceptionåŠå…¶å­ç±»å¼‚å¸¸ï¼Œä¸éœ€è¦åœ¨ä»£ç ä¸­è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œç¨‹åºåœ¨è¿è¡ŒæœŸé—´å‡ºç°è¿™ç§å¼‚å¸¸æ—¶ï¼Œä¼šè‡ªåŠ¨è§¦å‘JVMçš„å¼‚å¸¸å¤„ç†æœºåˆ¶ã€‚è¿™ç§å¼‚å¸¸é€šå¸¸è¡¨ç¤ºç¨‹åºå‡ºç°äº†é€»è¾‘æˆ–ç¼–ç¨‹é”™è¯¯ã€‚ä¾‹å¦‚ï¼šNullPointerExceptionã€ArrayIndexOutOfBoundsExceptionã€IllegalArgumentExceptionç­‰ã€‚\n@Service\npublic class Service1 &#123;\n\n    @Autowired\n    private AccountMapper accountMapper;\n\n    @Transactional\n    public void transfer(int from, int to, int amount) throws FileNotFoundException &#123;\n        int fromBalance = accountMapper.findBalanceBy(from);\n        if (fromBalance - amount >= 0) &#123;\n            accountMapper.update(from, -1 * amount);\n            new FileInputStream(\"hj\");\n            accountMapper.update(to, amount);\n        &#125;\n    &#125;\n&#125;\n\n\næ— æ³•äº‹åŠ¡å›æ»šï¼šSpringé»˜è®¤åªä¼šå›æ»šéæ£€æŸ¥å¼‚å¸¸\n\nè§£æ³•ï¼š\né…ç½®rollbackForå±æ€§ (ä»€ä¹ˆé”™è¯¯éœ€è¦å›æ»š)ï¼š\n @Transactional(rollbackFor = Exception.class)\n\n\n2.æ–¹æ³•å†…è‡ªå·±try-catchå¼‚å¸¸å¯¼è‡´äº‹åŠ¡ä¸èƒ½æ­£ç¡®å›æ»š@Service\npublic class Service2 &#123;\n\n    @Autowired\n    private AccountMapper accountMapper;\n\n    @Transactional(rollbackFor = Exception.class)\n    public void transfer(int from, int to, int amount)  &#123;\n        try &#123;\n            int fromBalance = accountMapper.findBalanceBy(from);\n            if (fromBalance - amount >= 0) &#123;\n                accountMapper.update(from, -1 * amount);\n                new FileInputStream(\"hj\");\n                accountMapper.update(to, amount);\n            &#125;\n        &#125; catch (FileNotFoundException e) &#123;\n            e.printStackTrace();\n        &#125;\n    &#125;\n&#125;\n\n\nåŸå› ï¼šäº‹åŠ¡é€šçŸ¥åªæœ‰æ•æ‰åˆ°äº†ç›®æ ‡æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ï¼Œæ‰èƒ½è¿›è¡Œåç»­çš„å›æ»šå¤„ç†ï¼Œå¦‚æœç›®æ ‡è‡ªå·±å¤„ç†æ‰å¼‚å¸¸ï¼Œäº‹åŠ¡é€šçŸ¥æ— æ³•çŸ¥æ‚‰\n\næ–¹æ³•1ï¼šå°†catchåˆ°çš„å¼‚å¸¸ï¼ŒåŒ…è£…æˆè¿è¡Œæ—¶å¼‚å¸¸æŠ›å‡º\n\nåœ¨catchå—é‡Œthrow new RuntimeException(e);\n\n\næ–¹æ³•2ï¼šæ‰‹åŠ¨è®¾ç½®å›æ»š\n\nåœ¨catchå—æ·»åŠ \nTransactionInterceptor.currentTransactionStatus().setRollbackOnly();\n\n\n\n\n3.aopåˆ‡é¢é¡ºåºå¼‚å¸¸å¯¼è‡´äº‹åŠ¡ä¸èƒ½æ­£ç¡®å›æ»š@Service\npublic class Service3 &#123;\n\n    @Autowired\n    private AccountMapper accountMapper;\n\n    @Transactional(rollbackFor = Exception.class)\n    public void transfer(int from, int to, int amount) throws FileNotFoundException &#123;\n        int fromBalance = accountMapper.findBalanceBy(from);\n        if (fromBalance - amount >= 0) &#123;\n            accountMapper.update(from, -1 * amount);\n            new FileInputStream(\"hj\");\n            accountMapper.update(to, amount);\n        &#125;\n    &#125;\n&#125;\n\n@Aspect\npublic class MyAspect &#123;\n    @Around(\"execution(* transfer(..))\")\n    public Object around(ProceedingJoinPoint pjp) throws Throwable &#123;\n        LoggerUtils.get().debug(\"log:&#123;&#125;\", pjp.getTarget());\n        try &#123;\n            return pjp.proceed();\n        &#125; catch (Throwable e) &#123;\n            e.printStackTrace();\n            return null;\n        &#125;\n    &#125;\n&#125;\n\n\n\n4.épublicæ–¹æ³•å¯¼è‡´äº‹åŠ¡å¤±æ•ˆ@Service\npublic class Service4 &#123;\n\n    @Autowired\n    private AccountMapper accountMapper;\n\n    @Transactional\n    void transfer(int from, int to, int amount) throws FileNotFoundException &#123;\n        int fromBalance = accountMapper.findBalanceBy(from);\n        if (fromBalance - amount >= 0) &#123;\n            accountMapper.update(from, -1 * amount);\n            accountMapper.update(to, amount);\n        &#125;\n    &#125;\n&#125;\n\n\nåŸå› ï¼šSpringä¸ºæ–¹æ³•åˆ›å»ºä»£ç†ï¼Œæ·»åŠ äº‹åŠ¡é€šçŸ¥ï¼Œå‰ææ¡ä»¶éƒ½æ˜¯æ–¹æ³•ä¸ºpublic\n\næ–¹æ³•1ï¼šæ–¹æ³•æ”¹ä¸ºpublic\n\næ–¹æ³•2ï¼šæ·»åŠ beané…ç½®ï¼Œä¸æ¨èä½¿ç”¨\n\n@Bean\npublic TransactionAttributeSource transactionAttributeSource() &#123;\n    return new AnnotationTransactionAttributeSource(false);\n&#125;\n\n\n\n\n\nâ€‹\tæ‹“å±•ï¼šAnnotationTransactionAttributeSource\nâ€‹\t\tAnnotationTransactionAttributeSourceæ˜¯Springäº‹åŠ¡æ¡†æ¶ä¸­çš„ä¸€ä¸ªç±»ï¼Œç”¨äºè§£æ@Transactionalæ³¨è§£å¹¶ä»¥æ­¤ä¸ºåŸºç¡€ç”ŸæˆTransactionAttributeå¯¹è±¡ã€‚TransactionAttributeå¯¹è±¡æè¿°äº†ä¸€æ®µæ–¹æ³•æ‰§è¡Œæ—¶åº”è¯¥ä½¿ç”¨çš„äº‹åŠ¡å±æ€§ï¼ŒåŒ…æ‹¬äº‹åŠ¡çš„åå­—ã€ä¼ æ’­è¡Œä¸ºã€éš”ç¦»çº§åˆ«ã€è¶…æ—¶æ—¶é—´ã€åªè¯»å±æ€§ç­‰ã€‚\nâ€‹\t\tåœ¨Springçš„äº‹åŠ¡ç®¡ç†ä¸­ï¼Œäº‹åŠ¡åˆ‡é¢å¯¹è±¡ä¼šè°ƒç”¨AnnotationTransactionAttributeSourceå¯¹è±¡çš„getTransactionAttribute()æ–¹æ³•ï¼Œä»è€Œè·å–æ–¹æ³•æˆ–ç±»çº§åˆ«çš„äº‹åŠ¡å±æ€§ã€‚è¿™ç§æ–¹å¼å¯ä»¥å°†äº‹åŠ¡å±æ€§ä¸å…·ä½“çš„ä¸šåŠ¡ä»£ç è§£è€¦ï¼Œä½¿å¾—ä¸šåŠ¡ä»£ç æ›´åŠ ç®€æ´å¯è¯»ã€‚\nâ€‹\t\tAnnotationTransactionAttributeSourceå¯¹è±¡æœ‰ä¸€ä¸ªå¸ƒå°”ç±»å‹çš„æ„é€ å‡½æ•°å‚æ•°ï¼Œå®ƒç”¨äºæ§åˆ¶@Transactionalæ³¨è§£çš„è§£ææ–¹å¼ã€‚å¦‚æœè¿™ä¸ªå‚æ•°ä¸ºfalseï¼Œåˆ™AnnotationTransactionAttributeSourceåªä¼šè§£æ@Transactionalæ³¨è§£ï¼Œè€Œä¸ä¼šè€ƒè™‘ç»§æ‰¿å’Œé‡è½½å…³ç³»ï¼Œå³åªè§£æè¢«æ³¨è§£ç±»æˆ–æ–¹æ³•ä¸Šçš„@Transactionalæ³¨è§£ï¼Œè€Œä¸è€ƒè™‘å…¶åŸºç±»å’Œå­ç±»ä»¥åŠé‡è½½æ–¹æ³•ä¸­çš„@Transactionalæ³¨è§£ã€‚\nâ€‹\t\té»˜è®¤æƒ…å†µä¸‹AnnotationTransactionAttributeSourceå¯¹è±¡çš„æ„é€ å‡½æ•°å‚æ•°æ˜¯trueï¼Œå³æ”¯æŒç»§æ‰¿å’Œé‡è½½çš„æ³¨è§£è§£æã€‚ä½†æ˜¯ï¼Œåœ¨æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œè¿™ç§è§£ææ–¹å¼å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ï¼Œå¦‚äº‹åŠ¡ä¼ æ’­ã€è¶…æ—¶ç­‰ä¸è¢«æ­£ç¡®è§£æã€‚æ­¤æ—¶ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®æ„é€ å‡½æ•°å‚æ•°ä¸ºfalseæ¥ç¦ç”¨è¿™ç§è§£ææœºåˆ¶ï¼Œä»¥ç¡®ä¿æ­£ç¡®åœ°è§£æ@Transactionalæ³¨è§£ã€‚\n5.çˆ¶å­å®¹å™¨å¯¼è‡´çš„äº‹åŠ¡å¤±æ•ˆ6.è°ƒç”¨æœ¬ç±»æ–¹æ³•å¯¼è‡´ä¼ æ’­è¡Œä¸ºå¤±æ•ˆ7.@Transactionalæ²¡æœ‰ä¿è¯åŸå­è¡Œä¸º8.@Transactionalæ–¹æ³•å¯¼è‡´çš„synchronizedå¤±æ•ˆ","slug":"Springäº‹åŠ¡å¤±æ•ˆçš„æƒ…å†µä»¥åŠæ³¨æ„äº‹é¡¹","date":"2023-05-07T12:31:38.000Z","categories_index":"","tags_index":"Java,Spring,é¢è¯•é¢˜","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"},{"id":"94364c933b9df4578d2492ddcb35178f","title":"How to use Hexo","content":"Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub.\nmyHexoCreate a new post$ hexo new \"title\"\n\nMore info: Writing\nRun server$ hexo server\n\nMore info: Server\nGenerate static files$ hexo generate\n\nMore info: Generating\nDeploy to remote sites$ hexo deploy\n\nMore info: Deployment\n","slug":"hello-world","date":"2023-05-06T09:17:31.212Z","categories_index":"","tags_index":"","author_index":"å¤§å®è´çš„ç¨‹åºå‘˜"}]