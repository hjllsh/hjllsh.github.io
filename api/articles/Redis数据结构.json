{"title":"Redis数据结构","uid":"95d031e6876e8ced445f4faed1bda7eb","slug":"Redis数据结构","date":"2023-06-16T13:30:38.000Z","updated":"2023-06-16T16:16:53.840Z","comments":true,"path":"api/articles/Redis数据结构.json","keywords":null,"cover":[],"content":"<h3 id=\"Redis数据结构-动态字符串SDS\"><a href=\"#Redis数据结构-动态字符串SDS\" class=\"headerlink\" title=\"Redis数据结构-动态字符串SDS\"></a>Redis数据结构-动态字符串SDS</h3><p>Redis没有直接使用C语言中的字符串，因为C语言字符串存在很多问题：</p>\n<ul>\n<li>获取字符串长度的需要通过运算</li>\n<li>非二进制安全</li>\n<li>不可修改</li>\n</ul>\n<p>Redis构建了一种新的字符串结构，称为简单动态字符串（Simple Dynamic String），简称SDS。</p>\n<p>Redis是C语言实现的，其中SDS是一个结构体，源码如下：</p>\n<p><img src=\"D:/Java成神之路/7、2022版Redis入门到精通/Redis-笔记资料/04-原理篇/讲义/原理篇.assets/1653984624671.png\" alt=\"1653984624671\"></p>\n<p>例如，一个包含字符串“name”的sds结构如下：</p>\n<p><img src=\"D:/Java成神之路/7、2022版Redis入门到精通/Redis-笔记资料/04-原理篇/讲义/原理篇.assets/1653984648404.png\" alt=\"1653984648404\"></p>\n<p>SDS之所以叫做动态字符串，是因为它具备动态扩容的能力，例如一个内容为“hi”的SDS：</p>\n<p><img src=\"D:/Java成神之路/7、2022版Redis入门到精通/Redis-笔记资料/04-原理篇/讲义/原理篇.assets/1653984787383.png\" alt=\"1653984787383\"></p>\n<p>假如我们要给SDS追加一段字符串“,Amy”，这里首先会申请新内存空间：</p>\n<p>如果新字符串小于1M，则新空间为扩展后字符串长度的两倍+1；</p>\n<p>alloc（申请长度） &#x3D; len * 2 实际申请为 len * 2 + 1多出一位用来存\\0</p>\n<p>如果新字符串大于1M，则新空间为扩展后字符串长度+1M+1。称为内存预分配。</p>\n<p><img src=\"D:/Java成神之路/7、2022版Redis入门到精通/Redis-笔记资料/04-原理篇/讲义/原理篇.assets/1653984822363.png\" alt=\"1653984822363\"></p>\n<p><img src=\"D:/Java成神之路/7、2022版Redis入门到精通/Redis-笔记资料/04-原理篇/讲义/原理篇.assets/1653984838306.png\" alt=\"1653984838306\"></p>\n<p>二进制安全：根据len读取，不会因为在中间读到\\0而结束</p>\n<h3 id=\"Redis数据结构-intset\"><a href=\"#Redis数据结构-intset\" class=\"headerlink\" title=\"Redis数据结构-intset\"></a>Redis数据结构-intset</h3><p>IntSet是Redis中set集合的一种实现方式，基于整数数组来实现，并且具备长度可变、有序等特征。<br>结构如下：</p>\n<p><img src=\"D:/Java成神之路/7、2022版Redis入门到精通/Redis-笔记资料/04-原理篇/讲义/原理篇.assets/1653984923322.png\" alt=\"1653984923322\"></p>\n<p>其中的encoding包含三种模式，表示存储的整数大小不同：</p>\n<p><img src=\"D:/Java成神之路/7、2022版Redis入门到精通/Redis-笔记资料/04-原理篇/讲义/原理篇.assets/1653984942385.png\" alt=\"1653984942385\"></p>\n<p><img src=\"D:/Java成神之路/7、2022版Redis入门到精通/Redis-笔记资料/04-原理篇/讲义/原理篇.assets/1653985149557.png\" alt=\"1653985149557\"></p>\n<p>startPtr为起始地址，数组从0开始遍历，为了方便计算地址（每个元素距离开始元素的位置）</p>\n<p>数组中每个数字都在int16_t的范围内，因此采用的编码方式是INTSET_ENC_INT16，每部分占用的字节大小为：<br>encoding：4字节<br>length：4字节<br>contents：2字节 * 3  &#x3D; 6字节</p>\n<p><img src=\"D:/Java成神之路/7、2022版Redis入门到精通/Redis-笔记资料/04-原理篇/讲义/原理篇.assets/1653985197214.png\" alt=\"1653985197214\"></p>\n<p>我们向该其中添加一个数字：50000，这个数字超出了int16_t的范围，intset会自动升级编码方式到合适的大小。<br>以当前案例来说流程如下：</p>\n<ul>\n<li>升级编码为INTSET_ENC_INT32, 每个整数占4字节，并按照新的编码方式及元素个数扩容数组</li>\n<li>倒序依次将数组中的元素拷贝到扩容后的正确位置</li>\n<li>将待添加的元素放入数组末尾</li>\n<li>最后，将inset的encoding属性改为INTSET_ENC_INT32，将length属性改为4</li>\n</ul>\n<p><img src=\"D:/Java成神之路/7、2022版Redis入门到精通/Redis-笔记资料/04-原理篇/讲义/原理篇.assets/1653985276621.png\" alt=\"1653985276621\"></p>\n<p>源码如下：</p>\n<p><img src=\"D:/Java成神之路/7、2022版Redis入门到精通/Redis-笔记资料/04-原理篇/讲义/原理篇.assets/1653985304075.png\" alt=\"1653985304075\"></p>\n<p><img src=\"D:/Java成神之路/7、2022版Redis入门到精通/Redis-笔记资料/04-原理篇/讲义/原理篇.assets/1653985327653.png\" alt=\"1653985327653\"></p>\n<p>小总结：</p>\n<p>Intset可以看做是特殊的整数数组，具备一些特点：</p>\n<ul>\n<li>Redis会确保Intset中的元素唯一、有序</li>\n<li>具备类型升级机制，可以节省内存空间</li>\n<li>底层采用二分查找方式来查询</li>\n</ul>\n","feature":true,"text":"Redis数据结构-动态字符串SDSRedis没有直接使用C语言中的字符串，因为C语言字符串存在很多问题： 获取字符串长度的需要通过运算 非二进制安全 不可修改 Redis构建了一种新的字符串结构，称为简单动态字符串（Simple Dynamic String），简称SDS。 R...","link":"","photos":[],"count_time":{"symbolsCount":"1k","symbolsTime":"1 mins."},"categories":[],"tags":[{"name":"redis","slug":"redis","count":14,"path":"api/tags/redis.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2SDS\"><span class=\"toc-text\">Redis数据结构-动态字符串SDS</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-intset\"><span class=\"toc-text\">Redis数据结构-intset</span></a></li></ol>","author":{"name":"大宝贝的程序员","slug":"blog-author","avatar":"/img/header.jpg","link":"/","description":"Java实习生,即将入职场的小白","socials":{"github":"https://github.com/hjllsh","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://mp.csdn.net/mp_blog/manage/article","juejin":"","customs":{}}},"mapped":true,"prev_post":{},"next_post":{"title":"Linux实战操作","uid":"1259182ad65f322df495428ef17055e6","slug":"Linux实战操作","date":"2023-06-16T04:22:35.000Z","updated":"2023-06-16T13:25:14.926Z","comments":true,"path":"api/articles/Linux实战操作.json","keywords":null,"cover":[],"text":"一个开源的中文查Linux命令的网站：https://wangchujiang.com/linux-command/list.html Linux目录结构 &#x2F;bin 是Binary的缩写，这个目录存放着最经典的常用命令 &#x2F;Sbin s是Super User的意...","link":"","photos":[],"count_time":{"symbolsCount":"7.6k","symbolsTime":"7 mins."},"categories":[],"tags":[{"name":"Linux","slug":"Linux","count":2,"path":"api/tags/Linux.json"},{"name":"Shell","slug":"Shell","count":1,"path":"api/tags/Shell.json"}],"author":{"name":"大宝贝的程序员","slug":"blog-author","avatar":"/img/header.jpg","link":"/","description":"Java实习生,即将入职场的小白","socials":{"github":"https://github.com/hjllsh","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://mp.csdn.net/mp_blog/manage/article","juejin":"","customs":{}}},"feature":true}}