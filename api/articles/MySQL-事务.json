{"title":"MySQL事务","uid":"c1f6d722cc4602038235f2e7924e8ff2","slug":"MySQL-事务","date":"2023-05-17T13:51:38.000Z","updated":"2023-05-18T03:11:52.678Z","comments":true,"path":"api/articles/MySQL-事务.json","keywords":null,"cover":[],"content":"<h2 id=\"事务\"><a href=\"#事务\" class=\"headerlink\" title=\"事务\"></a>事务</h2><p>事务 是一组操作的集合，它是一个不可分割的工作单位，事务会把所有的操作作为一个整体一起向系</p>\n<p>统提交或撤销操作请求，即这些操作要么同时成功，要么同时失败。</p>\n<p>默认MySQL的事务是自动提交的，也就是说，当执行完一条DML语句时，MySQL会立即隐</p>\n<p>式的提交事务。</p>\n<h4 id=\"事务操作\"><a href=\"#事务操作\" class=\"headerlink\" title=\"事务操作\"></a><strong>事务操作</strong></h4><p><strong>未控制事务</strong></p>\n<p>测试正常情况</p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 1. 查询张三余额</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> account <span class=\"token keyword\">where</span> name <span class=\"token operator\">=</span> <span class=\"token string\">'张三'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- 2. 张三的余额减少1000</span>\n<span class=\"token keyword\">update</span> account <span class=\"token keyword\">set</span> money <span class=\"token operator\">=</span> money <span class=\"token operator\">-</span> <span class=\"token number\">1000</span> <span class=\"token keyword\">where</span> name <span class=\"token operator\">=</span> <span class=\"token string\">'张三'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- 3. 李四的余额增加1000</span>\n<span class=\"token keyword\">update</span> account <span class=\"token keyword\">set</span> money <span class=\"token operator\">=</span> money <span class=\"token operator\">+</span> <span class=\"token number\">1000</span> <span class=\"token keyword\">where</span> name <span class=\"token operator\">=</span> <span class=\"token string\">'李四'</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>可以看到数据操作前后是一致的。</p>\n<p>测试异常情况</p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 1. 查询张三余额</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> account <span class=\"token keyword\">where</span> name <span class=\"token operator\">=</span> <span class=\"token string\">'张三'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- 2. 张三的余额减少1000</span>\n<span class=\"token keyword\">update</span> account <span class=\"token keyword\">set</span> money <span class=\"token operator\">=</span> money <span class=\"token operator\">-</span> <span class=\"token number\">1000</span> <span class=\"token keyword\">where</span> name <span class=\"token operator\">=</span> <span class=\"token string\">'张三'</span><span class=\"token punctuation\">;</span>\n出错了<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token comment\">-- 3. 李四的余额增加1000</span>\n<span class=\"token keyword\">update</span> account <span class=\"token keyword\">set</span> money <span class=\"token operator\">=</span> money <span class=\"token operator\">+</span> <span class=\"token number\">1000</span> <span class=\"token keyword\">where</span> name <span class=\"token operator\">=</span> <span class=\"token string\">'李四'</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>(出错了….) 这句话不符合SQL语法,执行就会报错，检查最终的数据情况, 发现数据在操作前后不一致了。</p>\n<p><strong>控制事务</strong></p>\n<p>查看&#x2F;设置事务提交方式</p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> @<span class=\"token variable\">@autocommit</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- autocommit为1标识开启事务自动提交   为0表示手动提交事务</span>\n<span class=\"token keyword\">set</span> @<span class=\"token variable\">@autocommit</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>提交事务</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">commit;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>回滚事务</p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\"><span class=\"token keyword\">rollback</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>开启事务</p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\"><span class=\"token keyword\">start</span> <span class=\"token keyword\">transaction</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- 或者</span>\n<span class=\"token keyword\">begin</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>转账案例：</p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 开启事务</span>\n<span class=\"token keyword\">start</span> <span class=\"token keyword\">transaction</span>\n<span class=\"token comment\">-- 1. 查询张三余额</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> account <span class=\"token keyword\">where</span> name <span class=\"token operator\">=</span> <span class=\"token string\">'张三'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- 2. 张三的余额减少1000</span>\n<span class=\"token keyword\">update</span> account <span class=\"token keyword\">set</span> money <span class=\"token operator\">=</span> money <span class=\"token operator\">-</span> <span class=\"token number\">1000</span> <span class=\"token keyword\">where</span> name <span class=\"token operator\">=</span> <span class=\"token string\">'张三'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- 3. 李四的余额增加1000</span>\n<span class=\"token keyword\">update</span> account <span class=\"token keyword\">set</span> money <span class=\"token operator\">=</span> money <span class=\"token operator\">+</span> <span class=\"token number\">1000</span> <span class=\"token keyword\">where</span> name <span class=\"token operator\">=</span> <span class=\"token string\">'李四'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- 如果正常执行完毕, 则提交事务</span>\n<span class=\"token keyword\">commit</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- 如果执行过程中报错, 则回滚事务</span>\n<span class=\"token comment\">-- rollback;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"事务四大特性\"><a href=\"#事务四大特性\" class=\"headerlink\" title=\"事务四大特性\"></a>事务四大特性</h4><p>原子性（Atomicity）：事务是不可分割的最小操作单元，要么全部成功，要么全部失败。</p>\n<p>一致性（Consistency）：事务完成时，必须使所有的数据都保持一致状态。</p>\n<p>隔离性（Isolation）：数据库系统提供的隔离机制，保证事务在不受外部并发操作影响的独立环境下运行。</p>\n<p>持久性（Durability）：事务一旦提交或回滚，它对数据库中的数据的改变就是永久的。</p>\n<p>上述就是事务的四大特性，简称ACID。</p>\n<p><strong>并发事务问题</strong></p>\n<p> 赃读：一个事务读到另外一个事务还没有提交的数据。</p>\n<p><img src=\"/assets/images/transaction01.png\"></p>\n<p>比如B读取到了A未提交的数据。</p>\n<p>不可重复读：一个事务先后读取同一条记录，但两次读取的数据不同，称之为不可重复读</p>\n<p><img src=\"/assets/images/transaction02.png\"></p>\n<p> 事务A两次读取同一条记录，但是读取到的数据却是不一样的。</p>\n<p> 幻读：一个事务按照条件查询数据时，没有对应的数据行，但是在插入数据时，又发现这行数据已经存在，好像出现了 “幻影”。</p>\n<p><img src=\"/assets/images/transaction03.png\"></p>\n<p><strong>事务隔离级别</strong></p>\n<table>\n<thead>\n<tr>\n<th><strong>隔离级别</strong></th>\n<th><strong>脏读</strong></th>\n<th><strong>不可重复读</strong></th>\n<th><strong>幻读</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Read uncommitted</td>\n<td>存在</td>\n<td>存在</td>\n<td>存在</td>\n</tr>\n<tr>\n<td>Read committed</td>\n<td>不存在</td>\n<td>存在</td>\n<td>存在</td>\n</tr>\n<tr>\n<td>Repeatable Read(default)</td>\n<td>不存在</td>\n<td>不存在</td>\n<td>存在</td>\n</tr>\n<tr>\n<td>Serializable</td>\n<td>不存在</td>\n<td>不存在</td>\n<td>不存在</td>\n</tr>\n</tbody></table>\n<p> 查看事务隔离级别</p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> @<span class=\"token variable\">@TRANSACTION_IOSLATION</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>设置事务隔离级别</p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\"><span class=\"token keyword\">SET</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">SESSION</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">GLOBAL</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">TRANSACTION</span> IOSLATION <span class=\"token keyword\">LEVEL</span>\n<span class=\"token punctuation\">[</span><span class=\"token keyword\">READ</span> <span class=\"token keyword\">COMMITTED</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">READ</span> <span class=\"token keyword\">UNCOMMITTED</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">REPEATABLE</span> <span class=\"token keyword\">READ</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">SERIALIZABLE</span><span class=\"token punctuation\">]</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>事务隔离级别越高，数据越安全，但是性能越低。</p>\n","text":"事务事务 是一组操作的集合，它是一个不可分割的工作单位，事务会把所有的操作作为一个整体一起向系 统提交或撤销操作请求，即这些操作要么同时成功，要么同时失败。 默认MySQL的事务是自动提交的，也就是说，当执行完一条DML语句时，MySQL会立即隐 式的提交事务。 事务操作未控制事...","link":"","photos":[],"count_time":{"symbolsCount":"1.9k","symbolsTime":"2 mins."},"categories":[],"tags":[{"name":"MySQL","slug":"MySQL","count":12,"path":"api/tags/MySQL.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BA%8B%E5%8A%A1\"><span class=\"toc-text\">事务</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E4%BA%8B%E5%8A%A1%E6%93%8D%E4%BD%9C\"><span class=\"toc-text\">事务操作</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E4%BA%8B%E5%8A%A1%E5%9B%9B%E5%A4%A7%E7%89%B9%E6%80%A7\"><span class=\"toc-text\">事务四大特性</span></a></li></ol></li></ol></li></ol>","author":{"name":"大宝贝的程序员","slug":"blog-author","avatar":"/img/header.jpg","link":"/","description":"Java实习生,即将入职场的小白","socials":{"github":"https://github.com/hjllsh","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://mp.csdn.net/mp_blog/manage/article","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"MySQL_存储引擎_索引","uid":"ca0fb70bccc39b11cac4043db766085d","slug":"MySQL-存储引擎-索引","date":"2023-05-18T02:31:14.000Z","updated":"2023-05-23T13:47:20.934Z","comments":true,"path":"api/articles/MySQL-存储引擎-索引.json","keywords":null,"cover":[],"text":"MySQL存储引擎MySQL体系结构 连接层 最上层是一些客户端和链接服务，包含本地sock 通信和大多数基于客户端&#x2F;服务端工具实现的类似于 TCP&#x2F;IP的通信。主要完成一些类似于连接处理、授权认证、及相关的安全方案。在该层上引入了线程 池的概念，为通过认证安...","link":"","photos":[],"count_time":{"symbolsCount":"16k","symbolsTime":"15 mins."},"categories":[],"tags":[{"name":"MySQL","slug":"MySQL","count":12,"path":"api/tags/MySQL.json"}],"author":{"name":"大宝贝的程序员","slug":"blog-author","avatar":"/img/header.jpg","link":"/","description":"Java实习生,即将入职场的小白","socials":{"github":"https://github.com/hjllsh","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://mp.csdn.net/mp_blog/manage/article","juejin":"","customs":{}}}},"next_post":{"title":"MySQL_约束_多表查询","uid":"f293b2fcfae54b8509d50db2914ed7a0","slug":"MySQL-约束-多表联查","date":"2023-05-16T13:40:42.000Z","updated":"2023-05-17T13:50:48.431Z","comments":true,"path":"api/articles/MySQL-约束-多表联查.json","keywords":null,"cover":[],"text":"约束概念：约束是作用于表中字段上的规则，用于限制存储在表中的数据。 目的：保证数据库中数据的正确、有效性和完整性。 约束 描述 关键词 非空约束 限制该字段的数据不能为null NOT NULL 唯一约束 保证该字段的所有数据都是唯一、不重复的 UNIQUE 主键约束 主键是一行...","link":"","photos":[],"count_time":{"symbolsCount":"8.9k","symbolsTime":"8 mins."},"categories":[],"tags":[{"name":"MySQL","slug":"MySQL","count":12,"path":"api/tags/MySQL.json"}],"author":{"name":"大宝贝的程序员","slug":"blog-author","avatar":"/img/header.jpg","link":"/","description":"Java实习生,即将入职场的小白","socials":{"github":"https://github.com/hjllsh","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://mp.csdn.net/mp_blog/manage/article","juejin":"","customs":{}}}}}